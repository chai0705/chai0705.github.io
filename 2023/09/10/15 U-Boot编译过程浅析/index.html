<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>U-Boot编译过程浅析 - 热爱学习的未来酱</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="热爱学习的未来酱"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="热爱学习的未来酱"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="一、U-Boot源代码获取可以参考我之前输出的这篇文章：  [RK356x] [Firefly-Linux] 10min带你获取、了解与编译U-Boot源代码  切换成linux_release_v1.2.3a版本： 12git remote updategit checkout -b rk356x&amp;#x2F;linux_release_v1.2.3a rk356x&amp;#x2F;linux_release_v1.2.3"><meta property="og:type" content="article"><meta property="og:title" content="U-Boot编译过程浅析"><meta property="og:url" content="http://example.com/2023/09/10/15%20U-Boot%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%B5%85%E6%9E%90/"><meta property="og:site_name" content="热爱学习的未来酱"><meta property="og:description" content="一、U-Boot源代码获取可以参考我之前输出的这篇文章：  [RK356x] [Firefly-Linux] 10min带你获取、了解与编译U-Boot源代码  切换成linux_release_v1.2.3a版本： 12git remote updategit checkout -b rk356x&amp;#x2F;linux_release_v1.2.3a rk356x&amp;#x2F;linux_release_v1.2.3"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159362.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159859.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159833.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159751.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159822.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159815.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159840.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159970.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159113.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159108.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159124.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159130.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159177.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159221.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159361.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159367.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159407.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159412.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159495.png"><meta property="og:image" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159479.png"><meta property="article:published_time" content="2023-09-10T09:17:04.000Z"><meta property="article:modified_time" content="2023-12-04T13:13:11.932Z"><meta property="article:author" content="chai"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159362.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2023/09/10/15%20U-Boot%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%B5%85%E6%9E%90/"},"headline":"U-Boot编译过程浅析","image":["https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159362.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159859.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159833.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159751.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159822.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159815.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159840.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159970.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159113.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159108.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159124.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159130.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159177.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159221.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159361.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159367.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159407.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159412.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159495.png","https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159479.png"],"datePublished":"2023-09-10T09:17:04.000Z","dateModified":"2023-12-04T13:13:11.932Z","author":{"@type":"Person","name":"chai"},"publisher":{"@type":"Organization","name":"热爱学习的未来酱","logo":{"@type":"ImageObject"}},"description":"一、U-Boot源代码获取可以参考我之前输出的这篇文章：  [RK356x] [Firefly-Linux] 10min带你获取、了解与编译U-Boot源代码  切换成linux_release_v1.2.3a版本： 12git remote updategit checkout -b rk356x&#x2F;linux_release_v1.2.3a rk356x&#x2F;linux_release_v1.2.3"}</script><link rel="canonical" href="http://example.com/2023/09/10/15%20U-Boot%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%B5%85%E6%9E%90/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="热爱学习的未来酱" type="application/atom+xml">
</head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">热爱学习的未来酱</a></div><div class="navbar-menu"><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-09-10T09:17:04.000Z" title="2023/9/10 17:17:04">2023-09-10</time>发表</span><span class="level-item"><time dateTime="2023-12-04T13:13:11.932Z" title="2023/12/4 21:13:11">2023-12-04</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a></span></div></div><h1 class="title is-3 is-size-4-mobile">U-Boot编译过程浅析</h1><div class="content"><h2 id="一、U-Boot源代码获取"><a href="#一、U-Boot源代码获取" class="headerlink" title="一、U-Boot源代码获取"></a>一、U-Boot源代码获取</h2><p>可以参考我之前输出的这篇文章：</p>
<blockquote>
<p>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/Neutionwei/article/details/123462959">RK356x] [Firefly-Linux] 10min带你获取、了解与编译U-Boot源代码</a></p>
</blockquote>
<p>切换成<code>linux_release_v1.2.3a</code>版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote update</span><br><span class="line">git checkout -b rk356x/linux_release_v1.2.3a rk356x/linux_release_v1.2.3a</span><br></pre></td></tr></table></figure>

<h2 id="二、编译RK3568"><a href="#二、编译RK3568" class="headerlink" title="二、编译RK3568"></a>二、编译RK3568</h2><p>RK356x 配置文件查看：<br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159362.png" alt="img">清除历史编译状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br></pre></td></tr></table></figure>

<p>使用 <code>make.sh</code> 配置 <code>configs/rk3568_defconfig</code> 并编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./make.sh rk3568</span><br></pre></td></tr></table></figure>

<h2 id="三、编译日志分析"><a href="#三、编译日志分析" class="headerlink" title="三、编译日志分析"></a>三、编译日志分析</h2><p>常用编译变量说明：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>HOSTCC</code></td>
<td>PC 机 gcc 编译命令</td>
</tr>
<tr>
<td><code>HOSTCXX</code></td>
<td>PC 机 g++ 编译命令</td>
</tr>
<tr>
<td><code>HOSTLD</code></td>
<td>PC 机 ld 链接命令</td>
</tr>
<tr>
<td><code>CC</code></td>
<td>交叉工具链 gcc 编译命令</td>
</tr>
<tr>
<td><code>CPP</code></td>
<td>交叉工具链 gcc -E 编译命令</td>
</tr>
<tr>
<td><code>LD</code></td>
<td>交叉工具链 ld 链接命令</td>
</tr>
<tr>
<td><code>OBJCOPY</code></td>
<td>交叉工具链 objcopy 命令</td>
</tr>
<tr>
<td><code>OBJDUMP</code></td>
<td>交叉工具链 objdump 链接命令</td>
</tr>
<tr>
<td><code>DTC</code></td>
<td>设备树编译命令 dtc</td>
</tr>
<tr>
<td><code>CHECK</code></td>
<td>执行静态检查 sparse</td>
</tr>
</tbody></table>
<p>摘自顶层<code>Makefile</code>：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159859.png" alt="img"><br>注意：上图中的<code>cc</code>与<code>gcc</code>是同一个东西！</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159833.png" alt="img"></p>
<p>编译日志主要分成以下几部分：</p>
<ol>
<li>配置文件生成</li>
<li>工具目录编译</li>
<li>U-Boot核心代码交叉编译</li>
<li>U-Boot目标文件生成</li>
<li>设备树编译并追加到U-Boot目标文件</li>
<li>TPL与SPL代码编译</li>
<li>TPL与SPL目标文件生成</li>
<li>最终固件打包</li>
</ol>
<h3 id="3-1-配置文件生成"><a href="#3-1-配置文件生成" class="headerlink" title="3.1 配置文件生成"></a>3.1 配置文件生成</h3><p>执行<code>make rk3568_defconfig -j8</code>命令，生成<code>.config</code>：<br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159751.png" alt="img"><br>执行<code>scripts/kconfig/conf --silentoldconfig Kconfig</code>，这个话主要是检查是否有新的配置项，这里是清除历史输出文件后进行编译，因此所有配置项都认为是新的！</p>
<p>在这个过程根据<code>config.h</code>文件配置<code>u-boot.cfg</code>、<code>spl/u-boot.cfg</code>、<code>	/u-boot.cfg</code>等文件，然后产生了各自的<code>autoconf.mk</code>文件。编译<code>sam-offsets.s</code>产生<code>u-boot.lds</code>链接脚本。</p>
<p>另外<code>include/generated/version_autogenerated.h</code>是描述版本信息的头文件。<br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159822.png" alt="img"></p>
<h3 id="3-2-工具目录编译"><a href="#3-2-工具目录编译" class="headerlink" title="3.2 工具目录编译"></a>3.2 工具目录编译</h3><p>对<code>tools</code>下的工具进行一系列编译：<br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159815.png" alt="img"></p>
<h3 id="3-3-U-Boot核心代码交叉编译"><a href="#3-3-U-Boot核心代码交叉编译" class="headerlink" title="3.3 U-Boot核心代码交叉编译"></a>3.3 U-Boot核心代码交叉编译</h3><p>编译完成<code>tools</code>目录后，开始交叉编译核心代码，我们会看到有非常多<code>build-in.o</code>，这个输出文件很有意思，它是该文件所处目录所有<code>*.o</code>文件的集合体，例如<code>arch/arm/cpu/built-in.o</code>，那它就是<code>arch/arm/cpu/</code>目录所有<code>*.o</code>文件的集合体！</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159840.png" alt="img"><br>核心代码的编译过程主要涉及<code>arch</code>架构代码目录、<code>common</code>通用目录、<code>cmd</code>命令目录与<code>driver</code>驱动目录，当然还有<code>lib</code>公共库目录与<code>examles</code>例程目录，注意这个编译过程不是按照顺序编译打印的，这个因为前面使用<code>-j8</code>编译选项，这个选项的意思是打开8个线程并发编译：<br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159970.png" alt="img"><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159113.png" alt="img"><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159108.png" alt="img"></p>
<h3 id="3-4-U-Boot目标文件生成"><a href="#3-4-U-Boot目标文件生成" class="headerlink" title="3.4 U-Boot目标文件生成"></a>3.4 U-Boot目标文件生成</h3><p>核心代码交叉编译完毕后链接之前所有的<code>built-in.o</code>文件，通过<code>objcopy</code>命令生成<code>u-boot-nodtb.bin</code>文件与<code>u-boot.sym</code>符号表，并且使用<code>relocate-rela</code>工具对<code>u-boot-nodtb.bin</code>静态reloc（静态<code>rela.dyn</code>修复）：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159124.png" alt="img"></p>
<h3 id="3-5-设备树编译并追加到U-Boot目标文件"><a href="#3-5-设备树编译并追加到U-Boot目标文件" class="headerlink" title="3.5 设备树编译并追加到U-Boot目标文件"></a>3.5 设备树编译并追加到U-Boot目标文件</h3><p>接下来是编译设备树<code>dts</code>，并且产生<code>dt.dtb</code>（u-boot设备树<code>dtb</code>文件）、<code>dt-spl.dtb</code>（spl设备树<code>dtb</code>文件）、<code>dt-tpl.dtb</code>（tpl设备树<code>dtb</code>文件），并且把<code>dtb</code>文件追加到u-boot文件生成<code>u-boot.bin</code>文件：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159130.png" alt="img"></p>
<h3 id="3-6-TPL与SPL代码编译"><a href="#3-6-TPL与SPL代码编译" class="headerlink" title="3.6 TPL与SPL代码编译"></a>3.6 TPL与SPL代码编译</h3><p><code>spl</code>是初始化DDR内存使用的，而<code>spl</code>相当于一个精简版u-boot，，只不过它的目的是加载u-boot固件，它们编译套路与U-Boot核心代码类似，注意的是它会把编译生成的<code>*.o</code>搬到<code>tpl</code>、<code>spl</code>目录，<code>tpl</code>、<code>spl</code>目录树的排布与U-Boot目录树一样：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159177.png" alt="img"></p>
<h3 id="3-7-TPL与SPL目标文件生成"><a href="#3-7-TPL与SPL目标文件生成" class="headerlink" title="3.7 TPL与SPL目标文件生成"></a>3.7 TPL与SPL目标文件生成</h3><p><code>u-boot-spl.lds</code>是<code>spl</code>的链接脚本，<code>u-boot-spl.dtb</code>是<code>spl</code>的设备树<code>dtb</code>文件：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159221.png" alt="img"><br><code>u-boot-spl-nodtb.bin</code>是<code>spl</code>目标文件，同样地把设备树<code>dtb</code>文件追加进去并产生<code>u-boot-spl.bin</code>文件：<br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159361.png" alt="img"><br><code>u-boot-tpl-nodtb.bin</code>是<code>tpl</code>目标文件，注意这里直接复制成<code>u-boot-tpl.bin</code>（没有追加设备树<code>dtb</code>文件）：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159367.png" alt="img"></p>
<p>还有一点需要注意的是，<code>u-boot-tpl.bin</code>是不能烧录进RK356x的，这是因为<code>tpl</code>相关代码，RK官方并没有开源！我们需要使用<code>rkbin</code>的<code>ddr.bin</code>文件替换！</p>
<h3 id="3-8-最终固件打包"><a href="#3-8-最终固件打包" class="headerlink" title="3.8 最终固件打包"></a>3.8 最终固件打包</h3><p>首先通过<code>rkbin/RKTRUST/RK3568TRUST.ini</code>文件描述的内容把<code>u-boot.bin</code>打包成<code>u-boot.itb</code>，紧接着根据 FIT 描述文件的内容把 ATF、OP-TEE、U-Boot、MCU 打包到一起（当然也包括设备树 DTB）：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159407.png" alt="img"><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159412.png" alt="img"><br><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159495.png" alt="img"><br>最后生成的固件为<code>uboot.img</code>，并且根据<code>rkbin/RKBOOT/RK3568MINIALL.ini</code>文件生成<code>rk356x_spl_loader_v1.12.112.bin</code>（注意这里并没有打包我们编译产生的<code>u-boot-spl.bin</code>文件，而是打包存放于<code>rkbin</code>目录下的<code>spl.bin</code>文件）</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202309122159479.png" alt="img"></p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/09/27/17%20%E9%80%82%E9%85%8D%E7%91%9E%E8%8A%AF%E5%BE%AE%E5%AE%98%E6%96%B9SDK/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">适配瑞芯微官方SDK</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/09/10/13%20bootloader%E5%BC%95%E5%AF%BC%E6%B5%81%E7%A8%8B/"><span class="level-item">bootloader引导流程</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">热爱学习的未来酱</a><p class="is-size-7"><span>&copy; 2023 chai</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>