<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="永远年轻，永远热泪盈眶" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 热爱学习的未来酱</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="热爱学习的未来酱" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/1.png" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">热爱学习的未来酱</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['我希望用一生的时间不断学习和深入电子计算机相关的一切知识，并将其整理成网络，分享出来，与更多志同道合的朋友一起进步', '无论你最终要成为一个怎样的人，千万要记住，时间在飞逝。', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="post-07_小技巧/11_repo学习"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/19/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/11_repo%E5%AD%A6%E4%B9%A0/"
    >repo的学习</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/19/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/11_repo%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2024-08-18T22:50:19.000Z" itemprop="datePublished">2024-08-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7/">小技巧</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>说一下前因后果，之前学了一段时间的git，但是无论如何也没用起来，这一点让我很是不爽,为了实现能常用git我甚至还搞了一个完全的Linux系统，但还是没有用起来，这还是让我很不爽，最近开始研究野火的SDK了，发现野火是用repo来进行代码管理的，其实更上层的瑞芯微也是这样管理代码的，但我们也不知道为了什么起见，可能对应的客户不同吧，就一个板子一套镜像，我认为这是有问题的，但我并没有什么话语权，只能听安排，但是我可以自己维护一个主线，我甚至可以搞一个千兆的宽带，这一点在理，但让我搞一个新机器我又不愿意，这个以后再说，先来研究理论基础。</p>
</blockquote>
<h1 id="repo理论基础"><a class="markdownIt-Anchor" href="#repo理论基础"></a> repo理论基础</h1>
<h2 id="repo是什么"><a class="markdownIt-Anchor" href="#repo是什么"></a> repo是什么？</h2>
<p><strong>Repo是一个高级的版本库管理工具，主要用于管理Android项目的多个Git仓库</strong>。下面将非常详细地讲解Repo的各个方面：</p>
<ol>
<li><strong>起源与用途</strong>：
<ul>
<li>Repo是由Google开发并广泛使用于Android开源项目（AOSP）中的工具。</li>
<li>它旨在简化对包含多个Git仓库的大型项目的管理工作。</li>
<li>在Android项目中，Repo帮助开发者同步、管理和更新分布在多个Git仓库中的代码。</li>
</ul>
</li>
<li><strong>核心功能与特点</strong>：
<ul>
<li><strong>仓库管理</strong>：Repo能够初始化一个仓库清单（manifest），该清单描述了项目所需的所有Git仓库的位置和分支信息。</li>
<li><strong>同步操作</strong>：通过<code>repo sync</code>命令，Repo可以自动地克隆或更新所有列在清单中的Git仓库。</li>
<li><strong>分支管理</strong>：Repo支持在多个仓库之间切换分支，确保整个项目的一致性。</li>
<li><strong>状态查看</strong>：使用<code>repo status</code>可以查看所有仓库的当前状态，包括哪些文件被修改、新增或删除。</li>
<li><strong>上传与审查</strong>：Repo集成了Git的上传（<code>git push</code>）和代码审查（Gerrit）的功能，便于开发者提交更改并进行代码审查。</li>
</ul>
</li>
<li><strong>工作原理</strong>：
<ul>
<li>Repo本身是一个Python脚本，它利用Git命令来管理多个Git仓库。</li>
<li>当Repo初始化一个项目时，它会首先克隆一个特殊的Git仓库（通常称为manifest仓库），该仓库包含了项目的manifest文件。</li>
<li>Manifest文件是一个XML文件，它定义了项目中所有其他Git仓库的位置、分支和复制条件。</li>
<li>随后，Repo根据manifest文件的信息，逐一克隆或更新每个Git仓库到本地工作目录。</li>
</ul>
</li>
<li><strong>优势</strong>：
<ul>
<li><strong>简化管理</strong>：对于包含数百个Git仓库的大型项目来说，手动管理这些仓库将非常繁琐且容易出错。Repo提供了自动化的管理工具，大大简化了这一过程。</li>
<li><strong>保持一致性</strong>：Repo确保所有仓库都按照manifest文件的规定处于正确的分支和版本，从而保证了整个项目的一致性。</li>
<li><strong>提高开发效率</strong>：通过集成代码上传和审查的功能，Repo帮助开发者更快地完成开发流程。</li>
</ul>
</li>
<li><strong>使用场景</strong>：
<ul>
<li>Repo特别适用于大型、复杂且包含多个相互依赖的组件或模块的项目。</li>
<li>在Android开源项目中，Repo是不可或缺的工具，用于管理数以百计的Git仓库。</li>
<li>类似的项目，如Chrome OS和Linux内核项目，也可能使用Repo或其类似工具来管理多个Git仓库。</li>
</ul>
</li>
<li><strong>安装与配置</strong>：
<ul>
<li>Repo通常需要通过特定的脚本来安装，因为它本身是一个Python脚本。</li>
<li>安装后，需要通过Repo的<code>init</code>命令来初始化一个项目，该命令会克隆manifest仓库并设置项目的本地环境。</li>
<li>配置Repo通常涉及编辑manifest文件，以更改项目的仓库列表、分支和复制条件。</li>
</ul>
</li>
</ol>
<p>通过以上详细的讲解，你应该对Repo有了全面而深入的理解。Repo是一个强大的工具，它简化了大型项目中多个Git仓库的管理，提高了开发效率和项目一致性。</p>
<h2 id="repo的安装"><a class="markdownIt-Anchor" href="#repo的安装"></a> repo的安装</h2>
<p>repo 其实就是个python脚本，所以只需要拉取下来放到某个路径就好了，但在此之前需要先安装git，git的安装方法不再讲解，可以看前面的文档。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COPYwget https://storage.googleapis.com/git-repo-downloads/repo .</span><br><span class="line">wget https://raw.githubusercontent.com/esrlabs/git-repo/stable/repo .</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043063.png" alt="image-20240817170916119" />image-20240817170916119</p>
<p>然后赋予可执行权限，拷贝到/usr/bin/目录：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043962.png" alt="image-20240817171016635" />image-20240817171016635</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043016.png" alt="image-20240817171038551" />image-20240817171038551</p>
<h2 id="repo常用命令"><a class="markdownIt-Anchor" href="#repo常用命令"></a> repo常用命令</h2>
<h3 id="repo常用命令-2"><a class="markdownIt-Anchor" href="#repo常用命令-2"></a> repo常用命令</h3>
<ol>
<li>
<p><strong>初始化repo</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo --trace init -u https://android.googlesource.com/platform/manifest -b branch_name -m default.xml</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>同步代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo sync</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>上传代码到远程仓库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo upload dev</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>列出分支</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo branch  # 或者 repo branches</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>状态查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo status</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>查看修改</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo diff</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>撤销整个工程的本地修改</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo forall -c &#x27;git reset --hard HEAD; git clean -df; git rebase --abort&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>切换整个工程模块的分支</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo forall -c &#x27;git branch master&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>更新整个工程模块的代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo forall -c &#x27;git pull projectname&#x27;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="repo与git命令对照表"><a class="markdownIt-Anchor" href="#repo与git命令对照表"></a> repo与git命令对照表</h3>
<table>
<thead>
<tr>
<th>repo命令</th>
<th>等同git命令</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>repo init -u</td>
<td>无</td>
<td>初始化</td>
</tr>
<tr>
<td>repo sync</td>
<td>git pull</td>
<td>同步代码</td>
</tr>
<tr>
<td>repo upload</td>
<td>git push</td>
<td>上传代码</td>
</tr>
<tr>
<td>repo forall</td>
<td>无</td>
<td>多仓执行</td>
</tr>
<tr>
<td>repo start</td>
<td>git checkout -b</td>
<td>创建并切换分支</td>
</tr>
<tr>
<td>repo checkout</td>
<td>git checkout</td>
<td>切换分支</td>
</tr>
<tr>
<td>repo status</td>
<td>git status</td>
<td>状态查询</td>
</tr>
<tr>
<td>repo branches</td>
<td>git branch</td>
<td>分支查询</td>
</tr>
<tr>
<td>repo diff</td>
<td>git diff</td>
<td>文件对比</td>
</tr>
<tr>
<td>repo prune</td>
<td>git remote prune origin</td>
<td>删除合并分支</td>
</tr>
<tr>
<td>repo stage –i</td>
<td>git add --interactive</td>
<td>添加文件到暂存区</td>
</tr>
<tr>
<td>repo abandon</td>
<td>git branch -D</td>
<td>删除分支</td>
</tr>
<tr>
<td>repo version</td>
<td>无</td>
<td>查看版本号</td>
</tr>
</tbody>
</table>
<h3 id="repo-脚本参数"><a class="markdownIt-Anchor" href="#repo-脚本参数"></a> repo 脚本参数</h3>
<ul>
<li><code>--repo-url=URL</code>: repo 工具本身的 git 库地址。缺省为：<code>git://android.git.kernel.org/tools/repo.git</code></li>
<li><code>--repo-branch=REVISION</code>: 使用repo的版本库，即repo git库的分支或者里程碑名称。缺省为<code>caf-stable</code></li>
<li><code>--no-repo-verify</code>: 设定不要对repo的里程碑签名进行严格的验证。</li>
<li><code>-u</code> 或 <code>--manifest-url</code>: 设定清单库的Git服务器地址。</li>
<li><code>-b</code> 或 <code>--manifest-branch</code>: 检出清单库的特定分支。</li>
<li><code>--mirror</code>: 只在repo第一次初始化的时候使用，建立本地镜像。</li>
<li><code>-m</code> 或 <code>--manifest-name</code>: 指定清单库中的某个清单为有效的清单文件。默认为<code>default.xml</code>。</li>
<li><code>--no-tags</code>: 不获取标签（tags）。</li>
<li><code>--trace</code>: 显示repo命令的执行过程。</li>
</ul>
<h3 id="repo-help"><a class="markdownIt-Anchor" href="#repo-help"></a> repo help</h3>
<ul>
<li><code>repo help</code>：查看 <code>repo</code> 的帮助文档。</li>
<li><code>repo help sync</code>：查看 <code>sync</code> 命令的帮助文档。</li>
</ul>
<h3 id="repo-init"><a class="markdownIt-Anchor" href="#repo-init"></a> repo init</h3>
<ul>
<li><code>repo init</code> 主要用于初始化 <code>repo</code> 工具，执行的 <code>repo</code> 脚本是一个引导工具，而非下载代码的脚本。</li>
<li>该命令会克隆 <code>manifest.git</code> 到 <code>.repo/manifests/</code> 目录下（地址由 <code>-u</code> 参数指定），并在 <code>.repo/</code> 目录中生成符号链接 <code>manifest.xml</code>，指向 <code>.repo/manifests/default.xml</code>。</li>
<li>如果 <code>.repo/manifests/</code> 目录中有多个 <code>xml</code> 文件，可通过 <code>repo init -m</code> 参数指定要使用的 <code>manifest</code> 文件，默认是 <code>default.xml</code>。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">COPYbash</span><br><span class="line">复制代码</span><br><span class="line">repo --trace init -u https://android.googlesource.com/platform/manifest -b branch_name -m default.xml &amp;&amp; repo sync &amp;&amp; repo start branch_name --all</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--trace</code>：查看 <code>repo</code> 背后的具体操作。</li>
<li><code>-u</code>：指定 <code>Manifest</code> 库的 Git 访问路径。</li>
<li><code>-m</code>：指定使用的 <code>Manifest</code> 文件。</li>
<li><code>-b</code>：指定使用 <code>Manifest</code> 仓库中的某个特定分支。</li>
</ul>
<p><strong>初始化完成后生成的 <code>.repo</code> 目录结构：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">COPYbash复制代码tree .repo -L 1</span><br><span class="line">.repo</span><br><span class="line">├── manifest.xml -&gt; manifests/default.xml</span><br><span class="line">├── manifests</span><br><span class="line">├── manifests.git</span><br><span class="line">├── project-objects</span><br><span class="line">├── project.list</span><br><span class="line">├── projects</span><br><span class="line">└── repo</span><br></pre></td></tr></table></figure>
<p><strong>各文件夹的用途：</strong></p>
<ul>
<li><code>manifests</code>：清单文件的仓库。</li>
<li><code>manifests.git</code>：清单文件的 Git 裸仓库，不带工作区。</li>
<li><code>manifest.xml</code>：符号链接，指向用于初始化工作区的清单文件。</li>
<li><code>project.list</code>：包含所有项目名称的列表。</li>
<li><code>projects</code>：包含所有 <code>git project</code> 的裸仓库，文件夹的层次结构与工作区布局一致。</li>
<li><code>repo</code>：<code>repo</code> 命令的主体，推荐使用其中的 <code>repo</code> 命令。</li>
</ul>
<h3 id="repo-sync"><a class="markdownIt-Anchor" href="#repo-sync"></a> repo sync</h3>
<ul>
<li><strong>首次运行</strong>：相当于 <code>git clone</code>，会将服务器的内容完全拷贝到本地。</li>
<li><strong>后续运行</strong>：若项目已同步，则相当于执行 <code>git remote update &amp;&amp; git rebase origin/&lt;branch&gt;</code>。</li>
</ul>
<p><code>repo sync</code> 不会更新 <code>.repo/repo</code> 仓库。</p>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-j</code>：开启多线程同步，加快同步速度，默认使用4个线程。</li>
<li><code>-c, --current-branch</code>：仅同步指定的远程分支，默认同步所有远程分支。</li>
<li><code>-d, --detach</code>：脱离当前本地分支，切换到 <code>manifest.xml</code> 中设定的分支。第一次 <code>sync</code> 后通常会切换到 <code>dev</code> 分支开发，若不带此参数，可能导致本地 <code>dev</code> 分支与 <code>manifest</code> 远程分支合并，可能引发同步失败。</li>
<li><code>-f, --force-broken</code>：当某些 <code>git</code> 库同步失败时，不中断同步操作，继续同步其他 <code>git</code> 库。</li>
</ul>
<h3 id="repo-upload"><a class="markdownIt-Anchor" href="#repo-upload"></a> repo upload</h3>
<ul>
<li>类似于 <code>git push</code>。</li>
<li><strong>用法</strong>：<code>repo upload [--re --cc] [项目列表]</code></li>
<li>若无参数，<code>repo upload</code> 会搜索所有项目中的更改以进行上传。</li>
</ul>
<h3 id="repo-start"><a class="markdownIt-Anchor" href="#repo-start"></a> repo start</h3>
<ul>
<li><code>repo start</code> 是 <code>git checkout -b</code> 的封装，但 <code>repo start</code> 是基于 <code>manifest</code> 中设定的分支创建特性分支。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li><code>repo start stable --all</code>：假设 <code>manifest</code> 文件中设定的分支为 <code>gingerbread-stable</code>，则会在所有项目上基于该分支创建特性分支 <code>stable</code>。</li>
<li><code>repo start stable platform/build platform/bionic</code>：可以指定项目。</li>
</ul>
<h3 id="repo-forall"><a class="markdownIt-Anchor" href="#repo-forall"></a> repo forall</h3>
<ul>
<li><code>repo forall [&lt;PROJECT_LIST&gt;] -c &lt;COMMAND&gt;</code>：在每个项目中运行指定的 Shell 命令。</li>
</ul>
<p><strong>可用的环境变量：</strong></p>
<ul>
<li><code>REPO_PROJECT</code>：项目的唯一名称。</li>
<li><code>REPO_PATH</code>：客户端根目录的相对路径。</li>
<li><code>REPO_REMOTE</code>：清单中远程系统的名称。</li>
<li><code>REPO_LREV</code>：清单中的修订版本名称，已转换为本地跟踪分支。</li>
<li><code>REPO_RREV</code>：清单中的修订版本名称，与清单中的名称一致。</li>
</ul>
<p><strong>常用参数：</strong></p>
<ul>
<li><code>-c</code>：运行指定的命令。</li>
<li><code>-p</code>：输出命令结果前显示项目标头。</li>
<li><code>-v</code>：显示命令向 <code>stderr</code> 写入的消息。</li>
</ul>
<h3 id="manifest-文件"><a class="markdownIt-Anchor" href="#manifest-文件"></a> manifest 文件</h3>
<ul>
<li><code>manifest</code> 文件是 <code>repo</code> 工具的核心，记录所有 <code>git</code> 仓库的地址和分支。</li>
<li>官方文档参考：<a target="_blank" rel="noopener" href="https://github.com/GerritCodeReview/git-repo/blob/main/docs/manifest-format.md">manifest 文件格式</a>。</li>
</ul>
<p><strong>manifest 文件示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;manifest&gt;</span><br><span class="line">    &lt;remote /&gt;</span><br><span class="line">    &lt;default remote=&quot;origin&quot; revision=&quot;master&quot; sync-j=&quot;4&quot; /&gt;</span><br><span class="line">    &lt;project /&gt;</span><br><span class="line">    &lt;project /&gt;</span><br><span class="line">    &lt;project /&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>
<p><strong>元素说明：</strong></p>
<ul>
<li><code>remote</code>：指定使用 <code>repo upload</code> 时提交到哪个服务器，可定义一个或多个 <code>remote</code>。</li>
<li>default：包含一些缺省属性，如果 project中未指定，则使用这些属性。
<ul>
<li><code>revision</code>：Git 分支的名称，可为 <code>branch</code>、<code>tag</code> 或 <code>commit id</code>。</li>
<li><code>sync-j</code>：同步时并行任务数。</li>
<li><code>sync-c</code>：为 <code>true</code> 时，仅同步 <code>project</code> 中指定的分支。</li>
</ul>
</li>
<li>project：定义一个或多个 git 仓库。
<ul>
<li><code>name</code>：<code>git project</code> 的名字。</li>
<li><code>path</code>：本地工作区路径。</li>
<li><code>revision</code>：与 <code>default</code> 标签中的 <code>revision</code> 含义相同。</li>
</ul>
</li>
</ul>
<h1 id="repo实际用法"><a class="markdownIt-Anchor" href="#repo实际用法"></a> repo实际用法</h1>
<blockquote>
<p>我之前只用过野火的repo，今天就继续用野火的repo，使用一下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">COPY# 创建目录</span><br><span class="line">mkdir ~/LubanCat_SDK</span><br><span class="line"></span><br><span class="line">cd ~/LubanCat_SDK</span><br><span class="line"></span><br><span class="line"># 配置姓名和邮箱</span><br><span class="line">git config --global user.email &quot;you@example.com&quot;</span><br><span class="line">git config --global user.name &quot;Your Name&quot;</span><br><span class="line">  </span><br><span class="line"># 拉取LubanCat-RK356x系列Linux_SDK</span><br><span class="line">repo init --depth=1 -u https://github.com/LubanCat/manifests.git -b linux -m rk356x_linux_release.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 拉取LubanCat-RK3588系列Linux_SDK</span><br><span class="line">repo init --depth=1 -u https://github.com/LubanCat/manifests.git -b linux -m rk3588_linux_release.xml</span><br><span class="line"></span><br><span class="line">#如果运行以上命令失败，提示：fatal: Cannot get https://gerrit.googlesource.com/git-repo/clone.bundle</span><br><span class="line">#则可以在以上命令中添加选项 --repo-url https://mirrors.tuna.tsinghua.edu.cn/git/git-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043976.png" alt="image-20240819093048396" />image-20240819093048396</p>
<blockquote>
<ul>
<li><code>repo init</code>: 初始化 Repo 客户端。</li>
<li><code>--depth=1</code>: 进行浅克隆（shallow clone），即只克隆最近的提交历史。这可以加速克隆过程，因为你不会获取整个项目的历史记录，只会获取最近的提交。这对于大型项目特别有用，可以节省时间和带宽。</li>
<li><code>-u https://github.com/LubanCat/manifests.git</code>: 指定清单仓库（manifest repository）的 URL。这是包含项目清单文件的 Git 仓库，清单文件定义了项目中包含的所有其他仓库。</li>
<li><code>-b linux</code>: 指定要检出的分支名。在这个例子中，<code>linux</code> 是清单仓库中的一个分支名，该分支包含了特定于该项目的清单文件。</li>
<li><code>-m rk3588_linux_release.xml</code>: 指定要使用的清单文件名。在这个例子中，<code>rk3588_linux_release.xml</code> 是清单仓库中的一个文件，它定义了项目的具体结构和配置。</li>
</ul>
<p>这个命令的作用是初始化一个 Repo 工作环境，从指定的 URL 克隆清单仓库的 <code>linux</code> 分支，并使用 <code>rk3588_linux_release.xml</code> 清单文件来配置项目。这个清单文件将包含项目中所有其他 Git 仓库的信息，以及这些仓库应该如何被检出和配置。在 <code>repo init</code> 完成之后，你通常会使用 <code>repo sync</code> 命令来同步（即克隆或更新）清单文件中定义的所有仓库。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY.repo/repo/repo sync -c -j20</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043968.png" alt="image-20240819100404978" />image-20240819100404978</p>
<p>这个命令主要做了以下几件事情：</p>
<ol>
<li><strong>同步代码</strong>：<code>repo sync</code> 命令的主要目的是从远程仓库同步代码到本地。它会拉取所有在 <code>manifest</code> 文件中定义的项目的最新代码。</li>
<li><strong>-c 选项</strong>：这个选项表示只同步当前分支。也就是说，它只会同步 manifest 文件中定义的当前分支的最新代码，而不会同步其他分支的代码。</li>
<li><strong>-j20 选项</strong>：这个选项指定了同步过程中的并发任务数。<code>-j20</code> 表示会同时运行 20 个任务来同步代码，这可以加速同步过程，但也可能增加网络和 CPU 的负载。你需要根据你的机器和网络环境来合理设置这个值。</li>
</ol>
<p>同步完成之后如下图所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043001.png" alt="image-20240819100736704" />image-20240819100736704</p>
<p>而实际的代码同步凭靠的是这个rk3588_linux5.10_stable.xml文件，该文件的内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;manifest&gt;</span><br><span class="line">  &lt;!-- &lt;remote name=&quot;origin&quot; fetch=&quot;ssh://git@gitlab.ebf.local/rockchip/linux/&quot;/&gt; --&gt;</span><br><span class="line">  &lt;remote name=&quot;origin&quot; fetch=&quot;https://github.com/LubanCat&quot;/&gt;  </span><br><span class="line"></span><br><span class="line">  &lt;default remote=&quot;origin&quot; sync-j=&quot;4&quot;/&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;project name=&quot;debian11&quot; path=&quot;debian&quot; revision=&quot;refs/tags/stable-5.10.160&quot; clone-depth=&quot;1&quot;/&gt;</span><br><span class="line">  &lt;project name=&quot;device_rockchip&quot; path=&quot;device/rockchip&quot; revision=&quot;a85039a1513b2debd79f8e7ecc59c5cca01d1530&quot; upstream=&quot;master&quot; dest-branch=&quot;master&quot;&gt;</span><br><span class="line">    &lt;linkfile src=&quot;common/mkfirmware.sh&quot; dest=&quot;mkfirmware.sh&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;common/build.sh&quot; dest=&quot;build.sh&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;common/rkflash.sh&quot; dest=&quot;rkflash.sh&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;rk3588&quot; dest=&quot;device/rockchip/.target_product&quot;/&gt;</span><br><span class="line">  &lt;/project&gt;</span><br><span class="line">  &lt;project name=&quot;gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu&quot; path=&quot;prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu&quot; revision=&quot;adbb295a970c4b39dc487c95226fe84d2c460072&quot; upstream=&quot;master&quot; dest-branch=&quot;master&quot;/&gt;</span><br><span class="line">  &lt;project name=&quot;kernel&quot; revision=&quot;4124065a2763eb8097806289b4825c8933b82efc&quot; upstream=&quot;stable-5.10-rk3588&quot; dest-branch=&quot;stable-5.10-rk3588&quot;/&gt;</span><br><span class="line">  &lt;project name=&quot;lubancat-bin&quot; revision=&quot;da4446576b196334590e59a9ec4cb2a094980bdf&quot; upstream=&quot;rk3588&quot; dest-branch=&quot;rk3588&quot;/&gt;</span><br><span class="line">  &lt;project name=&quot;rkbin&quot; revision=&quot;2dde28de6e47f5003683cd3a20b4243c63e6b2fb&quot; upstream=&quot;main&quot; dest-branch=&quot;main&quot;/&gt;</span><br><span class="line">  &lt;project name=&quot;tools&quot; revision=&quot;210be81d659a6bc4e7a648744ae77837f394be0f&quot; upstream=&quot;master&quot; dest-branch=&quot;master&quot;&gt;</span><br><span class="line">    &lt;linkfile src=&quot;windows/RKDevTool/RKDevTool_Release/rk3588-config.cfg&quot; dest=&quot;tools/windows/RKDevTool/RKDevTool_Release/config.cfg&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;windows/RKDevTool/rockdev/rk3588-package-file&quot; dest=&quot;tools/windows/RKDevTool/rockdev/package-file&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;windows/RKDevTool/rockdev/rk3588-mkupdate.bat&quot; dest=&quot;tools/windows/RKDevTool/rockdev/mkupdate.bat&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;linux/Linux_Pack_Firmware/rockdev/rk3588-mkupdate.sh&quot; dest=&quot;tools/linux/Linux_Pack_Firmware/rockdev/mkupdate.sh&quot;/&gt;</span><br><span class="line">    &lt;linkfile src=&quot;linux/Linux_Pack_Firmware/rockdev/rk3588-package-file&quot; dest=&quot;tools/linux/Linux_Pack_Firmware/rockdev/package-file&quot;/&gt;</span><br><span class="line">  &lt;/project&gt;</span><br><span class="line">  &lt;project name=&quot;u-boot&quot; revision=&quot;refs/tags/lbc-gen-rkr7.1&quot; clone-depth=&quot;1&quot;/&gt;</span><br><span class="line">  &lt;project name=&quot;ubuntu&quot; revision=&quot;refs/tags/stable-5.10-rk3588&quot; clone-depth=&quot;1&quot;/&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>
<p>在这个 <code>XML</code> 文件中，包含了一个 Android <code>repo</code> 工具所使用的 <code>manifest</code> 文件。它定义了多个项目的来源、分支、路径、文件链接等关键信息。下面我会详细解释这个 XML 文件的结构及各个元素的作用。</p>
<p><strong>整体结构</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;manifest&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</code>: 这是 XML 文件的声明，表示该文件是 XML 1.0 版本，字符编码是 <code>UTF-8</code>。</li>
<li><code>&lt;manifest&gt;</code>: 这是 XML 文件的根元素，所有项目的配置信息都在这个根元素之内。Manifest 是 <code>repo</code> 工具的核心配置文件，用于描述多 Git 仓库如何被同步、管理。</li>
</ul>
<p><strong>元素</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;remote name=&quot;origin&quot; fetch=&quot;https://github.com/LubanCat&quot;/&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>作用</strong>：定义远程仓库的位置。</p>
</li>
<li>
<p><strong>属性</strong>：</p>
<ul>
<li><code>name</code>: 为远程仓库命名为 <code>origin</code>，这个名字将在其他地方引用到，比如 <code>&lt;default&gt;</code> 和 <code>&lt;project&gt;</code>。</li>
<li><code>fetch</code>: 指定远程仓库的 URL。在这个例子中，代码会从 <code>https://github.com/LubanCat</code> 获取。</li>
</ul>
<blockquote>
<p>注释 <code>&lt;!-- ... --&gt;</code> 表示注释掉的部分，实际上在文件解析时会被忽略。这里可以看到原本使用的是 <code>ssh://</code> 的 URL 被注释掉，改用了 <code>https</code> 的 URL。</p>
</blockquote>
</li>
</ul>
<p><strong><code>&lt;default&gt;</code> 元素</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;default remote=&quot;origin&quot; sync-j=&quot;4&quot;/&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>作用</strong>：设置默认的同步和远程仓库配置，适用于该清单中所有项目（除非项目本身有覆盖配置）。</p>
</li>
<li>
<p>属性</p>
<p>：</p>
<ul>
<li><code>remote</code>: 使用前面定义的 <code>origin</code> 作为默认远程仓库。</li>
<li><code>sync-j</code>: 指定在同步代码时使用的并行线程数。在这个例子中，使用 <code>4</code> 个线程并发同步，可以提高同步速度。</li>
</ul>
</li>
</ul>
<p><strong>元素</strong></p>
<p>项目的核心定义，描述要同步的 Git 仓库。可以有多个 <code>&lt;project&gt;</code> 元素，每一个都代表一个独立的 Git 仓库。</p>
<p>示例 1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;project name=&quot;debian11&quot; path=&quot;debian&quot; revision=&quot;refs/tags/stable-5.10.160&quot; clone-depth=&quot;1&quot;/&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>作用</strong>：定义一个名为 <code>debian11</code> 的项目，这个项目是一个 Git 仓库。</p>
</li>
<li>
<p>属性</p>
<p>：</p>
<ul>
<li><code>name</code>: 仓库名，指向仓库的名称为 <code>debian11</code>。</li>
<li><code>path</code>: 项目的本地路径。在这个例子中，同步的代码将存放在 <code>debian/</code> 目录下。</li>
<li><code>revision</code>: 指定要检出的特定分支、标签或提交 ID。这里使用的是 <code>refs/tags/stable-5.10.160</code>，这意味着会同步 <code>stable-5.10.160</code> 标签的内容。</li>
<li><code>clone-depth</code>: 指定浅克隆的深度（即保留最近的 n 个提交）。这里是 <code>1</code>，表示只克隆最近一次提交历史。</li>
</ul>
</li>
</ul>
<p>示例 2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;project name=&quot;device_rockchip&quot; path=&quot;device/rockchip&quot; revision=&quot;a85039a1513b2debd79f8e7ecc59c5cca01d1530&quot; upstream=&quot;master&quot; dest-branch=&quot;master&quot;&gt;</span><br><span class="line">  &lt;linkfile src=&quot;common/mkfirmware.sh&quot; dest=&quot;mkfirmware.sh&quot;/&gt;</span><br><span class="line">  &lt;linkfile src=&quot;common/build.sh&quot; dest=&quot;build.sh&quot;/&gt;</span><br><span class="line">  &lt;linkfile src=&quot;common/rkflash.sh&quot; dest=&quot;rkflash.sh&quot;/&gt;</span><br><span class="line">  &lt;linkfile src=&quot;rk3588&quot; dest=&quot;device/rockchip/.target_product&quot;/&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>作用</strong>：定义名为 <code>device_rockchip</code> 的项目，并为其指定多个文件的链接（<code>linkfile</code> 元素）。</p>
</li>
<li>
<p><strong>属性</strong>：</p>
<ul>
<li><code>name</code>: 仓库名 <code>device_rockchip</code>。</li>
<li><code>path</code>: 项目的本地路径为 <code>device/rockchip</code>。</li>
<li><code>revision</code>: 同步到特定的提交，这里是 <code>a85039a1513b2debd79f8e7ecc59c5cca01d1530</code>。</li>
<li><code>upstream</code>: 指定该项目的上游分支是 <code>master</code>。</li>
<li><code>dest-branch</code>: 指定目标分支为 <code>master</code>。</li>
</ul>
</li>
<li>
<p><strong><code>&lt;linkfile&gt;</code> 元素</strong>：为本地项目中的某些文件创建符号链接。</p>
<ul>
<li><code>src</code>: 链接的源文件位置（在仓库中的路径）。</li>
<li><code>dest</code>: 链接的目标文件位置（在本地项目中的路径）。</li>
</ul>
<p>例如，<code>&lt;linkfile src=&quot;common/mkfirmware.sh</code></p>
</li>
</ul>
<h1 id="搭建自己的repo仓库"><a class="markdownIt-Anchor" href="#搭建自己的repo仓库"></a> 搭建自己的repo仓库</h1>
<blockquote>
<p>v2ray wsl翻墙</p>
<p><a target="_blank" rel="noopener" href="https://ivpsr.com/2484.html">https://ivpsr.com/2484.html</a></p>
</blockquote>
<p>首先，在服务端只需要建立一个仓库名为<code>manifest</code>，构建完成如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043339.png" alt="image-20240819162611044" />image-20240819162611044</p>
<p>然后在本地拉取该仓库，拉取完成如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043360.png" alt="image-20240819162649607" />image-20240819162649607</p>
<p>然后创建一个xml文件，这个文件名可以随意取例如rk3588_linux_release.xml，内容填充如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;manifest&gt;</span><br><span class="line">  &lt;remote  name=&quot;origin&quot; fetch=&quot;https://github.com/chai0705&quot; /&gt;</span><br><span class="line">  &lt;default remote=&quot;origin&quot; sync-j=&quot;8&quot; /&gt;</span><br><span class="line">  &lt;project name=&quot;rootfs-build&quot; path=&quot;rootfs-build&quot; revision=&quot;main&quot; /&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>
<p>remote: 远程服务端，name为repo仓库名称，fetch 为 仓库url</p>
<p>default:设置每个项目默认的仓库和分支，remote指定了使用哪一个远程服务端</p>
<p>project: 每个项目的git仓库，path会指向下载后的仓库放在那个路径</p>
<p>name: 服务端git仓库名称，指向的是在fetch在已有的仓库名。</p>
<p>revision: 分支名称或者commit id</p>
<p>然后推送出去，即可，如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043547.png" alt="image-20240819163952002" />image-20240819163952002</p>
<p>到这里就关于repo就搭建完成了，然后开始测试，输入以下命令，这里的repo可以指定一下国内源，不然太慢了，或者使用本地的repo也是可以的。</p>
<blockquote>
<p>–repo-url <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/git/git-repo">https://mirrors.tuna.tsinghua.edu.cn/git/git-repo</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo init -u https://github.com/chai0705/manifest -b master -m rk3588_linux_release.xml --repo-url https://mirrors.tuna.tsinghua.edu.cn/git/git-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043403.png" alt="image-20240819165255782" />image-20240819165255782</p>
<p>这样就初始化成功了，然后就可以进行同步了，同步过程如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYrepo sync -j20</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043455.png" alt="image-20240819165407859" />image-20240819165407859</p>
<p>同步完成如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051043610.png" alt="image-20240819165611921" />image-20240819165611921</p>
<p>不错啊，这个，我感觉很不错，</p>
<p>小修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">COPY&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;manifest&gt;</span><br><span class="line">  &lt;remote  name=&quot;origin&quot; fetch=&quot;https://github.com/chai0705&quot; /&gt;</span><br><span class="line">  &lt;default remote=&quot;origin&quot; sync-j=&quot;8&quot; /&gt;</span><br><span class="line">  &lt;project name=&quot;rootfs-build&quot; path=&quot;rootfs-build&quot; revision=&quot;master&quot; /&gt;</span><br><span class="line">  &lt;project name=&quot;u-boot&quot; path=&quot;u-boot&quot; revision=&quot;master&quot; /&gt;</span><br><span class="line">  &lt;project name=&quot;kernel&quot; path=&quot;kernel&quot; revision=&quot;master&quot; /&gt;</span><br><span class="line">  &lt;project name=&quot;rkbin&quot; path=&quot;rkbin&quot; revision=&quot;master&quot; /&gt;</span><br><span class="line">  &lt;project name=&quot;gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu&quot; path=&quot;prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu&quot; revision=&quot;adbb295a970c4b39dc487c95226fe84d2c460072&quot; upstream=&quot;master&quot; dest-branch=&quot;master&quot;/&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br><span class="line">COPY</span><br><span class="line">git remote add origin https://github.com/chai0705/u-boot.git</span><br><span class="line">git clone https://github.com/chai0705/kernel.git</span><br><span class="line">git push -u origin master</span><br><span class="line">COPYgit branch -m main master</span><br><span class="line">git fetch origin</span><br><span class="line">git branch -u origin/master master</span><br><span class="line">git remote set-head origin -a</span><br><span class="line">COPYexport windows_host=`cat /etc/resolv.conf|grep nameserver|awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">export ALL_PROXY=socks5://$windows_host:10810</span><br><span class="line">export HTTP_PROXY=$ALL_PROXY</span><br><span class="line">export http_proxy=$ALL_PROXY</span><br><span class="line">export HTTPS_PROXY=$ALL_PROXY</span><br><span class="line">export https_proxy=$ALL_PROXY</span><br><span class="line"></span><br><span class="line">if [ &quot;`git config --global --get proxy.https`&quot; != &quot;socks5://$windows_host:10810&quot; ]; then</span><br><span class="line">            git config --global proxy.https socks5://$windows_host:10810</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-07_小技巧/10_各类任务耗时"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/18/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/10_%E5%90%84%E7%B1%BB%E4%BB%BB%E5%8A%A1%E8%80%97%E6%97%B6/"
    >各类任务耗时</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/18/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/10_%E5%90%84%E7%B1%BB%E4%BB%BB%E5%8A%A1%E8%80%97%E6%97%B6/" class="article-date">
  <time datetime="2024-08-17T22:50:19.000Z" itemprop="datePublished">2024-08-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7/">小技巧</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>​	仅以此记录工作中一些耗时的任务</p>
<h1 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> Linux</h1>
<h2 id="传输linux源码"><a class="markdownIt-Anchor" href="#传输linux源码"></a> 传输Linux源码</h2>
<table>
<thead>
<tr>
<th>任务</th>
<th>耗时</th>
</tr>
</thead>
<tbody>
<tr>
<td>传输Linux源码</td>
<td>30S</td>
</tr>
</tbody>
</table>
<h2 id="解压linux源码"><a class="markdownIt-Anchor" href="#解压linux源码"></a> 解压Linux源码</h2>
<table>
<thead>
<tr>
<th>任务</th>
<th>耗时</th>
</tr>
</thead>
<tbody>
<tr>
<td>本机解压Linux源码</td>
<td>1m44</td>
</tr>
<tr>
<td>服务器解压Linux源码</td>
<td>1m32</td>
</tr>
<tr>
<td>小主机解压Linux源码</td>
<td>1m52</td>
</tr>
</tbody>
</table>
<h2 id="编译linux源码"><a class="markdownIt-Anchor" href="#编译linux源码"></a> 编译Linux源码</h2>
<table>
<thead>
<tr>
<th>任务</th>
<th>耗时</th>
</tr>
</thead>
<tbody>
<tr>
<td>本机编译buildroot整体镜像</td>
<td>70m7</td>
</tr>
<tr>
<td>服务器编译buildroot整体镜像</td>
<td>54min</td>
</tr>
<tr>
<td>小主机编译buildroot整体镜像</td>
<td>92m16</td>
</tr>
<tr>
<td>本机编译buildroot</td>
<td>50m</td>
</tr>
<tr>
<td>服务器编译buildroot</td>
<td>38m41</td>
</tr>
<tr>
<td>小主机编译buildroot</td>
<td>68min</td>
</tr>
<tr>
<td>本机编译recovery</td>
<td>16min</td>
</tr>
<tr>
<td>服务器编译recovery</td>
<td>12m57</td>
</tr>
<tr>
<td>小主机编译recovery</td>
<td>21min</td>
</tr>
<tr>
<td>本机编译kernel</td>
<td>2m22</td>
</tr>
<tr>
<td>服务器编译kernel</td>
<td>1m16</td>
</tr>
<tr>
<td>小主机编译kernel</td>
<td>3m27</td>
</tr>
</tbody>
</table>
<h2 id="打包linux源码"><a class="markdownIt-Anchor" href="#打包linux源码"></a> 打包Linux源码</h2>
<table>
<thead>
<tr>
<th>任务</th>
<th>耗时</th>
</tr>
</thead>
<tbody>
<tr>
<td>本机打包Linux镜像</td>
<td>8m21</td>
</tr>
<tr>
<td>服务器打包Linux镜像</td>
<td>3m4</td>
</tr>
<tr>
<td>小主机打包Linux镜像</td>
<td>8m28</td>
</tr>
</tbody>
</table>
<h1 id="安卓"><a class="markdownIt-Anchor" href="#安卓"></a> 安卓</h1>
<h2 id="传输安卓源码到服务器"><a class="markdownIt-Anchor" href="#传输安卓源码到服务器"></a> 传输安卓源码到服务器</h2>
<h2 id="解压安卓源码"><a class="markdownIt-Anchor" href="#解压安卓源码"></a> 解压安卓源码</h2>
<h2 id="编译安卓源码"><a class="markdownIt-Anchor" href="#编译安卓源码"></a> 编译安卓源码</h2>
<h2 id="上传安卓源码"><a class="markdownIt-Anchor" href="#上传安卓源码"></a> 上传安卓源码</h2>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-07_小技巧/9_性能测试"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/15/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/9_%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"
    >性能测试</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/15/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/9_%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2024-08-14T22:50:19.000Z" itemprop="datePublished">2024-08-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7/">小技巧</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="1综合性能测试unixbench"><a class="markdownIt-Anchor" href="#1综合性能测试unixbench"></a> 1综合性能测试(unixbench)</h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045325.png" alt="image-20240524145726916" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045331.png" alt="image-20240524145738191" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./Run</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------                                                                                                                                                      </span><br><span class="line">Benchmark Run: 六 5月 25 2024 09:26:51 - 09:54:51                                                                                                                                                                             </span><br><span class="line">8 CPUs in system; running 1 parallel copy of tests                                                                                                                                                                            </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">Dhrystone 2 using register variables       31539593.3 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Double-Precision Whetstone                     6482.1 MWIPS (9.9 s, 7 samples)                                                                                                                                                </span><br><span class="line">Execl Throughput                               5137.7 lps   (29.9 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks        734469.9 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 256 bufsize 500 maxblocks          265982.6 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks       2000659.6 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Pipe Throughput                             1664325.7 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Pipe-based Context Switching                 211808.0 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Process Creation                               4083.5 lps   (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (1 concurrent)                   3877.1 lpm   (60.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (8 concurrent)                   3437.1 lpm   (60.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">System Call Overhead                        1331518.3 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">System Benchmarks Index Values               BASELINE       RESULT    INDEX                                                                                                                                                   </span><br><span class="line">Dhrystone 2 using register variables         116700.0   31539593.3   2702.6                                                                                                                                                   </span><br><span class="line">Double-Precision Whetstone                       55.0       6482.1   1178.6                                                                                                                                                   </span><br><span class="line">Execl Throughput                                 43.0       5137.7   1194.8                                                                                                                                                   </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks          3960.0     734469.9   1854.7                                                                                                                                                   </span><br><span class="line">File Copy 256 bufsize 500 maxblocks            1655.0     265982.6   1607.1                                                                                                                                                   </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks          5800.0    2000659.6   3449.4                                                                                                                                                   </span><br><span class="line">Pipe Throughput                               12440.0    1664325.7   1337.9                                                                                                                                                   </span><br><span class="line">Pipe-based Context Switching                   4000.0     211808.0    529.5                                                                                                                                                   </span><br><span class="line">Process Creation                                126.0       4083.5    324.1                                                                                                                                                   </span><br><span class="line">Shell Scripts (1 concurrent)                     42.4       3877.1    914.4                                                                                                                                                   </span><br><span class="line">Shell Scripts (8 concurrent)                      6.0       3437.1   5728.5                                                                                                                                                   </span><br><span class="line">System Call Overhead                          15000.0    1331518.3    887.7                                                                                                                                                   </span><br><span class="line">                                                                   ========                                                                                                                                                   </span><br><span class="line">System Benchmarks Index Score                                        1364.8                                                                                                                                                   </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">------------------------------------------------------------------------                                                                                                                                                      </span><br><span class="line">Benchmark Run: 六 5月 25 2024 09:54:51 - 10:23:04                                                                                                                                                                             </span><br><span class="line">8 CPUs in system; running 8 parallel copies of tests                                                                                                                                                                          </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">Dhrystone 2 using register variables      157812940.0 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Double-Precision Whetstone                    37250.0 MWIPS (9.6 s, 7 samples)                                                                                                                                                </span><br><span class="line">Execl Throughput                              17709.4 lps   (29.8 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks       2846650.5 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 256 bufsize 500 maxblocks          902894.4 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks       5776203.7 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Pipe Throughput                             8112803.3 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Pipe-based Context Switching                1139800.0 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Process Creation                              32554.8 lps   (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (1 concurrent)                  29022.0 lpm   (60.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (8 concurrent)                   4265.4 lpm   (60.1 s, 2 samples)                                                                                                                                               </span><br><span class="line">System Call Overhead                        8171571.9 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">System Benchmarks Index Values               BASELINE       RESULT    INDEX                                                                                                                                                   </span><br><span class="line">Dhrystone 2 using register variables         116700.0  157812940.0  13523.0                                                                                                                                                   </span><br><span class="line">Double-Precision Whetstone                       55.0      37250.0   6772.7                                                                                                                                                   </span><br><span class="line">Execl Throughput                                 43.0      17709.4   4118.5                                                                                                                                                   </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks          3960.0    2846650.5   7188.5                                                                                                                                                   </span><br><span class="line">File Copy 256 bufsize 500 maxblocks            1655.0     902894.4   5455.6                                                                                                                                                   </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks          5800.0    5776203.7   9959.0                                                                                                                                                   </span><br><span class="line">Pipe Throughput                               12440.0    8112803.3   6521.5                                                                                                                                                   </span><br><span class="line">Pipe-based Context Switching                   4000.0    1139800.0   2849.5                                                                                                                                                   </span><br><span class="line">Process Creation                                126.0      32554.8   2583.7                                                                                                                                                   </span><br><span class="line">Shell Scripts (1 concurrent)                     42.4      29022.0   6844.8                                                                                                                                                   </span><br><span class="line">Shell Scripts (8 concurrent)                      6.0       4265.4   7109.1                                                                                                                                                   </span><br><span class="line">System Call Overhead                          15000.0    8171571.9   5447.7                                                                                                                                                   </span><br><span class="line">                                                                   ========                                                                                                                                                   </span><br><span class="line">System Benchmarks Index Score                                        5925.9                                                                                                                                                   </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">root@topeet:/test/01_unixbench/byte-unixbench-master/UnixBench$   </span><br></pre></td></tr></table></figure>
<h2 id="2cpu性能speccpu2006"><a class="markdownIt-Anchor" href="#2cpu性能speccpu2006"></a> 2.CPU性能(speccpu2006)</h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045327.png" alt="image-20240524150847095" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045355.png" alt="image-20240524151335344" /></p>
<p>安装编译工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install build-essential gfortran</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045346.png" alt="image-20240524151435285" /></p>
<p>问题解决：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim src/make-3.80/glob/glob.c </span><br></pre></td></tr></table></figure>
<p>注释209 232行</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045341.png" alt="image-20240524152454164" /></p>
<p>然后运行根目录下的安装脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045640.png" alt="image-20240524165154844" /></p>
<p>安装完成之后加载环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./shrc</span><br></pre></td></tr></table></figure>
<p>然后输入以下命令确定是否安装成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runspec -V</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045771.png" alt="image-20240524165323929" /></p>
<p>测试命令和说明：</p>
<ol>
<li>
<p><code>runspec --reportable -c arm64.cfg -n 1 -r 1 --tune=base all</code></p>
<ul>
<li><code>--reportable</code>: 表示可以展示为 SPEC 官方可报告的测试结果</li>
<li><code>-c rk3588.cfg</code>: 指定使用 <code>rk3588.cfg</code> 这个配置文件</li>
<li><code>-n 1</code>: 测试次数为 1 次</li>
<li><code>-r 1</code>: 运行 1 线程(默认 1 线程,speed 模式)</li>
<li><code>--tune=base</code>: 使用 base 基准测试模式</li>
<li><code>all</code>: 表示测试所有的整数和浮点测试项</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">                                  Estimated                       Estimated                                  </span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak                                     </span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate                                     </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------                                  </span><br><span class="line">400.perlbench       1        420       23.3 *                                                                </span><br><span class="line">401.bzip2           1        588       16.4 *                                                                </span><br><span class="line">403.gcc             1        404       19.9 *                                                                </span><br><span class="line">429.mcf             1        475       19.2 *                                                                </span><br><span class="line">445.gobmk           1        474       22.1 *                                                                </span><br><span class="line">456.hmmer           1        253       36.9 *                                                                </span><br><span class="line">458.sjeng           1        628       19.3 *                                                                </span><br><span class="line">462.libquantum      1        207      100   *                                                                </span><br><span class="line">464.h264ref         1        533       41.5 *                                                                </span><br><span class="line">471.omnetpp         1        561       11.1 *                                                                </span><br><span class="line">473.astar           1        479       14.6 *                                                                </span><br><span class="line">483.xalancbmk       1        417       16.5 *                                                                </span><br><span class="line"> Est. SPECint_rate_base2006            23.3                                                                  </span><br><span class="line"> Est. SPECint_rate2006                                              Not Run                                  </span><br><span class="line">                                                                                                             </span><br><span class="line">      set: fp                                                                                                </span><br><span class="line">        format: raw -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.rsf                           </span><br><span class="line">        format: flags -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.flags.html                  </span><br><span class="line">        format: ASCII -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.txt                         </span><br><span class="line">        format: PDF -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.pdf                           </span><br><span class="line">        format: Submission Check -&gt; PASSED syntax check                                                      </span><br><span class="line">        format: Screen -&gt;                                                                                    </span><br><span class="line">                                                                                                             </span><br><span class="line">                                  Estimated                       Estimated                                  </span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak                                     </span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate                                     </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------                                  </span><br><span class="line">410.bwaves          1        320       42.4 *                                                                </span><br><span class="line">416.gamess          1        674       29.1 *                                                                </span><br><span class="line">433.milc            1        327       28.1 *                                                                </span><br><span class="line">434.zeusmp          1        459       19.8 *                                                                </span><br><span class="line">435.gromacs         1        308       23.2 *                                                                </span><br><span class="line">436.cactusADM       1        812       14.7 *                                                                </span><br><span class="line">437.leslie3d        1        306       30.8 *                                                                </span><br><span class="line">444.namd            1        387       20.7 *                                                                </span><br><span class="line">447.dealII          1        270       42.4 *                                                                </span><br><span class="line">450.soplex          1        308       27.1 *                                                                </span><br><span class="line">453.povray          1        131       40.6 *                                                                </span><br><span class="line">454.calculix        1        317       26.0 *                                                                </span><br><span class="line">459.GemsFDTD        1        388       27.3 *                                                                </span><br><span class="line">465.tonto           1        304       32.4 *                                                                </span><br><span class="line">470.lbm             1        350       39.2 *                                                                </span><br><span class="line">481.wrf             1        287       38.9 *                                                                </span><br><span class="line">482.sphinx3         1        825       23.6 *                                                                </span><br><span class="line"> Est. SPECfp_rate_base2006             28.6                                                                  </span><br><span class="line"> Est. SPECfp_rate2006                                               Not Run       </span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>runspec --reportable -c arm64.cfg -n 1 -r N --tune=base all</code></p>
<ul>
<li><code>--reportable</code>: 表示可以展示为 SPEC 官方可报告的测试结果</li>
<li><code>-n 1</code>: 测试次数为 1 次</li>
<li><code>-r N</code>: 运行 N 线程(rate 模式,测试吞吐量)</li>
<li><code>--tune=base</code>: 使用 base 基准测试模式</li>
<li><code>all</code>: 表示测试所有的整数和浮点测试项</li>
</ul>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">                                  Estimated                       Estimated</span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak</span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------</span><br><span class="line">400.perlbench       1        417       23.4 *                                  </span><br><span class="line">401.bzip2           1        591       16.3 *                                  </span><br><span class="line">403.gcc             1        409       19.7 *                                  </span><br><span class="line">429.mcf             1        442       20.6 *                                  </span><br><span class="line">445.gobmk           1        474       22.1 *                                  </span><br><span class="line">456.hmmer           1        254       36.8 *                                  </span><br><span class="line">458.sjeng           1        629       19.2 *                                  </span><br><span class="line">462.libquantum      1        207       99.9 *                                  </span><br><span class="line">464.h264ref         1        534       41.4 *                                  </span><br><span class="line">471.omnetpp         1        569       11.0 *                                  </span><br><span class="line">473.astar           1        471       14.9 *                                  </span><br><span class="line">483.xalancbmk       1        408       16.9 *                                  </span><br><span class="line"> Est. SPECint_rate_base2006            23.5</span><br><span class="line"> Est. SPECint_rate2006                                              Not Run</span><br><span class="line"></span><br><span class="line">      set: fp</span><br><span class="line">        format: raw -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.rsf</span><br><span class="line">        format: flags -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.flags.html</span><br><span class="line">        format: ASCII -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.txt</span><br><span class="line">        format: PDF -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.pdf</span><br><span class="line">        format: Submission Check -&gt; PASSED syntax check</span><br><span class="line">        format: Screen -&gt; </span><br><span class="line"></span><br><span class="line">                                  Estimated                       Estimated</span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak</span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------</span><br><span class="line">410.bwaves          1        326       41.7 *                                  </span><br><span class="line">416.gamess          1        674       29.0 *                                  </span><br><span class="line">433.milc            1        331       27.7 *                                  </span><br><span class="line">434.zeusmp          1        450       20.2 *                                  </span><br><span class="line">435.gromacs         1        308       23.1 *                                  </span><br><span class="line">436.cactusADM       1        814       14.7 *                                  </span><br><span class="line">437.leslie3d        1        306       30.7 *                                  </span><br><span class="line">444.namd            1        387       20.7 *                                  </span><br><span class="line">447.dealII          1        268       42.7 *                                  </span><br><span class="line">450.soplex          1        322       25.9 *                                  </span><br><span class="line">453.povray          1        131       40.5 *                                  </span><br><span class="line">454.calculix        1        317       26.0 *                                  </span><br><span class="line">459.GemsFDTD        1        390       27.2 *                                  </span><br><span class="line">465.tonto           1        304       32.3 *                                  </span><br><span class="line">470.lbm             1        351       39.2 *                                  </span><br><span class="line">481.wrf             1        287       39.0 *                                  </span><br><span class="line">482.sphinx3         1        813       24.0 *                                  </span><br><span class="line"> Est. SPECfp_rate_base2006             28.5</span><br><span class="line"> Est. SPECfp_rate2006                                               Not Run</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Benchmarks</td>
<td style="text-align:left">Estimated Base</td>
<td style="text-align:left">Estimated Base</td>
<td style="text-align:left">Estimated Base</td>
<td style="text-align:left">Estimated Peak</td>
<td style="text-align:left">Estimated Peak</td>
<td style="text-align:left">Estimated Peak</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Copies</td>
<td style="text-align:left">Run Time</td>
<td style="text-align:left">Rate</td>
<td style="text-align:left">Copies</td>
<td style="text-align:left">Run Time</td>
<td style="text-align:left">Rate</td>
</tr>
<tr>
<td style="text-align:left">400.perlbench</td>
<td style="text-align:left">1</td>
<td style="text-align:left">420</td>
<td style="text-align:left">23.3 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">401.bzip2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">588</td>
<td style="text-align:left">16.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">403.gcc</td>
<td style="text-align:left">1</td>
<td style="text-align:left">404</td>
<td style="text-align:left">19.9 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">429.mcf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">475</td>
<td style="text-align:left">19.2 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">445.gobmk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">474</td>
<td style="text-align:left">22.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">456.hmmer</td>
<td style="text-align:left">1</td>
<td style="text-align:left">253</td>
<td style="text-align:left">36.9 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">458.sjeng</td>
<td style="text-align:left">1</td>
<td style="text-align:left">628</td>
<td style="text-align:left">19.3 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">462.libquantum</td>
<td style="text-align:left">1</td>
<td style="text-align:left">207</td>
<td style="text-align:left">100 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">464.h264ref</td>
<td style="text-align:left">1</td>
<td style="text-align:left">533</td>
<td style="text-align:left">41.5 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">471.omnetpp</td>
<td style="text-align:left">1</td>
<td style="text-align:left">561</td>
<td style="text-align:left">11.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">473.astar</td>
<td style="text-align:left">1</td>
<td style="text-align:left">479</td>
<td style="text-align:left">14.6 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">483.xalancbmk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">417</td>
<td style="text-align:left">16.5 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECint_rate_base2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">23.3</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECint_rate2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">Not Run</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">410.bwaves</td>
<td style="text-align:left">1</td>
<td style="text-align:left">320</td>
<td style="text-align:left">42.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">416.gamess</td>
<td style="text-align:left">1</td>
<td style="text-align:left">674</td>
<td style="text-align:left">29.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">433.milc</td>
<td style="text-align:left">1</td>
<td style="text-align:left">327</td>
<td style="text-align:left">28.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">434.zeusmp</td>
<td style="text-align:left">1</td>
<td style="text-align:left">459</td>
<td style="text-align:left">19.8 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">435.gromacs</td>
<td style="text-align:left">1</td>
<td style="text-align:left">308</td>
<td style="text-align:left">23.2 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">436.cactusADM</td>
<td style="text-align:left">1</td>
<td style="text-align:left">812</td>
<td style="text-align:left">14.7 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">437.leslie3d</td>
<td style="text-align:left">1</td>
<td style="text-align:left">306</td>
<td style="text-align:left">30.8 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">444.namd</td>
<td style="text-align:left">1</td>
<td style="text-align:left">387</td>
<td style="text-align:left">20.7 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">447.dealII</td>
<td style="text-align:left">1</td>
<td style="text-align:left">270</td>
<td style="text-align:left">42.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">450.soplex</td>
<td style="text-align:left">1</td>
<td style="text-align:left">308</td>
<td style="text-align:left">27.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">453.povray</td>
<td style="text-align:left">1</td>
<td style="text-align:left">131</td>
<td style="text-align:left">40.6 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">454.calculix</td>
<td style="text-align:left">1</td>
<td style="text-align:left">317</td>
<td style="text-align:left">26.0 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">459.GemsFDTD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">388</td>
<td style="text-align:left">27.3 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">465.tonto</td>
<td style="text-align:left">1</td>
<td style="text-align:left">304</td>
<td style="text-align:left">32.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">470.lbm</td>
<td style="text-align:left">1</td>
<td style="text-align:left">350</td>
<td style="text-align:left">39.2 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">481.wrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">287</td>
<td style="text-align:left">38.9 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">482.sphinx3</td>
<td style="text-align:left">1</td>
<td style="text-align:left">825</td>
<td style="text-align:left">23.6 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECfp_rate_base2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">28.6</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECfp_rate2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">Not Run</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="3系统综合性能lmbench"><a class="markdownIt-Anchor" href="#3系统综合性能lmbench"></a> <strong>3.系统综合性能(Lmbench)</strong></h2>
<h3 id="一-引言"><a class="markdownIt-Anchor" href="#一-引言"></a> 一、引言</h3>
<p>Lmbench 是一套简易可移植的，符合ANSI/C 标准为UNIX/POSIX 而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。Lmbench 旨在使系统开发者深入了解关键操作的基础成本。（百度Lmbench了解详情）</p>
<h3 id="二-软件说明和下载"><a class="markdownIt-Anchor" href="#二-软件说明和下载"></a> 二、软件说明和下载</h3>
<p>软件说明：</p>
<p>lmbench是个用于评价系统综合性能的多平台开源benchmark，能够测试包括文档读写、内存操作、进程创建销毁开销、网络等性能，测试 方法简单。<br />
Lmbench是个多平台软件，因此能够对同级别的系统进行比较测试，反映不同系统的优劣势，通过选择不同的库函数我们就能够比较库函数的性能；更为重要的是，作为一个开源软件， lmbench提供一个测试框架，假如测试者对测试项目有更高的测试需要，能够通过少量的修改源代码达到目的（比如现在只能评测进程创建、终止的性能和进程转换的开销，通过修改部分代码即可实现线程级别的性能测试）</p>
<p>下载：</p>
<p>方式一：百度网盘为本人的一个工具，带有编写好的脚本，可直接运行脚本进行测试。</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1GJ7iOSTYQa4THAjjiD4TXQ">https://pan.baidu.com/s/1GJ7iOSTYQa4THAjjiD4TXQ</a><br />
提取码：jayn</p>
<p>方式二：<a target="_blank" rel="noopener" href="http://www.bitmover.com/">www.bitmover.com/</a> lmbench  （进入该网站下载）</p>
<h3 id="三-测试步骤"><a class="markdownIt-Anchor" href="#三-测试步骤"></a> 三、测试步骤</h3>
<h4 id="31上传安装包到home路径解压文件并赋予权限"><a class="markdownIt-Anchor" href="#31上传安装包到home路径解压文件并赋予权限"></a> 3.1上传安装包到/home路径，解压文件并赋予权限</h4>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045728.png" alt="image-20240524143848374" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045712.png" alt="image-20240524143902227" /></p>
<p>​	然后赋予权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 *</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045798.png" alt="image-20240524143945906" /></p>
<h4 id="32-测试执行"><a class="markdownIt-Anchor" href="#32-测试执行"></a> 3.2、测试执行</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash lmbench-test.sh </span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045011.png" alt="image-20240524144003996" /></p>
<p>==要改一下存储容量大小，我改为了6000==</p>
<h3 id="4-查看结果"><a class="markdownIt-Anchor" href="#4-查看结果"></a> 4 查看结果</h3>
<p>执行 make see 查看运行结果，若只出现两行命令，显示运行结果输出到了 summary.out 文件中，则直接查看该文件即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ./results/summary.out</span><br></pre></td></tr></table></figure>
<p>将会看到如下输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">make[1]: Entering directory &#x27;/test/03_lmbench/lmbench-3.0-a9/results&#x27;</span><br><span class="line"></span><br><span class="line">                 L M B E N C H  3 . 0   S U M M A R Y</span><br><span class="line">                 ------------------------------------</span><br><span class="line">                 (Alpha software, do not distribute)</span><br><span class="line"></span><br><span class="line">Basic system parameters</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Host                 OS Description              Mhz  tlb  cache  mem   scal</span><br><span class="line">                                                     pages line   par   load</span><br><span class="line">                                                           bytes  </span><br><span class="line">--------- ------------- ----------------------- ---- ----- ----- ------ ----</span><br><span class="line">topeet    Linux 5.10.19       aarch64-linux-gnu 2279    48   128   22.3    1</span><br><span class="line">topeet    Linux 5.10.19       aarch64-linux-gnu 2279    48   128   22.4    1</span><br><span class="line"></span><br><span class="line">Processor, Processes - times in microseconds - smaller is better</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Host                 OS  Mhz null null      open slct sig  sig  fork exec sh  </span><br><span class="line">                             call  I/O stat clos TCP  inst hndl proc proc proc</span><br><span class="line">--------- ------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----</span><br><span class="line">topeet    Linux 5.10.19 2279 0.13 0.16 0.56 4.07 2.84 0.17 0.88 356. 870. 2189</span><br><span class="line">topeet    Linux 5.10.19 2279 0.13 0.16 0.57 1.63 2.81 0.17 0.89 347. 879. 2123</span><br><span class="line"></span><br><span class="line">Basic integer operations - times in nanoseconds - smaller is better</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Host                 OS  intgr intgr  intgr  intgr  intgr  </span><br><span class="line">                          bit   add    mul    div    mod   </span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19 0.3300 0.2200 0.8900 3.5100 3.6200</span><br><span class="line">topeet    Linux 5.10.19 0.3300 0.2200 0.8900 3.5100 3.6200</span><br><span class="line"></span><br><span class="line">Basic uint64 operations - times in nanoseconds - smaller is better</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">Host                 OS int64  int64  int64  int64  int64  </span><br><span class="line">                         bit    add    mul    div    mod   </span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19  0.330        1.7900 2.8500 4.5000</span><br><span class="line">topeet    Linux 5.10.19  0.330        1.7900 2.8500 4.5000</span><br><span class="line"></span><br><span class="line">Basic float operations - times in nanoseconds - smaller is better</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">Host                 OS  float  float  float  float</span><br><span class="line">                         add    mul    div    bogo</span><br><span class="line">--------- ------------- ------ ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 3.5100 1.2100</span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 3.5100 1.2100</span><br><span class="line"></span><br><span class="line">Basic double operations - times in nanoseconds - smaller is better</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">Host                 OS  double double double double</span><br><span class="line">                         add    mul    div    bogo</span><br><span class="line">--------- ------------- ------  ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 5.2600 2.4200</span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 5.2700 2.4200</span><br><span class="line"></span><br><span class="line">Context switching - times in microseconds - smaller is better</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">Host                 OS  2p/0K 2p/16K 2p/64K 8p/16K 8p/64K 16p/16K 16p/64K</span><br><span class="line">                         ctxsw  ctxsw  ctxsw ctxsw  ctxsw   ctxsw   ctxsw</span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------ ------- -------</span><br><span class="line">topeet    Linux 5.10.19 1.2600 1.2700 1.4100 8.9200 9.0500 7.48000    13.8</span><br><span class="line">topeet    Linux 5.10.19 1.2400 1.3000        5.2900 0.5600 6.36000 2.83000</span><br><span class="line"></span><br><span class="line">*Local* Communication latencies in microseconds - smaller is better</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">Host                 OS 2p/0K  Pipe AF     UDP  RPC/   TCP  RPC/ TCP</span><br><span class="line">                        ctxsw       UNIX         UDP         TCP conn</span><br><span class="line">--------- ------------- ----- ----- ---- ----- ----- ----- ----- ----</span><br><span class="line">topeet    Linux 5.10.19 1.260 4.775 25.0 8.477        10.7        99.</span><br><span class="line">topeet    Linux 5.10.19 1.240 4.753 5.26 8.399        10.6        79.</span><br><span class="line"></span><br><span class="line">*Remote* Communication latencies in microseconds - smaller is better</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">Host                 OS   UDP  RPC/  TCP   RPC/ TCP</span><br><span class="line">                               UDP         TCP  conn</span><br><span class="line">--------- ------------- ----- ----- ----- ----- ----</span><br><span class="line">topeet    Linux 5.10.19                             </span><br><span class="line">topeet    Linux 5.10.19                             </span><br><span class="line"></span><br><span class="line">File &amp; VM system latencies in microseconds - smaller is better</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Host                 OS   0K File      10K File     Mmap    Prot   Page   100fd</span><br><span class="line">                        Create Delete Create Delete Latency Fault  Fault  selct</span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------- ----- ------- -----</span><br><span class="line">topeet    Linux 5.10.19 9.0826 5.9360   21.8   11.7  8992.0 0.162 0.10570 1.325</span><br><span class="line">topeet    Linux 5.10.19 9.3983 6.2696   21.8   11.2  8695.0 0.162 0.11910 1.300</span><br><span class="line"></span><br><span class="line">*Local* Communication bandwidths in MB/s - bigger is better</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">Host                OS  Pipe AF    TCP  File   Mmap  Bcopy  Bcopy  Mem   Mem</span><br><span class="line">                             UNIX      reread reread (libc) (hand) read write</span><br><span class="line">--------- ------------- ---- ---- ---- ------ ------ ------ ------ ---- -----</span><br><span class="line">topeet    Linux 5.10.19 2384 6458 2027 5744.7  17.4K  11.8K 8924.8 10.K 17.9K</span><br><span class="line">topeet    Linux 5.10.19 2448 6468 3177 5695.6  17.5K  12.0K 8938.3 10.K 17.8K</span><br><span class="line"></span><br><span class="line">Memory latencies in nanoseconds - smaller is better</span><br><span class="line">    (WARNING - may not be correct, check graphs)</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Host                 OS   Mhz   L1 $   L2 $    Main mem    Rand mem    Guesses</span><br><span class="line">--------- -------------   ---   ----   ----    --------    --------    -------</span><br><span class="line">topeet    Linux 5.10.19  2279 1.7630 2.6940    6.965000       441.6</span><br><span class="line">topeet    Linux 5.10.19  2279 1.7640 2.6870    6.889000       408.4</span><br><span class="line">make[1]: Leaving directory &#x27;/test/03_lmbench/lmbench-3.0-a9/results&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="41-系统基本信息"><a class="markdownIt-Anchor" href="#41-系统基本信息"></a> 4.1. 系统基本信息</h4>
<p>输出结果中开始显示系统的基本参数信息。</p>
<p>其中：</p>
<p>tlb: 表示转换后备缓存的页面数；</p>
<p>cache line bytes: 高速缓存行字节数</p>
<p>mem par: 存储器分层并行化；</p>
<p>scal load: 并行执行的 Lmbench 数目。</p>
<h4 id="42-处理器-processor-性能"><a class="markdownIt-Anchor" href="#42-处理器-processor-性能"></a> 4.2. 处理器 Processor 性能</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>null call: 执行 getppid 需要的时间；</p>
<p>null I/O: 从 /dev/zero 读取一个字节的时长 t1，写一个字节到 /dev/null 的时长 t2，t1、t2 取平均值即为该项结果；</p>
<p>stat: stat 一个文件（即得到一个文件的信息）所需时长；</p>
<p>open clos: open 一个文件接着再 close 掉该文件一共所用时间（不包含读目录和节点的时间）；</p>
<p>slct TCP: 通过 TCP 网络连接选择 100 个文件描述符所消耗的时间；</p>
<p>sig inst: install signal 所耗时长；</p>
<p>sig hndl: handler signal 所耗时长；</p>
<p>fork proc: fork 一个完全相同的 process，并把原来的 process 关掉一共所消耗的时间；</p>
<p>exec proc: 模拟一个 shell 进程的工作过程：fork 一个新进程执行新命令消耗的时间。</p>
<p>sh proc: fork 一个进程，同时询问系统 shell 来找到并运行一个新程序所用时间。</p>
<h4 id="43-数学运算"><a class="markdownIt-Anchor" href="#43-数学运算"></a> 4.3. 数学运算</h4>
<p>如下输出结果单位均为 ns，数值越小表示性能越好。</p>
<p>(1) 整型计算</p>
<p>(2) 无符号整型计算</p>
<p>(3) 浮点型计算</p>
<p>(4) 双精度浮点型计算</p>
<h4 id="44-上下文切换"><a class="markdownIt-Anchor" href="#44-上下文切换"></a> 4.4. 上下文切换</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>多个进程用 unix pipe 环连接起来，每个进程从自己的管道中读取 token，执行任务，然后将 token 写给下一个进程。</p>
<p>context swithing 时间包括：切换进程的时间，加上恢复进程所有状态所用的时间（包含恢复 cache 状态）。</p>
<p>2p/0k: 每个进程的 size 为 0（不执行任何任务），进程数为 2 时上下文切换所消耗的时间；</p>
<p>2p/16k: 每个进程 size 为 16K（执行任务），进程数为 2 时上下文切换所消耗的时间；</p>
<p>之后的测试项以此类推。</p>
<h4 id="45-本地通讯时延"><a class="markdownIt-Anchor" href="#45-本地通讯时延"></a> 4.5. 本地通讯时延</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>2p/0k: 每个进程的 size 为 0（不执行任何任务），进程数为 2 时上下文切换所消耗的时间；</p>
<p>Pipe: 即所谓的 hot potato 测试，两个没有具体任务的进程之间使用 pipe 通信，一个 token 在两个进程间来回传递，传递一个来回所消耗时长的平均值；</p>
<p>AF UNIX: 同 Pipe 测试项，但进程间通信使用的是 socket 通信；</p>
<p>UDP: 同 Pipe 测试项，但进程间通信使用的是 UDP/IP 通信；</p>
<p>RPC/UDP: 同 Pipe 测试项，但进程间通信使用的是 sun RPC 通信，默认情况下，RPC 采用 UDP 协议传输；</p>
<p>TCP: 同 Pipe 测试项，但进程间通信使用的是 TCP/IP 通信；</p>
<p>RPC/TCP: 同 Pipe 测试项，但进程间通信使用的是 sun RPC 通信，指定 RPC 采用 TCP 协议传输；</p>
<p>TCP conn: 创建 socket 描述符和建立连接所用时间。</p>
<h4 id="46-文件-内存延时"><a class="markdownIt-Anchor" href="#46-文件-内存延时"></a> 4.6. 文件、内存延时</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>0K File Create: 0K 文件创建所用时间；</p>
<p>0K File Delete: 0K 文件删除所用时间；</p>
<p>10K File Create: 10K 文件创建所用时间；</p>
<p>10K File Delete: 10K 文件删除所用时间；</p>
<p>Mmap Latency: 将指定文件的开头 n 个字节 mmap 到内存，然后 unmap，并记录每次 mmap 和 unmap 共消耗的时间，去每次消耗时间的最大值；</p>
<p>Port Fault: 保护页延时时间；</p>
<p>Page Faule: 缺页延时时间；</p>
<p>100fd selct: 对 100 个文件描述符配置 select 的时间。</p>
<h4 id="47-本地通信带宽"><a class="markdownIt-Anchor" href="#47-本地通信带宽"></a> 4.7. 本地通信带宽</h4>
<p>如下输出结果单位均为 MB/s，数值越大表示性能越好。</p>
<p>Pipe: 在两个进程建立 pipe，pipe 的每个 chunk 为 64K，通过该管道移动 50MB 数据所消耗的时间；</p>
<p>AF UNIX: 两个进程之间建立 unix stream socket 连接，每个 chunk 为 64K，通过该 socket 传输 10MB 数据所用的时间；</p>
<p>TCP: 同 Pipe 测试项，但进程间使用 TCP/IP socket 通信，传输数据量为 3MB；</p>
<p>File reread: 读文件并将其汇总一起所用的时间；</p>
<p>Mmap reread: 将文件 mmap 到内存中，从内存中读文件并将其汇总一起所用时间；</p>
<p>Bcopy(libc):dobw_mem i bcopy，从指定内存区域拷贝指定数量的字节内容到另一个指定内存区域的速度；</p>
<p>Bcopy(hand): do bw_mem %i fcp，把数据从磁盘的一个位置拷贝到另一个位置所用的时间；</p>
<p>Mem read: bw_mem i frd，累加数组中的整数值，测试把数据读入 processor 的带宽；</p>
<p>Mem write: do bw_mem fwr，把整数数组的每个成员设置为 1，测试写数据到内存的带宽。</p>
<h4 id="48-内存操作延时"><a class="markdownIt-Anchor" href="#48-内存操作延时"></a> 4.8. 内存操作延时</h4>
<p>如下输出结果单位均为 ns，数值越小表示性能越好。</p>
<p>本地测试执行 lat_mem_rd，将整数数组中每第 4 个元素的值累加起来；测试的是读数据到 processor 的带宽。</p>
<p>L1： 缓存1</p>
<p>L2： 缓存2</p>
<p>Main Mem： 连续内存</p>
<p>Rand Mem： 内存随机访问延时</p>
<p>Guesses:</p>
<p>假如 L1 和 L2 近似，会显示 “No L1 cache?”</p>
<p>假如 L2 和 Main Mem 近似，会显示 “No L2 cache?”</p>
<h2 id="4内存带宽性能stream"><a class="markdownIt-Anchor" href="#4内存带宽性能stream"></a> <strong>4.内存带宽性能(stream)</strong></h2>
<p>1.安装gfortran：</p>
<p>apt-get install gfortran</p>
<p>2.解压stream工具包</p>
<p>tar xvf stream-5.9-1.tar.bz2</p>
<p>3.进入到解压目录执行编译：</p>
<p>cd stream-5.9-1</p>
<p>make<br />
4.同时运行单线程和多线程测试</p>
<p>./Run.sh -n 1 -n 4 -n 8</p>
<p>注：这里的-n参数的值根据实际CPU核数设定,如只有4核，只跑./Run -n 1 -n 4，以此类推；</p>
<p>5.执行完后到results目录查看结果</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045131.png" alt="image-20240527131621866" /></p>
<h2 id="5硬盘读写性能iozone"><a class="markdownIt-Anchor" href="#5硬盘读写性能iozone"></a> <strong>5.硬盘读写性能(iozone)</strong></h2>
<p>解压之后进入源码目录/iozone3_430/src/current下，如下图所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045120.png" alt="image-20240524171745999" /></p>
<p>编译make CFLAGS=-fcommon linux-arm</p>
<p>编译完成如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045208.png" alt="image-20240524172141636" /></p>
<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./iozone -s 4g -i 0 -i 1 -i 2 -a -y 4k -q 16384k -f /iozonefile -Rb /home/iozonefile_rk3588.xls</span><br><span class="line">./iozone -s 8g -i 0 -i 1 -i 2 -a -y 4k -q 16384k -f /iozonefile -Rb /home/iozonefile_rk3588_8.xls</span><br><span class="line">./iozone -s 16g -i 0 -i 1 -i 2 -a -y 4k -q 16384k -f /iozonefile -Rb /home/iozonefile_rk3588_16.xls</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">                                                              random    random     bkwd    record    stride                                    </span><br><span class="line">              kB  reclen    write  rewrite    read    reread    read     write     read   rewrite      read   fwrite frewrite    fread  freread</span><br><span class="line">         4194304       4   436116   358158  5174402  4094807  2270951   252551                                                          </span><br><span class="line">         4194304       8   483751   256332  6320444  4891630  3472364   269135                                                          </span><br><span class="line">         4194304      16   552179   684541  6972783  5524091  5331936   191062                                                          </span><br><span class="line">         4194304      32   559849   265827  7379428  5821622  6585738   586108                                                          </span><br><span class="line">         4194304      64   568082   280172  7673710  6031385  7545110   585944                                                          </span><br><span class="line">         4194304     128   573306   500080  9033916  6142411  8316207   190163                                                          </span><br><span class="line">         4194304     256   573799   354331  7653196  6182861  8500953   381861                                                          </span><br><span class="line">         4194304     512   576573   457535  7674945  6020641  8491712   281622                                                          </span><br><span class="line">         4194304    1024   610564   252042  7706394  5969902  8495998   205003                                                          </span><br><span class="line">         4194304    2048   562769   698420  6728767  5158486  6865677   337050                                                          </span><br><span class="line">         4194304    4096   539499   365094  4529862  3965179  4768454   339728                                                          </span><br><span class="line">         4194304    8192   532515   545150  3921947  3663390  4292595   368336                                                          </span><br><span class="line">         4194304   16384   567006   310780  3897468  3539879  4119894   285764                                                          </span><br><span class="line"></span><br><span class="line">iozone test complete.</span><br><span class="line">Excel output is below:</span><br><span class="line"></span><br><span class="line">&quot;Writer report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   436116  483751  552179  559849  568082  573306  573799  576573  610564  562769  539499  532515  567006 </span><br><span class="line"></span><br><span class="line">&quot;Re-writer report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   358158  256332  684541  265827  280172  500080  354331  457535  252042  698420  365094  545150  310780 </span><br><span class="line"></span><br><span class="line">&quot;Reader report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   5174402  6320444  6972783  7379428  7673710  9033916  7653196  7674945  7706394  6728767  4529862  3921947  3897468 </span><br><span class="line"></span><br><span class="line">&quot;Re-Reader report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   4094807  4891630  5524091  5821622  6031385  6142411  6182861  6020641  5969902  5158486  3965179  3663390  3539879 </span><br><span class="line"></span><br><span class="line">&quot;Random read report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   2270951  3472364  5331936  6585738  7545110  8316207  8500953  8491712  8495998  6865677  4768454  4292595  4119894 </span><br><span class="line"></span><br><span class="line">&quot;Random write report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   252551  269135  191062  586108  585944  190163  381861  281622  205003  337050  339728  368336  285764 </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./iozone -i 0 -i 1  -i 2 -f /iozonefile　-s 16G -Rb iozonefile_rk3588_16.xls</span><br><span class="line">./iozone -i 0 -i 1  -i 2 -f /iozonefile　 -s 8G  -Rb iozonefile_rk3588_8.xls</span><br><span class="line">./iozone -i 0 -i 1  -i 2 -f /iozonefile　 -s 4G  -Rb iozonefile_rk3588_4.xls</span><br></pre></td></tr></table></figure>
<h2 id="6网络传输性能netperf"><a class="markdownIt-Anchor" href="#6网络传输性能netperf"></a> <strong>6.网络传输性能(netperf)</strong></h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045197.png" alt="image-20240524173321029" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure -build=alpha</span><br><span class="line">make CFLAGS=-fcommon </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045342.png" alt="image-20240524173812947" /></p>
<p>在另一台机器上安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install netperf</span><br></pre></td></tr></table></figure>
<p>然后执行netserver命令启动监听服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netperf -H 192.168.1.221 -t TCP_STREAM -l 60 &gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t UDP_STREAM -l 60 &gt;&gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t TCP_RR -l 60 &gt;&gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t UDP_RR -l 60 &gt;&gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t TCP_CRR -l 60 &gt;&gt; netperf.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET</span><br><span class="line">Recv   Send    Send                          </span><br><span class="line">Socket Socket  Message  Elapsed              </span><br><span class="line">Size   Size    Size     Time     Throughput  </span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec  </span><br><span class="line"></span><br><span class="line">131072  16384  16384    60.00    44262.95   </span><br><span class="line">MIGRATED UDP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET</span><br><span class="line">Socket  Message  Elapsed      Messages                </span><br><span class="line">Size    Size     Time         Okay Errors   Throughput</span><br><span class="line">bytes   bytes    secs            #      #   10^6bits/sec</span><br><span class="line"></span><br><span class="line">212992   65507   60.00     7031396      0    61413.95</span><br><span class="line">212992           60.00     7016613           61284.84</span><br><span class="line"></span><br><span class="line">MIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET : first burst 0</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate         </span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec   </span><br><span class="line"></span><br><span class="line">16384  131072 1        1       60.00    93255.47   </span><br><span class="line">16384  131072</span><br><span class="line">MIGRATED UDP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET : first burst 0</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate         </span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec   </span><br><span class="line"></span><br><span class="line">212992 212992 1        1       60.00    95949.79   </span><br><span class="line">212992 212992</span><br><span class="line">MIGRATED TCP Connect/Request/Response TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate         </span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec   </span><br><span class="line"></span><br><span class="line">16384  131072 1        1       60.00    23631.47   </span><br><span class="line">16384  131072</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>TCP STREAM<br />
1） 远端系统（即server）使用大小为87380字节的socket接收缓冲<br />
2） 本地系统（即client）使用大小为16384字节的socket发送缓冲<br />
3） 向远端系统发送的测试分组大小为16384字节<br />
4） 测试经历的时间为60.03秒<br />
5） 吞吐量的测试结果为941.47Mbits/秒</p>
</li>
<li>
<p>UDP_STREAM<br />
UDP_STREAM方式的结果中有两行测试数据，第一行显示的是本地系统的发送统计，这里的吞吐量表示netperf向本地socket发送分组的能力。第二行显示的就是远端系统接收的情况。</p>
</li>
<li>
<p>TCP_RR<br />
TCP_RR方式的测试对象是多次TCP request和response的交易过程，但是它们发生在同一个TCP连接中，这种模式常常出现在数据库应用中。数据库的client程序与server程序建立一个TCP连接以后，就在这个连接中传送数据库的多次交易过程。<br />
Netperf输出的结果也是由两行组成。第一行显示本地系统的情况，第二行显示的是远端系统的信息。平均的交易率（transaction rate）为3094.64次/秒。注意到这里每次交易中的request和response分组的大小都为1个字节，不具有很大的实际意义。用户可以通过测试相关的参数来改变request和response分组的大小，TCP_RR方式下的参数如下表所示：<br />
参数说明：<br />
-r req,resp 设置request和reponse分组的大小<br />
-s size 设置本地系统的socket发送与接收缓冲大小<br />
-S size 设置远端系统的socket发送与接收缓冲大小<br />
-D 对本地与远端系统的socket设置TCP_NODELAY选项</p>
</li>
<li>
<p>UDP_RR<br />
UDP_RR方式使用UDP分组进行request/response的交易过程。没有TCP连接所带来的负担。<br />
可能会受到网络中路由器或其它的网络设备对UDP采用了与TCP不同的缓冲区空间和处理技术影响,正常情况下会高于TCP_RR的值。本次测试结果为3136.53次/秒。</p>
</li>
<li>
<p>TCP_CRR<br />
与TCP_RR不同，TCP_CRR为每次交易建立一个新的TCP连接。最典型的应用就是HTTP，每次HTTP交易是在一条单独的TCP连接中进行的。因此，由于需要不停地建立新的TCP连接，并且在交易结束后拆除TCP连接，交易率一定会受到很大的影响。</p>
</li>
</ol>
<p>这里交易率明显的降低了，只有1422.23次/秒。</p>
<h2 id="7数据盘读写性能fio"><a class="markdownIt-Anchor" href="#7数据盘读写性能fio"></a> 7.数据盘读写性能(fio)</h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045589.png" alt="image-20240524175402485" /></p>
<p>测试方法<br />
安装libaio：（注意：顺序不能反，一定要先安装libaio，再编译）<br />
桌面版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get -y install libaio1 libaio-dev libraw-dev</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd fio-2.1.10</span><br><span class="line"> ./configure --cpu=aarch64</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045567.png" alt="image-20240524181017554" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=read -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_read.result &gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=write -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_write.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fio -filename=/test.1M -direct=1 -iodepth 16 -thread -rw=read -ioengine=libaio -bs=1M -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/1M_read.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.1M -direct=1 -iodepth 16 -thread -rw=write -ioengine=libaio -bs=1M -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/1M_write.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=randread -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_randread.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=randwrite -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_randwrite.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试完成后可查看result文件看结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">/test/07_fio/4k_read.result: (g=0): rw=read, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_read.result: (groupid=0, jobs=8): err= 0: pid=207001: Mon May 27 14:54:47 2024</span><br><span class="line">  read: IOPS=47.3k, BW=185MiB/s (194MB/s)(16.0GiB/88745msec)</span><br><span class="line">    slat (nsec): min=875, max=2133.2k, avg=7007.83, stdev=5016.92</span><br><span class="line">    clat (usec): min=199, max=3487.5k, avg=2610.55, stdev=15493.93</span><br><span class="line">     lat (usec): min=233, max=3487.5k, avg=2617.91, stdev=15493.93</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[  1045],  5.00th=[  1614], 10.00th=[  1778], 20.00th=[  1958],</span><br><span class="line">     | 30.00th=[  2073], 40.00th=[  2180], 50.00th=[  2311], 60.00th=[  2376],</span><br><span class="line">     | 70.00th=[  2507], 80.00th=[  2638], 90.00th=[  2933], 95.00th=[  3818],</span><br><span class="line">     | 99.00th=[  6390], 99.50th=[  9110], 99.90th=[ 28181], 99.95th=[ 38536],</span><br><span class="line">     | 99.99th=[425722]</span><br><span class="line">   bw (  KiB/s): min=23890, max=376878, per=100.00%, avg=199714.24, stdev=5507.16, samples=1309</span><br><span class="line">   iops        : min= 5969, max=94219, avg=49926.62, stdev=1376.75, samples=1309</span><br><span class="line">  lat (usec)   : 250=0.01%, 500=0.07%, 750=0.28%, 1000=0.51%</span><br><span class="line">  lat (msec)   : 2=22.73%, 4=72.24%, 10=3.75%, 20=0.25%, 50=0.14%</span><br><span class="line">  lat (msec)   : 100=0.02%, 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%</span><br><span class="line">  lat (msec)   : 2000=0.01%, &gt;=2000=0.01%</span><br><span class="line">  cpu          : usr=2.13%, sys=4.20%, ctx=558488, majf=0, minf=137</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=4194304,0,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=185MiB/s (194MB/s), 185MiB/s-185MiB/s (194MB/s-194MB/s), io=16.0GiB (17.2GB), run=88745-88745msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=246678/1475, merge=3945401/195, ticks=623046/25558, in_queue=648640, util=100.00%</span><br><span class="line">/test/07_fio/4k_write.result: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_write.result: (groupid=0, jobs=8): err= 0: pid=207097: Mon May 27 15:04:35 2024</span><br><span class="line">  write: IOPS=7147, BW=27.9MiB/s (29.3MB/s)(16.0GiB/586796msec); 0 zone resets</span><br><span class="line">    slat (nsec): min=1166, max=523153k, avg=24597.05, stdev=1700976.31</span><br><span class="line">    clat (usec): min=43, max=2624.1k, avg=17410.51, stdev=63041.08</span><br><span class="line">     lat (usec): min=72, max=2624.1k, avg=17435.47, stdev=63131.39</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[   1483],  5.00th=[   2835], 10.00th=[   3195],</span><br><span class="line">     | 20.00th=[   3589], 30.00th=[   3720], 40.00th=[   3916],</span><br><span class="line">     | 50.00th=[   4178], 60.00th=[   4293], 70.00th=[   4490],</span><br><span class="line">     | 80.00th=[   5276], 90.00th=[   9241], 95.00th=[ 125305],</span><br><span class="line">     | 99.00th=[ 227541], 99.50th=[ 329253], 99.90th=[ 926942],</span><br><span class="line">     | 99.95th=[1199571], 99.99th=[1501561]</span><br><span class="line">   bw (  KiB/s): min=   64, max=222744, per=100.00%, avg=30970.62, stdev=4675.11, samples=8583</span><br><span class="line">   iops        : min=   16, max=55686, avg=7741.70, stdev=1168.75, samples=8583</span><br><span class="line">  lat (usec)   : 50=0.01%, 100=0.01%, 250=0.03%, 500=0.10%, 750=0.65%</span><br><span class="line">  lat (usec)   : 1000=0.07%</span><br><span class="line">  lat (msec)   : 2=0.34%, 4=41.87%, 10=47.66%, 20=1.25%, 50=0.63%</span><br><span class="line">  lat (msec)   : 100=0.69%, 250=5.88%, 500=0.58%, 750=0.10%, 1000=0.05%</span><br><span class="line">  lat (msec)   : 2000=0.08%, &gt;=2000=0.01%</span><br><span class="line">  cpu          : usr=0.38%, sys=0.75%, ctx=576754, majf=0, minf=10</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,4194304,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=27.9MiB/s (29.3MB/s), 27.9MiB/s-27.9MiB/s (29.3MB/s-29.3MB/s), io=16.0GiB (17.2GB), run=586796-586796msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=0/286936, merge=0/3916379, ticks=0/8454187, in_queue=8462460, util=99.50%</span><br><span class="line">/test/07_fio/1M_read.result: (g=0): rw=read, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/1M_read.result: (groupid=0, jobs=8): err= 0: pid=207618: Mon May 27 15:05:35 2024</span><br><span class="line">  read: IOPS=275, BW=275MiB/s (288MB/s)(16.0GiB/59550msec)</span><br><span class="line">    slat (usec): min=38, max=512225, avg=25893.10, stdev=42143.54</span><br><span class="line">    clat (msec): min=11, max=2415, avg=430.93, stdev=146.16</span><br><span class="line">     lat (msec): min=11, max=2415, avg=456.82, stdev=152.57</span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  1.00th=[  105],  5.00th=[  213], 10.00th=[  264], 20.00th=[  317],</span><br><span class="line">     | 30.00th=[  355], 40.00th=[  388], 50.00th=[  418], 60.00th=[  451],</span><br><span class="line">     | 70.00th=[  493], 80.00th=[  542], 90.00th=[  609], 95.00th=[  684],</span><br><span class="line">     | 99.00th=[  844], 99.50th=[  902], 99.90th=[ 1083], 99.95th=[ 1183],</span><br><span class="line">     | 99.99th=[ 1552]</span><br><span class="line">   bw (  KiB/s): min=104448, max=669573, per=100.00%, avg=285587.80, stdev=11325.53, samples=924</span><br><span class="line">   iops        : min=  102, max=  653, avg=278.80, stdev=11.05, samples=924</span><br><span class="line">  lat (msec)   : 20=0.11%, 50=0.24%, 100=0.48%, 250=7.28%, 500=63.64%</span><br><span class="line">  lat (msec)   : 750=25.52%, 1000=2.52%, 2000=0.21%, &gt;=2000=0.01%</span><br><span class="line">  cpu          : usr=0.03%, sys=0.38%, ctx=18042, majf=0, minf=32777</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.4%, 16=99.3%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=16384,0,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=275MiB/s (288MB/s), 275MiB/s-275MiB/s (288MB/s-288MB/s), io=16.0GiB (17.2GB), run=59550-59550msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=32674/725, merge=0/110, ticks=6973292/412111, in_queue=7385454, util=100.00%</span><br><span class="line">/test/07_fio/1M_write.result: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/1M_write.result: (groupid=0, jobs=8): err= 0: pid=207681: Mon May 27 15:15:17 2024</span><br><span class="line">  write: IOPS=28, BW=28.2MiB/s (29.6MB/s)(16.0GiB/581311msec); 0 zone resets</span><br><span class="line">    slat (usec): min=93, max=4919.9k, avg=252152.23, stdev=625406.54</span><br><span class="line">    clat (msec): min=8, max=17001, avg=4129.88, stdev=2203.68</span><br><span class="line">     lat (msec): min=12, max=17001, avg=4382.04, stdev=2254.09</span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  1.00th=[   84],  5.00th=[  451], 10.00th=[ 1653], 20.00th=[ 2366],</span><br><span class="line">     | 30.00th=[ 2702], 40.00th=[ 3205], 50.00th=[ 4279], 60.00th=[ 4597],</span><br><span class="line">     | 70.00th=[ 4933], 80.00th=[ 6141], 90.00th=[ 6879], 95.00th=[ 8154],</span><br><span class="line">     | 99.00th=[10402], 99.50th=[10939], 99.90th=[12818], 99.95th=[13087],</span><br><span class="line">     | 99.99th=[14832]</span><br><span class="line">   bw (  KiB/s): min=13635, max=463331, per=100.00%, avg=79465.91, stdev=9160.13, samples=3318</span><br><span class="line">   iops        : min=    8, max=  449, avg=75.27, stdev= 8.92, samples=3318</span><br><span class="line">  lat (msec)   : 10=0.04%, 20=0.12%, 50=0.46%, 100=0.48%, 250=2.11%</span><br><span class="line">  lat (msec)   : 500=2.25%, 750=2.20%, 1000=0.84%, 2000=2.95%, &gt;=2000=88.54%</span><br><span class="line">  cpu          : usr=0.08%, sys=0.04%, ctx=17511, majf=0, minf=9</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.4%, 16=99.3%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,16384,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=28.2MiB/s (29.6MB/s), 28.2MiB/s-28.2MiB/s (29.6MB/s-29.6MB/s), io=16.0GiB (17.2GB), run=581311-581311msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=0/38767, merge=0/1043, ticks=0/64664224, in_queue=64667302, util=99.27%</span><br><span class="line">/test/07_fio/4k_randread.result: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_randread.result: (groupid=0, jobs=8): err= 0: pid=208207: Mon May 27 15:23:33 2024</span><br><span class="line">  read: IOPS=8483, BW=33.1MiB/s (34.7MB/s)(16.0GiB/494420msec)</span><br><span class="line">    slat (usec): min=2, max=201706, avg=36.93, stdev=428.22</span><br><span class="line">    clat (usec): min=88, max=533254, avg=15039.17, stdev=10664.59</span><br><span class="line">     lat (usec): min=292, max=533276, avg=15076.65, stdev=10688.75</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[   807],  5.00th=[  1958], 10.00th=[  3359], 20.00th=[  6128],</span><br><span class="line">     | 30.00th=[  8848], 40.00th=[ 11600], 50.00th=[ 14353], 60.00th=[ 17171],</span><br><span class="line">     | 70.00th=[ 20055], 80.00th=[ 22676], 90.00th=[ 25822], 95.00th=[ 27657],</span><br><span class="line">     | 99.00th=[ 45876], 99.50th=[ 66847], 99.90th=[111674], 99.95th=[130548],</span><br><span class="line">     | 99.99th=[177210]</span><br><span class="line">   bw (  KiB/s): min= 8035, max=48720, per=99.97%, avg=33923.78, stdev=237.61, samples=7886</span><br><span class="line">   iops        : min= 2006, max=12180, avg=8477.79, stdev=59.39, samples=7886</span><br><span class="line">  lat (usec)   : 100=0.01%, 250=0.01%, 500=0.06%, 750=0.75%, 1000=0.85%</span><br><span class="line">  lat (msec)   : 2=3.51%, 4=7.18%, 10=21.64%, 20=36.19%, 50=28.96%</span><br><span class="line">  lat (msec)   : 100=0.70%, 250=0.15%, 500=0.01%, 750=0.01%</span><br><span class="line">  cpu          : usr=0.75%, sys=2.16%, ctx=8332454, majf=0, minf=137</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=4194304,0,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=33.1MiB/s (34.7MB/s), 33.1MiB/s-33.1MiB/s (34.7MB/s-34.7MB/s), io=16.0GiB (17.2GB), run=494420-494420msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=4181430/7450, merge=12740/996, ticks=62631284/343162, in_queue=62974566, util=100.00%</span><br><span class="line">/test/07_fio/4k_randwrite.result: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_randwrite.result: (groupid=0, jobs=8): err= 0: pid=208657: Mon May 27 15:41:42 2024</span><br><span class="line">  write: IOPS=3855, BW=15.1MiB/s (15.8MB/s)(16.0GiB/1087918msec); 0 zone resets</span><br><span class="line">    slat (usec): min=2, max=2778.7k, avg=352.85, stdev=13919.64</span><br><span class="line">    clat (nsec): min=1458, max=5634.7M, avg=32836509.68, stdev=162686262.13</span><br><span class="line">     lat (usec): min=91, max=5634.8k, avg=33190.01, stdev=163925.97</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[    249],  5.00th=[    627], 10.00th=[   1123],</span><br><span class="line">     | 20.00th=[   2073], 30.00th=[   2966], 40.00th=[   3949],</span><br><span class="line">     | 50.00th=[   4883], 60.00th=[   5866], 70.00th=[   6849],</span><br><span class="line">     | 80.00th=[   7898], 90.00th=[  28181], 95.00th=[  48497],</span><br><span class="line">     | 99.00th=[ 801113], 99.50th=[1182794], 99.90th=[2105541],</span><br><span class="line">     | 99.95th=[2365588], 99.99th=[3103785]</span><br><span class="line">   bw (  KiB/s): min=   56, max=85966, per=100.00%, avg=15926.41, stdev=3214.43, samples=16811</span><br><span class="line">   iops        : min=    8, max=21488, avg=3980.73, stdev=803.57, samples=16811</span><br><span class="line">  lat (usec)   : 2=0.01%, 4=0.01%, 50=0.01%, 100=0.01%, 250=1.00%</span><br><span class="line">  lat (usec)   : 500=2.63%, 750=2.62%, 1000=2.55%</span><br><span class="line">  lat (msec)   : 2=10.38%, 4=21.28%, 10=46.67%, 20=1.69%, 50=6.22%</span><br><span class="line">  lat (msec)   : 100=0.51%, 250=1.12%, 500=1.43%, 750=0.81%, 1000=0.40%</span><br><span class="line">  lat (msec)   : 2000=0.56%, &gt;=2000=0.14%</span><br><span class="line">  cpu          : usr=0.35%, sys=1.10%, ctx=7577659, majf=0, minf=11</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,4194304,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=15.1MiB/s (15.8MB/s), 15.1MiB/s-15.1MiB/s (15.8MB/s-15.8MB/s), io=16.0GiB (17.2GB), run=1087918-1087918msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=0/4191578, merge=0/13549, ticks=0/133093101, in_queue=133097231, util=99.99%</span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<p>filename=/data/test 测试文件名称，通常选择需要测试的盘的data目录；</p>
<p>direct=1 是否使用directIO，测试过程绕过OS自带的buffer。Linux读写的时候，内核维护了缓存，数据先写到缓存，后面再后台写到SSD。读的时候也优先读缓存里的数据。这样速度可以加快，但是一旦掉电缓存里的数据就没了。所以有一种模式叫做directIO，跳过缓存，直接读写SSD，使测试结果更真实；</p>
<p>rw=read 测试顺序读的I/O；</p>
<p>rw=write 测试顺序写的I/O；</p>
<p>rw=randread 测试随机读的I/O；</p>
<p>rw=write rw=randwrite 测试随机写的I/O；</p>
<p>rw=write rw=randrw 测试随机混合读和写的I/O；</p>
<p>bs=4k 单次io的块文件大小为4k；</p>
<p>size=5G 本次的测试文件大小为5g，以每次4k的io进行测试；</p>
<p>numjobs=8 测试线程为8；（需要根据测试的cpu线程数做对应修改）</p>
<p>name=job1 一个任务的名字，重复了也没关系；</p>
<p>thread 使用pthread_create创建线程，另一种是fork创建进程。进程的开销比线程要大，一般都采用thread测试；</p>
<p>group_reporting 关于显示结果的，汇总每个进程的信息；</p>
<p>runtime=120 测试时间为120秒，如果不写则一直将5g文件分4k每次写完为止；</p>
<p>time_based 如果设置的话，即使file已被完全读写或写完，也要执行完runtime规定的时间，它是通过循环执行相同的负载来实现的；</p>
<p>ioengine=libaio 指定io引擎使用libaio方式。<br />
libaio：Linux本地异步I/O。请注意，Linux可能只支持具有非缓冲I/O的排队行为（设置为“direct=1”或“buffered=0”）；</p>
<p>iodepth=32 队列的深度为32。<br />
  同步的IO：一次只能发出一个IO请求，等待内核完成才返回，这样对于单个线程iodepth总是小于1。（电梯算法：假如一部电梯一次只能搭乘一人，那么每个人一但乘上电梯，就能快速达到目的地（响应时间），但需要耗费较长的等待时间（队列长度）。虽然响应时间较短，但系统的吞吐量很小。）<br />
  异步情况下：一次提交一批，然后等待一批的完成，减少交互的次数，会更有效率。加大磁盘队列深度就是让磁盘不断工作，减少磁盘的空闲时间。（电梯算法：32个人等电梯，一次上满32人，只需等一次电梯即可）。</p>
<blockquote>
<p>各项参数说明<br />
io 执行了多少M的IO<br />
bw 平均IO带宽<br />
iops IOPS 即I/O per second，即每秒进行读写（I/O）操作的次数，是衡量磁盘性能的主要指标之一。<br />
runt 线程运行时间（单位毫秒）<br />
slat 提交延迟<br />
clat 完成延迟<br />
lat 响应时间<br />
cpu 利用率<br />
IO depths io队列<br />
IO submit 单个IO提交要提交的IO数<br />
IO complete 与上面的提交编号一样，但改为填写<br />
IO issued 发出的读/写请求数，以及短请求数。<br />
IO latencies IO延迟的分布<br />
下面的io 总共执行了多少size的IO<br />
aggrb group总带宽<br />
minb 最小平均带宽.<br />
maxb 最大平均带宽.<br />
mint group中线程的最短运行时间.<br />
maxt group中线程的最长运行时间.<br />
ios 所有group总共执行的IO数.<br />
merge 总共发生的IO合并数.<br />
ticks Number of ticks we kept the disk busy.<br />
in_queue 花费在队列上的总共时间.<br />
util 磁盘利用率</p>
</blockquote>
<h2 id="82d-图形性能graphics"><a class="markdownIt-Anchor" href="#82d-图形性能graphics"></a> 8.2D 图形性能(graphics)</h2>
<p>修改unixbench的第52行，从-lGL -lXext -lX11修改为GL_LIBS = -lGL -lXext -lX11 -lm  ，解开第49行的注释，如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045547.png" alt="image-20240524181919729" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apt-get install glade  mesa-common-dev  libxext-dev   libx11-dev pkg-config libxmuu-dev libxrender-dev</span><br><span class="line">sudo apt-get install libxft-dev libfreetype6-dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置x11perf</span></span><br><span class="line">./configure --build=arm-linux</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">make install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译unixbench</span></span><br><span class="line">make </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 进行测试</span></span><br><span class="line">./Run graphics </span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Benchmark Run: 一 5月 27 2024 16:12:44 - 16:30:55</span><br><span class="line">8 CPUs in system; running 1 parallel copy of tests</span><br><span class="line"></span><br><span class="line">2D graphics: aa polygons                       5973.2 score (50.8 s, 2 samples)</span><br><span class="line">2D graphics: ellipses                          3633.5 score (50.8 s, 2 samples)</span><br><span class="line">2D graphics: images and blits                174032.7 score (53.8 s, 2 samples)</span><br><span class="line">2D graphics: rectangles                        4501.6 score (58.9 s, 2 samples)</span><br><span class="line">2D graphics: text                            120825.3 score (50.2 s, 2 samples)</span><br><span class="line">2D graphics: windows                           1361.1 score (50.8 s, 2 samples)</span><br><span class="line">3D graphics: gears                              888.6 fps   (20.0 s, 2 samples)</span><br><span class="line"></span><br><span class="line">3D Graphics Benchmarks Index Values          BASELINE       RESULT    INDEX</span><br><span class="line">3D graphics: gears                               33.4        888.6    266.0</span><br><span class="line">                                                                   ========</span><br><span class="line">3D Graphics Benchmarks Index Score                                    266.0</span><br><span class="line"></span><br><span class="line">2D Graphics Benchmarks Index Values          BASELINE       RESULT    INDEX</span><br><span class="line">2D graphics: aa polygons                         15.0       5973.2   3982.1</span><br><span class="line">2D graphics: ellipses                            15.0       3633.5   2422.3</span><br><span class="line">2D graphics: images and blits                    15.0     174032.7 116021.8</span><br><span class="line">2D graphics: rectangles                          15.0       4501.6   3001.1</span><br><span class="line">2D graphics: text                                15.0     120825.3  80550.2</span><br><span class="line">2D graphics: windows                             15.0       1361.1    907.4</span><br><span class="line">                                                                   ========</span><br><span class="line">2D Graphics Benchmarks Index Score                                   7913.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="93d-图形性能glmark2-es"><a class="markdownIt-Anchor" href="#93d-图形性能glmark2-es"></a> 9.<strong>3D 图形性能(glmark2-es)</strong></h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install glmark2-es</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试</span></span><br><span class="line">glmark2-es --fullscreen</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.bilibili.com/video/BV1ZN411D7V8/</span><br></pre></td></tr></table></figure>
<h2 id="1010g-文件性能"><a class="markdownIt-Anchor" href="#1010g-文件性能"></a> 10.10G 文件性能</h2>
<p>没空间了，改为了5G</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/$ dd if=/dev/zero of=/test10 bs=1M count=5120 conv=fdatasync</span><br><span class="line">5120+0 records in</span><br><span class="line">5120+0 records out</span><br><span class="line">5368709120 bytes (5.4 GB, 5.0 GiB) copied, 64.2663 s, 83.5 MB/s</span><br><span class="line">root@topeet:/$ </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/$ dd if=/test10 of=/home/kylin/testduxie1 bs=1M count=10240 conv=fdatasync</span><br><span class="line">5120+0 records in</span><br><span class="line">5120+0 records out</span><br><span class="line">5368709120 bytes (5.4 GB, 5.0 GiB) copied, 69.4213 s, 77.3 MB/s</span><br></pre></td></tr></table></figure>
<h2 id="11usb-存储设备性能"><a class="markdownIt-Anchor" href="#11usb-存储设备性能"></a> 11.USB 存储设备性能</h2>
<p>2.0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/$ dd if=/test10 of=/media/kylin/新加卷/testduxie2 bs=1M count=1024  conv=fdatasync </span><br><span class="line"></span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 32.3505 s, 33.2 MB/s</span><br></pre></td></tr></table></figure>
<p>3.0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dd if=/test10 of=/media/kylin/新加卷/testduxie2 bs=1M count=1024  conv=fdatasync </span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 11.8471 s, 90.6 MB/s</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/16_野火sdk学习shell脚本解析"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/12/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/16_%E9%87%8E%E7%81%ABsdk%E5%AD%A6%E4%B9%A0shell%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90/"
    >开放麒麟shell脚本解析</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/12/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/16_%E9%87%8E%E7%81%ABsdk%E5%AD%A6%E4%B9%A0shell%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2024-08-12T09:17:03.000Z" itemprop="datePublished">2024-08-12</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/openkylin/openkylin-embedded-builder">https://gitee.com/openkylin/openkylin-embedded-builder</a></p>
<p>开放麒麟官网：<a target="_blank" rel="noopener" href="https://www.openkylin.top/">https://www.openkylin.top</a></p>
<p>文档目的：强化shell脚本编写阅读能力，提取开放麒麟文件系统构建脚本</p>
<p>代码阅读和编译环境：VS code 和 WSL ubuntu22</p>
</blockquote>
<h1 id="项目仓库的获取"><a class="markdownIt-Anchor" href="#项目仓库的获取"></a> 项目仓库的获取</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYgit clone https://gitee.com/openkylin/openkylin-embedded-builder.git</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026560.png" alt="image-20240816133742484" />image-20240816133742484</p>
<p>==果然不愧是gitee，果然是比github快的多，就还不错吧==</p>
<h1 id="仓库目录文件的分析"><a class="markdownIt-Anchor" href="#仓库目录文件的分析"></a> 仓库目录文件的分析</h1>
<p>拉取下来之后，仓库的目录和文件内容如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026374.png" alt="image-20240816133930163" />image-20240816133930163</p>
<p>上面的这些文件和文件夹中，只有后四个对我们有用，具体作用如下所示：</p>
<table>
<thead>
<tr>
<th>文件和文件夹名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://check-env.sh/">check-env.sh</a></td>
<td>检查文件系统构建的环境，查看依赖是不是安装完成</td>
</tr>
<tr>
<td>config</td>
<td>存放一系列的配置文件，和后处理脚本</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://functions.sh/">functions.sh</a></td>
<td>文件系统的脚本，系统的构建，主要函数都在该脚本中</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://okbuild.sh/">okbuild.sh</a></td>
<td>逻辑函数，对一些内容进行判断，这是需要执行的脚本</td>
</tr>
</tbody>
</table>
<p>根据我理解的逻辑对，上面提到的这四个文件或文件夹进行分析</p>
<h1 id="check-envsh脚本分析"><a class="markdownIt-Anchor" href="#check-envsh脚本分析"></a> check-env.sh脚本分析</h1>
<p>脚本执行过程如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026523.png" alt="image-20240816135726813" />image-20240816135726813</p>
<p>首先是将当前用户设置为无密码使用sudo，然后检查了几个工具是否安装，如果没安装就安装上，最后，将okbuild.sh链接到usr/bin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash  </span><br><span class="line">  </span><br><span class="line">set -e  # 如果任何语句的执行结果为非真，则立即退出脚本  </span><br><span class="line">  </span><br><span class="line"># 获取当前脚本的绝对路径所在的目录  </span><br><span class="line">CURRENT_DIR=$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)  </span><br><span class="line"># 导入当前目录下的functions.sh脚本  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/functions.sh  </span><br><span class="line">  </span><br><span class="line"># 配置sudo权限  </span><br><span class="line">config_sudo  </span><br><span class="line">  </span><br><span class="line"># 检查并安装制作镜像所需的包  </span><br><span class="line">check_package debootstrap  # 检查并安装debootstrap包，用于创建根文件系统  </span><br><span class="line">check_package gdisk        # 检查并安装gdisk包，用于操作GPT分区表  </span><br><span class="line">check_package mtools       # 检查并安装mtools包，用于操作MS-DOS文件系统  </span><br><span class="line">check_package dosfstools   # 检查并安装dosfstools包，用于创建和管理FAT文件系统  </span><br><span class="line">check_package genisoimage  # 检查并安装genisoimage包，用于创建ISO映像文件  </span><br><span class="line">check_package squashfs-tools  # 检查并安装squashfs-tools包，用于创建和管理squashfs文件系统  </span><br><span class="line">check_package xz-utils     # 检查并安装xz-utils包，用于处理XZ格式的压缩文件  </span><br><span class="line">  </span><br><span class="line"># 检查并安装设备树编译器  </span><br><span class="line">check_package device-tree-compiler  </span><br><span class="line">  </span><br><span class="line"># 创建软链接，将okbuild.sh脚本链接到/usr/bin/目录下，使其可以在任何地方被调用  </span><br><span class="line">sudo ln -v -sf &quot;$&#123;CURRENT_DIR&#125;&quot;/okbuild.sh /usr/bin/</span><br></pre></td></tr></table></figure>
<p>上面用了两个函数，从他们的名字上就可以分析出他们的作用，config_sudo是配置当前用户的sudo免密码权限，而check_package用来检测工具是否安装，这两个函数都定义在functions.sh脚本当中，等等再对这个脚本里的函数进行分析。</p>
<h1 id="config文件内容分析"><a class="markdownIt-Anchor" href="#config文件内容分析"></a> config文件内容分析</h1>
<p>config是这里唯一的一个文件夹，这个文件夹里有一些细分的脚本</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026400.png" alt="image-20240816141742796" />image-20240816141742796</p>
<p>可以分成两类，第一类是六个，如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026423.png" alt="image-20240816142830197" />image-20240816142830197</p>
<p>这些脚本里面就是安装一些工具，创建openkylin用户，设置中文环境罢了，其他也没啥，而public.sh里面是四个函数，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 仅打印</span><br><span class="line">function MY_LOG() &#123;</span><br><span class="line">    echo &quot; =&gt; $*&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 打印 并 执行</span><br><span class="line">function MY_LOG_EXEC() &#123;</span><br><span class="line">    echo &quot; =&gt; $*&quot;</span><br><span class="line">    eval &quot;$*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 执行指定目录下的脚本</span><br><span class="line">function run_scripts() &#123;</span><br><span class="line">    SCRIPTS_DIR=&quot;$&#123;1&#125;&quot;</span><br><span class="line">    VK_ORDER=$&#123;VK_ORDER:-default&#125;</span><br><span class="line"></span><br><span class="line">    if [ -d &quot;$&#123;SCRIPTS_DIR&#125;&quot; ]; then</span><br><span class="line">        if [ -f &quot;$&#123;SCRIPTS_DIR&#125;/$&#123;VK_ORDER&#125;&quot; ]; then</span><br><span class="line">            # 按照给定的顺序执行脚本</span><br><span class="line">            for script_name in $(cat $&#123;SCRIPTS_DIR&#125;/$&#123;VK_ORDER&#125; | sed &#x27;/^#/d&#x27;); do</span><br><span class="line">                echo &quot;---&gt; . $&#123;SCRIPTS_DIR&#125;/$&#123;script_name&#125;&quot;</span><br><span class="line">                . $&#123;SCRIPTS_DIR&#125;/$&#123;script_name&#125; 2&gt;&amp;1 | tee /config/&quot;$(basename $&#123;script_name&#125;)&quot;.log</span><br><span class="line">            done</span><br><span class="line">        else</span><br><span class="line">            # 按照sort -n排序，执行全部脚本</span><br><span class="line">            for script_name in $(find $&#123;SCRIPTS_DIR&#125; -name &quot;*.sh&quot; | sort -n); do</span><br><span class="line">                echo &quot;---&gt; . $&#123;script_name&#125;&quot;</span><br><span class="line">                . &quot;$&#123;script_name&#125;&quot; 2&gt;&amp;1 | tee /config/&quot;$(basename $&#123;script_name&#125;)&quot;.log</span><br><span class="line">            done</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建用户</span><br><span class="line">function create_user() &#123;</span><br><span class="line">    USERNAME=&quot;$1&quot;</span><br><span class="line">    PASSWORD=&quot;$2&quot;</span><br><span class="line">    USERID=&quot;$&#123;3:-1000&#125;&quot;</span><br><span class="line">    if ! awk -F: &#x27;&#123;print $1&#125;&#x27; /etc/passwd | grep -q $&#123;USERNAME&#125;; then</span><br><span class="line">        useradd -m -s /bin/bash -u $&#123;USERID&#125; &quot;$&#123;USERNAME&#125;&quot;</span><br><span class="line">        usermod -c &quot;$&#123;USERNAME&#125;&quot; &quot;$&#123;USERNAME&#125;&quot;</span><br><span class="line">        echo &quot;$&#123;USERNAME&#125;:$&#123;PASSWORD&#125;&quot; | chpasswd</span><br><span class="line">        adduser $&#123;USERNAME&#125; sudo</span><br><span class="line">        adduser $&#123;USERNAME&#125; adm</span><br><span class="line">        adduser $&#123;USERNAME&#125; cdrom &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; dip &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; plugdev &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; lpadmin &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; sambashare &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; libvirtd &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; lxd &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">    else</span><br><span class="line">        echo &quot;user $&#123;USERNAME&#125; already exists&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_hostname() &#123;</span><br><span class="line">    HOSTNAME=&quot;$1&quot;</span><br><span class="line">    echo $&#123;HOSTNAME&#125; &gt;/etc/hostname</span><br><span class="line"></span><br><span class="line">    touch /etc/hosts</span><br><span class="line">    if ! grep -q &quot;127.0.0.1 localhost&quot; /etc/hosts; then</span><br><span class="line">        cat &gt;&gt;/etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 $&#123;HOSTNAME&#125;</span><br><span class="line">EOF</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function install_pkgs() &#123;</span><br><span class="line">    MY_LOG_EXEC apt-get install -y &quot;$*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 循环单个安装</span><br><span class="line">function install_pkgs_each() &#123;</span><br><span class="line">    for pkg in &quot;$@&quot;; do</span><br><span class="line">        MY_LOG_EXEC apt-get install -y -q &quot;$&#123;pkg&#125;&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 结束，收尾</span><br><span class="line">function finish() &#123;</span><br><span class="line">    # 禁止 kylin-virtual-keyboard, ukui-tablet-desktop.desktop 开机不启动</span><br><span class="line">    [ -f &quot;/etc/xdg/autostart/kylin-virtual-keyboard.desktop&quot; ] &amp;&amp; mv -v /etc/xdg/autostart/kylin-virtual-keyboard.desktop&#123;,.bak&#125;</span><br><span class="line">    [ -f &quot;/etc/xdg/autostart/ukui-tablet-desktop.desktop&quot; ] &amp;&amp; mv -v /etc/xdg/autostart/ukui-tablet-desktop.desktop&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line">    # 删除开始菜单图标</span><br><span class="line">    rm -rf /usr/share/applications/vim.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.systemmonitor.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.plasma-systemmonitor.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.khelpcenter.desktop</span><br><span class="line">    rm -rf /usr/share/applications/mate-user-guide.desktop</span><br><span class="line">    rm -rf /usr/share/applications/yelp.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.telhandler.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.sms.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.kcm.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.app.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.smshandler.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.nonplasma.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.daemon.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect_open.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kinfocenter.desktop</span><br><span class="line"></span><br><span class="line">    set_hostname openkylin</span><br><span class="line"></span><br><span class="line">    if [ -f /lib/systemd/system/dnsmasq.service ]; then</span><br><span class="line">        systemctl disable dnsmasq.service</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 设置时区</span><br><span class="line">    echo &quot;Asia/Shanghai&quot; &gt;/etc/timezone</span><br><span class="line">    rm -rf /etc/localtime</span><br><span class="line">    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; file system make finish&quot;</span><br><span class="line"></span><br><span class="line">    export HISTSIZE=0</span><br><span class="line">    rm -rf /var/cache/apt/archives/*.deb</span><br><span class="line">    if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">        rm -rf /var/cache/apt/*.bin</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_Packages</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_InRelease</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_Translation*</span><br><span class="line">        rm -rf /root/.bash_history</span><br><span class="line">        rm -rf /tmp/*</span><br><span class="line">        rm -rf ~/.bash_history</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置默认语言为中文</span><br><span class="line">function config_zh_cn() &#123;</span><br><span class="line">    cat &gt;/etc/locale.gen &lt;&lt;EOF</span><br><span class="line">zh_CN.UTF-8 UTF-8</span><br><span class="line">en_US.UTF-8 UTF-8</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cat &gt;/etc/default/locale &lt;&lt;EOF</span><br><span class="line">LANG=zh_CN.UTF-8</span><br><span class="line">LANGUAGE=&quot;zh_CN:zh&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    locale-gen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置默认语言为英文</span><br><span class="line">function config_en_utf8() &#123;</span><br><span class="line">    cat &gt;/etc/locale.gen &lt;&lt;EOF</span><br><span class="line">en_US ISO-8859-1</span><br><span class="line">en_US.UTF-8 UTF-8</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cat &gt;/etc/default/locale &lt;&lt;EOF</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">LANGUAGE=&quot;en_US:en&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    locale-gen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三个函数run_scripts和第四个函数create_user需要注意一下，第四个函数可以学习一下，用在我们的构建上，而第三个是重点，根据他的内容可以推测出正是调用了这个函数才真正的调用了下面的这些shell函数：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026426.png" alt="image-20240816143742187" />image-20240816143742187</p>
<p>这些shell等等再讲解，先来看openkylin目录下的文件，可以将这些文件分为三部分，具体如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026090.png" alt="image-20240816144035365" />image-20240816144035365</p>
<p>main.sh可以从名字看出他是最主要的文件，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash  </span><br><span class="line">set -e  </span><br><span class="line">  </span><br><span class="line"># 解析宿主环境传递参数  </span><br><span class="line">for item in $*; do  </span><br><span class="line">    if grep -q &quot;^VK.*=&quot; &lt;&lt;&lt;&quot;$&#123;item&#125;&quot;; then  </span><br><span class="line">        KEY=$&#123;item%%=*&#125;  # 提取键名  </span><br><span class="line">        VALUE=&quot;$&#123;item##*=&#125;&quot;  # 提取键值  </span><br><span class="line">        eval &quot;export $&#123;KEY&#125;=&#x27;$&#123;VALUE&#125;&#x27;&quot;  # 导出键值对为环境变量  </span><br><span class="line">    fi  </span><br><span class="line">done  </span><br><span class="line">  </span><br><span class="line"># 系统版本信息  </span><br><span class="line">[ -f /etc/os-release ] &amp;&amp; source /etc/os-release  # 如果存在系统版本信息文件，则导入  </span><br><span class="line">  </span><br><span class="line">CURRENT_DIR=$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)  # 获取当前脚本的绝对路径  </span><br><span class="line">[ -f &quot;$&#123;CURRENT_DIR&#125;&quot;/public.sh ] &amp;&amp; . &quot;$&#123;CURRENT_DIR&#125;&quot;/public.sh  # 如果存在公共脚本，则导入  </span><br><span class="line">[ -f &quot;$&#123;CURRENT_DIR&#125;&quot;/private.sh ] &amp;&amp; . &quot;$&#123;CURRENT_DIR&#125;&quot;/private.sh  # 如果存在私有脚本，则导入  </span><br><span class="line">  </span><br><span class="line">CURRENT_ARCH=$(dpkg --print-architecture)  # 获取当前系统架构  </span><br><span class="line">  </span><br><span class="line"># 设置内网源  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/apt_source-$&#123;CURRENT_ARCH&#125;.sh  # 导入对应架构的内网源设置脚本  </span><br><span class="line">  </span><br><span class="line"># 制作系统  </span><br><span class="line">if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ]; then  # 如果当前任务为配置  </span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ]; then  # 如果设置了更新标志，并且值为y  </span><br><span class="line">        if [ -f /rootfs.deblist ] &amp;&amp; [ ! -f /rootfs-update.deblist ]; then  # 如果存在基础包列表文件，且不存在更新后的列表文件  </span><br><span class="line">            # 升级基础包  </span><br><span class="line">            for pkg in $(awk &#x27;&#123;print $1&#125;&#x27; /rootfs.deblist); do  # 遍历基础包列表  </span><br><span class="line">                MY_LOG_EXEC apt-get install -y -q --allow-downgrades $&#123;pkg&#125;  # 安装或降级包  </span><br><span class="line">            done  </span><br><span class="line">            # 升级后的列表  </span><br><span class="line">            dpkg-query -W --showformat=&#x27;$&#123;Package&#125; $&#123;Version&#125;\n&#x27; &gt;/rootfs-update.deblist  # 生成更新后的列表文件  </span><br><span class="line">            rm -rf /var/cache/apt/archives/*.deb  # 清理下载的包文件  </span><br><span class="line">        fi  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    run_scripts &quot;$&#123;CURRENT_DIR&#125;&quot;/shells  # 执行shell脚本目录下的所有脚本  </span><br><span class="line">else  </span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;&quot;/$&#123;VK_CURRENT_TASK&#125;.sh  # 导入并执行当前任务对应的脚本  </span><br><span class="line">fi  </span><br><span class="line">  </span><br><span class="line"># 设置公网源  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/apt_public-$&#123;CURRENT_ARCH&#125;.sh  # 导入对应架构的公网源设置脚本  </span><br><span class="line">  </span><br><span class="line">finish  # 执行结束操作</span><br></pre></td></tr></table></figure>
<p>然后是内网源和公网源的，这里我还没看懂到底是啥意思，为社么要设置两次呢，这里不是很理解，等等再说吧，而第39行终于是调用了前面提到的run_scripts，调用shell下的一系列内容。</p>
<p>最后是以prop开头的一系列文件，根据内容开看这是一系列的配置文件，以树莓派4b的配置文件为例，可以看到有以下内容：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026104.png" alt="image-20240816145605421" />image-20240816145605421</p>
<p>分别记录了版本状态、主板标识、架构、执行顺序、执行任务等等，现在还不知道是哪里用到了这个配置文件，但肯定是用到了，后面对于编译流程的分析过程中再来讲解，最后来看shells文件夹里的脚本，如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026080.png" alt="image-20240816145829922" />image-20240816145829922</p>
<p>同样是根据名字进行推理，前面六个脚本可以分成一类，是文件系统设置的脚本，而后面六个可以分成一类，根据不同的开发板来决定都调用前面哪几个脚本，然后来对前面这几个脚本进行分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    # base tools</span><br><span class="line">    apt-utils</span><br><span class="line">    kmod</span><br><span class="line">    kbd</span><br><span class="line">    whiptail</span><br><span class="line">    locales</span><br><span class="line"></span><br><span class="line">    systemd-resolved</span><br><span class="line"></span><br><span class="line">    # extra tools</span><br><span class="line">    vim</span><br><span class="line">    lsof</span><br><span class="line">    cpio</span><br><span class="line">    file</span><br><span class="line">    sudo</span><br><span class="line">    tree</span><br><span class="line">    wget</span><br><span class="line">    rsync</span><br><span class="line">    fdisk</span><br><span class="line">    gdisk</span><br><span class="line">    parted</span><br><span class="line">    psmisc</span><br><span class="line">    rsyslog</span><br><span class="line">    dosfstools</span><br><span class="line">    lsb-release</span><br><span class="line">    archdetect-deb</span><br><span class="line">    bash-completion</span><br><span class="line">    zstd</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>1-tools.sh就是安装一点软件而已，<a target="_blank" rel="noopener" href="http://xn--2-net-408hr55ok0j.sh/">然后看2-net.sh</a>，其实也就是安装了一点网络相关的软件，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    iputils-ping iproute2 net-tools</span><br><span class="line">    network-manager</span><br><span class="line">    wpasupplicant</span><br><span class="line"></span><br><span class="line">    # ssh</span><br><span class="line">    openssh-server</span><br><span class="line">    openssh-client</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--3-ukui-9h6jv19jfqswkn.sh/">然后来看3-ukui.sh</a>，也是装一些工具，他这里的工具主要是关于桌面配置相关的东西，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    xinit lightdm xdg-user-dirs ukui-control-center ukui-desktop-environment ukui-desktop-environment-core ukui-greeter openkylin-wallpapers</span><br><span class="line">    ukui-globaltheme-heyin</span><br><span class="line">    libukuiinputgatherclient1 xserver-xorg-video-fbdev</span><br><span class="line">    xserver-xorg-input-all</span><br><span class="line"></span><br><span class="line">    # 网络设置</span><br><span class="line">    network-manager-gnome</span><br><span class="line"></span><br><span class="line">    # 便签</span><br><span class="line">    ukui-notebook libqt5sql5-sqlite</span><br><span class="line">    # 屏幕键盘</span><br><span class="line">    onboard python3-xdg</span><br><span class="line">    # VNC工具</span><br><span class="line">    remmina remmina-plugin-vnc</span><br><span class="line"></span><br><span class="line">    kylin-daq</span><br><span class="line">    kylin-app-manager</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br><span class="line"></span><br><span class="line"># lite-ukui-config</span><br><span class="line">if apt-cache policy lite-ukui-config | grep -q lite-ukui-config; then</span><br><span class="line">    apt-get install -y lite-ukui-config</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--4-grub-9h6jv11j4zu.sh/">然后是4-grub.sh</a>，我到现在也不知道grub是做什么的，但是看内容是只有amd64的才需要，就不管了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">CURRENT_ARCH=$(dpkg --print-architecture)</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;CURRENT_ARCH&#125;&quot; == &quot;amd64&quot; ]; then</span><br><span class="line">    PKGS=(</span><br><span class="line">        grub-efi</span><br><span class="line">        grub-common</span><br><span class="line">        grub2-common</span><br><span class="line">        # label.so</span><br><span class="line">        plymouth-label</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--5-kernel-kf1np64ujon.sh/">然后看5-kernel.sh</a>，根据内容就知道这是内核的构建，忽略即可，无需理会。<a target="_blank" rel="noopener" href="http://xn--9-lash-9h6js56j9zau85i.sh/">最后来看9-lash.sh</a>，这里就是设置了一下允许root登录，以及设置网络配置文件，其他就没啥了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># NetworkManager</span><br><span class="line">if [ -d /etc/NetworkManager/conf.d ]; then</span><br><span class="line">    touch /etc/NetworkManager/conf.d/10-globally-managed-devices.conf</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># ssh allow root login</span><br><span class="line">&#123;</span><br><span class="line">    if [ -f /etc/ssh/sshd_config ]; then</span><br><span class="line">        if ! grep -q &quot;^PermitRootLogin yes$&quot; /etc/ssh/sshd_config; then</span><br><span class="line">            sed -i.bak &#x27;/PermitRootLogin/d&#x27; /etc/ssh/sshd_config</span><br><span class="line">            echo &#x27;PermitRootLogin yes&#x27; &gt;&gt;/etc/ssh/sshd_config</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里关于config文件就分析的差不多了。</p>
<h1 id="okbuildsh脚本分析"><a class="markdownIt-Anchor" href="#okbuildsh脚本分析"></a> okbuild.sh脚本分析</h1>
<p>这个脚本就是最开始运行的构建脚本，一切以这个为开始，但是呢，这个脚本实际上并没有什么用，因为我只需要文件系统构建的地方即可，这里的内容有些空虚了，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">CURRENT_FILE=$(readlink -f &quot;$0&quot;)</span><br><span class="line">CURRENT_DIR=$(dirname &quot;$&#123;CURRENT_FILE&#125;&quot;)</span><br><span class="line"># 函数库 优先级 1</span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/functions.sh</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">    echo -en &quot;USAGE:</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_chilliepi  # 双椒派</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_lotus2     # lotus2开发板</span><br><span class="line"></span><br><span class="line">$(basename &quot;$0&quot;) -p prop_rpi4b      # 树莓派4B</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_vf2        # VisionFive2</span><br><span class="line"></span><br><span class="line">$(basename &quot;$0&quot;) -p prop_phytiumpi_2G  # 飞腾派 2GB 版本</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_phytiumpi_4G  # 飞腾派 4GB 版本</span><br><span class="line">&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 判断参数个数</span><br><span class="line">if [ $# -eq 0 ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 配置sudo免密</span><br><span class="line">if [ &quot;$(id -nu)&quot; != &quot;root&quot; ]; then</span><br><span class="line">    sudo tee &quot;/etc/sudoers.d/$&#123;USER&#125;&quot; &lt;&lt;EOF</span><br><span class="line">$USER ALL=(ALL:ALL) NOPASSWD: ALL</span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">ARGS=$(getopt -a -o h,p: -l help,conf:,prop:,mirror:,suite:,name:,arch:,debdir:,tasks:,version: -- &quot;$@&quot;)</span><br><span class="line">eval set -- &quot;$&#123;ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 参数 优先级 1</span><br><span class="line">while true; do</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">    -h | --help)</span><br><span class="line">        usage</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    -p | --prop)</span><br><span class="line">        PROP=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --arch)</span><br><span class="line">        VK_ARCH=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --tasks)</span><br><span class="line">        VK_TASKS=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --)</span><br><span class="line">        break</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">    shift</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 默认选用base目录</span><br><span class="line">CONF=$&#123;CONF:-openkylin&#125;</span><br><span class="line"></span><br><span class="line">if [ ! -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">    color_error &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125; not exist!!&quot;</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 参数 优先级 2</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;PROP:-default.prop&#125;&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;PROP:-default.prop&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 参数 优先级 3</span><br><span class="line">for item in &quot;$@&quot;; do</span><br><span class="line">    if grep -q &quot;^VK.*=&quot; &lt;&lt;&lt;&quot;$&#123;item&#125;&quot;; then</span><br><span class="line">        KEY=$&#123;item%%=*&#125;</span><br><span class="line">        VALUE=&quot;$&#123;item##*=&#125;&quot;</span><br><span class="line">        eval &quot;export $&#123;KEY&#125;=&#x27;$&#123;VALUE&#125;&#x27;&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 参数 优先级 4</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;VK_ENV&#125;&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;VK_ENV&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 是否保留镜像制作目录</span><br><span class="line">VK_KEEP_IMAGE_DIR=$&#123;VK_KEEP_IMAGE_DIR:-y&#125;</span><br><span class="line"></span><br><span class="line">VK_ARCH=$&#123;VK_ARCH:-arm64&#125;</span><br><span class="line">VK_MIRROR=$&#123;VK_MIRROR:-http://archive.build.openkylin.top/openkylin&#125;</span><br><span class="line">VK_SUITE=$&#123;VK_SUITE:-yangtze&#125;</span><br><span class="line">VK_VERSION=$&#123;VK_VERSION:-test&#125;</span><br><span class="line"></span><br><span class="line">ROOTFS_DIR=&quot;openKylin&quot;</span><br><span class="line">if [ -n &quot;$&#123;VK_VERSION&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_VERSION&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_TERMINAL&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_TERMINAL&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_BOARD&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_BOARD&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_ARCH&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_ARCH&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 函数库 优先级 2</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/functions.sh&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/functions.sh&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">color_info &quot;---&gt; args&quot;</span><br><span class="line">set | grep &quot;^VK_&quot; | tee &quot;$&#123;ROOTFS_DIR&#125;.prop&quot;</span><br><span class="line"></span><br><span class="line">function exit_function() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-iso/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">    umount_target ./p1</span><br><span class="line">    umount_target ./p2</span><br><span class="line">    umount_target ./p3</span><br><span class="line"></span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trap &quot;exit_function&quot; 0</span><br><span class="line"></span><br><span class="line">umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$&#123;VK_TASKS&#125;&quot; ]; then</span><br><span class="line">    color_error &quot;---&gt; no task to do!!&quot;</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 判断是否支持此架构</span><br><span class="line">if ! echo &quot;$&#123;VK_ARCH&#125;&quot; | grep -q -E &quot;amd64|arm64|loongarch64|i386|riscv64&quot;; then</span><br><span class="line">    color_error &quot;not support &#x27;ARCH: $&#123;VK_ARCH&#125;&#x27;&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># x86上制作其他架构, 需安装 binfmt-support,qemu-user-static</span><br><span class="line">if [ &quot;$(dpkg --print-architecture)&quot; == &quot;amd64&quot; ] &amp;&amp; [ &quot;$&#123;VK_ARCH&#125;&quot; != &quot;amd64&quot; ]; then</span><br><span class="line">    check_package binfmt-support</span><br><span class="line">    check_package qemu-user-static</span><br><span class="line">elif [ &quot;$(dpkg --print-architecture)&quot; != &quot;$&#123;VK_ARCH&#125;&quot; ]; then</span><br><span class="line">    # 非x86, 提示不能制作其他架构</span><br><span class="line">    color_error &quot;current os is $(dpkg --print-architecture), don&#x27;t support $&#123;VK_ARCH&#125;!!&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 执行任务</span><br><span class="line">##################################################</span><br><span class="line">for task in $&#123;VK_TASKS//,/ &#125;; do</span><br><span class="line">    color_info &quot;---&gt; do_$&#123;task&#125;&quot;</span><br><span class="line">    export VK_CURRENT_TASK=&quot;$&#123;task&#125;&quot;</span><br><span class="line">    do_&quot;$&#123;task&#125;&quot;</span><br><span class="line">done | tee &quot;$&#123;ROOTFS_DIR&#125;.log&quot;</span><br><span class="line">##################################################</span><br></pre></td></tr></table></figure>
<p>判断了，确实没有什么需要学习的地方</p>
<h1 id="functionssh脚本分析"><a class="markdownIt-Anchor" href="#functionssh脚本分析"></a> functions.sh脚本分析</h1>
<p>这里面的内容有点多，我先将每个函数隔离出来</p>
<h2 id="函数-config_sudo"><a class="markdownIt-Anchor" href="#函数-config_sudo"></a> 函数 config_sudo</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY# 配置sudo免密</span><br><span class="line">function config_sudo() &#123;</span><br><span class="line">    if [ $(id -u) != 0 ]; then</span><br><span class="line">        sudo tee /etc/sudoers.d/$USER &lt;&lt;EOF</span><br><span class="line">$USER ALL=(ALL:ALL) NOPASSWD: ALL</span><br><span class="line">EOF</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-check_package"><a class="markdownIt-Anchor" href="#函数-check_package"></a> 函数 check_package</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">COPY# 检查是否安装指定包</span><br><span class="line">function check_package() &#123;</span><br><span class="line">    pkg_name=&quot;$1&quot;</span><br><span class="line">    if [ -n &quot;$&#123;pkg_name&#125;&quot; ]; then</span><br><span class="line">        if ! dpkg -l | grep &quot;^ii  $&#123;pkg_name&#125;&quot;; then</span><br><span class="line">            sudo apt-get install -y -qq &quot;$&#123;pkg_name&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-mount_host_to_target"><a class="markdownIt-Anchor" href="#函数-mount_host_to_target"></a> 函数 mount_host_to_target</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY# 宿主机挂载 设备节点 到 rootfs</span><br><span class="line">function mount_host_to_target() &#123;</span><br><span class="line">    sudo mount --bind /dev $&#123;1&#125;/dev</span><br><span class="line">    sudo mount --bind /run $&#123;1&#125;/run</span><br><span class="line">    sudo mount -t devpts devpts $&#123;1&#125;/dev/pts</span><br><span class="line">    sudo mount -t proc proc $&#123;1&#125;/proc</span><br><span class="line">    sudo mount -t sysfs sysfs $&#123;1&#125;/sys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-umount_target"><a class="markdownIt-Anchor" href="#函数-umount_target"></a> 函数 umount_target</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COPY# 卸载宿主设备节点</span><br><span class="line">function umount_target() &#123;</span><br><span class="line">    sudo umount -l $&#123;1&#125;/* &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">    sudo umount $&#123;1&#125; &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_rootfs"><a class="markdownIt-Anchor" href="#函数-do_rootfs"></a> 函数 do_rootfs</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">COPY# 制作基础根文件系统</span><br><span class="line">function do_rootfs() &#123;</span><br><span class="line">    # 先删除 原有 rootfs 目录</span><br><span class="line">    if [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.done&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        MY_LOG_EXEC &quot;sudo rm -rf $&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # debootstrap 参数</span><br><span class="line">        DEBOOTSTRAP_ARGS=&quot;--no-check-gpg --variant=minbase --arch=$&#123;VK_ARCH&#125; --components=main --include=openkylin-keyring,systemd-sysv $&#123;VK_SUITE&#125; $&#123;ROOTFS_DIR&#125; $&#123;VK_MIRROR&#125; gutsy&quot;</span><br><span class="line"></span><br><span class="line">        # 制作 rootfs</span><br><span class="line">        MY_LOG_EXEC &quot;sudo debootstrap $&#123;DEBOOTSTRAP_ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 记录基础rootfs的包列表，给第2步升级包版本用</span><br><span class="line">        # sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27; &gt; /rootfs.deblist&quot;</span><br><span class="line">        # cp &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line">        sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27;&quot; &gt;&quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line"></span><br><span class="line">        sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/archives/*.deb</span><br><span class="line">        if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/*.bin</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Packages</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_InRelease</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Translation*</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/root/.bash_history</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/tmp/*</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # rootfs制作完成</span><br><span class="line">        MY_LOG_EXEC &quot;touch $&#123;ROOTFS_DIR&#125;.done&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_config"><a class="markdownIt-Anchor" href="#函数-do_config"></a> 函数 do_config</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">COPY# 进入根文件系统进行安装、配置</span><br><span class="line">function do_config() &#123;</span><br><span class="line">    # 需要升级基础rootfs</span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ] &amp;&amp; [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.rootfs-update.deblist&quot; ]; then</span><br><span class="line">        MY_LOG_EXEC &quot;sudo cp -v $&#123;ROOTFS_DIR&#125;.rootfs.deblist $&#123;ROOTFS_DIR&#125;/rootfs.deblist&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 挂载</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    mount_host_to_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝配置到 $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo mkdir -p $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo cp -v $&#123;CURRENT_DIR&#125;/config/*.sh $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">    if [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        sudo cp -r $&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/. $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">        # 制作</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; /usr/bin/env -i \</span><br><span class="line">            PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \</span><br><span class="line">            HOME=/root \</span><br><span class="line">            LC_ALL=C \</span><br><span class="line">            DEBIAN_FRONTEND=noninteractive \</span><br><span class="line">            APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=DontWarn \</span><br><span class="line">            bash -euo pipefail /config/main.sh &quot;$(set | grep &quot;^VK_&quot; | xargs)&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#x27;config/$&#123;CONF&#125;&#x27; not exits!&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 卸载</span><br><span class="line">    umount_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 参考分析用</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    # sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/config $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; == &quot;config&quot; ]; then</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.deblist</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 删除 update 包列表</span><br><span class="line">    if [ -f &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist ]; then</span><br><span class="line">        cp -v &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist</span><br><span class="line">    fi</span><br><span class="line">    sudo rm -v -rf &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs*.deblist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_tar"><a class="markdownIt-Anchor" href="#函数-do_tar"></a> 函数 do_tar</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COPY# 将 rootfs 打为 tar 包</span><br><span class="line">function do_tar() &#123;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo tar zcf $&#123;ROOTFS_DIR&#125;.tar.gz --numeric-owner -C $&#123;ROOTFS_DIR&#125; .&quot;</span><br><span class="line">    md5sum $&#123;ROOTFS_DIR&#125;.tar.gz &gt;$&#123;ROOTFS_DIR&#125;.tar.gz.md5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_iso"><a class="markdownIt-Anchor" href="#函数-do_iso"></a> 函数 do_iso</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">COPY# 制作iso文件</span><br><span class="line">function do_iso() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    pushd &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line"></span><br><span class="line">    do_config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.$&#123;VK_CURRENT_TASK&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 镜像名称</span><br><span class="line">    ISO_FILENAME=&quot;$&#123;ROOTFS_DIR&#125;.iso&quot;</span><br><span class="line">    CDROM_DIR=&quot;$&#123;ROOTFS_DIR&#125;-cdrom&quot;</span><br><span class="line"></span><br><span class="line">    sudo rm -rf $&#123;CDROM_DIR&#125;</span><br><span class="line">    mkdir -pv $&#123;CDROM_DIR&#125;/&#123;casper,boot/grub,EFI/BOOT&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝 内核 和 initrd</span><br><span class="line">    if [ -f $&#123;ROOTFS_DIR&#125;/boot/vmlinuz ] &amp;&amp; [ -f $&#123;ROOTFS_DIR&#125;/boot/initrd.img ]; then</span><br><span class="line">        # 标准内核情况</span><br><span class="line">        sudo cp -v $&#123;ROOTFS_DIR&#125;/boot/vmlinuz $&#123;CDROM_DIR&#125;/casper/vmlinuz</span><br><span class="line">        sudo cp -v $&#123;ROOTFS_DIR&#125;/boot/initrd.img $&#123;CDROM_DIR&#125;/casper/initrd.lz</span><br><span class="line">    else</span><br><span class="line">        # 没有内核软链接文件的情况</span><br><span class="line">        VMLINUXZ=$(sudo find $&#123;ROOTFS_DIR&#125;/boot -name &quot;vmlinuz*&quot; | head -n1)</span><br><span class="line">        INITRD_IMG=$(sudo find $&#123;ROOTFS_DIR&#125;/boot -name &quot;initrd*&quot; | head -n1)</span><br><span class="line">        sudo cp -v $&#123;VMLINUXZ&#125; $&#123;CDROM_DIR&#125;/casper/vmlinuz</span><br><span class="line">        sudo cp -v $&#123;INITRD_IMG&#125; $&#123;CDROM_DIR&#125;/casper/initrd.lz</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; mksquash&quot;</span><br><span class="line">    [ -f $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs ] &amp;&amp; sudo rm -rf $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs</span><br><span class="line">    [ -f $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs ] || sudo mksquashfs $&#123;ROOTFS_DIR&#125; $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs -quiet # -comp xz -no-progress</span><br><span class="line">    printf $(sudo du -sx --block-size=1 $&#123;ROOTFS_DIR&#125; | cut -f1) &gt;$&#123;CDROM_DIR&#125;/casper/filesystem.size</span><br><span class="line"></span><br><span class="line">    # iso grub菜单项</span><br><span class="line">    cat &gt;$&#123;CDROM_DIR&#125;/boot/grub/grub.cfg &lt;&lt;EOF</span><br><span class="line">set default=0</span><br><span class="line">set timeout=3</span><br><span class="line"></span><br><span class="line">set color_normal=white/black</span><br><span class="line">set color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">menuentry &quot;install openkylin&quot; &#123;</span><br><span class="line">    linux   /casper/vmlinuz boot=casper only-ubiquity locale=zh_CN quiet splash</span><br><span class="line">    initrd  /casper/initrd.lz</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    if [ &quot;$&#123;VK_ARCH&#125;&quot; = &quot;arm64&quot; ]; then</span><br><span class="line">        EFINAME=&quot;bootaa64.efi&quot;</span><br><span class="line">    elif [ &quot;$&#123;VK_ARCH&#125;&quot; = &quot;amd64&quot; ]; then</span><br><span class="line">        EFINAME=&quot;bootx64.efi&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # efi</span><br><span class="line">    if [ -f &quot;$&#123;CURRENT_DIR&#125;/$&#123;EFINAME&#125;&quot; ]; then</span><br><span class="line">        cp -v $&#123;CURRENT_DIR&#125;/$&#123;EFINAME&#125; $&#123;CDROM_DIR&#125;/EFI/BOOT/$&#123;EFINAME&#125;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=$&#123;CDROM_DIR&#125;/boot/grub/efi.img bs=1M count=10</span><br><span class="line">    mkfs.vfat $&#123;CDROM_DIR&#125;/boot/grub/efi.img</span><br><span class="line">    mmd -i $&#123;CDROM_DIR&#125;/boot/grub/efi.img efi efi/boot</span><br><span class="line">    mcopy -i $&#123;CDROM_DIR&#125;/boot/grub/efi.img $&#123;CDROM_DIR&#125;/EFI/BOOT/$&#123;EFINAME&#125; ::efi/boot/</span><br><span class="line"></span><br><span class="line">    [ -d $&#123;CURRENT_DIR&#125;/config/cdrom ] &amp;&amp; cp -r $&#123;CURRENT_DIR&#125;/config/cdrom/. $&#123;CDROM_DIR&#125;</span><br><span class="line"></span><br><span class="line">    sudo mkisofs -input-charset utf-8 -J -r -V openKylin -eltorito-alt-boot -e boot/grub/efi.img -no-emul-boot -o $&#123;ISO_FILENAME&#125; $&#123;CDROM_DIR&#125;</span><br><span class="line">    md5sum &quot;$&#123;ISO_FILENAME&#125;&quot; &gt;&quot;$&#123;ISO_FILENAME&#125;&quot;.md5</span><br><span class="line">    cp -rf &quot;$&#123;ISO_FILENAME&#125;&quot;* ..</span><br><span class="line">    cp -rf ./*.deblist ..</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;ISO_FILENAME&#125;* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 $&#123;VK_CURRENT_TASK&#125; 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125; 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体硬件构建"><a class="markdownIt-Anchor" href="#具体硬件构建"></a> 具体硬件构建</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br></pre></td><td class="code"><pre><span class="line">COPY# 双椒派 镜像</span><br><span class="line">function do_img_chilliepi() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">    do_config</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 128 + 2048))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line"></span><br><span class="line">    # boot分区</span><br><span class="line">    sgdisk -n 0:0:+128M -c 0:boot &quot;$&#123;IMAGE_FILE&#125;&quot; &gt;/dev/null</span><br><span class="line">    # 根分区</span><br><span class="line">    sgdisk -n 0:0:0 -c 0:root &quot;$&#123;IMAGE_FILE&#125;&quot; &gt;/dev/null</span><br><span class="line"></span><br><span class="line">    # sgdisk -p &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    yes | sudo mkfs.vfat -n BOOT $&#123;LOOP_DEV&#125;p1</span><br><span class="line">    yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;LOOP_DEV&#125;p2</span><br><span class="line"></span><br><span class="line">    part1_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p1)</span><br><span class="line">    part2_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p2)</span><br><span class="line"></span><br><span class="line">    echo part1_uuid=$&#123;part1_uuid&#125;</span><br><span class="line">    echo part2_uuid=$&#123;part2_uuid&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝文件</span><br><span class="line">    mkdir -p &#123;p1,p2&#125;</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p1 ./p1/</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p2 ./p2/</span><br><span class="line"></span><br><span class="line">    # copy boot</span><br><span class="line">    sudo cp -v -rf -a $&#123;ROOTFS_DIR&#125;/boot/. ./p1/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./p2/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee ./p2/etc/fstab &lt;&lt;EOF</span><br><span class="line">UUID=$&#123;part2_uuid&#125;   /           ext4    rw,relatime 0 1</span><br><span class="line">UUID=$&#123;part1_uuid&#125;   /boot       vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo umount ./p1 ./p2</span><br><span class="line">    rmdir p1 p2</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 树莓派 4B</span><br><span class="line">function do_img_rpi4b() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 128 + 1024))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mktable msdos</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mkpart primary fat32 1MiB 128MiB</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mkpart primary ext4 128MiB 100%</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; set 1 boot on</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    yes | sudo mkfs.vfat -n BOOT -F 32 $&#123;LOOP_DEV&#125;p1</span><br><span class="line">    yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;LOOP_DEV&#125;p2</span><br><span class="line"></span><br><span class="line">    part1_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p1)</span><br><span class="line">    part2_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p2)</span><br><span class="line"></span><br><span class="line">    echo part1_uuid=$&#123;part1_uuid&#125;</span><br><span class="line">    echo part2_uuid=$&#123;part2_uuid&#125;</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p2 $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p1 $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./$&#123;ROOT_TARGET&#125;/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/etc/fstab &lt;&lt;EOF</span><br><span class="line">UUID=$&#123;part2_uuid&#125;   /           ext4    rw,relatime 0 1</span><br><span class="line">UUID=$&#123;part1_uuid&#125;   /boot       vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # copy boot</span><br><span class="line">    git clone https://gitee.com/openkylin/bootfiles-embedded.git</span><br><span class="line">    sudo cp -v -rf ./bootfiles-embedded/rpi4b/boot/. ./$&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    sudo tee ./$&#123;ROOT_TARGET&#125;/boot/cmdline.txt &lt;&lt;EOF</span><br><span class="line">console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 root=/dev/mmcblk0p2 rootfstype=ext4 rootwait</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo tee ./$&#123;ROOT_TARGET&#125;/boot/config.txt &lt;&lt;EOF</span><br><span class="line">[all]</span><br><span class="line">kernel=vmlinuz-5.15.92-v8+</span><br><span class="line">cmdline=cmdline.txt</span><br><span class="line"></span><br><span class="line">[pi4]</span><br><span class="line">max_framebuffers=2</span><br><span class="line">arm_boost=1</span><br><span class="line">dtoverlay=vc4-fkms-v3d</span><br><span class="line"></span><br><span class="line">[all]</span><br><span class="line">dtparam=audio=on</span><br><span class="line">dtparam=i2c_arm=on</span><br><span class="line">dtparam=spi=on</span><br><span class="line">disable_overscan=1</span><br><span class="line">dtoverlay=vc4-kms-v3d</span><br><span class="line">dtoverlay=dwc2</span><br><span class="line">camera_auto_detect=1</span><br><span class="line">display_auto_detect=1</span><br><span class="line">arm_64bit=1</span><br><span class="line">dtparam=audio=on</span><br><span class="line">enable_uart=1</span><br><span class="line">enable_gic=1</span><br><span class="line">dtoverlay=pi3-miniuart-bt</span><br><span class="line">force_turbo=1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sync</span><br><span class="line"></span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function do_img_vf2() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 64 + 256))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line"></span><br><span class="line">    sgdisk --clear --set-alignment=2 \</span><br><span class="line">        --new=1:4096:8191 --change-name=1:spl --typecode=1:2E54B353-1271-4842-806F-E436D6AF6985 \</span><br><span class="line">        --new=2:8192:16383 --change-name=2:uboot --typecode=2:BC13C2FF-59E6-4262-A352-B275FD6F7172 \</span><br><span class="line">        --new=3:16384:+64M --change-name=3:system --typecode=3:EBD0A0A2-B9E5-4433-87C0-68B6B72699C7 \</span><br><span class="line">        --new=4:0:-0 --change-name=4:rootfs --typecode=4:0x8300 \</span><br><span class="line">        &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # spl and uboot for vf2</span><br><span class="line">    U_BOOT_SPL=&quot;https://www.openkylin.top/public/software/Embedded/visionfive2/u-boot-spl.bin.normal.out&quot;</span><br><span class="line">    U_BOOT_FILE=&quot;https://www.openkylin.top/public/software/Embedded/visionfive2/visionfive2_fw_payload.img&quot;</span><br><span class="line">    wget -qO- $&#123;U_BOOT_SPL&#125; | sudo dd of=$&#123;LOOP_DEV&#125;p1 status=progress</span><br><span class="line">    wget -qO- $&#123;U_BOOT_FILE&#125; | sudo dd of=$&#123;LOOP_DEV&#125;p2 status=progress</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    sudo mkfs.vfat $&#123;LOOP_DEV&#125;p3</span><br><span class="line">    sudo mkfs.ext4 $&#123;LOOP_DEV&#125;p4</span><br><span class="line">    sudo dosfslabel $&#123;LOOP_DEV&#125;p3 BOOT</span><br><span class="line">    sudo e2label $&#123;LOOP_DEV&#125;p4 ROOT</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    # mount root partition</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p4 $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p3 $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./$&#123;ROOT_TARGET&#125;/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/etc/fstab &lt;&lt;EOF</span><br><span class="line"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt; </span><br><span class="line">LABEL=ROOT  /               ext4    errors=remount-ro 0       1</span><br><span class="line">LABEL=BOOT  /boot           vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # uEnv.txt</span><br><span class="line">    echo &quot;---&gt; generate uEnv.txt&quot;</span><br><span class="line">    sudo tee &quot;$&#123;ROOT_TARGET&#125;&quot;/boot/uEnv.txt &lt;&lt;EOF</span><br><span class="line">fdt_high=0xffffffffffffffff</span><br><span class="line">initrd_high=0xffffffffffffffff</span><br><span class="line">kernel_addr_r=0x44000000</span><br><span class="line">kernel_comp_addr_r=0x90000000</span><br><span class="line">kernel_comp_size=0x10000000</span><br><span class="line">fdt_addr_r=0x48000000</span><br><span class="line">ramdisk_addr_r=0x48100000</span><br><span class="line"># Move distro to first boot to speed up booting</span><br><span class="line">boot_targets=distro mmc0 dhcp</span><br><span class="line"># Fix wrong fdtfile name</span><br><span class="line">fdtfile=starfive/jh7110-visionfive-v2.dtb</span><br><span class="line"># Fix missing bootcmd</span><br><span class="line">#bootcmd=run load_distro_uenv;run bootcmd_distro</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo touch &quot;$&#123;ROOT_TARGET&#125;&quot;/boot/vf2_uEnv.txt</span><br><span class="line"></span><br><span class="line">    # extlinux.conf</span><br><span class="line">    echo &quot;---&gt; generate extlinux.conf&quot;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot/extlinux</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/boot/extlinux/extlinux.conf &lt;&lt;EOF</span><br><span class="line">default openkylin</span><br><span class="line">menu title openkylin</span><br><span class="line">prompt 0</span><br><span class="line">timeout 50</span><br><span class="line"></span><br><span class="line">label openkylin</span><br><span class="line">	menu label openkylin</span><br><span class="line">	linux /vmlinuz-5.10.79+</span><br><span class="line">	initrd /initrd.img-5.10.79+</span><br><span class="line">	</span><br><span class="line">	fdtdir /dtbs</span><br><span class="line">	append  root=/dev/mmcblk1p4 rw rootwait console=ttyS0,115200 earlycon rootwait</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # umount</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function do_img_lotus2() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    MY_LOG_EXEC &quot;sudo tar zcf $&#123;ROOTFS_DIR&#125;.tar.gz -C $&#123;ROOTFS_DIR&#125; .&quot;</span><br><span class="line">    md5sum $&#123;ROOTFS_DIR&#125;.tar.gz &gt;$&#123;ROOTFS_DIR&#125;.tar.gz.md5</span><br><span class="line">    cp -rf $&#123;ROOTFS_DIR&#125;.tar.gz* ..</span><br><span class="line">    popd</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 飞腾派</span><br><span class="line">function do_img_phytiumpi() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; use $&#123;VK_UBOOT_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 1024))</span><br><span class="line"></span><br><span class="line">    # 文件系统放在ext4文件中</span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;ROOTFS_DIR&#125;.ext4&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line">    # 格式化ext4</span><br><span class="line">    MY_LOG_EXEC &quot;yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;ROOTFS_DIR&#125;.ext4&quot;</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo mount $&#123;ROOTFS_DIR&#125;.ext4 $&#123;ROOT_TARGET&#125;&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. $&#123;ROOT_TARGET&#125;&quot;</span><br><span class="line"></span><br><span class="line">    sync</span><br><span class="line"></span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line"></span><br><span class="line">    # 安装uboot</span><br><span class="line">    echo &quot;---&gt; install uboot&quot;</span><br><span class="line">    (</span><br><span class="line">        # 先删除旧的</span><br><span class="line">        rm -rf ./phyitum-pi/</span><br><span class="line"></span><br><span class="line">        mkdir -p ./phyitum-pi/resource</span><br><span class="line">        cp -v $&#123;ROOTFS_DIR&#125;/boot/vmlinuz ./phyitum-pi/resource/vmlinuz</span><br><span class="line"></span><br><span class="line">        cd ./phyitum-pi/resource</span><br><span class="line">        wget -R &quot;index.html*,*.deb&quot; -r -np -nd http://factory.openkylin.top/kif/archive/get/repos/phyitumpi/pool/</span><br><span class="line"></span><br><span class="line">        # mkimage 依赖 上面拷贝的vmlinuz文件</span><br><span class="line">        mkimage -f ./edu.its ./uImage.itd</span><br><span class="line"></span><br><span class="line">        # cp -v $&#123;VK_UBOOT_FILE&#125; fip.bin</span><br><span class="line">        # dd if=./uImage.itd of=./fip.bin bs=1M seek=4</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./phyitum-pi/resource/$&#123;VK_UBOOT_FILE&#125; of=$&#123;IMAGE_FILE&#125; conv=notrunc&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./phyitum-pi/resource/uImage.itd of=$&#123;IMAGE_FILE&#125; bs=1M seek=4 conv=notrunc&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./$&#123;ROOTFS_DIR&#125;.ext4 of=$&#123;IMAGE_FILE&#125; bs=1M seek=64 conv=notrunc&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; success&quot;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="构建自己的脚本"><a class="markdownIt-Anchor" href="#构建自己的脚本"></a> 构建自己的脚本</h1>
<blockquote>
<p>我的目的也只是想要构建一个文件系统，由于ubuntu24上才能构建成功base，所以我就在一个基础包上构建即可。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COPYapt install -y apt-utils kmod kbd whiptail locales \</span><br><span class="line">	systemd-resolved vim lsof cpio file sudo tree wget rsync \</span><br><span class="line">	fdisk gdisk parted psmisc rsyslog dosfstools lsb-release archdetect-deb \</span><br><span class="line">	bash-completion zstd iputils-ping iproute2 net-tools network-manager \</span><br><span class="line">	wpasupplicant openssh-server openssh-client xinit lightdm xdg-user-dirs </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apt install ukui-control-center ukui-desktop-environment ukui-desktop-environment-core \</span><br><span class="line">	ukui-greeter openkylin-wallpapers ukui-globaltheme-heyin libukuiinputgatherclient1 \</span><br><span class="line">	 ukui-notebook \</span><br><span class="line"> 	kylin-daq kylin-app-manager</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	apt install xserver-xorg-video-fbdev xserver-xorg-input-all 	libqt5sql5-sqlite onboard python3-xdg remmina remmina-plugin-vnc network-manager-gnome </span><br></pre></td></tr></table></figure>
<p>openkylin-anything.list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYdeb http://ppa.build.openkylin.top/kylinsoft/anything2.0/openkylin/ nile main</span><br></pre></td></tr></table></figure>
<p>openkylin-software.list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYdeb http://software.openkylin.top/openkylin/ nile main all    </span><br></pre></td></tr></table></figure>
<p>问题解决了，使用官方的构建脚本的话会出现几个问题，首先呢源不对，要将源换成2.0的开放麒麟源，再然后呢需要将apt的整个目录换掉，最后有个deb包是装不上的，需要手动装一下，这样才是真的成功，然后呢，我已经构建成功迅为的开放麒麟镜像了，现在开始研究一下官方构建步骤的楼层</p>
<h1 id="构建流程"><a class="markdownIt-Anchor" href="#构建流程"></a> 构建流程</h1>
<p>直接输入./okbuild.sh而不添加任何参数会打印usage，说明该脚本总共支持的平台，以及各个平台的编译步骤，这里使用树莓派的编译命令，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY./okbuild.sh -p prop_rpi4b </span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026406.png" alt="image-20240817151602795" />image-20240817151602795</p>
<p>这个命令总共有两个参数，分别为-p选项和prop_rpi4b 参数，其实在shell脚本里，这些都属于参数，写下来的内容呢就是对这两个参数进行判断，然后赋值，具体内容会将prop_rpi4b 赋值给PROP，CONF默认值为openkylin，再然后读取了prop配置文件的值，该文件的值接下来会进行逐个判定，先列一下该配置文件的具体内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 版本状态</span><br><span class="line">VK_VERSION=&quot;1.0.2&quot;</span><br><span class="line"># 主板标识</span><br><span class="line">VK_BOARD=&quot;rpi4b&quot;</span><br><span class="line"># 架构</span><br><span class="line">VK_ARCH=&quot;arm64&quot;</span><br><span class="line"># 执行顺序</span><br><span class="line">VK_ORDER=&quot;order_rpi4b&quot;</span><br><span class="line"></span><br><span class="line"># 执行任务</span><br><span class="line">VK_TASKS=&quot;rootfs,config,img_rpi4b&quot;</span><br><span class="line"></span><br><span class="line">VK_UPDATE=&quot;y&quot;</span><br><span class="line">VK_KEEP_IMAGE_DIR=&quot;n&quot;</span><br></pre></td></tr></table></figure>
<p>最后会将这些值导入，这里最重要的是VK_TASKS，在okbuild.sh中，他的最后会依次执行rootfs,config,img_rpi4b，也就是do_rootfs函数、do_config函数，以及do_img_rpi4b函数，do_rootfs函数很简单，就是构建了一个最小文件系统，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">COPYfunction do_rootfs() &#123;</span><br><span class="line">    # 先删除 原有 rootfs 目录</span><br><span class="line">    if [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.done&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        MY_LOG_EXEC &quot;sudo rm -rf $&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # debootstrap 参数</span><br><span class="line">        DEBOOTSTRAP_ARGS=&quot;--no-check-gpg --variant=minbase --arch=$&#123;VK_ARCH&#125; --components=main --include=openkylin-keyring,systemd-sysv $&#123;VK_SUITE&#125; $&#123;ROOTFS_DIR&#125; $&#123;VK_MIRROR&#125; gutsy&quot;</span><br><span class="line"></span><br><span class="line">        # 制作 rootfs</span><br><span class="line">        MY_LOG_EXEC &quot;sudo debootstrap $&#123;DEBOOTSTRAP_ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 记录基础rootfs的包列表，给第2步升级包版本用</span><br><span class="line">        # sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27; &gt; /rootfs.deblist&quot;</span><br><span class="line">        # cp &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line">        sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27;&quot; &gt;&quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line"></span><br><span class="line">        sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/archives/*.deb</span><br><span class="line">        if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/*.bin</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Packages</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_InRelease</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Translation*</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/root/.bash_history</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/tmp/*</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # rootfs制作完成</span><br><span class="line">        MY_LOG_EXEC &quot;touch $&#123;ROOTFS_DIR&#125;.done&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来do_config</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">COPY</span><br><span class="line"># 进入根文件系统进行安装、配置</span><br><span class="line">function do_config() &#123;</span><br><span class="line">    # 需要升级基础rootfs</span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ] &amp;&amp; [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.rootfs-update.deblist&quot; ]; then</span><br><span class="line">        MY_LOG_EXEC &quot;sudo cp -v $&#123;ROOTFS_DIR&#125;.rootfs.deblist $&#123;ROOTFS_DIR&#125;/rootfs.deblist&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 挂载</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    mount_host_to_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝配置到 $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo mkdir -p $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo cp -v $&#123;CURRENT_DIR&#125;/config/*.sh $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">    if [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        sudo cp -r $&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/. $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">        # 制作</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; /usr/bin/env -i \</span><br><span class="line">            PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \</span><br><span class="line">            HOME=/root \</span><br><span class="line">            LC_ALL=C \</span><br><span class="line">            DEBIAN_FRONTEND=noninteractive \</span><br><span class="line">            APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=DontWarn \</span><br><span class="line">            bash -euo pipefail /config/main.sh &quot;$(set | grep &quot;^VK_&quot; | xargs)&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#x27;config/$&#123;CONF&#125;&#x27; not exits!&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 卸载</span><br><span class="line">    umount_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 参考分析用</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    # sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/config $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; == &quot;config&quot; ]; then</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.deblist</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 删除 update 包列表</span><br><span class="line">    if [ -f &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist ]; then</span><br><span class="line">        cp -v &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist</span><br><span class="line">    fi</span><br><span class="line">    sudo rm -v -rf &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs*.deblist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他这里就很灵性，亦或者很取巧，他把config目录整个搬进去了，这样直接在chroot环境运行，这肯定没啥问题，我就没想到这个地方，虽然这属于一个很简单的地方，果然是不传递的，之前的想发也就不对了，在ubuntu上定义的环境变量，是不会进入到chroot的环境中的，如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026448.png" alt="image-20240817154352321" />image-20240817154352321</p>
<table>
<thead>
<tr>
<th>对传入的两个参数进行判断</th>
<th>将prop_rpi4b 赋值给PROP</th>
<th>读取prop配置文件值，并导入进环境变量</th>
<th>根据VK_TASKS值进行任务逐个执行</th>
<th>首先执行do_rootfs</th>
<th>然后执行do_config</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>至此对于流程就大致分析完成了，确实挺简单的，就是一些shell脚本的语法还不是很熟悉，但也就这样了，开放麒麟的构建就这样了，后续也没啥东西了，ok，那就先这样。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/15_rk 内核镜像构建"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/11/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/15_rk%20%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/"
    >RK内核镜像构建</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/11/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/15_rk%20%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/" class="article-date">
  <time datetime="2024-08-11T09:17:03.000Z" itemprop="datePublished">2024-08-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>我只是想到，单纯的看视频并没有什么用，我现在认为实践是检验真理的唯一标准。</p>
<p>先来看编译的过程：</p>
<p>实际的编译命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make -C kernel/ -j33 CROSS_COMPILE=/home/topeet/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64 rockchip_linux_defconfig rk3588_linux.config</span><br><span class="line"></span><br><span class="line">make -C kernel/ -j33 CROSS_COMPILE=/home/topeet/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64 topeet-rk3588-linux.img</span><br><span class="line">/home/topeet/rk3588-linux/device/rockchip/common/scripts/mk-fitimage.sh kernel/boot.img /home/topeet/rk3588-linux/kernel/boot.its kernel/arch/arm64/boot/Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">make -j33 CROSS_COMPILE=/home/topeet/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64</span><br></pre></td></tr></table></figure>
<p>内核镜像的生成过程以及后续压缩成 <code>Image.gz</code> 的过程可以分为以下几个步骤：</p>
<h3 id="image-生成过程"><a class="markdownIt-Anchor" href="#image-生成过程"></a> Image 生成过程</h3>
<ol>
<li><strong>配置内核</strong>
<ul>
<li>使用 <code>make menuconfig</code> 或其他配置工具选择适当的内核选项。</li>
<li>配置文件通常保存为 <code>.config</code>。</li>
</ul>
</li>
<li><strong>编译内核</strong>
<ul>
<li>运行 <code>make</code> 命令，开始编译内核。</li>
<li>编译过程主要包括：
<ul>
<li><strong>预处理</strong>：解析头文件和宏定义。</li>
<li><strong>编译</strong>：将 C 语言代码编译为汇编。</li>
<li><strong>汇编</strong>：将汇编代码转换为目标代码。</li>
<li><strong>链接</strong>：将目标文件链接为单个内核镜像 <code>vmlinux</code>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>生成 Image</strong>
<ul>
<li><code>vmlinux</code> 是一个未压缩的 ELF 格式文件。</li>
<li>通过 <code>objcopy</code> 工具，将 <code>vmlinux</code> 转换为可加载的 <code>Image</code> 格式（通常是裸数据格式）。</li>
</ul>
</li>
</ol>
<h3 id="imagegz-生成过程"><a class="markdownIt-Anchor" href="#imagegz-生成过程"></a> Image.gz 生成过程</h3>
<ol>
<li><strong>压缩内核</strong>
<ul>
<li>使用 <code>gzip</code> 工具压缩 <code>Image</code> 文件，生成 <code>Image.gz</code>。</li>
<li>压缩后的文件更小，方便传输和存储。</li>
</ul>
</li>
<li><strong>安装内核（可选）</strong>
<ul>
<li>将 <code>Image.gz</code> 复制到引导加载程序可访问的目录。</li>
<li>更新引导加载程序配置以加载新的内核。</li>
</ul>
</li>
</ol>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<ul>
<li><strong>Image</strong> 是内核的未压缩版本，适合直接加载。</li>
<li><strong>Image.gz</strong> 是压缩版本，适合节省空间。</li>
</ul>
<p>这种流程适用于大多数 Linux 内核的构建和压缩过程。具体步骤可能根据不同的硬件平台和配置选项有所调整。</p>
<p>wsl.exe --system -d Ubuntu-22.04 df -h /mnt/wslg/distro</p>
<p>列出已经安装的发行版镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --list --verbose</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408092111207.png" alt="image-20240809211103188" /></p>
<p>注销Linux发行版</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --unregister &lt;DistributionName&gt;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/13_rga的学习"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/10/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/13_rga%E7%9A%84%E5%AD%A6%E4%B9%A0/"
    >rga的学习</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/10/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/13_rga%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2024-07-10T09:17:03.000Z" itemprop="datePublished">2024-07-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="rga源码获取"><a class="markdownIt-Anchor" href="#rga源码获取"></a> RGA源码获取</h1>
<p><a target="_blank" rel="noopener" href="https://meta.zbox.filez.com/v/link/view/c3559cbbf1514464bf109b44901db9fa">https://meta.zbox.filez.com/v/link/view/c3559cbbf1514464bf109b44901db9fa</a>  提取码rkrga</p>
<h1 id="rga源码编译"><a class="markdownIt-Anchor" href="#rga源码编译"></a> RGA源码编译</h1>
<p>​	其实源码的编译很简单，总共是需要安装三个工具分别为gcc g++和cmake</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install cmake g++ gcc </span><br><span class="line">sudo apt install g++-9-aarch64-linux-gnu gcc-9-aarch64-linux-gnu </span><br></pre></td></tr></table></figure>
<p>然后链接一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++</span><br><span class="line">sudo ln -s /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++</span><br></pre></td></tr></table></figure>
<p>然后修改源码目录的cmake交叉编译器设置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim toolchains/toolchain_linux.cmake</span><br></pre></td></tr></table></figure>
<p>修改完成之后如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102042549.png" alt="image-20240710204241524" /></p>
<p>​	然后直接运行cmake-linux.sh编译即可，编译完成如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SCRIPT_DIR=$PWD</span><br><span class="line">SOURCE_PATH=$&#123;SCRIPT_DIR&#125;</span><br><span class="line">TOOLCHAIN_PATH=$&#123;SOURCE_PATH&#125;/toolchains/toolchain_linux.cmake</span><br><span class="line"></span><br><span class="line">cmake 	-DBUILD_TOOLCHAINS_PATH=$&#123;TOOLCHAIN_PATH&#125; .</span><br><span class="line"></span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line">popd</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102055766.png" alt="image-20240710205510721" /></p>
<p>​	会在源码目录下的build/build_linux/install目录中生成后续使用的头文件和库，可以看到lib库不仅提供了so动态库还提供了.a静态库</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102055622.png" alt="image-20240710205553582" /></p>
<p>​	使用file命令也可以得到他的架构类型：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102057202.png" alt="image-20240710205752179" /></p>
<p>​	还有第二种meson的编译方法，其实还挺简单，但是我还是很喜欢cmake 的方式的，方便，只需要改一下cross/cross_file_aarch64.txt文件，修改以下几个地方，还挺简单，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c = &#x27;/usr/bin/aarch64-linux-gnu-gcc&#x27;</span><br><span class="line">cpp = &#x27;/usr/bin/aarch64-linux-gnu-g++&#x27;</span><br><span class="line">ar = &#x27;/usr/bin/aarch64-linux-gnu-ar&#x27;</span><br><span class="line">strip = &#x27;/usr/bin/aarch64-linux-gnu-strip&#x27;</span><br></pre></td></tr></table></figure>
<p>​	然后运行./meson.sh脚本即可，具体步骤如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102151221.png" alt="image-20240710215119171" /></p>
<p>​	会将要用到的包放到build/meson_aarch64/install目录下，具体如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102152895.png" alt="image-20240710215203845" /></p>
<p>​	行了，就先到这里。</p>
<h1 id="开发板上rga的使用"><a class="markdownIt-Anchor" href="#开发板上rga的使用"></a> 开发板上RGA的使用</h1>
<p>​	上面的编译步骤直接在开发板上试了一下，然后替换对应的rga库，然后来测试rga Demo，首先获取RGA属性，具体如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407122110073.png" alt="image-20240712211025031" /></p>
<table>
<thead>
<tr>
<th style="text-align:left">项目</th>
<th style="text-align:left">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">选择模式</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">im2d querystring</td>
<td style="text-align:left">…</td>
</tr>
<tr>
<td style="text-align:left">RGA 演示模式</td>
<td style="text-align:left">0x0</td>
</tr>
<tr>
<td style="text-align:left">RGA API 版本</td>
<td style="text-align:left">1.10.1_[0]</td>
</tr>
<tr>
<td style="text-align:left">RGA 供应商</td>
<td style="text-align:left">Rockchip Electronics Co.,Ltd.</td>
</tr>
<tr>
<td style="text-align:left">RGA API 版本</td>
<td style="text-align:left">v1.10.1_[0]</td>
</tr>
<tr>
<td style="text-align:left">RGA 版本</td>
<td style="text-align:left">RGA_2_Enhance RGA_3</td>
</tr>
<tr>
<td style="text-align:left">最大输入分辨率</td>
<td style="text-align:left">8192x8192</td>
</tr>
<tr>
<td style="text-align:left">最大输出分辨率</td>
<td style="text-align:left">8128x8128</td>
</tr>
<tr>
<td style="text-align:left">字节对齐</td>
<td style="text-align:left">16 byte</td>
</tr>
<tr>
<td style="text-align:left">缩放比例范围</td>
<td style="text-align:left">0.0625 ~ 16</td>
</tr>
<tr>
<td style="text-align:left">输入格式</td>
<td style="text-align:left">RGBA/ARGB_8888, RGB_888, RGB_565, ARGB_4444, ARGB_5551, YUV420_sp_8bit, YUV420_sp_10bit, YUV420_p_8bit, YUV420_p_10bit, YUV422_sp_8bit, YUV422_sp_10bit, YUV422_p_8bit, YUV422_p_10bit, YUYV422, YUV400</td>
</tr>
<tr>
<td style="text-align:left">输出格式</td>
<td style="text-align:left">RGBA/ARGB_8888, RGB_888, RGB_565, ARGB_4444, ARGB_5551, RGBA_4444, RGBA_5551, YUV420_sp_8bit, YUV420_sp_10bit, YUV420_p_8bit, YUV422_sp_8bit, YUV422_sp_10bit, YUV422_p_8bit, YUYV420, YUYV422, YUV400, Y4</td>
</tr>
<tr>
<td style="text-align:left">RGA 功能</td>
<td style="text-align:left">color_fill, color_palette, ROP, quantize, src1_r2y_csc, dst_full_csc, FBC_mode, blend_in_YUV, BT.2020</td>
</tr>
<tr>
<td style="text-align:left">预期性能</td>
<td style="text-align:left">最大 4 像素/周期</td>
</tr>
</tbody>
</table>
<p>以下是整理后的<code>rgaImDemo</code>使用说明：</p>
<h3 id="用法"><a class="markdownIt-Anchor" href="#用法"></a> 用法：</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh复制代码rgaImDemo [--help/-h] [--while/-w=(time)] [--querystring/--querystring=&lt;options&gt;]</span><br><span class="line">          [--copy] [--resize=&lt;up/down&gt;] [--crop] [--rotate=90/180/270]</span><br><span class="line">          [--flip=H/V] [--translate] [--blend] [--cvtcolor]</span><br><span class="line">          [--fill=blue/green/red]</span><br></pre></td></tr></table></figure>
<h3 id="参数说明"><a class="markdownIt-Anchor" href="#参数说明"></a> 参数说明：</h3>
<h4 id="基本选项"><a class="markdownIt-Anchor" href="#基本选项"></a> 基本选项：</h4>
<ul>
<li><code>--help</code> / <code>-h</code>: 显示帮助信息。</li>
<li><code>--while</code> / <code>-w=(time)</code>: 设置循环模式，用户可以自行设定循环次数。</li>
</ul>
<h4 id="查询信息"><a class="markdownIt-Anchor" href="#查询信息"></a> 查询信息：</h4>
<ul>
<li>
<pre><code class="shell">--querystring
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> / </span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">--querystring=&lt;options&gt;</span><br></pre></td></tr></table></figure>

: 根据选项打印当前版本的RGA的版本或支持信息。如果没有输入选项，则打印所有版本和支持信息。

&lt;options&gt;

- `vendor`: 打印厂商信息。
- `version`: 打印RGA版本和librga/im2d_api版本。
- `maxinput`: 打印最大输入分辨率。
- `maxoutput`: 打印最大输出分辨率。
- `scalelimit`: 打印缩放限制。
- `inputformat`: 打印支持的输入格式。
- `outputformat`: 打印支持的输出格式。
- `expected`: 打印预期性能。
- `all`: 打印所有信息（默认）。

</code></pre>
</li>
</ul>
<h4 id="图像处理选项"><a class="markdownIt-Anchor" href="#图像处理选项"></a> 图像处理选项：</h4>
<ul>
<li>
<p><code>--copy</code>: 使用RGA复制图像，默认是720p到720p。</p>
</li>
<li>
<p><code>--resize</code>: 使用RGA调整图像大小，可以选择放大或缩小。</p>
<options>
<ul>
<li><code>up</code>: 放大720p (1280x720) -&gt; 1080p (1920x1080)。</li>
<li><code>down</code>: 缩小720p (1280x720) -&gt; 480p (720x480)。</li>
</ul>
</li>
<li>
<p><code>--crop</code>: 使用RGA裁剪图像，默认从(100,100)位置裁剪300x300大小的图像。</p>
</li>
<li>
<p><code>--rotate</code>: 使用RGA旋转图像，可以选择旋转角度。</p>
<options>
<ul>
<li><code>90</code>: 旋转90度。</li>
<li><code>180</code>: 旋转180度。</li>
<li><code>270</code>: 旋转270度。</li>
</ul>
</li>
<li>
<p><code>--flip</code>: 使用RGA翻转图像，可以选择水平或垂直翻转。</p>
<options>
<ul>
<li><code>H</code>: 水平镜像。</li>
<li><code>V</code>: 垂直镜像。</li>
</ul>
</li>
<li>
<p><code>--translate</code>: 使用RGA平移图像，默认平移(300,300)。</p>
</li>
<li>
<p><code>--blend</code>: 使用RGA混合图像，默认是Porter-Duff的’SRC over DST’模式。</p>
<options>
<ul>
<li><code>src</code>: Porter-Duff SRC模式。</li>
<li><code>dst</code>: Porter-Duff DST模式。</li>
<li><code>src-over</code>: Porter-Duff SRC-OVER模式（默认）。</li>
<li><code>dst-over</code>: Porter-Duff DST-OVER模式。</li>
<li><code>src-in</code>: Porter-Duff SRC-IN模式。</li>
<li><code>dst-in</code>: Porter-Duff DST-IN模式。</li>
<li><code>src-out</code>: Porter-Duff SRC-OUT模式。</li>
<li><code>dst-out</code>: Porter-Duff DST-OUT模式。</li>
<li><code>src-atop</code>: Porter-Duff SRC-ATOP模式。</li>
<li><code>dst-atop</code>: Porter-Duff DST-ATOP模式。</li>
<li><code>xor</code>: Porter-Duff XOR模式。</li>
</ul>
</li>
<li>
<p><code>--cvtcolor</code>: 使用RGA修改图像格式和颜色空间，默认是RGBA8888到NV12。</p>
</li>
<li>
<p><code>--fill</code>: 使用RGA填充图像颜色，可以选择填充为蓝色、绿色或红色。</p>
<options>
<ul>
<li><code>red</code>: 填充为红色。</li>
<li><code>blue</code>: 填充为蓝色。</li>
<li><code>green</code>: 填充为绿色。</li>
<li><code>&lt;value&gt;</code>: 填充颜色值，格式为红[0:7]绿[8:15]蓝[16:23] alpha[24:31]。</li>
</ul>
</li>
</ul>
<h3 id="示例用法"><a class="markdownIt-Anchor" href="#示例用法"></a> 示例用法：</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sh复制代码# 显示帮助信息</span><br><span class="line">rgaImDemo --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置循环模式，循环次数为10</span></span><br><span class="line">rgaImDemo --while=10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印RGA版本和支持信息</span></span><br><span class="line">rgaImDemo --querystring=all</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制图像</span></span><br><span class="line">rgaImDemo --copy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">放大图像</span></span><br><span class="line">rgaImDemo --resize=up</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">旋转图像90度</span></span><br><span class="line">rgaImDemo --rotate=90</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">水平翻转图像</span></span><br><span class="line">rgaImDemo --flip=H</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">混合图像，使用Porter-Duff的SRC模式</span></span><br><span class="line">rgaImDemo --blend=src</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">填充图像为蓝色</span></span><br><span class="line">rgaImDemo --fill=blue</span><br></pre></td></tr></table></figure>
<p>以上是整理后的<code>rgaImDemo</code>使用说明，以便更好地理解和使用该工具。</p>
<p>终于显示出来了正常的图片，有点问题：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407122201709.png" alt="image-20240712220110651" /></p>
<p>​	 现在可以了，这是我的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 RGBA 数据</span></span><br><span class="line">img_data = np.fromfile(<span class="string">&#x27;out0w1920-h1080-rgba8888.bin&#x27;</span>, dtype=np.uint8)</span><br><span class="line">img = img_data.reshape((<span class="number">1080</span>, <span class="number">1920</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为 BGR 格式</span></span><br><span class="line">img_bgr = cv2.cvtColor(img, cv2.COLOR_RGBA2BGR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存图像为 JPG 格式</span></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;output.jpg&#x27;</span>, img_bgr)</span><br></pre></td></tr></table></figure>
<p>​	终于算是能读取出来了，行了现在去研究一下RGA的代码吧，其实也没啥，这个RGA的程序跟oepncv是一样的，这一点毋庸置疑，只要学过opencv这个就不是问题。</p>
<h1 id="rga_resize_demo"><a class="markdownIt-Anchor" href="#rga_resize_demo"></a> rga_resize_demo</h1>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 版权所有 (C) 2022  Rockchip Electronics Co., Ltd.</span></span><br><span class="line"><span class="comment"> * 作者:</span></span><br><span class="line"><span class="comment"> *     YuQiaowei &lt;cerf.yu@rock-chips.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 根据 Apache 许可证，版本 2.0（“许可证”）授权；</span></span><br><span class="line"><span class="comment"> * 您不能根据许可证使用此文件，除非符合许可证。</span></span><br><span class="line"><span class="comment"> * 您可以在以下网址获取许可证副本：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 除非适用法律要求或书面同意，按照许可证分发的软件</span></span><br><span class="line"><span class="comment"> * 是按“原样”分发的，没有任何明示或暗示的担保或条件。</span></span><br><span class="line"><span class="comment"> * 请参阅许可证以了解管理权限和限制的特定语言。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_NDEBUG 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG <span class="string">&quot;rga_resize_demo&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RgaUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;im2d.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCAL_FILE_PATH <span class="string">&quot;/data&quot;</span>  <span class="comment">// 本地文件路径</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> src_width, src_height, src_format;  <span class="comment">// 源图像的宽度、高度和格式</span></span><br><span class="line">    <span class="type">int</span> dst_width, dst_height, dst_format;  <span class="comment">// 目标图像的宽度、高度和格式</span></span><br><span class="line">    <span class="type">char</span> *src_buf, *dst_buf;  <span class="comment">// 源图像和目标图像的缓冲区</span></span><br><span class="line">    <span class="type">int</span> src_buf_size, dst_buf_size;  <span class="comment">// 源图像和目标图像的缓冲区大小</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rga_buffer_t</span> src_img, dst_img;  <span class="comment">// RGA 缓冲区类型</span></span><br><span class="line">    <span class="type">rga_buffer_handle_t</span> src_handle, dst_handle;  <span class="comment">// RGA 缓冲区句柄</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;src_img, <span class="number">0</span>, <span class="keyword">sizeof</span>(src_img));  <span class="comment">// 初始化源图像缓冲区</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dst_img, <span class="number">0</span>, <span class="keyword">sizeof</span>(dst_img));  <span class="comment">// 初始化目标图像缓冲区</span></span><br><span class="line"></span><br><span class="line">    src_width = <span class="number">1280</span>;  <span class="comment">// 设置源图像宽度</span></span><br><span class="line">    src_height = <span class="number">720</span>;  <span class="comment">// 设置源图像高度</span></span><br><span class="line">    src_format = RK_FORMAT_RGBA_8888;  <span class="comment">// 设置源图像格式</span></span><br><span class="line"></span><br><span class="line">    dst_width = <span class="number">1920</span>;  <span class="comment">// 设置目标图像宽度</span></span><br><span class="line">    dst_height = <span class="number">1080</span>;  <span class="comment">// 设置目标图像高度</span></span><br><span class="line">    dst_format = RK_FORMAT_RGBA_8888;  <span class="comment">// 设置目标图像格式</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算源图像和目标图像缓冲区大小</span></span><br><span class="line">    src_buf_size = src_width * src_height * get_bpp_from_format(src_format);</span><br><span class="line">    dst_buf_size = dst_width * dst_height * get_bpp_from_format(dst_format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为源图像和目标图像分配缓冲区</span></span><br><span class="line">    src_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(src_buf_size);</span><br><span class="line">    dst_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(dst_buf_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 填充图像数据 */</span></span><br><span class="line">    <span class="comment">// 从文件读取源图像数据，如果读取失败则绘制RGBA图像</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != read_image_from_file(src_buf, LOCAL_FILE_PATH, src_width, src_height, src_format, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;src image read err\n&quot;</span>);</span><br><span class="line">        draw_rgba(src_buf, src_width, src_height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(dst_buf, <span class="number">0x80</span>, dst_buf_size);  <span class="comment">// 初始化目标图像缓冲区</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导入虚拟地址缓冲区</span></span><br><span class="line">    src_handle = importbuffer_virtualaddr(src_buf, src_buf_size);</span><br><span class="line">    dst_handle = importbuffer_virtualaddr(dst_buf, dst_buf_size);</span><br><span class="line">    <span class="keyword">if</span> (src_handle == <span class="number">0</span> || dst_handle == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;importbuffer failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> release_buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装缓冲区句柄为RGA缓冲区</span></span><br><span class="line">    src_img = wrapbuffer_handle(src_handle, src_width, src_height, src_format);</span><br><span class="line">    dst_img = wrapbuffer_handle(dst_handle, dst_width, dst_height, dst_format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 将源图像放大到1920*1080。</span></span><br><span class="line"><span class="comment">        --------------    ---------------------</span></span><br><span class="line"><span class="comment">        |            |    |                   |</span></span><br><span class="line"><span class="comment">        |  src_img   |    |     dst_img       |</span></span><br><span class="line"><span class="comment">        |            | =&gt; |                   |</span></span><br><span class="line"><span class="comment">        --------------    |                   |</span></span><br><span class="line"><span class="comment">                          |                   |</span></span><br><span class="line"><span class="comment">                          ---------------------</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查源图像和目标图像的合法性</span></span><br><span class="line">    ret = imcheck(src_img, dst_img, &#123;&#125;, &#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span> (IM_STATUS_NOERROR != ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d, check error! %s&quot;</span>, __LINE__, imStrError((IM_STATUS)ret));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用RGA库进行图像缩放</span></span><br><span class="line">    ret = imresize(src_img, dst_img);</span><br><span class="line">    <span class="keyword">if</span> (ret == IM_STATUS_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s running success!\n&quot;</span>, LOG_TAG);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s running failed, %s\n&quot;</span>, LOG_TAG, imStrError((IM_STATUS)ret));</span><br><span class="line">        <span class="keyword">goto</span> release_buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将目标图像写入文件</span></span><br><span class="line">    write_image_to_file(dst_buf, LOCAL_FILE_PATH, dst_width, dst_height, dst_format, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">release_buffer:</span><br><span class="line">    <span class="comment">// 释放RGA缓冲区句柄</span></span><br><span class="line">    <span class="keyword">if</span> (src_handle)</span><br><span class="line">        releasebuffer_handle(src_handle);</span><br><span class="line">    <span class="keyword">if</span> (dst_handle)</span><br><span class="line">        releasebuffer_handle(dst_handle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放缓冲区内存</span></span><br><span class="line">    <span class="keyword">if</span> (src_buf)</span><br><span class="line">        <span class="built_in">free</span>(src_buf);</span><br><span class="line">    <span class="keyword">if</span> (dst_buf)</span><br><span class="line">        <span class="built_in">free</span>(dst_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​</p>
<p>deb安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y sudo locales git fakeroot devscripts cmake vim qemu-user-static:arm64 binfmt-support \</span><br><span class="line">        dh-make dh-exec pkg-kde-tools device-tree-compiler:arm64 bc cpio parted dosfstools mtools libssl-dev:arm64 \</span><br><span class="line">        g++-aarch64-linux-gnu dpkg-dev meson debhelper pkgconf</span><br></pre></td></tr></table></figure>
<p>编译deb包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo DEB_BUILD_OPTIONS=nocheck dpkg-buildpackage -b -d -uc -us -aarm64</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/12_uboot启动流程"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/04/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/12_uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"
    >uboot启动流程</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/04/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/12_uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time datetime="2024-07-04T08:17:03.000Z" itemprop="datePublished">2024-07-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>​	uboot可以说就是一个裸机程序，是由一系列程序链接起来的，链接脚本为根目录下的u-boot.lds</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042042636.png" alt="image-20240704204240610" /></p>
<p>*(.__image_copy_start) 先不用管，零长度数组。</p>
<p>然后是 arch/arm/cpu/armv8/start.o (.text*)</p>
<p>首次执行的是reset，具体内容如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042056573.png" alt="image-20240704205658534" /></p>
<p>​	而reset的内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	/* Allow the board to save important registers */</span><br><span class="line">	b	save_boot_params</span><br><span class="line">.globl	save_boot_params_ret</span><br></pre></td></tr></table></figure>
<p>反正最后是跳到了arch/arm/lib/crt0.S，在该汇编文件中构建了C语言的临时运行环境，然后运行了board_init_f_ C语言函数。</p>
<p>该函数在common/board_r.c文件中，具体内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_r</span><span class="params">(<span class="type">gd_t</span> *new_gd, ulong dest_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Set up the new global data pointer. So far only x86 does this</span></span><br><span class="line"><span class="comment">	 * here.</span></span><br><span class="line"><span class="comment">	 * TODO(sjg@chromium.org): Consider doing this for all archs, or</span></span><br><span class="line"><span class="comment">	 * dropping the new_gd parameter.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(X86_64)</span></span><br><span class="line">	arch_setup_gd(new_gd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_ARM64)</span></span><br><span class="line">	gd = new_gd;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	gd-&gt;flags &amp;= ~GD_FLG_LOG_READY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">		init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (initcall_run_list(init_sequence_r))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* NOTREACHED - run_main_loop() does not return */</span></span><br><span class="line">	hang();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	其中init_sequence_r是一个数组，有各种初始化操作，具体如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042126409.png" alt="image-20240704212609374" /></p>
<p>然后继续根据瑞芯微的来即可：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042210930.png" alt="image-20240704221021869" /></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/11_ubuntu构建完整系统"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/05/15/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/11_ubuntu%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%B3%BB%E7%BB%9F/"
    >ubuntu完整构建</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/05/15/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/11_ubuntu%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time datetime="2024-05-15T09:17:03.000Z" itemprop="datePublished">2024-05-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="脚本整理"><a class="markdownIt-Anchor" href="#脚本整理"></a> 脚本整理</h1>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export BOARD_NAME=&quot;Orange Pi 5&quot;                                                                              </span><br><span class="line">export BOARD_MAKER=&quot;Xulong&quot;                                                                                  </span><br><span class="line">export UBOOT_PACKAGE=&quot;u-boot-orangepi-rk3588&quot;                                                                </span><br><span class="line">export UBOOT_RULES_TARGET=&quot;orangepi_5&quot;                                                                       </span><br><span class="line">export UBOOT_RULES_TARGET_EXTRA=&quot;orangepi_5_sata&quot;      </span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822471.png" alt="image-20240509205731107" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">topeet@topeet:~/Linux/ubuntu-rockchip/config/kernels$ cat rockchip-5.10.conf </span><br><span class="line">KERNEL_REPO=https://github.com/Joshua-Riek/linux-rockchip.git</span><br><span class="line">KERNEL_BRANCH=linux-5.10-gen-rkr6</span><br><span class="line">KERNEL_VERSION=5.10.160</span><br><span class="line">KERNEL_CLONE_DIR=linux-rockchip</span><br><span class="line">KERNEL_DEFCONFIG=rockchip_linux_defconfig</span><br><span class="line">DPKG_BUILDPACKAGE=y</span><br><span class="line">topeet@topeet:~/Linux/ubuntu-rockchip/config/kernels$ </span><br></pre></td></tr></table></figure>
<p>build.sh分析的差不多了，主要就是执行了下面的这四个脚本：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822066.png" alt="image-20240509210304254" /></p>
<p>当然这些脚本里面肯定是用到了相应的环境变量的，这一点毋庸置疑。从上往下慢慢来，<a target="_blank" rel="noopener" href="http://xn--build-kernel-fq3te7fyw3kyta.sh">先来分析build-kernel.sh</a>。</p>
<h2 id="build-kernelsh"><a class="markdownIt-Anchor" href="#build-kernelsh"></a> <a target="_blank" rel="noopener" href="http://build-kernel.sh">build-kernel.sh</a></h2>
<p>source …/config/kernels/“${KERNEL_TARGET}.conf”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KERNEL_REPO=https://github.com/Joshua-Riek/linux-rockchip.git</span><br><span class="line">KERNEL_BRANCH=linux-5.10-gen-rkr6</span><br><span class="line">KERNEL_VERSION=5.10.160</span><br><span class="line">KERNEL_CLONE_DIR=linux-rockchip</span><br><span class="line">KERNEL_DEFCONFIG=rockchip_linux_defconfig</span><br><span class="line">DPKG_BUILDPACKAGE=y</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>git clone --progress -b “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>K</mi><mi>E</mi><mi>R</mi><mi>N</mi><mi>E</mi><msub><mi>L</mi><mi>B</mi></msub><mi>R</mi><mi>A</mi><mi>N</mi><mi>C</mi><mi>H</mi></mrow><mi mathvariant="normal">&quot;</mi><mi mathvariant="normal">&quot;</mi></mrow><annotation encoding="application/x-tex">{KERNEL_BRANCH}&quot; &quot;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span><span class="mord">&quot;</span><span class="mord">&quot;</span></span></span></span>{KERNEL_REPO}” “${KERNEL_CLONE_DIR}” --depth=2</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export ftp_proxy=http://127.0.0.1:8889/</span><br><span class="line">export https_proxy=http://127.0.0.1:8889/</span><br><span class="line">export FTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTPS_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export http_proxy=http://127.0.0.1:8889/</span><br><span class="line"></span><br><span class="line"> git clone --progress -b linux-5.10-gen-rkr6 https://github.com/Joshua-Riek/linux-rockchip.git linux-rockchip --depth=2</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822488.png" alt="image-20240509210716946" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd linux-rockchip</span><br><span class="line">git checkout linux-5.10-gen-rkr6</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822548.png" alt="image-20240509210951189" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">构建二进制软件包</span></span><br><span class="line">sudo dpkg-buildpackage -a &quot;$(cat debian/arch)&quot; -d -b -nc -uc</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认配置文件</span></span><br><span class="line">make rockchip_linux_defconfig CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm64 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置内核编译数字</span></span><br><span class="line">    echo &quot;1&quot; &gt; .version</span><br><span class="line">    touch .scmversion</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译内核到一个deb包当中</span></span><br><span class="line">sudo make bindeb-pkg \</span><br><span class="line">    KBUILD_IMAGE=&quot;arch/arm64/boot/Image&quot; \</span><br><span class="line">    KDEB_PKGVERSION=&quot;$(make kernelversion)-rockchip-1&quot; \</span><br><span class="line">    KERNELRELEASE=&quot;$(make kernelversion)-rockchip&quot; \</span><br><span class="line">    CROSS_COMPILE=aarch64-linux-gnu- \</span><br><span class="line">    ARCH=arm64 \</span><br><span class="line">    -j &quot;$(nproc)&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822409.png" alt="image-20240509213751095" /></p>
<p>​	编译完成是这俩重要的deb文件,一个是用来存放内核头，一个是用来存放镜像例如设备树、内核、驱动文件等。具体的使用以后再说，然后开始看uboot的编译。</p>
<h2 id="build-u-bootsh"><a class="markdownIt-Anchor" href="#build-u-bootsh"></a> <a target="_blank" rel="noopener" href="http://build-u-boot.sh">build-u-boot.sh</a></h2>
<p>UBOOT_PACKAGE是在board里面配置的时候设置的，具体如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822437.png" alt="image-20240509215108602" /></p>
<p>我这里就继续以香橙派为例进行说明：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822658.png" alt="" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405092152376.png" alt="image-20240509215244172" /></p>
<p>具体就是upstream 文件的内容，具体如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIT=https://github.com/orangepi-xunlong/u-boot-orangepi.git</span><br><span class="line">COMMIT=7f7ff61a8b79fdb4f2d51dfb8aa643b8bc3ada0c</span><br><span class="line">BRANCH=v2017.09-rk3588</span><br><span class="line">VERSION=2017.09+20240401.git7f7ff61a</span><br></pre></td></tr></table></figure>
<p>最终的整合命令为:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone --single-branch --progress -b v2017.09-rk3588 https://github.com/orangepi-xunlong/u-boot-orangepi.git u-boot-orangepi-rk3588</span><br><span class="line">git -C u-boot-orangepi-rk3588 checkout 7f7ff61a8b79fdb4f2d51dfb8aa643b8bc3ada0c</span><br><span class="line">cp -r ubuntu-rockchip/packages/u-boot-orangepi-rk3588/debian u-boot-orangepi-rk3588</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822916.png" alt="image-20240509215535488" /></p>
<p>​	果然每家都有每家的uboot，算是又强了一点点，这个地方我直接用我家的uboot应该也是可以的，当然我家的uboot是基本没改过的，就也还行吧。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rules=orangepi_5,package-orangepi_5</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前处理，就是打了一些补丁</span></span><br><span class="line">dpkg-source --before-build .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 编译uboot，这里不是这么简单</span></span><br><span class="line">dpkg-buildpackage -a &quot;$(cat debian/arch)&quot; -d -b -nc -uc --rules-target=&quot;$&#123;rules&#125;&quot;</span><br><span class="line">dpkg-source --after-build .</span><br><span class="line"></span><br><span class="line">rm -f ../*.buildinfo ../*.changes</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202405100822890.png" alt="image-20240509220655758" /></p>
<p>​	可以看到最后生成了uboot的deb包。</p>
<h2 id="build-rootfssh"><a class="markdownIt-Anchor" href="#build-rootfssh"></a> <a target="_blank" rel="noopener" href="http://build-rootfs.sh">build-rootfs.sh</a></h2>
<p>​	设置几个相关环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export RELASE_NAME=&quot;Ubuntu 22.04 LTS (Jammy Jellyfish)&quot;</span><br><span class="line">export RELASE_VERSION=&quot;22.04&quot;</span><br><span class="line">if [ -z &quot;$&#123;KERNEL_TARGET&#125;&quot; ]; then</span><br><span class="line">    export KERNEL_TARGET=&quot;rockchip-5.10&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Joshua-Riek/ubuntu-live-build.git</span><br><span class="line"></span><br><span class="line">cd ubuntu-live-build</span><br><span class="line">bash ./docker/build-livecd-rootfs.sh</span><br><span class="line">bash ./build.sh &quot;--desktop&quot; &quot;--jammy&quot;</span><br><span class="line">mv &quot;./build/ubuntu-$&#123;RELASE_VERSION&#125;-preinstalled-$&#123;PROJECT&#125;-arm64.rootfs.tar.xz&quot; ../</span><br></pre></td></tr></table></figure>
<h2 id="config-imagesh"><a class="markdownIt-Anchor" href="#config-imagesh"></a> <a target="_blank" rel="noopener" href="http://config-image.sh">config-image.sh</a></h2>
<p>​	导入两个文件的环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">shellcheck shell=bash</span></span><br><span class="line"></span><br><span class="line">export BOARD_NAME=&quot;Orange Pi 5B&quot;</span><br><span class="line">export BOARD_MAKER=&quot;Xulong&quot;</span><br><span class="line">export UBOOT_PACKAGE=&quot;u-boot-orangepi-rk3588&quot;</span><br><span class="line">export UBOOT_RULES_TARGET=&quot;orangepi_5b&quot;</span><br><span class="line"></span><br><span class="line">function config_image_hook__orangepi-5b() &#123;</span><br><span class="line">    local rootfs=&quot;$1&quot;</span><br><span class="line">    local overlay=&quot;$2&quot;</span><br><span class="line"></span><br><span class="line">    # Install panfork</span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; add-apt-repository -y ppa:jjriek/panfork-mesa</span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; apt-get update</span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; apt-get -y install mali-g610-firmware</span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; apt-get -y dist-upgrade</span><br><span class="line"></span><br><span class="line">    # Enable bluetooth for AP6275P</span><br><span class="line">    mkdir -p &quot;$&#123;rootfs&#125;/usr/lib/scripts&quot;</span><br><span class="line">    cp &quot;$&#123;overlay&#125;/usr/lib/systemd/system/ap6275p-bluetooth.service&quot; &quot;$&#123;rootfs&#125;/usr/lib/systemd/system/ap6275p-bluetooth.service&quot;</span><br><span class="line">    cp &quot;$&#123;overlay&#125;/usr/lib/scripts/ap6275p-bluetooth.sh&quot; &quot;$&#123;rootfs&#125;/usr/lib/scripts/ap6275p-bluetooth.sh&quot;</span><br><span class="line">    cp &quot;$&#123;overlay&#125;/usr/bin/brcm_patchram_plus&quot; &quot;$&#123;rootfs&#125;/usr/bin/brcm_patchram_plus&quot;</span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; systemctl enable ap6275p-bluetooth</span><br><span class="line"></span><br><span class="line">    # Enable USB 2.0 port</span><br><span class="line">    cp &quot;$&#123;overlay&#125;/usr/lib/systemd/system/enable-usb2.service&quot; &quot;$&#123;rootfs&#125;/usr/lib/systemd/system/enable-usb2.service&quot;</span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; systemctl --no-reload enable enable-usb2</span><br><span class="line"></span><br><span class="line">    # Install wiring orangepi package </span><br><span class="line">    chroot &quot;$&#123;rootfs&#125;&quot; apt-get -y install wiringpi-opi libwiringpi2-opi libwiringpi-opi-dev</span><br><span class="line">    echo &quot;BOARD=orangepi5&quot; &gt; &quot;$&#123;rootfs&#125;/etc/orangepi-release&quot;</span><br><span class="line"></span><br><span class="line">    return 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export RELASE_NAME=&quot;Ubuntu 22.04 LTS (Jammy Jellyfish)&quot;</span><br><span class="line">export RELASE_VERSION=&quot;22.04&quot;</span><br><span class="line">if [ -z &quot;$&#123;KERNEL_TARGET&#125;&quot; ]; then</span><br><span class="line">    export KERNEL_TARGET=&quot;rockchip-5.10&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><code>update-initramfs -u</code>命令用于更新Linux系统的初始化内存文件系统（initramfs）。</p>
<p>initramfs是一个临时的文件系统，位于Linux启动过程的早期阶段。它包含了用于引导系统的必要文件、驱动程序和工具。initramfs在系统引导时被加载到内存中，并在完成引导过程之前提供必要的资源。</p>
<p><code>update-initramfs -u</code>命令的作用是重新生成和更新initramfs文件。它会根据当前系统配置和安装的软件包，重新打包和生成initramfs文件，以确保其与当前系统环境保持同步。</p>
<p>在更新initramfs时，该命令会扫描系统上已安装的内核和相关的驱动程序，将其添加到initramfs文件中，以便在引导过程中正确加载所需的模块和驱动程序。</p>
<p>通常，在更新内核或修改了与引导相关的配置文件后，需要运行<code>update-initramfs -u</code>命令来确保initramfs文件与系统的变更保持同步。这样可以确保系统能够正确引导，并正确加载所需的模块和驱动程序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd $&#123;chroot_dir&#125; &amp;&amp; tar -cpf &quot;../ubuntu-$&#123;RELASE_VERSION&#125;-preinstalled-$&#123;PROJECT&#125;-arm64-$&#123;BOARD&#125;.rootfs.tar&quot; . &amp;&amp; cd .. &amp;&amp; rm -rf $&#123;chroot_dir&#125;</span><br><span class="line">../scripts/build-image.sh &quot;ubuntu-$&#123;RELASE_VERSION&#125;-preinstalled-$&#123;PROJECT&#125;-arm64-$&#123;BOARD&#125;.rootfs.tar&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">if [ -z &quot;$&#123;img##*server*&#125;&quot; ]; then</span><br><span class="line">    # Setup partition table</span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;disk&#125;&quot; count=4096 bs=512</span><br><span class="line">    parted --script &quot;$&#123;disk&#125;&quot; \</span><br><span class="line">    mklabel gpt \</span><br><span class="line">    mkpart primary fat32 16MiB 20MiB \</span><br><span class="line">    mkpart primary ext4 20MiB 100%</span><br><span class="line"></span><br><span class="line">    # Create partitions</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;t&quot;</span><br><span class="line">        echo &quot;1&quot;</span><br><span class="line">        echo &quot;EBD0A0A2-B9E5-4433-87C0-68B6B72699C7&quot;</span><br><span class="line">        echo &quot;t&quot;</span><br><span class="line">        echo &quot;2&quot;</span><br><span class="line">        echo &quot;C12A7328-F81F-11D2-BA4B-00A0C93EC93B&quot;</span><br><span class="line">        echo &quot;w&quot;</span><br><span class="line">    &#125; | fdisk &quot;$&#123;disk&#125;&quot; &amp;&gt; /dev/null || true</span><br><span class="line"></span><br><span class="line">    partprobe &quot;$&#123;disk&#125;&quot;</span><br><span class="line"></span><br><span class="line">    partition_char=&quot;$(if [[ $&#123;disk: -1&#125; == [0-9] ]]; then echo p; fi)&quot;</span><br><span class="line"></span><br><span class="line">    sleep 1</span><br><span class="line"></span><br><span class="line">    wait_loopdev &quot;$&#123;disk&#125;$&#123;partition_char&#125;2&quot; 60 || &#123;</span><br><span class="line">        echo &quot;Failure to create $&#123;disk&#125;$&#123;partition_char&#125;1 in time&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep 1</span><br><span class="line"></span><br><span class="line">    wait_loopdev &quot;$&#123;disk&#125;$&#123;partition_char&#125;1&quot; 60 || &#123;</span><br><span class="line">        echo &quot;Failure to create $&#123;disk&#125;$&#123;partition_char&#125;1 in time&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep 1</span><br><span class="line"></span><br><span class="line">    # Generate random uuid for bootfs</span><br><span class="line">    boot_uuid=$(uuidgen | head -c8)</span><br><span class="line"></span><br><span class="line">    # Generate random uuid for rootfs</span><br><span class="line">    root_uuid=$(uuidgen)</span><br><span class="line"></span><br><span class="line">    # Create filesystems on partitions</span><br><span class="line">    mkfs.vfat -i &quot;$&#123;boot_uuid&#125;&quot; -F32 -n CIDATA &quot;$&#123;disk&#125;$&#123;partition_char&#125;1&quot;</span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;disk&#125;$&#123;partition_char&#125;2&quot; bs=1KB count=10 &gt; /dev/null</span><br><span class="line">    mkfs.ext4 -U &quot;$&#123;root_uuid&#125;&quot; -L cloudimg-rootfs &quot;$&#123;disk&#125;$&#123;partition_char&#125;2&quot;</span><br><span class="line"></span><br><span class="line">    # Mount partitions</span><br><span class="line">    mkdir -p $&#123;mount_point&#125;/&#123;system-boot,writable&#125; </span><br><span class="line">    mount &quot;$&#123;disk&#125;$&#123;partition_char&#125;1&quot; $&#123;mount_point&#125;/system-boot</span><br><span class="line">    mount &quot;$&#123;disk&#125;$&#123;partition_char&#125;2&quot; $&#123;mount_point&#125;/writable</span><br><span class="line"></span><br><span class="line">    # Cloud init config for server image</span><br><span class="line">    cp ../overlay/boot/firmware/&#123;meta-data,user-data,network-config&#125; $&#123;mount_point&#125;/system-boot</span><br></pre></td></tr></table></figure>
<p>现在源码和镜像肯定是有了，晚上应该看看佐大的视频，还是需要再研究看看</p>
<h1 id="mycode"><a class="markdownIt-Anchor" href="#mycode"></a> mycode</h1>
<p>rkbin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export ftp_proxy=http://127.0.0.1:8889/</span><br><span class="line">export https_proxy=http://127.0.0.1:8889/</span><br><span class="line">export FTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTPS_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export http_proxy=http://127.0.0.1:8889/</span><br><span class="line"></span><br><span class="line">git clone --depth 1 https://github.com/rockchip-linux/rkbin</span><br></pre></td></tr></table></figure>
<p>官方uboot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth 1 https://source.denx.de/u-boot/u-boot.git</span><br><span class="line">cd u-boot</span><br><span class="line">export BL31=../rkbin/bin/rk35/rk3588_bl31_v1.45.elf</span><br><span class="line">export ROCKCHIP_TPL=../rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2736MHz_eyescan_v1.11.bin</span><br><span class="line">make evb-rk3588_defconfig</span><br><span class="line">make CROSS_COMPILE=aarch64-linux-gnu-</span><br></pre></td></tr></table></figure>
<p>RK uboot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rockchip-linux/u-boot.git</span><br><span class="line">cd u-boot</span><br><span class="line">export BL31=../rkbin/bin/rk35/rk3588_bl31_v1.45.elf</span><br><span class="line">export ROCKCHIP_TPL=../rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2736MHz_eyescan_v1.11.bin</span><br><span class="line">make rk3588_defconfig</span><br><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- -j32</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rules=orangepi_5,package-orangepi_5</span><br><span class="line">make mrproper</span><br><span class="line">dpkg-buildpackage -a &quot;$(cat debian/arch)&quot; -d -b -nc -uc --rules-target=&quot;$&#123;rules&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make mrproper</span><br><span class="line">rules=rk3588,package-rk3588</span><br><span class="line">dpkg-buildpackage -a &quot;$(cat debian/arch)&quot; -d -b -nc -uc --rules-target=&quot;$&#123;rules&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- orangepi_5_defconfig -j32 </span><br><span class="line">make CROSS_COMPILE=aarch64-linux-gnu-  -j32 </span><br><span class="line">make ARCH=arm \</span><br><span class="line">	CROSS_COMPILE=aarch64-linux-gnu- \</span><br><span class="line">	BL31=../rkbin/bin/rk35/rk3588_bl31_v1.38.elf \</span><br><span class="line">	spl/u-boot-spl.bin u-boot.dtb u-boot.itb \</span><br><span class="line">	-j32</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- rk3588_defconfig -j32 </span><br><span class="line">make CROSS_COMPILE=aarch64-linux-gnu-  -j32 </span><br><span class="line">make ARCH=arm \</span><br><span class="line">	CROSS_COMPILE=aarch64-linux-gnu- \</span><br><span class="line">	BL31=../rkbin/bin/rk35/rk3588_bl31_v1.38.elf \</span><br><span class="line">	spl/u-boot-spl.bin u-boot.dtb u-boot.itb \</span><br><span class="line">	-j32</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">decode_bl31.py</span><br><span class="line">def main():</span><br><span class="line">    if &quot;BL31&quot; in os.environ:</span><br><span class="line">        bl31_elf=os.getenv(&quot;BL31&quot;);</span><br><span class="line">    elif os.path.isfile(&quot;./bl31.elf&quot;):</span><br><span class="line">        bl31_elf = &quot;./bl31.elf&quot;</span><br><span class="line">    else:</span><br><span class="line">        os.system(&quot;echo &#x27;int main()&#123;&#125;&#x27; &gt; bl31.c&quot;)</span><br><span class="line">        os.system(&quot;$&#123;CROSS_COMPILE&#125;gcc -c bl31.c -o bl31.elf&quot;)</span><br><span class="line">        bl31_elf = &quot;./bl31.elf&quot;</span><br><span class="line">        logging.basicConfig(format=&#x27;%(levelname)s:%(message)s&#x27;, level=logging.DEBUG)</span><br><span class="line">        logging.warning(&#x27; BL31 file bl31.elf NOT found, resulting binary is non-functional&#x27;)</span><br><span class="line">        logging.warning(&#x27; Please read Building section in doc/README.rockchip&#x27;)</span><br><span class="line">    generate_atf_binary(bl31_elf);</span><br><span class="line">    </span><br><span class="line">make_fit_atf.sh</span><br><span class="line">	注释掉BL32</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tools/mkimage -n rk3588 -T rksd -d \</span><br><span class="line">  ../rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2736MHz_v1.11.bin:spl/u-boot-spl.bin \</span><br><span class="line">  idbloader.img</span><br></pre></td></tr></table></figure>
<p>sudo dd if=idbloader.img of=/dev/sdc seek=64</p>
<p>sudo dd if=u-boot.itb of=/dev/sdc  seek=16384 conv=notrunc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ../rkbin</span><br><span class="line">./tools/trust_merger RKTRUST/RK3588TRUST.ini</span><br><span class="line">sudo dd if=trust.img of=/dev/sdc seek=24576</span><br></pre></td></tr></table></figure>
<p>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</p>
<h1 id="系统移植"><a class="markdownIt-Anchor" href="#系统移植"></a> 系统移植</h1>
<h2 id="1构建v2ray"><a class="markdownIt-Anchor" href="#1构建v2ray"></a> 1.构建v2ray</h2>
<h2 id="2拉取源码"><a class="markdownIt-Anchor" href="#2拉取源码"></a> 2.拉取源码</h2>
<p>设置http端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export ftp_proxy=http://127.0.0.1:8889/</span><br><span class="line">export https_proxy=http://127.0.0.1:8889/</span><br><span class="line">export FTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTPS_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export http_proxy=http://127.0.0.1:8889/</span><br></pre></td></tr></table></figure>
<p>拉取orangepi源码</p>
<p>拉取ubuntu-rockchip源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Joshua-Riek/ubuntu-rockchip.git</span><br><span class="line">git clone --single-branch --progress -b v2017.09-rk3588 https://github.com/orangepi-xunlong/u-boot-orangepi.git u-boot-orangepi-rk3588</span><br><span class="line">git -C u-boot-orangepi-rk3588 checkout 7f7ff61a8b79fdb4f2d51dfb8aa643b8bc3ada0c</span><br><span class="line">cp -r ubuntu-rockchip/packages/u-boot-orangepi-rk3588/debian u-boot-orangepi-rk3588</span><br></pre></td></tr></table></figure>
<p>拉取瑞芯微官方uboot源码和rkbin源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rockchip-linux/u-boot.git</span><br><span class="line">git clone https://github.com/rockchip-linux/rkbin.git</span><br></pre></td></tr></table></figure>
<h2 id="3编译"><a class="markdownIt-Anchor" href="#3编译"></a> 3.编译</h2>
<p>安装交叉编译器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc-aarch64-linux-gnu</span><br></pre></td></tr></table></figure>
<p>修改arch/arm/mach-rockchip/decode_bl31.py文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim arch/arm/mach-rockchip/decode_bl31.py</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;BL31&quot;</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">        bl31_elf=os.getenv(<span class="string">&quot;BL31&quot;</span>);</span><br><span class="line">    <span class="keyword">elif</span> os.path.isfile(<span class="string">&quot;./bl31.elf&quot;</span>):</span><br><span class="line">        bl31_elf = <span class="string">&quot;./bl31.elf&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        os.system(<span class="string">&quot;echo &#x27;int main()&#123;&#125;&#x27; &gt; bl31.c&quot;</span>)</span><br><span class="line">        os.system(<span class="string">&quot;$&#123;CROSS_COMPILE&#125;gcc -c bl31.c -o bl31.elf&quot;</span>)</span><br><span class="line">        bl31_elf = <span class="string">&quot;./bl31.elf&quot;</span></span><br><span class="line">        logging.basicConfig(<span class="built_in">format</span>=<span class="string">&#x27;%(levelname)s:%(message)s&#x27;</span>, level=logging.DEBUG)</span><br><span class="line">        logging.warning(<span class="string">&#x27; BL31 file bl31.elf NOT found, resulting binary is non-functional&#x27;</span>)</span><br><span class="line">        logging.warning(<span class="string">&#x27; Please read Building section in doc/README.rockchip&#x27;</span>)</span><br><span class="line">    generate_atf_binary(bl31_elf);</span><br></pre></td></tr></table></figure>
<p>修改arch/arm/mach-rockchip/make_fit_atf.sh 文件注释掉#gen_bl32_node</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim arch/arm/mach-rockchip/make_fit_atf.sh</span><br><span class="line"></span><br><span class="line">source ./$&#123;srctree&#125;/arch/arm/mach-rockchip/fit_nodes.sh</span><br><span class="line"></span><br><span class="line">gen_header</span><br><span class="line">gen_uboot_node</span><br><span class="line">gen_bl31_node</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gen_bl32_node</span></span><br><span class="line">gen_mcu_node</span><br><span class="line">gen_loadable_node</span><br><span class="line">gen_kfdt_node</span><br><span class="line">gen_fdt_node</span><br><span class="line">gen_arm64_configurations</span><br></pre></td></tr></table></figure>
<p>修改波特率</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim configs/rk3588_defconfig</span><br><span class="line">CONFIG_BAUDRATE=115200</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /home/topeet/back/01_tmp/decode_bl31.py  arch/arm/mach-rockchip/</span><br><span class="line">cp /home/topeet/back/01_tmp/make_fit_atf.sh  arch/arm/mach-rockchip/</span><br><span class="line">cp /home/topeet/back/01_tmp/rk3588_defconfig configs/</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm  -j20  rk3588_defconfig</span><br><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- -j20 </span><br><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm  -j20 \</span><br><span class="line">BL31=../rkbin/bin/rk35/rk3588_bl31_v1.45.elf \</span><br><span class="line">spl/u-boot-spl.bin u-boot.dtb u-boot.itb</span><br></pre></td></tr></table></figure>
<p>构建idbloader.img</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tools/mkimage -n rk3588 -T rksd -d \</span><br><span class="line">	../rkbin/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2400MHz_v1.16.bin:spl/u-boot-spl.bin \</span><br><span class="line">	idbloader.img</span><br></pre></td></tr></table></figure>
<h2 id="4写入"><a class="markdownIt-Anchor" href="#4写入"></a> 4.写入</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if=idbloader.img of=/dev/sdc seek=64</span><br><span class="line">sudo dd if=u-boot.itb of=/dev/sdc seek=16384 conv=notrunc</span><br><span class="line">sync</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if=/dev/zero of=/dev/sdc count=4096 bs=512 </span><br><span class="line">sudo parted --script /dev/sdc  \</span><br><span class="line">mklabel gpt \</span><br><span class="line">mkpart primary fat32 16MiB 20MiB \</span><br><span class="line">mkpart primary ext4 20MiB 100%</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Create partitions</span></span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;t&quot;</span><br><span class="line">    echo &quot;1&quot;</span><br><span class="line">    echo &quot;EBD0A0A2-B9E5-4433-87C0-68B6B72699C7&quot;</span><br><span class="line">    echo &quot;t&quot;</span><br><span class="line">    echo &quot;2&quot;</span><br><span class="line">    echo &quot;C12A7328-F81F-11D2-BA4B-00A0C93EC93B&quot;</span><br><span class="line">    echo &quot;w&quot;</span><br><span class="line">&#125; | sudo fdisk /dev/sdc  &amp;&gt; /dev/null || true</span><br><span class="line"></span><br><span class="line">sudo partprobe /dev/sdc </span><br><span class="line"></span><br><span class="line">    # Generate random uuid for bootfs</span><br><span class="line">boot_uuid=$(uuidgen | head -c8)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generate random uuid <span class="keyword">for</span> rootfs</span></span><br><span class="line">root_uuid=$(uuidgen)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Create filesystems on partitions</span></span><br><span class="line">sudo mkfs.vfat -i &quot;$&#123;boot_uuid&#125;&quot; -F32 -n CIDATA /dev/sdc1</span><br><span class="line">sudo dd if=/dev/zero of=/dev/sdc2 bs=1KB count=10 &gt; /dev/null</span><br><span class="line">sudo mkfs.ext4 -U &quot;$&#123;root_uuid&#125;&quot; -L cloudimg-rootfs /dev/sdc2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mount partitions</span></span><br><span class="line">mkdir -p &#123;system-boot,writable&#125; </span><br><span class="line">mount &quot;sdc1&quot; system-boot</span><br><span class="line">mount &quot;sdc2&quot; writable</span><br></pre></td></tr></table></figure>
<h1 id="命令学习"><a class="markdownIt-Anchor" href="#命令学习"></a> 命令学习</h1>
<h2 id="mklabel"><a class="markdownIt-Anchor" href="#mklabel"></a> mklabel</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parted --script /dev/sdb \</span><br><span class="line">mklabel gpt \</span><br><span class="line">mkpart primary ext4 16MiB 100%</span><br></pre></td></tr></table></figure>
<ol>
<li>
<ul>
<li><code>mklabel gpt</code>: 创建了一个 GPT（GUID 分区表）磁盘标签。GPT 是一种磁盘分区表标准，支持更大的磁盘容量和更多的分区。</li>
<li><code>mkpart primary ext4 16MiB 100%</code>: 创建了一个主分区，并将其格式化为 ext4 文件系统。具体的参数解释如下：
<ul>
<li><code>primary</code>: 表示创建一个主分区。主分区是可用于安装操作系统或存储数据的分区类型。</li>
<li><code>ext4</code>: 表示将分区格式化为 ext4 文件系统。ext4 是一种常见的 Linux 文件系统。</li>
<li><code>16MiB</code>: 表示分区的起始位置。这里的 <code>16MiB</code> 表示分区从磁盘的 16MiB 处开始。</li>
<li><code>100%</code>: 表示分区的结束位置。这里的 <code>100%</code> 表示分区将占据整个磁盘的剩余空间。</li>
</ul>
</li>
</ul>
<p><code>--script</code> 参数用于在不需要用户交互的情况下运行 parted 命令。它告诉 parted 不要提示用户进行确认或提供交互式输入。</p>
</li>
</ol>
<h2 id="fdisk"><a class="markdownIt-Anchor" href="#fdisk"></a> fdisk</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Create partitions</span></span><br><span class="line"> &#123;</span><br><span class="line">     echo &quot;t&quot;</span><br><span class="line">     echo &quot;1&quot;</span><br><span class="line">     echo &quot;C12A7328-F81F-11D2-BA4B-00A0C93EC93B&quot;</span><br><span class="line">     echo &quot;w&quot;</span><br><span class="line"> &#125; | fdisk /dev/sdb &amp;&gt; /dev/null || true</span><br></pre></td></tr></table></figure>
<p>这段代码使用了 <code>fdisk</code> 工具来创建分区。下面是对代码中各个部分的解释：</p>
<ol>
<li><code>echo &quot;t&quot;</code>: 发送 “t” 命令给 <code>fdisk</code>，用于更改分区类型。</li>
<li><code>echo &quot;1&quot;</code>: 发送 “1” 命令给 <code>fdisk</code>，用于选择第一个分区。</li>
<li><code>echo &quot;C12A7328-F81F-11D2-BA4B-00A0C93EC93B&quot;</code>: 发送 “C12A7328-F81F-11D2-BA4B-00A0C93EC93B” 命令给 <code>fdisk</code>，用于将分区类型更改为 EFI System。</li>
<li><code>echo &quot;w&quot;</code>: 发送 “w” 命令给 <code>fdisk</code>，用于保存分区表并退出。</li>
</ol>
<h2 id="partprobe"><a class="markdownIt-Anchor" href="#partprobe"></a> partprobe</h2>
<p>​	重新加载分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">partprobe /dev/sdb</span><br></pre></td></tr></table></figure>
<h1 id="文件系统配置"><a class="markdownIt-Anchor" href="#文件系统配置"></a> 文件系统配置</h1>
<p>​	给文件系统分区设置uuid，创建ext4文件系统分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generate random uuid <span class="keyword">for</span> rootfs</span></span><br><span class="line">root_uuid=$(uuidgen)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Create filesystems on partitions</span></span><br><span class="line">dd if=/dev/zero of=/dev/sdb1 bs=1KB count=10 </span><br><span class="line">mkfs.ext4 -U &quot;$&#123;root_uuid&#125;&quot; -L desktop-rootfs /dev/sdb1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mount partitions</span></span><br><span class="line">mkdir -p writable</span><br><span class="line">mount /dev/sdb1 writable</span><br></pre></td></tr></table></figure>
<p>​	拷贝文件系统镜像到SD卡分区，并设置fstab</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copy the rootfs to root partition</span></span><br><span class="line">tar -xpf &quot;$&#123;rootfs&#125;&quot; -C writable</span><br><span class="line">echo &quot;# &lt;file system&gt;     &lt;mount point&gt;  &lt;type&gt;  &lt;options&gt;   &lt;dump&gt;  &lt;fsck&gt;&quot; &gt; writable/etc/fstab</span><br><span class="line">echo &quot;UUID=$&#123;root_uuid,,&#125; /              ext4    defaults,x-systemd.growfs    0       1&quot; &gt;&gt; writable/etc/fstab</span><br></pre></td></tr></table></figure>
<p>​	写入idbloader 和 uboot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if=idbloader.img of=/dev/sdb seek=64</span><br><span class="line">sudo dd if=u-boot.itb of=/dev/sdb seek=16384 conv=notrunc</span><br><span class="line">sync</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir boot</span><br><span class="line">sudo mkdir boot/extlinux </span><br><span class="line">sudo vim boot/extlinux/extlinux.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># /boot/extlinux/extlinux.conf</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># IMPORTANT WARNING</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># The configuration of this file is generated automatically.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Do not edit this file manually, use: u-boot-update</span></span></span><br><span class="line"></span><br><span class="line">default l0</span><br><span class="line">menu title U-Boot menu</span><br><span class="line">prompt 1</span><br><span class="line">timeout 20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">label l0</span><br><span class="line">        menu label Ubuntu 22.04.4 LTS 5.10.0-1004-rockchip</span><br><span class="line">        linux /boot/vmlinuz-5.10.0-1004-rockchip</span><br><span class="line">        initrd /boot/initrd.img-5.10.0-1004-rockchip</span><br><span class="line">        fdtdir /lib/firmware/5.10.0-1004-rockchip/device-tree/</span><br><span class="line"></span><br><span class="line">        append root=/dev/mmcblk1p1 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory</span><br><span class="line"></span><br><span class="line">label l0r</span><br><span class="line">        menu label Ubuntu 22.04.4 LTS 5.10.0-1004-rockchip (rescue target)</span><br><span class="line">        linux /boot/vmlinuz-5.10.0-1004-rockchip</span><br><span class="line">        initrd /boot/initrd.img-5.10.0-1004-rockchip</span><br><span class="line">        fdtdir /lib/firmware/5.10.0-1004-rockchip/device-tree/</span><br><span class="line">        append root=UUID=ad3b52b5-62aa-4f25-95fc-796d6126a268 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory single</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&lt;file system&gt;     &lt;mount point&gt;  &lt;<span class="built_in">type</span>&gt;  &lt;options&gt;   &lt;dump&gt;  &lt;fsck&gt;</span></span><br><span class="line">/dev/mmcblk1p1 / ext4 defaults 0 1</span><br></pre></td></tr></table></figure>
<h1 id="最终步骤"><a class="markdownIt-Anchor" href="#最终步骤"></a> 最终步骤</h1>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export ftp_proxy=http://127.0.0.1:8889/</span><br><span class="line">export https_proxy=http://127.0.0.1:8889/</span><br><span class="line">export FTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTPS_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export HTTP_PROXY=http://127.0.0.1:8889/</span><br><span class="line">export http_proxy=http://127.0.0.1:8889/</span><br><span class="line"></span><br><span class="line">git clone https://github.com/Joshua-Riek/ubuntu-rockchip.git</span><br><span class="line">git clone --single-branch --progress -b v2017.09-rk3588 https://github.com/orangepi-xunlong/u-boot-orangepi.git u-boot-orangepi-rk3588</span><br><span class="line">git -C u-boot-orangepi-rk3588 checkout 7f7ff61a8b79fdb4f2d51dfb8aa643b8bc3ada0c</span><br><span class="line">cp -r ubuntu-rockchip/packages/u-boot-orangepi-rk3588/debian u-boot-orangepi-rk3588</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修改uboot波特率为115200</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>  make CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm  -j32  orangepi_5_defconfig
  make CROSS_COMPILE=aarch64-linux-gnu- -j32 
  make CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm  -j32 \
  BL31=../rkbin/bin/rk35/rk3588_bl31_v1.45.elf \
  spl/u-boot-spl.bin u-boot.dtb u-boot.itb
</code></pre>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-01_生活/13_反思(5月第2个星期"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/05/06/01_%E7%94%9F%E6%B4%BB/13_%E5%8F%8D%E6%80%9D(5%E6%9C%88%E7%AC%AC2%E4%B8%AA%E6%98%9F%E6%9C%9F/"
    >反思(5月第2个星期</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/05/06/01_%E7%94%9F%E6%B4%BB/13_%E5%8F%8D%E6%80%9D(5%E6%9C%88%E7%AC%AC2%E4%B8%AA%E6%98%9F%E6%9C%9F/" class="article-date">
  <time datetime="2024-05-06T12:26:56.000Z" itemprop="datePublished">2024-05-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  Here's something encrypted, password is required to continue reading. 
      <a class="article-more-link" href="/2024/05/06/01_%E7%94%9F%E6%B4%BB/13_%E5%8F%8D%E6%80%9D(5%E6%9C%88%E7%AC%AC2%E4%B8%AA%E6%98%9F%E6%9C%9F/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-05_C语言高级学习/05_计算机系统架构与ARM汇编语言"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/04/23/05_C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0/05_%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E4%B8%8EARM%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"
    >程序的编译、链接和运行</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/04/23/05_C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0/05_%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E4%B8%8EARM%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" class="article-date">
  <time datetime="2024-04-22T22:26:56.000Z" itemprop="datePublished">2024-04-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0/">C语言高级学习</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>​	以后就在每次学习前写一个当时想的心路历程吧，这样也能知道自己在做这件事情的时候，当时都在想什么，日后自己再一次想起时候，找到当时自己的所思所想，我想的是我的C语言还很差劲，我认为在学习系统编程之前，需要一个这样的知识来帮我扫清前方的障碍，而且我认为之前的学习真的太差了，并没有真正的将这些东西转换为自己的东西，而且现在心中的方向一直不是很明确，我也希望出现一个东西，让我找一下心中的那个目标，让我知道我这样做是不是对的，为了寻求一个答案，你又能否一往无前呢。</p>
<hr />
<h1 id="编译过程从源文件到汇编文件"><a class="markdownIt-Anchor" href="#编译过程从源文件到汇编文件"></a> 编译过程：从源文件到汇编文件</h1>
<p>​	    汇编的过程都做了什么呢？（从高级语言到低级语言的转变），先说一下原因呢？不论是何种高级语言编写的程序，都要经过预处理和汇编这一步，预处理这个步骤要做的不再解释，汇编就是从C程序转换为同样功能的汇编语言，不论是什么类型的芯片，使用什么语言来完成这一功能，他们最终的汇编语言必然都是差不多的，如果每一种语言都写一个编译器，那工作量可真的太大了，所以每个语言的汇编器不一样，这是肯定的，但他们全部必然有一个相同的编译器。</p>
<p>​	上面也说了，汇编实际上就是将高级语言转变为低级的汇编语言，再具体可以细分为</p>
<ul>
<li>程序语句、函数转变为代码段</li>
<li>变量、常量转变为数据段、BSS段、rodata段</li>
<li>各种辅助信息也就是符号表和重定位表</li>
</ul>
<p>​	上面有一个地方认识错了，从C源文件编译为可执行文件的具体步骤是，预处理、编译、汇编、链接。</p>
<p>main.c             main.i         main.s         main.o          a.out</p>
<p>​			预处理                编译             汇编              链接</p>
<p>我们先来分析编译这一步骤，又可以分为下面这一些零零散散的步骤：</p>
<p>​	词法分析、语法分析、语义分析、中间代码生成、汇编代码生成、目标代码生成</p>
<p>​	想去了解一下编译器，目前我的疑惑是同一架构的编译器，到底能不能通用。</p>
<p>==编译器==</p>
<blockquote>
<p>​	分解成一个又一个的token，是不可再分的最小单元，它可能是关键字、可能是符号、可能是字符串，标识符和标点符号。</p>
</blockquote>
<p>​	既然编译器是将高级语言编译成可执行程序的一种工具，可是编译器也是一种可执行程序呀，编译器是怎样编译出来的。</p>
<p>​	最初的编译器通常是手工编写的，使用底层语言（如汇编语言）或其他更低级别的语言来实现。这些早期的编译器可能只支持语言的子集，但足以进行自举过程。</p>
<p>​	当得到一个基本的编译器后，它可以用于编译更高级别的语言实现，例如用C语言编写的编译器。一旦拥有了使用高级语言编写的编译器，就可以更容易地进行编译器的改进和扩展。</p>
<blockquote>
<p>​	第二步骤为将最小的token整合成statement sequence，翻译一下就是语句序列</p>
<p>​	分解成的token是线性结构，而token整合而来的statement squence 是一个abstract sysntax tree抽象语法树，尽可能的使语法保持完整</p>
<p>​	每个语句的分类是不同的，就比如可以将变量分为varable-defintion，for循环有一个为for-statement while为while-statement，等等</p>
</blockquote>
<p>​</p>
<blockquote>
<p>在上一个步骤中已经将全部的token转换为了抽象语法树，这时候其实已经可以执行了，但并不是能让人很好的理解，更好的办法其实还是将其转换回线性结构，</p>
</blockquote>
<p>​	==发现并没有什么实际的效果，所以就到这里吧，然后回到老师的课堂上==</p>
<hr />
<h2 id="词法分析"><a class="markdownIt-Anchor" href="#词法分析"></a> 词法分析</h2>
<p>​	从左到右。一个字符一个字符的读入源程序</p>
<p>​	对源程序的字符流进行扫描，分解成一系列的记号 token(关键字、标识符、字面量、特殊字符、分界符等等)，判断是不是又错误的词法，就比如中文字符，圆角半角字符等等。</p>
<h2 id="语法分析"><a class="markdownIt-Anchor" href="#语法分析"></a> 语法分析</h2>
<p>​	将前一阶段产生的token序列进行语法分析，看是否构成一个语法上正确的程序，分解成语短语，用语法树来表示，语法树不再是一个线性结构，而是树状结构，syntax  句法</p>
<h2 id="语义分析"><a class="markdownIt-Anchor" href="#语义分析"></a> 语义分析</h2>
<p>​	检查语法分析输出的语句、程序、表达式有没有错误，语义分为动态语义和静态语义，例如不允许使用一个没有声明的变量，在运行期间检测出除数为零。<strong>其实我们大部分错误都是发生在这个地方。</strong></p>
<h2 id="生成中间代码"><a class="markdownIt-Anchor" href="#生成中间代码"></a> 生成中间代码</h2>
<p>​		将语法树转换成为中间代码，中间代码是内部表现形式，他非常接近目标代码，类似于伪代码形式，容易生成，容易将其翻译为目标代码。</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202404232153033.png" alt="image-20240423215342912" /></p>
<p>​	我上面又分析错了，原来他们的中间代码是相同的，哦不对，我上面分析的是对的，我刚刚又理解错了，不同语言的相同功能，他们最终生成的汇编是相同的。</p>
<h2 id="生成汇编文件"><a class="markdownIt-Anchor" href="#生成汇编文件"></a> 生成汇编文件</h2>
<p>​	将中间代码翻译为汇编文件</p>
<h1 id="汇编过程"><a class="markdownIt-Anchor" href="#汇编过程"></a> 汇编过程</h1>
<p>​		在上一个步骤中已经将经过预处理的原始代码，编译为了.S汇编文件，而汇编文件又会经过汇编器生成.o目标文件。</p>
<p>​	汇编器动作的基本流程如下所示：</p>
<ol>
<li>词法分析</li>
<li>语法分析</li>
<li>代码生成</li>
<li>赋值信息</li>
</ol>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202404241937033.png" alt="image-20240424193720958" /></p>
<p>​	他的主要目录就是进行指令翻译，将汇编源文件，翻译为二进制指令，然后呢就是生成各种表的信息，就包括符号表和重定位表。</p>
<p>​	  <strong>指令生成</strong></p>
<p>​	我们编写的程序一般包括变量、函数、关键字等等，他们都会被放到不同的section段中，就包括代码段数据段、只读代码段、bss段，初始化的全局变量、静态变量放到数据段，未初始化的全局变量和静态变量放到bss段，而一些函数调用放到代码段，一些字符串放到只读数据段里面。</p>
<p>​	<strong>符号表</strong></p>
<p>​	readelf -s ~~~.o</p>
<p>​	读取一个.o文件的符号表，符号表中的信息就是汇编语言中各个section，以及偏移地址</p>
<p>​	<strong>重定位表</strong></p>
<p>​	当然只有符号表肯定是不行的，他们最终肯定会经过链接从而生成可执行文件，符号表只是将汇编程序中的一些符号进行了收集，那他们呢，要重定位到哪一个地址呢？</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202404242006656.png" alt="image-20240424200629507" /></p>
<p>​	总算是比较清楚了，也终于是知道了symtab是啥了。sym就是symbol tab 就是表，symtab就是符号表，而rel text就是重定位信息，可以通过readelf -r 来查看，而大S readelf -S可以查看各个段的信息，</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202404242010626.png" alt="image-20240424201000384" /></p>
<h1 id="符号表"><a class="markdownIt-Anchor" href="#符号表"></a> 符号表</h1>
<p>​	符号表：编译过程中用来来保存源程序中各种符号的信息，主要包括符号的地址值、类型、占用空间的大小。</p>
<p><strong>ELF文件和BIN文件</strong></p>
<p>​	文件结构：<br />
​		BIN文件即raw binary文件</p>
<p>​			只包含机器码，纯粹的程序文件，即镜像文件</p>
<p>​			类似的还有HEX文件</p>
<p>​	ELF文件除了机器码之外还有一些额外的信息</p>
<p>​			段的加载地址、运行地址</p>
<p>​			符号表、重定位表等等</p>
<h1 id="链接过程地址空间分配与链接脚本"><a class="markdownIt-Anchor" href="#链接过程地址空间分配与链接脚本"></a> 链接过程：地址空间分配与链接脚本</h1>
<p>​	目的：将所有的可重定位目标文件合并组装成可执行目标文件</p>
<p>​	主要步骤：地址空间分配，强符号和弱符号、重定位</p>
<p><strong>地址空间的分配</strong></p>
<p>​	扫描所有的目标文件，从各个文件段表中获取各个文件代码段、数据段信息：大小、地址等</p>
<p>​	从指定的链接地址开始，按照代码段、数据段、BSS段顺序将各个目标文件的同类型段合并，然后重新计算各个段的长度和位置</p>
<h1 id="链接过程符号解析-强符号和弱符号"><a class="markdownIt-Anchor" href="#链接过程符号解析-强符号和弱符号"></a> 链接过程：符号解析  强符号和弱符号</h1>
<p>​		在地址空间分配的过程中，会创建全局符号表，收集目标文件中符号表中的符号，统一放到全局符号表之中，但是可能遇到不同模块中遇到相同符号的情况，那这种情况要怎样解决呢？这时候就有了强符号和弱符号的概念了</p>
<p>​	强符号：函数名  初始化的全局变量</p>
<p>​	弱符号：未初始化的全局变量</p>
<p>==强符号不允许多次定义，但是弱符号可以共存，强弱符号共存的情况，强符号会覆盖弱符号==</p>
<h1 id="链接过程重定位"><a class="markdownIt-Anchor" href="#链接过程重定位"></a> 链接过程：重定位</h1>
<pre><code>本质就是修正指令中的符号地址
</code></pre>
<p>​	是连接过程中最核心最重要的一步</p>
<p>​	地址空间分配、符号解析都是为重定位服务的</p>
<p><strong>修改符号地址</strong></p>
<p>​	读取各个目标文件中，各个段的重定位信息：重定位表</p>
<p>​	进行符号重定位、修改指令中的符号地址</p>
<p>​	确定各个重定位符号的新地址、形成新的符号表</p>
<p><strong>地址修正</strong></p>
<p>​	重定位地址=新段基址 + 段内偏移</p>
<h1 id="程序的运行"><a class="markdownIt-Anchor" href="#程序的运行"></a> 程序的运行</h1>
<p>​	<strong>加载器</strong></p>
<p>​		在操作系统环境下执行一个可执行文件，加载器会首先将可执行文件加载到内存中，加载器拷贝数据完毕之后，进行相关操作，然后会跳转到程序入口</p>
<p>​	<strong>镜像加载地址</strong></p>
<p>​		程序头表：</p>
<p>​			指定了可执行文件镜像加载到内存中的地址</p>
<p>​			链接地址等于加载到内存中的地址</p>
<p>​		ELF文件头基本信息</p>
<p>​			文件类型 运行平台  程序入口地址</p>
<p>Linux内存映像</p>
<p>​	在Linux环境下，通过调用execve函数来启动加载器，可执行文件的运行通过进程的形式实现，当运行一个可执行文件时，主要工作有三步，创建一个独立的虚拟地址空间，读取可执行文件头，建立虚拟地址空间和可执行文件的映射关系，将PC指针设置为可执行文件的入口地址，启动运行</p>
<h1 id="bss段的处理"><a class="markdownIt-Anchor" href="#bss段的处理"></a> BSS段的处理</h1>
<p>​	特点：<br />
​	未初始化的全局变量、static局部变量放到BSS段</p>
<p>​	BSS段不占目标文件的空间</p>
<p>​	可执行文件运行时，在内存中给BSS段分配空间</p>
<p>​	设置BSS段的目的：早期计算机存储资源贵，节省磁盘空间</p>
<h1 id="main函数入口"><a class="markdownIt-Anchor" href="#main函数入口"></a> main函数入口</h1>
<p>​	没啥用</p>
<h1 id="链接静态库"><a class="markdownIt-Anchor" href="#链接静态库"></a> 链接静态库</h1>
<p>​	归档文件</p>
<p>​		目标归档文件</p>
<p>​	制作静态库</p>
<p>​	ar rcs libtest.a x.o xx.o</p>
<p>​	链接静态库</p>
<p>​	gcc main.c -l ./include -L ./lib -ltest</p>
<p>链接静态库带来的问题：<br />
一般定义的函数都会引用到，所以链接的时候会全部组装在一起，就比如C静态库，我们使用了printf，将所有的模块全部连接上了，这就导致可执行文件的体积大大增加。</p>
<h1 id="动态链接"><a class="markdownIt-Anchor" href="#动态链接"></a> 动态链接</h1>
<p>​</p>
<p>静态链接的缺点：</p>
<p>​	生成的可执行文件体积较大，包含相同的公共代码，浪费存储空间、运行时占用的内存较大</p>
<p>​	程序运行时需要一次性加载到内存之中</p>
<p>​	对于内存配置较小的系统可能装载不下，无法运行</p>
<p>动态链接：</p>
<p>​	静态链接发生在链接的过程中，动态链接推迟到运行时再进行</p>
<p>​	动态链接的目标文件也称为动态链接库，运行时除了可执行文件，这些库也要被加载到内存，进行重定位</p>
<p>好处</p>
<p>​	解决了空间浪费问题，节省内存</p>
<p>​	可以运行更大的程序</p>
<p>​	升级更加容易方便</p>
<p>ldd 命令可以查看用到的共享库</p>
<p>​	<strong>与地址无关的代码</strong></p>
<p>​		放到哪里，都可以执行，无需重定位，无需改变</p>
<p>​	<strong>实现思想</strong></p>
<p>​		将指令中需要修改的部分分离出来，跟数据放在一起</p>
<p>​		剩余指令就能做到与地址无关，被多个进程共享</p>
<p>​		数据和需要被修改的指令在每个进程中都有一个副本，互不影响</p>
<p>​	gcc -fPIC -c main.c</p>
<h1 id="共享库"><a class="markdownIt-Anchor" href="#共享库"></a> 共享库</h1>
<p>​	三个主要路径：<br />
​		/lib   存放最关键和最基础的共享库，例如动态链接器、C库、数学库，这些库主要是/bin/sbin下程序运行以及系统启动所需要的库</p>
<p>​		/usr/lib  非系统运行所需要的关键性的共享库，比如开发时用到的一些共享库</p>
<p>​		/usr/local/lib 存放第三方应用程序所需要的一些共享库</p>
<p>​	基本过程</p>
<p>​		ELF文件执行，动态链接器/bin/ld-linux-so.xvei加载成功，到.dynamic段里面找ELF文件依赖的共享库</p>
<p>​		若该路径是绝对路径就到绝对路径下面寻找</p>
<p>​		若该路径是相对路径，就到/lib /usr/lib  /etc/ld.so.conf 配置文件指定的目录中查找共享库</p>
<p>​	库目录缓存</p>
<p>​		/etc/ld.so.conf存放共享库的路径，为了避免每次查找，耗费时间，可以使用ldconfig生成一个缓存/etc/ld.so.cache</p>
<p>​		新增、删除、或者更新共享库路径的时候，需要使用ldconfig更新缓存</p>
<p>​	环境变量	LD_LIBRARY_PATH</p>
<p>​		由若干个路径组成的环境变量，每个路径用冒号查找</p>
<p>​		可以使用该变量临时更改程序依赖的共享库查找路径，而不影响系统中其他程序的运行。</p>
<h1 id="插件"><a class="markdownIt-Anchor" href="#插件"></a> 插件</h1>
<p>​	<strong>什么是插件</strong></p>
<p>​		为了使软件方便扩展，具备通用性，可以采用插件机制</p>
<p>​		主程序逻辑框架不变，各个业务以动态链接库的形式加载进来</p>
<p>​		软件发布后，不用重新编译，通过插件形式更新功能、软件增值</p>
<p>​		插件的本质是共享库，只不过组装形式复杂</p>
<p>==目前用不到==</p>
<h1 id="内核模块加载机制"><a class="markdownIt-Anchor" href="#内核模块加载机制"></a> 内核模块加载机制</h1>
<p>​	内核模块不依赖于C库，所以链接重定位过程要自己完成，运行在内核空间</p>
<h1 id="linux内核加载实验"><a class="markdownIt-Anchor" href="#linux内核加载实验"></a> Linux内核加载实验</h1>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> chai
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="热爱学习的未来酱"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%94%9F%E6%B4%BB">生活</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE">瑞芯微</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/Linux%E5%AD%A6%E4%B9%A0">Linux学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E8%AF%BB%E4%B9%A6">读书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0">驱动学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0">C语言高级学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7">小技巧</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/shell%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0">shell编程学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/PCB%E5%AD%A6%E4%B9%A0">PCB学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0">音视频学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=22707008&auto=0&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>