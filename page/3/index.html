<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="永远年轻，永远热泪盈眶" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 热爱学习的未来酱</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="热爱学习的未来酱" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/1.png" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">热爱学习的未来酱</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['我希望用一生的时间不断学习和深入电子计算机相关的一切知识，并将其整理成网络，分享出来，与更多志同道合的朋友一起进步', '无论你最终要成为一个怎样的人，千万要记住，时间在飞逝。', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="post-07_小技巧/9_性能测试"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/15/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/9_%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"
    >性能测试</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/15/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/9_%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2024-08-14T22:50:19.000Z" itemprop="datePublished">2024-08-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7/">小技巧</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1综合性能测试unixbench"><a class="markdownIt-Anchor" href="#1综合性能测试unixbench"></a> 1综合性能测试(unixbench)</h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045325.png" alt="image-20240524145726916" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045331.png" alt="image-20240524145738191" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./Run</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------                                                                                                                                                      </span><br><span class="line">Benchmark Run: 六 5月 25 2024 09:26:51 - 09:54:51                                                                                                                                                                             </span><br><span class="line">8 CPUs in system; running 1 parallel copy of tests                                                                                                                                                                            </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">Dhrystone 2 using register variables       31539593.3 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Double-Precision Whetstone                     6482.1 MWIPS (9.9 s, 7 samples)                                                                                                                                                </span><br><span class="line">Execl Throughput                               5137.7 lps   (29.9 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks        734469.9 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 256 bufsize 500 maxblocks          265982.6 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks       2000659.6 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Pipe Throughput                             1664325.7 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Pipe-based Context Switching                 211808.0 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Process Creation                               4083.5 lps   (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (1 concurrent)                   3877.1 lpm   (60.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (8 concurrent)                   3437.1 lpm   (60.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">System Call Overhead                        1331518.3 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">System Benchmarks Index Values               BASELINE       RESULT    INDEX                                                                                                                                                   </span><br><span class="line">Dhrystone 2 using register variables         116700.0   31539593.3   2702.6                                                                                                                                                   </span><br><span class="line">Double-Precision Whetstone                       55.0       6482.1   1178.6                                                                                                                                                   </span><br><span class="line">Execl Throughput                                 43.0       5137.7   1194.8                                                                                                                                                   </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks          3960.0     734469.9   1854.7                                                                                                                                                   </span><br><span class="line">File Copy 256 bufsize 500 maxblocks            1655.0     265982.6   1607.1                                                                                                                                                   </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks          5800.0    2000659.6   3449.4                                                                                                                                                   </span><br><span class="line">Pipe Throughput                               12440.0    1664325.7   1337.9                                                                                                                                                   </span><br><span class="line">Pipe-based Context Switching                   4000.0     211808.0    529.5                                                                                                                                                   </span><br><span class="line">Process Creation                                126.0       4083.5    324.1                                                                                                                                                   </span><br><span class="line">Shell Scripts (1 concurrent)                     42.4       3877.1    914.4                                                                                                                                                   </span><br><span class="line">Shell Scripts (8 concurrent)                      6.0       3437.1   5728.5                                                                                                                                                   </span><br><span class="line">System Call Overhead                          15000.0    1331518.3    887.7                                                                                                                                                   </span><br><span class="line">                                                                   ========                                                                                                                                                   </span><br><span class="line">System Benchmarks Index Score                                        1364.8                                                                                                                                                   </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">------------------------------------------------------------------------                                                                                                                                                      </span><br><span class="line">Benchmark Run: 六 5月 25 2024 09:54:51 - 10:23:04                                                                                                                                                                             </span><br><span class="line">8 CPUs in system; running 8 parallel copies of tests                                                                                                                                                                          </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">Dhrystone 2 using register variables      157812940.0 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Double-Precision Whetstone                    37250.0 MWIPS (9.6 s, 7 samples)                                                                                                                                                </span><br><span class="line">Execl Throughput                              17709.4 lps   (29.8 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks       2846650.5 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 256 bufsize 500 maxblocks          902894.4 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks       5776203.7 KBps  (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Pipe Throughput                             8112803.3 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Pipe-based Context Switching                1139800.0 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">Process Creation                              32554.8 lps   (30.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (1 concurrent)                  29022.0 lpm   (60.0 s, 2 samples)                                                                                                                                               </span><br><span class="line">Shell Scripts (8 concurrent)                   4265.4 lpm   (60.1 s, 2 samples)                                                                                                                                               </span><br><span class="line">System Call Overhead                        8171571.9 lps   (10.0 s, 7 samples)                                                                                                                                               </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">System Benchmarks Index Values               BASELINE       RESULT    INDEX                                                                                                                                                   </span><br><span class="line">Dhrystone 2 using register variables         116700.0  157812940.0  13523.0                                                                                                                                                   </span><br><span class="line">Double-Precision Whetstone                       55.0      37250.0   6772.7                                                                                                                                                   </span><br><span class="line">Execl Throughput                                 43.0      17709.4   4118.5                                                                                                                                                   </span><br><span class="line">File Copy 1024 bufsize 2000 maxblocks          3960.0    2846650.5   7188.5                                                                                                                                                   </span><br><span class="line">File Copy 256 bufsize 500 maxblocks            1655.0     902894.4   5455.6                                                                                                                                                   </span><br><span class="line">File Copy 4096 bufsize 8000 maxblocks          5800.0    5776203.7   9959.0                                                                                                                                                   </span><br><span class="line">Pipe Throughput                               12440.0    8112803.3   6521.5                                                                                                                                                   </span><br><span class="line">Pipe-based Context Switching                   4000.0    1139800.0   2849.5                                                                                                                                                   </span><br><span class="line">Process Creation                                126.0      32554.8   2583.7                                                                                                                                                   </span><br><span class="line">Shell Scripts (1 concurrent)                     42.4      29022.0   6844.8                                                                                                                                                   </span><br><span class="line">Shell Scripts (8 concurrent)                      6.0       4265.4   7109.1                                                                                                                                                   </span><br><span class="line">System Call Overhead                          15000.0    8171571.9   5447.7                                                                                                                                                   </span><br><span class="line">                                                                   ========                                                                                                                                                   </span><br><span class="line">System Benchmarks Index Score                                        5925.9                                                                                                                                                   </span><br><span class="line">                                                                                                                                                                                                                              </span><br><span class="line">root@topeet:/test/01_unixbench/byte-unixbench-master/UnixBench$   </span><br></pre></td></tr></table></figure>
<h2 id="2cpu性能speccpu2006"><a class="markdownIt-Anchor" href="#2cpu性能speccpu2006"></a> 2.CPU性能(speccpu2006)</h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045327.png" alt="image-20240524150847095" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045355.png" alt="image-20240524151335344" /></p>
<p>安装编译工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install build-essential gfortran</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045346.png" alt="image-20240524151435285" /></p>
<p>问题解决：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim src/make-3.80/glob/glob.c </span><br></pre></td></tr></table></figure>
<p>注释209 232行</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045341.png" alt="image-20240524152454164" /></p>
<p>然后运行根目录下的安装脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045640.png" alt="image-20240524165154844" /></p>
<p>安装完成之后加载环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./shrc</span><br></pre></td></tr></table></figure>
<p>然后输入以下命令确定是否安装成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runspec -V</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045771.png" alt="image-20240524165323929" /></p>
<p>测试命令和说明：</p>
<ol>
<li>
<p><code>runspec --reportable -c arm64.cfg -n 1 -r 1 --tune=base all</code></p>
<ul>
<li><code>--reportable</code>: 表示可以展示为 SPEC 官方可报告的测试结果</li>
<li><code>-c rk3588.cfg</code>: 指定使用 <code>rk3588.cfg</code> 这个配置文件</li>
<li><code>-n 1</code>: 测试次数为 1 次</li>
<li><code>-r 1</code>: 运行 1 线程(默认 1 线程,speed 模式)</li>
<li><code>--tune=base</code>: 使用 base 基准测试模式</li>
<li><code>all</code>: 表示测试所有的整数和浮点测试项</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">                                  Estimated                       Estimated                                  </span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak                                     </span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate                                     </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------                                  </span><br><span class="line">400.perlbench       1        420       23.3 *                                                                </span><br><span class="line">401.bzip2           1        588       16.4 *                                                                </span><br><span class="line">403.gcc             1        404       19.9 *                                                                </span><br><span class="line">429.mcf             1        475       19.2 *                                                                </span><br><span class="line">445.gobmk           1        474       22.1 *                                                                </span><br><span class="line">456.hmmer           1        253       36.9 *                                                                </span><br><span class="line">458.sjeng           1        628       19.3 *                                                                </span><br><span class="line">462.libquantum      1        207      100   *                                                                </span><br><span class="line">464.h264ref         1        533       41.5 *                                                                </span><br><span class="line">471.omnetpp         1        561       11.1 *                                                                </span><br><span class="line">473.astar           1        479       14.6 *                                                                </span><br><span class="line">483.xalancbmk       1        417       16.5 *                                                                </span><br><span class="line"> Est. SPECint_rate_base2006            23.3                                                                  </span><br><span class="line"> Est. SPECint_rate2006                                              Not Run                                  </span><br><span class="line">                                                                                                             </span><br><span class="line">      set: fp                                                                                                </span><br><span class="line">        format: raw -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.rsf                           </span><br><span class="line">        format: flags -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.flags.html                  </span><br><span class="line">        format: ASCII -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.txt                         </span><br><span class="line">        format: PDF -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.002.pdf                           </span><br><span class="line">        format: Submission Check -&gt; PASSED syntax check                                                      </span><br><span class="line">        format: Screen -&gt;                                                                                    </span><br><span class="line">                                                                                                             </span><br><span class="line">                                  Estimated                       Estimated                                  </span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak                                     </span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate                                     </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------                                  </span><br><span class="line">410.bwaves          1        320       42.4 *                                                                </span><br><span class="line">416.gamess          1        674       29.1 *                                                                </span><br><span class="line">433.milc            1        327       28.1 *                                                                </span><br><span class="line">434.zeusmp          1        459       19.8 *                                                                </span><br><span class="line">435.gromacs         1        308       23.2 *                                                                </span><br><span class="line">436.cactusADM       1        812       14.7 *                                                                </span><br><span class="line">437.leslie3d        1        306       30.8 *                                                                </span><br><span class="line">444.namd            1        387       20.7 *                                                                </span><br><span class="line">447.dealII          1        270       42.4 *                                                                </span><br><span class="line">450.soplex          1        308       27.1 *                                                                </span><br><span class="line">453.povray          1        131       40.6 *                                                                </span><br><span class="line">454.calculix        1        317       26.0 *                                                                </span><br><span class="line">459.GemsFDTD        1        388       27.3 *                                                                </span><br><span class="line">465.tonto           1        304       32.4 *                                                                </span><br><span class="line">470.lbm             1        350       39.2 *                                                                </span><br><span class="line">481.wrf             1        287       38.9 *                                                                </span><br><span class="line">482.sphinx3         1        825       23.6 *                                                                </span><br><span class="line"> Est. SPECfp_rate_base2006             28.6                                                                  </span><br><span class="line"> Est. SPECfp_rate2006                                               Not Run       </span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>runspec --reportable -c arm64.cfg -n 1 -r N --tune=base all</code></p>
<ul>
<li><code>--reportable</code>: 表示可以展示为 SPEC 官方可报告的测试结果</li>
<li><code>-n 1</code>: 测试次数为 1 次</li>
<li><code>-r N</code>: 运行 N 线程(rate 模式,测试吞吐量)</li>
<li><code>--tune=base</code>: 使用 base 基准测试模式</li>
<li><code>all</code>: 表示测试所有的整数和浮点测试项</li>
</ul>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">                                  Estimated                       Estimated</span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak</span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------</span><br><span class="line">400.perlbench       1        417       23.4 *                                  </span><br><span class="line">401.bzip2           1        591       16.3 *                                  </span><br><span class="line">403.gcc             1        409       19.7 *                                  </span><br><span class="line">429.mcf             1        442       20.6 *                                  </span><br><span class="line">445.gobmk           1        474       22.1 *                                  </span><br><span class="line">456.hmmer           1        254       36.8 *                                  </span><br><span class="line">458.sjeng           1        629       19.2 *                                  </span><br><span class="line">462.libquantum      1        207       99.9 *                                  </span><br><span class="line">464.h264ref         1        534       41.4 *                                  </span><br><span class="line">471.omnetpp         1        569       11.0 *                                  </span><br><span class="line">473.astar           1        471       14.9 *                                  </span><br><span class="line">483.xalancbmk       1        408       16.9 *                                  </span><br><span class="line"> Est. SPECint_rate_base2006            23.5</span><br><span class="line"> Est. SPECint_rate2006                                              Not Run</span><br><span class="line"></span><br><span class="line">      set: fp</span><br><span class="line">        format: raw -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.rsf</span><br><span class="line">        format: flags -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.flags.html</span><br><span class="line">        format: ASCII -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.txt</span><br><span class="line">        format: PDF -&gt; /test/02_spec2006/speccpu2006-v1.0.1/result/CFP2006.003.pdf</span><br><span class="line">        format: Submission Check -&gt; PASSED syntax check</span><br><span class="line">        format: Screen -&gt; </span><br><span class="line"></span><br><span class="line">                                  Estimated                       Estimated</span><br><span class="line">                Base     Base       Base        Peak     Peak       Peak</span><br><span class="line">Benchmarks     Copies  Run Time     Rate       Copies  Run Time     Rate </span><br><span class="line">-------------- ------  ---------  ---------    ------  ---------  ---------</span><br><span class="line">410.bwaves          1        326       41.7 *                                  </span><br><span class="line">416.gamess          1        674       29.0 *                                  </span><br><span class="line">433.milc            1        331       27.7 *                                  </span><br><span class="line">434.zeusmp          1        450       20.2 *                                  </span><br><span class="line">435.gromacs         1        308       23.1 *                                  </span><br><span class="line">436.cactusADM       1        814       14.7 *                                  </span><br><span class="line">437.leslie3d        1        306       30.7 *                                  </span><br><span class="line">444.namd            1        387       20.7 *                                  </span><br><span class="line">447.dealII          1        268       42.7 *                                  </span><br><span class="line">450.soplex          1        322       25.9 *                                  </span><br><span class="line">453.povray          1        131       40.5 *                                  </span><br><span class="line">454.calculix        1        317       26.0 *                                  </span><br><span class="line">459.GemsFDTD        1        390       27.2 *                                  </span><br><span class="line">465.tonto           1        304       32.3 *                                  </span><br><span class="line">470.lbm             1        351       39.2 *                                  </span><br><span class="line">481.wrf             1        287       39.0 *                                  </span><br><span class="line">482.sphinx3         1        813       24.0 *                                  </span><br><span class="line"> Est. SPECfp_rate_base2006             28.5</span><br><span class="line"> Est. SPECfp_rate2006                                               Not Run</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Benchmarks</td>
<td style="text-align:left">Estimated Base</td>
<td style="text-align:left">Estimated Base</td>
<td style="text-align:left">Estimated Base</td>
<td style="text-align:left">Estimated Peak</td>
<td style="text-align:left">Estimated Peak</td>
<td style="text-align:left">Estimated Peak</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Copies</td>
<td style="text-align:left">Run Time</td>
<td style="text-align:left">Rate</td>
<td style="text-align:left">Copies</td>
<td style="text-align:left">Run Time</td>
<td style="text-align:left">Rate</td>
</tr>
<tr>
<td style="text-align:left">400.perlbench</td>
<td style="text-align:left">1</td>
<td style="text-align:left">420</td>
<td style="text-align:left">23.3 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">401.bzip2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">588</td>
<td style="text-align:left">16.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">403.gcc</td>
<td style="text-align:left">1</td>
<td style="text-align:left">404</td>
<td style="text-align:left">19.9 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">429.mcf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">475</td>
<td style="text-align:left">19.2 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">445.gobmk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">474</td>
<td style="text-align:left">22.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">456.hmmer</td>
<td style="text-align:left">1</td>
<td style="text-align:left">253</td>
<td style="text-align:left">36.9 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">458.sjeng</td>
<td style="text-align:left">1</td>
<td style="text-align:left">628</td>
<td style="text-align:left">19.3 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">462.libquantum</td>
<td style="text-align:left">1</td>
<td style="text-align:left">207</td>
<td style="text-align:left">100 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">464.h264ref</td>
<td style="text-align:left">1</td>
<td style="text-align:left">533</td>
<td style="text-align:left">41.5 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">471.omnetpp</td>
<td style="text-align:left">1</td>
<td style="text-align:left">561</td>
<td style="text-align:left">11.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">473.astar</td>
<td style="text-align:left">1</td>
<td style="text-align:left">479</td>
<td style="text-align:left">14.6 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">483.xalancbmk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">417</td>
<td style="text-align:left">16.5 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECint_rate_base2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">23.3</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECint_rate2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">Not Run</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">410.bwaves</td>
<td style="text-align:left">1</td>
<td style="text-align:left">320</td>
<td style="text-align:left">42.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">416.gamess</td>
<td style="text-align:left">1</td>
<td style="text-align:left">674</td>
<td style="text-align:left">29.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">433.milc</td>
<td style="text-align:left">1</td>
<td style="text-align:left">327</td>
<td style="text-align:left">28.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">434.zeusmp</td>
<td style="text-align:left">1</td>
<td style="text-align:left">459</td>
<td style="text-align:left">19.8 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">435.gromacs</td>
<td style="text-align:left">1</td>
<td style="text-align:left">308</td>
<td style="text-align:left">23.2 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">436.cactusADM</td>
<td style="text-align:left">1</td>
<td style="text-align:left">812</td>
<td style="text-align:left">14.7 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">437.leslie3d</td>
<td style="text-align:left">1</td>
<td style="text-align:left">306</td>
<td style="text-align:left">30.8 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">444.namd</td>
<td style="text-align:left">1</td>
<td style="text-align:left">387</td>
<td style="text-align:left">20.7 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">447.dealII</td>
<td style="text-align:left">1</td>
<td style="text-align:left">270</td>
<td style="text-align:left">42.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">450.soplex</td>
<td style="text-align:left">1</td>
<td style="text-align:left">308</td>
<td style="text-align:left">27.1 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">453.povray</td>
<td style="text-align:left">1</td>
<td style="text-align:left">131</td>
<td style="text-align:left">40.6 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">454.calculix</td>
<td style="text-align:left">1</td>
<td style="text-align:left">317</td>
<td style="text-align:left">26.0 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">459.GemsFDTD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">388</td>
<td style="text-align:left">27.3 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">465.tonto</td>
<td style="text-align:left">1</td>
<td style="text-align:left">304</td>
<td style="text-align:left">32.4 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">470.lbm</td>
<td style="text-align:left">1</td>
<td style="text-align:left">350</td>
<td style="text-align:left">39.2 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">481.wrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">287</td>
<td style="text-align:left">38.9 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">482.sphinx3</td>
<td style="text-align:left">1</td>
<td style="text-align:left">825</td>
<td style="text-align:left">23.6 *</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECfp_rate_base2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">28.6</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Est. SPECfp_rate2006</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">Not Run</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="3系统综合性能lmbench"><a class="markdownIt-Anchor" href="#3系统综合性能lmbench"></a> <strong>3.系统综合性能(Lmbench)</strong></h2>
<h3 id="一-引言"><a class="markdownIt-Anchor" href="#一-引言"></a> 一、引言</h3>
<p>Lmbench 是一套简易可移植的，符合ANSI/C 标准为UNIX/POSIX 而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。Lmbench 旨在使系统开发者深入了解关键操作的基础成本。（百度Lmbench了解详情）</p>
<h3 id="二-软件说明和下载"><a class="markdownIt-Anchor" href="#二-软件说明和下载"></a> 二、软件说明和下载</h3>
<p>软件说明：</p>
<p>lmbench是个用于评价系统综合性能的多平台开源benchmark，能够测试包括文档读写、内存操作、进程创建销毁开销、网络等性能，测试 方法简单。<br />
Lmbench是个多平台软件，因此能够对同级别的系统进行比较测试，反映不同系统的优劣势，通过选择不同的库函数我们就能够比较库函数的性能；更为重要的是，作为一个开源软件， lmbench提供一个测试框架，假如测试者对测试项目有更高的测试需要，能够通过少量的修改源代码达到目的（比如现在只能评测进程创建、终止的性能和进程转换的开销，通过修改部分代码即可实现线程级别的性能测试）</p>
<p>下载：</p>
<p>方式一：百度网盘为本人的一个工具，带有编写好的脚本，可直接运行脚本进行测试。</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1GJ7iOSTYQa4THAjjiD4TXQ">https://pan.baidu.com/s/1GJ7iOSTYQa4THAjjiD4TXQ</a><br />
提取码：jayn</p>
<p>方式二：<a target="_blank" rel="noopener" href="http://www.bitmover.com/">www.bitmover.com/</a> lmbench  （进入该网站下载）</p>
<h3 id="三-测试步骤"><a class="markdownIt-Anchor" href="#三-测试步骤"></a> 三、测试步骤</h3>
<h4 id="31上传安装包到home路径解压文件并赋予权限"><a class="markdownIt-Anchor" href="#31上传安装包到home路径解压文件并赋予权限"></a> 3.1上传安装包到/home路径，解压文件并赋予权限</h4>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045728.png" alt="image-20240524143848374" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045712.png" alt="image-20240524143902227" /></p>
<p>​	然后赋予权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 *</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045798.png" alt="image-20240524143945906" /></p>
<h4 id="32-测试执行"><a class="markdownIt-Anchor" href="#32-测试执行"></a> 3.2、测试执行</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash lmbench-test.sh </span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045011.png" alt="image-20240524144003996" /></p>
<p>==要改一下存储容量大小，我改为了6000==</p>
<h3 id="4-查看结果"><a class="markdownIt-Anchor" href="#4-查看结果"></a> 4 查看结果</h3>
<p>执行 make see 查看运行结果，若只出现两行命令，显示运行结果输出到了 summary.out 文件中，则直接查看该文件即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ./results/summary.out</span><br></pre></td></tr></table></figure>
<p>将会看到如下输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">make[1]: Entering directory &#x27;/test/03_lmbench/lmbench-3.0-a9/results&#x27;</span><br><span class="line"></span><br><span class="line">                 L M B E N C H  3 . 0   S U M M A R Y</span><br><span class="line">                 ------------------------------------</span><br><span class="line">                 (Alpha software, do not distribute)</span><br><span class="line"></span><br><span class="line">Basic system parameters</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Host                 OS Description              Mhz  tlb  cache  mem   scal</span><br><span class="line">                                                     pages line   par   load</span><br><span class="line">                                                           bytes  </span><br><span class="line">--------- ------------- ----------------------- ---- ----- ----- ------ ----</span><br><span class="line">topeet    Linux 5.10.19       aarch64-linux-gnu 2279    48   128   22.3    1</span><br><span class="line">topeet    Linux 5.10.19       aarch64-linux-gnu 2279    48   128   22.4    1</span><br><span class="line"></span><br><span class="line">Processor, Processes - times in microseconds - smaller is better</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Host                 OS  Mhz null null      open slct sig  sig  fork exec sh  </span><br><span class="line">                             call  I/O stat clos TCP  inst hndl proc proc proc</span><br><span class="line">--------- ------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----</span><br><span class="line">topeet    Linux 5.10.19 2279 0.13 0.16 0.56 4.07 2.84 0.17 0.88 356. 870. 2189</span><br><span class="line">topeet    Linux 5.10.19 2279 0.13 0.16 0.57 1.63 2.81 0.17 0.89 347. 879. 2123</span><br><span class="line"></span><br><span class="line">Basic integer operations - times in nanoseconds - smaller is better</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Host                 OS  intgr intgr  intgr  intgr  intgr  </span><br><span class="line">                          bit   add    mul    div    mod   </span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19 0.3300 0.2200 0.8900 3.5100 3.6200</span><br><span class="line">topeet    Linux 5.10.19 0.3300 0.2200 0.8900 3.5100 3.6200</span><br><span class="line"></span><br><span class="line">Basic uint64 operations - times in nanoseconds - smaller is better</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">Host                 OS int64  int64  int64  int64  int64  </span><br><span class="line">                         bit    add    mul    div    mod   </span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19  0.330        1.7900 2.8500 4.5000</span><br><span class="line">topeet    Linux 5.10.19  0.330        1.7900 2.8500 4.5000</span><br><span class="line"></span><br><span class="line">Basic float operations - times in nanoseconds - smaller is better</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">Host                 OS  float  float  float  float</span><br><span class="line">                         add    mul    div    bogo</span><br><span class="line">--------- ------------- ------ ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 3.5100 1.2100</span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 3.5100 1.2100</span><br><span class="line"></span><br><span class="line">Basic double operations - times in nanoseconds - smaller is better</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">Host                 OS  double double double double</span><br><span class="line">                         add    mul    div    bogo</span><br><span class="line">--------- ------------- ------  ------ ------ ------ </span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 5.2600 2.4200</span><br><span class="line">topeet    Linux 5.10.19 0.8800 1.3200 5.2700 2.4200</span><br><span class="line"></span><br><span class="line">Context switching - times in microseconds - smaller is better</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">Host                 OS  2p/0K 2p/16K 2p/64K 8p/16K 8p/64K 16p/16K 16p/64K</span><br><span class="line">                         ctxsw  ctxsw  ctxsw ctxsw  ctxsw   ctxsw   ctxsw</span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------ ------- -------</span><br><span class="line">topeet    Linux 5.10.19 1.2600 1.2700 1.4100 8.9200 9.0500 7.48000    13.8</span><br><span class="line">topeet    Linux 5.10.19 1.2400 1.3000        5.2900 0.5600 6.36000 2.83000</span><br><span class="line"></span><br><span class="line">*Local* Communication latencies in microseconds - smaller is better</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">Host                 OS 2p/0K  Pipe AF     UDP  RPC/   TCP  RPC/ TCP</span><br><span class="line">                        ctxsw       UNIX         UDP         TCP conn</span><br><span class="line">--------- ------------- ----- ----- ---- ----- ----- ----- ----- ----</span><br><span class="line">topeet    Linux 5.10.19 1.260 4.775 25.0 8.477        10.7        99.</span><br><span class="line">topeet    Linux 5.10.19 1.240 4.753 5.26 8.399        10.6        79.</span><br><span class="line"></span><br><span class="line">*Remote* Communication latencies in microseconds - smaller is better</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">Host                 OS   UDP  RPC/  TCP   RPC/ TCP</span><br><span class="line">                               UDP         TCP  conn</span><br><span class="line">--------- ------------- ----- ----- ----- ----- ----</span><br><span class="line">topeet    Linux 5.10.19                             </span><br><span class="line">topeet    Linux 5.10.19                             </span><br><span class="line"></span><br><span class="line">File &amp; VM system latencies in microseconds - smaller is better</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Host                 OS   0K File      10K File     Mmap    Prot   Page   100fd</span><br><span class="line">                        Create Delete Create Delete Latency Fault  Fault  selct</span><br><span class="line">--------- ------------- ------ ------ ------ ------ ------- ----- ------- -----</span><br><span class="line">topeet    Linux 5.10.19 9.0826 5.9360   21.8   11.7  8992.0 0.162 0.10570 1.325</span><br><span class="line">topeet    Linux 5.10.19 9.3983 6.2696   21.8   11.2  8695.0 0.162 0.11910 1.300</span><br><span class="line"></span><br><span class="line">*Local* Communication bandwidths in MB/s - bigger is better</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">Host                OS  Pipe AF    TCP  File   Mmap  Bcopy  Bcopy  Mem   Mem</span><br><span class="line">                             UNIX      reread reread (libc) (hand) read write</span><br><span class="line">--------- ------------- ---- ---- ---- ------ ------ ------ ------ ---- -----</span><br><span class="line">topeet    Linux 5.10.19 2384 6458 2027 5744.7  17.4K  11.8K 8924.8 10.K 17.9K</span><br><span class="line">topeet    Linux 5.10.19 2448 6468 3177 5695.6  17.5K  12.0K 8938.3 10.K 17.8K</span><br><span class="line"></span><br><span class="line">Memory latencies in nanoseconds - smaller is better</span><br><span class="line">    (WARNING - may not be correct, check graphs)</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Host                 OS   Mhz   L1 $   L2 $    Main mem    Rand mem    Guesses</span><br><span class="line">--------- -------------   ---   ----   ----    --------    --------    -------</span><br><span class="line">topeet    Linux 5.10.19  2279 1.7630 2.6940    6.965000       441.6</span><br><span class="line">topeet    Linux 5.10.19  2279 1.7640 2.6870    6.889000       408.4</span><br><span class="line">make[1]: Leaving directory &#x27;/test/03_lmbench/lmbench-3.0-a9/results&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="41-系统基本信息"><a class="markdownIt-Anchor" href="#41-系统基本信息"></a> 4.1. 系统基本信息</h4>
<p>输出结果中开始显示系统的基本参数信息。</p>
<p>其中：</p>
<p>tlb: 表示转换后备缓存的页面数；</p>
<p>cache line bytes: 高速缓存行字节数</p>
<p>mem par: 存储器分层并行化；</p>
<p>scal load: 并行执行的 Lmbench 数目。</p>
<h4 id="42-处理器-processor-性能"><a class="markdownIt-Anchor" href="#42-处理器-processor-性能"></a> 4.2. 处理器 Processor 性能</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>null call: 执行 getppid 需要的时间；</p>
<p>null I/O: 从 /dev/zero 读取一个字节的时长 t1，写一个字节到 /dev/null 的时长 t2，t1、t2 取平均值即为该项结果；</p>
<p>stat: stat 一个文件（即得到一个文件的信息）所需时长；</p>
<p>open clos: open 一个文件接着再 close 掉该文件一共所用时间（不包含读目录和节点的时间）；</p>
<p>slct TCP: 通过 TCP 网络连接选择 100 个文件描述符所消耗的时间；</p>
<p>sig inst: install signal 所耗时长；</p>
<p>sig hndl: handler signal 所耗时长；</p>
<p>fork proc: fork 一个完全相同的 process，并把原来的 process 关掉一共所消耗的时间；</p>
<p>exec proc: 模拟一个 shell 进程的工作过程：fork 一个新进程执行新命令消耗的时间。</p>
<p>sh proc: fork 一个进程，同时询问系统 shell 来找到并运行一个新程序所用时间。</p>
<h4 id="43-数学运算"><a class="markdownIt-Anchor" href="#43-数学运算"></a> 4.3. 数学运算</h4>
<p>如下输出结果单位均为 ns，数值越小表示性能越好。</p>
<p>(1) 整型计算</p>
<p>(2) 无符号整型计算</p>
<p>(3) 浮点型计算</p>
<p>(4) 双精度浮点型计算</p>
<h4 id="44-上下文切换"><a class="markdownIt-Anchor" href="#44-上下文切换"></a> 4.4. 上下文切换</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>多个进程用 unix pipe 环连接起来，每个进程从自己的管道中读取 token，执行任务，然后将 token 写给下一个进程。</p>
<p>context swithing 时间包括：切换进程的时间，加上恢复进程所有状态所用的时间（包含恢复 cache 状态）。</p>
<p>2p/0k: 每个进程的 size 为 0（不执行任何任务），进程数为 2 时上下文切换所消耗的时间；</p>
<p>2p/16k: 每个进程 size 为 16K（执行任务），进程数为 2 时上下文切换所消耗的时间；</p>
<p>之后的测试项以此类推。</p>
<h4 id="45-本地通讯时延"><a class="markdownIt-Anchor" href="#45-本地通讯时延"></a> 4.5. 本地通讯时延</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>2p/0k: 每个进程的 size 为 0（不执行任何任务），进程数为 2 时上下文切换所消耗的时间；</p>
<p>Pipe: 即所谓的 hot potato 测试，两个没有具体任务的进程之间使用 pipe 通信，一个 token 在两个进程间来回传递，传递一个来回所消耗时长的平均值；</p>
<p>AF UNIX: 同 Pipe 测试项，但进程间通信使用的是 socket 通信；</p>
<p>UDP: 同 Pipe 测试项，但进程间通信使用的是 UDP/IP 通信；</p>
<p>RPC/UDP: 同 Pipe 测试项，但进程间通信使用的是 sun RPC 通信，默认情况下，RPC 采用 UDP 协议传输；</p>
<p>TCP: 同 Pipe 测试项，但进程间通信使用的是 TCP/IP 通信；</p>
<p>RPC/TCP: 同 Pipe 测试项，但进程间通信使用的是 sun RPC 通信，指定 RPC 采用 TCP 协议传输；</p>
<p>TCP conn: 创建 socket 描述符和建立连接所用时间。</p>
<h4 id="46-文件-内存延时"><a class="markdownIt-Anchor" href="#46-文件-内存延时"></a> 4.6. 文件、内存延时</h4>
<p>如下输出结果单位均为 us，数值越小表示性能越好。</p>
<p>0K File Create: 0K 文件创建所用时间；</p>
<p>0K File Delete: 0K 文件删除所用时间；</p>
<p>10K File Create: 10K 文件创建所用时间；</p>
<p>10K File Delete: 10K 文件删除所用时间；</p>
<p>Mmap Latency: 将指定文件的开头 n 个字节 mmap 到内存，然后 unmap，并记录每次 mmap 和 unmap 共消耗的时间，去每次消耗时间的最大值；</p>
<p>Port Fault: 保护页延时时间；</p>
<p>Page Faule: 缺页延时时间；</p>
<p>100fd selct: 对 100 个文件描述符配置 select 的时间。</p>
<h4 id="47-本地通信带宽"><a class="markdownIt-Anchor" href="#47-本地通信带宽"></a> 4.7. 本地通信带宽</h4>
<p>如下输出结果单位均为 MB/s，数值越大表示性能越好。</p>
<p>Pipe: 在两个进程建立 pipe，pipe 的每个 chunk 为 64K，通过该管道移动 50MB 数据所消耗的时间；</p>
<p>AF UNIX: 两个进程之间建立 unix stream socket 连接，每个 chunk 为 64K，通过该 socket 传输 10MB 数据所用的时间；</p>
<p>TCP: 同 Pipe 测试项，但进程间使用 TCP/IP socket 通信，传输数据量为 3MB；</p>
<p>File reread: 读文件并将其汇总一起所用的时间；</p>
<p>Mmap reread: 将文件 mmap 到内存中，从内存中读文件并将其汇总一起所用时间；</p>
<p>Bcopy(libc):dobw_mem i bcopy，从指定内存区域拷贝指定数量的字节内容到另一个指定内存区域的速度；</p>
<p>Bcopy(hand): do bw_mem %i fcp，把数据从磁盘的一个位置拷贝到另一个位置所用的时间；</p>
<p>Mem read: bw_mem i frd，累加数组中的整数值，测试把数据读入 processor 的带宽；</p>
<p>Mem write: do bw_mem fwr，把整数数组的每个成员设置为 1，测试写数据到内存的带宽。</p>
<h4 id="48-内存操作延时"><a class="markdownIt-Anchor" href="#48-内存操作延时"></a> 4.8. 内存操作延时</h4>
<p>如下输出结果单位均为 ns，数值越小表示性能越好。</p>
<p>本地测试执行 lat_mem_rd，将整数数组中每第 4 个元素的值累加起来；测试的是读数据到 processor 的带宽。</p>
<p>L1： 缓存1</p>
<p>L2： 缓存2</p>
<p>Main Mem： 连续内存</p>
<p>Rand Mem： 内存随机访问延时</p>
<p>Guesses:</p>
<p>假如 L1 和 L2 近似，会显示 “No L1 cache?”</p>
<p>假如 L2 和 Main Mem 近似，会显示 “No L2 cache?”</p>
<h2 id="4内存带宽性能stream"><a class="markdownIt-Anchor" href="#4内存带宽性能stream"></a> <strong>4.内存带宽性能(stream)</strong></h2>
<p>1.安装gfortran：</p>
<p>apt-get install gfortran</p>
<p>2.解压stream工具包</p>
<p>tar xvf stream-5.9-1.tar.bz2</p>
<p>3.进入到解压目录执行编译：</p>
<p>cd stream-5.9-1</p>
<p>make<br />
4.同时运行单线程和多线程测试</p>
<p>./Run.sh -n 1 -n 4 -n 8</p>
<p>注：这里的-n参数的值根据实际CPU核数设定,如只有4核，只跑./Run -n 1 -n 4，以此类推；</p>
<p>5.执行完后到results目录查看结果</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045131.png" alt="image-20240527131621866" /></p>
<h2 id="5硬盘读写性能iozone"><a class="markdownIt-Anchor" href="#5硬盘读写性能iozone"></a> <strong>5.硬盘读写性能(iozone)</strong></h2>
<p>解压之后进入源码目录/iozone3_430/src/current下，如下图所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045120.png" alt="image-20240524171745999" /></p>
<p>编译make CFLAGS=-fcommon linux-arm</p>
<p>编译完成如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045208.png" alt="image-20240524172141636" /></p>
<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./iozone -s 4g -i 0 -i 1 -i 2 -a -y 4k -q 16384k -f /iozonefile -Rb /home/iozonefile_rk3588.xls</span><br><span class="line">./iozone -s 8g -i 0 -i 1 -i 2 -a -y 4k -q 16384k -f /iozonefile -Rb /home/iozonefile_rk3588_8.xls</span><br><span class="line">./iozone -s 16g -i 0 -i 1 -i 2 -a -y 4k -q 16384k -f /iozonefile -Rb /home/iozonefile_rk3588_16.xls</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">                                                              random    random     bkwd    record    stride                                    </span><br><span class="line">              kB  reclen    write  rewrite    read    reread    read     write     read   rewrite      read   fwrite frewrite    fread  freread</span><br><span class="line">         4194304       4   436116   358158  5174402  4094807  2270951   252551                                                          </span><br><span class="line">         4194304       8   483751   256332  6320444  4891630  3472364   269135                                                          </span><br><span class="line">         4194304      16   552179   684541  6972783  5524091  5331936   191062                                                          </span><br><span class="line">         4194304      32   559849   265827  7379428  5821622  6585738   586108                                                          </span><br><span class="line">         4194304      64   568082   280172  7673710  6031385  7545110   585944                                                          </span><br><span class="line">         4194304     128   573306   500080  9033916  6142411  8316207   190163                                                          </span><br><span class="line">         4194304     256   573799   354331  7653196  6182861  8500953   381861                                                          </span><br><span class="line">         4194304     512   576573   457535  7674945  6020641  8491712   281622                                                          </span><br><span class="line">         4194304    1024   610564   252042  7706394  5969902  8495998   205003                                                          </span><br><span class="line">         4194304    2048   562769   698420  6728767  5158486  6865677   337050                                                          </span><br><span class="line">         4194304    4096   539499   365094  4529862  3965179  4768454   339728                                                          </span><br><span class="line">         4194304    8192   532515   545150  3921947  3663390  4292595   368336                                                          </span><br><span class="line">         4194304   16384   567006   310780  3897468  3539879  4119894   285764                                                          </span><br><span class="line"></span><br><span class="line">iozone test complete.</span><br><span class="line">Excel output is below:</span><br><span class="line"></span><br><span class="line">&quot;Writer report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   436116  483751  552179  559849  568082  573306  573799  576573  610564  562769  539499  532515  567006 </span><br><span class="line"></span><br><span class="line">&quot;Re-writer report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   358158  256332  684541  265827  280172  500080  354331  457535  252042  698420  365094  545150  310780 </span><br><span class="line"></span><br><span class="line">&quot;Reader report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   5174402  6320444  6972783  7379428  7673710  9033916  7653196  7674945  7706394  6728767  4529862  3921947  3897468 </span><br><span class="line"></span><br><span class="line">&quot;Re-Reader report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   4094807  4891630  5524091  5821622  6031385  6142411  6182861  6020641  5969902  5158486  3965179  3663390  3539879 </span><br><span class="line"></span><br><span class="line">&quot;Random read report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   2270951  3472364  5331936  6585738  7545110  8316207  8500953  8491712  8495998  6865677  4768454  4292595  4119894 </span><br><span class="line"></span><br><span class="line">&quot;Random write report&quot;</span><br><span class="line">        &quot;4&quot;  &quot;8&quot;  &quot;16&quot;  &quot;32&quot;  &quot;64&quot;  &quot;128&quot;  &quot;256&quot;  &quot;512&quot;  &quot;1024&quot;  &quot;2048&quot;  &quot;4096&quot;  &quot;8192&quot;  &quot;16384&quot;</span><br><span class="line">&quot;4194304&quot;   252551  269135  191062  586108  585944  190163  381861  281622  205003  337050  339728  368336  285764 </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./iozone -i 0 -i 1  -i 2 -f /iozonefile　-s 16G -Rb iozonefile_rk3588_16.xls</span><br><span class="line">./iozone -i 0 -i 1  -i 2 -f /iozonefile　 -s 8G  -Rb iozonefile_rk3588_8.xls</span><br><span class="line">./iozone -i 0 -i 1  -i 2 -f /iozonefile　 -s 4G  -Rb iozonefile_rk3588_4.xls</span><br></pre></td></tr></table></figure>
<h2 id="6网络传输性能netperf"><a class="markdownIt-Anchor" href="#6网络传输性能netperf"></a> <strong>6.网络传输性能(netperf)</strong></h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045197.png" alt="image-20240524173321029" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure -build=alpha</span><br><span class="line">make CFLAGS=-fcommon </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045342.png" alt="image-20240524173812947" /></p>
<p>在另一台机器上安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install netperf</span><br></pre></td></tr></table></figure>
<p>然后执行netserver命令启动监听服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netperf -H 192.168.1.221 -t TCP_STREAM -l 60 &gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t UDP_STREAM -l 60 &gt;&gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t TCP_RR -l 60 &gt;&gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t UDP_RR -l 60 &gt;&gt; netperf.txt</span><br><span class="line">netperf -H 192.168.1.221 -t TCP_CRR -l 60 &gt;&gt; netperf.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET</span><br><span class="line">Recv   Send    Send                          </span><br><span class="line">Socket Socket  Message  Elapsed              </span><br><span class="line">Size   Size    Size     Time     Throughput  </span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec  </span><br><span class="line"></span><br><span class="line">131072  16384  16384    60.00    44262.95   </span><br><span class="line">MIGRATED UDP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET</span><br><span class="line">Socket  Message  Elapsed      Messages                </span><br><span class="line">Size    Size     Time         Okay Errors   Throughput</span><br><span class="line">bytes   bytes    secs            #      #   10^6bits/sec</span><br><span class="line"></span><br><span class="line">212992   65507   60.00     7031396      0    61413.95</span><br><span class="line">212992           60.00     7016613           61284.84</span><br><span class="line"></span><br><span class="line">MIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET : first burst 0</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate         </span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec   </span><br><span class="line"></span><br><span class="line">16384  131072 1        1       60.00    93255.47   </span><br><span class="line">16384  131072</span><br><span class="line">MIGRATED UDP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET : first burst 0</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate         </span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec   </span><br><span class="line"></span><br><span class="line">212992 212992 1        1       60.00    95949.79   </span><br><span class="line">212992 212992</span><br><span class="line">MIGRATED TCP Connect/Request/Response TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.221 () port 0 AF_INET</span><br><span class="line">Local /Remote</span><br><span class="line">Socket Size   Request  Resp.   Elapsed  Trans.</span><br><span class="line">Send   Recv   Size     Size    Time     Rate         </span><br><span class="line">bytes  Bytes  bytes    bytes   secs.    per sec   </span><br><span class="line"></span><br><span class="line">16384  131072 1        1       60.00    23631.47   </span><br><span class="line">16384  131072</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>TCP STREAM<br />
1） 远端系统（即server）使用大小为87380字节的socket接收缓冲<br />
2） 本地系统（即client）使用大小为16384字节的socket发送缓冲<br />
3） 向远端系统发送的测试分组大小为16384字节<br />
4） 测试经历的时间为60.03秒<br />
5） 吞吐量的测试结果为941.47Mbits/秒</p>
</li>
<li>
<p>UDP_STREAM<br />
UDP_STREAM方式的结果中有两行测试数据，第一行显示的是本地系统的发送统计，这里的吞吐量表示netperf向本地socket发送分组的能力。第二行显示的就是远端系统接收的情况。</p>
</li>
<li>
<p>TCP_RR<br />
TCP_RR方式的测试对象是多次TCP request和response的交易过程，但是它们发生在同一个TCP连接中，这种模式常常出现在数据库应用中。数据库的client程序与server程序建立一个TCP连接以后，就在这个连接中传送数据库的多次交易过程。<br />
Netperf输出的结果也是由两行组成。第一行显示本地系统的情况，第二行显示的是远端系统的信息。平均的交易率（transaction rate）为3094.64次/秒。注意到这里每次交易中的request和response分组的大小都为1个字节，不具有很大的实际意义。用户可以通过测试相关的参数来改变request和response分组的大小，TCP_RR方式下的参数如下表所示：<br />
参数说明：<br />
-r req,resp 设置request和reponse分组的大小<br />
-s size 设置本地系统的socket发送与接收缓冲大小<br />
-S size 设置远端系统的socket发送与接收缓冲大小<br />
-D 对本地与远端系统的socket设置TCP_NODELAY选项</p>
</li>
<li>
<p>UDP_RR<br />
UDP_RR方式使用UDP分组进行request/response的交易过程。没有TCP连接所带来的负担。<br />
可能会受到网络中路由器或其它的网络设备对UDP采用了与TCP不同的缓冲区空间和处理技术影响,正常情况下会高于TCP_RR的值。本次测试结果为3136.53次/秒。</p>
</li>
<li>
<p>TCP_CRR<br />
与TCP_RR不同，TCP_CRR为每次交易建立一个新的TCP连接。最典型的应用就是HTTP，每次HTTP交易是在一条单独的TCP连接中进行的。因此，由于需要不停地建立新的TCP连接，并且在交易结束后拆除TCP连接，交易率一定会受到很大的影响。</p>
</li>
</ol>
<p>这里交易率明显的降低了，只有1422.23次/秒。</p>
<h2 id="7数据盘读写性能fio"><a class="markdownIt-Anchor" href="#7数据盘读写性能fio"></a> 7.数据盘读写性能(fio)</h2>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045589.png" alt="image-20240524175402485" /></p>
<p>测试方法<br />
安装libaio：（注意：顺序不能反，一定要先安装libaio，再编译）<br />
桌面版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get -y install libaio1 libaio-dev libraw-dev</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd fio-2.1.10</span><br><span class="line"> ./configure --cpu=aarch64</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045567.png" alt="image-20240524181017554" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=read -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_read.result &gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=write -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_write.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fio -filename=/test.1M -direct=1 -iodepth 16 -thread -rw=read -ioengine=libaio -bs=1M -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/1M_read.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.1M -direct=1 -iodepth 16 -thread -rw=write -ioengine=libaio -bs=1M -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/1M_write.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=randread -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_randread.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br><span class="line">fio -filename=/test.4k -direct=1 -iodepth 16 -thread -rw=randwrite -ioengine=libaio -bs=4k -size=2G -numjobs=8 -group_reporting -name=/test/07_fio/4k_randwrite.result &gt;&gt; /test/07_fio/result </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试完成后可查看result文件看结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">/test/07_fio/4k_read.result: (g=0): rw=read, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_read.result: (groupid=0, jobs=8): err= 0: pid=207001: Mon May 27 14:54:47 2024</span><br><span class="line">  read: IOPS=47.3k, BW=185MiB/s (194MB/s)(16.0GiB/88745msec)</span><br><span class="line">    slat (nsec): min=875, max=2133.2k, avg=7007.83, stdev=5016.92</span><br><span class="line">    clat (usec): min=199, max=3487.5k, avg=2610.55, stdev=15493.93</span><br><span class="line">     lat (usec): min=233, max=3487.5k, avg=2617.91, stdev=15493.93</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[  1045],  5.00th=[  1614], 10.00th=[  1778], 20.00th=[  1958],</span><br><span class="line">     | 30.00th=[  2073], 40.00th=[  2180], 50.00th=[  2311], 60.00th=[  2376],</span><br><span class="line">     | 70.00th=[  2507], 80.00th=[  2638], 90.00th=[  2933], 95.00th=[  3818],</span><br><span class="line">     | 99.00th=[  6390], 99.50th=[  9110], 99.90th=[ 28181], 99.95th=[ 38536],</span><br><span class="line">     | 99.99th=[425722]</span><br><span class="line">   bw (  KiB/s): min=23890, max=376878, per=100.00%, avg=199714.24, stdev=5507.16, samples=1309</span><br><span class="line">   iops        : min= 5969, max=94219, avg=49926.62, stdev=1376.75, samples=1309</span><br><span class="line">  lat (usec)   : 250=0.01%, 500=0.07%, 750=0.28%, 1000=0.51%</span><br><span class="line">  lat (msec)   : 2=22.73%, 4=72.24%, 10=3.75%, 20=0.25%, 50=0.14%</span><br><span class="line">  lat (msec)   : 100=0.02%, 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%</span><br><span class="line">  lat (msec)   : 2000=0.01%, &gt;=2000=0.01%</span><br><span class="line">  cpu          : usr=2.13%, sys=4.20%, ctx=558488, majf=0, minf=137</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=4194304,0,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=185MiB/s (194MB/s), 185MiB/s-185MiB/s (194MB/s-194MB/s), io=16.0GiB (17.2GB), run=88745-88745msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=246678/1475, merge=3945401/195, ticks=623046/25558, in_queue=648640, util=100.00%</span><br><span class="line">/test/07_fio/4k_write.result: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_write.result: (groupid=0, jobs=8): err= 0: pid=207097: Mon May 27 15:04:35 2024</span><br><span class="line">  write: IOPS=7147, BW=27.9MiB/s (29.3MB/s)(16.0GiB/586796msec); 0 zone resets</span><br><span class="line">    slat (nsec): min=1166, max=523153k, avg=24597.05, stdev=1700976.31</span><br><span class="line">    clat (usec): min=43, max=2624.1k, avg=17410.51, stdev=63041.08</span><br><span class="line">     lat (usec): min=72, max=2624.1k, avg=17435.47, stdev=63131.39</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[   1483],  5.00th=[   2835], 10.00th=[   3195],</span><br><span class="line">     | 20.00th=[   3589], 30.00th=[   3720], 40.00th=[   3916],</span><br><span class="line">     | 50.00th=[   4178], 60.00th=[   4293], 70.00th=[   4490],</span><br><span class="line">     | 80.00th=[   5276], 90.00th=[   9241], 95.00th=[ 125305],</span><br><span class="line">     | 99.00th=[ 227541], 99.50th=[ 329253], 99.90th=[ 926942],</span><br><span class="line">     | 99.95th=[1199571], 99.99th=[1501561]</span><br><span class="line">   bw (  KiB/s): min=   64, max=222744, per=100.00%, avg=30970.62, stdev=4675.11, samples=8583</span><br><span class="line">   iops        : min=   16, max=55686, avg=7741.70, stdev=1168.75, samples=8583</span><br><span class="line">  lat (usec)   : 50=0.01%, 100=0.01%, 250=0.03%, 500=0.10%, 750=0.65%</span><br><span class="line">  lat (usec)   : 1000=0.07%</span><br><span class="line">  lat (msec)   : 2=0.34%, 4=41.87%, 10=47.66%, 20=1.25%, 50=0.63%</span><br><span class="line">  lat (msec)   : 100=0.69%, 250=5.88%, 500=0.58%, 750=0.10%, 1000=0.05%</span><br><span class="line">  lat (msec)   : 2000=0.08%, &gt;=2000=0.01%</span><br><span class="line">  cpu          : usr=0.38%, sys=0.75%, ctx=576754, majf=0, minf=10</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,4194304,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=27.9MiB/s (29.3MB/s), 27.9MiB/s-27.9MiB/s (29.3MB/s-29.3MB/s), io=16.0GiB (17.2GB), run=586796-586796msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=0/286936, merge=0/3916379, ticks=0/8454187, in_queue=8462460, util=99.50%</span><br><span class="line">/test/07_fio/1M_read.result: (g=0): rw=read, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/1M_read.result: (groupid=0, jobs=8): err= 0: pid=207618: Mon May 27 15:05:35 2024</span><br><span class="line">  read: IOPS=275, BW=275MiB/s (288MB/s)(16.0GiB/59550msec)</span><br><span class="line">    slat (usec): min=38, max=512225, avg=25893.10, stdev=42143.54</span><br><span class="line">    clat (msec): min=11, max=2415, avg=430.93, stdev=146.16</span><br><span class="line">     lat (msec): min=11, max=2415, avg=456.82, stdev=152.57</span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  1.00th=[  105],  5.00th=[  213], 10.00th=[  264], 20.00th=[  317],</span><br><span class="line">     | 30.00th=[  355], 40.00th=[  388], 50.00th=[  418], 60.00th=[  451],</span><br><span class="line">     | 70.00th=[  493], 80.00th=[  542], 90.00th=[  609], 95.00th=[  684],</span><br><span class="line">     | 99.00th=[  844], 99.50th=[  902], 99.90th=[ 1083], 99.95th=[ 1183],</span><br><span class="line">     | 99.99th=[ 1552]</span><br><span class="line">   bw (  KiB/s): min=104448, max=669573, per=100.00%, avg=285587.80, stdev=11325.53, samples=924</span><br><span class="line">   iops        : min=  102, max=  653, avg=278.80, stdev=11.05, samples=924</span><br><span class="line">  lat (msec)   : 20=0.11%, 50=0.24%, 100=0.48%, 250=7.28%, 500=63.64%</span><br><span class="line">  lat (msec)   : 750=25.52%, 1000=2.52%, 2000=0.21%, &gt;=2000=0.01%</span><br><span class="line">  cpu          : usr=0.03%, sys=0.38%, ctx=18042, majf=0, minf=32777</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.4%, 16=99.3%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=16384,0,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=275MiB/s (288MB/s), 275MiB/s-275MiB/s (288MB/s-288MB/s), io=16.0GiB (17.2GB), run=59550-59550msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=32674/725, merge=0/110, ticks=6973292/412111, in_queue=7385454, util=100.00%</span><br><span class="line">/test/07_fio/1M_write.result: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/1M_write.result: (groupid=0, jobs=8): err= 0: pid=207681: Mon May 27 15:15:17 2024</span><br><span class="line">  write: IOPS=28, BW=28.2MiB/s (29.6MB/s)(16.0GiB/581311msec); 0 zone resets</span><br><span class="line">    slat (usec): min=93, max=4919.9k, avg=252152.23, stdev=625406.54</span><br><span class="line">    clat (msec): min=8, max=17001, avg=4129.88, stdev=2203.68</span><br><span class="line">     lat (msec): min=12, max=17001, avg=4382.04, stdev=2254.09</span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  1.00th=[   84],  5.00th=[  451], 10.00th=[ 1653], 20.00th=[ 2366],</span><br><span class="line">     | 30.00th=[ 2702], 40.00th=[ 3205], 50.00th=[ 4279], 60.00th=[ 4597],</span><br><span class="line">     | 70.00th=[ 4933], 80.00th=[ 6141], 90.00th=[ 6879], 95.00th=[ 8154],</span><br><span class="line">     | 99.00th=[10402], 99.50th=[10939], 99.90th=[12818], 99.95th=[13087],</span><br><span class="line">     | 99.99th=[14832]</span><br><span class="line">   bw (  KiB/s): min=13635, max=463331, per=100.00%, avg=79465.91, stdev=9160.13, samples=3318</span><br><span class="line">   iops        : min=    8, max=  449, avg=75.27, stdev= 8.92, samples=3318</span><br><span class="line">  lat (msec)   : 10=0.04%, 20=0.12%, 50=0.46%, 100=0.48%, 250=2.11%</span><br><span class="line">  lat (msec)   : 500=2.25%, 750=2.20%, 1000=0.84%, 2000=2.95%, &gt;=2000=88.54%</span><br><span class="line">  cpu          : usr=0.08%, sys=0.04%, ctx=17511, majf=0, minf=9</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.2%, 8=0.4%, 16=99.3%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,16384,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=28.2MiB/s (29.6MB/s), 28.2MiB/s-28.2MiB/s (29.6MB/s-29.6MB/s), io=16.0GiB (17.2GB), run=581311-581311msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=0/38767, merge=0/1043, ticks=0/64664224, in_queue=64667302, util=99.27%</span><br><span class="line">/test/07_fio/4k_randread.result: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_randread.result: (groupid=0, jobs=8): err= 0: pid=208207: Mon May 27 15:23:33 2024</span><br><span class="line">  read: IOPS=8483, BW=33.1MiB/s (34.7MB/s)(16.0GiB/494420msec)</span><br><span class="line">    slat (usec): min=2, max=201706, avg=36.93, stdev=428.22</span><br><span class="line">    clat (usec): min=88, max=533254, avg=15039.17, stdev=10664.59</span><br><span class="line">     lat (usec): min=292, max=533276, avg=15076.65, stdev=10688.75</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[   807],  5.00th=[  1958], 10.00th=[  3359], 20.00th=[  6128],</span><br><span class="line">     | 30.00th=[  8848], 40.00th=[ 11600], 50.00th=[ 14353], 60.00th=[ 17171],</span><br><span class="line">     | 70.00th=[ 20055], 80.00th=[ 22676], 90.00th=[ 25822], 95.00th=[ 27657],</span><br><span class="line">     | 99.00th=[ 45876], 99.50th=[ 66847], 99.90th=[111674], 99.95th=[130548],</span><br><span class="line">     | 99.99th=[177210]</span><br><span class="line">   bw (  KiB/s): min= 8035, max=48720, per=99.97%, avg=33923.78, stdev=237.61, samples=7886</span><br><span class="line">   iops        : min= 2006, max=12180, avg=8477.79, stdev=59.39, samples=7886</span><br><span class="line">  lat (usec)   : 100=0.01%, 250=0.01%, 500=0.06%, 750=0.75%, 1000=0.85%</span><br><span class="line">  lat (msec)   : 2=3.51%, 4=7.18%, 10=21.64%, 20=36.19%, 50=28.96%</span><br><span class="line">  lat (msec)   : 100=0.70%, 250=0.15%, 500=0.01%, 750=0.01%</span><br><span class="line">  cpu          : usr=0.75%, sys=2.16%, ctx=8332454, majf=0, minf=137</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=4194304,0,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=33.1MiB/s (34.7MB/s), 33.1MiB/s-33.1MiB/s (34.7MB/s-34.7MB/s), io=16.0GiB (17.2GB), run=494420-494420msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=4181430/7450, merge=12740/996, ticks=62631284/343162, in_queue=62974566, util=100.00%</span><br><span class="line">/test/07_fio/4k_randwrite.result: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.20</span><br><span class="line">Starting 8 threads</span><br><span class="line"></span><br><span class="line">/test/07_fio/4k_randwrite.result: (groupid=0, jobs=8): err= 0: pid=208657: Mon May 27 15:41:42 2024</span><br><span class="line">  write: IOPS=3855, BW=15.1MiB/s (15.8MB/s)(16.0GiB/1087918msec); 0 zone resets</span><br><span class="line">    slat (usec): min=2, max=2778.7k, avg=352.85, stdev=13919.64</span><br><span class="line">    clat (nsec): min=1458, max=5634.7M, avg=32836509.68, stdev=162686262.13</span><br><span class="line">     lat (usec): min=91, max=5634.8k, avg=33190.01, stdev=163925.97</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[    249],  5.00th=[    627], 10.00th=[   1123],</span><br><span class="line">     | 20.00th=[   2073], 30.00th=[   2966], 40.00th=[   3949],</span><br><span class="line">     | 50.00th=[   4883], 60.00th=[   5866], 70.00th=[   6849],</span><br><span class="line">     | 80.00th=[   7898], 90.00th=[  28181], 95.00th=[  48497],</span><br><span class="line">     | 99.00th=[ 801113], 99.50th=[1182794], 99.90th=[2105541],</span><br><span class="line">     | 99.95th=[2365588], 99.99th=[3103785]</span><br><span class="line">   bw (  KiB/s): min=   56, max=85966, per=100.00%, avg=15926.41, stdev=3214.43, samples=16811</span><br><span class="line">   iops        : min=    8, max=21488, avg=3980.73, stdev=803.57, samples=16811</span><br><span class="line">  lat (usec)   : 2=0.01%, 4=0.01%, 50=0.01%, 100=0.01%, 250=1.00%</span><br><span class="line">  lat (usec)   : 500=2.63%, 750=2.62%, 1000=2.55%</span><br><span class="line">  lat (msec)   : 2=10.38%, 4=21.28%, 10=46.67%, 20=1.69%, 50=6.22%</span><br><span class="line">  lat (msec)   : 100=0.51%, 250=1.12%, 500=1.43%, 750=0.81%, 1000=0.40%</span><br><span class="line">  lat (msec)   : 2000=0.56%, &gt;=2000=0.14%</span><br><span class="line">  cpu          : usr=0.35%, sys=1.10%, ctx=7577659, majf=0, minf=11</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,4194304,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=15.1MiB/s (15.8MB/s), 15.1MiB/s-15.1MiB/s (15.8MB/s-15.8MB/s), io=16.0GiB (17.2GB), run=1087918-1087918msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">  mmcblk0: ios=0/4191578, merge=0/13549, ticks=0/133093101, in_queue=133097231, util=99.99%</span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<p>filename=/data/test 测试文件名称，通常选择需要测试的盘的data目录；</p>
<p>direct=1 是否使用directIO，测试过程绕过OS自带的buffer。Linux读写的时候，内核维护了缓存，数据先写到缓存，后面再后台写到SSD。读的时候也优先读缓存里的数据。这样速度可以加快，但是一旦掉电缓存里的数据就没了。所以有一种模式叫做directIO，跳过缓存，直接读写SSD，使测试结果更真实；</p>
<p>rw=read 测试顺序读的I/O；</p>
<p>rw=write 测试顺序写的I/O；</p>
<p>rw=randread 测试随机读的I/O；</p>
<p>rw=write rw=randwrite 测试随机写的I/O；</p>
<p>rw=write rw=randrw 测试随机混合读和写的I/O；</p>
<p>bs=4k 单次io的块文件大小为4k；</p>
<p>size=5G 本次的测试文件大小为5g，以每次4k的io进行测试；</p>
<p>numjobs=8 测试线程为8；（需要根据测试的cpu线程数做对应修改）</p>
<p>name=job1 一个任务的名字，重复了也没关系；</p>
<p>thread 使用pthread_create创建线程，另一种是fork创建进程。进程的开销比线程要大，一般都采用thread测试；</p>
<p>group_reporting 关于显示结果的，汇总每个进程的信息；</p>
<p>runtime=120 测试时间为120秒，如果不写则一直将5g文件分4k每次写完为止；</p>
<p>time_based 如果设置的话，即使file已被完全读写或写完，也要执行完runtime规定的时间，它是通过循环执行相同的负载来实现的；</p>
<p>ioengine=libaio 指定io引擎使用libaio方式。<br />
libaio：Linux本地异步I/O。请注意，Linux可能只支持具有非缓冲I/O的排队行为（设置为“direct=1”或“buffered=0”）；</p>
<p>iodepth=32 队列的深度为32。<br />
  同步的IO：一次只能发出一个IO请求，等待内核完成才返回，这样对于单个线程iodepth总是小于1。（电梯算法：假如一部电梯一次只能搭乘一人，那么每个人一但乘上电梯，就能快速达到目的地（响应时间），但需要耗费较长的等待时间（队列长度）。虽然响应时间较短，但系统的吞吐量很小。）<br />
  异步情况下：一次提交一批，然后等待一批的完成，减少交互的次数，会更有效率。加大磁盘队列深度就是让磁盘不断工作，减少磁盘的空闲时间。（电梯算法：32个人等电梯，一次上满32人，只需等一次电梯即可）。</p>
<blockquote>
<p>各项参数说明<br />
io 执行了多少M的IO<br />
bw 平均IO带宽<br />
iops IOPS 即I/O per second，即每秒进行读写（I/O）操作的次数，是衡量磁盘性能的主要指标之一。<br />
runt 线程运行时间（单位毫秒）<br />
slat 提交延迟<br />
clat 完成延迟<br />
lat 响应时间<br />
cpu 利用率<br />
IO depths io队列<br />
IO submit 单个IO提交要提交的IO数<br />
IO complete 与上面的提交编号一样，但改为填写<br />
IO issued 发出的读/写请求数，以及短请求数。<br />
IO latencies IO延迟的分布<br />
下面的io 总共执行了多少size的IO<br />
aggrb group总带宽<br />
minb 最小平均带宽.<br />
maxb 最大平均带宽.<br />
mint group中线程的最短运行时间.<br />
maxt group中线程的最长运行时间.<br />
ios 所有group总共执行的IO数.<br />
merge 总共发生的IO合并数.<br />
ticks Number of ticks we kept the disk busy.<br />
in_queue 花费在队列上的总共时间.<br />
util 磁盘利用率</p>
</blockquote>
<h2 id="82d-图形性能graphics"><a class="markdownIt-Anchor" href="#82d-图形性能graphics"></a> 8.2D 图形性能(graphics)</h2>
<p>修改unixbench的第52行，从-lGL -lXext -lX11修改为GL_LIBS = -lGL -lXext -lX11 -lm  ，解开第49行的注释，如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051045547.png" alt="image-20240524181919729" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apt-get install glade  mesa-common-dev  libxext-dev   libx11-dev pkg-config libxmuu-dev libxrender-dev</span><br><span class="line">sudo apt-get install libxft-dev libfreetype6-dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置x11perf</span></span><br><span class="line">./configure --build=arm-linux</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">make install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译unixbench</span></span><br><span class="line">make </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 进行测试</span></span><br><span class="line">./Run graphics </span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Benchmark Run: 一 5月 27 2024 16:12:44 - 16:30:55</span><br><span class="line">8 CPUs in system; running 1 parallel copy of tests</span><br><span class="line"></span><br><span class="line">2D graphics: aa polygons                       5973.2 score (50.8 s, 2 samples)</span><br><span class="line">2D graphics: ellipses                          3633.5 score (50.8 s, 2 samples)</span><br><span class="line">2D graphics: images and blits                174032.7 score (53.8 s, 2 samples)</span><br><span class="line">2D graphics: rectangles                        4501.6 score (58.9 s, 2 samples)</span><br><span class="line">2D graphics: text                            120825.3 score (50.2 s, 2 samples)</span><br><span class="line">2D graphics: windows                           1361.1 score (50.8 s, 2 samples)</span><br><span class="line">3D graphics: gears                              888.6 fps   (20.0 s, 2 samples)</span><br><span class="line"></span><br><span class="line">3D Graphics Benchmarks Index Values          BASELINE       RESULT    INDEX</span><br><span class="line">3D graphics: gears                               33.4        888.6    266.0</span><br><span class="line">                                                                   ========</span><br><span class="line">3D Graphics Benchmarks Index Score                                    266.0</span><br><span class="line"></span><br><span class="line">2D Graphics Benchmarks Index Values          BASELINE       RESULT    INDEX</span><br><span class="line">2D graphics: aa polygons                         15.0       5973.2   3982.1</span><br><span class="line">2D graphics: ellipses                            15.0       3633.5   2422.3</span><br><span class="line">2D graphics: images and blits                    15.0     174032.7 116021.8</span><br><span class="line">2D graphics: rectangles                          15.0       4501.6   3001.1</span><br><span class="line">2D graphics: text                                15.0     120825.3  80550.2</span><br><span class="line">2D graphics: windows                             15.0       1361.1    907.4</span><br><span class="line">                                                                   ========</span><br><span class="line">2D Graphics Benchmarks Index Score                                   7913.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="93d-图形性能glmark2-es"><a class="markdownIt-Anchor" href="#93d-图形性能glmark2-es"></a> 9.<strong>3D 图形性能(glmark2-es)</strong></h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install glmark2-es</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试</span></span><br><span class="line">glmark2-es --fullscreen</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.bilibili.com/video/BV1ZN411D7V8/</span><br></pre></td></tr></table></figure>
<h2 id="1010g-文件性能"><a class="markdownIt-Anchor" href="#1010g-文件性能"></a> 10.10G 文件性能</h2>
<p>没空间了，改为了5G</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/$ dd if=/dev/zero of=/test10 bs=1M count=5120 conv=fdatasync</span><br><span class="line">5120+0 records in</span><br><span class="line">5120+0 records out</span><br><span class="line">5368709120 bytes (5.4 GB, 5.0 GiB) copied, 64.2663 s, 83.5 MB/s</span><br><span class="line">root@topeet:/$ </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/$ dd if=/test10 of=/home/kylin/testduxie1 bs=1M count=10240 conv=fdatasync</span><br><span class="line">5120+0 records in</span><br><span class="line">5120+0 records out</span><br><span class="line">5368709120 bytes (5.4 GB, 5.0 GiB) copied, 69.4213 s, 77.3 MB/s</span><br></pre></td></tr></table></figure>
<h2 id="11usb-存储设备性能"><a class="markdownIt-Anchor" href="#11usb-存储设备性能"></a> 11.USB 存储设备性能</h2>
<p>2.0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@topeet:/$ dd if=/test10 of=/media/kylin/新加卷/testduxie2 bs=1M count=1024  conv=fdatasync </span><br><span class="line"></span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 32.3505 s, 33.2 MB/s</span><br></pre></td></tr></table></figure>
<p>3.0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dd if=/test10 of=/media/kylin/新加卷/testduxie2 bs=1M count=1024  conv=fdatasync </span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 11.8471 s, 90.6 MB/s</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/16_野火sdk学习shell脚本解析"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/12/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/16_%E9%87%8E%E7%81%ABsdk%E5%AD%A6%E4%B9%A0shell%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90/"
    >开放麒麟shell脚本解析</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/12/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/16_%E9%87%8E%E7%81%ABsdk%E5%AD%A6%E4%B9%A0shell%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2024-08-12T09:17:03.000Z" itemprop="datePublished">2024-08-12</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/openkylin/openkylin-embedded-builder">https://gitee.com/openkylin/openkylin-embedded-builder</a></p>
<p>开放麒麟官网：<a target="_blank" rel="noopener" href="https://www.openkylin.top/">https://www.openkylin.top</a></p>
<p>文档目的：强化shell脚本编写阅读能力，提取开放麒麟文件系统构建脚本</p>
<p>代码阅读和编译环境：VS code 和 WSL ubuntu22</p>
</blockquote>
<h1 id="项目仓库的获取"><a class="markdownIt-Anchor" href="#项目仓库的获取"></a> 项目仓库的获取</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYgit clone https://gitee.com/openkylin/openkylin-embedded-builder.git</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026560.png" alt="image-20240816133742484" />image-20240816133742484</p>
<p>==果然不愧是gitee，果然是比github快的多，就还不错吧==</p>
<h1 id="仓库目录文件的分析"><a class="markdownIt-Anchor" href="#仓库目录文件的分析"></a> 仓库目录文件的分析</h1>
<p>拉取下来之后，仓库的目录和文件内容如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026374.png" alt="image-20240816133930163" />image-20240816133930163</p>
<p>上面的这些文件和文件夹中，只有后四个对我们有用，具体作用如下所示：</p>
<table>
<thead>
<tr>
<th>文件和文件夹名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://check-env.sh/">check-env.sh</a></td>
<td>检查文件系统构建的环境，查看依赖是不是安装完成</td>
</tr>
<tr>
<td>config</td>
<td>存放一系列的配置文件，和后处理脚本</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://functions.sh/">functions.sh</a></td>
<td>文件系统的脚本，系统的构建，主要函数都在该脚本中</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://okbuild.sh/">okbuild.sh</a></td>
<td>逻辑函数，对一些内容进行判断，这是需要执行的脚本</td>
</tr>
</tbody>
</table>
<p>根据我理解的逻辑对，上面提到的这四个文件或文件夹进行分析</p>
<h1 id="check-envsh脚本分析"><a class="markdownIt-Anchor" href="#check-envsh脚本分析"></a> check-env.sh脚本分析</h1>
<p>脚本执行过程如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026523.png" alt="image-20240816135726813" />image-20240816135726813</p>
<p>首先是将当前用户设置为无密码使用sudo，然后检查了几个工具是否安装，如果没安装就安装上，最后，将okbuild.sh链接到usr/bin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash  </span><br><span class="line">  </span><br><span class="line">set -e  # 如果任何语句的执行结果为非真，则立即退出脚本  </span><br><span class="line">  </span><br><span class="line"># 获取当前脚本的绝对路径所在的目录  </span><br><span class="line">CURRENT_DIR=$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)  </span><br><span class="line"># 导入当前目录下的functions.sh脚本  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/functions.sh  </span><br><span class="line">  </span><br><span class="line"># 配置sudo权限  </span><br><span class="line">config_sudo  </span><br><span class="line">  </span><br><span class="line"># 检查并安装制作镜像所需的包  </span><br><span class="line">check_package debootstrap  # 检查并安装debootstrap包，用于创建根文件系统  </span><br><span class="line">check_package gdisk        # 检查并安装gdisk包，用于操作GPT分区表  </span><br><span class="line">check_package mtools       # 检查并安装mtools包，用于操作MS-DOS文件系统  </span><br><span class="line">check_package dosfstools   # 检查并安装dosfstools包，用于创建和管理FAT文件系统  </span><br><span class="line">check_package genisoimage  # 检查并安装genisoimage包，用于创建ISO映像文件  </span><br><span class="line">check_package squashfs-tools  # 检查并安装squashfs-tools包，用于创建和管理squashfs文件系统  </span><br><span class="line">check_package xz-utils     # 检查并安装xz-utils包，用于处理XZ格式的压缩文件  </span><br><span class="line">  </span><br><span class="line"># 检查并安装设备树编译器  </span><br><span class="line">check_package device-tree-compiler  </span><br><span class="line">  </span><br><span class="line"># 创建软链接，将okbuild.sh脚本链接到/usr/bin/目录下，使其可以在任何地方被调用  </span><br><span class="line">sudo ln -v -sf &quot;$&#123;CURRENT_DIR&#125;&quot;/okbuild.sh /usr/bin/</span><br></pre></td></tr></table></figure>
<p>上面用了两个函数，从他们的名字上就可以分析出他们的作用，config_sudo是配置当前用户的sudo免密码权限，而check_package用来检测工具是否安装，这两个函数都定义在functions.sh脚本当中，等等再对这个脚本里的函数进行分析。</p>
<h1 id="config文件内容分析"><a class="markdownIt-Anchor" href="#config文件内容分析"></a> config文件内容分析</h1>
<p>config是这里唯一的一个文件夹，这个文件夹里有一些细分的脚本</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026400.png" alt="image-20240816141742796" />image-20240816141742796</p>
<p>可以分成两类，第一类是六个，如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026423.png" alt="image-20240816142830197" />image-20240816142830197</p>
<p>这些脚本里面就是安装一些工具，创建openkylin用户，设置中文环境罢了，其他也没啥，而public.sh里面是四个函数，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 仅打印</span><br><span class="line">function MY_LOG() &#123;</span><br><span class="line">    echo &quot; =&gt; $*&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 打印 并 执行</span><br><span class="line">function MY_LOG_EXEC() &#123;</span><br><span class="line">    echo &quot; =&gt; $*&quot;</span><br><span class="line">    eval &quot;$*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 执行指定目录下的脚本</span><br><span class="line">function run_scripts() &#123;</span><br><span class="line">    SCRIPTS_DIR=&quot;$&#123;1&#125;&quot;</span><br><span class="line">    VK_ORDER=$&#123;VK_ORDER:-default&#125;</span><br><span class="line"></span><br><span class="line">    if [ -d &quot;$&#123;SCRIPTS_DIR&#125;&quot; ]; then</span><br><span class="line">        if [ -f &quot;$&#123;SCRIPTS_DIR&#125;/$&#123;VK_ORDER&#125;&quot; ]; then</span><br><span class="line">            # 按照给定的顺序执行脚本</span><br><span class="line">            for script_name in $(cat $&#123;SCRIPTS_DIR&#125;/$&#123;VK_ORDER&#125; | sed &#x27;/^#/d&#x27;); do</span><br><span class="line">                echo &quot;---&gt; . $&#123;SCRIPTS_DIR&#125;/$&#123;script_name&#125;&quot;</span><br><span class="line">                . $&#123;SCRIPTS_DIR&#125;/$&#123;script_name&#125; 2&gt;&amp;1 | tee /config/&quot;$(basename $&#123;script_name&#125;)&quot;.log</span><br><span class="line">            done</span><br><span class="line">        else</span><br><span class="line">            # 按照sort -n排序，执行全部脚本</span><br><span class="line">            for script_name in $(find $&#123;SCRIPTS_DIR&#125; -name &quot;*.sh&quot; | sort -n); do</span><br><span class="line">                echo &quot;---&gt; . $&#123;script_name&#125;&quot;</span><br><span class="line">                . &quot;$&#123;script_name&#125;&quot; 2&gt;&amp;1 | tee /config/&quot;$(basename $&#123;script_name&#125;)&quot;.log</span><br><span class="line">            done</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建用户</span><br><span class="line">function create_user() &#123;</span><br><span class="line">    USERNAME=&quot;$1&quot;</span><br><span class="line">    PASSWORD=&quot;$2&quot;</span><br><span class="line">    USERID=&quot;$&#123;3:-1000&#125;&quot;</span><br><span class="line">    if ! awk -F: &#x27;&#123;print $1&#125;&#x27; /etc/passwd | grep -q $&#123;USERNAME&#125;; then</span><br><span class="line">        useradd -m -s /bin/bash -u $&#123;USERID&#125; &quot;$&#123;USERNAME&#125;&quot;</span><br><span class="line">        usermod -c &quot;$&#123;USERNAME&#125;&quot; &quot;$&#123;USERNAME&#125;&quot;</span><br><span class="line">        echo &quot;$&#123;USERNAME&#125;:$&#123;PASSWORD&#125;&quot; | chpasswd</span><br><span class="line">        adduser $&#123;USERNAME&#125; sudo</span><br><span class="line">        adduser $&#123;USERNAME&#125; adm</span><br><span class="line">        adduser $&#123;USERNAME&#125; cdrom &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; dip &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; plugdev &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; lpadmin &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; sambashare &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; libvirtd &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; lxd &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">    else</span><br><span class="line">        echo &quot;user $&#123;USERNAME&#125; already exists&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_hostname() &#123;</span><br><span class="line">    HOSTNAME=&quot;$1&quot;</span><br><span class="line">    echo $&#123;HOSTNAME&#125; &gt;/etc/hostname</span><br><span class="line"></span><br><span class="line">    touch /etc/hosts</span><br><span class="line">    if ! grep -q &quot;127.0.0.1 localhost&quot; /etc/hosts; then</span><br><span class="line">        cat &gt;&gt;/etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 $&#123;HOSTNAME&#125;</span><br><span class="line">EOF</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function install_pkgs() &#123;</span><br><span class="line">    MY_LOG_EXEC apt-get install -y &quot;$*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 循环单个安装</span><br><span class="line">function install_pkgs_each() &#123;</span><br><span class="line">    for pkg in &quot;$@&quot;; do</span><br><span class="line">        MY_LOG_EXEC apt-get install -y -q &quot;$&#123;pkg&#125;&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 结束，收尾</span><br><span class="line">function finish() &#123;</span><br><span class="line">    # 禁止 kylin-virtual-keyboard, ukui-tablet-desktop.desktop 开机不启动</span><br><span class="line">    [ -f &quot;/etc/xdg/autostart/kylin-virtual-keyboard.desktop&quot; ] &amp;&amp; mv -v /etc/xdg/autostart/kylin-virtual-keyboard.desktop&#123;,.bak&#125;</span><br><span class="line">    [ -f &quot;/etc/xdg/autostart/ukui-tablet-desktop.desktop&quot; ] &amp;&amp; mv -v /etc/xdg/autostart/ukui-tablet-desktop.desktop&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line">    # 删除开始菜单图标</span><br><span class="line">    rm -rf /usr/share/applications/vim.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.systemmonitor.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.plasma-systemmonitor.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.khelpcenter.desktop</span><br><span class="line">    rm -rf /usr/share/applications/mate-user-guide.desktop</span><br><span class="line">    rm -rf /usr/share/applications/yelp.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.telhandler.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.sms.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.kcm.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.app.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.smshandler.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.nonplasma.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.daemon.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect_open.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kinfocenter.desktop</span><br><span class="line"></span><br><span class="line">    set_hostname openkylin</span><br><span class="line"></span><br><span class="line">    if [ -f /lib/systemd/system/dnsmasq.service ]; then</span><br><span class="line">        systemctl disable dnsmasq.service</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 设置时区</span><br><span class="line">    echo &quot;Asia/Shanghai&quot; &gt;/etc/timezone</span><br><span class="line">    rm -rf /etc/localtime</span><br><span class="line">    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; file system make finish&quot;</span><br><span class="line"></span><br><span class="line">    export HISTSIZE=0</span><br><span class="line">    rm -rf /var/cache/apt/archives/*.deb</span><br><span class="line">    if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">        rm -rf /var/cache/apt/*.bin</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_Packages</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_InRelease</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_Translation*</span><br><span class="line">        rm -rf /root/.bash_history</span><br><span class="line">        rm -rf /tmp/*</span><br><span class="line">        rm -rf ~/.bash_history</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置默认语言为中文</span><br><span class="line">function config_zh_cn() &#123;</span><br><span class="line">    cat &gt;/etc/locale.gen &lt;&lt;EOF</span><br><span class="line">zh_CN.UTF-8 UTF-8</span><br><span class="line">en_US.UTF-8 UTF-8</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cat &gt;/etc/default/locale &lt;&lt;EOF</span><br><span class="line">LANG=zh_CN.UTF-8</span><br><span class="line">LANGUAGE=&quot;zh_CN:zh&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    locale-gen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置默认语言为英文</span><br><span class="line">function config_en_utf8() &#123;</span><br><span class="line">    cat &gt;/etc/locale.gen &lt;&lt;EOF</span><br><span class="line">en_US ISO-8859-1</span><br><span class="line">en_US.UTF-8 UTF-8</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cat &gt;/etc/default/locale &lt;&lt;EOF</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">LANGUAGE=&quot;en_US:en&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    locale-gen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三个函数run_scripts和第四个函数create_user需要注意一下，第四个函数可以学习一下，用在我们的构建上，而第三个是重点，根据他的内容可以推测出正是调用了这个函数才真正的调用了下面的这些shell函数：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026426.png" alt="image-20240816143742187" />image-20240816143742187</p>
<p>这些shell等等再讲解，先来看openkylin目录下的文件，可以将这些文件分为三部分，具体如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026090.png" alt="image-20240816144035365" />image-20240816144035365</p>
<p>main.sh可以从名字看出他是最主要的文件，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash  </span><br><span class="line">set -e  </span><br><span class="line">  </span><br><span class="line"># 解析宿主环境传递参数  </span><br><span class="line">for item in $*; do  </span><br><span class="line">    if grep -q &quot;^VK.*=&quot; &lt;&lt;&lt;&quot;$&#123;item&#125;&quot;; then  </span><br><span class="line">        KEY=$&#123;item%%=*&#125;  # 提取键名  </span><br><span class="line">        VALUE=&quot;$&#123;item##*=&#125;&quot;  # 提取键值  </span><br><span class="line">        eval &quot;export $&#123;KEY&#125;=&#x27;$&#123;VALUE&#125;&#x27;&quot;  # 导出键值对为环境变量  </span><br><span class="line">    fi  </span><br><span class="line">done  </span><br><span class="line">  </span><br><span class="line"># 系统版本信息  </span><br><span class="line">[ -f /etc/os-release ] &amp;&amp; source /etc/os-release  # 如果存在系统版本信息文件，则导入  </span><br><span class="line">  </span><br><span class="line">CURRENT_DIR=$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)  # 获取当前脚本的绝对路径  </span><br><span class="line">[ -f &quot;$&#123;CURRENT_DIR&#125;&quot;/public.sh ] &amp;&amp; . &quot;$&#123;CURRENT_DIR&#125;&quot;/public.sh  # 如果存在公共脚本，则导入  </span><br><span class="line">[ -f &quot;$&#123;CURRENT_DIR&#125;&quot;/private.sh ] &amp;&amp; . &quot;$&#123;CURRENT_DIR&#125;&quot;/private.sh  # 如果存在私有脚本，则导入  </span><br><span class="line">  </span><br><span class="line">CURRENT_ARCH=$(dpkg --print-architecture)  # 获取当前系统架构  </span><br><span class="line">  </span><br><span class="line"># 设置内网源  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/apt_source-$&#123;CURRENT_ARCH&#125;.sh  # 导入对应架构的内网源设置脚本  </span><br><span class="line">  </span><br><span class="line"># 制作系统  </span><br><span class="line">if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ]; then  # 如果当前任务为配置  </span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ]; then  # 如果设置了更新标志，并且值为y  </span><br><span class="line">        if [ -f /rootfs.deblist ] &amp;&amp; [ ! -f /rootfs-update.deblist ]; then  # 如果存在基础包列表文件，且不存在更新后的列表文件  </span><br><span class="line">            # 升级基础包  </span><br><span class="line">            for pkg in $(awk &#x27;&#123;print $1&#125;&#x27; /rootfs.deblist); do  # 遍历基础包列表  </span><br><span class="line">                MY_LOG_EXEC apt-get install -y -q --allow-downgrades $&#123;pkg&#125;  # 安装或降级包  </span><br><span class="line">            done  </span><br><span class="line">            # 升级后的列表  </span><br><span class="line">            dpkg-query -W --showformat=&#x27;$&#123;Package&#125; $&#123;Version&#125;\n&#x27; &gt;/rootfs-update.deblist  # 生成更新后的列表文件  </span><br><span class="line">            rm -rf /var/cache/apt/archives/*.deb  # 清理下载的包文件  </span><br><span class="line">        fi  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    run_scripts &quot;$&#123;CURRENT_DIR&#125;&quot;/shells  # 执行shell脚本目录下的所有脚本  </span><br><span class="line">else  </span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;&quot;/$&#123;VK_CURRENT_TASK&#125;.sh  # 导入并执行当前任务对应的脚本  </span><br><span class="line">fi  </span><br><span class="line">  </span><br><span class="line"># 设置公网源  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/apt_public-$&#123;CURRENT_ARCH&#125;.sh  # 导入对应架构的公网源设置脚本  </span><br><span class="line">  </span><br><span class="line">finish  # 执行结束操作</span><br></pre></td></tr></table></figure>
<p>然后是内网源和公网源的，这里我还没看懂到底是啥意思，为社么要设置两次呢，这里不是很理解，等等再说吧，而第39行终于是调用了前面提到的run_scripts，调用shell下的一系列内容。</p>
<p>最后是以prop开头的一系列文件，根据内容开看这是一系列的配置文件，以树莓派4b的配置文件为例，可以看到有以下内容：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026104.png" alt="image-20240816145605421" />image-20240816145605421</p>
<p>分别记录了版本状态、主板标识、架构、执行顺序、执行任务等等，现在还不知道是哪里用到了这个配置文件，但肯定是用到了，后面对于编译流程的分析过程中再来讲解，最后来看shells文件夹里的脚本，如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026080.png" alt="image-20240816145829922" />image-20240816145829922</p>
<p>同样是根据名字进行推理，前面六个脚本可以分成一类，是文件系统设置的脚本，而后面六个可以分成一类，根据不同的开发板来决定都调用前面哪几个脚本，然后来对前面这几个脚本进行分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    # base tools</span><br><span class="line">    apt-utils</span><br><span class="line">    kmod</span><br><span class="line">    kbd</span><br><span class="line">    whiptail</span><br><span class="line">    locales</span><br><span class="line"></span><br><span class="line">    systemd-resolved</span><br><span class="line"></span><br><span class="line">    # extra tools</span><br><span class="line">    vim</span><br><span class="line">    lsof</span><br><span class="line">    cpio</span><br><span class="line">    file</span><br><span class="line">    sudo</span><br><span class="line">    tree</span><br><span class="line">    wget</span><br><span class="line">    rsync</span><br><span class="line">    fdisk</span><br><span class="line">    gdisk</span><br><span class="line">    parted</span><br><span class="line">    psmisc</span><br><span class="line">    rsyslog</span><br><span class="line">    dosfstools</span><br><span class="line">    lsb-release</span><br><span class="line">    archdetect-deb</span><br><span class="line">    bash-completion</span><br><span class="line">    zstd</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>1-tools.sh就是安装一点软件而已，<a target="_blank" rel="noopener" href="http://xn--2-net-408hr55ok0j.sh/">然后看2-net.sh</a>，其实也就是安装了一点网络相关的软件，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    iputils-ping iproute2 net-tools</span><br><span class="line">    network-manager</span><br><span class="line">    wpasupplicant</span><br><span class="line"></span><br><span class="line">    # ssh</span><br><span class="line">    openssh-server</span><br><span class="line">    openssh-client</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--3-ukui-9h6jv19jfqswkn.sh/">然后来看3-ukui.sh</a>，也是装一些工具，他这里的工具主要是关于桌面配置相关的东西，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    xinit lightdm xdg-user-dirs ukui-control-center ukui-desktop-environment ukui-desktop-environment-core ukui-greeter openkylin-wallpapers</span><br><span class="line">    ukui-globaltheme-heyin</span><br><span class="line">    libukuiinputgatherclient1 xserver-xorg-video-fbdev</span><br><span class="line">    xserver-xorg-input-all</span><br><span class="line"></span><br><span class="line">    # 网络设置</span><br><span class="line">    network-manager-gnome</span><br><span class="line"></span><br><span class="line">    # 便签</span><br><span class="line">    ukui-notebook libqt5sql5-sqlite</span><br><span class="line">    # 屏幕键盘</span><br><span class="line">    onboard python3-xdg</span><br><span class="line">    # VNC工具</span><br><span class="line">    remmina remmina-plugin-vnc</span><br><span class="line"></span><br><span class="line">    kylin-daq</span><br><span class="line">    kylin-app-manager</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br><span class="line"></span><br><span class="line"># lite-ukui-config</span><br><span class="line">if apt-cache policy lite-ukui-config | grep -q lite-ukui-config; then</span><br><span class="line">    apt-get install -y lite-ukui-config</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--4-grub-9h6jv11j4zu.sh/">然后是4-grub.sh</a>，我到现在也不知道grub是做什么的，但是看内容是只有amd64的才需要，就不管了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">CURRENT_ARCH=$(dpkg --print-architecture)</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;CURRENT_ARCH&#125;&quot; == &quot;amd64&quot; ]; then</span><br><span class="line">    PKGS=(</span><br><span class="line">        grub-efi</span><br><span class="line">        grub-common</span><br><span class="line">        grub2-common</span><br><span class="line">        # label.so</span><br><span class="line">        plymouth-label</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--5-kernel-kf1np64ujon.sh/">然后看5-kernel.sh</a>，根据内容就知道这是内核的构建，忽略即可，无需理会。<a target="_blank" rel="noopener" href="http://xn--9-lash-9h6js56j9zau85i.sh/">最后来看9-lash.sh</a>，这里就是设置了一下允许root登录，以及设置网络配置文件，其他就没啥了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># NetworkManager</span><br><span class="line">if [ -d /etc/NetworkManager/conf.d ]; then</span><br><span class="line">    touch /etc/NetworkManager/conf.d/10-globally-managed-devices.conf</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># ssh allow root login</span><br><span class="line">&#123;</span><br><span class="line">    if [ -f /etc/ssh/sshd_config ]; then</span><br><span class="line">        if ! grep -q &quot;^PermitRootLogin yes$&quot; /etc/ssh/sshd_config; then</span><br><span class="line">            sed -i.bak &#x27;/PermitRootLogin/d&#x27; /etc/ssh/sshd_config</span><br><span class="line">            echo &#x27;PermitRootLogin yes&#x27; &gt;&gt;/etc/ssh/sshd_config</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里关于config文件就分析的差不多了。</p>
<h1 id="okbuildsh脚本分析"><a class="markdownIt-Anchor" href="#okbuildsh脚本分析"></a> okbuild.sh脚本分析</h1>
<p>这个脚本就是最开始运行的构建脚本，一切以这个为开始，但是呢，这个脚本实际上并没有什么用，因为我只需要文件系统构建的地方即可，这里的内容有些空虚了，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">CURRENT_FILE=$(readlink -f &quot;$0&quot;)</span><br><span class="line">CURRENT_DIR=$(dirname &quot;$&#123;CURRENT_FILE&#125;&quot;)</span><br><span class="line"># 函数库 优先级 1</span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/functions.sh</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">    echo -en &quot;USAGE:</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_chilliepi  # 双椒派</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_lotus2     # lotus2开发板</span><br><span class="line"></span><br><span class="line">$(basename &quot;$0&quot;) -p prop_rpi4b      # 树莓派4B</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_vf2        # VisionFive2</span><br><span class="line"></span><br><span class="line">$(basename &quot;$0&quot;) -p prop_phytiumpi_2G  # 飞腾派 2GB 版本</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_phytiumpi_4G  # 飞腾派 4GB 版本</span><br><span class="line">&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 判断参数个数</span><br><span class="line">if [ $# -eq 0 ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 配置sudo免密</span><br><span class="line">if [ &quot;$(id -nu)&quot; != &quot;root&quot; ]; then</span><br><span class="line">    sudo tee &quot;/etc/sudoers.d/$&#123;USER&#125;&quot; &lt;&lt;EOF</span><br><span class="line">$USER ALL=(ALL:ALL) NOPASSWD: ALL</span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">ARGS=$(getopt -a -o h,p: -l help,conf:,prop:,mirror:,suite:,name:,arch:,debdir:,tasks:,version: -- &quot;$@&quot;)</span><br><span class="line">eval set -- &quot;$&#123;ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 参数 优先级 1</span><br><span class="line">while true; do</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">    -h | --help)</span><br><span class="line">        usage</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    -p | --prop)</span><br><span class="line">        PROP=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --arch)</span><br><span class="line">        VK_ARCH=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --tasks)</span><br><span class="line">        VK_TASKS=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --)</span><br><span class="line">        break</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">    shift</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 默认选用base目录</span><br><span class="line">CONF=$&#123;CONF:-openkylin&#125;</span><br><span class="line"></span><br><span class="line">if [ ! -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">    color_error &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125; not exist!!&quot;</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 参数 优先级 2</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;PROP:-default.prop&#125;&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;PROP:-default.prop&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 参数 优先级 3</span><br><span class="line">for item in &quot;$@&quot;; do</span><br><span class="line">    if grep -q &quot;^VK.*=&quot; &lt;&lt;&lt;&quot;$&#123;item&#125;&quot;; then</span><br><span class="line">        KEY=$&#123;item%%=*&#125;</span><br><span class="line">        VALUE=&quot;$&#123;item##*=&#125;&quot;</span><br><span class="line">        eval &quot;export $&#123;KEY&#125;=&#x27;$&#123;VALUE&#125;&#x27;&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 参数 优先级 4</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;VK_ENV&#125;&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;VK_ENV&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 是否保留镜像制作目录</span><br><span class="line">VK_KEEP_IMAGE_DIR=$&#123;VK_KEEP_IMAGE_DIR:-y&#125;</span><br><span class="line"></span><br><span class="line">VK_ARCH=$&#123;VK_ARCH:-arm64&#125;</span><br><span class="line">VK_MIRROR=$&#123;VK_MIRROR:-http://archive.build.openkylin.top/openkylin&#125;</span><br><span class="line">VK_SUITE=$&#123;VK_SUITE:-yangtze&#125;</span><br><span class="line">VK_VERSION=$&#123;VK_VERSION:-test&#125;</span><br><span class="line"></span><br><span class="line">ROOTFS_DIR=&quot;openKylin&quot;</span><br><span class="line">if [ -n &quot;$&#123;VK_VERSION&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_VERSION&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_TERMINAL&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_TERMINAL&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_BOARD&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_BOARD&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_ARCH&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_ARCH&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 函数库 优先级 2</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/functions.sh&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/functions.sh&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">color_info &quot;---&gt; args&quot;</span><br><span class="line">set | grep &quot;^VK_&quot; | tee &quot;$&#123;ROOTFS_DIR&#125;.prop&quot;</span><br><span class="line"></span><br><span class="line">function exit_function() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-iso/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">    umount_target ./p1</span><br><span class="line">    umount_target ./p2</span><br><span class="line">    umount_target ./p3</span><br><span class="line"></span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trap &quot;exit_function&quot; 0</span><br><span class="line"></span><br><span class="line">umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$&#123;VK_TASKS&#125;&quot; ]; then</span><br><span class="line">    color_error &quot;---&gt; no task to do!!&quot;</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 判断是否支持此架构</span><br><span class="line">if ! echo &quot;$&#123;VK_ARCH&#125;&quot; | grep -q -E &quot;amd64|arm64|loongarch64|i386|riscv64&quot;; then</span><br><span class="line">    color_error &quot;not support &#x27;ARCH: $&#123;VK_ARCH&#125;&#x27;&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># x86上制作其他架构, 需安装 binfmt-support,qemu-user-static</span><br><span class="line">if [ &quot;$(dpkg --print-architecture)&quot; == &quot;amd64&quot; ] &amp;&amp; [ &quot;$&#123;VK_ARCH&#125;&quot; != &quot;amd64&quot; ]; then</span><br><span class="line">    check_package binfmt-support</span><br><span class="line">    check_package qemu-user-static</span><br><span class="line">elif [ &quot;$(dpkg --print-architecture)&quot; != &quot;$&#123;VK_ARCH&#125;&quot; ]; then</span><br><span class="line">    # 非x86, 提示不能制作其他架构</span><br><span class="line">    color_error &quot;current os is $(dpkg --print-architecture), don&#x27;t support $&#123;VK_ARCH&#125;!!&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 执行任务</span><br><span class="line">##################################################</span><br><span class="line">for task in $&#123;VK_TASKS//,/ &#125;; do</span><br><span class="line">    color_info &quot;---&gt; do_$&#123;task&#125;&quot;</span><br><span class="line">    export VK_CURRENT_TASK=&quot;$&#123;task&#125;&quot;</span><br><span class="line">    do_&quot;$&#123;task&#125;&quot;</span><br><span class="line">done | tee &quot;$&#123;ROOTFS_DIR&#125;.log&quot;</span><br><span class="line">##################################################</span><br></pre></td></tr></table></figure>
<p>判断了，确实没有什么需要学习的地方</p>
<h1 id="functionssh脚本分析"><a class="markdownIt-Anchor" href="#functionssh脚本分析"></a> functions.sh脚本分析</h1>
<p>这里面的内容有点多，我先将每个函数隔离出来</p>
<h2 id="函数-config_sudo"><a class="markdownIt-Anchor" href="#函数-config_sudo"></a> 函数 config_sudo</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY# 配置sudo免密</span><br><span class="line">function config_sudo() &#123;</span><br><span class="line">    if [ $(id -u) != 0 ]; then</span><br><span class="line">        sudo tee /etc/sudoers.d/$USER &lt;&lt;EOF</span><br><span class="line">$USER ALL=(ALL:ALL) NOPASSWD: ALL</span><br><span class="line">EOF</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-check_package"><a class="markdownIt-Anchor" href="#函数-check_package"></a> 函数 check_package</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">COPY# 检查是否安装指定包</span><br><span class="line">function check_package() &#123;</span><br><span class="line">    pkg_name=&quot;$1&quot;</span><br><span class="line">    if [ -n &quot;$&#123;pkg_name&#125;&quot; ]; then</span><br><span class="line">        if ! dpkg -l | grep &quot;^ii  $&#123;pkg_name&#125;&quot;; then</span><br><span class="line">            sudo apt-get install -y -qq &quot;$&#123;pkg_name&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-mount_host_to_target"><a class="markdownIt-Anchor" href="#函数-mount_host_to_target"></a> 函数 mount_host_to_target</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY# 宿主机挂载 设备节点 到 rootfs</span><br><span class="line">function mount_host_to_target() &#123;</span><br><span class="line">    sudo mount --bind /dev $&#123;1&#125;/dev</span><br><span class="line">    sudo mount --bind /run $&#123;1&#125;/run</span><br><span class="line">    sudo mount -t devpts devpts $&#123;1&#125;/dev/pts</span><br><span class="line">    sudo mount -t proc proc $&#123;1&#125;/proc</span><br><span class="line">    sudo mount -t sysfs sysfs $&#123;1&#125;/sys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-umount_target"><a class="markdownIt-Anchor" href="#函数-umount_target"></a> 函数 umount_target</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COPY# 卸载宿主设备节点</span><br><span class="line">function umount_target() &#123;</span><br><span class="line">    sudo umount -l $&#123;1&#125;/* &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">    sudo umount $&#123;1&#125; &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_rootfs"><a class="markdownIt-Anchor" href="#函数-do_rootfs"></a> 函数 do_rootfs</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">COPY# 制作基础根文件系统</span><br><span class="line">function do_rootfs() &#123;</span><br><span class="line">    # 先删除 原有 rootfs 目录</span><br><span class="line">    if [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.done&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        MY_LOG_EXEC &quot;sudo rm -rf $&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # debootstrap 参数</span><br><span class="line">        DEBOOTSTRAP_ARGS=&quot;--no-check-gpg --variant=minbase --arch=$&#123;VK_ARCH&#125; --components=main --include=openkylin-keyring,systemd-sysv $&#123;VK_SUITE&#125; $&#123;ROOTFS_DIR&#125; $&#123;VK_MIRROR&#125; gutsy&quot;</span><br><span class="line"></span><br><span class="line">        # 制作 rootfs</span><br><span class="line">        MY_LOG_EXEC &quot;sudo debootstrap $&#123;DEBOOTSTRAP_ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 记录基础rootfs的包列表，给第2步升级包版本用</span><br><span class="line">        # sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27; &gt; /rootfs.deblist&quot;</span><br><span class="line">        # cp &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line">        sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27;&quot; &gt;&quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line"></span><br><span class="line">        sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/archives/*.deb</span><br><span class="line">        if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/*.bin</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Packages</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_InRelease</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Translation*</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/root/.bash_history</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/tmp/*</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # rootfs制作完成</span><br><span class="line">        MY_LOG_EXEC &quot;touch $&#123;ROOTFS_DIR&#125;.done&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_config"><a class="markdownIt-Anchor" href="#函数-do_config"></a> 函数 do_config</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">COPY# 进入根文件系统进行安装、配置</span><br><span class="line">function do_config() &#123;</span><br><span class="line">    # 需要升级基础rootfs</span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ] &amp;&amp; [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.rootfs-update.deblist&quot; ]; then</span><br><span class="line">        MY_LOG_EXEC &quot;sudo cp -v $&#123;ROOTFS_DIR&#125;.rootfs.deblist $&#123;ROOTFS_DIR&#125;/rootfs.deblist&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 挂载</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    mount_host_to_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝配置到 $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo mkdir -p $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo cp -v $&#123;CURRENT_DIR&#125;/config/*.sh $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">    if [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        sudo cp -r $&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/. $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">        # 制作</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; /usr/bin/env -i \</span><br><span class="line">            PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \</span><br><span class="line">            HOME=/root \</span><br><span class="line">            LC_ALL=C \</span><br><span class="line">            DEBIAN_FRONTEND=noninteractive \</span><br><span class="line">            APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=DontWarn \</span><br><span class="line">            bash -euo pipefail /config/main.sh &quot;$(set | grep &quot;^VK_&quot; | xargs)&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#x27;config/$&#123;CONF&#125;&#x27; not exits!&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 卸载</span><br><span class="line">    umount_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 参考分析用</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    # sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/config $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; == &quot;config&quot; ]; then</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.deblist</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 删除 update 包列表</span><br><span class="line">    if [ -f &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist ]; then</span><br><span class="line">        cp -v &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist</span><br><span class="line">    fi</span><br><span class="line">    sudo rm -v -rf &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs*.deblist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_tar"><a class="markdownIt-Anchor" href="#函数-do_tar"></a> 函数 do_tar</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COPY# 将 rootfs 打为 tar 包</span><br><span class="line">function do_tar() &#123;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo tar zcf $&#123;ROOTFS_DIR&#125;.tar.gz --numeric-owner -C $&#123;ROOTFS_DIR&#125; .&quot;</span><br><span class="line">    md5sum $&#123;ROOTFS_DIR&#125;.tar.gz &gt;$&#123;ROOTFS_DIR&#125;.tar.gz.md5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_iso"><a class="markdownIt-Anchor" href="#函数-do_iso"></a> 函数 do_iso</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">COPY# 制作iso文件</span><br><span class="line">function do_iso() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    pushd &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line"></span><br><span class="line">    do_config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.$&#123;VK_CURRENT_TASK&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 镜像名称</span><br><span class="line">    ISO_FILENAME=&quot;$&#123;ROOTFS_DIR&#125;.iso&quot;</span><br><span class="line">    CDROM_DIR=&quot;$&#123;ROOTFS_DIR&#125;-cdrom&quot;</span><br><span class="line"></span><br><span class="line">    sudo rm -rf $&#123;CDROM_DIR&#125;</span><br><span class="line">    mkdir -pv $&#123;CDROM_DIR&#125;/&#123;casper,boot/grub,EFI/BOOT&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝 内核 和 initrd</span><br><span class="line">    if [ -f $&#123;ROOTFS_DIR&#125;/boot/vmlinuz ] &amp;&amp; [ -f $&#123;ROOTFS_DIR&#125;/boot/initrd.img ]; then</span><br><span class="line">        # 标准内核情况</span><br><span class="line">        sudo cp -v $&#123;ROOTFS_DIR&#125;/boot/vmlinuz $&#123;CDROM_DIR&#125;/casper/vmlinuz</span><br><span class="line">        sudo cp -v $&#123;ROOTFS_DIR&#125;/boot/initrd.img $&#123;CDROM_DIR&#125;/casper/initrd.lz</span><br><span class="line">    else</span><br><span class="line">        # 没有内核软链接文件的情况</span><br><span class="line">        VMLINUXZ=$(sudo find $&#123;ROOTFS_DIR&#125;/boot -name &quot;vmlinuz*&quot; | head -n1)</span><br><span class="line">        INITRD_IMG=$(sudo find $&#123;ROOTFS_DIR&#125;/boot -name &quot;initrd*&quot; | head -n1)</span><br><span class="line">        sudo cp -v $&#123;VMLINUXZ&#125; $&#123;CDROM_DIR&#125;/casper/vmlinuz</span><br><span class="line">        sudo cp -v $&#123;INITRD_IMG&#125; $&#123;CDROM_DIR&#125;/casper/initrd.lz</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; mksquash&quot;</span><br><span class="line">    [ -f $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs ] &amp;&amp; sudo rm -rf $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs</span><br><span class="line">    [ -f $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs ] || sudo mksquashfs $&#123;ROOTFS_DIR&#125; $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs -quiet # -comp xz -no-progress</span><br><span class="line">    printf $(sudo du -sx --block-size=1 $&#123;ROOTFS_DIR&#125; | cut -f1) &gt;$&#123;CDROM_DIR&#125;/casper/filesystem.size</span><br><span class="line"></span><br><span class="line">    # iso grub菜单项</span><br><span class="line">    cat &gt;$&#123;CDROM_DIR&#125;/boot/grub/grub.cfg &lt;&lt;EOF</span><br><span class="line">set default=0</span><br><span class="line">set timeout=3</span><br><span class="line"></span><br><span class="line">set color_normal=white/black</span><br><span class="line">set color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">menuentry &quot;install openkylin&quot; &#123;</span><br><span class="line">    linux   /casper/vmlinuz boot=casper only-ubiquity locale=zh_CN quiet splash</span><br><span class="line">    initrd  /casper/initrd.lz</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    if [ &quot;$&#123;VK_ARCH&#125;&quot; = &quot;arm64&quot; ]; then</span><br><span class="line">        EFINAME=&quot;bootaa64.efi&quot;</span><br><span class="line">    elif [ &quot;$&#123;VK_ARCH&#125;&quot; = &quot;amd64&quot; ]; then</span><br><span class="line">        EFINAME=&quot;bootx64.efi&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # efi</span><br><span class="line">    if [ -f &quot;$&#123;CURRENT_DIR&#125;/$&#123;EFINAME&#125;&quot; ]; then</span><br><span class="line">        cp -v $&#123;CURRENT_DIR&#125;/$&#123;EFINAME&#125; $&#123;CDROM_DIR&#125;/EFI/BOOT/$&#123;EFINAME&#125;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=$&#123;CDROM_DIR&#125;/boot/grub/efi.img bs=1M count=10</span><br><span class="line">    mkfs.vfat $&#123;CDROM_DIR&#125;/boot/grub/efi.img</span><br><span class="line">    mmd -i $&#123;CDROM_DIR&#125;/boot/grub/efi.img efi efi/boot</span><br><span class="line">    mcopy -i $&#123;CDROM_DIR&#125;/boot/grub/efi.img $&#123;CDROM_DIR&#125;/EFI/BOOT/$&#123;EFINAME&#125; ::efi/boot/</span><br><span class="line"></span><br><span class="line">    [ -d $&#123;CURRENT_DIR&#125;/config/cdrom ] &amp;&amp; cp -r $&#123;CURRENT_DIR&#125;/config/cdrom/. $&#123;CDROM_DIR&#125;</span><br><span class="line"></span><br><span class="line">    sudo mkisofs -input-charset utf-8 -J -r -V openKylin -eltorito-alt-boot -e boot/grub/efi.img -no-emul-boot -o $&#123;ISO_FILENAME&#125; $&#123;CDROM_DIR&#125;</span><br><span class="line">    md5sum &quot;$&#123;ISO_FILENAME&#125;&quot; &gt;&quot;$&#123;ISO_FILENAME&#125;&quot;.md5</span><br><span class="line">    cp -rf &quot;$&#123;ISO_FILENAME&#125;&quot;* ..</span><br><span class="line">    cp -rf ./*.deblist ..</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;ISO_FILENAME&#125;* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 $&#123;VK_CURRENT_TASK&#125; 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125; 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体硬件构建"><a class="markdownIt-Anchor" href="#具体硬件构建"></a> 具体硬件构建</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br></pre></td><td class="code"><pre><span class="line">COPY# 双椒派 镜像</span><br><span class="line">function do_img_chilliepi() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">    do_config</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 128 + 2048))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line"></span><br><span class="line">    # boot分区</span><br><span class="line">    sgdisk -n 0:0:+128M -c 0:boot &quot;$&#123;IMAGE_FILE&#125;&quot; &gt;/dev/null</span><br><span class="line">    # 根分区</span><br><span class="line">    sgdisk -n 0:0:0 -c 0:root &quot;$&#123;IMAGE_FILE&#125;&quot; &gt;/dev/null</span><br><span class="line"></span><br><span class="line">    # sgdisk -p &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    yes | sudo mkfs.vfat -n BOOT $&#123;LOOP_DEV&#125;p1</span><br><span class="line">    yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;LOOP_DEV&#125;p2</span><br><span class="line"></span><br><span class="line">    part1_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p1)</span><br><span class="line">    part2_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p2)</span><br><span class="line"></span><br><span class="line">    echo part1_uuid=$&#123;part1_uuid&#125;</span><br><span class="line">    echo part2_uuid=$&#123;part2_uuid&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝文件</span><br><span class="line">    mkdir -p &#123;p1,p2&#125;</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p1 ./p1/</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p2 ./p2/</span><br><span class="line"></span><br><span class="line">    # copy boot</span><br><span class="line">    sudo cp -v -rf -a $&#123;ROOTFS_DIR&#125;/boot/. ./p1/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./p2/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee ./p2/etc/fstab &lt;&lt;EOF</span><br><span class="line">UUID=$&#123;part2_uuid&#125;   /           ext4    rw,relatime 0 1</span><br><span class="line">UUID=$&#123;part1_uuid&#125;   /boot       vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo umount ./p1 ./p2</span><br><span class="line">    rmdir p1 p2</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 树莓派 4B</span><br><span class="line">function do_img_rpi4b() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 128 + 1024))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mktable msdos</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mkpart primary fat32 1MiB 128MiB</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mkpart primary ext4 128MiB 100%</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; set 1 boot on</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    yes | sudo mkfs.vfat -n BOOT -F 32 $&#123;LOOP_DEV&#125;p1</span><br><span class="line">    yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;LOOP_DEV&#125;p2</span><br><span class="line"></span><br><span class="line">    part1_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p1)</span><br><span class="line">    part2_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p2)</span><br><span class="line"></span><br><span class="line">    echo part1_uuid=$&#123;part1_uuid&#125;</span><br><span class="line">    echo part2_uuid=$&#123;part2_uuid&#125;</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p2 $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p1 $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./$&#123;ROOT_TARGET&#125;/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/etc/fstab &lt;&lt;EOF</span><br><span class="line">UUID=$&#123;part2_uuid&#125;   /           ext4    rw,relatime 0 1</span><br><span class="line">UUID=$&#123;part1_uuid&#125;   /boot       vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # copy boot</span><br><span class="line">    git clone https://gitee.com/openkylin/bootfiles-embedded.git</span><br><span class="line">    sudo cp -v -rf ./bootfiles-embedded/rpi4b/boot/. ./$&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    sudo tee ./$&#123;ROOT_TARGET&#125;/boot/cmdline.txt &lt;&lt;EOF</span><br><span class="line">console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 root=/dev/mmcblk0p2 rootfstype=ext4 rootwait</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo tee ./$&#123;ROOT_TARGET&#125;/boot/config.txt &lt;&lt;EOF</span><br><span class="line">[all]</span><br><span class="line">kernel=vmlinuz-5.15.92-v8+</span><br><span class="line">cmdline=cmdline.txt</span><br><span class="line"></span><br><span class="line">[pi4]</span><br><span class="line">max_framebuffers=2</span><br><span class="line">arm_boost=1</span><br><span class="line">dtoverlay=vc4-fkms-v3d</span><br><span class="line"></span><br><span class="line">[all]</span><br><span class="line">dtparam=audio=on</span><br><span class="line">dtparam=i2c_arm=on</span><br><span class="line">dtparam=spi=on</span><br><span class="line">disable_overscan=1</span><br><span class="line">dtoverlay=vc4-kms-v3d</span><br><span class="line">dtoverlay=dwc2</span><br><span class="line">camera_auto_detect=1</span><br><span class="line">display_auto_detect=1</span><br><span class="line">arm_64bit=1</span><br><span class="line">dtparam=audio=on</span><br><span class="line">enable_uart=1</span><br><span class="line">enable_gic=1</span><br><span class="line">dtoverlay=pi3-miniuart-bt</span><br><span class="line">force_turbo=1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sync</span><br><span class="line"></span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function do_img_vf2() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 64 + 256))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line"></span><br><span class="line">    sgdisk --clear --set-alignment=2 \</span><br><span class="line">        --new=1:4096:8191 --change-name=1:spl --typecode=1:2E54B353-1271-4842-806F-E436D6AF6985 \</span><br><span class="line">        --new=2:8192:16383 --change-name=2:uboot --typecode=2:BC13C2FF-59E6-4262-A352-B275FD6F7172 \</span><br><span class="line">        --new=3:16384:+64M --change-name=3:system --typecode=3:EBD0A0A2-B9E5-4433-87C0-68B6B72699C7 \</span><br><span class="line">        --new=4:0:-0 --change-name=4:rootfs --typecode=4:0x8300 \</span><br><span class="line">        &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # spl and uboot for vf2</span><br><span class="line">    U_BOOT_SPL=&quot;https://www.openkylin.top/public/software/Embedded/visionfive2/u-boot-spl.bin.normal.out&quot;</span><br><span class="line">    U_BOOT_FILE=&quot;https://www.openkylin.top/public/software/Embedded/visionfive2/visionfive2_fw_payload.img&quot;</span><br><span class="line">    wget -qO- $&#123;U_BOOT_SPL&#125; | sudo dd of=$&#123;LOOP_DEV&#125;p1 status=progress</span><br><span class="line">    wget -qO- $&#123;U_BOOT_FILE&#125; | sudo dd of=$&#123;LOOP_DEV&#125;p2 status=progress</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    sudo mkfs.vfat $&#123;LOOP_DEV&#125;p3</span><br><span class="line">    sudo mkfs.ext4 $&#123;LOOP_DEV&#125;p4</span><br><span class="line">    sudo dosfslabel $&#123;LOOP_DEV&#125;p3 BOOT</span><br><span class="line">    sudo e2label $&#123;LOOP_DEV&#125;p4 ROOT</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    # mount root partition</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p4 $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p3 $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./$&#123;ROOT_TARGET&#125;/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/etc/fstab &lt;&lt;EOF</span><br><span class="line"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt; </span><br><span class="line">LABEL=ROOT  /               ext4    errors=remount-ro 0       1</span><br><span class="line">LABEL=BOOT  /boot           vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # uEnv.txt</span><br><span class="line">    echo &quot;---&gt; generate uEnv.txt&quot;</span><br><span class="line">    sudo tee &quot;$&#123;ROOT_TARGET&#125;&quot;/boot/uEnv.txt &lt;&lt;EOF</span><br><span class="line">fdt_high=0xffffffffffffffff</span><br><span class="line">initrd_high=0xffffffffffffffff</span><br><span class="line">kernel_addr_r=0x44000000</span><br><span class="line">kernel_comp_addr_r=0x90000000</span><br><span class="line">kernel_comp_size=0x10000000</span><br><span class="line">fdt_addr_r=0x48000000</span><br><span class="line">ramdisk_addr_r=0x48100000</span><br><span class="line"># Move distro to first boot to speed up booting</span><br><span class="line">boot_targets=distro mmc0 dhcp</span><br><span class="line"># Fix wrong fdtfile name</span><br><span class="line">fdtfile=starfive/jh7110-visionfive-v2.dtb</span><br><span class="line"># Fix missing bootcmd</span><br><span class="line">#bootcmd=run load_distro_uenv;run bootcmd_distro</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo touch &quot;$&#123;ROOT_TARGET&#125;&quot;/boot/vf2_uEnv.txt</span><br><span class="line"></span><br><span class="line">    # extlinux.conf</span><br><span class="line">    echo &quot;---&gt; generate extlinux.conf&quot;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot/extlinux</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/boot/extlinux/extlinux.conf &lt;&lt;EOF</span><br><span class="line">default openkylin</span><br><span class="line">menu title openkylin</span><br><span class="line">prompt 0</span><br><span class="line">timeout 50</span><br><span class="line"></span><br><span class="line">label openkylin</span><br><span class="line">	menu label openkylin</span><br><span class="line">	linux /vmlinuz-5.10.79+</span><br><span class="line">	initrd /initrd.img-5.10.79+</span><br><span class="line">	</span><br><span class="line">	fdtdir /dtbs</span><br><span class="line">	append  root=/dev/mmcblk1p4 rw rootwait console=ttyS0,115200 earlycon rootwait</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # umount</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function do_img_lotus2() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    MY_LOG_EXEC &quot;sudo tar zcf $&#123;ROOTFS_DIR&#125;.tar.gz -C $&#123;ROOTFS_DIR&#125; .&quot;</span><br><span class="line">    md5sum $&#123;ROOTFS_DIR&#125;.tar.gz &gt;$&#123;ROOTFS_DIR&#125;.tar.gz.md5</span><br><span class="line">    cp -rf $&#123;ROOTFS_DIR&#125;.tar.gz* ..</span><br><span class="line">    popd</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 飞腾派</span><br><span class="line">function do_img_phytiumpi() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; use $&#123;VK_UBOOT_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 1024))</span><br><span class="line"></span><br><span class="line">    # 文件系统放在ext4文件中</span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;ROOTFS_DIR&#125;.ext4&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line">    # 格式化ext4</span><br><span class="line">    MY_LOG_EXEC &quot;yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;ROOTFS_DIR&#125;.ext4&quot;</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo mount $&#123;ROOTFS_DIR&#125;.ext4 $&#123;ROOT_TARGET&#125;&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. $&#123;ROOT_TARGET&#125;&quot;</span><br><span class="line"></span><br><span class="line">    sync</span><br><span class="line"></span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line"></span><br><span class="line">    # 安装uboot</span><br><span class="line">    echo &quot;---&gt; install uboot&quot;</span><br><span class="line">    (</span><br><span class="line">        # 先删除旧的</span><br><span class="line">        rm -rf ./phyitum-pi/</span><br><span class="line"></span><br><span class="line">        mkdir -p ./phyitum-pi/resource</span><br><span class="line">        cp -v $&#123;ROOTFS_DIR&#125;/boot/vmlinuz ./phyitum-pi/resource/vmlinuz</span><br><span class="line"></span><br><span class="line">        cd ./phyitum-pi/resource</span><br><span class="line">        wget -R &quot;index.html*,*.deb&quot; -r -np -nd http://factory.openkylin.top/kif/archive/get/repos/phyitumpi/pool/</span><br><span class="line"></span><br><span class="line">        # mkimage 依赖 上面拷贝的vmlinuz文件</span><br><span class="line">        mkimage -f ./edu.its ./uImage.itd</span><br><span class="line"></span><br><span class="line">        # cp -v $&#123;VK_UBOOT_FILE&#125; fip.bin</span><br><span class="line">        # dd if=./uImage.itd of=./fip.bin bs=1M seek=4</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./phyitum-pi/resource/$&#123;VK_UBOOT_FILE&#125; of=$&#123;IMAGE_FILE&#125; conv=notrunc&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./phyitum-pi/resource/uImage.itd of=$&#123;IMAGE_FILE&#125; bs=1M seek=4 conv=notrunc&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./$&#123;ROOTFS_DIR&#125;.ext4 of=$&#123;IMAGE_FILE&#125; bs=1M seek=64 conv=notrunc&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; success&quot;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="构建自己的脚本"><a class="markdownIt-Anchor" href="#构建自己的脚本"></a> 构建自己的脚本</h1>
<blockquote>
<p>我的目的也只是想要构建一个文件系统，由于ubuntu24上才能构建成功base，所以我就在一个基础包上构建即可。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COPYapt install -y apt-utils kmod kbd whiptail locales \</span><br><span class="line">	systemd-resolved vim lsof cpio file sudo tree wget rsync \</span><br><span class="line">	fdisk gdisk parted psmisc rsyslog dosfstools lsb-release archdetect-deb \</span><br><span class="line">	bash-completion zstd iputils-ping iproute2 net-tools network-manager \</span><br><span class="line">	wpasupplicant openssh-server openssh-client xinit lightdm xdg-user-dirs </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apt install ukui-control-center ukui-desktop-environment ukui-desktop-environment-core \</span><br><span class="line">	ukui-greeter openkylin-wallpapers ukui-globaltheme-heyin libukuiinputgatherclient1 \</span><br><span class="line">	 ukui-notebook \</span><br><span class="line"> 	kylin-daq kylin-app-manager</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	apt install xserver-xorg-video-fbdev xserver-xorg-input-all 	libqt5sql5-sqlite onboard python3-xdg remmina remmina-plugin-vnc network-manager-gnome </span><br></pre></td></tr></table></figure>
<p>openkylin-anything.list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYdeb http://ppa.build.openkylin.top/kylinsoft/anything2.0/openkylin/ nile main</span><br></pre></td></tr></table></figure>
<p>openkylin-software.list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYdeb http://software.openkylin.top/openkylin/ nile main all    </span><br></pre></td></tr></table></figure>
<p>问题解决了，使用官方的构建脚本的话会出现几个问题，首先呢源不对，要将源换成2.0的开放麒麟源，再然后呢需要将apt的整个目录换掉，最后有个deb包是装不上的，需要手动装一下，这样才是真的成功，然后呢，我已经构建成功迅为的开放麒麟镜像了，现在开始研究一下官方构建步骤的楼层</p>
<h1 id="构建流程"><a class="markdownIt-Anchor" href="#构建流程"></a> 构建流程</h1>
<p>直接输入./okbuild.sh而不添加任何参数会打印usage，说明该脚本总共支持的平台，以及各个平台的编译步骤，这里使用树莓派的编译命令，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY./okbuild.sh -p prop_rpi4b </span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026406.png" alt="image-20240817151602795" />image-20240817151602795</p>
<p>这个命令总共有两个参数，分别为-p选项和prop_rpi4b 参数，其实在shell脚本里，这些都属于参数，写下来的内容呢就是对这两个参数进行判断，然后赋值，具体内容会将prop_rpi4b 赋值给PROP，CONF默认值为openkylin，再然后读取了prop配置文件的值，该文件的值接下来会进行逐个判定，先列一下该配置文件的具体内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 版本状态</span><br><span class="line">VK_VERSION=&quot;1.0.2&quot;</span><br><span class="line"># 主板标识</span><br><span class="line">VK_BOARD=&quot;rpi4b&quot;</span><br><span class="line"># 架构</span><br><span class="line">VK_ARCH=&quot;arm64&quot;</span><br><span class="line"># 执行顺序</span><br><span class="line">VK_ORDER=&quot;order_rpi4b&quot;</span><br><span class="line"></span><br><span class="line"># 执行任务</span><br><span class="line">VK_TASKS=&quot;rootfs,config,img_rpi4b&quot;</span><br><span class="line"></span><br><span class="line">VK_UPDATE=&quot;y&quot;</span><br><span class="line">VK_KEEP_IMAGE_DIR=&quot;n&quot;</span><br></pre></td></tr></table></figure>
<p>最后会将这些值导入，这里最重要的是VK_TASKS，在okbuild.sh中，他的最后会依次执行rootfs,config,img_rpi4b，也就是do_rootfs函数、do_config函数，以及do_img_rpi4b函数，do_rootfs函数很简单，就是构建了一个最小文件系统，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">COPYfunction do_rootfs() &#123;</span><br><span class="line">    # 先删除 原有 rootfs 目录</span><br><span class="line">    if [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.done&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        MY_LOG_EXEC &quot;sudo rm -rf $&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # debootstrap 参数</span><br><span class="line">        DEBOOTSTRAP_ARGS=&quot;--no-check-gpg --variant=minbase --arch=$&#123;VK_ARCH&#125; --components=main --include=openkylin-keyring,systemd-sysv $&#123;VK_SUITE&#125; $&#123;ROOTFS_DIR&#125; $&#123;VK_MIRROR&#125; gutsy&quot;</span><br><span class="line"></span><br><span class="line">        # 制作 rootfs</span><br><span class="line">        MY_LOG_EXEC &quot;sudo debootstrap $&#123;DEBOOTSTRAP_ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 记录基础rootfs的包列表，给第2步升级包版本用</span><br><span class="line">        # sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27; &gt; /rootfs.deblist&quot;</span><br><span class="line">        # cp &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line">        sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27;&quot; &gt;&quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line"></span><br><span class="line">        sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/archives/*.deb</span><br><span class="line">        if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/*.bin</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Packages</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_InRelease</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Translation*</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/root/.bash_history</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/tmp/*</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # rootfs制作完成</span><br><span class="line">        MY_LOG_EXEC &quot;touch $&#123;ROOTFS_DIR&#125;.done&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来do_config</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">COPY</span><br><span class="line"># 进入根文件系统进行安装、配置</span><br><span class="line">function do_config() &#123;</span><br><span class="line">    # 需要升级基础rootfs</span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ] &amp;&amp; [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.rootfs-update.deblist&quot; ]; then</span><br><span class="line">        MY_LOG_EXEC &quot;sudo cp -v $&#123;ROOTFS_DIR&#125;.rootfs.deblist $&#123;ROOTFS_DIR&#125;/rootfs.deblist&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 挂载</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    mount_host_to_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝配置到 $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo mkdir -p $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo cp -v $&#123;CURRENT_DIR&#125;/config/*.sh $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">    if [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        sudo cp -r $&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/. $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">        # 制作</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; /usr/bin/env -i \</span><br><span class="line">            PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \</span><br><span class="line">            HOME=/root \</span><br><span class="line">            LC_ALL=C \</span><br><span class="line">            DEBIAN_FRONTEND=noninteractive \</span><br><span class="line">            APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=DontWarn \</span><br><span class="line">            bash -euo pipefail /config/main.sh &quot;$(set | grep &quot;^VK_&quot; | xargs)&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#x27;config/$&#123;CONF&#125;&#x27; not exits!&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 卸载</span><br><span class="line">    umount_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 参考分析用</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    # sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/config $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; == &quot;config&quot; ]; then</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.deblist</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 删除 update 包列表</span><br><span class="line">    if [ -f &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist ]; then</span><br><span class="line">        cp -v &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist</span><br><span class="line">    fi</span><br><span class="line">    sudo rm -v -rf &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs*.deblist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他这里就很灵性，亦或者很取巧，他把config目录整个搬进去了，这样直接在chroot环境运行，这肯定没啥问题，我就没想到这个地方，虽然这属于一个很简单的地方，果然是不传递的，之前的想发也就不对了，在ubuntu上定义的环境变量，是不会进入到chroot的环境中的，如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026448.png" alt="image-20240817154352321" />image-20240817154352321</p>
<table>
<thead>
<tr>
<th>对传入的两个参数进行判断</th>
<th>将prop_rpi4b 赋值给PROP</th>
<th>读取prop配置文件值，并导入进环境变量</th>
<th>根据VK_TASKS值进行任务逐个执行</th>
<th>首先执行do_rootfs</th>
<th>然后执行do_config</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>至此对于流程就大致分析完成了，确实挺简单的，就是一些shell脚本的语法还不是很熟悉，但也就这样了，开放麒麟的构建就这样了，后续也没啥东西了，ok，那就先这样。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/15_rk 内核镜像构建"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/11/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/15_rk%20%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/"
    >RK内核镜像构建</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/11/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/15_rk%20%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/" class="article-date">
  <time datetime="2024-08-11T09:17:03.000Z" itemprop="datePublished">2024-08-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>我只是想到，单纯的看视频并没有什么用，我现在认为实践是检验真理的唯一标准。</p>
<p>先来看编译的过程：</p>
<p>实际的编译命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make -C kernel/ -j33 CROSS_COMPILE=/home/topeet/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64 rockchip_linux_defconfig rk3588_linux.config</span><br><span class="line"></span><br><span class="line">make -C kernel/ -j33 CROSS_COMPILE=/home/topeet/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64 topeet-rk3588-linux.img</span><br><span class="line">/home/topeet/rk3588-linux/device/rockchip/common/scripts/mk-fitimage.sh kernel/boot.img /home/topeet/rk3588-linux/kernel/boot.its kernel/arch/arm64/boot/Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">make -j33 CROSS_COMPILE=/home/topeet/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64</span><br></pre></td></tr></table></figure>
<p>内核镜像的生成过程以及后续压缩成 <code>Image.gz</code> 的过程可以分为以下几个步骤：</p>
<h3 id="image-生成过程"><a class="markdownIt-Anchor" href="#image-生成过程"></a> Image 生成过程</h3>
<ol>
<li><strong>配置内核</strong>
<ul>
<li>使用 <code>make menuconfig</code> 或其他配置工具选择适当的内核选项。</li>
<li>配置文件通常保存为 <code>.config</code>。</li>
</ul>
</li>
<li><strong>编译内核</strong>
<ul>
<li>运行 <code>make</code> 命令，开始编译内核。</li>
<li>编译过程主要包括：
<ul>
<li><strong>预处理</strong>：解析头文件和宏定义。</li>
<li><strong>编译</strong>：将 C 语言代码编译为汇编。</li>
<li><strong>汇编</strong>：将汇编代码转换为目标代码。</li>
<li><strong>链接</strong>：将目标文件链接为单个内核镜像 <code>vmlinux</code>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>生成 Image</strong>
<ul>
<li><code>vmlinux</code> 是一个未压缩的 ELF 格式文件。</li>
<li>通过 <code>objcopy</code> 工具，将 <code>vmlinux</code> 转换为可加载的 <code>Image</code> 格式（通常是裸数据格式）。</li>
</ul>
</li>
</ol>
<h3 id="imagegz-生成过程"><a class="markdownIt-Anchor" href="#imagegz-生成过程"></a> Image.gz 生成过程</h3>
<ol>
<li><strong>压缩内核</strong>
<ul>
<li>使用 <code>gzip</code> 工具压缩 <code>Image</code> 文件，生成 <code>Image.gz</code>。</li>
<li>压缩后的文件更小，方便传输和存储。</li>
</ul>
</li>
<li><strong>安装内核（可选）</strong>
<ul>
<li>将 <code>Image.gz</code> 复制到引导加载程序可访问的目录。</li>
<li>更新引导加载程序配置以加载新的内核。</li>
</ul>
</li>
</ol>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<ul>
<li><strong>Image</strong> 是内核的未压缩版本，适合直接加载。</li>
<li><strong>Image.gz</strong> 是压缩版本，适合节省空间。</li>
</ul>
<p>这种流程适用于大多数 Linux 内核的构建和压缩过程。具体步骤可能根据不同的硬件平台和配置选项有所调整。</p>
<p>wsl.exe --system -d Ubuntu-22.04 df -h /mnt/wslg/distro</p>
<p>列出已经安装的发行版镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --list --verbose</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408092111207.png" alt="image-20240809211103188" /></p>
<p>注销Linux发行版</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --unregister &lt;DistributionName&gt;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-06_工作记录/24_工作记录(八月第二个星期)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/03/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/24_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E5%85%AB%E6%9C%88%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%98%9F%E6%9C%9F)/"
    >工作记录((8月第2个星期)</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/03/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/24_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E5%85%AB%E6%9C%88%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-date">
  <time datetime="2024-08-03T13:26:56.000Z" itemprop="datePublished">2024-08-03</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="810工作记录"><a class="markdownIt-Anchor" href="#810工作记录"></a> 8.10工作记录</h1>
<h3 id="解锁rk3568潜力多屏显示功能全面解析"><a class="markdownIt-Anchor" href="#解锁rk3568潜力多屏显示功能全面解析"></a> 解锁RK3568潜力：多屏显示功能全面解析</h3>
<p>RK3568作为瑞芯微公司推出的一款高性能、多媒体应用处理器，凭借其卓越的性能和丰富的外设接口，迅速在嵌入式开发领域占据一席之地，成为广告机、电子看板、会议系统等多种应用场景的理想选择。</p>
<p>随着RK3568的广泛应用，越来越多的开发者和企业开始关注其“多屏显示”功能。那究竟如何解锁RK3568在多屏显示方面的全部潜力呢？下面我们将对RK3568多屏显示的应用场景和具体实现步骤进行讲解。</p>
<h4 id="rk3568多屏显示应用领域"><a class="markdownIt-Anchor" href="#rk3568多屏显示应用领域"></a> RK3568多屏显示应用领域</h4>
<p>RK3568的多屏显示功能不仅适用于广告机和信息发布系统，还在工业控制、智能家居、多媒体教学等多个领域展现出强大的应用潜力，提供了灵活的显示解决方案。</p>
<ul>
<li><strong>工业监控</strong>：实现多监控画面的独立显示，关键设备数据和监控视频同步展示，助力精准管理与决策。</li>
<li><strong>智能家居</strong>：家庭安全监控与能源管理系统数据同步显示，提升家庭管理的便捷性与直观性。</li>
<li><strong>多媒体教学</strong>：主屏播放教学内容，副屏展示互动信息，增强课堂互动效果。</li>
<li><strong>数字标牌与广告展示</strong>：多屏展示不同广告内容，更有效地吸引观众，提升信息传达效率。</li>
<li><strong>医疗影像显示</strong>：同步显示不同类型影像，提高诊断的准确性与效率。</li>
</ul>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408101726573.png" alt="image-20240810172635440" /></p>
<h4 id="rk3568多屏显示设置步骤"><a class="markdownIt-Anchor" href="#rk3568多屏显示设置步骤"></a> RK3568多屏显示设置步骤</h4>
<p>在Rockchip平台中，LCD控制器称为VOP（Video Output Processor），即视频输出处理器。VOP的主要功能是负责从存储器中的帧缓冲区读取图像数据，并将这些数据传输到显示设备，而在VOP模块的后端又设计了多路独立的Video Port，每个Video Port都可以独立处理并输出视频信号，RK3568 Video Port与各显示接口的连接关系如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408121438604.png" alt="image-20240812143644592" /></p>
<p>从上图可知在RK3568 SOC上有着三个Video Ports，所以RK3568最多可以同时输出三路视频信号，从而实现双屏、三屏的同显和异显，而iTOP-RK3568显示接口如下图所示：</p>
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408121446905.jpg" alt="img" style="zoom:200%;" />
<p>结合RK3568 Video Port与各显示接口的连接关系和iTOP-RK3568显示相关接口，可以得到如下的双屏方案和三屏方案：</p>
<p>双屏方案：</p>
<table>
<thead>
<tr>
<th>方案编号</th>
<th>显示屏组合</th>
</tr>
</thead>
<tbody>
<tr>
<td>方案一</td>
<td>MIPI屏幕 + LVDS7寸屏</td>
</tr>
<tr>
<td>方案二</td>
<td>MIPI屏幕 + LVDS10.1寸1024X600屏</td>
</tr>
<tr>
<td>方案三</td>
<td>MIPI屏幕 + LVDS10.1寸1280X800屏</td>
</tr>
<tr>
<td>方案四</td>
<td>MIPI屏幕 + HDMI屏</td>
</tr>
<tr>
<td>方案五</td>
<td>MIPI屏幕 + VGA屏</td>
</tr>
<tr>
<td>方案六</td>
<td>LVDS7寸屏 + VGA屏</td>
</tr>
<tr>
<td>方案七</td>
<td>LVDS7寸屏 + HDMI屏</td>
</tr>
<tr>
<td>方案八</td>
<td>LVDS10.1寸1024X600屏 + HDMI屏</td>
</tr>
<tr>
<td>方案九</td>
<td>LVDS10.1寸1024X600屏 + VGA屏</td>
</tr>
<tr>
<td>方案十</td>
<td>LVDS10.1寸1280X800屏 + HDMI屏</td>
</tr>
<tr>
<td>方案十一</td>
<td>LVDS10.1寸1280X800屏 + VGA屏</td>
</tr>
<tr>
<td>方案十二</td>
<td>HDMI屏 + VGA屏</td>
</tr>
</tbody>
</table>
<p>三屏方案：</p>
<table>
<thead>
<tr>
<th>方案编号</th>
<th>显示屏组合</th>
</tr>
</thead>
<tbody>
<tr>
<td>方案一</td>
<td>MIPI屏幕 + LVDS7寸屏 + HDMI屏</td>
</tr>
<tr>
<td>方案二</td>
<td>MIPI屏幕 + LVDS7寸屏 + VGA屏</td>
</tr>
<tr>
<td>方案三</td>
<td>MIPI屏幕 + LVDS10.1寸1280X800屏 + VGA屏</td>
</tr>
<tr>
<td>方案四</td>
<td>MIPI屏幕 + LVDS10.1寸1280X800屏 + HDMI屏</td>
</tr>
<tr>
<td>方案五</td>
<td>MIPI屏幕 + LVDS10.1寸1024X600屏 + VGA屏</td>
</tr>
<tr>
<td>方案六</td>
<td>MIPI屏幕 + LVDS10.1寸1024X600屏 + HDMI屏</td>
</tr>
<tr>
<td>方案七</td>
<td>LVDS7寸屏 + VGA屏 + HDMI屏</td>
</tr>
<tr>
<td>方案八</td>
<td>LVDS10.1寸1280X800屏 + VGA屏 + HDMI屏</td>
</tr>
<tr>
<td>方案九</td>
<td>LVDS10.1寸1024X600屏 + VGA屏 + HDMI屏</td>
</tr>
</tbody>
</table>
<p>而为了帮助用户更容易的实现多屏显示，迅为对设备树进行了优化，将每个屏幕的使能设计成了宏定义的形式，具体定义在topeet_screen_choose.dtsi设备树中，该设备树具体内容如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408121515089.png" alt="image-20240812151547040" /></p>
<p>想要实现多屏显示，只需要根据需求打开对应的宏定义即可，例如要想实现HDMI屏+VGA屏双屏显示，需要打开VGA和HDMI的宏（==需要是不同的VP==），修改完成如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408121522350.png" alt="image-20240812152247311" /></p>
<p>​	而要想实现MIPI屏幕+LVDS7寸屏+HDMI屏三屏显示，只需要打开MIPI、LVDS和HDMI三个宏定义即可(==需要是不同的VP==),修改完成如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408121539601.png" alt="image-20240812153949544" /></p>
<p>​	设备树修改完成之后，重新编译内核镜像，烧写到开发板即可实现多屏显示。</p>
<h4 id="rk3568多屏显示实例演示"><a class="markdownIt-Anchor" href="#rk3568多屏显示实例演示"></a> RK3568多屏显示实例演示</h4>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1SR4y1S7G7/">https://www.bilibili.com/video/BV1SR4y1S7G7/</a></p>
<p>==多屏异显的具体实现方法可参考《19【北京迅为】itop-3568 开发板多屏显示手册 【底板1.7版】v1.1.doc》==</p>
<p>官网：<a target="_blank" rel="noopener" href="http://www.topeetboard.com/">http://www.topeetboard.com/</a></p>
<p>销售工程师：010-8527-0708 转接 1</p>
<p>技术支持类：010-8527-0708 转接 2</p>
<p>方案定制类：010-8527-0708 转接 3</p>
<h1 id="812-工作记录星期一"><a class="markdownIt-Anchor" href="#812-工作记录星期一"></a> 8.12 工作记录(星期一)</h1>
<p>现在我就只有一个追求了，那就是顺心意，之前的行为啊，其实就是想的太多了，就比如前面努力提高自己的计算机水平，这本身来说就是一个点缀，而不能成为一个终极追求，还是顺心意最适合我，其实顺心意这个东西，包含了很多很多，就像心变，就像心流，聚精会神的做自己想要做的事情，不在意时间的流逝，一眨眼，再一回头，就发现原来我们已经走了这么长的路了啊，想想就感觉很幸福。</p>
<p>今天就尽可能的戴着耳塞和耳机了，其实我要做的就是寻找自己最合适的状态，我发现四处都很安静，或者也不是，或许正是这种封闭双耳的感觉让我很是沉浸，还有另一种情况，那就是戴着耳机听音乐的时候，那也很沉浸，但是呢，得看是什么状态，如果是工作的时候，戴耳机就不太行了，法师在旁，虽然我的效率确实是高了，但是过不去内心的那一道门槛，所以也就只有中午的时候，以及下午法师录课的时候可以听，其实听不听音乐的不重要，就是想要让自己静心下来，做顺心意的自己，举几个例子，就比如直接问法师我的这个推文哪里有问题，直接拒绝青苹果说的更新的请求，法师这个无所谓，青苹果这个确实是应该的，这件事或许你会不高兴，但是我自己会很高兴，对吧。</p>
<p>忘记时间,</p>
<hr />
<p>然后来看今天的任务了，今天肯定是要写完推文的，推文的内容框架上面已经写了，现在欠缺的就是技术性的内容，法师说的是可以直接复制手册上的一些内容，我认为不该如此，这肯定是存在问题的，慢慢解决呗。</p>
<p>RK3568多屏异显设置步骤，我的想法是先讲一下VOP，也就是果姐姐写的那个，讲解一下显示原理，然后是我们在这个基础上又做了哪些东西，最后才是具体的多屏显示步骤，我认为这个想法很不错，用通俗易懂的说法，来解释明白。</p>
<table>
<thead>
<tr>
<th>显示接口</th>
<th>最大支持分辨率</th>
<th>支持格式</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HDMI</strong></td>
<td>4096x2160@60Hz</td>
<td>支持RGB/YUV420（最高支持10位）</td>
</tr>
<tr>
<td><strong>LVDS</strong></td>
<td>1280x800@60Hz</td>
<td>支持RGB（最高支持8位）</td>
</tr>
<tr>
<td><strong>EDP</strong></td>
<td>2560x1600@60Hz</td>
<td>支持RGB（最高支持10位）</td>
</tr>
<tr>
<td><strong>MIPI</strong> (2路)</td>
<td>每通道最大支持1920x1080@60Hz，双MIPI支持2048x1536@60Hz</td>
<td>支持RGB（最高支持8位）</td>
</tr>
<tr>
<td><strong>BT656</strong></td>
<td>支持PAL和NTSC</td>
<td>支持RGB（最高支持8位）</td>
</tr>
<tr>
<td><strong>RGB/BT1120</strong></td>
<td>1920x1080@60Hz</td>
<td>支持RGB（最高支持8位）</td>
</tr>
</tbody>
</table>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-06_工作记录/23_工作记录(八月第一个星期)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/08/02/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/23_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E5%85%AB%E6%9C%88%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%98%9F%E6%9C%9F)/"
    >工作记录((8月第1个星期)</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/02/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/23_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E5%85%AB%E6%9C%88%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-date">
  <time datetime="2024-08-02T13:26:56.000Z" itemprop="datePublished">2024-08-02</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="工作记录星期四"><a class="markdownIt-Anchor" href="#工作记录星期四"></a> 工作记录(星期四)</h1>
<blockquote>
<p>第1章 初步认识I2C</p>
<p>​	1.1 PWM基础知识</p>
<p>​		介绍一下  频率(周期)和占空比  面积等效原理</p>
<p>​	1.2 iTOP-RK3568开发板PWM接口介绍</p>
<p>​		硬件资源、数据手册介绍 (三种工作模式，捕获、连续、单次)、PWM复用关系图</p>
<p>​	1.3 实验外设SG-90舵机介绍</p>
<p>第二章 PWM子系统框架</p>
<p>第三章 使用sysfs接口操作pwm</p>
<p>第四章 pwm控制器注册流程分析</p>
<p>第五章 pwm子系统API框架</p>
<p>第六章 SG90舵机驱动程序</p>
<p>第七章 模拟PWM</p>
<p>​	高精度定时器</p>
<p>第八章 呼吸灯实验</p>
<p>第九章 sysyfs操作pwm原理讲解</p>
<p>第十章 PWM输入捕获驱动实验</p>
</blockquote>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408011330459.png" alt="" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;pwm12 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;active&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pwm12ml_pins&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sg90 &#123;</span><br><span class="line">    compatible = &quot;sg90&quot;;</span><br><span class="line">    pwms = &lt;&amp;pwm12 0 20000000 1&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>节点名称 (<code>sg90</code>)</strong>:</p>
<ul>
<li>表示设备的名称，在这里是 <code>sg90</code>，通常用于标识设备。</li>
</ul>
<p><strong>compatible</strong>:</p>
<ul>
<li><code>compatible = &quot;sg90&quot;;</code></li>
<li>用于指定设备的兼容性字符串，内核会根据这个字符串来匹配合适的驱动程序。</li>
</ul>
<p><strong>pwms</strong>:</p>
<ul>
<li>
<p><code>pwms = &lt;&amp;pwm12 0 20000000 1&gt;;</code></p>
</li>
<li>
<p>配置 PWM 控制器的信息。</p>
<ul>
<li>
<p><code>&amp;pwm12</code>: PWM 控制器的引用。</p>
</li>
<li>
<p><code>0</code>: PWM 通道号。</p>
</li>
<li>
<p><code>20000000</code>: PWM 周期，单位为纳秒（20ms）。</p>
</li>
<li>
<p><code>1</code>: 初始占空比，单位是占空比的百分比（1%）。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pwm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">dev_t</span> dev_num;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev_test</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_device</span> *<span class="title">sg90_pwm_device</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开设备时的回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test open\n&quot;</span>);</span><br><span class="line">    pwm_config(sg90_pwm_device, <span class="number">500000</span>, <span class="number">20000000</span>);    <span class="comment">// 配置 PWM 参数:脉冲宽度为 50000000 纳秒, 周期为 20,000,000 纳秒</span></span><br><span class="line">    pwm_set_polarity(sg90_pwm_device, PWM_POLARITY_NORMAL);    <span class="comment">// 设置 PWM 极性为正常极性</span></span><br><span class="line">    pwm_enable(sg90_pwm_device);    <span class="comment">// 启动 PWM</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入设备时的回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cdev_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> data[<span class="number">1</span>];</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test write\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 从用户空间拷贝数据到内核空间</span></span><br><span class="line">    ret = copy_from_user(data, buf, size);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;copy_from_user failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新 PWM 参数:脉冲宽度根据用户输入的数据调整</span></span><br><span class="line">    pwm_config(sg90_pwm_device, <span class="number">500000</span> + data[<span class="number">0</span>] * <span class="number">100000</span> / <span class="number">9</span>, <span class="number">20000000</span>);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放设备时的回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test release\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pwm_config(sg90_pwm_device, <span class="number">500000</span>, <span class="number">20000000</span>);    <span class="comment">// 回到初始的 PWM 参数配置</span></span><br><span class="line">    pwm_disable(sg90_pwm_device);    <span class="comment">// 停止 PWM</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义字符设备操作函数集合</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = cdev_test_open,</span><br><span class="line">    .write = cdev_test_write,</span><br><span class="line">    .release = cdev_test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备探测函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sg90_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 PWM 设备</span></span><br><span class="line">    sg90_pwm_device = devm_pwm_get(&amp;pdev-&gt;dev, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(sg90_pwm_device)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to get PWM device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(sg90_pwm_device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 申请设备号</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;alloc_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;alloc_chrdev_region is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;alloc_chrdev_region is ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化字符设备</span></span><br><span class="line">    cdev_init(&amp;cdev_test, &amp;cdev_test_ops);</span><br><span class="line">    cdev_test.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    ret = cdev_add(&amp;cdev_test, dev_num, <span class="number">1</span>);<span class="comment">// 添加字符设备</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;test&quot;</span>);    <span class="comment">// 创建设备类</span></span><br><span class="line">    device = device_create(class, <span class="literal">NULL</span>, dev_num, <span class="literal">NULL</span>, <span class="string">&quot;sg90&quot;</span>);    <span class="comment">// 创建设备</span></span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;sg90_probe successful\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备移除函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sg90_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line"></span><br><span class="line">    device_destroy(class, dev_num);    <span class="comment">// 删除设备</span></span><br><span class="line">    class_destroy(class);    <span class="comment">// 删除设备类</span></span><br><span class="line">    cdev_del(&amp;cdev_test);    <span class="comment">// 删除字符设备</span></span><br><span class="line">    unregister_chrdev_region(dev_num, <span class="number">1</span>);    <span class="comment">// 释放设备号</span></span><br><span class="line">    printk(<span class="string">&quot;sg90_remove successful\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备树匹配表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">sg90_of_device_id</span>[] =</span> &#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;sg90&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, sg90_of_device_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义平台驱动</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">sg90_platform_driver</span> =</span> &#123;</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;sg90&quot;</span>,</span><br><span class="line">        .of_match_table = sg90_of_device_id,</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe = sg90_probe,</span><br><span class="line">    .remove = sg90_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">modulecdev_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册平台驱动</span></span><br><span class="line">    ret = platform_driver_register(&amp;sg90_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;platform_driver_register is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;platform_driver_register is ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">modulecdev_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 注销平台驱动</span></span><br><span class="line">    platform_driver_unregister(&amp;sg90_platform_driver);</span><br><span class="line">    printk(<span class="string">&quot;bye bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明模块许可证和作者</span></span><br><span class="line">module_init(modulecdev_init);</span><br><span class="line">module_exit(modulecdev_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="comment">// argc 表示命令行参数的数量,包括程序名本身</span></span><br><span class="line">    <span class="comment">// argv 是一个字符串数组,存储了各个命令行参数</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd;  <span class="comment">// 文件描述符,用于标识打开的设备文件</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">1</span>];  <span class="comment">// 存储要写入设备的单个字节数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果命令行参数个数小于2,说明缺少要写入的值,打印用法并返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;value&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以只写方式打开设备文件&quot;/dev/sg90&quot;</span></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/sg90&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;  <span class="comment">// 打开设备文件失败,输出错误信息并返回错误</span></span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将命令行参数转换为整数,存储在buf[0]中</span></span><br><span class="line">    buf[<span class="number">0</span>] = (<span class="type">unsigned</span> <span class="type">char</span>)atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// 将buf中的1个字节数据写入打开的设备文件</span></span><br><span class="line">    <span class="keyword">if</span> (write(fd, buf, <span class="number">1</span>) != <span class="number">1</span>) &#123;  <span class="comment">// 写入失败,输出错误信息,关闭文件并返回错误</span></span><br><span class="line">        perror(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 延迟3秒,模拟设备操作</span></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// 关闭设备文件</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 程序执行成功</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">leds &#123;</span><br><span class="line">    compatible = <span class="string">&quot;pwm-leds&quot;</span>;</span><br><span class="line">    led-gpios = &lt;&amp;gpio0 RK_PB7 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pwm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/hrtimer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">dev_t</span> dev_num;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev_test</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 PWM LED 数据结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_led_data</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> sum_count;  <span class="comment">// PWM 周期总脉冲数</span></span><br><span class="line">    <span class="type">int</span> high_count;  <span class="comment">// PWM 高电平持续脉冲数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">gpiod</span>;</span>  <span class="comment">// GPIO 描述符</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hrtimer</span> <span class="title">pwm_timer</span>;</span>  <span class="comment">// 高分辨率定时器</span></span><br><span class="line">    <span class="type">ktime_t</span> time;  <span class="comment">// 定时器时间间隔</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明 PWM LED 数据结构体指针</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_led_data</span> *<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PWM 定时器回调函数</span></span><br><span class="line"><span class="keyword">enum</span> hrtimer_restart <span class="title function_">pwm_timer_func</span><span class="params">(<span class="keyword">struct</span> hrtimer *timer)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> timer_count = <span class="number">0</span>;  <span class="comment">// 定时器计数器</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_led_data</span> *<span class="title">mydata</span> =</span> container_of(timer, <span class="keyword">struct</span> pwm_led_data, pwm_timer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果计数器达到总脉冲数, 将 GPIO 设为高电平</span></span><br><span class="line">    <span class="keyword">if</span> (timer_count == mydata-&gt;sum_count) &#123;</span><br><span class="line">        gpiod_set_value(mydata-&gt;gpiod, <span class="number">1</span>);</span><br><span class="line">        timer_count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果计数器达到高电平持续脉冲数, 将 GPIO 设为低电平</span></span><br><span class="line">    <span class="keyword">if</span> (timer_count == mydata-&gt;high_count) &#123;</span><br><span class="line">        gpiod_set_value(mydata-&gt;gpiod, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    timer_count++;</span><br><span class="line">    <span class="comment">// 如果高电平持续脉冲数为 0, 则计数器重置为 0</span></span><br><span class="line">    <span class="keyword">if</span> (mydata-&gt;high_count == <span class="number">0</span>) &#123;</span><br><span class="line">        timer_count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将定时器向前移动 time 时间间隔, 并重新启动</span></span><br><span class="line">    hrtimer_forward(timer, hrtimer_cb_get_time(timer), mydata-&gt;time);</span><br><span class="line">    <span class="keyword">return</span> HRTIMER_RESTART;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符设备打开回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test open\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符设备写入回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cdev_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">int</span> kbuf[<span class="number">2</span>];</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test write\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 从用户空间拷贝数据到内核空间</span></span><br><span class="line">    ret = copy_from_user(kbuf, buf, size);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;copy_from_user failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新 PWM LED 数据结构体</span></span><br><span class="line">    data-&gt;sum_count = kbuf[<span class="number">0</span>];</span><br><span class="line">    data-&gt;high_count = kbuf[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符设备释放回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test release\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符设备操作函数集</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = cdev_test_open,</span><br><span class="line">    .write = cdev_test_write,</span><br><span class="line">    .release = cdev_test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备探测回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配 PWM LED 数据结构体内存</span></span><br><span class="line">    data = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pwm_led_data), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">        printk(<span class="string">&quot;kmalloc failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化 PWM LED 数据结构体</span></span><br><span class="line">    data-&gt;sum_count = <span class="number">20</span>;</span><br><span class="line">    data-&gt;high_count = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 动态分配设备号</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;alloc_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;alloc_chrdev_region is error\n&quot;</span>);</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;alloc_chrdev_region is ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化字符设备</span></span><br><span class="line">    cdev_init(&amp;cdev_test, &amp;cdev_test_ops);</span><br><span class="line">    cdev_test.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    ret = cdev_add(&amp;cdev_test, dev_num, <span class="number">1</span>);    <span class="comment">// 向内核注册字符设备</span></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;cdev_add is error\n&quot;</span>);</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;test&quot;</span>);    <span class="comment">// 创建设备类</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(class)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;class_create is error\n&quot;</span>);</span><br><span class="line">        cdev_del(&amp;cdev_test);</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    device = device_create(class, <span class="literal">NULL</span>, dev_num, <span class="literal">NULL</span>, <span class="string">&quot;pwm-gpio&quot;</span>);    <span class="comment">// 创建设备节点</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(device)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;device_create is error\n&quot;</span>);</span><br><span class="line">        class_destroy(class);</span><br><span class="line">        cdev_del(&amp;cdev_test);</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data-&gt;gpiod = gpiod_get(&amp;pdev-&gt;dev, <span class="string">&quot;led&quot;</span>, GPIOD_OUT_HIGH);    <span class="comment">// 获取 GPIO 描述符</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(data-&gt;gpiod)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;gpiod_get is error\n&quot;</span>);</span><br><span class="line">        device_destroy(class, dev_num);</span><br><span class="line">        class_destroy(class);</span><br><span class="line">        cdev_del(&amp;cdev_test);</span><br><span class="line">        unregister_chrdev_region(dev_num, <span class="number">1</span>);</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(data-&gt;gpiod);</span><br><span class="line">    &#125;</span><br><span class="line">    gpiod_set_value(data-&gt;gpiod, <span class="number">1</span>);    <span class="comment">// 将 GPIO 设为高电平</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化高分辨率定时器</span></span><br><span class="line">    data-&gt;time = ktime_set(<span class="number">0</span>, <span class="number">1000000</span>);  <span class="comment">// 1 ms</span></span><br><span class="line">    hrtimer_init(&amp;data-&gt;pwm_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);</span><br><span class="line">    data-&gt;pwm_timer.function = pwm_timer_func;</span><br><span class="line">    hrtimer_start(&amp;data-&gt;pwm_timer, data-&gt;time, HRTIMER_MODE_REL);    <span class="comment">// 启动高分辨率定时器</span></span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;led_probe successful\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备移除回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line">    hrtimer_cancel(&amp;data-&gt;pwm_timer);    <span class="comment">// 停止高分辨率定时器</span></span><br><span class="line">    gpiod_put(data-&gt;gpiod);    <span class="comment">// 释放 GPIO 描述符</span></span><br><span class="line">    device_destroy(class, dev_num);    <span class="comment">// 删除设备节点</span></span><br><span class="line">    class_destroy(class);    <span class="comment">// 删除设备类</span></span><br><span class="line">    cdev_del(&amp;cdev_test);    <span class="comment">// 从内核注销字符设备</span></span><br><span class="line">    unregister_chrdev_region(dev_num, <span class="number">1</span>);    <span class="comment">// 释放设备号</span></span><br><span class="line">    kfree(data);    <span class="comment">// 释放 PWM LED 数据结构体内存</span></span><br><span class="line">    printk(<span class="string">&quot;led_remove successful\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备树匹配表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">led_of_device_id</span>[] =</span> &#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;pwm-leds&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, led_of_device_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台设备驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">led_platform_driver</span> =</span> &#123;</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;pwm-leds&quot;</span>,</span><br><span class="line">        .of_match_table = led_of_device_id,</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe = led_probe,</span><br><span class="line">    .remove = led_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">modulecdev_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册平台设备驱动</span></span><br><span class="line">    ret = platform_driver_register(&amp;led_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;platform_driver_register is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;platform_driver_register is ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">modulecdev_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 注销平台设备驱动</span></span><br><span class="line">    platform_driver_unregister(&amp;led_platform_driver);</span><br><span class="line">    printk(<span class="string">&quot;bye bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化和退出函数注册</span></span><br><span class="line">module_init(modulecdev_init);</span><br><span class="line">module_exit(modulecdev_exit);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块许可证、作者和描述信息</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;A simple PWM GPIO LED driver with hrtimer&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd; <span class="comment">// 文件描述符</span></span><br><span class="line">    <span class="type">int</span> buf[<span class="number">2</span>]; <span class="comment">// 缓冲区,存放两个整数值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查命令行参数个数是否正确</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;sum_count&gt; &lt;high_count&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开 PWM GPIO 设备文件</span></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/pwm-gpio&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将命令行参数转换为整数,存入缓冲区</span></span><br><span class="line">    buf[<span class="number">0</span>] = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    buf[<span class="number">1</span>] = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将缓冲区的数据写入 PWM GPIO 设备</span></span><br><span class="line">    <span class="keyword">if</span> (write(fd, buf, <span class="keyword">sizeof</span>(buf)) != <span class="keyword">sizeof</span>(buf)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭设备文件</span></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pwm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/hrtimer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备号</span></span><br><span class="line"><span class="type">dev_t</span> dev_num;</span><br><span class="line"><span class="comment">// cdev结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev_test</span>;</span></span><br><span class="line"><span class="comment">// 类结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="comment">// 设备结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PWM LED数据结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_led_data</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> sum_count; <span class="comment">// 总计数</span></span><br><span class="line">    <span class="type">int</span> high_count; <span class="comment">// 高电平计数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">gpiod</span>;</span> <span class="comment">// GPIO描述符</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hrtimer</span> <span class="title">pwm_timer</span>;</span> <span class="comment">// 高精度定时器</span></span><br><span class="line">    <span class="type">ktime_t</span> time; <span class="comment">// 定时器时间</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PWM LED数据结构体指针</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_led_data</span> *<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PWM定时器回调函数</span></span><br><span class="line"><span class="keyword">enum</span> hrtimer_restart <span class="title function_">pwm_timer_func</span><span class="params">(<span class="keyword">struct</span> hrtimer *timer)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> timer_count = <span class="number">0</span>; <span class="comment">// 定时器计数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_led_data</span> *<span class="title">mydata</span> =</span> container_of(timer, <span class="keyword">struct</span> pwm_led_data, pwm_timer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据计数切换GPIO引脚的电平</span></span><br><span class="line">    <span class="keyword">if</span> (timer_count == mydata-&gt;sum_count) &#123;</span><br><span class="line">        gpiod_set_value(mydata-&gt;gpiod, <span class="number">1</span>);</span><br><span class="line">        timer_count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timer_count == mydata-&gt;high_count) &#123;</span><br><span class="line">        gpiod_set_value(mydata-&gt;gpiod, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    timer_count++;</span><br><span class="line">    <span class="keyword">if</span> (mydata-&gt;high_count == <span class="number">0</span>) &#123;</span><br><span class="line">        timer_count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重启定时器</span></span><br><span class="line">    hrtimer_forward(timer, timer-&gt;softexpires, mydata-&gt;time);</span><br><span class="line">    <span class="keyword">return</span> HRTIMER_RESTART;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cdev open回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test open\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cdev write回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cdev_test_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">int</span> kbuf[<span class="number">2</span>];</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test write\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 从用户空间拷贝数据到内核空间</span></span><br><span class="line">    ret = copy_from_user(kbuf, buf, size);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;copy_from_user failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新数据结构体中的值</span></span><br><span class="line">    data-&gt;sum_count = kbuf[<span class="number">0</span>];</span><br><span class="line">    data-&gt;high_count = kbuf[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cdev release回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev test release\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cdev操作集</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = cdev_test_open,</span><br><span class="line">    .write = cdev_test_write,</span><br><span class="line">    .release = cdev_test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台驱动probe回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配并初始化数据结构体</span></span><br><span class="line">    data = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pwm_led_data), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">        printk(<span class="string">&quot;kmalloc failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    data-&gt;sum_count = <span class="number">100</span>;</span><br><span class="line">    data-&gt;high_count = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 申请设备号</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;alloc_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;alloc_chrdev_region is error\n&quot;</span>);</span><br><span class="line">        kfree(data);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;alloc_chrdev_region is ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化cdev</span></span><br><span class="line">    cdev_init(&amp;cdev_test, &amp;cdev_test_ops);</span><br><span class="line">    cdev_test.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加cdev</span></span><br><span class="line">    ret = cdev_add(&amp;cdev_test, dev_num, <span class="number">1</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    device = device_create(class, <span class="literal">NULL</span>, dev_num, <span class="literal">NULL</span>, <span class="string">&quot;pwm-gpio&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取GPIO描述符并设置初始电平</span></span><br><span class="line">    data-&gt;gpiod = gpiod_get(&amp;pdev-&gt;dev, <span class="string">&quot;led&quot;</span>, GPIOD_OUT_HIGH);</span><br><span class="line">    gpiod_set_value(data-&gt;gpiod, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化高精度定时器</span></span><br><span class="line">    data-&gt;time = ktime_set(<span class="number">0</span>, <span class="number">200000</span>);  <span class="comment">// 1 ms</span></span><br><span class="line">    hrtimer_init(&amp;data-&gt;pwm_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);</span><br><span class="line">    data-&gt;pwm_timer.function = pwm_timer_func;</span><br><span class="line">    hrtimer_start(&amp;data-&gt;pwm_timer, data-&gt;time, HRTIMER_MODE_REL);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;led_probe successful\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台驱动remove回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span> &#123;</span><br><span class="line">    hrtimer_cancel(&amp;data-&gt;pwm_timer);    <span class="comment">// 取消定时器</span></span><br><span class="line">    gpiod_put(data-&gt;gpiod);    <span class="comment">// 释放GPIO描述符</span></span><br><span class="line">    device_destroy(class, dev_num);    <span class="comment">// 删除设备节点</span></span><br><span class="line">    class_destroy(class);    <span class="comment">// 删除类</span></span><br><span class="line">    cdev_del(&amp;cdev_test);    <span class="comment">// 删除cdev</span></span><br><span class="line">    unregister_chrdev_region(dev_num, <span class="number">1</span>);    <span class="comment">// 释放设备号</span></span><br><span class="line">    kfree(data);    <span class="comment">// 释放数据结构体</span></span><br><span class="line">    printk(<span class="string">&quot;led_remove successful\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备树匹配表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">led_of_device_id</span>[] =</span> &#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;pwm-leds&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, led_of_device_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台驱动结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">led_platform_driver</span> =</span> &#123;</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;pwm-leds&quot;</span>,</span><br><span class="line">        .of_match_table = led_of_device_id,</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe = led_probe,</span><br><span class="line">    .remove = led_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">modulecdev_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册平台驱动</span></span><br><span class="line">    ret = platform_driver_register(&amp;led_platform_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;platform_driver_register is error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;platform_driver_register is ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块卸载函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">modulecdev_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 注销平台驱动</span></span><br><span class="line">    platform_driver_unregister(&amp;led_platform_driver);</span><br><span class="line">    printk(<span class="string">&quot;bye bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(modulecdev_init);</span><br><span class="line">module_exit(modulecdev_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;A simple PWM GPIO LED driver with hrtimer&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> buf[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查命令行参数是否正确</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;max_duty_cycle&gt; &lt;initial_duty_cycle&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开 PWM-GPIO 设备文件</span></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/pwm-gpio&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从命令行参数获取 PWM 参数</span></span><br><span class="line">    buf[<span class="number">0</span>] = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    buf[<span class="number">1</span>] = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递增 PWM 占空比</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; buf[<span class="number">0</span>] + <span class="number">1</span>; i++) &#123;</span><br><span class="line">        buf[<span class="number">1</span>] = i;</span><br><span class="line">        write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        usleep(<span class="number">30000</span>); <span class="comment">// 延迟 30 毫秒</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递减 PWM 占空比</span></span><br><span class="line">    <span class="keyword">if</span> (i == buf[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = buf[<span class="number">0</span>]; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">            buf[<span class="number">1</span>] = i;</span><br><span class="line">            write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">            usleep(<span class="number">30000</span>); <span class="comment">// 延迟 30 毫秒</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭设备文件</span></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，关于RK3568的I2C接口以及后续实验要用到的外设内容就介绍完成了。</p>
<table>
<thead>
<tr>
<th>PWM接口</th>
<th>pinctrl function</th>
<th>网络标号</th>
<th>对应的GPIO</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>PWM0</td>
<td>PWM0_M0</td>
<td>Working_LEDEN_H_GPIO0_B7</td>
<td>GPIO0_B7</td>
<td>LED灯控制引脚</td>
</tr>
<tr>
<td></td>
<td>PWM0_M1</td>
<td>LCD0_PWREN_H_GPIO0_C7</td>
<td>GPIO0_C7</td>
<td>LVDS屏幕供电使能引脚</td>
</tr>
<tr>
<td>PWM1</td>
<td>PWM1_M0</td>
<td>VGA_HPDIN_GPIO0_C0</td>
<td>GPIO0_C0</td>
<td>VGA热插拔判断引脚</td>
</tr>
<tr>
<td></td>
<td>PWM1_M1</td>
<td>PCIE20_WAKEN_MO</td>
<td>GPIO0_B5</td>
<td>PCIE2.0唤醒</td>
</tr>
<tr>
<td>PWM2</td>
<td>PWM2_M0</td>
<td>PCIE20_PERSTn_GPIO0_C1</td>
<td>GPIO0_C1</td>
<td>PCIE2.0复位引脚</td>
</tr>
<tr>
<td></td>
<td>PWM2_M1</td>
<td>TP_RST_L_GPIO0_B6</td>
<td>GPIO0_B6</td>
<td>MIPI触摸屏复位引脚</td>
</tr>
<tr>
<td>PWM3_IR</td>
<td>PWM3_IR</td>
<td>PWM3_IR</td>
<td>GPIO0_C2</td>
<td>红外接收头</td>
</tr>
<tr>
<td>PWM4</td>
<td>PWM4</td>
<td>LCD0_BL_PWM4</td>
<td>GPIO0_C3</td>
<td>LVDS屏幕背光</td>
</tr>
<tr>
<td>PWM5</td>
<td>PWM5</td>
<td>LCD1_BL_PWM5</td>
<td>GPIO0_C4</td>
<td>MIPI屏幕背光</td>
</tr>
<tr>
<td>PWM6</td>
<td>PWM6</td>
<td>PWM_FAN</td>
<td>GPIO0_C5</td>
<td>散热风扇转速调节</td>
</tr>
<tr>
<td>PWM7_IR</td>
<td>PWM7_IR</td>
<td>RS485_DIR_GPIO0_C6</td>
<td>GPIO0_C6</td>
<td>485收发控制引脚</td>
</tr>
<tr>
<td>PWM8</td>
<td>PWM8_M0</td>
<td>UART4_RX_M1</td>
<td>GPIO3_B1</td>
<td>串口4接收引脚</td>
</tr>
<tr>
<td></td>
<td>PWM8_M1</td>
<td>SDMMC0_D0</td>
<td>GPIO1_D5</td>
<td>SD卡数据线</td>
</tr>
<tr>
<td>PWM9</td>
<td>PWM9_M0</td>
<td>UART4_TX_M1</td>
<td>GPIO3_B2</td>
<td>串口4发送引脚</td>
</tr>
<tr>
<td></td>
<td>PWM9_M1</td>
<td>SDMMC0_D1</td>
<td>GPIO1_D5</td>
<td>SD卡数据线</td>
</tr>
<tr>
<td>PWM10</td>
<td>PWM10_M0</td>
<td>GPIO3_B5</td>
<td>GPIO3_B5</td>
<td>未使用</td>
</tr>
<tr>
<td></td>
<td>PWM10_M1</td>
<td>SDMMC0_CMD</td>
<td>GPIO2_A1</td>
<td>SD卡CMD引脚</td>
</tr>
<tr>
<td>PWM11</td>
<td>PWM11_IR_M0</td>
<td>GPIO3_B6</td>
<td>GPIO3_B6</td>
<td>未使用</td>
</tr>
<tr>
<td></td>
<td>PWM11_IR_M1</td>
<td>CIF_CLKOUT</td>
<td>GPIO4_C0</td>
<td>未使用</td>
</tr>
<tr>
<td>PWM12</td>
<td>PWM12_M0</td>
<td>GMAC0_RSTn_GPIO3_B7</td>
<td>GPIO3_B7</td>
<td>网卡0复位引脚</td>
</tr>
<tr>
<td></td>
<td>PWM12_M1</td>
<td>GPIO4_C5</td>
<td>GPIO4_C5</td>
<td>串口9发送引脚</td>
</tr>
<tr>
<td>PWM13</td>
<td>PWM13_M0</td>
<td>GMAC0_INT/PMEB_GPIO3_C0</td>
<td>GPIO3_C0</td>
<td>网卡0中断引脚</td>
</tr>
<tr>
<td></td>
<td>PWM13_M1</td>
<td>GPIO4_C6</td>
<td>GPIO4_C6</td>
<td>串口9接收引脚</td>
</tr>
<tr>
<td>PWM14</td>
<td>PWM14_M0</td>
<td>UART7_TX_M1</td>
<td>GPIO3_C4</td>
<td>串口7发送引脚</td>
</tr>
<tr>
<td></td>
<td>PWM14_M1</td>
<td>4G_DISABLE_GPIO4_C2</td>
<td>GPIO4_C2</td>
<td>CAN1 RX</td>
</tr>
<tr>
<td>PWM15</td>
<td>PWM15_IR_M0</td>
<td>UART7_RX_M1</td>
<td>GPIO3_C5</td>
<td>串口7接收引脚</td>
</tr>
<tr>
<td></td>
<td>PWM15_IR_M1</td>
<td>HDMIRX_INT_L_GPIO4_C3</td>
<td>GPIO4_C3</td>
<td>CAN1 TX</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">高电平持续时间</th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left">转动角度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">转动角度</td>
<td style="text-align:left">0°</td>
<td style="text-align:left">1.25 ms</td>
<td style="text-align:left">67.5°</td>
<td style="text-align:left">2.0 ms</td>
<td style="text-align:left">135°</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">22.5°</td>
<td style="text-align:left">1.5 ms</td>
<td style="text-align:left">90°</td>
<td style="text-align:left">2.25 ms</td>
<td style="text-align:left">157.5°</td>
</tr>
<tr>
<td style="text-align:left">1.0 ms</td>
<td style="text-align:left">45°</td>
<td style="text-align:left">1.75 ms</td>
<td style="text-align:left">112.5°</td>
<td style="text-align:left">2.5 ms</td>
<td style="text-align:left">180°</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">高电平持续时间</th>
<th style="text-align:left">转动角度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0.5 ms</td>
<td style="text-align:left">0°</td>
</tr>
<tr>
<td style="text-align:left">1.0 ms</td>
<td style="text-align:left">45°</td>
</tr>
<tr>
<td style="text-align:left">1.5 ms</td>
<td style="text-align:left">90°</td>
</tr>
<tr>
<td style="text-align:left">2.0 ms</td>
<td style="text-align:left">135°</td>
</tr>
<tr>
<td style="text-align:left">2.5 ms</td>
<td style="text-align:left">180°</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">线缆颜色</th>
<th style="text-align:left">功能</th>
<th>背板20pin引脚编号</th>
<th>网络标号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">红线</td>
<td style="text-align:left">电源正极(5V)</td>
<td>10/12</td>
<td>VCC5V0_SYS</td>
</tr>
<tr>
<td style="text-align:left">棕线</td>
<td style="text-align:left">电源负极(GND)</td>
<td>19/20</td>
<td>GND</td>
</tr>
<tr>
<td style="text-align:left">橙线</td>
<td style="text-align:left">控制信号线(PWM信号)</td>
<td>6</td>
<td>UART9_TX_M1(GPIO4_C5)</td>
</tr>
</tbody>
</table>
<p>可以将整个I2C子系统用下面的框图来描述：</p>
<p>可以将上面这一I2C子系统划分为三个层次，分别为用户空间、内核空间和硬件层，内核空间就包括I2C设备驱动层、I2C核心层和I2C适配器驱动层，而本章的主要内容就是介绍I2C子系统框架中的内核空间。</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性名称</th>
<th style="text-align:left">读函数</th>
<th style="text-align:left">写函数</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">period</td>
<td style="text-align:left"><code>period_show</code></td>
<td style="text-align:left"><code>period_store</code></td>
<td style="text-align:left">PWM 周期读写</td>
</tr>
<tr>
<td style="text-align:left">duty_cycle</td>
<td style="text-align:left"><code>duty_cycle_show</code></td>
<td style="text-align:left"><code>duty_cycle_store</code></td>
<td style="text-align:left">PWM 占空比读写</td>
</tr>
<tr>
<td style="text-align:left">enable</td>
<td style="text-align:left"><code>enable_show</code></td>
<td style="text-align:left"><code>enable_store</code></td>
<td style="text-align:left">PWM 使能状态读写</td>
</tr>
<tr>
<td style="text-align:left">polarity</td>
<td style="text-align:left"><code>polarity_show</code></td>
<td style="text-align:left"><code>polarity_store</code></td>
<td style="text-align:left">PWM 极性读写</td>
</tr>
<tr>
<td style="text-align:left">capture</td>
<td style="text-align:left"><code>capture_show</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">PWM 捕获值读取</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>​	先来分析一下输入捕获的的章节要怎样讲解</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pwm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rockchip_pwm_capture.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开字符设备的回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> *<span class="title">ddata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_capture_cdev</span> *<span class="title">pcdev</span>;</span></span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;This is cdev_test_open\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 inode 中获取设备数据</span></span><br><span class="line">    pcdev = container_of(inode-&gt;i_cdev, <span class="keyword">struct</span> pwm_capture_cdev, cdev_test);</span><br><span class="line">    ddata = container_of(pcdev, <span class="keyword">struct</span> rkxx_capture_drvdata, pwm_cdev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ddata) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to get device data\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将设备数据保存到文件私有数据中</span></span><br><span class="line">    file-&gt;private_data = ddata;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取字符设备的回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cdev_test_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> *<span class="title">ddata</span>;</span></span><br><span class="line">    <span class="type">int</span> val, i, ret;</span><br><span class="line"></span><br><span class="line">    ddata = file-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ddata) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Device data is NULL\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化捕获数据</span></span><br><span class="line">    ddata-&gt;lpr = <span class="number">0</span>;</span><br><span class="line">    ddata-&gt;hpr = <span class="number">0</span>;</span><br><span class="line">    ddata-&gt;state = RMC_IDLE1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用 PWM</span></span><br><span class="line">    val = readl_relaxed(ddata-&gt;base + PWM_REG_CTRL);</span><br><span class="line">    val = (val &amp; <span class="number">0xFFFFFFFE</span>) | PWM_ENABLE;</span><br><span class="line">    writel_relaxed(val, ddata-&gt;base + PWM_REG_CTRL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待数据捕获完成</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        msleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ddata-&gt;state == RMC_DONE &amp;&amp; ddata-&gt;hpr &amp;&amp; ddata-&gt;lpr) &#123;</span><br><span class="line">            printk(<span class="string">&quot;capture ok!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁用 PWM</span></span><br><span class="line">    val = readl_relaxed(ddata-&gt;base + PWM_REG_CTRL);</span><br><span class="line">    val = (val &amp; <span class="number">0xFFFFFFFE</span>) | PWM_DISABLE;</span><br><span class="line">    writel_relaxed(val, ddata-&gt;base + PWM_REG_CTRL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ddata-&gt;hpr == <span class="number">0</span> || ddata-&gt;lpr == <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to capture PWM data\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算周期和占空比</span></span><br><span class="line">    ddata-&gt;data.period_ns = (ddata-&gt;lpr + ddata-&gt;hpr) * ddata-&gt;pwm_freq_nstime;</span><br><span class="line">    ddata-&gt;data.duty_ns = ddata-&gt;hpr * ddata-&gt;pwm_freq_nstime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将数据拷贝到用户空间</span></span><br><span class="line">    ret = copy_to_user(buf, &amp;ddata-&gt;data, size);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to copy data to user space\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;This is cdev_test_read\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ddata-&gt;state = RMC_IDLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放字符设备的回调函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cdev_test_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;This is cdev_test_release\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符设备操作函数结构体</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">cdev_test_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = cdev_test_open,</span><br><span class="line">    .read = cdev_test_read,</span><br><span class="line">    .release = cdev_test_release</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PWM 捕获中断处理函数</span></span><br><span class="line"><span class="type">irqreturn_t</span> <span class="title function_">rk_pwm_capture</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> *<span class="title">ddata</span> =</span> dev_id;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> channel = ddata-&gt;pwm_channel;</span><br><span class="line">    <span class="type">int</span> val, lpr, hpr;</span><br><span class="line"></span><br><span class="line">    val = readl_relaxed(ddata-&gt;base + PWM_REG_INTSTS(channel));</span><br><span class="line">    <span class="keyword">if</span> ((val &amp; PWM_CH_INT(channel)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> IRQ_NONE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据极性读取 lpr 或 hpr</span></span><br><span class="line">    <span class="keyword">if</span> ((val &amp; PWM_CH_POL(channel)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ddata-&gt;state != RMC_DONE) &#123;</span><br><span class="line">            lpr = readl_relaxed(ddata-&gt;base + PWM_REG_LPR);</span><br><span class="line">            ddata-&gt;lpr = lpr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ddata-&gt;state != RMC_DONE) &#123;</span><br><span class="line">            hpr = readl_relaxed(ddata-&gt;base + PWM_REG_HPR);</span><br><span class="line">            ddata-&gt;hpr = hpr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除中断状态</span></span><br><span class="line">    writel_relaxed(PWM_CH_INT(channel), ddata-&gt;base + PWM_REG_INTSTS(channel));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态机处理</span></span><br><span class="line">    <span class="keyword">switch</span> (ddata-&gt;state) &#123;</span><br><span class="line">    <span class="keyword">case</span> RMC_IDLE1:</span><br><span class="line">        ddata-&gt;hpr = <span class="number">0</span>;</span><br><span class="line">        ddata-&gt;lpr = <span class="number">0</span>;</span><br><span class="line">        ddata-&gt;state = RMC_IDLE2;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RMC_IDLE2:</span><br><span class="line">        ddata-&gt;hpr = <span class="number">0</span>;</span><br><span class="line">        ddata-&gt;lpr = <span class="number">0</span>;</span><br><span class="line">        ddata-&gt;state = RMC_GETDATA;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RMC_GETDATA:</span><br><span class="line">        printk(<span class="string">&quot;ddata-&gt;hpr is %d, ddata-&gt;lpr is %d\n&quot;</span>, ddata-&gt;hpr, ddata-&gt;lpr);</span><br><span class="line">        <span class="keyword">if</span> (ddata-&gt;hpr &amp;&amp; ddata-&gt;lpr) &#123;</span><br><span class="line">            ddata-&gt;state = RMC_DONE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动探测函数</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">capture_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> *<span class="title">ddata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">r</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">p_clk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> pdev-&gt;dev.of_node;</span><br><span class="line">    <span class="type">int</span> pwm_channel;</span><br><span class="line">    <span class="type">int</span> irq;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_capture_cdev</span> *<span class="title">pcdev</span>;</span></span><br><span class="line">    <span class="type">int</span> freq;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配驱动数据结构</span></span><br><span class="line">    ddata = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rkxx_capture_drvdata), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!ddata) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to allocate memory for driver data\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    ddata-&gt;state = RMC_IDLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取资源</span></span><br><span class="line">    r = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">    ddata-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, r);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(ddata-&gt;base)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to map memory resource\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(ddata-&gt;base);</span><br><span class="line">    &#125;</span><br><span class="line">    ddata-&gt;dev = pdev-&gt;dev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取时钟</span></span><br><span class="line">    clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="string">&quot;pwm&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(clk)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get PWM clock\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(clk);</span><br><span class="line">    &#125;</span><br><span class="line">    ddata-&gt;clk = clk;</span><br><span class="line"></span><br><span class="line">    p_clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="string">&quot;pclk&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(p_clk)) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get peripheral clock\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(p_clk);</span><br><span class="line">    &#125;</span><br><span class="line">    ddata-&gt;p_clk = p_clk;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从设备树中读取 PWM 通道</span></span><br><span class="line">    ret = of_property_read_u32(np, <span class="string">&quot;pwm-channel&quot;</span>, &amp;pwm_channel);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get PWM channel from device tree\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    pwm_channel %= <span class="number">4</span>;</span><br><span class="line">    ddata-&gt;pwm_channel = pwm_channel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取中断号</span></span><br><span class="line">    irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (irq &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to get IRQ\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> irq;</span><br><span class="line">    &#125;</span><br><span class="line">    ddata-&gt;irq = irq;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置驱动数据</span></span><br><span class="line">    platform_set_drvdata(pdev, ddata);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求中断</span></span><br><span class="line">    ret = devm_request_irq(&amp;pdev-&gt;dev, irq, rk_pwm_capture, IRQF_NO_SUSPEND, <span class="string">&quot;rk_pwm_capture_irq&quot;</span>, ddata);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to request IRQ\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用时钟</span></span><br><span class="line">    ret = clk_prepare_enable(ddata-&gt;clk);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to enable PWM clock\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = clk_prepare_enable(ddata-&gt;p_clk);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        clk_disable_unprepare(ddata-&gt;clk);</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to enable peripheral clock\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 PWM 频率</span></span><br><span class="line">    freq = clk_get_rate(ddata-&gt;clk) / <span class="number">64</span>;</span><br><span class="line">    ddata-&gt;pwm_freq_nstime = <span class="number">1000000000</span> / freq;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册字符设备</span></span><br><span class="line">    pcdev = &amp;ddata-&gt;pwm_cdev;</span><br><span class="line">    ret = alloc_chrdev_region(&amp;pcdev-&gt;dev_num, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;alloc_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;alloc_chrdev_region error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_alloc_chrdev;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;alloc_chrdev_region success\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pcdev-&gt;cdev_test.owner = THIS_MODULE;</span><br><span class="line">    cdev_init(&amp;pcdev-&gt;cdev_test, &amp;cdev_test_ops);</span><br><span class="line">    ret = cdev_add(&amp;pcdev-&gt;cdev_test, pcdev-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to add cdev\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_cdev_add;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建设备类</span></span><br><span class="line">    pcdev-&gt;<span class="class"><span class="keyword">class</span> =</span> class_create(THIS_MODULE, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(pcdev-&gt;class)) &#123;</span><br><span class="line">        ret = PTR_ERR(pcdev-&gt;class);</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to create class\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_class_create;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建设备</span></span><br><span class="line">    pcdev-&gt;device = device_create(pcdev-&gt;class, <span class="literal">NULL</span>, pcdev-&gt;dev_num, <span class="literal">NULL</span>, <span class="string">&quot;capture&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(pcdev-&gt;device)) &#123;</span><br><span class="line">        ret = PTR_ERR(pcdev-&gt;device);</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to create device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_device_create;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rk_pwm_capture_init(ddata-&gt;base, ddata-&gt;pwm_channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_device_create:</span><br><span class="line">    class_destroy(pcdev-&gt;class);</span><br><span class="line">err_class_create:</span><br><span class="line">    cdev_del(&amp;pcdev-&gt;cdev_test);</span><br><span class="line">err_cdev_add:</span><br><span class="line">    unregister_chrdev_region(pcdev-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line">err_alloc_chrdev:</span><br><span class="line">    clk_disable_unprepare(ddata-&gt;p_clk);</span><br><span class="line">    clk_disable_unprepare(ddata-&gt;clk);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动移除函数</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">capture_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> *<span class="title">ddata</span> =</span> platform_get_drvdata(pdev);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_capture_cdev</span> *<span class="title">pcdev</span> =</span> &amp;ddata-&gt;pwm_cdev;</span><br><span class="line"></span><br><span class="line">    device_destroy(pcdev-&gt;class, pcdev-&gt;dev_num);</span><br><span class="line">    class_destroy(pcdev-&gt;class);</span><br><span class="line">    cdev_del(&amp;pcdev-&gt;cdev_test);</span><br><span class="line">    unregister_chrdev_region(pcdev-&gt;dev_num, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    clk_disable_unprepare(ddata-&gt;p_clk);</span><br><span class="line">    clk_disable_unprepare(ddata-&gt;clk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设备树匹配表</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">capture_of_device_id</span>[] =</span> &#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;pwm-capture&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平台驱动结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">capture_platform_driver</span> =</span> &#123;</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;pwm-capture&quot;</span>,</span><br><span class="line">        .of_match_table = capture_of_device_id,</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe = capture_probe,</span><br><span class="line">    .remove = capture_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块初始化函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">modulecdev_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;capture_platform_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块退出函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">modulecdev_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    platform_driver_unregister(&amp;capture_platform_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(modulecdev_init);</span><br><span class="line">module_exit(modulecdev_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;topeet&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __RKXX_PWM_REMOTECTL_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RKXX_PWM_REMOTECTL_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pwm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kdev_t.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 最大按键数 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_NUM_KEYS                60</span></span><br><span class="line"><span class="comment">/* 最大PWM捕获数 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWR_KEY_CAPURURE_MAX    10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM寄存器定义 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_CNTR                0x00  <span class="comment">/* 计数器寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_HPR                 0x04  <span class="comment">/* 周期寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_LPR                 0x08  <span class="comment">/* 占空比寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_CTRL                0x0c  <span class="comment">/* 控制寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM3_REG_INTSTS             0x10  <span class="comment">/* PWM3中断状态寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM2_REG_INTSTS             0x20  <span class="comment">/* PWM2中断状态寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM1_REG_INTSTS             0x30  <span class="comment">/* PWM1中断状态寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM0_REG_INTSTS             0x40  <span class="comment">/* PWM0中断状态寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM3_REG_INT_EN             0x14  <span class="comment">/* PWM3中断使能寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM2_REG_INT_EN             0x24  <span class="comment">/* PWM2中断使能寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM1_REG_INT_EN             0x34  <span class="comment">/* PWM1中断使能寄存器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM0_REG_INT_EN             0x44  <span class="comment">/* PWM0中断使能寄存器 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 控制寄存器位定义 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_ENABLE                  (1 &lt;&lt; 0) <span class="comment">/* PWM使能 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_DISABLE                 (0 &lt;&lt; 0) <span class="comment">/* PWM禁用 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作模式 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MODE_ONESHOT            (0x00 &lt;&lt; 1) <span class="comment">/* 单次模式 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MODE_CONTINUMOUS        (0x01 &lt;&lt; 1) <span class="comment">/* 连续模式 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MODE_CAPTURE            (0x02 &lt;&lt; 1) <span class="comment">/* 捕获模式 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 占空比输出极性 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_DUTY_POSTIVE            (0x01 &lt;&lt; 3) <span class="comment">/* 正极性 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_DUTY_NEGATIVE           (0x00 &lt;&lt; 3) <span class="comment">/* 负极性 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 非活动状态输出极性 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INACTIVE_POSTIVE        (0x01 &lt;&lt; 4) <span class="comment">/* 正极性 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INACTIVE_NEGATIVE       (0x00 &lt;&lt; 4) <span class="comment">/* 负极性 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 时钟源选择 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CLK_SCALE               (1 &lt;&lt; 9) <span class="comment">/* 时钟分频 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CLK_NON_SCALE           (0 &lt;&lt; 9) <span class="comment">/* 无时钟分频 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_INT                 (1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_INT                 (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_INT                 (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_INT                 (1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWR_KEY_INT             (1 &lt;&lt; 7)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_POL                 (1 &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_POL                 (1 &lt;&lt; 9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_POL                 (1 &lt;&lt; 10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_POL                 (1 &lt;&lt; 11)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_INT_ENABLE          (1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_INT_DISABLE         (0 &lt;&lt; 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_INT_ENABLE          (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_INT_DISABLE         (0 &lt;&lt; 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_INT_ENABLE          (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_INT_DISABLE         (0 &lt;&lt; 2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_INT_ENABLE          (1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_INT_DISABLE         (0 &lt;&lt; 3)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INT_ENABLE              1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INT_DISABLE             0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 预分频因子 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMCR_MIN_PRESCALE          0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMCR_MAX_PRESCALE          0x07</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMDCR_MIN_DUTY             0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMDCR_MAX_DUTY             0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMPCR_MIN_PERIOD           0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMPCR_MAX_PERIOD           0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">pwm_div</span> &#123;</span></span><br><span class="line">    PWM_DIV1    = (<span class="number">0x0</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV2    = (<span class="number">0x1</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV4    = (<span class="number">0x2</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV8    = (<span class="number">0x3</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV16   = (<span class="number">0x4</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV32   = (<span class="number">0x5</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV64   = (<span class="number">0x6</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    PWM_DIV128  = (<span class="number">0x7</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* NEC 协议 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_PRE_MIN         4000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_PRE_MAX         5000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_PRE_MIN_LOW     8000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_PRE_MAX_LOW     10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_BIT0_MIN        390</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_BIT0_MAX        730</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_BIT1_MIN        1300</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_BIT1_MAX        2000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_BIT_MIN_LOW     390</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_BIT_MAX_LOW     730</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_RPT_MIN         2000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_RPT_MAX         2500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_SEQ1_MIN        95000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_SEQ1_MAX        98000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_SEQ2_MIN        30000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_TIME_SEQ2_MAX        55000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_INTSTS(n)           ((3 - (n)) * 0x10 + 0x10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_INT_EN(n)           ((3 - (n)) * 0x10 + 0x14)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_VERSION_ID(n)        ((3 - (n)) * 0x10 + 0x2c)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_CTRL(n)    ((3 - (n)) * 0x10 + 0x50)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_LPRE(n)    ((3 - (n)) * 0x10 + 0x54)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_HPRE(n)    ((3 - (n)) * 0x10 + 0x58)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_LD(n)      ((3 - (n)) * 0x10 + 0x5C)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_HD_ZERO(n) ((3 - (n)) * 0x10 + 0x60)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_HD_ONE(n)  ((3 - (n)) * 0x10 + 0x64)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWRMATCH_VALUE(n)       ((3 - (n)) * 0x10 + 0x68)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWRCAPTURE_VALUE(n)     ((3 - (n)) * 0x10 + 0x9c)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH_INT(n)               BIT(n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH_POL(n)               BIT(n + 8)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH_INT_ENABLE(n)        BIT(n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWR_INT_ENABLE          BIT(7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CH3_PWRKEY_ENABLE           BIT(3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM 数据结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_data</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> period_ns; <span class="comment">/* 周期（纳秒） */</span></span><br><span class="line">    <span class="type">int</span> duty_ns;   <span class="comment">/* 占空比（纳秒） */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM 状态枚举 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RMC_STATE</span> &#123;</span></span><br><span class="line">    RMC_IDLE,   <span class="comment">/* 空闲状态 */</span></span><br><span class="line">    RMC_IDLE1,  <span class="comment">/* 空闲状态1 */</span></span><br><span class="line">    RMC_IDLE2,  <span class="comment">/* 空闲状态2 */</span></span><br><span class="line">    RMC_GETDATA,<span class="comment">/* 获取数据状态 */</span></span><br><span class="line">    RMC_DONE,   <span class="comment">/* 完成状态 */</span></span><br><span class="line">&#125; eRMC_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM 捕获平台数据结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RKxx_remotectl_platform_data</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> nbuttons; <span class="comment">/* 按钮数 */</span></span><br><span class="line">    <span class="type">int</span> rep;      <span class="comment">/* 重复 */</span></span><br><span class="line">    <span class="type">int</span> timer;    <span class="comment">/* 计时器 */</span></span><br><span class="line">    <span class="type">int</span> wakeup;   <span class="comment">/* 唤醒 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM 捕获字符设备数据结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_capture_cdev</span> &#123;</span></span><br><span class="line">    <span class="type">dev_t</span> dev_num;            <span class="comment">/* 设备号 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev_test</span>;</span>    <span class="comment">/* 字符设备结构体 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span>      <span class="comment">/* 设备类 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>    <span class="comment">/* 设备结构体 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> *<span class="title">ddata</span>;</span> <span class="comment">/* 驱动数据 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM 捕获驱动数据结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rkxx_capture_drvdata</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> __iomem *base;       <span class="comment">/* 基地址 */</span></span><br><span class="line">    <span class="type">int</span> irq;                  <span class="comment">/* 中断号 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span>        <span class="comment">/* 设备结构体 */</span></span><br><span class="line">    <span class="type">int</span> pwm_freq_nstime;      <span class="comment">/* PWM 频率（纳秒） */</span></span><br><span class="line">    <span class="type">int</span> pwm_channel;          <span class="comment">/* PWM 通道 */</span></span><br><span class="line">    <span class="type">int</span> hpr;                  <span class="comment">/* 高电平周期 */</span></span><br><span class="line">    <span class="type">int</span> lpr;                  <span class="comment">/* 低电平周期 */</span></span><br><span class="line">    eRMC_STATE state;         <span class="comment">/* PWM 状态 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span>          <span class="comment">/* 时钟 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">p_clk</span>;</span>        <span class="comment">/* 父时钟 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_capture_cdev</span> <span class="title">pwm_cdev</span>;</span> <span class="comment">/* PWM 捕获字符设备 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_data</span> <span class="title">data</span>;</span>             <span class="comment">/* PWM 数据结构 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM 中断控制 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rk_pwm_int_ctrl</span><span class="params">(<span class="type">void</span> __iomem *pwm_base, uint pwm_id, <span class="type">int</span> ctrl)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pwm_id &gt; <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">/* 如果 PWM ID 超过 3，直接返回 */</span></span><br><span class="line">    </span><br><span class="line">    val = readl_relaxed(pwm_base + PWM_REG_INT_EN(pwm_id)); <span class="comment">/* 读取当前中断使能状态 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ctrl) &#123;</span><br><span class="line">        val |= PWM_CH_INT_ENABLE(pwm_id); <span class="comment">/* 设置中断使能 */</span></span><br><span class="line">        writel_relaxed(val, pwm_base + PWM_REG_INT_EN(pwm_id)); <span class="comment">/* 写入中断使能寄存器 */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val &amp;= ~PWM_CH_INT_ENABLE(pwm_id); <span class="comment">/* 清除中断使能 */</span></span><br><span class="line">        writel_relaxed(val, pwm_base + PWM_REG_INT_EN(pwm_id)); <span class="comment">/* 写入中断使能寄存器 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始化 PWM 捕获 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rk_pwm_capture_init</span><span class="params">(<span class="type">void</span> __iomem *pwm_base, uint pwm_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 禁用 PWM */</span></span><br><span class="line">    val = readl_relaxed(pwm_base + PWM_REG_CTRL);</span><br><span class="line">    val = (val &amp; <span class="number">0xFFFFFFFE</span>) | PWM_DISABLE;</span><br><span class="line">    writel_relaxed(val, pwm_base + PWM_REG_CTRL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置为捕获模式 */</span></span><br><span class="line">    val = readl_relaxed(pwm_base + PWM_REG_CTRL);</span><br><span class="line">    val = (val &amp; <span class="number">0xFFFFFFF9</span>) | PWM_MODE_CAPTURE;</span><br><span class="line">    writel_relaxed(val, pwm_base + PWM_REG_CTRL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置分频值 */</span></span><br><span class="line">    val = readl_relaxed(pwm_base + PWM_REG_CTRL);</span><br><span class="line">    val = (val &amp; <span class="number">0xFF0001FF</span>) | PWM_DIV64;</span><br><span class="line">    writel_relaxed(val, pwm_base + PWM_REG_CTRL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启用中断 */</span></span><br><span class="line">    rk_pwm_int_ctrl(pwm_base, pwm_id, PWM_INT_ENABLE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 这里可以启用 PWM 捕获（注释掉的代码） */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    val = readl_relaxed(pwm_base + PWM_REG_CTRL);</span></span><br><span class="line"><span class="comment">    val = (val &amp; 0xFFFFFFFE) | PWM_ENABLE;</span></span><br><span class="line"><span class="comment">    writel_relaxed(val, pwm_base + PWM_REG_CTRL);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 PWM 数据结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pwm_data</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> period_ns;  <span class="comment">// PWM 周期,单位纳秒</span></span><br><span class="line">    <span class="type">int</span> duty_ns;    <span class="comment">// PWM 占空比,单位纳秒</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwm_data</span> <span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开 PWM 捕获设备文件</span></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/capture&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;打开设备文件失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取 PWM 捕获数据</span></span><br><span class="line">    <span class="keyword">if</span> (read(fd, &amp;data, <span class="keyword">sizeof</span>(data)) != <span class="keyword">sizeof</span>(data)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;读取数据失败\n&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 PWM 捕获数据</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;period_ns is %d, duty_ns is %d\n&quot;</span>, data.period_ns, data.duty_ns);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭设备文件</span></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;pwm3 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    compatible = <span class="string">&quot;pwm-capture&quot;</span>;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pwm-channel = &lt;<span class="number">3</span>&gt;;</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<p>dpkg-deb -Zgzip --uniform-compression -b . topeet-config.deb</p>
<p>u-boot/drivers/video/drm/dw_mipi_dsi.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">724</span>         <span class="keyword">if</span> (msg-&gt;flags &amp; MIPI_DSI_MSG_USE_LPM) &#123;</span><br><span class="line"><span class="number">725</span>                 dsi_update_bits(dsi, DSI_VID_MODE_CFG, LP_CMD_EN, LP_CMD_EN);</span><br><span class="line"><span class="number">726</span>                 <span class="comment">//dsi_update_bits(dsi, DSI_LPCLK_CTRL, PHY_TXREQUESTCLKHS, 0);</span></span><br><span class="line"><span class="number">727</span>                 dsi_write(dsi, DSI_LPCLK_CTRL, PHY_TXREQUESTCLKHS);</span><br><span class="line"><span class="number">728</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">729</span>                 dsi_update_bits(dsi, DSI_VID_MODE_CFG, LP_CMD_EN, <span class="number">0</span>);</span><br><span class="line"><span class="number">730</span>                 dsi_update_bits(dsi, DSI_LPCLK_CTRL,</span><br><span class="line"><span class="number">731</span>                                 PHY_TXREQUESTCLKHS, PHY_TXREQUESTCLKHS);</span><br><span class="line"><span class="number">732</span>         &#125;</span><br></pre></td></tr></table></figure>
<h1 id="89工作记录"><a class="markdownIt-Anchor" href="#89工作记录"></a> 8.9工作记录</h1>
<h3 id="探索rk3568开发板的多屏显示魔力"><a class="markdownIt-Anchor" href="#探索rk3568开发板的多屏显示魔力"></a> <strong>探索RK3568开发板的多屏显示魔力</strong></h3>
<p>多屏显示是现代设备的一大亮点，而基于Rockchip RK3568的开发板更是将这种功能发挥到极致。本文将带你一探RK3568如何通过多接口实现流畅的多屏显示，助力广告机、电子看板等场景的应用。</p>
<h4 id="开发板选型奠定稳定基础"><a class="markdownIt-Anchor" href="#开发板选型奠定稳定基础"></a> <strong>开发板选型，奠定稳定基础</strong></h4>
<p>RK3568开发板是这一技术方案的核心。我们选用迅为的iTOP-3568开发板，支持多屏显示功能的底板1.7版，连接了多个显示设备，展现出HDMI、LVDS、MIPI等多种接口的完美兼容。</p>
<h4 id="软硬结合稳定才是王道"><a class="markdownIt-Anchor" href="#软硬结合稳定才是王道"></a> <strong>软硬结合，稳定才是王道</strong></h4>
<p>从操作系统到驱动支持，RK3568开发板展现了强大的兼容性和性能。推荐使用Rockchip官方提供的Android或Linux系统镜像，确保驱动完全支持。显示驱动和GPU硬件加速库的优化让多屏显示流畅无比。</p>
<h4 id="多屏显示灵活配置"><a class="markdownIt-Anchor" href="#多屏显示灵活配置"></a> <strong>多屏显示，灵活配置</strong></h4>
<p>通过详细的硬件接口配置，你可以轻松实现多屏显示。HDMI作为主显示，支持4K输出；LVDS用于高分辨率图像展示，MIPI接口则适用于小尺寸屏幕，时序配置准确无误。利用xrandr命令，我们可以轻松设置屏幕的工作模式，无论是镜像显示还是独立显示，都能随心调整。</p>
<h4 id="同步优化完美呈现"><a class="markdownIt-Anchor" href="#同步优化完美呈现"></a> <strong>同步优化，完美呈现</strong></h4>
<p>为了避免画面撕裂和不同步问题，我们对垂直同步进行了精细调试。同时，优化渲染线程，确保每个屏幕刷新率的稳定，从而提供无卡顿、无延迟的流畅多屏显示体验。</p>
<h4 id="完美测试全面验证"><a class="markdownIt-Anchor" href="#完美测试全面验证"></a> <strong>完美测试，全面验证</strong></h4>
<p>无论是系统启动后的自动配置，还是多屏切换的流畅性，RK3568开发板都表现得游刃有余。通过一系列的功能测试和长期稳定性测试，我们确保了系统的高可靠性和强健的表现力。</p>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> <strong>总结</strong></h3>
<p>RK3568开发板凭借其出色的多屏显示能力，为广告机、电子看板等应用场景提供了强大的技术支撑。无论是高清画面显示，还是多接口灵活配置，RK3568都表现出了卓越的稳定性和性能。</p>
<hr />
<p>希望这个推文样式符合你的需求，它专注于推广和介绍RK3568多屏显示功能的应用与优势。如果有任何其他需求或修改意见，请随时告诉我！</p>
<p>Get-AppxPackage -Name “<em>Ubuntu</em>” | Select PackageFamilyName</p>
<p>%LOCALAPPDATA%\Packages&lt;CanonicalGroupLimited.Ubuntu22.04LTS_79rhkp1fndgsc&gt;\LocalState&lt;disk&gt;.vhdx</p>
<h1 id="810工作记录"><a class="markdownIt-Anchor" href="#810工作记录"></a> 8.10工作记录</h1>
<h3 id="解锁rk3568的潜力多屏异显功能全面解析"><a class="markdownIt-Anchor" href="#解锁rk3568的潜力多屏异显功能全面解析"></a> 解锁RK3568的潜力：多屏异显功能全面解析</h3>
<p>RK3568作为瑞芯微公司推出的一款高性能、多媒体应用处理器，凭借其卓越的性能和丰富的外设接口，迅速在嵌入式开发领域占据一席之地，成为广告机、电子看板、会议系统等多种应用场景的理想选择。</p>
<p>随着RK3568的广泛应用，越来越多的开发者和企业开始关注其“多屏异显”功能。那究竟如何解锁RK3568在多屏异显方面的全部潜力呢？在此，我们将对RK3568多屏异显的技术实现和应用场景进行解析。</p>
<h4 id="rk3568多屏异显实现原理"><a class="markdownIt-Anchor" href="#rk3568多屏异显实现原理"></a> RK3568多屏异显实现原理</h4>
<h4 id="rk3568多屏异显应用领域"><a class="markdownIt-Anchor" href="#rk3568多屏异显应用领域"></a> RK3568多屏异显应用领域</h4>
<p>RK3568的多屏异显功能不仅适用于广告机和信息发布系统，还在工业控制、智能家居、多媒体教学等多个领域展现出强大的应用潜力，提供灵活的显示解决方案。</p>
<ul>
<li><strong>工业监控</strong>：实现多监控画面的独立显示，关键设备数据和监控视频同步展示，助力精准管理与决策。</li>
<li><strong>智能家居</strong>：家庭安全监控与能源管理系统数据同步显示，提升家庭管理的便捷性与直观性。</li>
<li><strong>多媒体教学</strong>：主屏播放教学内容，副屏展示互动信息，增强课堂互动效果。</li>
<li><strong>数字标牌与广告展示</strong>：多屏展示不同广告内容，更有效地吸引观众，提升信息传达效率。</li>
<li><strong>医疗影像显示</strong>：同步显示不同类型影像，提高诊断的准确性与效率。</li>
</ul>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202408101726573.png" alt="image-20240810172635440" /></p>
<p>==也可以找一个更匹配的图==</p>
<h4 id="rk3568多屏异显实例演示"><a class="markdownIt-Anchor" href="#rk3568多屏异显实例演示"></a> RK3568多屏异显实例演示</h4>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1SR4y1S7G7/">https://www.bilibili.com/video/BV1SR4y1S7G7/</a></p>
<p>==多屏异显异触的具体实现方法可参考《19【北京迅为】itop-3568 开发板多屏显示手册 【底板1.7版】v1.1.doc》==</p>
<p>官网：<a target="_blank" rel="noopener" href="http://www.topeetboard.com/">http://www.topeetboard.com/</a></p>
<p>销售工程师：010-8527-0708 转接 1</p>
<p>技术支持类：010-8527-0708 转接 2</p>
<p>方案定制类：010-8527-0708 转接 3</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/14_mpp学习"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/14/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/14_mpp%E5%AD%A6%E4%B9%A0/"
    >mpp的学习</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/14/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/14_mpp%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2024-07-14T09:17:03.000Z" itemprop="datePublished">2024-07-14</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="mpp源码获取"><a class="markdownIt-Anchor" href="#mpp源码获取"></a> mpp源码获取</h1>
<p><a target="_blank" rel="noopener" href="https://github.com/rockchip-linux/mpp">https://github.com/rockchip-linux/mpp</a></p>
<h1 id="mpp-readme介绍"><a class="markdownIt-Anchor" href="#mpp-readme介绍"></a> mpp readme介绍</h1>
<h2 id="媒体处理平台-media-process-platform-mpp-模块目录说明"><a class="markdownIt-Anchor" href="#媒体处理平台-media-process-platform-mpp-模块目录说明"></a> 媒体处理平台 (Media Process Platform, MPP) 模块目录说明：</h2>
<h3 id="mpp-目录说明"><a class="markdownIt-Anchor" href="#mpp-目录说明"></a> MPP 目录说明：</h3>
<ul>
<li><strong>MPP</strong>：媒体处理平台   Media Process Platform</li>
<li><strong>MPI</strong>：媒体处理接口   Media Process Interface</li>
<li><strong>HAL</strong>：硬件抽象层  Hardware Abstract Layer</li>
<li><strong>OSAL</strong>：操作系统抽象层  Operation System Abstract Layer</li>
</ul>
<h3 id="规则"><a class="markdownIt-Anchor" href="#规则"></a> 规则：</h3>
<ol>
<li><strong>头文件安排规则</strong>
<ul>
<li>每个模块文件夹中的 <code>inc</code> 目录用于外部模块使用。</li>
<li>模块内部头文件应与实现文件一起放置。</li>
<li>头文件不应包含任何相对路径或绝对路径，所有包含路径应在 <code>Makefile</code> 中指定。</li>
</ul>
</li>
<li><strong>编译系统规则</strong>
<ul>
<li>使用 CMake 作为跨平台编译管理系统。</li>
<li>使用 CMake 的 out-of-source build，最终的二进制文件和库将安装到 <code>out/</code> 目录。</li>
</ul>
</li>
<li><strong>头文件包含顺序</strong>
<ul>
<li>MODULE_TAG</li>
<li>系统头文件</li>
<li>OSAL 头文件</li>
<li>模块头文件</li>
</ul>
</li>
</ol>
<h3 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项：</h3>
<ol>
<li>
<p>不再维护 Windows 支持。</p>
</li>
<li>
<p>MPP 现在支持所有 Rockchip 芯片，包括：</p>
<ul>
<li>RK29XX/RK30XX/RK31XX</li>
<li>RK3288/RK3368/RK3399</li>
<li>RK3228/RK3229/RK3228H/RK3328</li>
<li>RK3528/RK3528A</li>
<li>RK3562</li>
<li>RK3566/RK3568</li>
<li>RK3588</li>
<li>RV1108/RV1107</li>
<li>RV1109/RV1126</li>
</ul>
</li>
<li>
<p>MPP 支持硬件支持的所有格式，除了 VC1。</p>
</li>
<li>
<p>可以在 Linux 和 Android 上获取 MPP 的应用示例：</p>
<ul>
<li>Linux: <a target="_blank" rel="noopener" href="https://github.com/WainDing/mpp_linux_cpp">mpp_linux_cpp</a>, <a target="_blank" rel="noopener" href="https://github.com/MUZLATAN/ffmpeg_rtsp_mpp">ffmpeg_rtsp_mpp</a></li>
<li>Android: <a target="_blank" rel="noopener" href="https://github.com/c-xh/RKMediaCodecDemo">RKMediaCodecDemo</a></li>
</ul>
</li>
<li>
<p>官方 GitHub:</p>
<p>rockchip-linux/mpp</p>
<ul>
<li>开发版 GitHub: <a target="_blank" rel="noopener" href="https://github.com/HermanChen/mpp">HermanChen/mpp</a></li>
<li>开发版 Gitee: <a target="_blank" rel="noopener" href="https://gitee.com/hermanchen82/mpp">hermanchen82/mpp</a></li>
</ul>
</li>
<li>
<p>提交消息格式应基于 <a target="_blank" rel="noopener" href="https://keepachangelog.com/en/1.0.0/">Keep a Changelog</a></p>
</li>
</ol>
<p>更多文档可在 <a target="_blank" rel="noopener" href="http://opensource.rock-chips.com/wiki_Mpp">Rockchips 开源平台</a> 找到。</p>
<h3 id="mpp-目录结构"><a class="markdownIt-Anchor" href="#mpp-目录结构"></a> MPP 目录结构：</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">csharp复制代码  top</span><br><span class="line">   ├── build                  // CMake out-of-source build 目录</span><br><span class="line">   │   ├── cmake              // cmake 脚本目录</span><br><span class="line">   │   ├── android            // android build 目录</span><br><span class="line">   │   ├── linux              // linux build 目录</span><br><span class="line">   │   ├── vc10-x86_64        // Visual Studio 2010 on x86_64 build 目录</span><br><span class="line">   │   ├── vc12-x86_64        // Visual Studio 2013 on x86_64 build 目录</span><br><span class="line">   ├── doc                    // MPP 设计文档</span><br><span class="line">   ├── inc                    // 外部使用的头文件，包括平台头文件和 MPI 头文件</span><br><span class="line">   ├── mpp                    // 媒体处理平台: MPI 功能私有实现和 MPP 基础结构</span><br><span class="line">   │   ├── base               // 基本组件，包括 MppBuffer、MppFrame、MppPacket、MppTask、MppMeta 等</span><br><span class="line">   │   ├── common             // 视频编解码协议语法接口，供编解码器解析器和 HAL 使用</span><br><span class="line">   │   ├── codec              // 所有视频编解码器解析器，将流转换为协议结构</span><br><span class="line">   │   │   ├── inc            // 编解码器模块提供的外部使用头文件</span><br><span class="line">   │   │   ├── dec            // 解码器解析器工作流示例</span><br><span class="line">   │   │   ├── enc            // 编码器控制器工作流示例</span><br><span class="line">   │   ├── hal                // 硬件抽象层 (HAL)：MPI 中使用的模块</span><br><span class="line">   │   │   ├── inc            // HAL 提供的外部使用头文件</span><br><span class="line">   │   │   ├── iep            // IEP 用户库</span><br><span class="line">   │   │   ├── pp             // 后处理器用户库</span><br><span class="line">   │   │   ├── rga            // RGA 用户库</span><br><span class="line">   │   │   ├── deinter        // 去交错功能模块，包括 PP/IEP/RGA</span><br><span class="line">   │   │   ├── rkdec          // Rockchip 硬件解码器寄存器生成</span><br><span class="line">   │   │   ├── vpu            // VPU 寄存器生成库</span><br><span class="line">   │   ├── legacy             // 生成新的 libvpu，包括旧的 vpuapi 路径和新的 mpp 路径</span><br><span class="line">   │   ├── test               // MPP 内部视频协议单元测试和演示</span><br><span class="line">   ├── test                   // MPP 缓冲区/包组件单元测试和 MPP/MPI/VPU_API 演示</span><br><span class="line">   ├── out                    // 最终发布的二进制输出目录</span><br><span class="line">   │   ├── bin                // 可执行二进制文件输出目录</span><br><span class="line">   │   ├── inc                // 头文件输出目录</span><br><span class="line">   │   ├── lib                // 库文件输出目录</span><br><span class="line">   ├── osal                   // 操作系统抽象层：不同操作系统的抽象层</span><br><span class="line">   │   ├── allocator          // 支持的分配器，包括 Android 的 ion 和 Linux 的 drm</span><br><span class="line">   │   ├── android            // Google&#x27;s Android</span><br><span class="line">   │   ├── inc                // MPP 模块的 OSAL 头文件</span><br><span class="line">   │   ├── linux              // 主线 Linux 内核</span><br><span class="line">   │   ├── windows            // Microsoft&#x27;s Windows</span><br><span class="line">   │   ├── test               // OSAL 单元测试</span><br><span class="line">   ├── tools                  // 代码风格格式化工具</span><br><span class="line">   ├── utils                  // 小工具函数</span><br></pre></td></tr></table></figure>
<h3 id="mpp-实现整体框架"><a class="markdownIt-Anchor" href="#mpp-实现整体框架"></a> MPP 实现整体框架：</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    +---------------------------------------+</span><br><span class="line">    |                                       |</span><br><span class="line">    | ffmpeg / OpenMax / gstreamer / libva  |</span><br><span class="line">    |                                       |</span><br><span class="line">    +---------------------------------------+</span><br><span class="line"></span><br><span class="line">+-------------------- MPP ----------------------+</span><br><span class="line">|                                               |</span><br><span class="line">|   +-------------------------+    +--------+   |</span><br><span class="line">|   |                         |    |        |   |</span><br><span class="line">|   |        MPI / MPP        |    |        |   |</span><br><span class="line">|   |   buffer queue manage   |    |        |   |</span><br><span class="line">|   |                         |    |        |   |</span><br><span class="line">|   +-------------------------+    |        |   |</span><br><span class="line">|                                  |        |   |</span><br><span class="line">|   +-------------------------+    |        |   |</span><br><span class="line">|   |                         |    |        |   |</span><br><span class="line">|   |          codec          |    |  OSAL  |   |</span><br><span class="line">|   |    decoder / encoder    |    |        |   |</span><br><span class="line">|   |                         |    |        |   |</span><br><span class="line">|   +-------------------------+    |        |   |</span><br><span class="line">|                                  |        |   |</span><br><span class="line">|   +-----------+ +-----------+    |        |   |</span><br><span class="line">|   |           | |           |    |        |   |</span><br><span class="line">|   |  parser   | |    HAL    |    |        |   |</span><br><span class="line">|   |  recoder  | |  reg_gen  |    |        |   |</span><br><span class="line">|   |           | |           |    |        |   |</span><br><span class="line">|   +-----------+ +-----------+    +--------|   |</span><br><span class="line">|                                               |</span><br><span class="line">+-------------------- MPP ----------------------+</span><br><span class="line"></span><br><span class="line">    +---------------------------------------+</span><br><span class="line">    |                                       |</span><br><span class="line">    |                kernel                 |</span><br><span class="line">    |       RK vcodec_service / v4l2        |</span><br><span class="line">    |                                       |</span><br><span class="line">    +---------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="媒体处理接口-media-process-interface-分层结构"><a class="markdownIt-Anchor" href="#媒体处理接口-media-process-interface-分层结构"></a> 媒体处理接口 (Media Process Interface) 分层结构：</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">            +-------------------+</span><br><span class="line">            |                   |</span><br><span class="line">            |        MPI        |</span><br><span class="line">            |                   |</span><br><span class="line">            +---------+---------+</span><br><span class="line">                      |</span><br><span class="line">                      |</span><br><span class="line">                      v</span><br><span class="line">            +---------+---------+</span><br><span class="line">            |                   |</span><br><span class="line">        +---+        ctx        +---+</span><br><span class="line">        |   |                   |   |</span><br><span class="line">        |   +-------------------+   |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------+-------+           +-------+-------+</span><br><span class="line">|               |           |               |</span><br><span class="line">|     packet    |           |     frame     |</span><br><span class="line">|               |           |               |</span><br><span class="line">+---------------+           +-------+-------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        |     +---------------+     |</span><br><span class="line">        |     |               |     |</span><br><span class="line">        +----&gt;+     buffer    +&lt;----+</span><br><span class="line">              |               |</span><br><span class="line">              +---------------+</span><br></pre></td></tr></table></figure>
<h2 id="h264-解码器示例工作流程"><a class="markdownIt-Anchor" href="#h264-解码器示例工作流程"></a> H.264 解码器示例工作流程：</h2>
<p>视频流首先由 MPI/MPP 层排队，MPP 将流发送到 codec 层，codec 层解析流头并生成协议标准输出。此输出将发送到 HAL 生成寄存器文件集并与硬件通信。硬件完成任务并发送回信息。MPP 通知 codec 硬件结果，codec 按显示顺序输出解码帧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">               MPP              decoder             parser              HAL</span><br><span class="line"></span><br><span class="line">+                  +                  +                  +                  +</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|   open context   |                  |                  |                  |</span><br><span class="line">+----------------&gt; |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|       init       |                  |                  |                  |</span><br><span class="line">+----------------&gt; |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |       init       |                  |                  |</span><br><span class="line">|                  +----------------&gt; |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |       init       |                  |</span><br><span class="line">|                  |                  +----------------&gt; |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |       open       |</span><br><span class="line">|                  |                  +-----------------------------------&gt; |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|      decode      |                  |                  |                  |</span><br><span class="line">+----------------&gt; |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |   send_stream    |                  |                  |</span><br><span class="line">|                  +----------------&gt; |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |   parse_stream   |                  |</span><br><span class="line">|                  |                  +----------------&gt; |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |  reg generation  |</span><br><span class="line">|                  |                  +-----------------------------------&gt; |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |    send_regs     |</span><br><span class="line">|                  |                  +-----------------------------------&gt; |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |    wait_regs     |</span><br><span class="line">|                  |                  +-----------------------------------&gt; |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |  notify_hw_end   |                  |</span><br><span class="line">|                  |                  +----------------&gt; |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |   get_picture    |                  |                  |</span><br><span class="line">|                  +----------------&gt; |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |   get_picture    |                  |</span><br><span class="line">|                  |                  +----------------&gt; |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|      flush       |                  |                  |                  |</span><br><span class="line">+----------------&gt; |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |      flush       |                  |                  |</span><br><span class="line">|                  +----------------&gt; |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |      reset       |                  |</span><br><span class="line">|                  |                  +----------------&gt; |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|      close       |                  |                  |                  |</span><br><span class="line">+----------------&gt; |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |      close       |                  |                  |</span><br><span class="line">|                  +----------------&gt; |                  |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |      close       |                  |</span><br><span class="line">|                  |                  +----------------&gt; |                  |</span><br><span class="line">|                  |                  |                  |                  |</span><br><span class="line">|                  |                  |                  |      close       |</span><br><span class="line">|                  |                  +-----------------------------------&gt; |</span><br><span class="line">+                  +                  +                  +                  +</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>解码器支持三种内存使用模式：</p>
<h3 id="模式1纯内部模式"><a class="markdownIt-Anchor" href="#模式1纯内部模式"></a> 模式1：纯内部模式</h3>
<p>在这种模式下，用户不会调用 <code>MPP_DEC_SET_EXT_BUF_GROUP</code> 控制解码器，只需调用 <code>MPP_DEC_SET_INFO_CHANGE_READY</code> 让解码器继续运行。解码器会在内部创建缓冲区，用户需要释放每一帧获取到的缓冲区。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>简单易用，快速获得示例。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ol>
<li>解码器的缓冲区在解码器关闭前可能无法返回，可能导致内存泄漏或崩溃。</li>
<li>无法控制解码器的内存使用，解码器处于自由运行状态，会消耗所有可用内存。</li>
<li>实现零拷贝显示路径较为困难。</li>
</ol>
<h3 id="模式2半内部模式"><a class="markdownIt-Anchor" href="#模式2半内部模式"></a> 模式2：半内部模式</h3>
<p>这种模式是当前 <code>mpi_dec_test</code> 代码使用的模式。用户需要根据返回的信息变化创建 <code>MppBufferGroup</code>，并使用 <code>mpp_buffer_group_limit_config</code> 限制解码器的内存使用。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>简单易用。</li>
<li>用户可以在解码器关闭后释放 <code>MppBufferGroup</code>，内存可以更安全地保留更长时间。</li>
<li>可以通过 <code>mpp_buffer_group_limit_config</code> 限制内存使用。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>缓冲区限制仍不准确，内存使用是100%固定的。</li>
<li>实现零拷贝显示路径仍然困难。</li>
</ol>
<h3 id="模式3纯外部模式"><a class="markdownIt-Anchor" href="#模式3纯外部模式"></a> 模式3：纯外部模式</h3>
<p>在这种模式下，用户需要创建空的 <code>MppBufferGroup</code> 并通过文件句柄从外部分配器导入内存。在 Android 上，surfaceflinger 将创建缓冲区，mediaserver 从 surfaceflinger 获取文件句柄并提交到解码器的 <code>MppBufferGroup</code>。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>最有效的零拷贝显示方式。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ol>
<li>学习和使用较为困难。</li>
<li>播放器工作流可能限制这种使用方式。</li>
<li>可能需要外部解析器来获取外部分配器所需的正确缓冲区大小。</li>
</ol>
<h3 id="所需缓冲区大小计算"><a class="markdownIt-Anchor" href="#所需缓冲区大小计算"></a> 所需缓冲区大小计算：</h3>
<ul>
<li>像素数据：<code>hor_stride * ver_stride * 3 / 2</code></li>
<li>额外信息：<code>hor_stride * ver_stride / 2</code></li>
<li>总计：<code>hor_stride * ver_stride * 2</code></li>
</ul>
<p>对于 H.264/H.265 编码器，20+ 个缓冲区足够；对于其他编解码器，10 个缓冲区足够。</p>
<h1 id="源码的编译"><a class="markdownIt-Anchor" href="#源码的编译"></a> 源码的编译</h1>
<p>其实源码的编译很简单，总共是需要安装三个工具分别为gcc g++和cmake</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install g++-9-aarch64-linux-gnu gcc-9-aarch64-linux-gnu </span><br></pre></td></tr></table></figure>
<p>然后链接一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++</span><br><span class="line">sudo ln -s /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++</span><br></pre></td></tr></table></figure>
<p>然后进入源码目录下的mpp/build/linux/aarch64文件如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407142150341.png" alt="image-20240714215012311" /></p>
<p>然后运行make-Makefiles.bash可执行程序，在此之前需要加一下-DCMAKE_INSTALL_PREFIX=install \在make-Makefiles.bash的cmake中，添加完成如下图所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407142156183.png" alt="image-20240714215615158" /></p>
<p>​	生成Makefile如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407142150861.png" alt="image-20240714215058817" /></p>
<p>​	然后运行make -j32 &amp;&amp; make install 编译安装如下图所示</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407142202549.png" alt="image-20240714220256505" /></p>
<p>​	然后会在当前目录下生成install目录，如下图所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407142203966.png" alt="image-20240714220326941" /></p>
</li>
</ol>
<p>而在install目录下有对应的二进制测试文件和头文件以及对应的vpu库，</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407142203977.png" alt="image-20240714220351911" /></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/13_rga的学习"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/10/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/13_rga%E7%9A%84%E5%AD%A6%E4%B9%A0/"
    >rga的学习</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/10/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/13_rga%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2024-07-10T09:17:03.000Z" itemprop="datePublished">2024-07-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="rga源码获取"><a class="markdownIt-Anchor" href="#rga源码获取"></a> RGA源码获取</h1>
<p><a target="_blank" rel="noopener" href="https://meta.zbox.filez.com/v/link/view/c3559cbbf1514464bf109b44901db9fa">https://meta.zbox.filez.com/v/link/view/c3559cbbf1514464bf109b44901db9fa</a>  提取码rkrga</p>
<h1 id="rga源码编译"><a class="markdownIt-Anchor" href="#rga源码编译"></a> RGA源码编译</h1>
<p>​	其实源码的编译很简单，总共是需要安装三个工具分别为gcc g++和cmake</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install cmake g++ gcc </span><br><span class="line">sudo apt install g++-9-aarch64-linux-gnu gcc-9-aarch64-linux-gnu </span><br></pre></td></tr></table></figure>
<p>然后链接一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++</span><br><span class="line">sudo ln -s /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++</span><br></pre></td></tr></table></figure>
<p>然后修改源码目录的cmake交叉编译器设置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim toolchains/toolchain_linux.cmake</span><br></pre></td></tr></table></figure>
<p>修改完成之后如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102042549.png" alt="image-20240710204241524" /></p>
<p>​	然后直接运行cmake-linux.sh编译即可，编译完成如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SCRIPT_DIR=$PWD</span><br><span class="line">SOURCE_PATH=$&#123;SCRIPT_DIR&#125;</span><br><span class="line">TOOLCHAIN_PATH=$&#123;SOURCE_PATH&#125;/toolchains/toolchain_linux.cmake</span><br><span class="line"></span><br><span class="line">cmake 	-DBUILD_TOOLCHAINS_PATH=$&#123;TOOLCHAIN_PATH&#125; .</span><br><span class="line"></span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line">popd</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102055766.png" alt="image-20240710205510721" /></p>
<p>​	会在源码目录下的build/build_linux/install目录中生成后续使用的头文件和库，可以看到lib库不仅提供了so动态库还提供了.a静态库</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102055622.png" alt="image-20240710205553582" /></p>
<p>​	使用file命令也可以得到他的架构类型：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102057202.png" alt="image-20240710205752179" /></p>
<p>​	还有第二种meson的编译方法，其实还挺简单，但是我还是很喜欢cmake 的方式的，方便，只需要改一下cross/cross_file_aarch64.txt文件，修改以下几个地方，还挺简单，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c = &#x27;/usr/bin/aarch64-linux-gnu-gcc&#x27;</span><br><span class="line">cpp = &#x27;/usr/bin/aarch64-linux-gnu-g++&#x27;</span><br><span class="line">ar = &#x27;/usr/bin/aarch64-linux-gnu-ar&#x27;</span><br><span class="line">strip = &#x27;/usr/bin/aarch64-linux-gnu-strip&#x27;</span><br></pre></td></tr></table></figure>
<p>​	然后运行./meson.sh脚本即可，具体步骤如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102151221.png" alt="image-20240710215119171" /></p>
<p>​	会将要用到的包放到build/meson_aarch64/install目录下，具体如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407102152895.png" alt="image-20240710215203845" /></p>
<p>​	行了，就先到这里。</p>
<h1 id="开发板上rga的使用"><a class="markdownIt-Anchor" href="#开发板上rga的使用"></a> 开发板上RGA的使用</h1>
<p>​	上面的编译步骤直接在开发板上试了一下，然后替换对应的rga库，然后来测试rga Demo，首先获取RGA属性，具体如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407122110073.png" alt="image-20240712211025031" /></p>
<table>
<thead>
<tr>
<th style="text-align:left">项目</th>
<th style="text-align:left">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">选择模式</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">im2d querystring</td>
<td style="text-align:left">…</td>
</tr>
<tr>
<td style="text-align:left">RGA 演示模式</td>
<td style="text-align:left">0x0</td>
</tr>
<tr>
<td style="text-align:left">RGA API 版本</td>
<td style="text-align:left">1.10.1_[0]</td>
</tr>
<tr>
<td style="text-align:left">RGA 供应商</td>
<td style="text-align:left">Rockchip Electronics Co.,Ltd.</td>
</tr>
<tr>
<td style="text-align:left">RGA API 版本</td>
<td style="text-align:left">v1.10.1_[0]</td>
</tr>
<tr>
<td style="text-align:left">RGA 版本</td>
<td style="text-align:left">RGA_2_Enhance RGA_3</td>
</tr>
<tr>
<td style="text-align:left">最大输入分辨率</td>
<td style="text-align:left">8192x8192</td>
</tr>
<tr>
<td style="text-align:left">最大输出分辨率</td>
<td style="text-align:left">8128x8128</td>
</tr>
<tr>
<td style="text-align:left">字节对齐</td>
<td style="text-align:left">16 byte</td>
</tr>
<tr>
<td style="text-align:left">缩放比例范围</td>
<td style="text-align:left">0.0625 ~ 16</td>
</tr>
<tr>
<td style="text-align:left">输入格式</td>
<td style="text-align:left">RGBA/ARGB_8888, RGB_888, RGB_565, ARGB_4444, ARGB_5551, YUV420_sp_8bit, YUV420_sp_10bit, YUV420_p_8bit, YUV420_p_10bit, YUV422_sp_8bit, YUV422_sp_10bit, YUV422_p_8bit, YUV422_p_10bit, YUYV422, YUV400</td>
</tr>
<tr>
<td style="text-align:left">输出格式</td>
<td style="text-align:left">RGBA/ARGB_8888, RGB_888, RGB_565, ARGB_4444, ARGB_5551, RGBA_4444, RGBA_5551, YUV420_sp_8bit, YUV420_sp_10bit, YUV420_p_8bit, YUV422_sp_8bit, YUV422_sp_10bit, YUV422_p_8bit, YUYV420, YUYV422, YUV400, Y4</td>
</tr>
<tr>
<td style="text-align:left">RGA 功能</td>
<td style="text-align:left">color_fill, color_palette, ROP, quantize, src1_r2y_csc, dst_full_csc, FBC_mode, blend_in_YUV, BT.2020</td>
</tr>
<tr>
<td style="text-align:left">预期性能</td>
<td style="text-align:left">最大 4 像素/周期</td>
</tr>
</tbody>
</table>
<p>以下是整理后的<code>rgaImDemo</code>使用说明：</p>
<h3 id="用法"><a class="markdownIt-Anchor" href="#用法"></a> 用法：</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh复制代码rgaImDemo [--help/-h] [--while/-w=(time)] [--querystring/--querystring=&lt;options&gt;]</span><br><span class="line">          [--copy] [--resize=&lt;up/down&gt;] [--crop] [--rotate=90/180/270]</span><br><span class="line">          [--flip=H/V] [--translate] [--blend] [--cvtcolor]</span><br><span class="line">          [--fill=blue/green/red]</span><br></pre></td></tr></table></figure>
<h3 id="参数说明"><a class="markdownIt-Anchor" href="#参数说明"></a> 参数说明：</h3>
<h4 id="基本选项"><a class="markdownIt-Anchor" href="#基本选项"></a> 基本选项：</h4>
<ul>
<li><code>--help</code> / <code>-h</code>: 显示帮助信息。</li>
<li><code>--while</code> / <code>-w=(time)</code>: 设置循环模式，用户可以自行设定循环次数。</li>
</ul>
<h4 id="查询信息"><a class="markdownIt-Anchor" href="#查询信息"></a> 查询信息：</h4>
<ul>
<li>
<pre><code class="shell">--querystring
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> / </span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">--querystring=&lt;options&gt;</span><br></pre></td></tr></table></figure>

: 根据选项打印当前版本的RGA的版本或支持信息。如果没有输入选项，则打印所有版本和支持信息。

&lt;options&gt;

- `vendor`: 打印厂商信息。
- `version`: 打印RGA版本和librga/im2d_api版本。
- `maxinput`: 打印最大输入分辨率。
- `maxoutput`: 打印最大输出分辨率。
- `scalelimit`: 打印缩放限制。
- `inputformat`: 打印支持的输入格式。
- `outputformat`: 打印支持的输出格式。
- `expected`: 打印预期性能。
- `all`: 打印所有信息（默认）。

</code></pre>
</li>
</ul>
<h4 id="图像处理选项"><a class="markdownIt-Anchor" href="#图像处理选项"></a> 图像处理选项：</h4>
<ul>
<li>
<p><code>--copy</code>: 使用RGA复制图像，默认是720p到720p。</p>
</li>
<li>
<p><code>--resize</code>: 使用RGA调整图像大小，可以选择放大或缩小。</p>
<options>
<ul>
<li><code>up</code>: 放大720p (1280x720) -&gt; 1080p (1920x1080)。</li>
<li><code>down</code>: 缩小720p (1280x720) -&gt; 480p (720x480)。</li>
</ul>
</li>
<li>
<p><code>--crop</code>: 使用RGA裁剪图像，默认从(100,100)位置裁剪300x300大小的图像。</p>
</li>
<li>
<p><code>--rotate</code>: 使用RGA旋转图像，可以选择旋转角度。</p>
<options>
<ul>
<li><code>90</code>: 旋转90度。</li>
<li><code>180</code>: 旋转180度。</li>
<li><code>270</code>: 旋转270度。</li>
</ul>
</li>
<li>
<p><code>--flip</code>: 使用RGA翻转图像，可以选择水平或垂直翻转。</p>
<options>
<ul>
<li><code>H</code>: 水平镜像。</li>
<li><code>V</code>: 垂直镜像。</li>
</ul>
</li>
<li>
<p><code>--translate</code>: 使用RGA平移图像，默认平移(300,300)。</p>
</li>
<li>
<p><code>--blend</code>: 使用RGA混合图像，默认是Porter-Duff的’SRC over DST’模式。</p>
<options>
<ul>
<li><code>src</code>: Porter-Duff SRC模式。</li>
<li><code>dst</code>: Porter-Duff DST模式。</li>
<li><code>src-over</code>: Porter-Duff SRC-OVER模式（默认）。</li>
<li><code>dst-over</code>: Porter-Duff DST-OVER模式。</li>
<li><code>src-in</code>: Porter-Duff SRC-IN模式。</li>
<li><code>dst-in</code>: Porter-Duff DST-IN模式。</li>
<li><code>src-out</code>: Porter-Duff SRC-OUT模式。</li>
<li><code>dst-out</code>: Porter-Duff DST-OUT模式。</li>
<li><code>src-atop</code>: Porter-Duff SRC-ATOP模式。</li>
<li><code>dst-atop</code>: Porter-Duff DST-ATOP模式。</li>
<li><code>xor</code>: Porter-Duff XOR模式。</li>
</ul>
</li>
<li>
<p><code>--cvtcolor</code>: 使用RGA修改图像格式和颜色空间，默认是RGBA8888到NV12。</p>
</li>
<li>
<p><code>--fill</code>: 使用RGA填充图像颜色，可以选择填充为蓝色、绿色或红色。</p>
<options>
<ul>
<li><code>red</code>: 填充为红色。</li>
<li><code>blue</code>: 填充为蓝色。</li>
<li><code>green</code>: 填充为绿色。</li>
<li><code>&lt;value&gt;</code>: 填充颜色值，格式为红[0:7]绿[8:15]蓝[16:23] alpha[24:31]。</li>
</ul>
</li>
</ul>
<h3 id="示例用法"><a class="markdownIt-Anchor" href="#示例用法"></a> 示例用法：</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sh复制代码# 显示帮助信息</span><br><span class="line">rgaImDemo --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置循环模式，循环次数为10</span></span><br><span class="line">rgaImDemo --while=10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印RGA版本和支持信息</span></span><br><span class="line">rgaImDemo --querystring=all</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制图像</span></span><br><span class="line">rgaImDemo --copy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">放大图像</span></span><br><span class="line">rgaImDemo --resize=up</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">旋转图像90度</span></span><br><span class="line">rgaImDemo --rotate=90</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">水平翻转图像</span></span><br><span class="line">rgaImDemo --flip=H</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">混合图像，使用Porter-Duff的SRC模式</span></span><br><span class="line">rgaImDemo --blend=src</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">填充图像为蓝色</span></span><br><span class="line">rgaImDemo --fill=blue</span><br></pre></td></tr></table></figure>
<p>以上是整理后的<code>rgaImDemo</code>使用说明，以便更好地理解和使用该工具。</p>
<p>终于显示出来了正常的图片，有点问题：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407122201709.png" alt="image-20240712220110651" /></p>
<p>​	 现在可以了，这是我的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 RGBA 数据</span></span><br><span class="line">img_data = np.fromfile(<span class="string">&#x27;out0w1920-h1080-rgba8888.bin&#x27;</span>, dtype=np.uint8)</span><br><span class="line">img = img_data.reshape((<span class="number">1080</span>, <span class="number">1920</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为 BGR 格式</span></span><br><span class="line">img_bgr = cv2.cvtColor(img, cv2.COLOR_RGBA2BGR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存图像为 JPG 格式</span></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;output.jpg&#x27;</span>, img_bgr)</span><br></pre></td></tr></table></figure>
<p>​	终于算是能读取出来了，行了现在去研究一下RGA的代码吧，其实也没啥，这个RGA的程序跟oepncv是一样的，这一点毋庸置疑，只要学过opencv这个就不是问题。</p>
<h1 id="rga_resize_demo"><a class="markdownIt-Anchor" href="#rga_resize_demo"></a> rga_resize_demo</h1>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 版权所有 (C) 2022  Rockchip Electronics Co., Ltd.</span></span><br><span class="line"><span class="comment"> * 作者:</span></span><br><span class="line"><span class="comment"> *     YuQiaowei &lt;cerf.yu@rock-chips.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 根据 Apache 许可证，版本 2.0（“许可证”）授权；</span></span><br><span class="line"><span class="comment"> * 您不能根据许可证使用此文件，除非符合许可证。</span></span><br><span class="line"><span class="comment"> * 您可以在以下网址获取许可证副本：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 除非适用法律要求或书面同意，按照许可证分发的软件</span></span><br><span class="line"><span class="comment"> * 是按“原样”分发的，没有任何明示或暗示的担保或条件。</span></span><br><span class="line"><span class="comment"> * 请参阅许可证以了解管理权限和限制的特定语言。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_NDEBUG 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG <span class="string">&quot;rga_resize_demo&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RgaUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;im2d.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCAL_FILE_PATH <span class="string">&quot;/data&quot;</span>  <span class="comment">// 本地文件路径</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> src_width, src_height, src_format;  <span class="comment">// 源图像的宽度、高度和格式</span></span><br><span class="line">    <span class="type">int</span> dst_width, dst_height, dst_format;  <span class="comment">// 目标图像的宽度、高度和格式</span></span><br><span class="line">    <span class="type">char</span> *src_buf, *dst_buf;  <span class="comment">// 源图像和目标图像的缓冲区</span></span><br><span class="line">    <span class="type">int</span> src_buf_size, dst_buf_size;  <span class="comment">// 源图像和目标图像的缓冲区大小</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rga_buffer_t</span> src_img, dst_img;  <span class="comment">// RGA 缓冲区类型</span></span><br><span class="line">    <span class="type">rga_buffer_handle_t</span> src_handle, dst_handle;  <span class="comment">// RGA 缓冲区句柄</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;src_img, <span class="number">0</span>, <span class="keyword">sizeof</span>(src_img));  <span class="comment">// 初始化源图像缓冲区</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dst_img, <span class="number">0</span>, <span class="keyword">sizeof</span>(dst_img));  <span class="comment">// 初始化目标图像缓冲区</span></span><br><span class="line"></span><br><span class="line">    src_width = <span class="number">1280</span>;  <span class="comment">// 设置源图像宽度</span></span><br><span class="line">    src_height = <span class="number">720</span>;  <span class="comment">// 设置源图像高度</span></span><br><span class="line">    src_format = RK_FORMAT_RGBA_8888;  <span class="comment">// 设置源图像格式</span></span><br><span class="line"></span><br><span class="line">    dst_width = <span class="number">1920</span>;  <span class="comment">// 设置目标图像宽度</span></span><br><span class="line">    dst_height = <span class="number">1080</span>;  <span class="comment">// 设置目标图像高度</span></span><br><span class="line">    dst_format = RK_FORMAT_RGBA_8888;  <span class="comment">// 设置目标图像格式</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算源图像和目标图像缓冲区大小</span></span><br><span class="line">    src_buf_size = src_width * src_height * get_bpp_from_format(src_format);</span><br><span class="line">    dst_buf_size = dst_width * dst_height * get_bpp_from_format(dst_format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为源图像和目标图像分配缓冲区</span></span><br><span class="line">    src_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(src_buf_size);</span><br><span class="line">    dst_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(dst_buf_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 填充图像数据 */</span></span><br><span class="line">    <span class="comment">// 从文件读取源图像数据，如果读取失败则绘制RGBA图像</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != read_image_from_file(src_buf, LOCAL_FILE_PATH, src_width, src_height, src_format, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;src image read err\n&quot;</span>);</span><br><span class="line">        draw_rgba(src_buf, src_width, src_height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(dst_buf, <span class="number">0x80</span>, dst_buf_size);  <span class="comment">// 初始化目标图像缓冲区</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导入虚拟地址缓冲区</span></span><br><span class="line">    src_handle = importbuffer_virtualaddr(src_buf, src_buf_size);</span><br><span class="line">    dst_handle = importbuffer_virtualaddr(dst_buf, dst_buf_size);</span><br><span class="line">    <span class="keyword">if</span> (src_handle == <span class="number">0</span> || dst_handle == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;importbuffer failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> release_buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装缓冲区句柄为RGA缓冲区</span></span><br><span class="line">    src_img = wrapbuffer_handle(src_handle, src_width, src_height, src_format);</span><br><span class="line">    dst_img = wrapbuffer_handle(dst_handle, dst_width, dst_height, dst_format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 将源图像放大到1920*1080。</span></span><br><span class="line"><span class="comment">        --------------    ---------------------</span></span><br><span class="line"><span class="comment">        |            |    |                   |</span></span><br><span class="line"><span class="comment">        |  src_img   |    |     dst_img       |</span></span><br><span class="line"><span class="comment">        |            | =&gt; |                   |</span></span><br><span class="line"><span class="comment">        --------------    |                   |</span></span><br><span class="line"><span class="comment">                          |                   |</span></span><br><span class="line"><span class="comment">                          ---------------------</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查源图像和目标图像的合法性</span></span><br><span class="line">    ret = imcheck(src_img, dst_img, &#123;&#125;, &#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span> (IM_STATUS_NOERROR != ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d, check error! %s&quot;</span>, __LINE__, imStrError((IM_STATUS)ret));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用RGA库进行图像缩放</span></span><br><span class="line">    ret = imresize(src_img, dst_img);</span><br><span class="line">    <span class="keyword">if</span> (ret == IM_STATUS_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s running success!\n&quot;</span>, LOG_TAG);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s running failed, %s\n&quot;</span>, LOG_TAG, imStrError((IM_STATUS)ret));</span><br><span class="line">        <span class="keyword">goto</span> release_buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将目标图像写入文件</span></span><br><span class="line">    write_image_to_file(dst_buf, LOCAL_FILE_PATH, dst_width, dst_height, dst_format, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">release_buffer:</span><br><span class="line">    <span class="comment">// 释放RGA缓冲区句柄</span></span><br><span class="line">    <span class="keyword">if</span> (src_handle)</span><br><span class="line">        releasebuffer_handle(src_handle);</span><br><span class="line">    <span class="keyword">if</span> (dst_handle)</span><br><span class="line">        releasebuffer_handle(dst_handle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放缓冲区内存</span></span><br><span class="line">    <span class="keyword">if</span> (src_buf)</span><br><span class="line">        <span class="built_in">free</span>(src_buf);</span><br><span class="line">    <span class="keyword">if</span> (dst_buf)</span><br><span class="line">        <span class="built_in">free</span>(dst_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​</p>
<p>deb安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y sudo locales git fakeroot devscripts cmake vim qemu-user-static:arm64 binfmt-support \</span><br><span class="line">        dh-make dh-exec pkg-kde-tools device-tree-compiler:arm64 bc cpio parted dosfstools mtools libssl-dev:arm64 \</span><br><span class="line">        g++-aarch64-linux-gnu dpkg-dev meson debhelper pkgconf</span><br></pre></td></tr></table></figure>
<p>编译deb包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo DEB_BUILD_OPTIONS=nocheck dpkg-buildpackage -b -d -uc -us -aarm64</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-06_工作记录/22_工作记录(七月第四个星期)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/04/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/22_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC%E5%9B%9B%E4%B8%AA%E6%98%9F%E6%9C%9F)/"
    >工作记录(7月第4个星期)</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/04/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/22_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC%E5%9B%9B%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-date">
  <time datetime="2024-07-04T13:26:56.000Z" itemprop="datePublished">2024-07-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="工作记录星期一"><a class="markdownIt-Anchor" href="#工作记录星期一"></a> 工作记录(星期一)</h1>
<p>==摆脱一份幻觉比发现一个真理更能使人明智==</p>
<p>==当你在凝视深渊的时候深渊也在凝视你==</p>
<hr />
<p>在周六、周日的时候，也算是测试完了这些系统，目前还有问题的是HDMIIN，这个功能确实需要测试看看，目前的现象是无法采集到正确的图像信息。</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407221025887.png" alt="image-20240722102556818" /></p>
<p>HDMIIN的问题就先这样了，没有什么要搞的东西，现在这样可以的，能用就行，然后我要做什么呢？</p>
<p>gnome的构建吗，其实目前对我来说并没什么用，客户对于这个系统也并不是必要的，不是吗，而其他的一些包，我感觉并没有什么实际的作用，等真正用到了再说吧，现在确是不知道做什么了。</p>
<p>pip install opencv-python==4.5.4 -i <a target="_blank" rel="noopener" href="https://repo.huaweicloud.com/repository/pypi/simple/">https://repo.huaweicloud.com/repository/pypi/simple/</a></p>
<p>sudo apt install pip</p>
<p>pip install opencv-python -i <a target="_blank" rel="noopener" href="https://repo.huaweicloud.com/repository/pypi/simple/">https://repo.huaweicloud.com/repository/pypi/simple/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace cv;</span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 使用GStreamer管道获取视频，并确保使用BGR格式</span></span><br><span class="line">    VideoCapture <span class="title function_">cap</span><span class="params">(<span class="string">&quot;v4l2src device=/dev/video20 ! video/x-raw, format=(string)BGR ! videoconvert ! appsink&quot;</span>, cv::CAP_GSTREAMER)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!cap.isOpened()) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;Error: Could not open video device.&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> time0 = static_cast&lt;<span class="type">double</span>&gt;(getTickCount()); <span class="comment">// 获取开始时间</span></span><br><span class="line">    Mat frame;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        cap &gt;&gt; frame;</span><br><span class="line">        <span class="keyword">if</span> (frame.empty()) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;Error: Could not read frame.&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> time1 = static_cast&lt;<span class="type">double</span>&gt;(getTickCount()); <span class="comment">// 获取当前时间</span></span><br><span class="line">        <span class="type">double</span> fps = getTickFrequency() / (time1 - time0); <span class="comment">// 计算帧率</span></span><br><span class="line">        time0 = time1; <span class="comment">// 更新开始时间</span></span><br><span class="line"></span><br><span class="line">        putText(frame, <span class="string">&quot;FPS: &quot;</span> + to_string(fps), Point(<span class="number">10</span>, <span class="number">30</span>), FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>); <span class="comment">// 在图像上显示帧率</span></span><br><span class="line">        imshow(<span class="string">&quot;Video&quot;</span>, frame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 按下&#x27;q&#x27;键退出循环</span></span><br><span class="line">        <span class="keyword">if</span> (waitKey(<span class="number">1</span>) == <span class="string">&#x27;q&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放资源并关闭窗口</span></span><br><span class="line">    cap.release();</span><br><span class="line">    destroyAllWindows();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[   35.263239] start_addr=(0x20000), end_addr=(0x40000), buffer_size=(0x20000), smp_number_max=(16384)</span><br><span class="line">[   35.283231] [BT_RFKILL]: Enter rfkill_rk_pm_complete</span><br><span class="line">[   35.283234] []: ** disable irq</span><br><span class="line">[   35.283242] [BT_RFKILL]: Enable UART_RTS</span><br><span class="line">[   35.288046] Restarting tasks ... </span><br><span class="line">[   35.291903] healthd: battery l=100 v=0 t=42.4 h=2 st=2 chg=a</span><br><span class="line">[   35.298048] done.</span><br><span class="line">[   35.298175] PM: suspend exit 2024-07-24 02:00:01.967182114 UTC</span><br><span class="line">[   35.398375] PM: suspend entry 2024-07-24 02:00:02.067387124 UTC</span><br><span class="line">[   35.398395] PM: Syncing filesystems ... done.</span><br><span class="line">[   35.407545] Freezing user space processes ... (elapsed 0.004 seconds) done.</span><br><span class="line">[   35.411975] Freezing remaining freezable tasks ... (elapsed 0.002 seconds) done.</span><br><span class="line">[   35.414587] Suspending console(s) (use no_console_suspend to debug)</span><br><span class="line">[   35.414855] [BT_RFKILL]: Enter rfkill_rk_pm_prepare</span><br><span class="line">[   35.414858] [BT_RFKILL]: Disable UART_RTS</span><br><span class="line">[   35.414933] [BT_RFKILL]: enable irq for bt wakeup host</span><br><span class="line">[   35.525388] led_ctl suspend:power off!</span><br><span class="line">[   35.525394] led_ctl suspend:power off!</span><br><span class="line">[   35.525406] [WLAN_RFKILL]: Enter rfkill_wlan_suspend</span><br><span class="line">[   35.578742] PM: suspend of devices complete after 163.237 msecs</span><br><span class="line">[   35.581533] PM: late suspend of devices complete after 2.311 msecs</span><br><span class="line">[   35.583572] PM: noirq suspend of devices complete after 2.028 msecs</span><br><span class="line">[   35.583577] Disabling non-boot CPUs ...</span><br><span class="line">[   35.602059] CPU1: shutdown</span><br><span class="line">[   35.614931] psci: Retrying again to check for CPU kill</span><br><span class="line">[   35.614935] psci: CPU1 killed.</span><br><span class="line">[   35.661990] CPU2: shutdown</span><br><span class="line">[   35.661995] psci: CPU2 killed.</span><br><span class="line">[   35.708593] CPU3: shutdown</span><br><span class="line">[   35.721591] psci: Retrying again to check for CPU kill</span><br><span class="line">[   35.721595] psci: CPU3 killed.</span><br><span class="line">[   35.761853] CPU4: shutdown</span><br><span class="line">[   35.774951] psci: Retrying again to check for CPU kill</span><br><span class="line">[   35.774955] psci: CPU4 killed.</span><br><span class="line">[   35.815139] CPU5: shutdown</span><br><span class="line">[   35.828258] psci: Retrying again to check for CPU kill</span><br><span class="line">[   35.828262] psci: CPU5 killed.</span><br><span class="line">[   35.840234] Enabling non-boot CPUs ...</span><br><span class="line">[   35.859198] Detected VIPT I-cache on CPU1</span><br><span class="line">[   35.859224] CPU1: found redistributor 1 region 0:0x00000000fef20000</span><br><span class="line">[   35.859267] CPU1: update cpu_capacity 401</span><br><span class="line">[   35.859271] CPU1: Booted secondary processor [410fd034]</span><br><span class="line">[   35.859749] CPU1 is up</span><br><span class="line">[   35.879169] Detected VIPT I-cache on CPU2</span><br><span class="line">[   35.879190] CPU2: found redistributor 2 region 0:0x00000000fef40000</span><br><span class="line">[   35.879221] CPU2: update cpu_capacity 401</span><br><span class="line">[   35.879225] CPU2: Booted secondary processor [410fd034]</span><br><span class="line">[   35.879778] CPU2 is up</span><br><span class="line">[   35.899357] Detected VIPT I-cache on CPU3</span><br><span class="line">[   35.899378] CPU3: found redistributor 3 region 0:0x00000000fef60000</span><br><span class="line">[   35.899410] CPU3: update cpu_capacity 401</span><br><span class="line">[   35.899413] CPU3: Booted secondary processor [410fd034]</span><br><span class="line">[   35.900147] CPU3 is up</span><br><span class="line">[   35.919599] Detected PIPT I-cache on CPU4</span><br><span class="line">[   35.919624] CPU4: found redistributor 100 region 0:0x00000000fef80000</span><br><span class="line">[   35.919671] CPU4: update cpu_capacity 1024</span><br><span class="line">[   35.919674] CPU4: Booted secondary processor [410fd082]</span><br><span class="line">[   35.922157] cpu cpu4: avs=0, target-scale=17</span><br><span class="line">[   35.922248] cpu cpu4: l=10000 h=2147483647 hyst=5000 l_limit=0 h_limit=0</span><br><span class="line">[   35.922406] CPU4 is up</span><br><span class="line">[   35.946469] Detected PIPT I-cache on CPU5</span><br><span class="line">[   35.946487] CPU5: found redistributor 101 region 0:0x00000000fefa0000</span><br><span class="line">[   35.946521] CPU5: update cpu_capacity 1024</span><br><span class="line">[   35.946524] CPU5: Booted secondary processor [410fd082]</span><br><span class="line">[   35.949428] CPU5 is up</span><br><span class="line">[   35.951567] PM: noirq resume of devices complete after 2.027 msecs</span><br><span class="line">[   35.953788] PM: early resume of devices complete after 1.899 msecs</span><br><span class="line">[   35.959114] rk_gmac-dwmac fe300000.ethernet: init for RGMII</span><br><span class="line">[   36.162727] [WLAN_RFKILL]: Enter rfkill_wlan_resume</span><br><span class="line">[   36.162734] led_ctl resume:power on!</span><br><span class="line">[   36.162737] led_ctl resume:power on!</span><br><span class="line">[   36.164058] Suspended for 816.167 seconds</span><br><span class="line">[   36.165770] cdn-dp fec00000.dp: [drm:cdn_dp_pd_event_work] Not connected. Disabling cdn</span><br><span class="line">[   36.191636] mmc_host mmc2: Bus speed (slot 0) = 50000000Hz (slot req 50000000Hz, actual 50000000HZ div = 0)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在Linux中，电源管理通常涉及不同的休眠和低功耗模式。你提供的宏定义代表了各种不同的电源管理模式和操作。这些模式用于控制系统在休眠时的不同状态和行为，特别是在嵌入式系统和片上系统（SoC）中。以下是对这些模式的解释：</p>
<ol>
<li><strong>RKPM_SLP_WFI (Wait for Interrupt)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_WFI (1 &lt;&lt; 0)</code></li>
<li><strong>解释</strong>：这种模式下，CPU进入低功耗状态并等待中断。CPU时钟停止，直到某个外部或内部事件发生并产生中断信号，使CPU从等待状态中唤醒。</li>
</ul>
</li>
<li><strong>RKPM_SLP_ARMPD (ARM Power Down)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_ARMPD (1 &lt;&lt; 1)</code></li>
<li><strong>解释</strong>：这种模式下，ARM处理器核心完全关闭电源。此模式通常用于深度睡眠或休眠状态，以节省更多的电能。</li>
</ul>
</li>
<li><strong>RKPM_SLP_PERILPPD (Peripheral Power Down)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_PERILPPD (1 &lt;&lt; 2)</code></li>
<li><strong>解释</strong>：这种模式下，系统外围设备（如I/O接口）关闭电源。这有助于减少不必要的能耗，尤其是在外围设备不需要工作的情况下。</li>
</ul>
</li>
<li><strong>RKPM_SLP_DDR_RET (DDR Retention)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_DDR_RET (1 &lt;&lt; 3)</code></li>
<li><strong>解释</strong>：这种模式下，DDR内存进入保留状态（Retention），即保持其内容但消耗极低的功率。这种模式确保在系统唤醒时数据不会丢失。</li>
</ul>
</li>
<li><strong>RKPM_SLP_PLLPD (PLL Power Down)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_PLLPD (1 &lt;&lt; 4)</code></li>
<li><strong>解释</strong>：这种模式下，关闭相位锁定环（PLL）。PLL用于生成高频时钟信号，关闭PLL可以显著降低功耗。</li>
</ul>
</li>
<li><strong>RKPM_SLP_OSC_DIS (Oscillator Disable)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_OSC_DIS (1 &lt;&lt; 5)</code></li>
<li><strong>解释</strong>：这种模式下，关闭系统时钟振荡器。关闭振荡器进一步减少功耗，但系统不能进行任何操作，直到振荡器重新启用。</li>
</ul>
</li>
<li><strong>RKPM_SLP_CENTER_PD (Center Power Down)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_CENTER_PD (1 &lt;&lt; 6)</code></li>
<li><strong>解释</strong>：这种模式可能涉及SoC的中心部分（如中央总线、桥接器等）的电源关闭。这有助于节省核心架构的功耗。</li>
</ul>
</li>
<li><strong>RKPM_SLP_AP_PWROFF (Application Processor Power Off)</strong>
<ul>
<li><strong>定义</strong>：<code>#define RKPM_SLP_AP_PWROFF (1 &lt;&lt; 7)</code></li>
<li><strong>解释</strong>：这种模式下，应用处理器（AP）关闭电源。通常用于整个系统的深度休眠或关机状态。</li>
</ul>
</li>
</ol>
<p>这些模式在不同的硬件平台上可能有不同的实现，但总体目标都是在系统处于闲置或低活动状态时，通过不同程度的关闭或降低系统组件的功耗来节省能耗。这些模式通常由内核或电源管理固件管理，并根据系统状态动态启用或禁用。</p>
<p>原版</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rockchip,sleep-mode-config = &lt;</span><br><span class="line">        (0</span><br><span class="line">        | RKPM_SLP_ARMPD</span><br><span class="line">        | RKPM_SLP_PERILPPD</span><br><span class="line">        | RKPM_SLP_DDR_RET</span><br><span class="line">        | RKPM_SLP_PLLPD</span><br><span class="line">        | RKPM_SLP_CENTER_PD</span><br><span class="line">        | RKPM_SLP_OSC_DIS</span><br><span class="line">        | RKPM_SLP_AP_PWROFF</span><br><span class="line">        )</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br></pre></td></tr></table></figure>
<p>0.0719A     873mw</p>
<p>修改之后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rockchip,sleep-mode-config = &lt;</span><br><span class="line">    (0</span><br><span class="line">    | RKPM_SLP_PERILPPD</span><br><span class="line">    | RKPM_SLP_DDR_RET</span><br><span class="line">    | RKPM_SLP_PLLPD</span><br><span class="line">    | RKPM_SLP_CENTER_PD</span><br><span class="line">    | RKPM_SLP_WFI  // 这里可以添加WFI（等待中断）模式</span><br><span class="line">    )</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br><span class="line">rockchip,sleep-mode-config = &lt;</span><br><span class="line">(0 | RKPM_SLP_ARMPD | RKPM_SLP_DDR_RET | RKPM_SLP_PLLPD | RKPM_SLP_CENTER_PD | RKPM_SLP_WFI)</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rockchip,sleep-mode-config = &lt;</span><br><span class="line">(0 | RKPM_SLP_ARMPD | RKPM_SLP_PERILPPD | RKPM_SLP_DDR_RET | RKPM_SLP_PLLPD | RKPM_SLP_CENTER_PD | RKPM_SLP_WFI</span><br><span class="line">)</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407251252853.png" alt="image-20240725125209751" /></p>
<h1 id="726星期五"><a class="markdownIt-Anchor" href="#726星期五"></a> 7.26(星期五)</h1>
<p>正常打印：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407261341447.png" alt="image-20240726134155346" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407261441549.png" alt="image-20240726144108455" /></p>
<p>然后来等着，看一下即可，目前的时间是99.86211,去简单的学习一下。</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407270955190.png" alt="image-20240727095508101" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407270955095.png" alt="image-20240727095525008" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407271010234.png" alt="image-20240727101019198" /></p>
<p>第一次休眠打印</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">��INFO:    sleep mode config[0xfe]:</span><br><span class="line">INFO:           AP_PWROFF</span><br><span class="line">INFO:           SLP_ARMPD</span><br><span class="line">INFO:           SLP_PLLPD</span><br><span class="line">INFO:           DDR_RET</span><br><span class="line">INFO:           SLP_CENTER_PD</span><br><span class="line">INFO:           OSC_DIS</span><br><span class="line">INFO:    wakeup source config[0x4]:</span><br><span class="line">INFO:           GPIO interrupt can wakeup system</span><br><span class="line">INFO:    PWM CONFIG[0x4]:</span><br><span class="line">INFO:           PWM: PWM2D_REGULATOR_EN</span><br><span class="line">INFO:    APIOS info[0x0]:</span><br><span class="line">INFO:           not config</span><br><span class="line">INFO:    GPIO POWER INFO:</span><br><span class="line">INFO:           not config</span><br><span class="line">INFO:    PMU_MODE_CONG: 0x1477bf79</span><br><span class="line">INFO:    RK3399 the wake up information:</span><br><span class="line">INFO:    wake up status: 0x4</span><br><span class="line">INFO:           GPIO interrupt wakeup</span><br><span class="line">INFO:           GPIO0: 0x0</span><br><span class="line">INFO:           GPIO1: 0x200000</span><br><span class="line">INFO:           GPIO2: 0x0</span><br><span class="line">INFO:           GPIO3: 0x0</span><br><span class="line">INFO:           GPIO4: 0x0</span><br></pre></td></tr></table></figure>
<p>第二次休眠打印</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">INFO:    sleep mode config[0xfe]:</span><br><span class="line">INFO:           AP_PWROFF</span><br><span class="line">INFO:           SLP_ARMPD</span><br><span class="line">INFO:           SLP_PLLPD</span><br><span class="line">INFO:           DDR_RET</span><br><span class="line">INFO:           SLP_CENTER_PD</span><br><span class="line">INFO:           OSC_DIS</span><br><span class="line">INFO:    wakeup source config[0x4]:</span><br><span class="line">INFO:           GPIO interrupt can wakeup system</span><br><span class="line">INFO:    PWM CONFIG[0x4]:</span><br><span class="line">INFO:           PWM: PWM2D_REGULATOR_EN</span><br><span class="line">INFO:    APIOS info[0x0]:</span><br><span class="line">INFO:           not config</span><br><span class="line">INFO:    GPIO POWER INFO:</span><br><span class="line">INFO:           not config</span><br><span class="line">INFO:    PMU_MODE_CONG: 0x1477bf79</span><br><span class="line">INFO:    RK3399 the wake up information:</span><br><span class="line">INFO:    wake up status: 0x4</span><br><span class="line">INFO:           GPIO interrupt wakeup</span><br><span class="line">INFO:           GPIO0: 0x0</span><br><span class="line">INFO:           GPIO1: 0x200000</span><br><span class="line">INFO:           GPIO2: 0x0</span><br><span class="line">INFO:           GPIO3: 0x0</span><br><span class="line">INFO:           GPIO4: 0x0</span><br></pre></td></tr></table></figure>
<p>第三次休眠打印：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">INFO:    sleep mode config[0xfe]:</span><br><span class="line">INFO:           AP_PWROFF</span><br><span class="line">INFO:           SLP_ARMPD</span><br><span class="line">INFO:           SLP_PLLPD</span><br><span class="line">INFO:           DDR_RET</span><br><span class="line">INFO:           SLP_CENTER_PD</span><br><span class="line">INFO:           OSC_DIS</span><br><span class="line">INFO:    wakeup source config[0x4]:</span><br><span class="line">INFO:           GPIO interrupt can wakeup system</span><br><span class="line">INFO:    PWM CONFIG[0x4]:</span><br><span class="line">INFO:           PWM: PWM2D_REGULATOR_EN</span><br><span class="line">INFO:    APIOS info[0x0]:</span><br><span class="line">INFO:           not config</span><br><span class="line">INFO:    GPIO POWER INFO:</span><br><span class="line">INFO:           not config</span><br><span class="line">INFO:    PMU_MODE_CONG: 0x1477bf79</span><br></pre></td></tr></table></figure>
<h1 id="729工作记录"><a class="markdownIt-Anchor" href="#729工作记录"></a> 7.29(工作记录)</h1>
<p>==在迷失的时候，不如去选择更艰辛的那条路，因为即使是再长的路也会有尽头==</p>
<hr />
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291026125.png" alt="image-20240729102632080" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rk_gmac-dwmac fe010000.ethernet eth0</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291036121.png" alt="image-20240729103613072" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rk_gmac-dwmac fe2a0000.ethernet eth1</span><br></pre></td></tr></table></figure>
<p>根据原理图可知，gmac0 实际上是网口1，而gmac1实际上是网口0，这一点要注意，然后</p>
<p>底板引脚</p>
<table>
<thead>
<tr>
<th>网卡0复位</th>
<th>GMAC0_RSTn_GPIO3_B7</th>
<th>111</th>
</tr>
</thead>
<tbody>
<tr>
<td>网卡0中断</td>
<td>GMAC0_INT/PMEB_GPIO3_C0</td>
<td>112</td>
</tr>
<tr>
<td>网卡1复位</td>
<td>GMAC1_RSTn_GPIO3_B0</td>
<td>104</td>
</tr>
<tr>
<td>网卡1中断</td>
<td>GMAC1_INT/PMEB_GPIO3_A7</td>
<td>103</td>
</tr>
</tbody>
</table>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291044855.png" alt="image-20240729104434752" /></p>
<p>客户底板引脚</p>
<table>
<thead>
<tr>
<th>网卡0复位</th>
<th>GMAC0_RSTn_GPIO3_A5</th>
<th>101</th>
</tr>
</thead>
<tbody>
<tr>
<td>网卡0中断</td>
<td>GMAC0_INT/PMEB_GPIO3_A6</td>
<td>102</td>
</tr>
<tr>
<td>网卡1复位</td>
<td>GMAC1_RSTn_GPIO3_B0</td>
<td>103</td>
</tr>
<tr>
<td>网卡1中断</td>
<td>GMAC1_INT/PMEB_GPIO3_A7</td>
<td>104</td>
</tr>
</tbody>
</table>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291045839.png" alt="image-20240729104533761" /></p>
<p>关于网卡的问题就先这样了，如果想让我来解决硬件问题，那可真的太难了，听会儿音乐吧。然后来看CAN的问题，首先说一下为什么不用板载的CAN，而是使用SPI转can，这是因为SOC的canIP是有问题的，所以无可避免的就会出现问题，现在客户是用了两对SPI，两个MCP2515来转换的，具体使用的是哪个SPI转CAN呢</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291410804.png" alt="image-20240729141002769" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291410137.png" alt="image-20240729141008107" /></p>
<p>​	这个图肯定是看不出来的，而且我也不需要看他这里的转换，重要的是这个图：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291410896.png" alt="image-20240729141050862" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291412134.png" alt="image-20240729141216108" /></p>
<p>mcp2515的驱动默认是在5.10中有的，编译完成如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291434838.png" alt="image-20240729143415754" /></p>
<p>然后开始确定硬件SPI编号。</p>
<p>CAN2</p>
<table>
<thead>
<tr>
<th>引脚标号</th>
<th>网络名</th>
<th>复用关系</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>CON4 7</td>
<td><strong>PCIE20_PERSTn_M1</strong></td>
<td>SPI1_MOSI_M1</td>
<td>GPIO3_C1</td>
</tr>
<tr>
<td>CON4 11</td>
<td>HP_DET_L_GPIO3_C2</td>
<td>SPI1_MISO_M1</td>
<td>GPIO3_C2_d</td>
</tr>
<tr>
<td>CON4 13</td>
<td>5G_RESET</td>
<td>SPI1_CLK_M1</td>
<td>GPIO3_C3_d</td>
</tr>
<tr>
<td>CON4 35</td>
<td>PCIE30X1_PERSTn_M1</td>
<td>SPI1_CS0_M1</td>
<td>GPIO3_A1_d</td>
</tr>
<tr>
<td>CON2 54</td>
<td>I2C3_SCL_M0</td>
<td>感觉没啥用</td>
<td></td>
</tr>
</tbody>
</table>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291506008.png" alt="image-20240729150638976" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291507091.png" alt="image-20240729150700067" /></p>
<p>CAN1</p>
<table>
<thead>
<tr>
<th>引脚标号</th>
<th>网络名</th>
<th>复用关系</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>CON4 17</td>
<td>PCIE20_CLKREQn_M1</td>
<td>SPI0_MISO_M1</td>
<td>GPIO2_D0_d</td>
</tr>
<tr>
<td>CON4 19</td>
<td>PCIE20_WAKEn_M1</td>
<td>SPI0_MOSI_M1</td>
<td>GPIO2_D1_d</td>
</tr>
<tr>
<td>CON4 21</td>
<td>PCIE30X1_CLKREQn_M1</td>
<td>SPI0_CS0_M1</td>
<td>GPIO2_D2_d</td>
</tr>
<tr>
<td>CON4 23</td>
<td>PCIE30X1_WAKEn_M1</td>
<td>SPI0_CLK_M1</td>
<td>GPIO2_D3_d</td>
</tr>
<tr>
<td>CON2 37</td>
<td>I2S3_MCLK_M0</td>
<td>感觉没啥用</td>
<td></td>
</tr>
</tbody>
</table>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291506301.png" alt="image-20240729150610262" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">	clk8m: clk8m &#123;</span><br><span class="line">        compatible = <span class="string">&quot;fixed-clock&quot;</span>;</span><br><span class="line">        <span class="meta">#clock-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">        clock-frequency = &lt;<span class="number">40000000</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&amp;spi0 &#123;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;spi0m1_cs0  &amp;spi0m1_pins&gt;;</span><br><span class="line">     pinctrl<span class="number">-1</span> = &lt;&amp;spi0m1_cs0  &amp;spi0m1_pins_hs&gt;;</span><br><span class="line">	</span><br><span class="line">	mcp25180: mcp25180@<span class="number">0</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;microchip,mcp2518fd&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">		spi-max-frequency = &lt;<span class="number">10000000</span>&gt;;</span><br><span class="line">		interrupts-extended = &lt;&amp;gpio3 RK_PA2 IRQ_TYPE_LEVEL_LOW&gt;;</span><br><span class="line">		pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">		pinctrl<span class="number">-0</span> = &lt;&amp;mcp2518_int0&gt;;</span><br><span class="line">		clocks = &lt;&amp;clk8m&gt;;</span><br><span class="line">		status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;spi1 &#123;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;spi1m1_cs0  &amp;spi1m1_pins&gt;;</span><br><span class="line">     pinctrl<span class="number">-1</span> = &lt;&amp;spi1m1_cs0  &amp;spi1m1_pins_hs&gt;;</span><br><span class="line">	</span><br><span class="line">	mcp25181: mcp25181@<span class="number">0</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;microchip,mcp2518fd&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">		spi-max-frequency = &lt;<span class="number">10000000</span>&gt;;</span><br><span class="line">		interrupts-extended = &lt;&amp;gpio3 RK_PA3 IRQ_TYPE_LEVEL_LOW&gt;;</span><br><span class="line">		pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">		pinctrl<span class="number">-0</span> = &lt;&amp;mcp2518_int1&gt;;</span><br><span class="line">		clocks = &lt;&amp;clk8m&gt;;</span><br><span class="line">		status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">mcp2518-gpio&#123;</span><br><span class="line">            mcp2518_int0:mcp2518-int0 &#123;</span><br><span class="line">                rockchip,pins = &lt;<span class="number">3</span> RK_PA2 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">    </span><br><span class="line">            mcp2518_int1:mcp2518-int1 &#123;</span><br><span class="line">                rockchip,pins = &lt;<span class="number">3</span> RK_PA3 RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291507481.png" alt="image-20240729150743430" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291508565.png" alt="image-20240729150816426" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ip link set can0 down</span><br><span class="line">ip link set can0 type can bitrate 1000000 dbitrate 3000000 fd on</span><br><span class="line">ip -details link show can0</span><br><span class="line">ip link set can0 up</span><br><span class="line">cansend can0 123#DEADBEEF</span><br><span class="line">candump can0 &amp;</span><br></pre></td></tr></table></figure>
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291539994.png" alt="image-20240729153910946" style="zoom: 150%;" />
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291606589.png" alt="image-20240729160643497" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291607642.png" alt="image-20240729160711596" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291607038.png" alt="image-20240729160716973" /></p>
<p>标准帧</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291608844.png" alt="image-20240729160819804" /></p>
<p>扩展帧</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291608418.png" alt="image-20240729160813385" /></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ip link set can1 down</span><br><span class="line">ip link set can1 type can bitrate 1000000 dbitrate 3000000 fd on</span><br><span class="line">ip -details link show can1</span><br><span class="line">ip link set can1 up</span><br><span class="line">cansend can1 123#DEADBEEF</span><br><span class="line">candump can1 &amp;</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291609494.png" alt="image-20240729160955409" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291610756.png" alt="image-20240729161032720" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291610705.png" alt="image-20240729161037643" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291611876.png" alt="image-20240729161100840" /></p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407291611055.png" alt="image-20240729161141014" /></p>
<h1 id="731-星期三"><a class="markdownIt-Anchor" href="#731-星期三"></a> 7.31 星期三</h1>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407311330097.png" alt="image-20240731133018043" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/irqdesc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/irqdomain.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* PWM0 registers  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_CNTR			0x00  <span class="comment">/* Counter Register */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_HPR			0x04  <span class="comment">/* Period Register */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_LPR			0x08  <span class="comment">/* Duty Cycle Register */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_CTRL			0x0c  <span class="comment">/* Control Register */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM3_REG_INTSTS			0x10  <span class="comment">/* Interrupt Status Refister For Pwm3*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM2_REG_INTSTS			0x20  <span class="comment">/* Interrupt Status Refister For Pwm2*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM1_REG_INTSTS			0x30  <span class="comment">/* Interrupt Status Refister For Pwm1*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM0_REG_INTSTS			0x40  <span class="comment">/* Interrupt Status Refister For Pwm0*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM3_REG_INT_EN			0x14  <span class="comment">/* Interrupt Enable Refister For Pwm3*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM2_REG_INT_EN			0x24  <span class="comment">/* Interrupt Enable Refister For Pwm2*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM1_REG_INT_EN			0x34  <span class="comment">/* Interrupt Enable Refister For Pwm1*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM0_REG_INT_EN			0x44  <span class="comment">/* Interrupt Enable Refister For Pwm0*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*REG_CTRL bits definitions*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_ENABLE			(1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_DISABLE			(0 &lt;&lt; 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*operation mode*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MODE_ONESHOT		(0x00 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MODE_CONTINUMOUS		(0x01 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_MODE_CAPTURE		(0x02 &lt;&lt; 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*duty cycle output polarity*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_DUTY_POSTIVE		(0x01 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_DUTY_NEGATIVE		(0x00 &lt;&lt; 3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*incative state output polarity*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INACTIVE_POSTIVE		(0x01 &lt;&lt; 4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INACTIVE_NEGATIVE		(0x00 &lt;&lt; 4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*clock source select*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CLK_SCALE			(1 &lt;&lt; 9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CLK_NON_SCALE		(0 &lt;&lt; 9)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_INT			(1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_INT			(1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_INT			(1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_INT			(1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWR_KEY_INT			(1 &lt;&lt; 7)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_POL			(1 &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_POL			(1 &lt;&lt; 9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_POL			(1 &lt;&lt; 10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_POL			(1 &lt;&lt; 11)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_INT_ENABLE		(1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH0_INT_DISABLE		(0 &lt;&lt; 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_INT_ENABLE		(1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH1_INT_DISABLE		(0 &lt;&lt; 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_INT_ENABLE		(1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH2_INT_DISABLE		(0 &lt;&lt; 2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_INT_ENABLE		(1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH3_INT_DISABLE		(0 &lt;&lt; 3)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INT_ENABLE			1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_INT_DISABLE			0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*prescale factor*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMCR_MIN_PRESCALE			0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMCR_MAX_PRESCALE			0x07</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMDCR_MIN_DUTY				0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMDCR_MAX_DUTY				0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMPCR_MIN_PERIOD			0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMPCR_MAX_PERIOD			0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMPCR_MIN_PERIOD			0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWMPCR_MAX_PERIOD			0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_INTSTS(n)		((3 - (n)) * 0x10 + 0x10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_INT_EN(n)		((3 - (n)) * 0x10 + 0x14)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RK_PWM_VERSION_ID(n)		((3 - (n)) * 0x10 + 0x2c)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_CTRL(n)	((3 - (n)) * 0x10 + 0x50)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_LPRE(n)	((3 - (n)) * 0x10 + 0x54)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_HPRE(n)	((3 - (n)) * 0x10 + 0x58)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_LD(n)		((3 - (n)) * 0x10 + 0x5C)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_HD_ZERO(n)	((3 - (n)) * 0x10 + 0x60)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_REG_PWRMATCH_HD_ONE(n)	((3 - (n)) * 0x10 + 0x64)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWRMATCH_VALUE(n)		((3 - (n)) * 0x10 + 0x68)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWRCAPTURE_VALUE(n)		((3 - (n)) * 0x10 + 0x9c)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH_INT(n)			BIT(n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH_POL(n)			BIT(n+8)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_CH_INT_ENABLE(n)		BIT(n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PWM_PWR_INT_ENABLE		BIT(7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CH3_PWRKEY_ENABLE		BIT(3)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rk_pwm_capture_data_t</span> &#123;</span></span><br><span class="line">	<span class="type">u_int64_t</span> period_ns;</span><br><span class="line">	<span class="type">u_int64_t</span> duty_ns;</span><br><span class="line">    <span class="type">u_int8_t</span> capture_ms;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">pwm_div</span> &#123;</span></span><br><span class="line">	PWM_DIV1	= (<span class="number">0x0</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV2	= (<span class="number">0x1</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV4	= (<span class="number">0x2</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV8	= (<span class="number">0x3</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV16	= (<span class="number">0x4</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV32	= (<span class="number">0x5</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV64	= (<span class="number">0x6</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">	PWM_DIV128	= (<span class="number">0x7</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_MUTEX</span><span class="params">(device_mutex)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">CAP_STATE</span> &#123;</span></span><br><span class="line">	CAP_IDLE,</span><br><span class="line">	CAP_JUNK_DATA_1, <span class="comment">// lpr/hpr junk data</span></span><br><span class="line">	CAP_JUNK_DATA_2, <span class="comment">// hpr/lpr junk data</span></span><br><span class="line">	CAP_DATA,</span><br><span class="line">	CAP_DONE,</span><br><span class="line">&#125; eCAP_STATE;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rk_pwm_capture_sysfs_data</span> &#123;</span></span><br><span class="line">	<span class="type">dev_t</span> devno;</span><br><span class="line">	<span class="type">char</span> dev_name[<span class="number">32</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> _<span class="title">cdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *_<span class="title">class</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rk_pwm_capture_data_t</span> <span class="title">user_data</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rk_pwm_capture_drvdata</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> __iomem *base;</span><br><span class="line">    <span class="type">int</span> irq;</span><br><span class="line">	<span class="type">int</span> irq_cpu_id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line">    <span class="type">int</span> pwm_freq_nstime; <span class="comment">// Cycle of capture clock</span></span><br><span class="line">    <span class="type">int</span> pwm_channel; <span class="comment">// RK3568 4-built-in PWM channels</span></span><br><span class="line">    <span class="type">int</span> hpr; <span class="comment">// Number of capture clock cycles at high levels in a PWM cycle to be tested</span></span><br><span class="line">	<span class="type">int</span> lpr; <span class="comment">// Number of capture clock cycles at low levels in a PWM cycle to be tested</span></span><br><span class="line">	eCAP_STATE state;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">p_clk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rk_pwm_capture_sysfs_data</span> <span class="title">sdata</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-02_瑞芯微/12_uboot启动流程"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/04/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/12_uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"
    >uboot启动流程</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/04/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/12_uboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time datetime="2024-07-04T08:17:03.000Z" itemprop="datePublished">2024-07-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>​	uboot可以说就是一个裸机程序，是由一系列程序链接起来的，链接脚本为根目录下的u-boot.lds</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042042636.png" alt="image-20240704204240610" /></p>
<p>*(.__image_copy_start) 先不用管，零长度数组。</p>
<p>然后是 arch/arm/cpu/armv8/start.o (.text*)</p>
<p>首次执行的是reset，具体内容如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042056573.png" alt="image-20240704205658534" /></p>
<p>​	而reset的内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	/* Allow the board to save important registers */</span><br><span class="line">	b	save_boot_params</span><br><span class="line">.globl	save_boot_params_ret</span><br></pre></td></tr></table></figure>
<p>反正最后是跳到了arch/arm/lib/crt0.S，在该汇编文件中构建了C语言的临时运行环境，然后运行了board_init_f_ C语言函数。</p>
<p>该函数在common/board_r.c文件中，具体内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_r</span><span class="params">(<span class="type">gd_t</span> *new_gd, ulong dest_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Set up the new global data pointer. So far only x86 does this</span></span><br><span class="line"><span class="comment">	 * here.</span></span><br><span class="line"><span class="comment">	 * TODO(sjg@chromium.org): Consider doing this for all archs, or</span></span><br><span class="line"><span class="comment">	 * dropping the new_gd parameter.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(X86_64)</span></span><br><span class="line">	arch_setup_gd(new_gd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_ARM64)</span></span><br><span class="line">	gd = new_gd;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	gd-&gt;flags &amp;= ~GD_FLG_LOG_READY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">		init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (initcall_run_list(init_sequence_r))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* NOTREACHED - run_main_loop() does not return */</span></span><br><span class="line">	hang();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	其中init_sequence_r是一个数组，有各种初始化操作，具体如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042126409.png" alt="image-20240704212609374" /></p>
<p>然后继续根据瑞芯微的来即可：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407042210930.png" alt="image-20240704221021869" /></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-06_工作记录/21_工作记录(七月第三个星期)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/07/03/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/21_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC%E4%B8%89%E4%B8%AA%E6%98%9F%E6%9C%9F)/"
    >工作记录((7月第3个星期)</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/03/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/21_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC%E4%B8%89%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-date">
  <time datetime="2024-07-03T13:26:56.000Z" itemprop="datePublished">2024-07-03</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  Here's something encrypted, password is required to continue reading. 
      <a class="article-more-link" href="/2024/07/03/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/21_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC%E4%B8%89%E4%B8%AA%E6%98%9F%E6%9C%9F)/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> chai
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="热爱学习的未来酱"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%94%9F%E6%B4%BB">生活</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE">瑞芯微</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/Linux%E5%AD%A6%E4%B9%A0">Linux学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E8%AF%BB%E4%B9%A6">读书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0">C语言高级学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95">工作记录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7">小技巧</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/shell%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0">shell编程学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/PCB%E5%AD%A6%E4%B9%A0">PCB学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0">音视频学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=22707008&auto=0&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>