<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="永远年轻，永远热泪盈眶" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>开放麒麟shell脚本解析 |  热爱学习的未来酱</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="热爱学习的未来酱" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-02_瑞芯微/16_野火sdk学习shell脚本解析"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  开放麒麟shell脚本解析
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/08/12/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/16_%E9%87%8E%E7%81%ABsdk%E5%AD%A6%E4%B9%A0shell%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2024-08-12T09:17:03.000Z" itemprop="datePublished">2024-08-12</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE/">瑞芯微</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">9.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">50 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/openkylin/openkylin-embedded-builder">https://gitee.com/openkylin/openkylin-embedded-builder</a></p>
<p>开放麒麟官网：<a target="_blank" rel="noopener" href="https://www.openkylin.top/">https://www.openkylin.top</a></p>
<p>文档目的：强化shell脚本编写阅读能力，提取开放麒麟文件系统构建脚本</p>
<p>代码阅读和编译环境：VS code 和 WSL ubuntu22</p>
</blockquote>
<h1 id="项目仓库的获取"><a class="markdownIt-Anchor" href="#项目仓库的获取"></a> 项目仓库的获取</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYgit clone https://gitee.com/openkylin/openkylin-embedded-builder.git</span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026560.png" alt="image-20240816133742484" />image-20240816133742484</p>
<p>==果然不愧是gitee，果然是比github快的多，就还不错吧==</p>
<h1 id="仓库目录文件的分析"><a class="markdownIt-Anchor" href="#仓库目录文件的分析"></a> 仓库目录文件的分析</h1>
<p>拉取下来之后，仓库的目录和文件内容如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026374.png" alt="image-20240816133930163" />image-20240816133930163</p>
<p>上面的这些文件和文件夹中，只有后四个对我们有用，具体作用如下所示：</p>
<table>
<thead>
<tr>
<th>文件和文件夹名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://check-env.sh/">check-env.sh</a></td>
<td>检查文件系统构建的环境，查看依赖是不是安装完成</td>
</tr>
<tr>
<td>config</td>
<td>存放一系列的配置文件，和后处理脚本</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://functions.sh/">functions.sh</a></td>
<td>文件系统的脚本，系统的构建，主要函数都在该脚本中</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://okbuild.sh/">okbuild.sh</a></td>
<td>逻辑函数，对一些内容进行判断，这是需要执行的脚本</td>
</tr>
</tbody>
</table>
<p>根据我理解的逻辑对，上面提到的这四个文件或文件夹进行分析</p>
<h1 id="check-envsh脚本分析"><a class="markdownIt-Anchor" href="#check-envsh脚本分析"></a> check-env.sh脚本分析</h1>
<p>脚本执行过程如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026523.png" alt="image-20240816135726813" />image-20240816135726813</p>
<p>首先是将当前用户设置为无密码使用sudo，然后检查了几个工具是否安装，如果没安装就安装上，最后，将okbuild.sh链接到usr/bin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash  </span><br><span class="line">  </span><br><span class="line">set -e  # 如果任何语句的执行结果为非真，则立即退出脚本  </span><br><span class="line">  </span><br><span class="line"># 获取当前脚本的绝对路径所在的目录  </span><br><span class="line">CURRENT_DIR=$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)  </span><br><span class="line"># 导入当前目录下的functions.sh脚本  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/functions.sh  </span><br><span class="line">  </span><br><span class="line"># 配置sudo权限  </span><br><span class="line">config_sudo  </span><br><span class="line">  </span><br><span class="line"># 检查并安装制作镜像所需的包  </span><br><span class="line">check_package debootstrap  # 检查并安装debootstrap包，用于创建根文件系统  </span><br><span class="line">check_package gdisk        # 检查并安装gdisk包，用于操作GPT分区表  </span><br><span class="line">check_package mtools       # 检查并安装mtools包，用于操作MS-DOS文件系统  </span><br><span class="line">check_package dosfstools   # 检查并安装dosfstools包，用于创建和管理FAT文件系统  </span><br><span class="line">check_package genisoimage  # 检查并安装genisoimage包，用于创建ISO映像文件  </span><br><span class="line">check_package squashfs-tools  # 检查并安装squashfs-tools包，用于创建和管理squashfs文件系统  </span><br><span class="line">check_package xz-utils     # 检查并安装xz-utils包，用于处理XZ格式的压缩文件  </span><br><span class="line">  </span><br><span class="line"># 检查并安装设备树编译器  </span><br><span class="line">check_package device-tree-compiler  </span><br><span class="line">  </span><br><span class="line"># 创建软链接，将okbuild.sh脚本链接到/usr/bin/目录下，使其可以在任何地方被调用  </span><br><span class="line">sudo ln -v -sf &quot;$&#123;CURRENT_DIR&#125;&quot;/okbuild.sh /usr/bin/</span><br></pre></td></tr></table></figure>
<p>上面用了两个函数，从他们的名字上就可以分析出他们的作用，config_sudo是配置当前用户的sudo免密码权限，而check_package用来检测工具是否安装，这两个函数都定义在functions.sh脚本当中，等等再对这个脚本里的函数进行分析。</p>
<h1 id="config文件内容分析"><a class="markdownIt-Anchor" href="#config文件内容分析"></a> config文件内容分析</h1>
<p>config是这里唯一的一个文件夹，这个文件夹里有一些细分的脚本</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026400.png" alt="image-20240816141742796" />image-20240816141742796</p>
<p>可以分成两类，第一类是六个，如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026423.png" alt="image-20240816142830197" />image-20240816142830197</p>
<p>这些脚本里面就是安装一些工具，创建openkylin用户，设置中文环境罢了，其他也没啥，而public.sh里面是四个函数，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 仅打印</span><br><span class="line">function MY_LOG() &#123;</span><br><span class="line">    echo &quot; =&gt; $*&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 打印 并 执行</span><br><span class="line">function MY_LOG_EXEC() &#123;</span><br><span class="line">    echo &quot; =&gt; $*&quot;</span><br><span class="line">    eval &quot;$*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 执行指定目录下的脚本</span><br><span class="line">function run_scripts() &#123;</span><br><span class="line">    SCRIPTS_DIR=&quot;$&#123;1&#125;&quot;</span><br><span class="line">    VK_ORDER=$&#123;VK_ORDER:-default&#125;</span><br><span class="line"></span><br><span class="line">    if [ -d &quot;$&#123;SCRIPTS_DIR&#125;&quot; ]; then</span><br><span class="line">        if [ -f &quot;$&#123;SCRIPTS_DIR&#125;/$&#123;VK_ORDER&#125;&quot; ]; then</span><br><span class="line">            # 按照给定的顺序执行脚本</span><br><span class="line">            for script_name in $(cat $&#123;SCRIPTS_DIR&#125;/$&#123;VK_ORDER&#125; | sed &#x27;/^#/d&#x27;); do</span><br><span class="line">                echo &quot;---&gt; . $&#123;SCRIPTS_DIR&#125;/$&#123;script_name&#125;&quot;</span><br><span class="line">                . $&#123;SCRIPTS_DIR&#125;/$&#123;script_name&#125; 2&gt;&amp;1 | tee /config/&quot;$(basename $&#123;script_name&#125;)&quot;.log</span><br><span class="line">            done</span><br><span class="line">        else</span><br><span class="line">            # 按照sort -n排序，执行全部脚本</span><br><span class="line">            for script_name in $(find $&#123;SCRIPTS_DIR&#125; -name &quot;*.sh&quot; | sort -n); do</span><br><span class="line">                echo &quot;---&gt; . $&#123;script_name&#125;&quot;</span><br><span class="line">                . &quot;$&#123;script_name&#125;&quot; 2&gt;&amp;1 | tee /config/&quot;$(basename $&#123;script_name&#125;)&quot;.log</span><br><span class="line">            done</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建用户</span><br><span class="line">function create_user() &#123;</span><br><span class="line">    USERNAME=&quot;$1&quot;</span><br><span class="line">    PASSWORD=&quot;$2&quot;</span><br><span class="line">    USERID=&quot;$&#123;3:-1000&#125;&quot;</span><br><span class="line">    if ! awk -F: &#x27;&#123;print $1&#125;&#x27; /etc/passwd | grep -q $&#123;USERNAME&#125;; then</span><br><span class="line">        useradd -m -s /bin/bash -u $&#123;USERID&#125; &quot;$&#123;USERNAME&#125;&quot;</span><br><span class="line">        usermod -c &quot;$&#123;USERNAME&#125;&quot; &quot;$&#123;USERNAME&#125;&quot;</span><br><span class="line">        echo &quot;$&#123;USERNAME&#125;:$&#123;PASSWORD&#125;&quot; | chpasswd</span><br><span class="line">        adduser $&#123;USERNAME&#125; sudo</span><br><span class="line">        adduser $&#123;USERNAME&#125; adm</span><br><span class="line">        adduser $&#123;USERNAME&#125; cdrom &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; dip &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; plugdev &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; lpadmin &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; sambashare &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; libvirtd &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">        adduser $&#123;USERNAME&#125; lxd &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">    else</span><br><span class="line">        echo &quot;user $&#123;USERNAME&#125; already exists&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_hostname() &#123;</span><br><span class="line">    HOSTNAME=&quot;$1&quot;</span><br><span class="line">    echo $&#123;HOSTNAME&#125; &gt;/etc/hostname</span><br><span class="line"></span><br><span class="line">    touch /etc/hosts</span><br><span class="line">    if ! grep -q &quot;127.0.0.1 localhost&quot; /etc/hosts; then</span><br><span class="line">        cat &gt;&gt;/etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 $&#123;HOSTNAME&#125;</span><br><span class="line">EOF</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function install_pkgs() &#123;</span><br><span class="line">    MY_LOG_EXEC apt-get install -y &quot;$*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 循环单个安装</span><br><span class="line">function install_pkgs_each() &#123;</span><br><span class="line">    for pkg in &quot;$@&quot;; do</span><br><span class="line">        MY_LOG_EXEC apt-get install -y -q &quot;$&#123;pkg&#125;&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 结束，收尾</span><br><span class="line">function finish() &#123;</span><br><span class="line">    # 禁止 kylin-virtual-keyboard, ukui-tablet-desktop.desktop 开机不启动</span><br><span class="line">    [ -f &quot;/etc/xdg/autostart/kylin-virtual-keyboard.desktop&quot; ] &amp;&amp; mv -v /etc/xdg/autostart/kylin-virtual-keyboard.desktop&#123;,.bak&#125;</span><br><span class="line">    [ -f &quot;/etc/xdg/autostart/ukui-tablet-desktop.desktop&quot; ] &amp;&amp; mv -v /etc/xdg/autostart/ukui-tablet-desktop.desktop&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line">    # 删除开始菜单图标</span><br><span class="line">    rm -rf /usr/share/applications/vim.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.systemmonitor.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.plasma-systemmonitor.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.khelpcenter.desktop</span><br><span class="line">    rm -rf /usr/share/applications/mate-user-guide.desktop</span><br><span class="line">    rm -rf /usr/share/applications/yelp.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.telhandler.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.sms.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.kcm.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.app.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.smshandler.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.nonplasma.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect.daemon.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kdeconnect_open.desktop</span><br><span class="line">    rm -rf /usr/share/applications/org.kde.kinfocenter.desktop</span><br><span class="line"></span><br><span class="line">    set_hostname openkylin</span><br><span class="line"></span><br><span class="line">    if [ -f /lib/systemd/system/dnsmasq.service ]; then</span><br><span class="line">        systemctl disable dnsmasq.service</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 设置时区</span><br><span class="line">    echo &quot;Asia/Shanghai&quot; &gt;/etc/timezone</span><br><span class="line">    rm -rf /etc/localtime</span><br><span class="line">    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; file system make finish&quot;</span><br><span class="line"></span><br><span class="line">    export HISTSIZE=0</span><br><span class="line">    rm -rf /var/cache/apt/archives/*.deb</span><br><span class="line">    if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">        rm -rf /var/cache/apt/*.bin</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_Packages</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_InRelease</span><br><span class="line">        rm -rf /var/lib/apt/lists/*_Translation*</span><br><span class="line">        rm -rf /root/.bash_history</span><br><span class="line">        rm -rf /tmp/*</span><br><span class="line">        rm -rf ~/.bash_history</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置默认语言为中文</span><br><span class="line">function config_zh_cn() &#123;</span><br><span class="line">    cat &gt;/etc/locale.gen &lt;&lt;EOF</span><br><span class="line">zh_CN.UTF-8 UTF-8</span><br><span class="line">en_US.UTF-8 UTF-8</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cat &gt;/etc/default/locale &lt;&lt;EOF</span><br><span class="line">LANG=zh_CN.UTF-8</span><br><span class="line">LANGUAGE=&quot;zh_CN:zh&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    locale-gen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置默认语言为英文</span><br><span class="line">function config_en_utf8() &#123;</span><br><span class="line">    cat &gt;/etc/locale.gen &lt;&lt;EOF</span><br><span class="line">en_US ISO-8859-1</span><br><span class="line">en_US.UTF-8 UTF-8</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    cat &gt;/etc/default/locale &lt;&lt;EOF</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">LANGUAGE=&quot;en_US:en&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    locale-gen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三个函数run_scripts和第四个函数create_user需要注意一下，第四个函数可以学习一下，用在我们的构建上，而第三个是重点，根据他的内容可以推测出正是调用了这个函数才真正的调用了下面的这些shell函数：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026426.png" alt="image-20240816143742187" />image-20240816143742187</p>
<p>这些shell等等再讲解，先来看openkylin目录下的文件，可以将这些文件分为三部分，具体如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026090.png" alt="image-20240816144035365" />image-20240816144035365</p>
<p>main.sh可以从名字看出他是最主要的文件，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash  </span><br><span class="line">set -e  </span><br><span class="line">  </span><br><span class="line"># 解析宿主环境传递参数  </span><br><span class="line">for item in $*; do  </span><br><span class="line">    if grep -q &quot;^VK.*=&quot; &lt;&lt;&lt;&quot;$&#123;item&#125;&quot;; then  </span><br><span class="line">        KEY=$&#123;item%%=*&#125;  # 提取键名  </span><br><span class="line">        VALUE=&quot;$&#123;item##*=&#125;&quot;  # 提取键值  </span><br><span class="line">        eval &quot;export $&#123;KEY&#125;=&#x27;$&#123;VALUE&#125;&#x27;&quot;  # 导出键值对为环境变量  </span><br><span class="line">    fi  </span><br><span class="line">done  </span><br><span class="line">  </span><br><span class="line"># 系统版本信息  </span><br><span class="line">[ -f /etc/os-release ] &amp;&amp; source /etc/os-release  # 如果存在系统版本信息文件，则导入  </span><br><span class="line">  </span><br><span class="line">CURRENT_DIR=$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)  # 获取当前脚本的绝对路径  </span><br><span class="line">[ -f &quot;$&#123;CURRENT_DIR&#125;&quot;/public.sh ] &amp;&amp; . &quot;$&#123;CURRENT_DIR&#125;&quot;/public.sh  # 如果存在公共脚本，则导入  </span><br><span class="line">[ -f &quot;$&#123;CURRENT_DIR&#125;&quot;/private.sh ] &amp;&amp; . &quot;$&#123;CURRENT_DIR&#125;&quot;/private.sh  # 如果存在私有脚本，则导入  </span><br><span class="line">  </span><br><span class="line">CURRENT_ARCH=$(dpkg --print-architecture)  # 获取当前系统架构  </span><br><span class="line">  </span><br><span class="line"># 设置内网源  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/apt_source-$&#123;CURRENT_ARCH&#125;.sh  # 导入对应架构的内网源设置脚本  </span><br><span class="line">  </span><br><span class="line"># 制作系统  </span><br><span class="line">if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ]; then  # 如果当前任务为配置  </span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ]; then  # 如果设置了更新标志，并且值为y  </span><br><span class="line">        if [ -f /rootfs.deblist ] &amp;&amp; [ ! -f /rootfs-update.deblist ]; then  # 如果存在基础包列表文件，且不存在更新后的列表文件  </span><br><span class="line">            # 升级基础包  </span><br><span class="line">            for pkg in $(awk &#x27;&#123;print $1&#125;&#x27; /rootfs.deblist); do  # 遍历基础包列表  </span><br><span class="line">                MY_LOG_EXEC apt-get install -y -q --allow-downgrades $&#123;pkg&#125;  # 安装或降级包  </span><br><span class="line">            done  </span><br><span class="line">            # 升级后的列表  </span><br><span class="line">            dpkg-query -W --showformat=&#x27;$&#123;Package&#125; $&#123;Version&#125;\n&#x27; &gt;/rootfs-update.deblist  # 生成更新后的列表文件  </span><br><span class="line">            rm -rf /var/cache/apt/archives/*.deb  # 清理下载的包文件  </span><br><span class="line">        fi  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    run_scripts &quot;$&#123;CURRENT_DIR&#125;&quot;/shells  # 执行shell脚本目录下的所有脚本  </span><br><span class="line">else  </span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;&quot;/$&#123;VK_CURRENT_TASK&#125;.sh  # 导入并执行当前任务对应的脚本  </span><br><span class="line">fi  </span><br><span class="line">  </span><br><span class="line"># 设置公网源  </span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/apt_public-$&#123;CURRENT_ARCH&#125;.sh  # 导入对应架构的公网源设置脚本  </span><br><span class="line">  </span><br><span class="line">finish  # 执行结束操作</span><br></pre></td></tr></table></figure>
<p>然后是内网源和公网源的，这里我还没看懂到底是啥意思，为社么要设置两次呢，这里不是很理解，等等再说吧，而第39行终于是调用了前面提到的run_scripts，调用shell下的一系列内容。</p>
<p>最后是以prop开头的一系列文件，根据内容开看这是一系列的配置文件，以树莓派4b的配置文件为例，可以看到有以下内容：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026104.png" alt="image-20240816145605421" />image-20240816145605421</p>
<p>分别记录了版本状态、主板标识、架构、执行顺序、执行任务等等，现在还不知道是哪里用到了这个配置文件，但肯定是用到了，后面对于编译流程的分析过程中再来讲解，最后来看shells文件夹里的脚本，如下所示：<br />
<img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026080.png" alt="image-20240816145829922" />image-20240816145829922</p>
<p>同样是根据名字进行推理，前面六个脚本可以分成一类，是文件系统设置的脚本，而后面六个可以分成一类，根据不同的开发板来决定都调用前面哪几个脚本，然后来对前面这几个脚本进行分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    # base tools</span><br><span class="line">    apt-utils</span><br><span class="line">    kmod</span><br><span class="line">    kbd</span><br><span class="line">    whiptail</span><br><span class="line">    locales</span><br><span class="line"></span><br><span class="line">    systemd-resolved</span><br><span class="line"></span><br><span class="line">    # extra tools</span><br><span class="line">    vim</span><br><span class="line">    lsof</span><br><span class="line">    cpio</span><br><span class="line">    file</span><br><span class="line">    sudo</span><br><span class="line">    tree</span><br><span class="line">    wget</span><br><span class="line">    rsync</span><br><span class="line">    fdisk</span><br><span class="line">    gdisk</span><br><span class="line">    parted</span><br><span class="line">    psmisc</span><br><span class="line">    rsyslog</span><br><span class="line">    dosfstools</span><br><span class="line">    lsb-release</span><br><span class="line">    archdetect-deb</span><br><span class="line">    bash-completion</span><br><span class="line">    zstd</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>1-tools.sh就是安装一点软件而已，<a target="_blank" rel="noopener" href="http://xn--2-net-408hr55ok0j.sh/">然后看2-net.sh</a>，其实也就是安装了一点网络相关的软件，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    iputils-ping iproute2 net-tools</span><br><span class="line">    network-manager</span><br><span class="line">    wpasupplicant</span><br><span class="line"></span><br><span class="line">    # ssh</span><br><span class="line">    openssh-server</span><br><span class="line">    openssh-client</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--3-ukui-9h6jv19jfqswkn.sh/">然后来看3-ukui.sh</a>，也是装一些工具，他这里的工具主要是关于桌面配置相关的东西，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">PKGS=(</span><br><span class="line">    xinit lightdm xdg-user-dirs ukui-control-center ukui-desktop-environment ukui-desktop-environment-core ukui-greeter openkylin-wallpapers</span><br><span class="line">    ukui-globaltheme-heyin</span><br><span class="line">    libukuiinputgatherclient1 xserver-xorg-video-fbdev</span><br><span class="line">    xserver-xorg-input-all</span><br><span class="line"></span><br><span class="line">    # 网络设置</span><br><span class="line">    network-manager-gnome</span><br><span class="line"></span><br><span class="line">    # 便签</span><br><span class="line">    ukui-notebook libqt5sql5-sqlite</span><br><span class="line">    # 屏幕键盘</span><br><span class="line">    onboard python3-xdg</span><br><span class="line">    # VNC工具</span><br><span class="line">    remmina remmina-plugin-vnc</span><br><span class="line"></span><br><span class="line">    kylin-daq</span><br><span class="line">    kylin-app-manager</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br><span class="line"></span><br><span class="line"># lite-ukui-config</span><br><span class="line">if apt-cache policy lite-ukui-config | grep -q lite-ukui-config; then</span><br><span class="line">    apt-get install -y lite-ukui-config</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--4-grub-9h6jv11j4zu.sh/">然后是4-grub.sh</a>，我到现在也不知道grub是做什么的，但是看内容是只有amd64的才需要，就不管了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line">CURRENT_ARCH=$(dpkg --print-architecture)</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;CURRENT_ARCH&#125;&quot; == &quot;amd64&quot; ]; then</span><br><span class="line">    PKGS=(</span><br><span class="line">        grub-efi</span><br><span class="line">        grub-common</span><br><span class="line">        grub2-common</span><br><span class="line">        # label.so</span><br><span class="line">        plymouth-label</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    install_pkgs &quot;$&#123;PKGS[@]&#125;&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://xn--5-kernel-kf1np64ujon.sh/">然后看5-kernel.sh</a>，根据内容就知道这是内核的构建，忽略即可，无需理会。<a target="_blank" rel="noopener" href="http://xn--9-lash-9h6js56j9zau85i.sh/">最后来看9-lash.sh</a>，这里就是设置了一下允许root登录，以及设置网络配置文件，其他就没啥了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># NetworkManager</span><br><span class="line">if [ -d /etc/NetworkManager/conf.d ]; then</span><br><span class="line">    touch /etc/NetworkManager/conf.d/10-globally-managed-devices.conf</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># ssh allow root login</span><br><span class="line">&#123;</span><br><span class="line">    if [ -f /etc/ssh/sshd_config ]; then</span><br><span class="line">        if ! grep -q &quot;^PermitRootLogin yes$&quot; /etc/ssh/sshd_config; then</span><br><span class="line">            sed -i.bak &#x27;/PermitRootLogin/d&#x27; /etc/ssh/sshd_config</span><br><span class="line">            echo &#x27;PermitRootLogin yes&#x27; &gt;&gt;/etc/ssh/sshd_config</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里关于config文件就分析的差不多了。</p>
<h1 id="okbuildsh脚本分析"><a class="markdownIt-Anchor" href="#okbuildsh脚本分析"></a> okbuild.sh脚本分析</h1>
<p>这个脚本就是最开始运行的构建脚本，一切以这个为开始，但是呢，这个脚本实际上并没有什么用，因为我只需要文件系统构建的地方即可，这里的内容有些空虚了，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">CURRENT_FILE=$(readlink -f &quot;$0&quot;)</span><br><span class="line">CURRENT_DIR=$(dirname &quot;$&#123;CURRENT_FILE&#125;&quot;)</span><br><span class="line"># 函数库 优先级 1</span><br><span class="line">. &quot;$&#123;CURRENT_DIR&#125;&quot;/functions.sh</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">    echo -en &quot;USAGE:</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_chilliepi  # 双椒派</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_lotus2     # lotus2开发板</span><br><span class="line"></span><br><span class="line">$(basename &quot;$0&quot;) -p prop_rpi4b      # 树莓派4B</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_vf2        # VisionFive2</span><br><span class="line"></span><br><span class="line">$(basename &quot;$0&quot;) -p prop_phytiumpi_2G  # 飞腾派 2GB 版本</span><br><span class="line">$(basename &quot;$0&quot;) -p prop_phytiumpi_4G  # 飞腾派 4GB 版本</span><br><span class="line">&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 判断参数个数</span><br><span class="line">if [ $# -eq 0 ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 配置sudo免密</span><br><span class="line">if [ &quot;$(id -nu)&quot; != &quot;root&quot; ]; then</span><br><span class="line">    sudo tee &quot;/etc/sudoers.d/$&#123;USER&#125;&quot; &lt;&lt;EOF</span><br><span class="line">$USER ALL=(ALL:ALL) NOPASSWD: ALL</span><br><span class="line">EOF</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">ARGS=$(getopt -a -o h,p: -l help,conf:,prop:,mirror:,suite:,name:,arch:,debdir:,tasks:,version: -- &quot;$@&quot;)</span><br><span class="line">eval set -- &quot;$&#123;ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 参数 优先级 1</span><br><span class="line">while true; do</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">    -h | --help)</span><br><span class="line">        usage</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    -p | --prop)</span><br><span class="line">        PROP=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --arch)</span><br><span class="line">        VK_ARCH=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --tasks)</span><br><span class="line">        VK_TASKS=$2</span><br><span class="line">        shift</span><br><span class="line">        ;;</span><br><span class="line">    --)</span><br><span class="line">        break</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">    shift</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 默认选用base目录</span><br><span class="line">CONF=$&#123;CONF:-openkylin&#125;</span><br><span class="line"></span><br><span class="line">if [ ! -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">    color_error &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125; not exist!!&quot;</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 参数 优先级 2</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;PROP:-default.prop&#125;&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;PROP:-default.prop&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 参数 优先级 3</span><br><span class="line">for item in &quot;$@&quot;; do</span><br><span class="line">    if grep -q &quot;^VK.*=&quot; &lt;&lt;&lt;&quot;$&#123;item&#125;&quot;; then</span><br><span class="line">        KEY=$&#123;item%%=*&#125;</span><br><span class="line">        VALUE=&quot;$&#123;item##*=&#125;&quot;</span><br><span class="line">        eval &quot;export $&#123;KEY&#125;=&#x27;$&#123;VALUE&#125;&#x27;&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 参数 优先级 4</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;VK_ENV&#125;&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/$&#123;VK_ENV&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 是否保留镜像制作目录</span><br><span class="line">VK_KEEP_IMAGE_DIR=$&#123;VK_KEEP_IMAGE_DIR:-y&#125;</span><br><span class="line"></span><br><span class="line">VK_ARCH=$&#123;VK_ARCH:-arm64&#125;</span><br><span class="line">VK_MIRROR=$&#123;VK_MIRROR:-http://archive.build.openkylin.top/openkylin&#125;</span><br><span class="line">VK_SUITE=$&#123;VK_SUITE:-yangtze&#125;</span><br><span class="line">VK_VERSION=$&#123;VK_VERSION:-test&#125;</span><br><span class="line"></span><br><span class="line">ROOTFS_DIR=&quot;openKylin&quot;</span><br><span class="line">if [ -n &quot;$&#123;VK_VERSION&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_VERSION&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_TERMINAL&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_TERMINAL&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_BOARD&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_BOARD&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ -n &quot;$&#123;VK_ARCH&#125;&quot; ]; then</span><br><span class="line">    ROOTFS_DIR=&quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_ARCH&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 函数库 优先级 2</span><br><span class="line">if [ -f &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/functions.sh&quot; ]; then</span><br><span class="line">    . &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/functions.sh&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">color_info &quot;---&gt; args&quot;</span><br><span class="line">set | grep &quot;^VK_&quot; | tee &quot;$&#123;ROOTFS_DIR&#125;.prop&quot;</span><br><span class="line"></span><br><span class="line">function exit_function() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-iso/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">    umount_target ./p1</span><br><span class="line">    umount_target ./p2</span><br><span class="line">    umount_target ./p3</span><br><span class="line"></span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trap &quot;exit_function&quot; 0</span><br><span class="line"></span><br><span class="line">umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$&#123;VK_TASKS&#125;&quot; ]; then</span><br><span class="line">    color_error &quot;---&gt; no task to do!!&quot;</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 判断是否支持此架构</span><br><span class="line">if ! echo &quot;$&#123;VK_ARCH&#125;&quot; | grep -q -E &quot;amd64|arm64|loongarch64|i386|riscv64&quot;; then</span><br><span class="line">    color_error &quot;not support &#x27;ARCH: $&#123;VK_ARCH&#125;&#x27;&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># x86上制作其他架构, 需安装 binfmt-support,qemu-user-static</span><br><span class="line">if [ &quot;$(dpkg --print-architecture)&quot; == &quot;amd64&quot; ] &amp;&amp; [ &quot;$&#123;VK_ARCH&#125;&quot; != &quot;amd64&quot; ]; then</span><br><span class="line">    check_package binfmt-support</span><br><span class="line">    check_package qemu-user-static</span><br><span class="line">elif [ &quot;$(dpkg --print-architecture)&quot; != &quot;$&#123;VK_ARCH&#125;&quot; ]; then</span><br><span class="line">    # 非x86, 提示不能制作其他架构</span><br><span class="line">    color_error &quot;current os is $(dpkg --print-architecture), don&#x27;t support $&#123;VK_ARCH&#125;!!&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 执行任务</span><br><span class="line">##################################################</span><br><span class="line">for task in $&#123;VK_TASKS//,/ &#125;; do</span><br><span class="line">    color_info &quot;---&gt; do_$&#123;task&#125;&quot;</span><br><span class="line">    export VK_CURRENT_TASK=&quot;$&#123;task&#125;&quot;</span><br><span class="line">    do_&quot;$&#123;task&#125;&quot;</span><br><span class="line">done | tee &quot;$&#123;ROOTFS_DIR&#125;.log&quot;</span><br><span class="line">##################################################</span><br></pre></td></tr></table></figure>
<p>判断了，确实没有什么需要学习的地方</p>
<h1 id="functionssh脚本分析"><a class="markdownIt-Anchor" href="#functionssh脚本分析"></a> functions.sh脚本分析</h1>
<p>这里面的内容有点多，我先将每个函数隔离出来</p>
<h2 id="函数-config_sudo"><a class="markdownIt-Anchor" href="#函数-config_sudo"></a> 函数 config_sudo</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY# 配置sudo免密</span><br><span class="line">function config_sudo() &#123;</span><br><span class="line">    if [ $(id -u) != 0 ]; then</span><br><span class="line">        sudo tee /etc/sudoers.d/$USER &lt;&lt;EOF</span><br><span class="line">$USER ALL=(ALL:ALL) NOPASSWD: ALL</span><br><span class="line">EOF</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-check_package"><a class="markdownIt-Anchor" href="#函数-check_package"></a> 函数 check_package</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">COPY# 检查是否安装指定包</span><br><span class="line">function check_package() &#123;</span><br><span class="line">    pkg_name=&quot;$1&quot;</span><br><span class="line">    if [ -n &quot;$&#123;pkg_name&#125;&quot; ]; then</span><br><span class="line">        if ! dpkg -l | grep &quot;^ii  $&#123;pkg_name&#125;&quot;; then</span><br><span class="line">            sudo apt-get install -y -qq &quot;$&#123;pkg_name&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-mount_host_to_target"><a class="markdownIt-Anchor" href="#函数-mount_host_to_target"></a> 函数 mount_host_to_target</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COPY# 宿主机挂载 设备节点 到 rootfs</span><br><span class="line">function mount_host_to_target() &#123;</span><br><span class="line">    sudo mount --bind /dev $&#123;1&#125;/dev</span><br><span class="line">    sudo mount --bind /run $&#123;1&#125;/run</span><br><span class="line">    sudo mount -t devpts devpts $&#123;1&#125;/dev/pts</span><br><span class="line">    sudo mount -t proc proc $&#123;1&#125;/proc</span><br><span class="line">    sudo mount -t sysfs sysfs $&#123;1&#125;/sys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-umount_target"><a class="markdownIt-Anchor" href="#函数-umount_target"></a> 函数 umount_target</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COPY# 卸载宿主设备节点</span><br><span class="line">function umount_target() &#123;</span><br><span class="line">    sudo umount -l $&#123;1&#125;/* &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">    sudo umount $&#123;1&#125; &gt;/dev/null 2&gt;&amp;1 || true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_rootfs"><a class="markdownIt-Anchor" href="#函数-do_rootfs"></a> 函数 do_rootfs</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">COPY# 制作基础根文件系统</span><br><span class="line">function do_rootfs() &#123;</span><br><span class="line">    # 先删除 原有 rootfs 目录</span><br><span class="line">    if [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.done&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        MY_LOG_EXEC &quot;sudo rm -rf $&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # debootstrap 参数</span><br><span class="line">        DEBOOTSTRAP_ARGS=&quot;--no-check-gpg --variant=minbase --arch=$&#123;VK_ARCH&#125; --components=main --include=openkylin-keyring,systemd-sysv $&#123;VK_SUITE&#125; $&#123;ROOTFS_DIR&#125; $&#123;VK_MIRROR&#125; gutsy&quot;</span><br><span class="line"></span><br><span class="line">        # 制作 rootfs</span><br><span class="line">        MY_LOG_EXEC &quot;sudo debootstrap $&#123;DEBOOTSTRAP_ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 记录基础rootfs的包列表，给第2步升级包版本用</span><br><span class="line">        # sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27; &gt; /rootfs.deblist&quot;</span><br><span class="line">        # cp &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line">        sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27;&quot; &gt;&quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line"></span><br><span class="line">        sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/archives/*.deb</span><br><span class="line">        if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/*.bin</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Packages</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_InRelease</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Translation*</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/root/.bash_history</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/tmp/*</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # rootfs制作完成</span><br><span class="line">        MY_LOG_EXEC &quot;touch $&#123;ROOTFS_DIR&#125;.done&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_config"><a class="markdownIt-Anchor" href="#函数-do_config"></a> 函数 do_config</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">COPY# 进入根文件系统进行安装、配置</span><br><span class="line">function do_config() &#123;</span><br><span class="line">    # 需要升级基础rootfs</span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ] &amp;&amp; [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.rootfs-update.deblist&quot; ]; then</span><br><span class="line">        MY_LOG_EXEC &quot;sudo cp -v $&#123;ROOTFS_DIR&#125;.rootfs.deblist $&#123;ROOTFS_DIR&#125;/rootfs.deblist&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 挂载</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    mount_host_to_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝配置到 $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo mkdir -p $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo cp -v $&#123;CURRENT_DIR&#125;/config/*.sh $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">    if [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        sudo cp -r $&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/. $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">        # 制作</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; /usr/bin/env -i \</span><br><span class="line">            PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \</span><br><span class="line">            HOME=/root \</span><br><span class="line">            LC_ALL=C \</span><br><span class="line">            DEBIAN_FRONTEND=noninteractive \</span><br><span class="line">            APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=DontWarn \</span><br><span class="line">            bash -euo pipefail /config/main.sh &quot;$(set | grep &quot;^VK_&quot; | xargs)&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#x27;config/$&#123;CONF&#125;&#x27; not exits!&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 卸载</span><br><span class="line">    umount_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 参考分析用</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    # sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/config $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; == &quot;config&quot; ]; then</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.deblist</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 删除 update 包列表</span><br><span class="line">    if [ -f &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist ]; then</span><br><span class="line">        cp -v &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist</span><br><span class="line">    fi</span><br><span class="line">    sudo rm -v -rf &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs*.deblist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_tar"><a class="markdownIt-Anchor" href="#函数-do_tar"></a> 函数 do_tar</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COPY# 将 rootfs 打为 tar 包</span><br><span class="line">function do_tar() &#123;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo tar zcf $&#123;ROOTFS_DIR&#125;.tar.gz --numeric-owner -C $&#123;ROOTFS_DIR&#125; .&quot;</span><br><span class="line">    md5sum $&#123;ROOTFS_DIR&#125;.tar.gz &gt;$&#123;ROOTFS_DIR&#125;.tar.gz.md5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数-do_iso"><a class="markdownIt-Anchor" href="#函数-do_iso"></a> 函数 do_iso</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">COPY# 制作iso文件</span><br><span class="line">function do_iso() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    pushd &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line"></span><br><span class="line">    do_config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.$&#123;VK_CURRENT_TASK&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 镜像名称</span><br><span class="line">    ISO_FILENAME=&quot;$&#123;ROOTFS_DIR&#125;.iso&quot;</span><br><span class="line">    CDROM_DIR=&quot;$&#123;ROOTFS_DIR&#125;-cdrom&quot;</span><br><span class="line"></span><br><span class="line">    sudo rm -rf $&#123;CDROM_DIR&#125;</span><br><span class="line">    mkdir -pv $&#123;CDROM_DIR&#125;/&#123;casper,boot/grub,EFI/BOOT&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝 内核 和 initrd</span><br><span class="line">    if [ -f $&#123;ROOTFS_DIR&#125;/boot/vmlinuz ] &amp;&amp; [ -f $&#123;ROOTFS_DIR&#125;/boot/initrd.img ]; then</span><br><span class="line">        # 标准内核情况</span><br><span class="line">        sudo cp -v $&#123;ROOTFS_DIR&#125;/boot/vmlinuz $&#123;CDROM_DIR&#125;/casper/vmlinuz</span><br><span class="line">        sudo cp -v $&#123;ROOTFS_DIR&#125;/boot/initrd.img $&#123;CDROM_DIR&#125;/casper/initrd.lz</span><br><span class="line">    else</span><br><span class="line">        # 没有内核软链接文件的情况</span><br><span class="line">        VMLINUXZ=$(sudo find $&#123;ROOTFS_DIR&#125;/boot -name &quot;vmlinuz*&quot; | head -n1)</span><br><span class="line">        INITRD_IMG=$(sudo find $&#123;ROOTFS_DIR&#125;/boot -name &quot;initrd*&quot; | head -n1)</span><br><span class="line">        sudo cp -v $&#123;VMLINUXZ&#125; $&#123;CDROM_DIR&#125;/casper/vmlinuz</span><br><span class="line">        sudo cp -v $&#123;INITRD_IMG&#125; $&#123;CDROM_DIR&#125;/casper/initrd.lz</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; mksquash&quot;</span><br><span class="line">    [ -f $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs ] &amp;&amp; sudo rm -rf $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs</span><br><span class="line">    [ -f $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs ] || sudo mksquashfs $&#123;ROOTFS_DIR&#125; $&#123;CDROM_DIR&#125;/casper/filesystem.squashfs -quiet # -comp xz -no-progress</span><br><span class="line">    printf $(sudo du -sx --block-size=1 $&#123;ROOTFS_DIR&#125; | cut -f1) &gt;$&#123;CDROM_DIR&#125;/casper/filesystem.size</span><br><span class="line"></span><br><span class="line">    # iso grub菜单项</span><br><span class="line">    cat &gt;$&#123;CDROM_DIR&#125;/boot/grub/grub.cfg &lt;&lt;EOF</span><br><span class="line">set default=0</span><br><span class="line">set timeout=3</span><br><span class="line"></span><br><span class="line">set color_normal=white/black</span><br><span class="line">set color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">menuentry &quot;install openkylin&quot; &#123;</span><br><span class="line">    linux   /casper/vmlinuz boot=casper only-ubiquity locale=zh_CN quiet splash</span><br><span class="line">    initrd  /casper/initrd.lz</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    if [ &quot;$&#123;VK_ARCH&#125;&quot; = &quot;arm64&quot; ]; then</span><br><span class="line">        EFINAME=&quot;bootaa64.efi&quot;</span><br><span class="line">    elif [ &quot;$&#123;VK_ARCH&#125;&quot; = &quot;amd64&quot; ]; then</span><br><span class="line">        EFINAME=&quot;bootx64.efi&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # efi</span><br><span class="line">    if [ -f &quot;$&#123;CURRENT_DIR&#125;/$&#123;EFINAME&#125;&quot; ]; then</span><br><span class="line">        cp -v $&#123;CURRENT_DIR&#125;/$&#123;EFINAME&#125; $&#123;CDROM_DIR&#125;/EFI/BOOT/$&#123;EFINAME&#125;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=$&#123;CDROM_DIR&#125;/boot/grub/efi.img bs=1M count=10</span><br><span class="line">    mkfs.vfat $&#123;CDROM_DIR&#125;/boot/grub/efi.img</span><br><span class="line">    mmd -i $&#123;CDROM_DIR&#125;/boot/grub/efi.img efi efi/boot</span><br><span class="line">    mcopy -i $&#123;CDROM_DIR&#125;/boot/grub/efi.img $&#123;CDROM_DIR&#125;/EFI/BOOT/$&#123;EFINAME&#125; ::efi/boot/</span><br><span class="line"></span><br><span class="line">    [ -d $&#123;CURRENT_DIR&#125;/config/cdrom ] &amp;&amp; cp -r $&#123;CURRENT_DIR&#125;/config/cdrom/. $&#123;CDROM_DIR&#125;</span><br><span class="line"></span><br><span class="line">    sudo mkisofs -input-charset utf-8 -J -r -V openKylin -eltorito-alt-boot -e boot/grub/efi.img -no-emul-boot -o $&#123;ISO_FILENAME&#125; $&#123;CDROM_DIR&#125;</span><br><span class="line">    md5sum &quot;$&#123;ISO_FILENAME&#125;&quot; &gt;&quot;$&#123;ISO_FILENAME&#125;&quot;.md5</span><br><span class="line">    cp -rf &quot;$&#123;ISO_FILENAME&#125;&quot;* ..</span><br><span class="line">    cp -rf ./*.deblist ..</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;ISO_FILENAME&#125;* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 $&#123;VK_CURRENT_TASK&#125; 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-$&#123;VK_CURRENT_TASK&#125; 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体硬件构建"><a class="markdownIt-Anchor" href="#具体硬件构建"></a> 具体硬件构建</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br></pre></td><td class="code"><pre><span class="line">COPY# 双椒派 镜像</span><br><span class="line">function do_img_chilliepi() &#123;</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">    do_config</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 128 + 2048))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line"></span><br><span class="line">    # boot分区</span><br><span class="line">    sgdisk -n 0:0:+128M -c 0:boot &quot;$&#123;IMAGE_FILE&#125;&quot; &gt;/dev/null</span><br><span class="line">    # 根分区</span><br><span class="line">    sgdisk -n 0:0:0 -c 0:root &quot;$&#123;IMAGE_FILE&#125;&quot; &gt;/dev/null</span><br><span class="line"></span><br><span class="line">    # sgdisk -p &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    yes | sudo mkfs.vfat -n BOOT $&#123;LOOP_DEV&#125;p1</span><br><span class="line">    yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;LOOP_DEV&#125;p2</span><br><span class="line"></span><br><span class="line">    part1_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p1)</span><br><span class="line">    part2_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p2)</span><br><span class="line"></span><br><span class="line">    echo part1_uuid=$&#123;part1_uuid&#125;</span><br><span class="line">    echo part2_uuid=$&#123;part2_uuid&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝文件</span><br><span class="line">    mkdir -p &#123;p1,p2&#125;</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p1 ./p1/</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p2 ./p2/</span><br><span class="line"></span><br><span class="line">    # copy boot</span><br><span class="line">    sudo cp -v -rf -a $&#123;ROOTFS_DIR&#125;/boot/. ./p1/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./p2/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee ./p2/etc/fstab &lt;&lt;EOF</span><br><span class="line">UUID=$&#123;part2_uuid&#125;   /           ext4    rw,relatime 0 1</span><br><span class="line">UUID=$&#123;part1_uuid&#125;   /boot       vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo umount ./p1 ./p2</span><br><span class="line">    rmdir p1 p2</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 树莓派 4B</span><br><span class="line">function do_img_rpi4b() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 128 + 1024))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mktable msdos</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mkpart primary fat32 1MiB 128MiB</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; mkpart primary ext4 128MiB 100%</span><br><span class="line">    parted -s $&#123;IMAGE_FILE&#125; set 1 boot on</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    yes | sudo mkfs.vfat -n BOOT -F 32 $&#123;LOOP_DEV&#125;p1</span><br><span class="line">    yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;LOOP_DEV&#125;p2</span><br><span class="line"></span><br><span class="line">    part1_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p1)</span><br><span class="line">    part2_uuid=$(sudo blkid -s UUID -o value $&#123;LOOP_DEV&#125;p2)</span><br><span class="line"></span><br><span class="line">    echo part1_uuid=$&#123;part1_uuid&#125;</span><br><span class="line">    echo part2_uuid=$&#123;part2_uuid&#125;</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p2 $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p1 $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./$&#123;ROOT_TARGET&#125;/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/etc/fstab &lt;&lt;EOF</span><br><span class="line">UUID=$&#123;part2_uuid&#125;   /           ext4    rw,relatime 0 1</span><br><span class="line">UUID=$&#123;part1_uuid&#125;   /boot       vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # copy boot</span><br><span class="line">    git clone https://gitee.com/openkylin/bootfiles-embedded.git</span><br><span class="line">    sudo cp -v -rf ./bootfiles-embedded/rpi4b/boot/. ./$&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    sudo tee ./$&#123;ROOT_TARGET&#125;/boot/cmdline.txt &lt;&lt;EOF</span><br><span class="line">console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 root=/dev/mmcblk0p2 rootfstype=ext4 rootwait</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo tee ./$&#123;ROOT_TARGET&#125;/boot/config.txt &lt;&lt;EOF</span><br><span class="line">[all]</span><br><span class="line">kernel=vmlinuz-5.15.92-v8+</span><br><span class="line">cmdline=cmdline.txt</span><br><span class="line"></span><br><span class="line">[pi4]</span><br><span class="line">max_framebuffers=2</span><br><span class="line">arm_boost=1</span><br><span class="line">dtoverlay=vc4-fkms-v3d</span><br><span class="line"></span><br><span class="line">[all]</span><br><span class="line">dtparam=audio=on</span><br><span class="line">dtparam=i2c_arm=on</span><br><span class="line">dtparam=spi=on</span><br><span class="line">disable_overscan=1</span><br><span class="line">dtoverlay=vc4-kms-v3d</span><br><span class="line">dtoverlay=dwc2</span><br><span class="line">camera_auto_detect=1</span><br><span class="line">display_auto_detect=1</span><br><span class="line">arm_64bit=1</span><br><span class="line">dtparam=audio=on</span><br><span class="line">enable_uart=1</span><br><span class="line">enable_gic=1</span><br><span class="line">dtoverlay=pi3-miniuart-bt</span><br><span class="line">force_turbo=1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sync</span><br><span class="line"></span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function do_img_vf2() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 64 + 256))</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;IMAGE_FILE&#125;&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line"></span><br><span class="line">    sgdisk --clear --set-alignment=2 \</span><br><span class="line">        --new=1:4096:8191 --change-name=1:spl --typecode=1:2E54B353-1271-4842-806F-E436D6AF6985 \</span><br><span class="line">        --new=2:8192:16383 --change-name=2:uboot --typecode=2:BC13C2FF-59E6-4262-A352-B275FD6F7172 \</span><br><span class="line">        --new=3:16384:+64M --change-name=3:system --typecode=3:EBD0A0A2-B9E5-4433-87C0-68B6B72699C7 \</span><br><span class="line">        --new=4:0:-0 --change-name=4:rootfs --typecode=4:0x8300 \</span><br><span class="line">        &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    DISK_PATH=$(readlink -f &quot;$&#123;IMAGE_FILE&#125;&quot;)</span><br><span class="line">    LOOP_DEV=$(losetup -l -O NAME,BACK-FILE | grep &quot;$&#123;DISK_PATH&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;LOOP_DEV&#125;&quot; ]; then</span><br><span class="line">        LOOP_DEV=$(sudo losetup -f)</span><br><span class="line">        # 将镜像关联到loop设备上</span><br><span class="line">        sudo losetup -P $&#123;LOOP_DEV&#125; &quot;$&#123;IMAGE_FILE&#125;&quot;</span><br><span class="line">        # sudo partprobe $&#123;LOOP_DEV&#125;</span><br><span class="line">    fi</span><br><span class="line">    echo $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    # spl and uboot for vf2</span><br><span class="line">    U_BOOT_SPL=&quot;https://www.openkylin.top/public/software/Embedded/visionfive2/u-boot-spl.bin.normal.out&quot;</span><br><span class="line">    U_BOOT_FILE=&quot;https://www.openkylin.top/public/software/Embedded/visionfive2/visionfive2_fw_payload.img&quot;</span><br><span class="line">    wget -qO- $&#123;U_BOOT_SPL&#125; | sudo dd of=$&#123;LOOP_DEV&#125;p1 status=progress</span><br><span class="line">    wget -qO- $&#123;U_BOOT_FILE&#125; | sudo dd of=$&#123;LOOP_DEV&#125;p2 status=progress</span><br><span class="line"></span><br><span class="line">    # 格式化分区</span><br><span class="line">    sudo mkfs.vfat $&#123;LOOP_DEV&#125;p3</span><br><span class="line">    sudo mkfs.ext4 $&#123;LOOP_DEV&#125;p4</span><br><span class="line">    sudo dosfslabel $&#123;LOOP_DEV&#125;p3 BOOT</span><br><span class="line">    sudo e2label $&#123;LOOP_DEV&#125;p4 ROOT</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    # mount root partition</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p4 $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo mount $&#123;LOOP_DEV&#125;p3 $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. ./$&#123;ROOT_TARGET&#125;/</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; generate fstab&quot;</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/etc/fstab &lt;&lt;EOF</span><br><span class="line"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt; </span><br><span class="line">LABEL=ROOT  /               ext4    errors=remount-ro 0       1</span><br><span class="line">LABEL=BOOT  /boot           vfat    nodev,noexec,rw   0       2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # uEnv.txt</span><br><span class="line">    echo &quot;---&gt; generate uEnv.txt&quot;</span><br><span class="line">    sudo tee &quot;$&#123;ROOT_TARGET&#125;&quot;/boot/uEnv.txt &lt;&lt;EOF</span><br><span class="line">fdt_high=0xffffffffffffffff</span><br><span class="line">initrd_high=0xffffffffffffffff</span><br><span class="line">kernel_addr_r=0x44000000</span><br><span class="line">kernel_comp_addr_r=0x90000000</span><br><span class="line">kernel_comp_size=0x10000000</span><br><span class="line">fdt_addr_r=0x48000000</span><br><span class="line">ramdisk_addr_r=0x48100000</span><br><span class="line"># Move distro to first boot to speed up booting</span><br><span class="line">boot_targets=distro mmc0 dhcp</span><br><span class="line"># Fix wrong fdtfile name</span><br><span class="line">fdtfile=starfive/jh7110-visionfive-v2.dtb</span><br><span class="line"># Fix missing bootcmd</span><br><span class="line">#bootcmd=run load_distro_uenv;run bootcmd_distro</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    sudo touch &quot;$&#123;ROOT_TARGET&#125;&quot;/boot/vf2_uEnv.txt</span><br><span class="line"></span><br><span class="line">    # extlinux.conf</span><br><span class="line">    echo &quot;---&gt; generate extlinux.conf&quot;</span><br><span class="line">    sudo mkdir -p $&#123;ROOT_TARGET&#125;/boot/extlinux</span><br><span class="line">    sudo tee $&#123;ROOT_TARGET&#125;/boot/extlinux/extlinux.conf &lt;&lt;EOF</span><br><span class="line">default openkylin</span><br><span class="line">menu title openkylin</span><br><span class="line">prompt 0</span><br><span class="line">timeout 50</span><br><span class="line"></span><br><span class="line">label openkylin</span><br><span class="line">	menu label openkylin</span><br><span class="line">	linux /vmlinuz-5.10.79+</span><br><span class="line">	initrd /initrd.img-5.10.79+</span><br><span class="line">	</span><br><span class="line">	fdtdir /dtbs</span><br><span class="line">	append  root=/dev/mmcblk1p4 rw rootwait console=ttyS0,115200 earlycon rootwait</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # umount</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;/boot</span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line">    sudo losetup -d $&#123;LOOP_DEV&#125;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function do_img_lotus2() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    MY_LOG_EXEC &quot;sudo tar zcf $&#123;ROOTFS_DIR&#125;.tar.gz -C $&#123;ROOTFS_DIR&#125; .&quot;</span><br><span class="line">    md5sum $&#123;ROOTFS_DIR&#125;.tar.gz &gt;$&#123;ROOTFS_DIR&#125;.tar.gz.md5</span><br><span class="line">    cp -rf $&#123;ROOTFS_DIR&#125;.tar.gz* ..</span><br><span class="line">    popd</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 飞腾派</span><br><span class="line">function do_img_phytiumpi() &#123;</span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;-img/$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        mkdir -pv &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        sudo cp -rf -a &quot;$&#123;ROOTFS_DIR&#125;&quot; &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">        pushd &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line"></span><br><span class="line">        do_config</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 磁盘文件名</span><br><span class="line">    IMAGE_FILE=&quot;$&#123;ROOTFS_DIR&#125;.img&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; use $&#123;VK_UBOOT_FILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;IMAGE_FILE&#125;.deblist</span><br><span class="line"></span><br><span class="line">    # 计算rootfs目录大小</span><br><span class="line">    dusize=$(sudo du -sm $&#123;ROOTFS_DIR&#125; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    size=$(($&#123;dusize&#125; + 1024))</span><br><span class="line"></span><br><span class="line">    # 文件系统放在ext4文件中</span><br><span class="line">    dd if=/dev/zero of=&quot;$&#123;ROOTFS_DIR&#125;.ext4&quot; bs=1M count=$&#123;size&#125; status=progress</span><br><span class="line">    # 格式化ext4</span><br><span class="line">    MY_LOG_EXEC &quot;yes | sudo mkfs.ext4 -Fq -L ROOT $&#123;ROOTFS_DIR&#125;.ext4&quot;</span><br><span class="line"></span><br><span class="line">    ROOT_TARGET=&quot;$&#123;ROOTFS_DIR&#125;-target&quot;</span><br><span class="line">    mkdir -pv $&#123;ROOT_TARGET&#125;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo mount $&#123;ROOTFS_DIR&#125;.ext4 $&#123;ROOT_TARGET&#125;&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; copy rootfs&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/. $&#123;ROOT_TARGET&#125;&quot;</span><br><span class="line"></span><br><span class="line">    sync</span><br><span class="line"></span><br><span class="line">    sudo umount $&#123;ROOT_TARGET&#125;</span><br><span class="line"></span><br><span class="line">    # 安装uboot</span><br><span class="line">    echo &quot;---&gt; install uboot&quot;</span><br><span class="line">    (</span><br><span class="line">        # 先删除旧的</span><br><span class="line">        rm -rf ./phyitum-pi/</span><br><span class="line"></span><br><span class="line">        mkdir -p ./phyitum-pi/resource</span><br><span class="line">        cp -v $&#123;ROOTFS_DIR&#125;/boot/vmlinuz ./phyitum-pi/resource/vmlinuz</span><br><span class="line"></span><br><span class="line">        cd ./phyitum-pi/resource</span><br><span class="line">        wget -R &quot;index.html*,*.deb&quot; -r -np -nd http://factory.openkylin.top/kif/archive/get/repos/phyitumpi/pool/</span><br><span class="line"></span><br><span class="line">        # mkimage 依赖 上面拷贝的vmlinuz文件</span><br><span class="line">        mkimage -f ./edu.its ./uImage.itd</span><br><span class="line"></span><br><span class="line">        # cp -v $&#123;VK_UBOOT_FILE&#125; fip.bin</span><br><span class="line">        # dd if=./uImage.itd of=./fip.bin bs=1M seek=4</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./phyitum-pi/resource/$&#123;VK_UBOOT_FILE&#125; of=$&#123;IMAGE_FILE&#125; conv=notrunc&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./phyitum-pi/resource/uImage.itd of=$&#123;IMAGE_FILE&#125; bs=1M seek=4 conv=notrunc&quot;</span><br><span class="line">    MY_LOG_EXEC &quot;dd if=./$&#123;ROOTFS_DIR&#125;.ext4 of=$&#123;IMAGE_FILE&#125; bs=1M seek=64 conv=notrunc&quot;</span><br><span class="line"></span><br><span class="line">    echo &quot;---&gt; success&quot;</span><br><span class="line"></span><br><span class="line">    xz -zkv --extreme --threads=0 $&#123;IMAGE_FILE&#125;</span><br><span class="line">    md5sum $&#123;IMAGE_FILE&#125;.xz &gt;$&#123;IMAGE_FILE&#125;.xz.md5</span><br><span class="line"></span><br><span class="line">    if [ -n &quot;$&#123;CONF&#125;&quot; ] &amp;&amp; [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        cp -rf $&#123;IMAGE_FILE&#125;.xz* ..</span><br><span class="line">        cp -rf *.deblist ..</span><br><span class="line">        popd</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; ] || [ &quot;$&#123;VK_KEEP_IMAGE_DIR&#125;&quot; != &quot;y&quot; ]; then</span><br><span class="line">        echo &quot;---&gt; 删除 img 制作目录，节省空间&quot;</span><br><span class="line">        sudo rm -rf &quot;$&#123;ROOTFS_DIR&#125;-img&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;---&gt; 保留 $&#123;ROOTFS_DIR&#125;-img 制作目录&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="构建自己的脚本"><a class="markdownIt-Anchor" href="#构建自己的脚本"></a> 构建自己的脚本</h1>
<blockquote>
<p>我的目的也只是想要构建一个文件系统，由于ubuntu24上才能构建成功base，所以我就在一个基础包上构建即可。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">COPYapt install -y apt-utils kmod kbd whiptail locales \</span><br><span class="line">	systemd-resolved vim lsof cpio file sudo tree wget rsync \</span><br><span class="line">	fdisk gdisk parted psmisc rsyslog dosfstools lsb-release archdetect-deb \</span><br><span class="line">	bash-completion zstd iputils-ping iproute2 net-tools network-manager \</span><br><span class="line">	wpasupplicant openssh-server openssh-client xinit lightdm xdg-user-dirs </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apt install ukui-control-center ukui-desktop-environment ukui-desktop-environment-core \</span><br><span class="line">	ukui-greeter openkylin-wallpapers ukui-globaltheme-heyin libukuiinputgatherclient1 \</span><br><span class="line">	 ukui-notebook \</span><br><span class="line"> 	kylin-daq kylin-app-manager</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	apt install xserver-xorg-video-fbdev xserver-xorg-input-all 	libqt5sql5-sqlite onboard python3-xdg remmina remmina-plugin-vnc network-manager-gnome </span><br></pre></td></tr></table></figure>
<p>openkylin-anything.list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYdeb http://ppa.build.openkylin.top/kylinsoft/anything2.0/openkylin/ nile main</span><br></pre></td></tr></table></figure>
<p>openkylin-software.list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYdeb http://software.openkylin.top/openkylin/ nile main all    </span><br></pre></td></tr></table></figure>
<p>问题解决了，使用官方的构建脚本的话会出现几个问题，首先呢源不对，要将源换成2.0的开放麒麟源，再然后呢需要将apt的整个目录换掉，最后有个deb包是装不上的，需要手动装一下，这样才是真的成功，然后呢，我已经构建成功迅为的开放麒麟镜像了，现在开始研究一下官方构建步骤的楼层</p>
<h1 id="构建流程"><a class="markdownIt-Anchor" href="#构建流程"></a> 构建流程</h1>
<p>直接输入./okbuild.sh而不添加任何参数会打印usage，说明该脚本总共支持的平台，以及各个平台的编译步骤，这里使用树莓派的编译命令，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY./okbuild.sh -p prop_rpi4b </span><br></pre></td></tr></table></figure>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026406.png" alt="image-20240817151602795" />image-20240817151602795</p>
<p>这个命令总共有两个参数，分别为-p选项和prop_rpi4b 参数，其实在shell脚本里，这些都属于参数，写下来的内容呢就是对这两个参数进行判断，然后赋值，具体内容会将prop_rpi4b 赋值给PROP，CONF默认值为openkylin，再然后读取了prop配置文件的值，该文件的值接下来会进行逐个判定，先列一下该配置文件的具体内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">COPY#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 版本状态</span><br><span class="line">VK_VERSION=&quot;1.0.2&quot;</span><br><span class="line"># 主板标识</span><br><span class="line">VK_BOARD=&quot;rpi4b&quot;</span><br><span class="line"># 架构</span><br><span class="line">VK_ARCH=&quot;arm64&quot;</span><br><span class="line"># 执行顺序</span><br><span class="line">VK_ORDER=&quot;order_rpi4b&quot;</span><br><span class="line"></span><br><span class="line"># 执行任务</span><br><span class="line">VK_TASKS=&quot;rootfs,config,img_rpi4b&quot;</span><br><span class="line"></span><br><span class="line">VK_UPDATE=&quot;y&quot;</span><br><span class="line">VK_KEEP_IMAGE_DIR=&quot;n&quot;</span><br></pre></td></tr></table></figure>
<p>最后会将这些值导入，这里最重要的是VK_TASKS，在okbuild.sh中，他的最后会依次执行rootfs,config,img_rpi4b，也就是do_rootfs函数、do_config函数，以及do_img_rpi4b函数，do_rootfs函数很简单，就是构建了一个最小文件系统，具体内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">COPYfunction do_rootfs() &#123;</span><br><span class="line">    # 先删除 原有 rootfs 目录</span><br><span class="line">    if [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.done&quot; ]; then</span><br><span class="line">        umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">        MY_LOG_EXEC &quot;sudo rm -rf $&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # debootstrap 参数</span><br><span class="line">        DEBOOTSTRAP_ARGS=&quot;--no-check-gpg --variant=minbase --arch=$&#123;VK_ARCH&#125; --components=main --include=openkylin-keyring,systemd-sysv $&#123;VK_SUITE&#125; $&#123;ROOTFS_DIR&#125; $&#123;VK_MIRROR&#125; gutsy&quot;</span><br><span class="line"></span><br><span class="line">        # 制作 rootfs</span><br><span class="line">        MY_LOG_EXEC &quot;sudo debootstrap $&#123;DEBOOTSTRAP_ARGS&#125;&quot;</span><br><span class="line"></span><br><span class="line">        # 记录基础rootfs的包列表，给第2步升级包版本用</span><br><span class="line">        # sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27; &gt; /rootfs.deblist&quot;</span><br><span class="line">        # cp &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line">        sudo chroot &quot;$&#123;ROOTFS_DIR&#125;&quot; bash -c &quot;dpkg-query -W --showformat=&#x27;\$&#123;Package&#125; \$&#123;Version&#125;\n&#x27;&quot; &gt;&quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs.deblist</span><br><span class="line"></span><br><span class="line">        sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/archives/*.deb</span><br><span class="line">        if (: &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_KEEP_VAR_LIB_APT_LISTS&#125;&quot; = &quot;y&quot; ]; then</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/cache/apt/*.bin</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Packages</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_InRelease</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/var/lib/apt/lists/*_Translation*</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/root/.bash_history</span><br><span class="line">            sudo rm -rf $&#123;ROOTFS_DIR&#125;/tmp/*</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # rootfs制作完成</span><br><span class="line">        MY_LOG_EXEC &quot;touch $&#123;ROOTFS_DIR&#125;.done&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来do_config</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">COPY</span><br><span class="line"># 进入根文件系统进行安装、配置</span><br><span class="line">function do_config() &#123;</span><br><span class="line">    # 需要升级基础rootfs</span><br><span class="line">    if (: &quot;$&#123;VK_UPDATE&#125;&quot;) 2&gt;/dev/null &amp;&amp; [ &quot;$&#123;VK_UPDATE&#125;&quot; = &quot;y&quot; ] &amp;&amp; [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; = &quot;config&quot; ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;.rootfs-update.deblist&quot; ]; then</span><br><span class="line">        MY_LOG_EXEC &quot;sudo cp -v $&#123;ROOTFS_DIR&#125;.rootfs.deblist $&#123;ROOTFS_DIR&#125;/rootfs.deblist&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 挂载</span><br><span class="line">    umount_target &quot;$&#123;ROOTFS_DIR&#125;&quot;</span><br><span class="line">    mount_host_to_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 拷贝配置到 $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo mkdir -p $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line">    sudo cp -v $&#123;CURRENT_DIR&#125;/config/*.sh $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">    if [ -d &quot;$&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;&quot; ]; then</span><br><span class="line">        sudo cp -r $&#123;CURRENT_DIR&#125;/config/$&#123;CONF&#125;/. $&#123;ROOTFS_DIR&#125;/config/</span><br><span class="line">        # 制作</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; /usr/bin/env -i \</span><br><span class="line">            PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \</span><br><span class="line">            HOME=/root \</span><br><span class="line">            LC_ALL=C \</span><br><span class="line">            DEBIAN_FRONTEND=noninteractive \</span><br><span class="line">            APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=DontWarn \</span><br><span class="line">            bash -euo pipefail /config/main.sh &quot;$(set | grep &quot;^VK_&quot; | xargs)&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;&#x27;config/$&#123;CONF&#125;&#x27; not exits!&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 卸载</span><br><span class="line">    umount_target $&#123;ROOTFS_DIR&#125;</span><br><span class="line"></span><br><span class="line">    # 参考分析用</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    # sudo cp -rf -a $&#123;ROOTFS_DIR&#125;/config $&#123;ROOTFS_DIR&#125;-config</span><br><span class="line">    sudo rm -rf $&#123;ROOTFS_DIR&#125;/config</span><br><span class="line"></span><br><span class="line">    # 记录包列表</span><br><span class="line">    if [ &quot;$&#123;VK_CURRENT_TASK&#125;&quot; == &quot;config&quot; ]; then</span><br><span class="line">        sudo chroot $&#123;ROOTFS_DIR&#125; dpkg -l | grep ^i | awk &#x27;&#123;print $2,$3&#125;&#x27; &gt;$&#123;ROOTFS_DIR&#125;.deblist</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 删除 update 包列表</span><br><span class="line">    if [ -f &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist ] &amp;&amp; [ ! -f &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist ]; then</span><br><span class="line">        cp -v &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs-update.deblist &quot;$&#123;ROOTFS_DIR&#125;&quot;.rootfs-update.deblist</span><br><span class="line">    fi</span><br><span class="line">    sudo rm -v -rf &quot;$&#123;ROOTFS_DIR&#125;&quot;/rootfs*.deblist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他这里就很灵性，亦或者很取巧，他把config目录整个搬进去了，这样直接在chroot环境运行，这肯定没啥问题，我就没想到这个地方，虽然这属于一个很简单的地方，果然是不传递的，之前的想发也就不对了，在ubuntu上定义的环境变量，是不会进入到chroot的环境中的，如下所示：</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202409051026448.png" alt="image-20240817154352321" />image-20240817154352321</p>
<table>
<thead>
<tr>
<th>对传入的两个参数进行判断</th>
<th>将prop_rpi4b 赋值给PROP</th>
<th>读取prop配置文件值，并导入进环境变量</th>
<th>根据VK_TASKS值进行任务逐个执行</th>
<th>首先执行do_rootfs</th>
<th>然后执行do_config</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>至此对于流程就大致分析完成了，确实挺简单的，就是一些shell脚本的语法还不是很熟悉，但也就这样了，开放麒麟的构建就这样了，后续也没啥东西了，ok，那就先这样。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/08/12/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/16_%E9%87%8E%E7%81%ABsdk%E5%AD%A6%E4%B9%A0shell%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/08/15/07_%E5%B0%8F%E6%8A%80%E5%B7%A7/9_%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            性能测试
          
        </div>
      </a>
    
    
      <a href="/2024/08/11/02_%E7%91%9E%E8%8A%AF%E5%BE%AE/15_rk%20%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">RK内核镜像构建</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> chai
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="热爱学习的未来酱"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%94%9F%E6%B4%BB">生活</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE">瑞芯微</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/Linux%E5%AD%A6%E4%B9%A0">Linux学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E8%AF%BB%E4%B9%A6">读书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0">C语言高级学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95">工作记录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7">小技巧</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/shell%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0">shell编程学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/PCB%E5%AD%A6%E4%B9%A0">PCB学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0">音视频学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=22707008&auto=0&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>