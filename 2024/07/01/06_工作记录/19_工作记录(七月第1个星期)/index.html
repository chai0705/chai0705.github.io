<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="永远年轻，永远热泪盈眶" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>工作记录((7月第1个星期) |  热爱学习的未来酱</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="热爱学习的未来酱" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-06_工作记录/19_工作记录(七月第1个星期)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  工作记录((7月第1个星期)
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/01/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/19_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC1%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-date">
  <time datetime="2024-07-01T13:26:56.000Z" itemprop="datePublished">2024-07-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">41 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="工作记录星期二"><a class="markdownIt-Anchor" href="#工作记录星期二"></a> 工作记录(星期二)</h1>
<p>==摆脱一份幻觉比发现一个真理更能使人明智==</p>
<p>==当你在凝视深渊的时候，深渊也在凝视你==</p>
<hr />
<p>每天晚上的效率问题就真的挺重要的，昨天晚上的问题出现在哪里呢？出现在手机上，如果晚上的话不接触手机，我认为将会很不错，将手机放到一个封闭起来的容器里，但每次都做不到这一点，之前以为看了一些有文笔的小说，就能解脱出去，后来发现并不是这个样子，该归来的还是要归来，这其实也就可以归结为自控力的不足，我现在更希望达到的一种状态是做一件事情就耗费最高的精力去做，从而让效率达到最高点，满足属于心流的状态，时时刻刻都是满足的，要想做到这种情况，我已经将电脑搬到了卧室里面，以后也就穿着鞋子进卧室了，我发现衣衫整洁是学习的一个很好的前提，花费的这些电量其实并无所谓，现在睡觉的时候感觉做的已经差不多了，有酸枣仁膏，有笔记本电脑就足矣，就还不错吧，然后呢，其他时候就是，之前的转盘很有用，现在就仍旧是使用转盘吧，小说这个东西也并不是不能看，我认为看也要看的有的价值，而不是在番茄上找到一个就一直看，付费跟免费的差距确实是非常大的，不是吗，以后的半小时就是半小时，半小时的规定时间，做应该做的事情，有些事情可以跳过，具体看心情了，懂。</p>
<p>今天只是一个测试，每天的睡眠时间足够是一切的基础，其余都是在这个地基上添砖加瓦，行了，就先总结到这里，还有中午时候的问题，可以在中午的时候做一些有缺的事情呀，也不用一直看，我还是认为心流比较重要，今天中午就看一看心流吧。</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>-t</code></td>
<td style="text-align:left">目标平台，支持 <code>rk356x</code>、<code>rk3588</code>、<code>rk3576</code>、<code>rv1106</code>、<code>rk1808</code>、<code>rv1126</code></td>
</tr>
<tr>
<td style="text-align:left"><code>-a</code></td>
<td style="text-align:left">目标架构，支持 <code>aarch64</code>(64位 ARM) 和 <code>armhf</code>(32位 ARM)</td>
</tr>
<tr>
<td style="text-align:left"><code>-d</code></td>
<td style="text-align:left">演示程序名称</td>
</tr>
<tr>
<td style="text-align:left"><code>-b</code></td>
<td style="text-align:left">构建类型，支持 <code>Debug</code>(调试版) 和 <code>Release</code>(发行版)</td>
</tr>
<tr>
<td style="text-align:left"><code>-m</code></td>
<td style="text-align:left">启用地址sanitizer检测，此时 <code>-b</code> 参数必须设置为 <code>Debug</code></td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d deeplabv3</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d lite_transformer</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d LPRNet</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d mobilenet</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d PPOCR-Rec</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d PPOCR-Det</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d PPOCR-System</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d ppseg</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d ppyoloe</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d resnet</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d RetinaFace</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolov5</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolov5_seg</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolov6</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolov7</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolov8</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolov8_seg</span><br><span class="line">./build-linux.sh -t rk3588 -a aarch64 -d yolox</span><br></pre></td></tr></table></figure>
<h1 id="工作记录星期三"><a class="markdownIt-Anchor" href="#工作记录星期三"></a> 工作记录(星期三)</h1>
<p>==当你在凝视深渊的时候，深渊也在凝视你==<br />
==摆脱一份幻觉比发现一个真理更能使人明智==</p>
<hr />
<p>昨天晚上的想法倒还行，以后可以继续进行尝试，算了不想这么多了，先搞明白音视频相关的，搞明白后面都要做啥才是最重要的，不是很想搞这个，算了先研究吧。</p>
<p>假如我们创建一个 1080x1920 (高x宽)的视频，每个像素占用 3 bytes 对颜色进行编码(或使用 24 bit 真色彩, 这可以提供 16,777,216 种不同的颜色)，每秒 24 帧，视频时长为 30 分钟。</p>
<ol>
<li>每帧的大小计算:
<ul>
<li>视频分辨率为 1080 x 1920</li>
<li>每个像素占用 3 bytes (24 bit 真彩色)</li>
<li>每帧的总像素数为 1080 x 1920 = 2,073,600 个</li>
<li>每帧的大小为 2,073,600 个像素 x 3 bytes/像素 = 6,220,800 bytes</li>
</ul>
</li>
<li>总帧数计算:
<ul>
<li>视频时长为 30 分钟 = 1,800 秒</li>
<li>视频帧率为 24 fps</li>
<li>总帧数为 1,800 秒 x 24 fps = 43,200 帧</li>
</ul>
</li>
<li>总数据量计算:
<ul>
<li>每帧 6,220,800 bytes</li>
<li>总帧数 43,200 帧</li>
<li>总数据量为 6,220,800 bytes/帧 x 43,200 帧 = 268,916,736,000 bytes ≈ 250.28 GB</li>
</ul>
</li>
<li>带宽计算:
<ul>
<li>总数据量为 268,916,736,000 bytes</li>
<li>视频时长为 1,800 秒</li>
<li>带宽 = 总数据量 / 时长 = 268,916,736,000 bytes / 1,800 seconds ≈ 149,398,186 bytes/s</li>
<li>换算成比特每秒(bps)为 149,398,186 bytes/s x 8 bits/byte = 1,195,185,488 bps ≈ 1.19 Gbps</li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-n, --name IMAGE_NAME</td>
<td style="text-align:left">构建镜像的名称,例如: openEuler-20.03-LTS-Firefly-RK3399-aarch64-alpha1 或 openEuler-21.09-Firefly-RK3399-aarch64-alpha1</td>
</tr>
<tr>
<td style="text-align:left">-k, --kernel KERNEL_URL</td>
<td style="text-align:left">内核源码仓库的项目地址,默认为 <a target="_blank" rel="noopener" href="https://gitee.com/openeuler/rockchip-kernel.git,%E4%B9%9F%E5%8F%AF%E8%AE%BE%E7%BD%AE%E4%B8%BA">https://gitee.com/openeuler/rockchip-kernel.git,也可设置为</a> <a href="mailto:git@gitee.com">git@gitee.com</a>:openeuler/rockchip-kernel.git 或 <a href="mailto:git@gitee.com">git@gitee.com</a>:openeuler/kernel.git</td>
</tr>
<tr>
<td style="text-align:left">-b, --branch KERNEL_BRANCH</td>
<td style="text-align:left">内核源码的对应分支,默认为 openEuler-20.03-LTS,根据 -k 参数的不同可选 openEuler-20.03-LTS 或 openEuler-21.09</td>
</tr>
<tr>
<td style="text-align:left">-c, --config BOARD_CONFIG</td>
<td style="text-align:left">开发板对应的 defconfig 文件名称,默认为 firefly-rk3399_defconfig,如需在 RK3588 开发板上使用预编译的 u-boot,可设为 none</td>
</tr>
<tr>
<td style="text-align:left">-r, --repo REPO_INFO</td>
<td style="text-align:left">开发源 repo 文件的 URL 或路径,也可以是开发源中资源库的 baseurl 列表(需使用双引号引起来,各 baseurl 之间用空格隔开)</td>
</tr>
<tr>
<td style="text-align:left">-d, --device-tree DTB_NAME</td>
<td style="text-align:left">内核设备树中的设备名称,对应 kernel/arch/arm64/boot/dts/rockchip 下的 DTB_NAME.dts 文件,默认为 rk3399-firefly</td>
</tr>
<tr>
<td style="text-align:left">-s, --spec SPEC</td>
<td style="text-align:left">构建镜像的版本,可选:headless(无图形界面)、xfce(带 Xfce 桌面及配套软件)、ukui(带 UKUI 桌面及必要配套软件,不含中文字体和输入法)、dde(带 DDE 桌面及必要配套软件,不含中文字体和输入法)、rpmlist 文件路径(包含要安装的软件列表),默认为 headless</td>
</tr>
<tr>
<td style="text-align:left">-h, --help</td>
<td style="text-align:left">显示帮助信息</td>
</tr>
</tbody>
</table>
<p>不能盲目的开始研究，要懂得学习的真正意义，懂了吗。</p>
<h2 id="buildsh分析"><a class="markdownIt-Anchor" href="#buildsh分析"></a> build.sh分析</h2>
<h3 id="__usage-help"><a class="markdownIt-Anchor" href="#__usage-help"></a> __usage help</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__usage=&quot;</span><br><span class="line">Usage: build [OPTIONS]</span><br><span class="line">Build Rockchip bootable images.</span><br><span class="line">The target bootable compressed images will be generated in the build/YYYY-MM-DD folder of the directory where the build script is located.</span><br><span class="line"></span><br><span class="line">Options: </span><br><span class="line">  -n, --name IMAGE_NAME            The Rockchip image name to be built.</span><br><span class="line">  -k, --kernel KERNEL_URL          The URL of kernel source&#x27;s repository, which defaults to https://gitee.com/openeuler/rockchip-kernel.git.</span><br><span class="line">  -b, --branch KERNEL_BRANCH       The branch name of kernel source&#x27;s repository, which defaults to openEuler-20.03-LTS.</span><br><span class="line">  -c, --config BOARD_CONFIG        Required! The name of target board which should be a space separated list, which defaults to firefly-rk3399_defconfig.</span><br><span class="line">  -r, --repo REPO_INFO             The URL/path of target repo file or list of repo&#x27;s baseurls which should be a space separated list.</span><br><span class="line">  -d, --device-tree DTB_NAME       Required! The device tree name of target board, which defaults to rk3399-firefly.</span><br><span class="line">  -s, --spec SPEC                  The image&#x27;s specification: headless, xfce, ukui, dde or the file path of rpmlist. The default is headless.</span><br><span class="line">  -h, --help                       Show command help.</span><br><span class="line">&quot;</span><br><span class="line">help()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;$__usage&quot;</span><br><span class="line">    exit $1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就一些打印信息，确定了一些参数，简单</p>
<h3 id="param"><a class="markdownIt-Anchor" href="#param"></a> param</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">default_param() &#123;</span><br><span class="line">    config=firefly-rk3399_defconfig</span><br><span class="line">    dtb_name=rk3399-firefly</span><br><span class="line">    branch=openEuler-20.03-LTS</span><br><span class="line">    repo_file=&quot;https://gitee.com/src-openeuler/openEuler-repos/raw/openEuler-20.03-LTS/generic.repo&quot;</span><br><span class="line">    kernel_url=&quot;https://gitee.com/openeuler/rockchip-kernel.git&quot;</span><br><span class="line">    workdir=$(pwd)/build</span><br><span class="line">    board_type=rk3399</span><br><span class="line">    name=$&#123;branch&#125;-$&#123;dtb_name&#125;-aarch64-alpha1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">save_param() &#123;</span><br><span class="line">    if [ -f $workdir/.param_last ]; then</span><br><span class="line">        rm $workdir/.param_last</span><br><span class="line">    fi</span><br><span class="line">    if [ -f $workdir/.param ]; then</span><br><span class="line">        mv $workdir/.param $workdir/.param_last</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;config=$config</span><br><span class="line">dtb_name=$dtb_name</span><br><span class="line">branch=$branch</span><br><span class="line">repo_file=$repo_file</span><br><span class="line">kernel_url=$kernel_url</span><br><span class="line">spec_param=$spec_param&quot; &gt; $workdir/.param</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置一些默认配置选项，如果在传入参数中不进行设置，则就会使用默认的配置</p>
<h3 id="deppkg_install"><a class="markdownIt-Anchor" href="#deppkg_install"></a> deppkg_install</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deppkg_install() &#123;</span><br><span class="line">    dnf makecache</span><br><span class="line">    dnf install git wget make gcc bison dtc m4 flex bc openssl-devel tar dosfstools rsync parted dnf-plugins-core tar kpartx diffutils dracut -y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装一些构建用到的依赖包</p>
<h3 id="parseargs"><a class="markdownIt-Anchor" href="#parseargs"></a> parseargs</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">parseargs()</span><br><span class="line">&#123;</span><br><span class="line">    if [ &quot;x$#&quot; == &quot;x0&quot; ]; then</span><br><span class="line">        return 0</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    while [ &quot;x$#&quot; != &quot;x0&quot; ];</span><br><span class="line">    do</span><br><span class="line">        if [ &quot;x$1&quot; == &quot;x-h&quot; -o &quot;x$1&quot; == &quot;x--help&quot; ]; then</span><br><span class="line">            return 1</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x&quot; ]; then</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-n&quot; -o &quot;x$1&quot; == &quot;x--name&quot; ]; then</span><br><span class="line">            name=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-k&quot; -o &quot;x$1&quot; == &quot;x--kernel&quot; ]; then</span><br><span class="line">            kernel_url=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-b&quot; -o &quot;x$1&quot; == &quot;x--branch&quot; ]; then</span><br><span class="line">            branch=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-c&quot; -o &quot;x$1&quot; == &quot;x--config&quot; ]; then</span><br><span class="line">            config=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-r&quot; -o &quot;x$1&quot; == &quot;x--repo&quot; ]; then</span><br><span class="line">            repo_file=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-d&quot; -o &quot;x$1&quot; == &quot;x--device-tree&quot; ]; then</span><br><span class="line">            dtb_name=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-s&quot; -o &quot;x$1&quot; == &quot;x--spec&quot; ]; then</span><br><span class="line">            spec_param=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        else</span><br><span class="line">            echo `date` - ERROR, UNKNOWN params &quot;$@&quot;</span><br><span class="line">            return 2</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数判断：</p>
<ol>
<li>如果没有传入任何参数,函数直接返回 0。</li>
<li>循环检查每个参数:
<ul>
<li>如果参数是 <code>-h</code> 或 <code>--help</code>，返回 1 表示显示帮助信息。</li>
<li>如果参数为空,则跳过。</li>
<li>如果参数是 <code>-n</code> 或 <code>--name</code>，则将第二个参数的值赋给变量 <code>name</code>。</li>
<li>如果参数是 <code>-k</code> 或 <code>--kernel</code>，则将第二个参数的值赋给变量 <code>kernel_url</code>。</li>
<li>如果参数是 <code>-b</code> 或 <code>--branch</code>，则将第二个参数的值赋给变量 <code>branch</code>。</li>
<li>如果参数是 <code>-c</code> 或 <code>--config</code>，则将第二个参数的值赋给变量 <code>config</code>。</li>
<li>如果参数是 <code>-r</code> 或 <code>--repo</code>，则将第二个参数的值赋给变量 <code>repo_file</code>。</li>
<li>如果参数是 <code>-d</code> 或 <code>--device-tree</code>，则将第二个参数的值赋给变量 <code>dtb_name</code>。</li>
<li>如果参数是 <code>-s</code> 或 <code>--spec</code>，则将第二个参数的值赋给变量 <code>spec_param</code>。</li>
<li>如果参数不是上述任何一种,则打印错误信息并返回 2。</li>
</ul>
</li>
</ol>
<h3 id="log"><a class="markdownIt-Anchor" href="#log"></a> log</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">buildid=$(date +%Y%m%d%H%M%S)</span><br><span class="line">builddate=$&#123;buildid:0:8&#125;</span><br><span class="line"></span><br><span class="line">ERROR()&#123;</span><br><span class="line">    echo `date` - ERROR, $* | tee -a $&#123;log_dir&#125;/$&#123;builddate&#125;.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LOG()&#123;</span><br><span class="line">    echo `date` - INFO, $* | tee -a $&#123;log_dir&#125;/$&#123;builddate&#125;.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="main"><a class="markdownIt-Anchor" href="#main"></a> main</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认参数</span></span><br><span class="line">default_param</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析命令行参数</span></span><br><span class="line">parseargs &quot;$@&quot; || help $?</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用解析后的参数</span></span><br><span class="line">used_param</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建工作目录</span></span><br><span class="line">if [ ! -d $workdir ]; then</span><br><span class="line">    mkdir $workdir</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建日志目录</span></span><br><span class="line">save_param</span><br><span class="line">if [ ! -d $&#123;log_dir&#125; ];then </span><br><span class="line">    mkdir -p $&#123;log_dir&#125;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查先前的构建状态</span></span><br><span class="line">if [ -f $workdir/.done ];then</span><br><span class="line">    LOG &quot;Checking the previous build.&quot;</span><br><span class="line">    # 如果之前的构建已完成,则清除构建标志</span><br><span class="line">    if [[ $(cat $workdir/.done | grep u-boot) == &quot;u-boot&quot; &amp;&amp; \</span><br><span class="line">    $(cat $workdir/.done | grep bootimg) == &quot;bootimg&quot; &amp;&amp; \</span><br><span class="line">    $(cat $workdir/.done | grep rootfs) == &quot;rootfs&quot; &amp;&amp; \</span><br><span class="line">    $(cat $workdir/.done | grep image) == &quot;image&quot; ]];then</span><br><span class="line">        LOG &quot;Found complete build, clean build flag.&quot;</span><br><span class="line">        rm $workdir/.done</span><br><span class="line">        touch $workdir/.done</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    # 如果没有先前的构建状态,则安装依赖包并创建构建标志</span><br><span class="line">    deppkg_install</span><br><span class="line">    touch $workdir/.done</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果 u-boot 没有构建完成,则构建 u-boot</span></span><br><span class="line">if [[ $(cat $workdir/.done | grep u-boot) != &quot;u-boot&quot; ]];then</span><br><span class="line">    bash build_u-boot.sh</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果 boot 镜像没有构建完成,则构建 boot 镜像</span></span><br><span class="line">if [[ $(cat $workdir/.done | grep bootimg) != &quot;bootimg&quot; ]];then</span><br><span class="line">    bash build_boot.sh</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果 rootfs 没有构建完成,则构建 rootfs</span></span><br><span class="line">if [[ $(cat $workdir/.done | grep rootfs) != &quot;rootfs&quot; ]];then</span><br><span class="line">    bash build_rootfs.sh</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据设备树名称确定板卡类型</span></span><br><span class="line">if [[ &quot;x$dtb_name&quot; == &quot;xrk3588s-roc-pc&quot; || &quot;x$dtb_name&quot; == &quot;xrk3588-firefly-itx-3588j&quot; || &quot;x$dtb_name&quot; == &quot;xrk3588-rock-5b&quot; ]]; then</span><br><span class="line">    board_type=rk3588</span><br><span class="line">else</span><br><span class="line">    board_type=rk3399</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成最终镜像</span></span><br><span class="line">bash gen_image.sh -n $name -t $board_type</span><br></pre></td></tr></table></figure>
<h2 id="build_rootfssh"><a class="markdownIt-Anchor" href="#build_rootfssh"></a> build_rootfs.sh</h2>
<h3 id="usage"><a class="markdownIt-Anchor" href="#usage"></a> usage</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__usage=&quot;</span><br><span class="line">Usage: build_rootfs [OPTIONS]</span><br><span class="line">Build Rockchip openEuler-root image.</span><br><span class="line">Run in root user.</span><br><span class="line">The target rootfs.img will be generated in the build folder of the directory where the build_rootfs.sh script is located.</span><br><span class="line"></span><br><span class="line">Options: </span><br><span class="line">  -r, --repo REPO_INFO          The URL/path of target repo file or list of repo&#x27;s baseurls which should be a space separated list.</span><br><span class="line">  -b, --branch KERNEL_BRANCH    The branch name of kernel source&#x27;s repository, which defaults to openEuler-20.03-LTS.</span><br><span class="line">  -d, --device-tree DTB_NAME    The device tree name of target board, which defaults to rk3399-firefly.</span><br><span class="line">  -s, --spec SPEC               The image&#x27;s specification: headless, xfce, ukui, dde or the file path of rpmlist. The default is headless.</span><br><span class="line">  -h, --help                    Show command help.</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">help()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;$__usage&quot;</span><br><span class="line">    exit $1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印提示</p>
<h3 id="default_param"><a class="markdownIt-Anchor" href="#default_param"></a> default_param</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">default_param() &#123;</span><br><span class="line">    repo_file=&quot;https://gitee.com/src-openeuler/openEuler-repos/raw/openEuler-20.03-LTS/generic.repo&quot;</span><br><span class="line">    tmp_dir=$&#123;workdir&#125;/tmp</span><br><span class="line">    workdir=$(pwd)/build</span><br><span class="line">    dtb_name=rk3399-firefly</span><br><span class="line">    branch=openEuler-20.03-LTS</span><br><span class="line">    nonfree_bin_dir=$&#123;workdir&#125;/../bin</span><br><span class="line">    rootfs_dir=$&#123;workdir&#125;/rootfs</span><br><span class="line">    log_dir=$&#123;workdir&#125;/log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">local_param()&#123;</span><br><span class="line">    if [ -f $workdir/.param ]; then</span><br><span class="line">        repo_file=$(cat $workdir/.param | grep repo_file)</span><br><span class="line">        repo_file=$&#123;repo_file:10&#125;</span><br><span class="line"></span><br><span class="line">        branch=$(cat $workdir/.param | grep branch)</span><br><span class="line">        branch=$&#123;branch:7&#125;</span><br><span class="line"></span><br><span class="line">        dtb_name=$(cat $workdir/.param | grep dtb_name)</span><br><span class="line">        dtb_name=$&#123;dtb_name:9&#125;</span><br><span class="line"></span><br><span class="line">        spec_param=$(cat $workdir/.param | grep spec_param)</span><br><span class="line">        spec_param=$&#123;spec_param:11&#125;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置默认的参数</p>
<h3 id="参数判断"><a class="markdownIt-Anchor" href="#参数判断"></a> 参数判断</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">parseargs()</span><br><span class="line">&#123;</span><br><span class="line">    if [ &quot;x$#&quot; == &quot;x0&quot; ]; then</span><br><span class="line">        return 0</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    while [ &quot;x$#&quot; != &quot;x0&quot; ];</span><br><span class="line">    do</span><br><span class="line">        if [ &quot;x$1&quot; == &quot;x-h&quot; -o &quot;x$1&quot; == &quot;x--help&quot; ]; then</span><br><span class="line">            return 1</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x&quot; ]; then</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-r&quot; -o &quot;x$1&quot; == &quot;x--repo&quot; ]; then</span><br><span class="line">            repo_file=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-b&quot; -o &quot;x$1&quot; == &quot;x--branch&quot; ]; then</span><br><span class="line">            branch=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-d&quot; -o &quot;x$1&quot; == &quot;x--device-tree&quot; ]; then</span><br><span class="line">            dtb_name=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-s&quot; -o &quot;x$1&quot; == &quot;x--spec&quot; ]; then</span><br><span class="line">            spec_param=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        else</span><br><span class="line">            echo `date` - ERROR, UNKNOWN params &quot;$@&quot;</span><br><span class="line">            return 2</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置log文件"><a class="markdownIt-Anchor" href="#设置log文件"></a> 设置log文件</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">buildid=$(date +%Y%m%d%H%M%S)</span><br><span class="line">builddate=$&#123;buildid:0:8&#125;</span><br><span class="line"></span><br><span class="line">ERROR()&#123;</span><br><span class="line">    echo `date` - ERROR, $* | tee -a $&#123;log_dir&#125;/$&#123;builddate&#125;.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LOG()&#123;</span><br><span class="line">    echo `date` - INFO, $* | tee -a $&#123;log_dir&#125;/$&#123;builddate&#125;.log</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="构建前的动作"><a class="markdownIt-Anchor" href="#构建前的动作"></a> 构建前的动作</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LOSETUP_D_IMG()&#123;</span><br><span class="line">    set +e</span><br><span class="line">    if [ -d $&#123;workdir&#125;/rootfs_tmp ]; then</span><br><span class="line">        if grep -q &quot;$&#123;workdir&#125;/rootfs_tmp &quot; /proc/mounts ; then</span><br><span class="line">            umount $&#123;workdir&#125;/rootfs_tmp</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">    if [ -d $&#123;workdir&#125;/rootfs_tmp ]; then</span><br><span class="line">        rm -rf $&#123;workdir&#125;/rootfs_tmp</span><br><span class="line">    fi</span><br><span class="line">    set -e</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UMOUNT_ALL()&#123;</span><br><span class="line">    set +e</span><br><span class="line">    if grep -q &quot;$&#123;rootfs_dir&#125;/dev &quot; /proc/mounts ; then</span><br><span class="line">        umount -l $&#123;rootfs_dir&#125;/dev</span><br><span class="line">    fi</span><br><span class="line">    if grep -q &quot;$&#123;rootfs_dir&#125;/proc &quot; /proc/mounts ; then</span><br><span class="line">        umount -l $&#123;rootfs_dir&#125;/proc</span><br><span class="line">    fi</span><br><span class="line">    if grep -q &quot;$&#123;rootfs_dir&#125;/sys &quot; /proc/mounts ; then</span><br><span class="line">        umount -l $&#123;rootfs_dir&#125;/sys</span><br><span class="line">    fi</span><br><span class="line">    set -e</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="判断是不是root"><a class="markdownIt-Anchor" href="#判断是不是root"></a> 判断是不是root</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root_need() &#123;</span><br><span class="line">    if [[ $EUID -ne 0 ]]; then</span><br><span class="line">        echo &quot;Error:This script must be run as root!&quot; 1&gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="安装deb包"><a class="markdownIt-Anchor" href="#安装deb包"></a> 安装deb包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">INSTALL_PACKAGES()&#123;</span><br><span class="line">    for item in $(cat $1)</span><br><span class="line">    do</span><br><span class="line">        dnf $&#123;repo_info&#125; --disablerepo=&quot;*&quot; --installroot=$&#123;rootfs_dir&#125;/ install -y $item --nogpgcheck</span><br><span class="line">        if [ $? == 0 ]; then</span><br><span class="line">            LOG install $item.</span><br><span class="line">        else</span><br><span class="line">            ERROR can not install $item.</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="构建rootfs"><a class="markdownIt-Anchor" href="#构建rootfs"></a> 构建rootfs</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">build_rootfs() &#123;</span><br><span class="line">    # 在函数退出时调用 UMOUNT_ALL 进行清理</span><br><span class="line">    trap &#x27;UMOUNT_ALL&#x27; EXIT</span><br><span class="line">    cd $workdir</span><br><span class="line"></span><br><span class="line">    # 如果 rootfs 目录存在，则删除</span><br><span class="line">    if [ -d rootfs ]; then rm -rf rootfs; fi</span><br><span class="line">    mkdir rootfs</span><br><span class="line"></span><br><span class="line">    # 如果临时目录不存在，则创建；否则清空</span><br><span class="line">    if [ ! -d $&#123;tmp_dir&#125; ]; then</span><br><span class="line">        mkdir -p $&#123;tmp_dir&#125;</span><br><span class="line">    else</span><br><span class="line">        rm -rf $&#123;tmp_dir&#125;/*</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 根据 spec_param 的值进行配置</span><br><span class="line">    if [ &quot;x$spec_param&quot; == &quot;xheadless&quot; ] || [ &quot;x$spec_param&quot; == &quot;x&quot; ]; then</span><br><span class="line">        :</span><br><span class="line">    elif [ &quot;x$spec_param&quot; == &quot;xxfce&quot; ] || [ &quot;x$spec_param&quot; == &quot;xukui&quot; ] || [ &quot;x$spec_param&quot; == &quot;xdde&quot; ]; then</span><br><span class="line">        CONFIG_RPM_LIST=$workdir/../configs/rpmlist-$&#123;spec_param&#125;</span><br><span class="line">    elif [ -f $&#123;spec_param&#125; ]; then</span><br><span class="line">        cp $&#123;spec_param&#125; $&#123;tmp_dir&#125;/</span><br><span class="line">        spec_file_name=$&#123;spec_param##*/&#125;</span><br><span class="line">        CONFIG_RPM_LIST=$&#123;tmp_dir&#125;/$&#123;spec_file_name&#125;</span><br><span class="line">    else</span><br><span class="line">        echo `date` - ERROR, please check your params in option -s or --spec.</span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 初始化 RPM 数据库</span><br><span class="line">    mkdir -p $&#123;rootfs_dir&#125;/var/lib/rpm</span><br><span class="line">    rpm --root  $&#123;rootfs_dir&#125;/ --initdb</span><br><span class="line"></span><br><span class="line">    # 检查 repo_file 参数</span><br><span class="line">    if [ &quot;x$repo_file&quot; == &quot;x&quot; ] ; then</span><br><span class="line">        echo `date` - ERROR, \&quot;-r REPO_INFO or --repo REPO_INFO\&quot; missing.</span><br><span class="line">        help 2</span><br><span class="line">    elif [ &quot;x$&#123;repo_file:0:4&#125;&quot; == &quot;xhttp&quot; ]; then</span><br><span class="line">        # 处理 http URL 的 repo_file</span><br><span class="line">        if [ &quot;x$&#123;repo_file:0-5&#125;&quot; == &quot;x.repo&quot; ]; then</span><br><span class="line">            repo_url=$&#123;repo_file&#125;</span><br><span class="line">            wget $&#123;repo_file&#125; -P $&#123;tmp_dir&#125;/</span><br><span class="line">            repo_file_name=$&#123;repo_file##*/&#125;</span><br><span class="line">            repo_file=$&#123;tmp_dir&#125;/$&#123;repo_file_name&#125;</span><br><span class="line">        else</span><br><span class="line">            repo_file_name=tmp.repo</span><br><span class="line">            repo_file_tmp=$&#123;tmp_dir&#125;/$&#123;repo_file_name&#125;</span><br><span class="line">            index=1</span><br><span class="line">            for baseurl in $&#123;repo_file// / &#125;</span><br><span class="line">            do</span><br><span class="line">                echo [repo$&#123;index&#125;] &gt;&gt; $&#123;repo_file_tmp&#125;</span><br><span class="line">                echo name=repo$&#123;index&#125; to build rk3399 image &gt;&gt; $&#123;repo_file_tmp&#125;</span><br><span class="line">                echo baseurl=$&#123;baseurl&#125; &gt;&gt; $&#123;repo_file_tmp&#125;</span><br><span class="line">                echo enabled=1 &gt;&gt; $&#123;repo_file_tmp&#125;</span><br><span class="line">                echo gpgcheck=0 &gt;&gt; $&#123;repo_file_tmp&#125;</span><br><span class="line">                echo &gt;&gt; $&#123;repo_file_tmp&#125;</span><br><span class="line">                index=$(($index+1))</span><br><span class="line">            done</span><br><span class="line">            repo_file=$&#123;repo_file_tmp&#125;</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        # 处理本地文件的 repo_file</span><br><span class="line">        if [ ! -f $repo_file ]; then</span><br><span class="line">            echo `date` - ERROR, repo file $repo_file can not be found.</span><br><span class="line">            exit 2</span><br><span class="line">        else</span><br><span class="line">            cp $repo_file $&#123;tmp_dir&#125;/</span><br><span class="line">            repo_file_name=$&#123;repo_file##*/&#125;</span><br><span class="line">            repo_file=$&#123;tmp_dir&#125;/$&#123;repo_file_name&#125;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 解析 repo 文件的内容</span><br><span class="line">    repo_info_names=`cat $&#123;repo_file&#125; | grep &quot;^\[&quot;`</span><br><span class="line">    repo_baseurls=`cat $&#123;repo_file&#125; | grep &quot;^baseurl=&quot;`</span><br><span class="line">    index=1</span><br><span class="line">    for repo_name in $&#123;repo_info_names&#125;</span><br><span class="line">    do</span><br><span class="line">        repo_name_list[$index]=$&#123;repo_name:1:-1&#125;</span><br><span class="line">        index=$((index+1))</span><br><span class="line">    done</span><br><span class="line">    index=1</span><br><span class="line">    for baseurl in $&#123;repo_baseurls&#125;</span><br><span class="line">    do</span><br><span class="line">        repo_info=&quot;$&#123;repo_info&#125; --repofrompath $&#123;repo_name_list[$index]&#125;-tmp,$&#123;baseurl:8&#125;&quot;</span><br><span class="line">        index=$((index+1))</span><br><span class="line">    done</span><br><span class="line">    </span><br><span class="line">    # 下载并安装 os_release_name</span><br><span class="line">    os_release_name=&quot;openEuler-release&quot;</span><br><span class="line">    dnf $&#123;repo_info&#125; --disablerepo=&quot;*&quot; --downloaddir=$&#123;workdir&#125;/ download $&#123;os_release_name&#125;</span><br><span class="line">    if [ $? != 0 ]; then</span><br><span class="line">        ERROR &quot;Fail to download $&#123;os_release_name&#125;!&quot;</span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line">    os_release_name=`ls -r $&#123;workdir&#125;/$&#123;os_release_name&#125;*.rpm 2&gt;/dev/null | head -n 1`</span><br><span class="line">    if [ -z &quot;$&#123;os_release_name&#125;&quot; ]; then</span><br><span class="line">        ERROR &quot;$&#123;os_release_name&#125; can not be found!&quot;</span><br><span class="line">        exit 2</span><br><span class="line">    else</span><br><span class="line">        LOG &quot;Success to download $&#123;os_release_name&#125;.&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    rpm -ivh --nodeps --root $&#123;rootfs_dir&#125;/ $&#123;os_release_name&#125;</span><br><span class="line"></span><br><span class="line">    # 配置 RPM 和网络设置</span><br><span class="line">    mkdir -p $&#123;rootfs_dir&#125;/etc/rpm</span><br><span class="line">    chmod a+rX $&#123;rootfs_dir&#125;/etc/rpm</span><br><span class="line">    echo &quot;%_install_langs en_US&quot; &gt; $&#123;rootfs_dir&#125;/etc/rpm/macros.image-language-conf</span><br><span class="line">    INSTALL_PACKAGES $CONFIG_RPM_LIST</span><br><span class="line">    cp -L /etc/resolv.conf $&#123;rootfs_dir&#125;/etc/resolv.conf</span><br><span class="line">    rm $&#123;workdir&#125;/*rpm</span><br><span class="line"></span><br><span class="line">    echo &quot;   nameserver 8.8.8.8</span><br><span class="line">   nameserver 114.114.114.114&quot; &gt; &quot;$&#123;rootfs_dir&#125;/etc/resolv.conf&quot;</span><br><span class="line">    if [ ! -d $&#123;rootfs_dir&#125;/etc/sysconfig/network-scripts ]; then mkdir &quot;$&#123;rootfs_dir&#125;/etc/sysconfig/network-scripts&quot;; fi</span><br><span class="line">    echo &quot;   TYPE=Ethernet</span><br><span class="line">   PROXY_METHOD=none</span><br><span class="line">   BROWSER_ONLY=no</span><br><span class="line">   BOOTPROTO=dhcp</span><br><span class="line">   DEFROUTE=yes</span><br><span class="line">   IPV4_FAILURE_FATAL=no</span><br><span class="line">   IPV6INIT=yes</span><br><span class="line">   IPV6_AUTOCONF=yes</span><br><span class="line">   IPV6_DEFROUTE=yes</span><br><span class="line">   IPV6_FAILURE_FATAL=no</span><br><span class="line">   IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">   NAME=eth0</span><br><span class="line">   UUID=851a6f36-e65c-3a43-8f4a-78fd0fc09dc9</span><br><span class="line">   ONBOOT=yes</span><br><span class="line">   AUTOCONNECT_PRIORITY=-999</span><br><span class="line">   DEVICE=eth0&quot; &gt; &quot;$&#123;rootfs_dir&#125;/etc/sysconfig/network-scripts/ifup-eth0&quot;</span><br><span class="line">    </span><br><span class="line">    LOG &quot;Configure network done.&quot;</span><br><span class="line"></span><br><span class="line">    # 挂载必要的文件系统</span><br><span class="line">    mount --bind /dev $&#123;rootfs_dir&#125;/dev</span><br><span class="line">    mount -t proc /proc $&#123;rootfs_dir&#125;/proc</span><br><span class="line">    mount -t sysfs /sys $&#123;rootfs_dir&#125;/sys</span><br><span class="line"></span><br><span class="line">    # 复制并配置扩展脚本</span><br><span class="line">    cp $nonfree_bin_dir/../bin/extend-root.sh $&#123;rootfs_dir&#125;/etc/rc.d/init.d/extend-root.sh</span><br><span class="line">    chmod +x $&#123;rootfs_dir&#125;/etc/rc.d/init.d/extend-root.sh</span><br><span class="line"></span><br><span class="line">    # 配置 NTP 和自动扩展 rootfs</span><br><span class="line">    set +e</span><br><span class="line">    sed -i -e &#x27;/^#NTP=/cNTP=0.cn.pool.ntp.org&#x27; $&#123;rootfs_dir&#125;/etc/systemd/timesyncd.conf</span><br><span class="line">    sed -i -e &#x27;s/#FallbackNTP=/FallbackNTP=1.asia.pool.ntp.org 2.asia.pool.ntp.org /g&#x27; $&#123;rootfs_dir&#125;/etc/systemd/timesyncd.conf</span><br><span class="line">    set -e</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt; EOF | chroot $&#123;rootfs_dir&#125;  /bin/bash</span><br><span class="line">    echo &#x27;openeuler&#x27; | passwd --stdin root</span><br><span class="line">    echo openEuler &gt; /etc/hostname</span><br><span class="line">    ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">    chkconfig --add extend-root.sh</span><br><span class="line">    chkconfig extend-root.sh on</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    LOG &quot;Set NTP and auto expand rootfs done.&quot;</span><br><span class="line"></span><br><span class="line">    # 配置 fstab 文件</span><br><span class="line">    echo &quot;LABEL=rootfs  / ext4    defaults,noatime 0 0&quot; &gt; $&#123;rootfs_dir&#125;/etc/fstab</span><br><span class="line">    echo &quot;LABEL=boot  /boot vfat    defaults,noatime 0 0&quot; &gt;&gt; $&#123;rootfs_dir&#125;/etc/fstab</span><br><span class="line">    LOG &quot;Set fstab done.&quot;</span><br><span class="line"></span><br><span class="line">    # 根据 dtb_name 进行特定配置</span><br><span class="line">    if [ -f $workdir/.param ]; then</span><br><span class="line">        dtb_name=$(cat $workdir/.param | grep dtb_name)</span><br><span class="line">        dtb_name=$&#123;dtb_name:9&#125;</span><br><span class="line">        if [ &quot;x$dtb_name&quot; == &quot;xrk3399-firefly&quot; ]; then</span><br><span class="line">            cd $workdir</span><br><span class="line">            if [ &quot;x$branch&quot; == &quot;xopenEuler-20.03-LTS&quot; ]; then</span><br><span class="line">                mkdir -p $&#123;rootfs_dir&#125;/system</span><br><span class="line">                mkdir -p $&#123;rootfs_dir&#125;/etc/profile.d/</span><br><span class="line">                mkdir -p $&#123;rootfs_dir&#125;/usr/bin/</span><br><span class="line">                cp -r $nonfree_bin_dir/wireless/system/*    $&#123;rootfs_dir&#125;/system/</span><br><span class="line">                cp   $nonfree_bin_dir/wireless/rcS.sh    $&#123;rootfs_dir&#125;/etc/profile.d/</span><br><span class="line">                cp   $nonfree_bin_dir/wireless/enable_bt    $&#123;rootfs_dir&#125;/usr/bin/</span><br><span class="line">                chmod +x  $&#123;rootfs_dir&#125;/usr/bin/enable_bt  $&#123;rootfs_dir&#125;/etc/profile.d/rcS.sh</span><br><span class="line">                LOG &quot;install firefly-rk3399 wireless firmware done.&quot;</span><br><span class="line">                ln -s $&#123;rootfs_dir&#125;/system/etc/firmware $&#123;rootfs_dir&#125;/etc/firmware</span><br><span class="line">            fi</span><br><span class="line">            mkdir -p $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm</span><br><span class="line">            cp $nonfree_bin_dir/linux-firmware/ap6356s/brcmfmac4356-sdio.bin $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm</span><br><span class="line">            cp $nonfree_bin_dir/linux-firmware/ap6356s/brcmfmac4356-sdio.firefly,firefly-rk3399.txt $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm</span><br><span class="line">            cp $nonfree_bin_dir/linux-firmware/ap6356s/BCM4356A2.hcd $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm</span><br><span class="line">        elif [ &quot;x$dtb_name&quot; == &quot;xrk3588-firefly-itx-3588j&quot; ]; then</span><br><span class="line">            cd $workdir</span><br><span class="line">            mkdir -p $&#123;rootfs_dir&#125;/etc/modules-load.d/</span><br><span class="line">            echo &quot;8821cu&quot; &gt;&gt; $&#123;rootfs_dir&#125;/etc/modules-load.d/8821cu.conf</span><br><span class="line">        elif [ &quot;x$dtb_name&quot; == &quot;xrk3566-roc-pc&quot; ]; then</span><br><span class="line">            mkdir -p $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm</span><br><span class="line">            cp $nonfree_bin_dir/linux-firmware/ap6255/brcmfmac43455-sdio.bin $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm/brcmfmac43455-sdio.firefly,rk3566-roc-pc.bin</span><br><span class="line">            cp $nonfree_bin_dir/linux-firmware/ap6255/brcmfmac43455-sdio.txt $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm/brcmfmac43455-sdio.firefly,rk3566-roc-pc.txt</span><br><span class="line">            cp $nonfree_bin_dir/linux-firmware/ap6255/BCM4345C0.hcd $&#123;rootfs_dir&#125;/usr/lib/firmware/brcm</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 解除挂载</span><br><span class="line">    UMOUNT_ALL</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="构建img镜像"><a class="markdownIt-Anchor" href="#构建img镜像"></a> 构建img镜像</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mk_rootfsimg() &#123;</span><br><span class="line">    trap &#x27;LOSETUP_D_IMG&#x27; EXIT</span><br><span class="line">    cd $workdir</span><br><span class="line">    size=`du -sh --block-size=1MiB $&#123;rootfs_dir&#125; | cut -f 1 | xargs`</span><br><span class="line">    size=$(($size+500))</span><br><span class="line">    rootfs_img=$&#123;workdir&#125;/rootfs.img</span><br><span class="line">    dd if=/dev/zero of=$&#123;rootfs_img&#125; bs=1MiB count=$size status=progress &amp;&amp; sync</span><br><span class="line">    mkfs.ext4 -L rootfs $&#123;workdir&#125;/rootfs.img</span><br><span class="line"></span><br><span class="line">    if [ -d $&#123;workdir&#125;/rootfs_tmp ];then rm -rf $&#123;workdir&#125;/rootfs_tmp; fi</span><br><span class="line">    mkdir $&#123;workdir&#125;/rootfs_tmp</span><br><span class="line">    mount $&#123;workdir&#125;/rootfs.img $&#123;workdir&#125;/rootfs_tmp</span><br><span class="line"></span><br><span class="line">    rsync -avHAXq $&#123;rootfs_dir&#125;/* $&#123;workdir&#125;/rootfs_tmp</span><br><span class="line">    sync</span><br><span class="line">    sleep 10</span><br><span class="line"></span><br><span class="line">    LOSETUP_D_IMG</span><br><span class="line"></span><br><span class="line">    if [ -f $workdir/rootfs.img ]; then</span><br><span class="line">        LOG &quot;make rootfs image done.&quot;</span><br><span class="line">    else</span><br><span class="line">        ERROR &quot;make rootfs image failed!&quot;</span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    LOG &quot;clean rootfs directory.&quot;</span><br><span class="line">    rm -rf $&#123;rootfs_dir&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="main-2"><a class="markdownIt-Anchor" href="#main-2"></a> main</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> -e 确保脚本在命令执行失败时退出</span></span><br><span class="line">set -e</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">调用 root_need 函数，确保脚本在 root 权限下运行</span></span><br><span class="line">root_need</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">调用 default_param 和 local_param 函数来设置默认参数和本地参数</span></span><br><span class="line">default_param</span><br><span class="line">local_param</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析传入的参数，如果解析失败则显示帮助信息并退出</span></span><br><span class="line">parseargs &quot;$@&quot; || help $?</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 CONFIG_RPM_LIST 变量，指向 rpmlist 配置文件</span></span><br><span class="line">CONFIG_RPM_LIST=$workdir/../configs/rpmlist</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果工作目录不存在，则创建</span></span><br><span class="line">if [ ! -d $workdir ]; then</span><br><span class="line">    mkdir $workdir</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果日志目录不存在，则创建</span></span><br><span class="line">if [ ! -d $&#123;log_dir&#125; ];then mkdir -p $&#123;log_dir&#125;; fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果 .<span class="keyword">done</span> 文件不存在，则创建</span></span><br><span class="line">if [ ! -f $workdir/.done ];then</span><br><span class="line">    touch $workdir/.done</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到工作目录</span></span><br><span class="line">cd $workdir</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 .<span class="keyword">done</span> 文件中的 <span class="string">&#x27;rootfs&#x27;</span> 字符串</span></span><br><span class="line">sed -i &#x27;s/rootfs//g&#x27; $workdir/.done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">记录日志信息</span></span><br><span class="line">LOG &quot;build rootfs...&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查 rootfs 目录是否存在</span></span><br><span class="line">if [ -d rootfs ]; then</span><br><span class="line">    # 如果 rootfs.img 文件存在且 .done 文件中包含 &#x27;rootfs&#x27;</span><br><span class="line">    if [[ -f $workdir/rootfs.img &amp;&amp; $(cat $workdir/.done | grep rootfs) == &quot;rootfs&quot; ]]; then</span><br><span class="line">        # 从 .param_last 文件中读取上次构建的参数</span><br><span class="line">        last_branch=$(cat $workdir/.param_last | grep branch)</span><br><span class="line">        last_branch=$&#123;last_branch:7&#125;</span><br><span class="line"></span><br><span class="line">        last_dtb_name=$(cat $workdir/.param_last | grep dtb_name)</span><br><span class="line">        last_dtb_name=$&#123;last_dtb_name:9&#125;</span><br><span class="line"></span><br><span class="line">        last_repo_file=$(cat $workdir/.param_last | grep repo_file)</span><br><span class="line">        last_repo_file=$&#123;last_repo_file:10&#125;</span><br><span class="line"></span><br><span class="line">        last_spec_param=$(cat $workdir/.param_last | grep spec_param)</span><br><span class="line">        last_spec_param=$&#123;last_spec_param:11&#125;</span><br><span class="line"></span><br><span class="line">        # 比较当前参数与上次构建的参数，如果不同则重新构建 rootfs</span><br><span class="line">        if [[ $&#123;last_branch&#125; != $&#123;branch&#125; || $&#123;last_dtb_name&#125; != $&#123;dtb_name&#125; || $&#123;last_repo_file&#125; != $&#123;repo_file&#125; || $&#123;last_spec_param&#125; != $&#123;spec_param&#125; ]]; then</span><br><span class="line">            rm -rf rootfs</span><br><span class="line">            build_rootfs</span><br><span class="line">            mk_rootfsimg</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        # 如果 rootfs.img 文件不存在或 .done 文件中不包含 &#x27;rootfs&#x27;，则重新构建 rootfs</span><br><span class="line">        rm -rf rootfs</span><br><span class="line">        build_rootfs</span><br><span class="line">        mk_rootfsimg</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    # 如果 rootfs 目录不存在，则构建 rootfs</span><br><span class="line">    build_rootfs</span><br><span class="line">    mk_rootfsimg</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">记录日志信息</span></span><br><span class="line">LOG &quot;The rootfs.img is generated in the $&#123;workdir&#125;.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 <span class="string">&#x27;rootfs&#x27;</span> 字符串追加到 .<span class="keyword">done</span> 文件中</span></span><br><span class="line">echo &quot;rootfs&quot; &gt;&gt; $workdir/.done</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.openeuler.org/openEuler-23.09/docker_img/aarch64/openEuler-docker.aarch64.tar.xz</span><br><span class="line">sudo docker load -i openEuler-docker.aarch64.tar.xz</span><br><span class="line">sudo docker run -t -i --privileged -v /dev/bus/usb:/dev/bus/usb -v /home/topeet/03_rockchip:/examples openeuler-23.09:latest /bin/bash</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://repo.openeuler.org/openEuler-24.03-LTS/everything/aarch64/Packages/openEuler-release-24.03LTS-55.oe2403.aarch64.rpm">https://repo.openeuler.org/openEuler-24.03-LTS/everything/aarch64/Packages/openEuler-release-24.03LTS-55.oe2403.aarch64.rpm</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dnf install git wget rsync</span><br><span class="line"></span><br><span class="line">git clone https://gitee.com/openeuler/rockchip.git</span><br><span class="line"></span><br><span class="line">dnf install &#x27;dnf-command(download)&#x27;</span><br><span class="line"></span><br><span class="line">bash build_rootfs.sh -r https://gitee.com/src-openeuler/openEuler-repos/raw/openEuler-22.03-LTS/generic.repo -b openEuler-22.03-LTS-RK3588 -d rk3588s-roc-pc -s xfce</span><br><span class="line"></span><br><span class="line">bash build.sh -n openEuler-22.03-LTS-Station-M3-aarch64-alpha1 -k https://gitee.com/openeuler/rockchip-kernel.git -b openEuler-22.03-LTS-RK3588 -c none -r https://gitee.com/src-openeuler/openEuler-repos/raw/openEuler-22.03-LTS/generic.repo -d rk3588s-roc-pc -s headless</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="工作记录星期四"><a class="markdownIt-Anchor" href="#工作记录星期四"></a> 工作记录(星期四)</h1>
<p>==听了很多的道理，依然过不好这一生==</p>
<p>==摆脱一份幻觉，比发现一个真理更能使人明智==</p>
<hr />
<p>昨天也算是真正意义上的付费阅读了，就还行吧，但是付费阅读之后就会发现，它的本意并没有那么好，归根结底也只是感情戏比较好， 目前我也并不喜欢这种后宫的文章，最主要的是心境不对，不是吗，所以就这样吧，也到此为止了，我更认为剑来比较适合我，择天记算是我永远的白月光，行了，开始今天的学习吧。</p>
<p>昨天的时候简单的构建了一个文件系统，但是并不能正常的启动，目前认为问题出现在内核上面，其实就很奇怪，无非也就是一个文件系统而已，奇奇怪怪的，为什么反而无法进入系统呢？</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42175752/article/details/137755842">认识欧拉操作系统</a></p>
<p>目前认为是跟内核有关系，现在的话文件系统的构建是要用docker 的，但是内核的编译肯定是可以用当前设备的，而具体要如何编译呢。</p>
<h2 id="内核构建"><a class="markdownIt-Anchor" href="#内核构建"></a> 内核构建</h2>
<h3 id="usage-2"><a class="markdownIt-Anchor" href="#usage-2"></a> usage</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__usage=&quot;</span><br><span class="line">Usage: build_boot [OPTIONS]</span><br><span class="line">Build Rockchip boot image.</span><br><span class="line">The target boot.img will be generated in the build folder of the directory where the build_boot.sh script is located.</span><br><span class="line"></span><br><span class="line">Options: </span><br><span class="line">  -b, --branch KERNEL_BRANCH            The branch name of kernel source&#x27;s repository, which defaults to openEuler-20.03-LTS.</span><br><span class="line">  -k, --kernel KERNEL_URL               Required! The URL of kernel source&#x27;s repository.</span><br><span class="line">  -d, --device-tree DTB_NAME            Required! The device tree name of target board, which defaults to rk3399-firefly.</span><br><span class="line">  -h, --help                            Show command help.</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">help()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;$__usage&quot;</span><br><span class="line">    exit $1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="param-2"><a class="markdownIt-Anchor" href="#param-2"></a> param</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">default_param() &#123;</span><br><span class="line">    workdir=$(pwd)/build</span><br><span class="line">    branch=openEuler-20.03-LTS</span><br><span class="line">    dtb_name=rk3399-firefly</span><br><span class="line">    kernel_url=&quot;https://gitee.com/openeuler/rockchip-kernel.git&quot;</span><br><span class="line">    boot_dir=$workdir/boot</span><br><span class="line">    log_dir=$workdir/log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">local_param()&#123;</span><br><span class="line">    if [ -f $workdir/.param ]; then</span><br><span class="line">        branch=$(cat $workdir/.param | grep branch)</span><br><span class="line">        branch=$&#123;branch:7&#125;</span><br><span class="line"></span><br><span class="line">        dtb_name=$(cat $workdir/.param | grep dtb_name)</span><br><span class="line">        dtb_name=$&#123;dtb_name:9&#125;</span><br><span class="line"></span><br><span class="line">        kernel_url=$(cat $workdir/.param | grep kernel_url)</span><br><span class="line">        kernel_url=$&#123;kernel_url:11&#125;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="命令参数"><a class="markdownIt-Anchor" href="#命令参数"></a> 命令参数</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">parseargs()</span><br><span class="line">&#123;</span><br><span class="line">    if [ &quot;x$#&quot; == &quot;x0&quot; ]; then</span><br><span class="line">        return 0</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    while [ &quot;x$#&quot; != &quot;x0&quot; ];</span><br><span class="line">    do</span><br><span class="line">        if [ &quot;x$1&quot; == &quot;x-h&quot; -o &quot;x$1&quot; == &quot;x--help&quot; ]; then</span><br><span class="line">            return 1</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x&quot; ]; then</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-b&quot; -o &quot;x$1&quot; == &quot;x--branch&quot; ]; then</span><br><span class="line">            branch=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-d&quot; -o &quot;x$1&quot; == &quot;x--device-tree&quot; ]; then</span><br><span class="line">            dtb_name=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        elif [ &quot;x$1&quot; == &quot;x-k&quot; -o &quot;x$1&quot; == &quot;x--kernel&quot; ]; then</span><br><span class="line">            kernel_url=`echo $2`</span><br><span class="line">            shift</span><br><span class="line">            shift</span><br><span class="line">        else</span><br><span class="line">            echo `date` - ERROR, UNKNOWN params &quot;$@&quot;</span><br><span class="line">            return 2</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="log-2"><a class="markdownIt-Anchor" href="#log-2"></a> log</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">buildid=$(date +%Y%m%d%H%M%S)</span><br><span class="line">builddate=$&#123;buildid:0:8&#125;</span><br><span class="line"></span><br><span class="line">ERROR()&#123;</span><br><span class="line">    echo `date` - ERROR, $* | tee -a $&#123;log_dir&#125;/$&#123;builddate&#125;.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LOG()&#123;</span><br><span class="line">    echo `date` - INFO, $* | tee -a $&#123;log_dir&#125;/$&#123;builddate&#125;.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="解除挂载"><a class="markdownIt-Anchor" href="#解除挂载"></a> 解除挂载</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">LOSETUP_D_IMG()&#123;</span><br><span class="line">    set +e</span><br><span class="line">    if [ -d $workdir/boot_emmc ]; then</span><br><span class="line">        if grep -q &quot;$workdir/boot_emmc &quot; /proc/mounts ; then</span><br><span class="line">            umount $workdir/boot_emmc</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">    if [ -d $workdir/boot_emmc ]; then</span><br><span class="line">        rm -rf $workdir/boot_emmc</span><br><span class="line">    fi</span><br><span class="line">    set -e</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="克隆-检查-构建内核"><a class="markdownIt-Anchor" href="#克隆-检查-构建内核"></a> 克隆、检查、构建内核</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">clone_and_check_kernel_source() &#123;</span><br><span class="line">    cd $workdir</span><br><span class="line">    if [ -d kernel ]; then</span><br><span class="line">        if [ -f $workdir/.param_last ]; then</span><br><span class="line">            last_branch=$(cat $workdir/.param_last | grep branch)</span><br><span class="line">            last_branch=$&#123;last_branch:7&#125;</span><br><span class="line"></span><br><span class="line">            last_dtb_name=$(cat $workdir/.param_last | grep dtb_name)</span><br><span class="line">            last_dtb_name=$&#123;last_dtb_name:9&#125;</span><br><span class="line"></span><br><span class="line">            last_kernel_url=$(cat $workdir/.param_last | grep kernel_url)</span><br><span class="line">            last_kernel_url=$&#123;last_kernel_url:11&#125;</span><br><span class="line"></span><br><span class="line">            cd $workdir/kernel</span><br><span class="line">            git remote -v update</span><br><span class="line">            lastest_kernel_version=$(git rev-parse @&#123;u&#125;)</span><br><span class="line">            local_kernel_version=$(git rev-parse @)</span><br><span class="line">            cd $workdir</span><br><span class="line"></span><br><span class="line">            if [[ $&#123;last_branch&#125; != $&#123;branch&#125; || \</span><br><span class="line">            $&#123;last_dtb_name&#125; != $&#123;dtb_name&#125; || \</span><br><span class="line">            $&#123;last_kernel_url&#125; != $&#123;kernel_url&#125; || \</span><br><span class="line">            $&#123;lastest_kernel_version&#125; != $&#123;local_kernel_version&#125; ]]; then</span><br><span class="line">                if [ -d $workdir/kernel ];then rm -rf $workdir/kernel; fi</span><br><span class="line">                if [ -d $workdir/boot ];then rm -rf $workdir/boot; fi</span><br><span class="line">                if [ -f $workdir/boot.img ];then rm $workdir/boot.img; fi</span><br><span class="line">                git clone --depth=1 -b $branch $kernel_url kernel</span><br><span class="line">                LOG &quot;clone kernel source done.&quot;</span><br><span class="line">            fi</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        git clone --depth=1 -b $branch $kernel_url kernel</span><br><span class="line">        LOG &quot;clone kernel source done.&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build_6.6-kernel() &#123;</span><br><span class="line">    cp $workdir/../configs/rockchip64-6.6_defconfig kernel/arch/arm64/configs</span><br><span class="line">    cd $workdir/kernel</span><br><span class="line">    make ARCH=arm64 rockchip64-6.6_defconfig</span><br><span class="line">    LOG &quot;make kernel begin...&quot;</span><br><span class="line">    make ARCH=arm64 -j$(nproc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build_5.10-kernel() &#123;</span><br><span class="line">    cp $workdir/../configs/rockchip64-5.10_defconfig kernel/arch/arm64/configs</span><br><span class="line">    cd $workdir/kernel</span><br><span class="line">    make ARCH=arm64 rockchip64-5.10_defconfig</span><br><span class="line">    LOG &quot;make kernel begin...&quot;</span><br><span class="line">    make ARCH=arm64 -j$(nproc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build_4.19-kernel() &#123;</span><br><span class="line">    cp $workdir/../configs/rockchip64-4.19_defconfig kernel/arch/arm64/configs</span><br><span class="line">    cd $workdir/kernel</span><br><span class="line">    make ARCH=arm64 rockchip64_4.19_defconfig</span><br><span class="line">    LOG &quot;make kernel begin...&quot;</span><br><span class="line">    make ARCH=arm64 -j$(nproc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build_rk3588-kernel() &#123;</span><br><span class="line">    cd $workdir/kernel</span><br><span class="line">    make ARCH=arm64 openeuler_rk3588_defconfig</span><br><span class="line">    LOG &quot;make kernel begin...&quot;</span><br><span class="line">    make ARCH=arm64 -j$(nproc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="安装内核"><a class="markdownIt-Anchor" href="#安装内核"></a> 安装内核</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">install_kernel() &#123;</span><br><span class="line">    if [ ! -f $workdir/kernel/arch/arm64/boot/Image ]; then</span><br><span class="line">        ERROR &quot;kernel Image can not be found!&quot;</span><br><span class="line">        exit 2</span><br><span class="line">    else</span><br><span class="line">        LOG &quot;make kernel done.&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ -d $workdir/kernel/kernel-modules ];then rm -rf $workdir/kernel/kernel-modules; fi</span><br><span class="line">    if [ -d $&#123;boot_dir&#125; ];then rm -rf $&#123;boot_dir&#125;; fi</span><br><span class="line">    mkdir -p $&#123;boot_dir&#125;</span><br><span class="line">    mkdir -p $workdir/kernel/kernel-modules</span><br><span class="line">    cd $workdir/kernel</span><br><span class="line">    make ARCH=arm64 install INSTALL_PATH=$&#123;boot_dir&#125;</span><br><span class="line">    make ARCH=arm64 modules_install INSTALL_MOD_PATH=$workdir/kernel/kernel-modules</span><br><span class="line">    LOG &quot;device tree name is $&#123;dtb_name&#125;.dtb&quot;</span><br><span class="line">    cp arch/arm64/boot/dts/rockchip/$&#123;dtb_name&#125;.dtb $&#123;boot_dir&#125;</span><br><span class="line">    LOG &quot;prepare kernel done.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="构建boot分区"><a class="markdownIt-Anchor" href="#构建boot分区"></a> 构建boot分区</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mk_boot() &#123;</span><br><span class="line">    LOG &quot;start make bootimg...&quot;</span><br><span class="line">    mkdir -p $&#123;boot_dir&#125;/extlinux</span><br><span class="line"></span><br><span class="line">    LOG &quot;start gen initrd...&quot;</span><br><span class="line">    dracut --no-kernel $&#123;boot_dir&#125;/initrd.img</span><br><span class="line">    LOG &quot;gen initrd donw.&quot;</span><br><span class="line"></span><br><span class="line">    kernel_name=$(ls $boot_dir | grep vmlinu)</span><br><span class="line">    dtb_name=$(ls $boot_dir | grep dtb)</span><br><span class="line">    LOG &quot;gen extlinux config for $dtb_name&quot;</span><br><span class="line">    echo &quot;label openEuler</span><br><span class="line">    kernel /$&#123;kernel_name&#125;</span><br><span class="line">    initrd /initrd.img</span><br><span class="line">    fdt /$&#123;dtb_name&#125;</span><br><span class="line">    append  earlyprintk console=ttyS2,1500000 rw root=UUID=614e0000-0000-4b53-8000-1d28000054a9 rootfstype=ext4 init=/sbin/init rootwait&quot; \</span><br><span class="line">    &gt; $&#123;boot_dir&#125;/extlinux/extlinux.conf</span><br><span class="line"></span><br><span class="line">    LOG &quot;gen extlinux config done.&quot;</span><br><span class="line"></span><br><span class="line">    dd if=/dev/zero of=$workdir/boot.img bs=1M count=240 status=progress</span><br><span class="line">    mkfs.vfat -n boot $workdir/boot.img</span><br><span class="line">    if [ -d $workdir/boot_emmc ];then rm -rf $workdir/boot_emmc; fi</span><br><span class="line">    mkdir $workdir/boot_emmc</span><br><span class="line">    mount $workdir/boot.img $workdir/boot_emmc/</span><br><span class="line">    cp -r $&#123;boot_dir&#125;/* $workdir/boot_emmc/</span><br><span class="line">    umount $workdir/boot.img</span><br><span class="line">    rmdir $workdir/boot_emmc</span><br><span class="line"></span><br><span class="line">    if [ -f $workdir/boot.img ]; then</span><br><span class="line">        LOG &quot;make boot image done.&quot;</span><br><span class="line">    else</span><br><span class="line">        ERROR &quot;make boot image failed!&quot;</span><br><span class="line">        exit 2</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    LOG &quot;clean boot directory.&quot;</span><br><span class="line">    rm -rf $&#123;boot_dir&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="main-3"><a class="markdownIt-Anchor" href="#main-3"></a> main</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认参数和本地参数</span></span><br><span class="line">default_param</span><br><span class="line">local_param</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析命令行参数, 如果出错则打印帮助信息</span></span><br><span class="line">parseargs &quot;$@&quot; || help $?</span><br><span class="line">set -e # 如果任何命令失败, 立即退出脚本</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查工作目录是否存在, 如果不存在则创建</span></span><br><span class="line">if [ ! -d $workdir ]; then</span><br><span class="line">    mkdir $workdir</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查日志目录是否存在, 如果不存在则创建</span></span><br><span class="line">if [ ! -d $&#123;log_dir&#125; ];then mkdir -p $&#123;log_dir&#125;; fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个空的 .<span class="keyword">done</span> 文件, 用于标记构建状态</span></span><br><span class="line">if [ ! -f $workdir/.done ];then</span><br><span class="line">    touch $workdir/.done</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 .<span class="keyword">done</span> 文件中删除 <span class="string">&quot;bootimg&quot;</span> 字符串 (如果存在)</span></span><br><span class="line">sed -i &#x27;s/bootimg//g&#x27; $workdir/.done</span><br><span class="line">LOG &quot;build boot...&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">克隆并检查内核源码</span></span><br><span class="line">clone_and_check_kernel_source</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查内核和 DTB 文件是否已经构建</span></span><br><span class="line">if [[ -f $workdir/kernel/arch/arm64/boot/dts/rockchip/$&#123;dtb_name&#125;.dtb &amp;&amp; -f $workdir/kernel/arch/arm64/boot/Image ]];then</span><br><span class="line">    LOG &quot;kernel is the latest&quot;</span><br><span class="line">else</span><br><span class="line">    # 根据不同的分支构建不同版本的内核</span><br><span class="line">    if [ &quot;$&#123;branch:0:15&#125;&quot; == &quot;openEuler-20.03-LTS&quot; ];then # 包括: openEuler-20.03-LTS*</span><br><span class="line">        build_4.19-kernel</span><br><span class="line">    elif [ &quot;$&#123;branch:0:15&#125;&quot; == &quot;openEuler-22.03-LTS&quot; ]; then # 包括: openEuler-22.03-LTS*</span><br><span class="line">        build_5.10-kernel</span><br><span class="line">    elif [ &quot;$&#123;branch:0:15&#125;&quot; == &quot;openEuler-24.03-LTS&quot; ]; then # 包括: openEuler-24.03-LTS*</span><br><span class="line">        build_6.6-kernel</span><br><span class="line">    elif [ &quot;$&#123;branch&#125;&quot; == &quot;openEuler-22.03-LTS-RK3588&quot; ]; then</span><br><span class="line">        build_rk3588-kernel</span><br><span class="line">    else</span><br><span class="line">        echo &quot;Unsupported version.&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查 boot.img 是否已经构建</span></span><br><span class="line">if [[ -f $workdir/boot.img &amp;&amp; $(cat $workdir/.done | grep bootimg) == &quot;bootimg&quot; ]];then</span><br><span class="line">    LOG &quot;boot is the latest&quot;</span><br><span class="line">else</span><br><span class="line">    # 设置清理函数, 在脚本退出时执行</span><br><span class="line">    trap &#x27;LOSETUP_D_IMG&#x27; EXIT</span><br><span class="line">    LOSETUP_D_IMG</span><br><span class="line">    # 安装内核并生成 boot.img</span><br><span class="line">    install_kernel</span><br><span class="line">    mk_boot</span><br><span class="line">fi</span><br><span class="line">LOG &quot;The boot.img is generated in the $&#123;workdir&#125;.&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 .<span class="keyword">done</span> 文件中记录 <span class="string">&quot;bootimg&quot;</span> 标记</span></span><br><span class="line">echo &quot;bootimg&quot; &gt;&gt; $workdir/.done</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitee.com/openeuler/rockchip.git</span><br><span class="line">sudo docker run -t -i --privileged -v /dev/bus/usb:/dev/bus/usb -v /home/topeet/03_rockchip:/examples openeuler-23.09:latest /bin/bash</span><br><span class="line">dnf makecache</span><br><span class="line">dnf install git wget make gcc bison dtc m4 flex bc openssl-devel tar dosfstools rsync parted dnf-plugins-core tar</span><br><span class="line">dnf install git wget rsync make gcc dracut</span><br><span class="line">bash build_boot.sh -k https://gitee.com/openeuler/rockchip-kernel.git -b openEuler-22.03-LTS-RK3588 -d rk3588s-roc-pc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/home/topeet/03_rockchip/01_rk3588/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make -C kernel/ -j17 CROSS_COMPILE=/home/topeet/03_rockchip/01_rk3588/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64 rockchip_linux_defconfig rk3588_linux.config</span><br><span class="line"></span><br><span class="line">make -C kernel/ -j17 CROSS_COMPILE=/home/topeet/03_rockchip/01_rk3588/rk3588-linux/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu- ARCH=arm64 topeet-rk3588-linux.img</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -o loop,offset=$((32768*512))  ubuntu22.img    tmp</span><br><span class="line"></span><br><span class="line">label openEuler</span><br><span class="line">    kernel /boot/vmlinuz-5.10.0</span><br><span class="line">    initrd /boot/initrd.img</span><br><span class="line">    fdt /boot/topeet-rk3588-linux.dtb</span><br><span class="line">    append  earlyprintk console=ttyS2,115200 rw root=/dev/mmcblk0p1 rootfstype=ext4 init=/sbin/init rootwait</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.openeuler.org/openEuler-23.09/docker_img/aarch64/openEuler-docker.aarch64.tar.xz</span><br><span class="line">sudo docker load -i openEuler-docker.aarch64.tar.xz</span><br><span class="line">sudo docker run -t -i --privileged -v /dev/bus/usb:/dev/bus/usb -v /home/topeet/03_rockchip:/examples openeuler-23.09:latest /bin/bash</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dnf install git wget make gcc bison dtc m4 flex bc openssl-devel tar dosfstools rsync parted dnf-plugins-core tar  makecache</span><br><span class="line">WORKDIR=$(pwd)/build</span><br><span class="line">mkdir $WORKDIR</span><br><span class="line">cd $WORKDIR</span><br><span class="line">mkdir rootfs</span><br><span class="line">mkdir -p rootfs/var/lib/rpm</span><br><span class="line">rpm --root  $WORKDIR/rootfs/ --initdb</span><br><span class="line">rpm -ivh --nodeps --root $WORKDIR/rootfs/ https://repo.openeuler.org/openEuler-24.03-LTS/everything/aarch64/Packages/openEuler-release-24.03LTS-55.oe2403.aarch64.rpm</span><br><span class="line"></span><br><span class="line">mkdir $WORKDIR/rootfs/etc/yum.repos.d</span><br><span class="line">curl -o $WORKDIR/rootfs/etc/yum.repos.d/openEuler-24.03-LTS.repo https://gitee.com/src-openeuler/openEuler-repos/raw/openEuler-24.03-LTS/generic.repo</span><br><span class="line"></span><br><span class="line">dnf --installroot=$WORKDIR/rootfs/ install dnf --nogpgcheck -y</span><br><span class="line">dnf --installroot=$WORKDIR/rootfs/ makecache</span><br><span class="line">dnf --installroot=$WORKDIR/rootfs/ install -y alsa-utils wpa_supplicant vim net-tools iproute iputils NetworkManager openssh-server passwd hostname ntp bluez pulseaudio-module-bluetooth</span><br></pre></td></tr></table></figure>
<p>设置dns</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp -L /etc/resolv.conf $&#123;WORKDIR&#125;/rootfs/etc/resolv.conf</span><br><span class="line">vim $WORKDIR/rootfs/etc/resolv.conf</span><br><span class="line"></span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 114.114.114.114</span><br></pre></td></tr></table></figure>
<p>设置 NTP 服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/#NTP=/NTP=0.cn.pool.ntp.org/g&#x27; $WORKDIR/rootfs/etc/systemd/timesyncd.conf</span><br><span class="line">sed -i &#x27;s/#FallbackNTP=/FallbackNTP=1.asia.pool.ntp.org 2.asia.pool.ntp.org/g&#x27; $WORKDIR/rootfs/etc/systemd/timesyncd.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">dnf --installroot=$WORKDIR/rootfs/ install -y  \</span><br><span class="line">    dnf \</span><br><span class="line">    yum \</span><br><span class="line">    alsa-utils \</span><br><span class="line">    haveged \</span><br><span class="line">    wpa_supplicant \</span><br><span class="line">    vim \</span><br><span class="line">    net-tools \</span><br><span class="line">    iproute \</span><br><span class="line">    iputils \</span><br><span class="line">    NetworkManager \</span><br><span class="line">    openssh-server \</span><br><span class="line">    openssh-clients \</span><br><span class="line">    passwd \</span><br><span class="line">    hostname \</span><br><span class="line">    bluez \</span><br><span class="line">    pulseaudio-module-bluetooth \</span><br><span class="line">    parted \</span><br><span class="line">    gdisk \</span><br><span class="line">    ntp \</span><br><span class="line">    dejavu-fonts \</span><br><span class="line">    liberation-fonts \</span><br><span class="line">    xorg-x11-server-Xorg \</span><br><span class="line">    xorg-x11-xinit \</span><br><span class="line">    xorg-x11-drivers \</span><br><span class="line">    xfwm4 \</span><br><span class="line">    xfdesktop \</span><br><span class="line">    xfce4-appfinder \</span><br><span class="line">    xfce4-panel \</span><br><span class="line">    xfce4-session \</span><br><span class="line">    xfce4-settings \</span><br><span class="line">    xfce4-terminal \</span><br><span class="line">    xfce4-notifyd \</span><br><span class="line">    network-manager-applet \</span><br><span class="line">    lightdm \</span><br><span class="line">    lightdm-gtk-greeter \</span><br><span class="line">    bc \</span><br><span class="line">    systemd-timesyncd \</span><br><span class="line">    openEuler-repos</span><br></pre></td></tr></table></figure>
<h1 id="工作记录星期五"><a class="markdownIt-Anchor" href="#工作记录星期五"></a> 工作记录(星期五)</h1>
<p>==懂得了很多道理，依然过不好这一生==</p>
<p>==摆脱一份幻觉，比发现一个真理更能使人明智==</p>
<hr />
<p>昨天晚上就还行吧，声音外放也确实是个很好的方法，但我要因为这个而去买一个音响吗，这件事情需要思考一下，感觉不需要，但如果使用小爱同学反而有点芥蒂，不是吗。画个六七十解决这个问题，也还行吧，我认为很值。</p>
<p>然后在昨天晚上的时候研究了一下uboot的启动流程，我的本意是想要学习extlinux 这些都是如何加载的，但是就目前这种情况来看的话，好像只能先看看怎样使用他了，目前看来的话，这个欧拉系统，搞定扩容、搞定蓝牙和WIFI就行了，其他倒也无所谓了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install iw blueman net-tools wireless-tools rfkill wireless-regdb </span><br></pre></td></tr></table></figure>
<hr />
<hr />
<p>欧拉系统的镜像就先搞到这里，接下来我其实是想要搞一下mpp、v4l2以及rga，</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/07/01/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/19_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC1%E4%B8%AA%E6%98%9F%E6%9C%9F)/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/07/02/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/20_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC2%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            工作记录((7月第2个星期)
          
        </div>
      </a>
    
    
      <a href="/2024/06/25/03_Linux%E5%AD%A6%E4%B9%A0/3%20%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%85%A5%E9%97%A8%E7%AF%87/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">嵌入式Linux入门篇</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> chai
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="热爱学习的未来酱"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%94%9F%E6%B4%BB">生活</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE">瑞芯微</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/Linux%E5%AD%A6%E4%B9%A0">Linux学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E8%AF%BB%E4%B9%A6">读书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0">C语言高级学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95">工作记录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7">小技巧</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/shell%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0">shell编程学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/PCB%E5%AD%A6%E4%B9%A0">PCB学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0">音视频学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=22707008&auto=0&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>