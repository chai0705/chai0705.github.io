<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="永远年轻，永远热泪盈眶" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>工作记录((7月第2个星期) |  热爱学习的未来酱</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="热爱学习的未来酱" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-06_工作记录/20_工作记录(七月第2个星期)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  工作记录((7月第2个星期)
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/07/02/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/20_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC2%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-date">
  <time datetime="2024-07-02T13:26:56.000Z" itemprop="datePublished">2024-07-02</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">61.1k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">353 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="buildroot-用户手册"><a class="markdownIt-Anchor" href="#buildroot-用户手册"></a> Buildroot 用户手册</h1>
<h1 id="part-i-入门"><a class="markdownIt-Anchor" href="#part-i-入门"></a> Part I. 入门</h1>
<h2 id="第1章-关于-buildroot"><a class="markdownIt-Anchor" href="#第1章-关于-buildroot"></a> 第1章. 关于 Buildroot</h2>
<p>Buildroot 是一个工具,它简化并自动化了为嵌入式系统构建完整 Linux 系统的过程,使用交叉编译。</p>
<p>为了实现这一目标,Buildroot 能够生成交叉编译工具链、根文件系统、Linux 内核镜像和目标系统的引导加载程序。Buildroot 可以独立地使用这些选项的任何组合(例如,您可以使用现有的交叉编译工具链,并仅使用 Buildroot 构建根文件系统)。</p>
<p>Buildroot 主要对从事嵌入式系统工作的人员有用。嵌入式系统通常使用不是大家在PC上常见的x86处理器,而是PowerPC、MIPS、ARM等处理器。</p>
<p>Buildroot 支持众多处理器及其变体;它还附带了几个现成硬件板卡的默认配置。除此之外,还有许多第三方项目基于 Buildroot 构建或开发了自己的 BSP [<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ftn.idm25">1]</a> 或 SDK [<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ftn.idm27">2]</a>。</p>
<hr />
<p>[<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#idm25">1] </a>BSP: 板级支持包</p>
<p>[<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#idm27">2] </a>SDK: 软件开发工具包</p>
<h2 id="第2章-系统需求"><a class="markdownIt-Anchor" href="#第2章-系统需求"></a> 第2章. 系统需求</h2>
<p>Buildroot 设计用于在 Linux 系统上运行。</p>
<p>虽然 Buildroot 本身会构建大部分编译所需的主机软件包,但是主机系统上预期已安装了某些标准的 Linux 工具。以下是必需和可选软件包的概述(请注意,软件包名称可能因发行版而异):</p>
<h3 id="21-必需的软件包"><a class="markdownIt-Anchor" href="#21-必需的软件包"></a> 2.1. 必需的软件包</h3>
<ul>
<li>构建工具:
<ul>
<li><code>which</code></li>
<li><code>sed</code></li>
<li><code>make</code>（版本3.81或更高）</li>
<li><code>binutils</code></li>
<li><code>build-essential</code>（仅适用于基于Debian的系统）</li>
<li><code>diffutils</code></li>
<li><code>gcc</code>（版本4.8或更高）</li>
<li><code>g++</code>（版本4.8或更高）</li>
<li><code>bash</code></li>
<li><code>patch</code></li>
<li><code>gzip</code></li>
<li><code>bzip2</code></li>
<li><code>perl</code>（版本5.8.7或更高）</li>
<li><code>tar</code></li>
<li><code>cpio</code></li>
<li><code>unzip</code></li>
<li><code>rsync</code></li>
<li><code>file</code>（必须位于 <code>/usr/bin/file</code>）</li>
<li><code>bc</code></li>
<li><code>findutils</code></li>
</ul>
</li>
<li>源码获取工具:
<ul>
<li><code>wget</code></li>
</ul>
</li>
</ul>
<h3 id="22-可选包"><a class="markdownIt-Anchor" href="#22-可选包"></a> 2.2. 可选包</h3>
<ul>
<li>建议依赖:
<ul>
<li>Buildroot 中的一些功能或实用程序,如 legal-info 或图形生成工具,有额外的依赖项。虽然它们对于简单构建并不是必需的,但仍然是高度推荐的:
<ul>
<li><code>python</code>（2.7 版本或任何更高版本）</li>
</ul>
</li>
</ul>
</li>
<li>配置界面依赖:
<ul>
<li>对于这些库,您需要同时安装运行时和开发数据,这在许多发行版中是分开打包的。开发包通常具有-dev或-devel后缀。
<ul>
<li><code>ncurses5</code> 用于使用 <code>menuconfig</code> 界面</li>
<li><code>qt5</code> 用于使用 <code>xconfig</code> 界面</li>
<li><code>glib2</code>、<code>gtk2</code> 和 <code>glade2</code> 用于使用 <code>gconfig</code> 界面</li>
</ul>
</li>
</ul>
</li>
<li>源码获取工具:
<ul>
<li>在官方代码树中,大多数软件包源代码是使用wget从ftp、http或https位置检索的。但也有少数软件包只通过版本控制系统提供。此外,Buildroot 还能够通过其他工具(如git或scp)下载源码(详见第 20 章&quot;下载基础设施&quot;)。如果您启用了使用这些方法的软件包,您将需要在主机系统上安装相应的工具:
<ul>
<li><code>bazaar</code></li>
<li><code>cvs</code></li>
<li><code>git</code></li>
<li><code>mercurial</code></li>
<li><code>scp</code></li>
<li><code>sftp</code></li>
<li><code>subversion</code></li>
</ul>
</li>
</ul>
</li>
<li>Java 相关软件包,如果需要为目标系统构建 Java 类路径:
<ul>
<li><code>javac</code> 编译器</li>
<li><code>jar</code> 工具</li>
</ul>
</li>
<li>文档生成工具:
<ul>
<li><code>asciidoc</code>，版本 8.6.3 或更高</li>
<li><code>w3m</code></li>
<li>带有 <code>argparse</code> 模块的 <code>python</code>（在 2.7+ 和 3.2+ 中自动存在）</li>
<li><code>dblatex</code>（仅针对 PDF 手册）</li>
</ul>
</li>
<li>图形生成工具:
<ul>
<li><code>graphviz</code> 用于 <code>graph-depends</code> 和 <code>&lt;pkg&gt;-graph-depends</code></li>
<li><code>python-matplotlib</code> 用于 <code>graph-build</code></li>
</ul>
</li>
<li>软件包统计工具 (<code>pkg-stats</code>):
<ul>
<li><code>python-aiohttp</code></li>
</ul>
</li>
</ul>
<h2 id="第3章-获取buildroot"><a class="markdownIt-Anchor" href="#第3章-获取buildroot"></a> 第3章. 获取Buildroot</h2>
<p>Buildroot的发行版每3个月发布一次,分别在2月、5月、8月和11月。版本号采用YYYY.MM的格式,例如2013.02、2014.08。</p>
<p>发行版tar包可以在<a target="_blank" rel="noopener" href="http://buildroot.org/downloads/%E4%B8%8B%E8%BD%BD%E8%8E%B7%E5%BE%97%E3%80%82">http://buildroot.org/downloads/下载获得。</a></p>
<p>为了方便起见,Buildroot源码树中的<code>support/misc/Vagrantfile</code>提供了一个<a target="_blank" rel="noopener" href="https://www.vagrantup.com/">Vagrantfile</a>文件,可以快速设置一个带有所需依赖项的虚拟机环境来开始使用。</p>
<p>如果您想在Linux或Mac OS X上设置一个隔离的Buildroot环境,可以在终端上粘贴以下命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://buildroot.org/downloads/Vagrantfile; vagrant up</span><br></pre></td></tr></table></figure>
<p>如果您在Windows上,可以在PowerShell中粘贴以下命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(new-object System.Net.WebClient).DownloadFile(</span><br><span class="line">&quot;https://buildroot.org/downloads/Vagrantfile&quot;,&quot;Vagrantfile&quot;);</span><br><span class="line">vagrant up</span><br></pre></td></tr></table></figure>
<p>如果您想跟踪开发进度,可以使用每日快照或克隆Git仓库。请参考Buildroot网站的<a target="_blank" rel="noopener" href="http://buildroot.org/download">下载页面</a>了解更多详细信息。</p>
<h2 id="第4章-buildroot快速入门"><a class="markdownIt-Anchor" href="#第4章-buildroot快速入门"></a> 第4章. Buildroot快速入门</h2>
<p><em><em><strong>重要提示*</strong></em>:您可以并且应该</em><em><strong>以普通用户的身份构建一切</strong></em>*。无需成为root用户即可配置和使用Buildroot。以常规用户运行所有命令可以防止包在编译和安装过程中出现行为不当的情况。</p>
<p>使用Buildroot的第一步是创建一个配置。Buildroot提供了一个类似于<a target="_blank" rel="noopener" href="http://www.kernel.org/">Linux内核</a>或<a target="_blank" rel="noopener" href="http://www.busybox.net/">BusyBox</a>中可以找到的配置工具。</p>
<p>从Buildroot目录运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make menuconfig</span></span><br></pre></td></tr></table></figure>
<p>以使用原始的基于文字界面的配置工具,或运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make nconfig</span></span><br></pre></td></tr></table></figure>
<p>以使用新的基于文字界面的配置工具,或运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make xconfig</span></span><br></pre></td></tr></table></figure>
<p>以使用基于Qt的配置工具,或运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make gconfig</span></span><br></pre></td></tr></table></figure>
<p>以使用基于GTK的配置工具。</p>
<p>所有这些&quot;make&quot;命令都需要构建配置实用程序(包括界面),因此您可能需要安装相关库的&quot;开发&quot;软件包。请参考<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#requirement">第2章,<em>系统要求</em></a>了解更多详细信息,特别是<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#requirement-optional">可选要求</a>部分以获取您最喜欢的界面所需的依赖项。</p>
<p>对于配置工具中的每个菜单项,您都可以找到相关的帮助,描述了该项的用途。请参考<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#configure">第6章, <em>Buildroot配置</em></a>了解一些具体的配置方面的详细信息。</p>
<p>一旦所有内容都配置好,配置工具就会生成一个<code>.config</code>文件,其中包含了整个配置信息。这个文件将被顶层的Makefile读取。</p>
<p>要启动构建过程,只需运行:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>
<p>默认情况下,Buildroot不支持顶层并行构建,所以运行<code>make -jN</code>是不必要的。但是,它确实有实验性的顶层并行构建支持,请参见<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#top-level-parallel-build">第8.12节,“顶层并行构建”</a>。</p>
<p><code>make</code>命令通常会执行以下步骤:</p>
<ul>
<li>下载所需的源文件;</li>
<li>配置、构建并安装交叉编译工具链,或简单地导入一个外部工具链;</li>
<li>配置、构建并安装所选的目标包;</li>
<li>如果被选择,构建一个内核映像;</li>
<li>如果被选择,构建一个引导程序映像;</li>
<li>创建所选格式的根文件系统映像。</li>
</ul>
<p>Buildroot的输出存储在单个目录<code>output/</code>中。该目录包含以下几个子目录:</p>
<ul>
<li><code>images/</code>是存储所有映像(内核映像、引导程序和根文件系统映像)的地方。这些就是您需要放在目标系统上的文件。</li>
<li><code>build/</code>是所有组件被构建的地方(包括Buildroot在主机上需要的工具,以及为目标编译的包)。该目录包含这些组件的一个子目录。</li>
<li><code>host/</code>包含为主机构建的工具,以及目标工具链的sysroot。前者是为主机编译的工具的安装,这些工具对Buildroot的正确执行是必需的,包括交叉编译工具链。后者是一个类似于根文件系统层次结构的层次结构。它包含所有提供并安装库的用户空间包的头文件和库。但是,这个目录<em>不打算</em>作为目标的根文件系统:它包含了大量的开发文件、未剥离的二进制文件和库,这使它对嵌入式系统来说太大了。这些开发文件用于为目标编译依赖于其他库的库和应用程序。</li>
<li><code>staging/</code>是指向目标工具链sysroot的<code>host/</code>内的符号链接,它存在是为了向后兼容。</li>
<li><code>target/</code>包含<em>几乎</em>完整的目标根文件系统:需要的一切都在那里,除了<code>/dev/</code>中的设备文件(Buildroot无法创建它们,因为Buildroot不以root身份运行,也不想以root身份运行)。此外,它没有正确的权限(例如busybox二进制文件的setuid)。因此,这个目录<strong><strong>不应该在您的目标上使用</strong></strong>。相反,您应该使用<code>images/</code>目录中构建的映像之一。如果您需要一个已提取的根文件系统映像来通过NFS引导,那么请使用<code>images/</code>中生成的tar包映像并以root身份提取它。与<code>staging/</code>相比,<code>target/</code>只包含运行所选目标应用程序所需的文件和库:开发文件(头文件等)不存在,二进制文件已经被剥离。</li>
</ul>
<p>这些命令<code>make menuconfig|nconfig|gconfig|xconfig</code>和<code>make</code>是允许您轻松快速地生成符合您需求的映像的基本命令,包括您启用的所有功能和应用程序。</p>
<p>关于&quot;make&quot;命令使用的更多细节,请参见<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#make-tips">第8.1节,“<em>make</em>技巧”</a>。</p>
<h2 id="第-5-章-社区资源"><a class="markdownIt-Anchor" href="#第-5-章-社区资源"></a> 第 5 章. 社区资源</h2>
<p>和任何开源项目一样,Buildroot 也有不同的方式来在社区内外分享信息。</p>
<p>如果您正在寻求帮助、想了解 Buildroot 或为项目贡献,这些方式都可能会对您有兴趣。</p>
<ul>
<li>
<p>邮件列表</p>
<p>Buildroot 有一个用于讨论和开发的邮件列表。这是 Buildroot 用户和开发者主要的交流方式。</p>
<p>只有 Buildroot 邮件列表的订阅者才被允许向该列表发帖。您可以通过<a target="_blank" rel="noopener" href="http://lists.buildroot.org/mailman/listinfo/buildroot">邮件列表信息页面</a>订阅。</p>
<p>发送到邮件列表的邮件也可以在<a target="_blank" rel="noopener" href="http://lists.buildroot.org/pipermail/buildroot">Mailman 邮件列表归档</a>或 <a target="_blank" rel="noopener" href="https://lore.kernel.org/buildroot/">lore.kernel.org</a> 上找到。</p>
</li>
<li>
<p>IRC</p>
<p>Buildroot IRC 频道 [#buildroot](javascript:void(0)) 托管在 <a target="_blank" rel="noopener" href="https://www.oftc.net/WebChat/">OFTC</a> 上。这是提问或讨论某些话题的一个有用地方。</p>
<p>在 IRC 上寻求帮助时,请使用代码共享网站(如 <a target="_blank" rel="noopener" href="https://paste.ack.tf/.Note">https://paste.ack.tf/.Note</a>)分享相关日志或代码片段。</p>
<p>对于某些问题,在邮件列表上发帖可能更好,因为它会触及更多开发者和用户。</p>
</li>
<li>
<p>缺陷跟踪器</p>
<p>Buildroot 的缺陷可以通过邮件列表或 <a target="_blank" rel="noopener" href="https://bugs.buildroot.org/buglist.cgi?product=buildroot">Buildroot 缺陷跟踪器</a>进行报告。在创建缺陷报告之前,请参考<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#reporting-bugs">第 22.6 节,“报告问题/缺陷或获得帮助”</a>。</p>
</li>
<li>
<p>Wiki</p>
<p><a target="_blank" rel="noopener" href="http://elinux.org/Buildroot">Buildroot wiki 页面</a>托管在 <a target="_blank" rel="noopener" href="http://elinux.org/">eLinux</a> wiki 上。它包含一些有用的链接、过去和即将到来的事件概述以及待办事项列表。</p>
</li>
<li>
<p>Patchwork</p>
<p>Patchwork 是一个基于 Web 的补丁跟踪系统,旨在促进对开源项目的贡献和管理。发送到邮件列表的补丁被系统&quot;捕获&quot;,并出现在网页上。对补丁的任何评论也会附加到补丁页面。</p>
<p>有关 Patchwork 的更多信息,请参见 <a target="_blank" rel="noopener" href="http://jk.ozlabs.org/projects/patchwork/%E3%80%82">http://jk.ozlabs.org/projects/patchwork/。</a></p>
<p>Buildroot 的 Patchwork 网站主要供 Buildroot 维护者使用,以确保补丁不会被遗漏。它也被 Buildroot 补丁审查者使用(参见<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#apply-patches-patchwork">第 22.3.1 节,“从 Patchwork 应用补丁”</a>)。</p>
<p>但是,由于该网站以干净简洁的 Web 界面公开了补丁及其相应的审查意见,因此对所有 Buildroot 开发者也可能很有用。</p>
<p>Buildroot 补丁管理界面可在 <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/buildroot/list/">https://patchwork.ozlabs.org/project/buildroot/list/</a> 访问。</p>
</li>
</ul>
<h1 id="part-ii-用户指南"><a class="markdownIt-Anchor" href="#part-ii-用户指南"></a> Part II. 用户指南</h1>
<h2 id="第6章buildroot配置"><a class="markdownIt-Anchor" href="#第6章buildroot配置"></a> 第6章Buildroot配置</h2>
<p>所有*config`中的配置选项都有一个帮助文本，提供有关该选项的详细信息。</p>
<p>make *config 命令还提供了一个搜索工具。阅读不同前端菜单中的帮助消息，了解如何使用:</p>
<ul>
<li>在 <em>menuconfig</em> 中，通过按下/来调用搜索工具;</li>
<li>在 <em>xconfig</em> 中，通过按下Ctrl + f来调用搜索工具。</li>
</ul>
<p>搜索的结果显示与匹配项相关的帮助消息。在<em>menuconfig</em>中，左列的数字为对应条目提供了快捷方式。只需键入这个数字就可以直接跳转到该条目，或者跳转到对应菜单（如果由于缺少依赖关系导致无法选择条目时）。</p>
<p>尽管菜单结构和条目的帮助文本应该是足够自解释的，但有一些主题需要额外的解释，在帮助文本中很难涵盖，因此在下面的章节中进行了解释。</p>
<h2 id="61-交叉编译工具链"><a class="markdownIt-Anchor" href="#61-交叉编译工具链"></a> 6.1. 交叉编译工具链</h2>
<p>编译工具链是一组工具，允许您为您的系统编译代码。它包括一个编译器（在我们的情况下是gcc），像汇编程序和链接器这样的二进制工具（在我们的情况下是binutils），以及一个C标准库（例如<a target="_blank" rel="noopener" href="http://www.gnu.org/software/libc/libc.html">GNU Libc</a>，<a target="_blank" rel="noopener" href="http://www.uclibc-ng.org/">uClibc-ng</a>）。</p>
<p>安装在开发站上的系统肯定已经有一个编译工具链，您可以使用它来为在您的系统上运行的应用程序进行编译。如果您正在使用的是PC，则您的编译工具链在x86处理器上运行，并为x86处理器生成代码。在大多数Linux系统下，编译工具链使用GNU libc（glibc）作为C标准库。这个编译工具链被称为“主机编译工具链”。它正在运行的机器，以及你正在工作的机器，称为“主机系统”[<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ftn.idm375">3]</a>。</p>
<p>编译工具链由您的发行版提供，Buildroot与它无关（除了使用它来构建交叉编译工具链和在开发主机上运行的其他工具）。</p>
<p>如上所述，随系统提供的编译工具链在您的主机系统上运行，并为您的目标系统（和目标处理器）生成代码。例如，如果您的主机系统使用x86处理器，并且您的目标系统使用ARM，那么主机上的常规编译工具链在x86上运行，并为x86生成代码，而交叉编译工具链在x86上运行并为ARM生成代码。</p>
<p>Buildroot为交叉编译工具链提供了两个解决方案：</p>
<ul>
<li><strong>内部工具链后端</strong>，在配置界面中称为Buildroot工具链。</li>
<li><strong>外部工具链后端</strong>，在配置界面中称为外部工具链。</li>
</ul>
<p>在工具链菜单中选择一个解决方案后，将出现一系列配置选项，这些选项在下面的各个部分中详细介绍。</p>
<h3 id="611-内部工具链后端"><a class="markdownIt-Anchor" href="#611-内部工具链后端"></a> 6.1.1. 内部工具链后端</h3>
<p><strong>内部工具链后端</strong>是在构建用于目标嵌入式系统的用户空间应用程序和库之前，Buildroot自行构建的交叉编译工具链的后端。</p>
<p>此后端支持几种C库：<a target="_blank" rel="noopener" href="http://www.uclibc-ng.org/">uClibc-ng</a>，<a target="_blank" rel="noopener" href="http://www.gnu.org/software/libc/libc.html">glibc</a>和<a target="_blank" rel="noopener" href="http://www.musl-libc.org/">musl</a>。</p>
<p>选择此后端后，将出现一些选项。最重要的选项允许：</p>
<ul>
<li>更改用于构建工具链的Linux内核头文件的版本。此项目值得一些解释。在构建交叉编译工具链的过程中，正在构建C库。此库提供了用户空间应用程序与Linux内核之间的接口。为了知道如何与Linux内核“通信”，C库需要访问Linux内核头文件（即内核中的 .h文件），这些文件定义了用户空间和内核之间的接口（系统调用、数据结构等）。由于此接口向后兼容，所以用于构建工具链的Linux内核头文件的版本不需要与您打算在嵌入式系统上运行的Linux内核的版本<em>完全</em>匹配。它们只需要具有版本等于或早于您打算在嵌入式系统上运行的Linux内核版本。如果您使用的内核头文件比您运行在嵌入式系统上的Linux内核更近，那么C库可能正在使用您的Linux内核所不支持的接口。</li>
<li>更改GCC编译器、binutils和C库的版本。</li>
<li>选择一些工具链选项（仅限于uClibc）：工具链是否应该具有RPC支持（主要用于NFS）、宽字符支持、区域设置支持（用于国际化）、C++支持或线程支持。取决于您选择的选项，Buildroot菜单中可见的用户空间应用程序和库的数量将发生变化：许多应用程序和库需要启用某些工具链选项才能启用这些软件包。大多数软件包在要求启用某些工具链选项时都会显示注释。如果需要，您可以通过运行 make uclibc-menuconfig 进一步优化uClibc配置。但请注意，Buildroot中的所有软件包都是针对Buildroot捆绑的默认uClibc配置进行测试的：如果您通过从uClibc中删除功能来偏离此配置，则有些软件包可能不再构建。</li>
</ul>
<p>值得注意的是，每当修改其中一个选项时，都必须重新构建整个工具链和系统。请参阅<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#full-rebuild">第8.2节，“了解何时需要进行全新构建”</a>。</p>
<p>此后端的优势：</p>
<ul>
<li>与Buildroot完全集成</li>
<li>快速，仅构建必要部分</li>
</ul>
<p>此后端的缺点：</p>
<ul>
<li>当执行 make clean 时需要重新构建工具链，这需要时间。如果您尝试减少构建时间，请考虑使用<strong>外部工具链后端</strong>。</li>
</ul>
<h3 id="612-外部工具链后端"><a class="markdownIt-Anchor" href="#612-外部工具链后端"></a> 6.1.2. 外部工具链后端</h3>
<p><strong>外部工具链后端</strong>允许使用现有的预构建交叉编译工具链。Buildroot已经知道一些知名的交叉编译工具链（来自<a target="_blank" rel="noopener" href="http://www.linaro.org/">Linaro</a>用于ARM，<a target="_blank" rel="noopener" href="http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/">Sourcery CodeBench</a> 用于ARM、x86-64、PowerPC 和 MIPS），并能够自动下载它们，或者可以指向一个自定义的工具链，可以是可下载的，也可以是本地安装的。</p>
<p>然后，有三种解决方案可以使用外部工具链：</p>
<ul>
<li>使用预定义的外部工具链配置文件，并让Buildroot下载、提取和安装工具链。Buildroot已经了解一些CodeSourcery和Linaro的工具链。只需从可用配置文件中的工具链中选择工具链配置文件。这绝对是最简单的解决办法。</li>
<li>使用预定义的外部工具链配置文件，但是，与其让Buildroot下载和提取工具链，不如告诉Buildroot您的工具链已经安装在系统上的某处。只需从可用工具链中的Toolchain中选择工具链配置文件，取消选择自动下载工具链，并在Toolchain path文本框中填写交叉编译工具链的路径。</li>
<li>使用完全自定义的外部工具链。这对于使用crosstool-NG生成的工具链或使用Buildroot本身生成的工具链特别有用。要做到这一点，可以在 工具链 列表中选择自定义工具链解决方案。您需要填写工具链路径、工具链前缀 和 外部工具链C库 选项。然后，您必须告诉Buildroot您的外部工具链支持什么。如果您的外部工具链使用<em>glibc</em>库，则只需告诉您的工具链是否支持C<ins>以及是否具有内置的RPC支持。如果您的外部工具链使用<em>uClibc</em>库，那么您必须告诉Buildroot它是否支持RPC、宽字符、区域设置、程序调用、线程和C</ins>。在执行开始时，Buildroot会告诉您选择的选项是否与工具链配置不匹配。</li>
</ul>
<p>我们的外部工具链支持已经通过Linaro生成的工具链，通过crosstool-NG生成的工具链，以及通过Buildroot本身生成的工具链进行了测试。一般来说，支持<em>sysroot</em>功能的所有工具链应该可以正常工作。如果不行，请不要犹豫联系开发人员。</p>
<p>我们不支持使用由OpenEmbedded或Yocto生成的工具链或SDK，因为这些工具链不是纯净的工具链（即仅包含编译器、binutils、C和C++库）。相反，这些工具链附带了大量的预编译库和程序。因此，Buildroot无法导入工具链的<em>sysroot</em>，因为它将包含数百兆字节的通过Buildroot通常构建的预编译库。</p>
<p>我们也不支持使用发行版工具链（即由您的发行版安装的gcc/binutils/C库）作为为目标系统构建软件的工具链。这是因为您的发行版工具链不是一个“纯洁”的工具链（即只包含C/C++库），因此我们无法将其正确地导入Buildroot构建环境。因此，即使您正在为x86或x86_64目标构建系统，也必须使用Buildroot或crosstool-NG生成交叉编译工具链。</p>
<p>如果您想为您的项目生成一个自定义工具链，可以在Buildroot中作为外部工具链使用，我们建议使用Buildroot自身构建它（请参见<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#build-toolchain-with-buildroot">第6.1.3节，“使用Buildroot构建外部工具链”</a>)，或者使用<a target="_blank" rel="noopener" href="http://crosstool-ng.org/">crosstool-NG</a>。</p>
<p>此后端的优势：</p>
<ul>
<li>允许使用知名且经过充分测试的交叉编译工具链。</li>
<li>避免了交叉编译工具链的构建时间，这在嵌入式Linux系统的整体构建时间中通常非常显著。</li>
</ul>
<p>此后端的缺点：</p>
<ul>
<li>如果您预先构建的外部工具链出现故障，可能很难从工具链供应商那里获得修复，除非使用Buildroot或Crosstool-NG自己构建外部工具链。</li>
</ul>
<h3 id="613-使用buildroot构建外部工具链"><a class="markdownIt-Anchor" href="#613-使用buildroot构建外部工具链"></a> 6.1.3. 使用Buildroot构建外部工具链</h3>
<p>Buildroot内部工具链选项可用于创建外部工具链。以下是建立内部工具链并将其打包以便供其他Buildroot项目重复使用的一系列步骤。</p>
<p>创建一个新的Buildroot配置，具有以下详细信息：</p>
<ul>
<li>为您的目标CPU架构选择适当的<em><strong>目标选项</strong></em></li>
<li>在<em><strong>工具链</strong></em>菜单中，保持<em><strong>Buildroot工具链</strong></em>作为<em><strong>工具链类型</strong></em>的默认设置，并按需要配置您的工具链</li>
<li>在<em><strong>系统配置</strong></em>菜单中，将<em><strong>初始系统</strong></em>选择为<em><strong>无</strong></em>，将*/bin/sh<em>选择为</em><strong>无</strong>*</li>
<li>在<em><strong>目标软件包</strong></em>菜单中，禁用<em><strong>BusyBox</strong></em></li>
<li>在<em><strong>文件系统映像</strong></em>菜单中，禁用<em><strong>对根文件系统进行打包</strong></em></li>
</ul>
<p>然后，我们可以触发构建，并要求Buildroot生成一个SDK。这将方便地为我们生成一个tarball，其中包含我们的工具链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make sdk</span><br></pre></td></tr></table></figure>
<p>这将在$(O)/images中生成SDK tarball，类似于arm-buildroot-linux-uclibcgnueabi_sdk-buildroot.tar.gz。保存这个tarball，因为现在它是您可以在其他Buildroot项目中重复使用的工具链。</p>
<p>在其他Buildroot项目中，在<em><strong>工具链</strong></em>菜单中：</p>
<ul>
<li>将<em><strong>工具链类型</strong></em>设置为<em><strong>外部工具链</strong></em></li>
<li>将<em><strong>工具链</strong></em>设置为<em><strong>自定义工具链</strong></em></li>
<li>将<em><strong>工具链源</strong></em>设置为<em><strong>下载和安装的工具链</strong></em></li>
<li>将<em><strong>工具链URL</strong></em>设置为file:///path/to/your/sdk/tarball.tar.gz</li>
</ul>
<h4 id="外部工具链包装器"><a class="markdownIt-Anchor" href="#外部工具链包装器"></a> 外部工具链包装器</h4>
<p>在使用外部工具链时，Buildroot会生成一个包装程序，会透明地将正确的选项（根据配置）传递给外部工具链程序。如果您需要调试此包装器以查看究竟传递了哪些参数，可以将环境变量BR2_DEBUG_WRAPPER设置为以下之一：</p>
<ul>
<li>0，空或未设置：无调试信息</li>
<li>1：在一行上跟踪所有参数</li>
<li>2：每行跟踪一个参数</li>
</ul>
<h2 id="62-dev管理"><a class="markdownIt-Anchor" href="#62-dev管理"></a> 6.2. /dev管理</h2>
<p>在Linux系统上，/dev目录包含特殊文件，称为<em>设备文件</em>，允许用户空间应用程序访问Linux内核管理的硬件设备。如果没有这些<em>设备文件</em>，您的用户空间应用程序将无法使用硬件设备，即使它们已经被Linux内核正确识别。</p>
<p>在系统配置、/dev管理下，Buildroot提供了处理/dev目录的四种不同解决方案：</p>
<ul>
<li>
<p>第一种解决方案是<em><strong>静态使用设备表</strong></em>*。这是在Linux中处理设备文件的传统方法。使用此方法，设备文件被持久地存储在根文件系统中（即跨重启后仍然存在），并且没有任何东西会在硬件设备添加或删除时自动创建和删除那些设备文件。因此，Buildroot使用<em>设备表</em>创建了一套标准设备文件，其中默认的设备表存储在Buildroot源代码中的system/device_table_dev.txt中。当Buildroot生成最终根文件系统映像时，该文件被处理，并且<em>设备文件</em>因此不可见于output/target目录下。BR2_ROOTFS_STATIC_DEVICE_TABLE选项允许更改Buildroot使用的默认设备表，或者添加额外的设备表，以便Buildroot在构建过程中创建额外的<em>设备文件</em>。因此，如果您使用此方法，如果系统中缺少一个<em>设备文件</em>，您可以创建一个board/<yourcompany>/<yourproject>/device_table_dev.txt文件，其中包含您的额外<em>设备文件</em>的描述，然后您可以将BR2_ROOTFS_STATIC_DEVICE_TABLE设置为<code>system/device_table_dev.txt board/&lt;yourcompany&gt;/&lt;yourproject&gt;/device_table_dev.txt</code>。有关设备表文件格式的更多详细信息，请参阅<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#makedev-syntax">第25章，“Makedev语法文档”</a>。</p>
</li>
<li>
<p>第二种解决方案是<em><strong>动态使用仅devtmpfs</strong></em>。<em>devtmpfs</em>是Linux内核内部的一个虚拟文件系统，它在2.6.32内核中引入（如果您使用较旧的内核，则无法使用此选项）。当挂载在/dev时，这个虚拟文件系统将根据系统中添加和移除的硬件设备自动显示和消失<em>设备文件</em>。这个文件系统在重启后不是持久性的：它会动态地由内核填充。使用<em>devtmpfs</em>要求启用以下内核配置选项：CONFIG_DEVTMPFS 和 CONFIG_DEVTMPFS_MOUNT。当Buildroot负责为您嵌入式设备构建Linux内核时，它会确保这两个选项已启用。但是，如果您在Buildroot之外构建Linux内核，则您有责任启用这两个选项（如果未能这样做，您的Buildroot系统将无法引导）。</p>
</li>
<li>
<p>第三种解决方案是<em><strong>动态使用devtmpfs + mdev</strong></em>。这种方法也依赖上面详述的<em>devtmpfs</em>虚拟文件系统（因此要求内核配置中启用CONFIG_DEVTMPFS和CONFIG_DEVTMPFS_MOUNT），但在其之上添加了mdev用户空间实用程序。mdev是BusyBox的一部分，内核会在每次添加或移除设备时调用mdev程序。通过/etc/mdev.conf配置文件，mdev可以配置为在设备出现或消失时设置特定权限或所有权，调用脚本或应用程序等。基本上，它允许<em>用户空间</em>在设备添加和移除事件上做出反应。mdev例如可以用于在设备出现在系统上时自动加载内核模块。如果您有需要固件的设备，mdev也将负责将固件内容传递给内核。mdev是udev的轻量级实现（功能更少）。有关mdev和其配置文件语法的更多详细信息，请参阅<a target="_blank" rel="noopener" href="http://git.busybox.net/busybox/tree/docs/mdev.txt%E3%80%82">http://git.busybox.net/busybox/tree/docs/mdev.txt。</a></p>
</li>
<li>
<p>第四种解决方案是<em><strong>动态使用devtmpfs + eudev</strong></em>。这种方法也依赖上述<em>devtmpfs</em>虚拟文件系统，但在其之上添加了eudev用户空间守护程序。eudev是一个后台运行的守护程序，在设备被添加或从系统中删除时由内核调用。它比mdev更加庞大，但提供了更高的灵活性。eudev是udev原始用户空间守护程序的一个独立版本，它现在是Systemd的一部分。有关eudev的更多详细信息，请参阅<a href="http%EF%BC%9A//en.wikipedia.org/wiki/Udev">http：//en.wikipedia.org/wiki/Udev</a>。</p>
<p>Buildroot开发人员建议从<em><strong>仅使用devtmpfs</strong></em>方案开始，直到您需要用户空间在添加/移除设备时被通知，或者如果需要固件，那么<em><strong>devtmpfs + mdev</strong></em>通常是一个不错的解决方案。</p>
<p>请注意，如果选择systemd作为init系统，则/dev管理将由systemd提供的udev程序执行。</p>
<h2 id="63-初始化系统"><a class="markdownIt-Anchor" href="#63-初始化系统"></a> 6.3. 初始化系统</h2>
<p><em>init</em>程序是内核启动的第一个用户空间程序（它具有PID号为1），负责启动用户空间服务和程序（例如：web服务器、图形应用程序、其他网络服务器等）。</p>
<p>Buildroot允许使用三种不同类型的init系统，可以从系统配置，init系统中选择：</p>
<ul>
<li>第一种解决方案是<em><strong>BusyBox</strong></em>。在许多程序中，BusyBox具有基本init程序的实现，这对大多数嵌入式系统而言足够了。启用BR2_INIT_BUSYBOX将确保BusyBox构建和安装其init程序。这是Buildroot中的默认解决方案。BusyBox的init程序将在启动时读取 /etc/inittab 文件，了解应该执行什么操作。此文件的语法可以在<a target="_blank" rel="noopener" href="http://git.busybox.net/busybox/tree/examples/inittab%E4%B8%AD%E6%89%BE%E5%88%B0%EF%BC%88%E8%AF%B7%E6%B3%A8%E6%84%8F%EF%BC%8CBusyBox%E7%9A%84inittab%E8%AF%AD%E6%B3%95%E5%BE%88%E7%89%B9%E6%AE%8A%EF%BC%9A%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E6%9D%A5%E8%87%AA%E4%BA%92%E8%81%94%E7%BD%91%E7%9A%84%E9%9A%8F%E6%9C%BAinittab%E6%96%87%E6%A1%A3%E6%9D%A5%E4%BA%86%E8%A7%A3BusyBox%E7%9A%84inittab%EF%BC%89%E3%80%82Buildroot%E4%B8%AD%E7%9A%84%E9%BB%98%E8%AE%A4inittab%E5%AD%98%E5%82%A8%E5%9C%A8system/skeleton/etc/inittab%E4%B8%AD%E3%80%82%E9%99%A4%E4%BA%86%E6%8C%82%E8%BD%BD%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%96%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%9A%84inittab%E7%9A%84%E4%B8%BB%E8%A6%81%E5%B7%A5%E4%BD%9C%E6%98%AF%E5%90%AF%E5%8A%A8/etc/init.d/rcS">http://git.busybox.net/busybox/tree/examples/inittab中找到（请注意，BusyBox的inittab语法很特殊：不要使用来自互联网的随机inittab文档来了解BusyBox的inittab）。Buildroot中的默认inittab存储在system/skeleton/etc/inittab中。除了挂载几个重要的文件系统外，默认的inittab的主要工作是启动/etc/init.d/rcS</a> shell脚本和启动getty程序（提供登录提示符）。</li>
<li>第二种解决方案是<em><strong>systemV</strong></em>。此解决方案使用旧的传统<em>sysvinit</em>程序，打包在Buildroot中的package/sysvinit中。这是大多数桌面Linux发行版采用的解决方案，直到它们转向更近代的替代方案，例如Upstart或Systemd。sysvinit也使用inittab文件（其与BusyBox的语法略有不同）。安装此init解决方案时的默认inittab位于package/sysvinit/inittab中。</li>
<li>第三种解决方案是<em><strong>systemd</strong></em>。systemd是Linux的新一代init系统。它远不止传统的<em>init</em>程序：具有激进的并行化功能，使用套接字和D-Bus激活启动服务，支持按需启动守护程序，跟踪使用Linux控制组的进程，支持系统状态的快照和恢复等。systemd将在相对复杂的嵌入式系统中是有用的，例如需要D-Bus和服务之间通信的系统。值得注意的是，systemd带来了相当多的大型依赖项：dbus、udev等更多。有关systemd的更多详细信息，请参见<a target="_blank" rel="noopener" href="http://www.freedesktop.org/wiki/Software/systemd%E3%80%82">http://www.freedesktop.org/wiki/Software/systemd。</a></li>
</ul>
<p>Buildroot开发人员推荐使用<em><strong>BusyBox init</strong></em>，因为它对大多数嵌入式系统已经足够。<em><strong>systemd</strong></em>可以用于更复杂的情况。</p>
</li>
</ul>
<h2 id="第7章-其他组件的配置"><a class="markdownIt-Anchor" href="#第7章-其他组件的配置"></a> 第7章。其他组件的配置</h2>
<p>在尝试修改下面列出的任何组件之前，请确保您已经配置好了Buildroot本身，并已启用相应的软件包。</p>
<ul>
<li>BusyBox</li>
</ul>
<p>如果您已经有一个BusyBox配置文件，您可以直接在Buildroot配置中指定此文件，使用BR2_PACKAGE_BUSYBOX_CONFIG。否则，Buildroot将从默认的BusyBox配置文件开始。要对配置进行后续更改，请使用make busybox-menuconfig打开BusyBox配置编辑器。还可以通过环境变量指定BusyBox配置文件，尽管这不被推荐。有关更多详情，请参阅<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#env-vars">第8.6节，“环境变量”</a>。</p>
<ul>
<li>uClibc</li>
</ul>
<p>对于uClibc的配置与BusyBox相同。指定现有配置文件的配置变量是BR2_UCLIBC_CONFIG。进行后续更改的命令是make uclibc-menuconfig。</p>
<ul>
<li>Linux内核</li>
</ul>
<p>如果您已经有一个内核配置文件，您可以直接在Buildroot配置中指定此文件，使用BR2_LINUX_KERNEL_USE_CUSTOM_CONFIG。如果您还没有内核配置文件，则可以从Buildroot配置中指定一个defconfig，使用BR2_LINUX_KERNEL_USE_DEFCONFIG，或者创建一个空文件，并将其指定为自定义配置文件，使用BR2_LINUX_KERNEL_USE_CUSTOM_CONFIG。要对配置进行后续更改，请使用make linux-menuconfig打开Linux配置编辑器。</p>
<ul>
<li>Barebox</li>
</ul>
<p>Barebox的配置方式与Linux内核相同。相应的配置变量是BR2_TARGET_BAREBOX_USE_CUSTOM_CONFIG和BR2_TARGET_BAREBOX_USE_DEFCONFIG。要打开配置编辑器，请使用make barebox-menuconfig。</p>
<ul>
<li>U-Boot</li>
</ul>
<p>对于U-Boot（版本2015.04或更新版本）的配置与Linux内核相同。相应的配置变量是BR2_TARGET_UBOOT_USE_CUSTOM_CONFIG和BR2_TARGET_UBOOT_USE_DEFCONFIG。要打开配置编辑器，请使用make uboot-menuconfig。</p>
<h2 id="第8章-buildroot的一般用法"><a class="markdownIt-Anchor" href="#第8章-buildroot的一般用法"></a> 第8章。Buildroot的一般用法</h2>
<h3 id="81-make技巧"><a class="markdownIt-Anchor" href="#81-make技巧"></a> 8.1 make技巧</h3>
<p>这里是一些能帮助您充分利用Buildroot的技巧集合。</p>
<p><strong>显示make执行的所有命令：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make V=1 &lt;target&gt;</span><br></pre></td></tr></table></figure>
<p><strong>显示具有defconfig的所有板子列表：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make list-defconfigs</span><br></pre></td></tr></table></figure>
<p><strong>显示所有可用的目标：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make help</span><br></pre></td></tr></table></figure>
<p>并非所有目标始终可用，.config文件中的一些设置可能会隐藏某些目标：</p>
<ul>
<li>只有在启用了busybox时，busybox-menuconfig才有效；</li>
<li>只有在启用了linux时，linux-menuconfig和linux-savedefconfig才有效；</li>
<li>在内部工具链后端中选择了uClibc C库时，uclibc-menuconfig才可用；</li>
<li>只有在启用了barebox引导加载程序时，barebox-menuconfig和barebox-savedefconfig才有效；</li>
<li>只有在启用了U-Boot引导加载程序（2015.04版或更新版）以及将uboot构建系统设置为Kconfig时，uboot-menuconfig和uboot-savedefconfig才有效。</li>
</ul>
<p><strong>清理：</strong> 在更改了任何架构或工具链配置选项时，需要显式清理。</p>
<p>要删除所有构建产品（包括构建目录、主机、分阶段和目标树、镜像和工具链）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br></pre></td></tr></table></figure>
<p><strong>生成手册：</strong> 现有手册源文件位于<em>docs/manual</em>目录中。要生成手册：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make manual-clean</span><br><span class="line">$ make manual</span><br></pre></td></tr></table></figure>
<p>手册输出将生成在<em>output/docs/manual</em>目录中。</p>
<p><strong>注意</strong></p>
<ul>
<li>构建文档需要一些工具（请参阅：<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#requirement-optional">第2.2节，“可选软件包”</a>）。</li>
</ul>
<p><strong>为新目标重置Buildroot：</strong> 要删除所有构建产品以及配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make distclean</span><br></pre></td></tr></table></figure>
<p><strong>注意。</strong> 如果启用了ccache，运行make clean或distclean并不会清空Buildroot使用的编译器缓存。要删除它，请参考<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ccache">第8.13.3节，“在Buildroot中使用ccache”</a>。</p>
<p><strong>转储内部make变量：</strong> 您可以转储make已知的变量以及它们的值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make -s printvars VARS=&#x27;VARIABLE1 VARIABLE2&#x27;</span><br><span class="line">VARIABLE1=value_of_variable</span><br><span class="line">VARIABLE2=value_of_variable</span><br></pre></td></tr></table></figure>
<p>可以使用一些变量调整输出，例如：</p>
<ul>
<li>VARS用于限制与指定make模式匹配的变量列表 - 必须设置否则将不打印任何内容</li>
<li>QUOTED_VARS如果设置为YES，将单引号括住值</li>
<li>RAW_VARS如果设置为YES，将打印未扩展的值</li>
</ul>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ make -s printvars VARS=BUSYBOX_%DEPENDENCIES</span><br><span class="line">BUSYBOX_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_ALL_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_PATCH_DEPENDENCIES=</span><br><span class="line">BUSYBOX_RDEPENDENCIES=ncurses util-linux</span><br><span class="line">$ make -s printvars VARS=BUSYBOX_%DEPENDENCIES QUOTED_VARS=YES</span><br><span class="line">BUSYBOX_DEPENDENCIES=&#x27;skeleton toolchain&#x27;</span><br><span class="line">BUSYBOX_FINAL_ALL_DEPENDENCIES=&#x27;skeleton toolchain&#x27;</span><br><span class="line">BUSYBOX_FINAL_DEPENDENCIES=&#x27;skeleton toolchain&#x27;</span><br><span class="line">BUSYBOX_FINAL_PATCH_DEPENDENCIES=&#x27;&#x27;</span><br><span class="line">BUSYBOX_RDEPENDENCIES=&#x27;ncurses util-linux&#x27;</span><br><span class="line">$ make -s printvars VARS=BUSYBOX_%DEPENDENCIES RAW_VARS=YES</span><br><span class="line">BUSYBOX_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_ALL_DEPENDENCIES=$(sort $(BUSYBOX_FINAL_DEPENDENCIES) $(BUSYBOX_FINAL_PATCH_DEPENDENCIES))</span><br><span class="line">BUSYBOX_FINAL_DEPENDENCIES=$(sort $(BUSYBOX_DEPENDENCIES))</span><br><span class="line">BUSYBOX_FINAL_PATCH_DEPENDENCIES=$(sort $(BUSYBOX_PATCH_DEPENDENCIES))</span><br><span class="line">BUSYBOX_RDEPENDENCIES=ncurses util-linux</span><br></pre></td></tr></table></figure>
<p>引用的变量的输出可以在shell脚本中重复使用，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ eval $(make -s printvars VARS=BUSYBOX_DEPENDENCIES QUOTED_VARS=YES)</span><br><span class="line">$ echo $BUSYBOX_DEPENDENCIES</span><br><span class="line">skeleton toolchain</span><br></pre></td></tr></table></figure>
<p><strong>8.2. 理解何时需要进行完整重新构建</strong></p>
<p>Buildroot不尝试检测系统配置通过make menuconfig、make xconfig或其他配置工具更改时应重新构建哪些部分。在某些情况下，Buildroot应重新构建整个系统，而在某些情况下，只需要重新构建特定的软件包。但是，在完全可靠的方式中检测这一点非常困难，因此Buildroot开发人员决定不尝试这样做。</p>
<p>相反，用户有责任知道何时需要完整重新构建。以下是一些规则，可以帮助您了解如何使用Buildroot：</p>
<ul>
<li>当更改目标架构配置时，通常需要重新构建整个系统。更改体系结构变体、二进制格式或浮点策略，例如，对整个系统都有影响。</li>
<li>更改工具链配置时，通常需要重新构建整个系统。更改工具链配置经常涉及更改编译器版本、C库类型或其配置，或其他基本配置项，这些更改会影响整个系统。</li>
<li>当向配置中添加附加软件包时，并不一定需要进行完整重新构建。Buildroot将检测这个软件包从未构建过，并将构建它。但是，如果此软件包是可选由已经构建的软件包使用的库，Buildroot不会自动重新构建这些软件包。要么您知道应重新构建哪些软件包，并可以手动重新构建它们，要么应该进行完整重新构建。例如，假设您已构建了一个包含ctorrent软件包但不包含openssl的系统。系统正在运行，但您意识到想在ctorrent中加入SSL支持，因此在Buildroot配置中启用openssl软件包并重新开始构建。Buildroot将检测到应该构建openssl，并将构建它，但不会检测出应重新构建ctorrent以利用openssl为ctorrent添加OpenSSL支持。您将需要进行完整重新构建，或者重新构建ctorrent本身。</li>
<li>当从配置中删除软件包时，Buildroot不会执行任何特殊操作。它不会从目标根文件系统或工具链<em>sysroot</em>中删除由该软件包安装的文件。需要进行完整重新构建以摆脱该软件包。然而，一般情况下，并不总是立刻需要移除此软件包：您可以等到下一个午餐时间重新启动构建。</li>
<li>当更改软件包的子选项时，软件包不会自动重新构建。在进行此类更改后，仅重新构建此软件包通常已足够，除非启用软件包子选项为另一个已经构建的软件包提供某些有用功能。再次强调，Buildroot不跟踪何时应该重新构建软件包：一旦软件包被构建，它将永远不会重新构建，除非显式告知要这样做。</li>
<li>当对根文件系统骨架进行更改时，需要完整重新构建。但是，当对根文件系统叠加、后构建脚本或后镜像脚本进行更改时，并不需要完整重新构建：简单地运行make调用将考虑这些更改。</li>
<li>当构建列表中的软件包重新构建或删除时，软件包foo不会自动重新构建。例如，如果包bar在FOO_DEPENDENCIES中列出，FOO_DEPENDENCIES = bar 并且更改了bar软件包的配置，该配置更改不会自动导致重新构建软件包foo。在这种情况下，您可能需要重新构建构建中引用了bar的软件包，或者执行完整重新构建以确保任何bar依赖的软件包都是最新的。</li>
</ul>
<p>一般来说，当您遇到构建错误并且对您所做的配置更改的潜在影响不确定时，请进行完整重新构建。如果出现相同的构建错误，那么您可以确定错误与软件包的部分重新构建无关。如果此错误发生在官方Buildroot软件包上，请随时报告问题！随着您对Buildroot的经验增长，您将逐渐了解何时确实需要进行完整重新构建，并将节省越来越多的时间。</p>
<p>要进行完整重新构建，请运行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make clean all</span><br></pre></td></tr></table></figure>
<h2 id="83-理解如何重新构建软件包"><a class="markdownIt-Anchor" href="#83-理解如何重新构建软件包"></a> 8.3。理解如何重新构建软件包</h2>
<p>Buildroot用户最常问的问题之一是如何重新构建一个给定的软件包，或者如何移除一个软件包而不必从头开始重新构建。</p>
<p>在不重新构建的情况下移除软件包在Buildroot中不受支持。这是因为Buildroot不会跟踪哪个软件包将文件安装在output/staging和output/target目录中，或者哪些软件包会根据另一个软件包的可用性进行不同的编译。</p>
<p>从头开始重新构建一个软件包的最简单方法是删除其构建目录中的文件夹output/build。Buildroot然后会重新提取、重新配置、重新编译和重新安装该软件包。您可以使用<package>-dirclean命令要求Buildroot执行此操作。</p>
<p>另一方面，如果您只想从编译步骤重新启动软件包的构建过程，可以运行<package>-rebuild。这将重新开始软件包的编译和安装过程，但不是从头开始：它基本上在软件包内执行make和make install，因此只会重新构建更改的文件。</p>
<p>如果要重新启动软件包的配置步骤的构建过程，请运行<package>-reconfigure。它将重新开始配置、编译和安装软件包。</p>
<p>尽管<package>-rebuild隐含<package>-reinstall，<package>-reconfigure则隐含<package>-rebuild，但是这些目标以及<package>仅对该软件包产生影响，并不触发重新创建根文件系统镜像。如果重新创建根文件系统是必要的，还应额外运行make或make all。</p>
<p>在内部，Buildroot创建所谓的<em>标记文件</em>来跟踪对每个软件包的每个步骤进行了哪些构建。它们存储在软件包构建目录中，output/build/<package>-<version>/，以.stamp_<step-name>命名。上述详细说明的命令简单地操作这些标记文件，以强制Buildroot在软件包构建过程中重新启动特定的步骤。</p>
<p>关于软件包特定的make目标的进一步详细信息在<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#pkg-build-steps">第8.13.5节，“软件包特定的<em>make</em>目标”</a>中有说明。</p>
<h2 id="84-离线构建"><a class="markdownIt-Anchor" href="#84-离线构建"></a> 8.4。离线构建</h2>
<p>如果您打算进行离线构建并只想下载您之前在配置器（<em>menuconfig</em>、<em>nconfig</em>、<em>xconfig</em>或<em>gconfig</em>）中选择的所有源文件，然后执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make source</span><br></pre></td></tr></table></figure>
<p>现在，您可以断开连接或将您的dl目录的内容复制到构建主机中。</p>
<h2 id="85-并行构建"><a class="markdownIt-Anchor" href="#85-并行构建"></a> 8.5。并行构建</h2>
<p>如果您的系统配置支持并行构建（由BR2_JLEVEL指定的值指定构建线程数），您可以使用make的-j选项来加快构建时间。例如，要使用8个线程进行构建，可以运行：</p>
<p>code<button><svg><path></path></svg><span>Copy code</span><span></span></button></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make -j8</span><br></pre></td></tr></table></figure>
<p>这将在8个并行线程上运行构建过程。</p>
<h2 id="86-ccache的使用"><a class="markdownIt-Anchor" href="#86-ccache的使用"></a> 8.6。CCache的使用</h2>
<p>CCache是一个用于提高编译时间的缓存工具。如果您正在多次构建相同的项目，CCache可帮助加快构建过程，尤其是对于较大的项目。要在Buildroot中使用CCache，请执行以下步骤：</p>
<ol>
<li>
<p>安装CCache工具。</p>
</li>
<li>
<p>设置环境变量CCACHE_DIR指向一个用于存储CCache缓存的目录。这可以是任何位置，建议是位于一个快速访问的位置。</p>
</li>
<li>
<p>在Buildroot配置中启用CCache支持：</p>
<p>code<button><svg><path></path></svg><span>Copy code</span><span></span></button></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make menuconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>进入Build options菜单</li>
<li>启用Enable compiler cache选项</li>
<li>设置CCache version（表示CCache版本号）</li>
<li>设置CCache size in GB（表示CCache缓存大小，如果将其保留为空，则CCache使用默认大小）</li>
</ul>
</li>
<li>
<p>确保ccache可执行文件在您的PATH中。</p>
</li>
</ol>
<p>使用CCache编译项目将会自动为您识别已缓存的结果，并加速构建过程。CCache会将已编译的对象文件保存在缓存中，以便在下次编译需要它们时能够快速重用这些编译结果。</p>
<h2 id="87-查看构建日志"><a class="markdownIt-Anchor" href="#87-查看构建日志"></a> 8.7。查看构建日志</h2>
<p>如果想要查看Buildroot的构建日志以进行调试或分析，您可以在构建过程中使用tee命令将构建输出保存到文件中。例如，可以使用以下命令将构建输出保存到名为build.log的文件中：</p>
<p>code<button><svg><path></path></svg><span>Copy code</span><span></span></button></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make 2&gt;&amp;1 | tee build.log</span><br></pre></td></tr></table></figure>
<p>这将同时将构建输出打印到终端并保存在build.log文件中。您可以根据需要查看此文件以了解详细的构建过程和任何可能的错误消息。</p>
<h2 id="88-软件包的版本库"><a class="markdownIt-Anchor" href="#88-软件包的版本库"></a> 8.8。软件包的版本库</h2>
<p>Buildroot在运行时下载软件包源代码，并将其存储在dl目录中。如果您需要重置或重新下载特定软件包的源代码，可以手动删除dl目录中与该软件包相关的文件。然后再次构建将触发重新下载并提取该软件包的源代码。</p>
<h2 id="89-构建虚拟机映像"><a class="markdownIt-Anchor" href="#89-构建虚拟机映像"></a> 8.9。构建虚拟机映像</h2>
<p>如果您想构建一个虚拟机映像（如QEMU的硬盘映像），可以使用Buildroot。要构建虚拟机映像，您需要启用适当的Target packages，Filesystem images和Bootloaders选项，并且需要配置适当的启动和根文件系统选项。</p>
<p>构建成功后，您将在output/images/目录中找到构建的虋拟机映像文件。</p>
<h2 id="810-定制构建结果"><a class="markdownIt-Anchor" href="#810-定制构建结果"></a> 8.10。定制构建结果</h2>
<p>对于定制构建结果，您可以根据自己的需求添加或更改Buildroot中的软件包、配置选项和功能。您还可以扩展Buildroot以支持自定义硬件或特定用例的需求。通过运用所学，您可以根据项目需求自定义构建。</p>
<p>这些是一些常用的构建技巧和实践，希望它们能帮助您更好地了解和使用Buildroot。如果您有任何进一步的问题或需要更多帮助，请随时与我联系！</p>
<h2 id="chapter-7-configuration-of-other-components"><a class="markdownIt-Anchor" href="#chapter-7-configuration-of-other-components"></a> Chapter 7. Configuration of other components</h2>
<p>Before attempting to modify any of the components below, make sure you have already configured Buildroot itself, and have enabled the corresponding package.</p>
<ul>
<li>
<p>BusyBox</p>
<p>If you already have a BusyBox configuration file, you can directly specify this file in the Buildroot configuration, using <code>BR2_PACKAGE_BUSYBOX_CONFIG</code>. Otherwise, Buildroot will start from a default BusyBox configuration <a target="_blank" rel="noopener" href="http://file.To">file.To</a> make subsequent changes to the configuration, use <code>make busybox-menuconfig</code> to open the BusyBox configuration <a target="_blank" rel="noopener" href="http://editor.It">editor.It</a> is also possible to specify a BusyBox configuration file through an environment variable, although this is not recommended. Refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#env-vars">Section 8.6, “Environment variables”</a> for more details.</p>
</li>
<li>
<p>uClibc</p>
<p>Configuration of uClibc is done in the same way as for BusyBox. The configuration variable to specify an existing configuration file is <code>BR2_UCLIBC_CONFIG</code>. The command to make subsequent changes is <code>make uclibc-menuconfig</code>.</p>
</li>
<li>
<p>Linux kernel</p>
<p>If you already have a kernel configuration file, you can directly specify this file in the Buildroot configuration, using <code>BR2_LINUX_KERNEL_USE_CUSTOM_CONFIG</code>.If you do not yet have a kernel configuration file, you can either start by specifying a defconfig in the Buildroot configuration, using <code>BR2_LINUX_KERNEL_USE_DEFCONFIG</code>, or start by creating an empty file and specifying it as custom configuration file, using <code>BR2_LINUX_KERNEL_USE_CUSTOM_CONFIG</code>.To make subsequent changes to the configuration, use <code>make linux-menuconfig</code> to open the Linux configuration editor.</p>
</li>
<li>
<p>Barebox</p>
<p>Configuration of Barebox is done in the same way as for the Linux kernel. The corresponding configuration variables are <code>BR2_TARGET_BAREBOX_USE_CUSTOM_CONFIG</code> and <code>BR2_TARGET_BAREBOX_USE_DEFCONFIG</code>. To open the configuration editor, use <code>make barebox-menuconfig</code>.</p>
</li>
<li>
<p>U-Boot</p>
<p>Configuration of U-Boot (version 2015.04 or newer) is done in the same way as for the Linux kernel. The corresponding configuration variables are <code>BR2_TARGET_UBOOT_USE_CUSTOM_CONFIG</code> and <code>BR2_TARGET_UBOOT_USE_DEFCONFIG</code>. To open the configuration editor, use <code>make uboot-menuconfig</code>.</p>
</li>
</ul>
<h2 id="chapter-8-general-buildroot-usage"><a class="markdownIt-Anchor" href="#chapter-8-general-buildroot-usage"></a> Chapter 8. General Buildroot usage</h2>
<h2 id="81-make-tips"><a class="markdownIt-Anchor" href="#81-make-tips"></a> 8.1. <em>make</em> tips</h2>
<p>This is a collection of tips that help you make the most of Buildroot.</p>
<p><strong>Display all commands executed by make:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make V=1 &lt;target&gt;</span><br></pre></td></tr></table></figure>
<p><strong>Display the list of boards with a defconfig:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make list-defconfigs</span><br></pre></td></tr></table></figure>
<p><strong>Display all available targets:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make help</span><br></pre></td></tr></table></figure>
<p>Not all targets are always available, some settings in the <code>.config</code> file may hide some targets:</p>
<ul>
<li><code>busybox-menuconfig</code> only works when <code>busybox</code> is enabled;</li>
<li><code>linux-menuconfig</code> and <code>linux-savedefconfig</code> only work when <code>linux</code> is enabled;</li>
<li><code>uclibc-menuconfig</code> is only available when the uClibc C library is selected in the internal toolchain backend;</li>
<li><code>barebox-menuconfig</code> and <code>barebox-savedefconfig</code> only work when the <code>barebox</code> bootloader is enabled.</li>
<li><code>uboot-menuconfig</code> and <code>uboot-savedefconfig</code> only work when the <code>U-Boot</code> bootloader is enabled and the <code>uboot</code> build system is set to <code>Kconfig</code>.</li>
</ul>
<p><strong>Cleaning:</strong> Explicit cleaning is required when any of the architecture or toolchain configuration options are changed.</p>
<p>To delete all build products (including build directories, host, staging and target trees, the images and the toolchain):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br></pre></td></tr></table></figure>
<p><strong>Generating the manual:</strong> The present manual sources are located in the <em>docs/manual</em> directory. To generate the manual:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make manual-clean</span><br><span class="line">$ make manual</span><br></pre></td></tr></table></figure>
<p>The manual outputs will be generated in <em>output/docs/manual</em>.</p>
<p><strong>Notes</strong></p>
<ul>
<li>A few tools are required to build the documentation (see: <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#requirement-optional">Section 2.2, “Optional packages”</a>).</li>
</ul>
<p><strong>Resetting Buildroot for a new target:</strong> To delete all build products as well as the configuration:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make distclean</span><br></pre></td></tr></table></figure>
<p><strong>Notes.</strong> If <code>ccache</code> is enabled, running <code>make clean</code> or <code>distclean</code> does not empty the compiler cache used by Buildroot. To delete it, refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ccache">Section 8.13.3, “Using <code>ccache</code> in Buildroot”</a>.</p>
<p><strong>Dumping the internal make variables:</strong> One can dump the variables known to make, along with their values:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make -s printvars VARS=&#x27;VARIABLE1 VARIABLE2&#x27;</span><br><span class="line">VARIABLE1=value_of_variable</span><br><span class="line">VARIABLE2=value_of_variable</span><br></pre></td></tr></table></figure>
<p>It is possible to tweak the output using some variables:</p>
<ul>
<li><code>VARS</code> will limit the listing to variables which names match the specified make-patterns - this must be set else nothing is printed</li>
<li><code>QUOTED_VARS</code>, if set to <code>YES</code>, will single-quote the value</li>
<li><code>RAW_VARS</code>, if set to <code>YES</code>, will print the unexpanded value</li>
</ul>
<p>For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ make -s printvars VARS=BUSYBOX_%DEPENDENCIES</span><br><span class="line">BUSYBOX_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_ALL_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_PATCH_DEPENDENCIES=</span><br><span class="line">BUSYBOX_RDEPENDENCIES=ncurses util-linux</span><br><span class="line">$ make -s printvars VARS=BUSYBOX_%DEPENDENCIES QUOTED_VARS=YES</span><br><span class="line">BUSYBOX_DEPENDENCIES=&#x27;skeleton toolchain&#x27;</span><br><span class="line">BUSYBOX_FINAL_ALL_DEPENDENCIES=&#x27;skeleton toolchain&#x27;</span><br><span class="line">BUSYBOX_FINAL_DEPENDENCIES=&#x27;skeleton toolchain&#x27;</span><br><span class="line">BUSYBOX_FINAL_PATCH_DEPENDENCIES=&#x27;&#x27;</span><br><span class="line">BUSYBOX_RDEPENDENCIES=&#x27;ncurses util-linux&#x27;</span><br><span class="line">$ make -s printvars VARS=BUSYBOX_%DEPENDENCIES RAW_VARS=YES</span><br><span class="line">BUSYBOX_DEPENDENCIES=skeleton toolchain</span><br><span class="line">BUSYBOX_FINAL_ALL_DEPENDENCIES=$(sort $(BUSYBOX_FINAL_DEPENDENCIES) $(BUSYBOX_FINAL_PATCH_DEPENDENCIES))</span><br><span class="line">BUSYBOX_FINAL_DEPENDENCIES=$(sort $(BUSYBOX_DEPENDENCIES))</span><br><span class="line">BUSYBOX_FINAL_PATCH_DEPENDENCIES=$(sort $(BUSYBOX_PATCH_DEPENDENCIES))</span><br><span class="line">BUSYBOX_RDEPENDENCIES=ncurses util-linux</span><br></pre></td></tr></table></figure>
<p>The output of quoted variables can be reused in shell scripts, for example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ eval $(make -s printvars VARS=BUSYBOX_DEPENDENCIES QUOTED_VARS=YES)</span><br><span class="line">$ echo $BUSYBOX_DEPENDENCIES</span><br><span class="line">skeleton toolchain</span><br></pre></td></tr></table></figure>
<h2 id="82-understanding-when-a-full-rebuild-is-necessary"><a class="markdownIt-Anchor" href="#82-understanding-when-a-full-rebuild-is-necessary"></a> 8.2. Understanding when a full rebuild is necessary</h2>
<p>Buildroot does not attempt to detect what parts of the system should be rebuilt when the system configuration is changed through <code>make menuconfig</code>, <code>make xconfig</code> or one of the other configuration tools. In some cases, Buildroot should rebuild the entire system, in some cases, only a specific subset of packages. But detecting this in a completely reliable manner is very difficult, and therefore the Buildroot developers have decided to simply not attempt to do this.</p>
<p>Instead, it is the responsibility of the user to know when a full rebuild is necessary. As a hint, here are a few rules of thumb that can help you understand how to work with Buildroot:</p>
<ul>
<li>When the target architecture configuration is changed, a complete rebuild is needed. Changing the architecture variant, the binary format or the floating point strategy for example has an impact on the entire system.</li>
<li>When the toolchain configuration is changed, a complete rebuild generally is needed. Changing the toolchain configuration often involves changing the compiler version, the type of C library or its configuration, or some other fundamental configuration item, and these changes have an impact on the entire system.</li>
<li>When an additional package is added to the configuration, a full rebuild is not necessarily needed. Buildroot will detect that this package has never been built, and will build it. However, if this package is a library that can optionally be used by packages that have already been built, Buildroot will not automatically rebuild those. Either you know which packages should be rebuilt, and you can rebuild them manually, or you should do a full rebuild. For example, let’s suppose you have built a system with the <code>ctorrent</code> package, but without <code>openssl</code>. Your system works, but you realize you would like to have SSL support in <code>ctorrent</code>, so you enable the <code>openssl</code> package in Buildroot configuration and restart the build. Buildroot will detect that <code>openssl</code> should be built and will be build it, but it will not detect that <code>ctorrent</code> should be rebuilt to benefit from <code>openssl</code> to add OpenSSL support. You will either have to do a full rebuild, or rebuild <code>ctorrent</code> itself.</li>
<li>When a package is removed from the configuration, Buildroot does not do anything special. It does not remove the files installed by this package from the target root filesystem or from the toolchain <em>sysroot</em>. A full rebuild is needed to get rid of this package. However, generally you don’t necessarily need this package to be removed right now: you can wait for the next lunch break to restart the build from scratch.</li>
<li>When the sub-options of a package are changed, the package is not automatically rebuilt. After making such changes, rebuilding only this package is often sufficient, unless enabling the package sub-option adds some features to the package that are useful for another package which has already been built. Again, Buildroot does not track when a package should be rebuilt: once a package has been built, it is never rebuilt unless explicitly told to do so.</li>
<li>When a change to the root filesystem skeleton is made, a full rebuild is needed. However, when changes to the root filesystem overlay, a post-build script or a post-image script are made, there is no need for a full rebuild: a simple <code>make</code> invocation will take the changes into account.</li>
<li>When a package listed in <code>FOO_DEPENDENCIES</code> is rebuilt or removed, the package <code>foo</code> is not automatically rebuilt. For example, if a package <code>bar</code> is listed in <code>FOO_DEPENDENCIES</code> with <code>FOO_DEPENDENCIES = bar</code> and the configuration of the <code>bar</code> package is changed, the configuration change would not result in a rebuild of package <code>foo</code> automatically. In this scenario, you may need to either rebuild any packages in your build which reference <code>bar</code> in their <code>DEPENDENCIES</code>, or perform a full rebuild to ensure any <code>bar</code> dependent packages are up to date.</li>
</ul>
<p>Generally speaking, when you’re facing a build error and you’re unsure of the potential consequences of the configuration changes you’ve made, do a full rebuild. If you get the same build error, then you are sure that the error is not related to partial rebuilds of packages, and if this error occurs with packages from the official Buildroot, do not hesitate to report the problem! As your experience with Buildroot progresses, you will progressively learn when a full rebuild is really necessary, and you will save more and more time.</p>
<p>For reference, a full rebuild is achieved by running:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make clean all</span><br></pre></td></tr></table></figure>
<h2 id="83-understanding-how-to-rebuild-packages"><a class="markdownIt-Anchor" href="#83-understanding-how-to-rebuild-packages"></a> 8.3. Understanding how to rebuild packages</h2>
<p>One of the most common questions asked by Buildroot users is how to rebuild a given package or how to remove a package without rebuilding everything from scratch.</p>
<p>Removing a package is unsupported by Buildroot without rebuilding from scratch. This is because Buildroot doesn’t keep track of which package installs what files in the <code>output/staging</code> and <code>output/target</code> directories, or which package would be compiled differently depending on the availability of another package.</p>
<p>The easiest way to rebuild a single package from scratch is to remove its build directory in <code>output/build</code>. Buildroot will then re-extract, re-configure, re-compile and re-install this package from scratch. You can ask buildroot to do this with the <code>make &lt;package&gt;-dirclean</code> command.</p>
<p>On the other hand, if you only want to restart the build process of a package from its compilation step, you can run <code>make &lt;package&gt;-rebuild</code>. It will restart the compilation and installation of the package, but not from scratch: it basically re-executes <code>make</code> and <code>make install</code> inside the package, so it will only rebuild files that changed.</p>
<p>If you want to restart the build process of a package from its configuration step, you can run <code>make &lt;package&gt;-reconfigure</code>. It will restart the configuration, compilation and installation of the package.</p>
<p>While <code>&lt;package&gt;-rebuild</code> implies <code>&lt;package&gt;-reinstall</code> and <code>&lt;package&gt;-reconfigure</code> implies <code>&lt;package&gt;-rebuild</code>, these targets as well as <code>&lt;package&gt;</code> only act on the said package, and do not trigger re-creating the root filesystem image. If re-creating the root filesystem in necessary, one should in addition run <code>make</code> or <code>make all</code>.</p>
<p>Internally, Buildroot creates so-called <em>stamp files</em> to keep track of which build steps have been completed for each package. They are stored in the package build directory, <code>output/build/&lt;package&gt;-&lt;version&gt;/</code> and are named <code>.stamp_&lt;step-name&gt;</code>. The commands detailed above simply manipulate these stamp files to force Buildroot to restart a specific set of steps of a package build process.</p>
<p>Further details about package special make targets are explained in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#pkg-build-steps">Section 8.13.5, “Package-specific <em>make</em> targets”</a>.</p>
<h2 id="84-offline-builds"><a class="markdownIt-Anchor" href="#84-offline-builds"></a> 8.4. Offline builds</h2>
<p>If you intend to do an offline build and just want to download all sources that you previously selected in the configurator (<em>menuconfig</em>, <em>nconfig</em>, <em>xconfig</em> or <em>gconfig</em>), then issue:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make source</span><br></pre></td></tr></table></figure>
<p>You can now disconnect or copy the content of your <code>dl</code> directory to the build-host.</p>
<h2 id="85-building-out-of-tree"><a class="markdownIt-Anchor" href="#85-building-out-of-tree"></a> 8.5. Building out-of-tree</h2>
<p>As default, everything built by Buildroot is stored in the directory <code>output</code> in the Buildroot tree.</p>
<p>Buildroot also supports building out of tree with a syntax similar to the Linux kernel. To use it, add <code>O=&lt;directory&gt;</code> to the make command line:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make O=/tmp/build menuconfig</span><br></pre></td></tr></table></figure>
<p>Or:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cd /tmp/build; make O=$PWD -C path/to/buildroot menuconfig</span><br></pre></td></tr></table></figure>
<p>All the output files will be located under <code>/tmp/build</code>. If the <code>O</code> path does not exist, Buildroot will create it.</p>
<p><em><strong>*Note:*</strong></em> the <code>O</code> path can be either an absolute or a relative path, but if it’s passed as a relative path, it is important to note that it is interpreted relative to the main Buildroot source directory, <em><strong>*not*</strong></em> the current working directory.</p>
<p>When using out-of-tree builds, the Buildroot <code>.config</code> and temporary files are also stored in the output directory. This means that you can safely run multiple builds in parallel using the same source tree as long as they use unique output directories.</p>
<p>For ease of use, Buildroot generates a Makefile wrapper in the output directory - so after the first run, you no longer need to pass <code>O=&lt;…&gt;</code> and <code>-C &lt;…&gt;</code>, simply run (in the output directory):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make &lt;target&gt;</span><br></pre></td></tr></table></figure>
<h2 id="86-environment-variables"><a class="markdownIt-Anchor" href="#86-environment-variables"></a> 8.6. Environment variables</h2>
<p>Buildroot also honors some environment variables, when they are passed to <code>make</code> or set in the environment:</p>
<ul>
<li><code>HOSTCXX</code>, the host C++ compiler to use</li>
<li><code>HOSTCC</code>, the host C compiler to use</li>
<li><code>UCLIBC_CONFIG_FILE=&lt;path/to/.config&gt;</code>, path to the uClibc configuration file, used to compile uClibc, if an internal toolchain is being built. Note that the uClibc configuration file can also be set from the configuration interface, so through the Buildroot <code>.config</code> file; this is the recommended way of setting it.</li>
<li><code>BUSYBOX_CONFIG_FILE=&lt;path/to/.config&gt;</code>, path to the BusyBox configuration file. Note that the BusyBox configuration file can also be set from the configuration interface, so through the Buildroot <code>.config</code> file; this is the recommended way of setting it.</li>
<li><code>BR2_CCACHE_DIR</code> to override the directory where Buildroot stores the cached files when using ccache.</li>
<li><code>BR2_DL_DIR</code> to override the directory in which Buildroot stores/retrieves downloaded files. Note that the Buildroot download directory can also be set from the configuration interface, so through the Buildroot <code>.config</code> file. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#download-location">Section 8.13.4, “Location of downloaded packages”</a> for more details on how you can set the download directory.</li>
<li><code>BR2_GRAPH_ALT</code>, if set and non-empty, to use an alternate color-scheme in build-time graphs</li>
<li><code>BR2_GRAPH_OUT</code> to set the filetype of generated graphs, either <code>pdf</code> (the default), or <code>png</code>.</li>
<li><code>BR2_GRAPH_DEPS_OPTS</code> to pass extra options to the dependency graph; see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#graph-depends">Section 8.9, “Graphing the dependencies between packages”</a> for the accepted options</li>
<li><code>BR2_GRAPH_DOT_OPTS</code> is passed verbatim as options to the <code>dot</code> utility to draw the dependency graph.</li>
<li><code>BR2_GRAPH_SIZE_OPTS</code> to pass extra options to the size graph; see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#graph-size">Section 8.11, “Graphing the filesystem size contribution of packages”</a> for the acepted options</li>
</ul>
<p>An example that uses config files located in the toplevel directory and in your $HOME:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make UCLIBC_CONFIG_FILE=uClibc.config BUSYBOX_CONFIG_FILE=$HOME/bb.config</span><br></pre></td></tr></table></figure>
<p>If you want to use a compiler other than the default <code>gcc</code> or <code>g</code>++ for building helper-binaries on your host, then do</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make HOSTCXX=g++-4.3-HEAD HOSTCC=gcc-4.3-HEAD</span><br></pre></td></tr></table></figure>
<h2 id="87-dealing-efficiently-with-filesystem-images"><a class="markdownIt-Anchor" href="#87-dealing-efficiently-with-filesystem-images"></a> 8.7. Dealing efficiently with filesystem images</h2>
<p>Filesystem images can get pretty big, depending on the filesystem you choose, the number of packages, whether you provisioned free space… Yet, some locations in the filesystems images may just be <em>empty</em> (e.g. a long run of <em>zeroes</em>); such a file is called a <em>sparse</em> file.</p>
<p>Most tools can handle sparse files efficiently, and will only store or write those parts of a sparse file that are not empty.</p>
<p>For example:</p>
<ul>
<li><code>tar</code> accepts the <code>-S</code> option to tell it to only store non-zero blocks of sparse files:
<ul>
<li><code>tar cf archive.tar -S [files…]</code> will efficiently store sparse files in a tarball</li>
<li><code>tar xf archive.tar -S</code> will efficiently store sparse files extracted from a tarball</li>
</ul>
</li>
<li><code>cp</code> accepts the <code>--sparse=WHEN</code> option (<code>WHEN</code> is one of <code>auto</code>, <code>never</code> or <code>always</code>):
<ul>
<li><code>cp --sparse=always source.file dest.file</code> will make <code>dest.file</code> a sparse file if <code>source.file</code> has long runs of zeroes</li>
</ul>
</li>
</ul>
<p>Other tools may have similar options. Please consult their respective man pages.</p>
<p>You can use sparse files if you need to store the filesystem images (e.g. to transfer from one machine to another), or if you need to send them (e.g. to the Q&amp;A team).</p>
<p>Note however that flashing a filesystem image to a device while using the sparse mode of <code>dd</code> may result in a broken filesystem (e.g. the block bitmap of an ext2 filesystem may be corrupted; or, if you have sparse files in your filesystem, those parts may not be all-zeroes when read back). You should only use sparse files when handling files on the build machine, not when transferring them to an actual device that will be used on the target.</p>
<h2 id="88-details-about-packages"><a class="markdownIt-Anchor" href="#88-details-about-packages"></a> 8.8. Details about packages</h2>
<p>Buildroot can produce a JSON blurb that describes the set of enabled packages in the current configuration, together with their dependencies, licenses and other metadata. This JSON blurb is produced by using the <code>show-info</code> make target:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make show-info</span><br></pre></td></tr></table></figure>
<p>Buildroot can also produce details about packages as HTML and JSON output using the <code>pkg-stats</code> make target. Amongst other things, these details include whether known CVEs (security vulnerabilities) affect the packages in your current configuration. It also shows if there is a newer upstream version for those packages.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make pkg-stats</span><br></pre></td></tr></table></figure>
<h2 id="89-graphing-the-dependencies-between-packages"><a class="markdownIt-Anchor" href="#89-graphing-the-dependencies-between-packages"></a> 8.9. Graphing the dependencies between packages</h2>
<p>One of Buildroot’s jobs is to know the dependencies between packages, and make sure they are built in the right order. These dependencies can sometimes be quite complicated, and for a given system, it is often not easy to understand why such or such package was brought into the build by Buildroot.</p>
<p>In order to help understanding the dependencies, and therefore better understand what is the role of the different components in your embedded Linux system, Buildroot is capable of generating dependency graphs.</p>
<p>To generate a dependency graph of the full system you have compiled, simply run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make graph-depends</span><br></pre></td></tr></table></figure>
<p>You will find the generated graph in <code>output/graphs/graph-depends.pdf</code>.</p>
<p>If your system is quite large, the dependency graph may be too complex and difficult to read. It is therefore possible to generate the dependency graph just for a given package:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &lt;pkg&gt;-graph-depends</span><br></pre></td></tr></table></figure>
<p>You will find the generated graph in <code>output/graph/&lt;pkg&gt;-graph-depends.pdf</code>.</p>
<p>Note that the dependency graphs are generated using the <code>dot</code> tool from the <em>Graphviz</em> project, which you must have installed on your system to use this feature. In most distributions, it is available as the <code>graphviz</code> package.</p>
<p>By default, the dependency graphs are generated in the PDF format. However, by passing the <code>BR2_GRAPH_OUT</code> environment variable, you can switch to other output formats, such as PNG, PostScript or SVG. All formats supported by the <code>-T</code> option of the <code>dot</code> tool are supported.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BR2_GRAPH_OUT=svg make graph-depends</span><br></pre></td></tr></table></figure>
<p>The <code>graph-depends</code> behaviour can be controlled by setting options in the <code>BR2_GRAPH_DEPS_OPTS</code> environment variable. The accepted options are:</p>
<ul>
<li><code>--depth N</code>, <code>-d N</code>, to limit the dependency depth to <code>N</code> levels. The default, <code>0</code>, means no limit.</li>
<li><code>--stop-on PKG</code>, <code>-s PKG</code>, to stop the graph on the package <code>PKG</code>. <code>PKG</code> can be an actual package name, a glob, the keyword <em>virtual</em> (to stop on virtual packages), or the keyword <em>host</em> (to stop on host packages). The package is still present on the graph, but its dependencies are not.</li>
<li><code>--exclude PKG</code>, <code>-x PKG</code>, like <code>--stop-on</code>, but also omits <code>PKG</code> from the graph.</li>
<li><code>--transitive</code>, <code>--no-transitive</code>, to draw (or not) the transitive dependencies. The default is to not draw transitive dependencies.</li>
<li><code>--colors R,T,H</code>, the comma-separated list of colors to draw the root package (<code>R</code>), the target packages (<code>T</code>) and the host packages (<code>H</code>). Defaults to: <code>lightblue,grey,gainsboro</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BR2_GRAPH_DEPS_OPTS=&#x27;-d 3 --no-transitive --colors=red,green,blue&#x27; make graph-depends</span><br></pre></td></tr></table></figure>
<h2 id="810-graphing-the-build-duration"><a class="markdownIt-Anchor" href="#810-graphing-the-build-duration"></a> 8.10. Graphing the build duration</h2>
<p>When the build of a system takes a long time, it is sometimes useful to be able to understand which packages are the longest to build, to see if anything can be done to speed up the build. In order to help such build time analysis, Buildroot collects the build time of each step of each package, and allows to generate graphs from this data.</p>
<p>To generate the build time graph after a build, run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make graph-build</span><br></pre></td></tr></table></figure>
<p>This will generate a set of files in <code>output/graphs</code> :</p>
<ul>
<li><code>build.hist-build.pdf</code>, a histogram of the build time for each package, ordered in the build order.</li>
<li><code>build.hist-duration.pdf</code>, a histogram of the build time for each package, ordered by duration (longest first)</li>
<li><code>build.hist-name.pdf</code>, a histogram of the build time for each package, order by package name.</li>
<li><code>build.pie-packages.pdf</code>, a pie chart of the build time per package</li>
<li><code>build.pie-steps.pdf</code>, a pie chart of the global time spent in each step of the packages build process.</li>
</ul>
<p>This <code>graph-build</code> target requires the Python Matplotlib and Numpy libraries to be installed (<code>python-matplotlib</code> and <code>python-numpy</code> on most distributions), and also the <code>argparse</code> module if you’re using a Python version older than 2.7 (<code>python-argparse</code> on most distributions).</p>
<p>By default, the output format for the graph is PDF, but a different format can be selected using the <code>BR2_GRAPH_OUT</code> environment variable. The only other format supported is PNG:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BR2_GRAPH_OUT=png make graph-build</span><br></pre></td></tr></table></figure>
<h2 id="811-graphing-the-filesystem-size-contribution-of-packages"><a class="markdownIt-Anchor" href="#811-graphing-the-filesystem-size-contribution-of-packages"></a> 8.11. Graphing the filesystem size contribution of packages</h2>
<p>When your target system grows, it is sometimes useful to understand how much each Buildroot package is contributing to the overall root filesystem size. To help with such an analysis, Buildroot collects data about files installed by each package and using this data, generates a graph and CSV files detailing the size contribution of the different packages.</p>
<p>To generate these data after a build, run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make graph-size</span><br></pre></td></tr></table></figure>
<p>This will generate:</p>
<ul>
<li><code>output/graphs/graph-size.pdf</code>, a pie chart of the contribution of each package to the overall root filesystem size</li>
<li><code>output/graphs/package-size-stats.csv</code>, a CSV file giving the size contribution of each package to the overall root filesystem size</li>
<li><code>output/graphs/file-size-stats.csv</code>, a CSV file giving the size contribution of each installed file to the package it belongs, and to the overall filesystem size.</li>
</ul>
<p>This <code>graph-size</code> target requires the Python Matplotlib library to be installed (<code>python-matplotlib</code> on most distributions), and also the <code>argparse</code> module if you’re using a Python version older than 2.7 (<code>python-argparse</code> on most distributions).</p>
<p>Just like for the duration graph, a <code>BR2_GRAPH_OUT</code> environment variable is supported to adjust the output file format. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#graph-depends">Section 8.9, “Graphing the dependencies between packages”</a> for details about this environment variable.</p>
<p>Additionally, one may set the environment variable <code>BR2_GRAPH_SIZE_OPTS</code> to further control the generated graph. Accepted options are:</p>
<ul>
<li><code>--size-limit X</code>, <code>-l X</code>, will group all packages which individual contribution is below <code>X</code> percent, to a single entry labelled <em>Others</em> in the graph. By default, <code>X=0.01</code>, which means packages each contributing less than 1% are grouped under <em>Others</em>. Accepted values are in the range <code>[0.0..1.0]</code>.</li>
<li><code>--iec</code>, <code>--binary</code>, <code>--si</code>, <code>--decimal</code>, to use IEC (binary, powers of 1024) or SI (decimal, powers of 1000; the default) prefixes.</li>
<li><code>--biggest-first</code>, to sort packages in decreasing size order, rather than in increasing size order.</li>
</ul>
<p><strong>Note.</strong> The collected filesystem size data is only meaningful after a complete clean rebuild. Be sure to run <code>make clean all</code> before using <code>make graph-size</code>.</p>
<p>To compare the root filesystem size of two different Buildroot compilations, for example after adjusting the configuration or when switching to another Buildroot release, use the <code>size-stats-compare</code> script. It takes two <code>file-size-stats.csv</code> files (produced by <code>make graph-size</code>) as input. Refer to the help text of this script for more details:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">utils/size-stats-compare -h</span><br></pre></td></tr></table></figure>
<h2 id="812-top-level-parallel-build"><a class="markdownIt-Anchor" href="#812-top-level-parallel-build"></a> 8.12. Top-level parallel build</h2>
<p><strong>Note.</strong> This section deals with a very experimental feature, which is known to break even in some non-unusual situations. Use at your own risk.</p>
<p>Buildroot has always been capable of using parallel build on a per package basis: each package is built by Buildroot using <code>make -jN</code> (or the equivalent invocation for non-make-based build systems). The level of parallelism is by default number of CPUs + 1, but it can be adjusted using the <code>BR2_JLEVEL</code> configuration option.</p>
<p>Until 2020.02, Buildroot was however building packages in a serial fashion: each package was built one after the other, without parallelization of the build between packages. As of 2020.02, Buildroot has experimental support for <em><strong>*top-level parallel build*</strong></em>, which allows some signicant build time savings by building packages that have no dependency relationship in parallel. This feature is however marked as experimental and is known not to work in some cases.</p>
<p>In order to use top-level parallel build, one must:</p>
<ol>
<li>Enable the option <code>BR2_PER_PACKAGE_DIRECTORIES</code> in the Buildroot configuration</li>
<li>Use <code>make -jN</code> when starting the Buildroot build</li>
</ol>
<p>Internally, the <code>BR2_PER_PACKAGE_DIRECTORIES</code> will enable a mechanism called <em><strong>*per-package directories*</strong></em>, which will have the following effects:</p>
<ul>
<li>Instead of a global <em>target</em> directory and a global <em>host</em> directory common to all packages, per-package <em>target</em> and <em>host</em> directories will be used, in <code>$(O)/per-package/&lt;pkg&gt;/target/</code> and <code>$(O)/per-package/&lt;pkg&gt;/host/</code> respectively. Those folders will be populated from the corresponding folders of the package dependencies at the beginning of <code>&lt;pkg&gt;</code> build. The compiler and all other tools will therefore only be able to see and access files installed by dependencies explicitly listed by <code>&lt;pkg&gt;</code>.</li>
<li>At the end of the build, the global <em>target</em> and <em>host</em> directories will be populated, located in <code>$(O)/target</code> and <code>$(O)/host</code> respectively. This means that during the build, those folders will be empty and it’s only at the very end of the build that they will be populated.</li>
</ul>
<h2 id="813-advanced-usage"><a class="markdownIt-Anchor" href="#813-advanced-usage"></a> 8.13. Advanced usage</h2>
<h3 id="8131-using-the-generated-toolchain-outside-buildroot"><a class="markdownIt-Anchor" href="#8131-using-the-generated-toolchain-outside-buildroot"></a> 8.13.1. Using the generated toolchain outside Buildroot</h3>
<p>You may want to compile, for your target, your own programs or other software that are not packaged in Buildroot. In order to do this you can use the toolchain that was generated by Buildroot.</p>
<p>The toolchain generated by Buildroot is located by default in <code>output/host/</code>. The simplest way to use it is to add <code>output/host/bin/</code> to your PATH environment variable and then to use <code>ARCH-linux-gcc</code>, <code>ARCH-linux-objdump</code>, <code>ARCH-linux-ld</code>, etc.</p>
<p>Alternatively, Buildroot can also export the toolchain and the development files of all selected packages, as an SDK, by running the command <code>make sdk</code>. This generates a tarball of the content of the host directory <code>output/host/</code>, named <code>&lt;TARGET-TUPLE&gt;_sdk-buildroot.tar.gz</code> (which can be overriden by setting the environment variable <code>BR2_SDK_PREFIX</code>) and located in the output directory <code>output/images/</code>.</p>
<p>This tarball can then be distributed to application developers, when they want to develop their applications that are not (yet) packaged as a Buildroot package.</p>
<p>Upon extracting the SDK tarball, the user must run the script <code>relocate-sdk.sh</code> (located at the top directory of the SDK), to make sure all paths are updated with the new location.</p>
<p>Alternatively, if you just want to prepare the SDK without generating the tarball (e.g. because you will just be moving the <code>host</code> directory, or will be generating the tarball on your own), Buildroot also allows you to just prepare the SDK with <code>make prepare-sdk</code> without actually generating a tarball.</p>
<p>For your convenience, by selecting the option <code>BR2_PACKAGE_HOST_ENVIRONMENT_SETUP</code>, you can get a <code>environment-setup</code> script installed in <code>output/host/</code> and therefore in your SDK. This script can be sourced with <code>. your/sdk/path/environment-setup</code> to export a number of environment variables that will help cross-compile your projects using the Buildroot SDK: the <code>PATH</code> will contain the SDK binaries, standard <em>autotools</em> variables will be defined with the appropriate values, and <code>CONFIGURE_FLAGS</code> will contain basic <code>./configure</code> options to cross-compile <em>autotools</em> projects. It also provides some useful commands. Note however that once this script is sourced, the environment is setup only for cross-compilation, and no longer for native compilation.</p>
<h3 id="8132-using-gdb-in-buildroot"><a class="markdownIt-Anchor" href="#8132-using-gdb-in-buildroot"></a> 8.13.2. Using <code>gdb</code> in Buildroot</h3>
<p>Buildroot allows to do cross-debugging, where the debugger runs on the build machine and communicates with <code>gdbserver</code> on the target to control the execution of the program.</p>
<p>To achieve this:</p>
<ul>
<li>If you are using an <em>internal toolchain</em> (built by Buildroot), you must enable <code>BR2_PACKAGE_HOST_GDB</code>, <code>BR2_PACKAGE_GDB</code> and <code>BR2_PACKAGE_GDB_SERVER</code>. This ensures that both the cross gdb and gdbserver get built, and that gdbserver gets installed to your target.</li>
<li>If you are using an <em>external toolchain</em>, you should enable <code>BR2_TOOLCHAIN_EXTERNAL_GDB_SERVER_COPY</code>, which will copy the gdbserver included with the external toolchain to the target. If your external toolchain does not have a cross gdb or gdbserver, it is also possible to let Buildroot build them, by enabling the same options as for the <em>internal toolchain backend</em>.</li>
</ul>
<p>Now, to start debugging a program called <code>foo</code>, you should run on the target:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdbserver :2345 foo</span><br></pre></td></tr></table></figure>
<p>This will cause <code>gdbserver</code> to listen on TCP port 2345 for a connection from the cross gdb.</p>
<p>Then, on the host, you should start the cross gdb using the following command line:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;buildroot&gt;/output/host/bin/&lt;tuple&gt;-gdb -ix &lt;buildroot&gt;/output/staging/usr/share/buildroot/gdbinit foo</span><br></pre></td></tr></table></figure>
<p>Of course, <code>foo</code> must be available in the current directory, built with debugging symbols. Typically you start this command from the directory where <code>foo</code> is built (and not from <code>output/target/</code> as the binaries in that directory are stripped).</p>
<p>The <code>&lt;buildroot&gt;/output/staging/usr/share/buildroot/gdbinit</code> file will tell the cross gdb where to find the libraries of the target.</p>
<p>Finally, to connect to the target from the cross gdb:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) target remote &lt;target ip address&gt;:2345</span><br></pre></td></tr></table></figure>
<h3 id="8133-using-ccache-in-buildroot"><a class="markdownIt-Anchor" href="#8133-using-ccache-in-buildroot"></a> 8.13.3. Using <code>ccache</code> in Buildroot</h3>
<p><a target="_blank" rel="noopener" href="http://ccache.samba.org/">ccache</a> is a compiler cache. It stores the object files resulting from each compilation process, and is able to skip future compilation of the same source file (with same compiler and same arguments) by using the pre-existing object files. When doing almost identical builds from scratch a number of times, it can nicely speed up the build process.</p>
<p><code>ccache</code> support is integrated in Buildroot. You just have to enable <code>Enable compiler cache</code> in <code>Build options</code>. This will automatically build <code>ccache</code> and use it for every host and target compilation.</p>
<p>The cache is located in the directory defined by the <code>BR2_CCACHE_DIR</code> configuration option, which defaults to <code>$HOME/.buildroot-ccache</code>. This default location is outside of Buildroot output directory so that it can be shared by separate Buildroot builds. If you want to get rid of the cache, simply remove this directory.</p>
<p>You can get statistics on the cache (its size, number of hits, misses, etc.) by running <code>make ccache-stats</code>.</p>
<p>The make target <code>ccache-options</code> and the <code>CCACHE_OPTIONS</code> variable provide more generic access to the ccache. For example</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># set cache limit size</span><br><span class="line">make CCACHE_OPTIONS=&quot;--max-size=5G&quot; ccache-options</span><br><span class="line"></span><br><span class="line"># zero statistics counters</span><br><span class="line">make CCACHE_OPTIONS=&quot;--zero-stats&quot; ccache-options</span><br></pre></td></tr></table></figure>
<p><code>ccache</code> makes a hash of the source files and of the compiler options. If a compiler option is different, the cached object file will not be used. Many compiler options, however, contain an absolute path to the staging directory. Because of this, building in a different output directory would lead to many cache misses.</p>
<p>To avoid this issue, buildroot has the <code>Use relative paths</code> option (<code>BR2_CCACHE_USE_BASEDIR</code>). This will rewrite all absolute paths that point inside the output directory into relative paths. Thus, changing the output directory no longer leads to cache misses.</p>
<p>A disadvantage of the relative paths is that they also end up to be relative paths in the object file. Therefore, for example, the debugger will no longer find the file, unless you cd to the output directory first.</p>
<p>See <a target="_blank" rel="noopener" href="https://ccache.samba.org/manual.html#_compiling_in_different_directories">the ccache manual’s section on “Compiling in different directories”</a> for more details about this rewriting of absolute paths.</p>
<p>When <code>ccache</code> is enabled in Buildroot using the <code>BR2_CCACHE=y</code> option:</p>
<ul>
<li><code>ccache</code> is used during the Buildroot build itself</li>
<li><code>ccache</code> is not used when building outside of Buildroot, for example when directly calling the cross-compiler or using the SDK</li>
</ul>
<p>One can override this behavior using the <code>BR2_USE_CCACHE</code> environment variable: when set to <code>1</code>, usage of ccache is enabled (default during the Buildroot build), when unset or set to a value different from <code>1</code>, usage of ccache is disabled.</p>
<h3 id="8134-location-of-downloaded-packages"><a class="markdownIt-Anchor" href="#8134-location-of-downloaded-packages"></a> 8.13.4. Location of downloaded packages</h3>
<p>The various tarballs that are downloaded by Buildroot are all stored in <code>BR2_DL_DIR</code>, which by default is the <code>dl</code> directory. If you want to keep a complete version of Buildroot which is known to be working with the associated tarballs, you can make a copy of this directory. This will allow you to regenerate the toolchain and the target filesystem with exactly the same versions.</p>
<p>If you maintain several Buildroot trees, it might be better to have a shared download location. This can be achieved by pointing the <code>BR2_DL_DIR</code> environment variable to a directory. If this is set, then the value of <code>BR2_DL_DIR</code> in the Buildroot configuration is overridden. The following line should be added to <code>&lt;~/.bashrc&gt;</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export BR2_DL_DIR=&lt;shared download location&gt;</span><br></pre></td></tr></table></figure>
<p>The download location can also be set in the <code>.config</code> file, with the <code>BR2_DL_DIR</code> option. Unlike most options in the .config file, this value is overridden by the <code>BR2_DL_DIR</code> environment variable.</p>
<h3 id="8135-package-specific-make-targets"><a class="markdownIt-Anchor" href="#8135-package-specific-make-targets"></a> 8.13.5. Package-specific <em>make</em> targets</h3>
<p>Running <code>make &lt;package&gt;</code> builds and installs that particular package and its dependencies.</p>
<p>For packages relying on the Buildroot infrastructure, there are numerous special make targets that can be called independently like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &lt;package&gt;-&lt;target&gt;</span><br></pre></td></tr></table></figure>
<p>The package build targets are (in the order they are executed):</p>
<table>
<thead>
<tr>
<th>command/target</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source</code></td>
<td>Fetch the source (download the tarball, clone the source repository, etc)</td>
</tr>
<tr>
<td><code>depends</code></td>
<td>Build and install all dependencies required to build the package</td>
</tr>
<tr>
<td><code>extract</code></td>
<td>Put the source in the package build directory (extract the tarball, copy the source, etc)</td>
</tr>
<tr>
<td><code>patch</code></td>
<td>Apply the patches, if any</td>
</tr>
<tr>
<td><code>configure</code></td>
<td>Run the configure commands, if any</td>
</tr>
<tr>
<td><code>build</code></td>
<td>Run the compilation commands</td>
</tr>
<tr>
<td><code>install-staging</code></td>
<td><em><strong>*target package:*</strong></em> Run the installation of the package in the staging directory, if necessary</td>
</tr>
<tr>
<td><code>install-target</code></td>
<td><em><strong>*target package:*</strong></em> Run the installation of the package in the target directory, if necessary</td>
</tr>
<tr>
<td><code>install</code></td>
<td><em><strong>*target package:*</strong></em> Run the 2 previous installation commands****host package:**** Run the installation of the package in the host directory</td>
</tr>
</tbody>
</table>
<p>Additionally, there are some other useful make targets:</p>
<table>
<thead>
<tr>
<th>command/target</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>show-depends</code></td>
<td>Displays the first-order dependencies required to build the package</td>
</tr>
<tr>
<td><code>show-recursive-depends</code></td>
<td>Recursively displays the dependencies required to build the package</td>
</tr>
<tr>
<td><code>show-rdepends</code></td>
<td>Displays the first-order reverse dependencies of the package (i.e packages that directly depend on it)</td>
</tr>
<tr>
<td><code>show-recursive-rdepends</code></td>
<td>Recursively displays the reverse dependencies of the package (i.e the packages that depend on it, directly or indirectly)</td>
</tr>
<tr>
<td><code>graph-depends</code></td>
<td>Generate a dependency graph of the package, in the context of the current Buildroot configuration. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#graph-depends">this section</a> for more details about dependency graphs.</td>
</tr>
<tr>
<td><code>graph-rdepends</code></td>
<td>Generate a graph of this package reverse dependencies (i.e the packages that depend on it, directly or indirectly)</td>
</tr>
<tr>
<td><code>dirclean</code></td>
<td>Remove the whole package build directory</td>
</tr>
<tr>
<td><code>reinstall</code></td>
<td>Re-run the install commands</td>
</tr>
<tr>
<td><code>rebuild</code></td>
<td>Re-run the compilation commands - this only makes sense when using the <code>OVERRIDE_SRCDIR</code> feature or when you modified a file directly in the build directory</td>
</tr>
<tr>
<td><code>reconfigure</code></td>
<td>Re-run the configure commands, then rebuild - this only makes sense when using the <code>OVERRIDE_SRCDIR</code> feature or when you modified a file directly in the build directory</td>
</tr>
</tbody>
</table>
<h3 id="8136-using-buildroot-during-development"><a class="markdownIt-Anchor" href="#8136-using-buildroot-during-development"></a> 8.13.6. Using Buildroot during development</h3>
<p>The normal operation of Buildroot is to download a tarball, extract it, configure, compile and install the software component found inside this tarball. The source code is extracted in <code>output/build/&lt;package&gt;-&lt;version&gt;</code>, which is a temporary directory: whenever <code>make clean</code> is used, this directory is entirely removed, and re-created at the next <code>make</code> invocation. Even when a Git or Subversion repository is used as the input for the package source code, Buildroot creates a tarball out of it, and then behaves as it normally does with tarballs.</p>
<p>This behavior is well-suited when Buildroot is used mainly as an integration tool, to build and integrate all the components of an embedded Linux system. However, if one uses Buildroot during the development of certain components of the system, this behavior is not very convenient: one would instead like to make a small change to the source code of one package, and be able to quickly rebuild the system with Buildroot.</p>
<p>Making changes directly in <code>output/build/&lt;package&gt;-&lt;version&gt;</code> is not an appropriate solution, because this directory is removed on <code>make clean</code>.</p>
<p>Therefore, Buildroot provides a specific mechanism for this use case: the <code>&lt;pkg&gt;_OVERRIDE_SRCDIR</code> mechanism. Buildroot reads an <em>override</em> file, which allows the user to tell Buildroot the location of the source for certain packages.</p>
<p>The default location of the override file is <code>$(CONFIG_DIR)/local.mk</code>, as defined by the <code>BR2_PACKAGE_OVERRIDE_FILE</code> configuration option. <code>$(CONFIG_DIR)</code> is the location of the Buildroot <code>.config</code> file, so <code>local.mk</code> by default lives side-by-side with the <code>.config</code> file, which means:</p>
<ul>
<li>In the top-level Buildroot source directory for in-tree builds (i.e., when <code>O=</code> is not used)</li>
<li>In the out-of-tree directory for out-of-tree builds (i.e., when <code>O=</code> is used)</li>
</ul>
<p>If a different location than these defaults is required, it can be specified through the <code>BR2_PACKAGE_OVERRIDE_FILE</code> configuration option.</p>
<p>In this <em>override</em> file, Buildroot expects to find lines of the form:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;pkg1&gt;_OVERRIDE_SRCDIR = /path/to/pkg1/sources</span><br><span class="line">&lt;pkg2&gt;_OVERRIDE_SRCDIR = /path/to/pkg2/sources</span><br></pre></td></tr></table></figure>
<p>For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LINUX_OVERRIDE_SRCDIR = /home/bob/linux/</span><br><span class="line">BUSYBOX_OVERRIDE_SRCDIR = /home/bob/busybox/</span><br></pre></td></tr></table></figure>
<p>When Buildroot finds that for a given package, an <code>&lt;pkg&gt;_OVERRIDE_SRCDIR</code> has been defined, it will no longer attempt to download, extract and patch the package. Instead, it will directly use the source code available in the specified directory and <code>make clean</code> will not touch this directory. This allows to point Buildroot to your own directories, that can be managed by Git, Subversion, or any other version control system. To achieve this, Buildroot will use <em>rsync</em> to copy the source code of the component from the specified <code>&lt;pkg&gt;_OVERRIDE_SRCDIR</code> to <code>output/build/&lt;package&gt;-custom/</code>.</p>
<p>This mechanism is best used in conjunction with the <code>make &lt;pkg&gt;-rebuild</code> and <code>make &lt;pkg&gt;-reconfigure</code> targets. A <code>make &lt;pkg&gt;-rebuild all</code> sequence will <em>rsync</em> the source code from <code>&lt;pkg&gt;_OVERRIDE_SRCDIR</code> to <code>output/build/&lt;package&gt;-custom</code> (thanks to <em>rsync</em>, only the modified files are copied), and restart the build process of just this package.</p>
<p>In the example of the <code>linux</code> package above, the developer can then make a source code change in <code>/home/bob/linux</code> and then run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make linux-rebuild all</span><br></pre></td></tr></table></figure>
<p>and in a matter of seconds gets the updated Linux kernel image in <code>output/images</code>. Similarly, a change can be made to the BusyBox source code in <code>/home/bob/busybox</code>, and after:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make busybox-rebuild all</span><br></pre></td></tr></table></figure>
<p>the root filesystem image in <code>output/images</code> contains the updated BusyBox.</p>
<p>Source trees for big projects often contain hundreds or thousands of files which are not needed for building, but will slow down the process of copying the sources with <em>rsync</em>. Optionally, it is possible define <code>&lt;pkg&gt;_OVERRIDE_SRCDIR_RSYNC_EXCLUSIONS</code> to skip syncing certain files from the source tree. For example, when working on the <code>webkitgtk</code> package, the following will exclude the tests and in-tree builds from a local WebKit source tree:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WEBKITGTK_OVERRIDE_SRCDIR = /home/bob/WebKit</span><br><span class="line">WEBKITGTK_OVERRIDE_SRCDIR_RSYNC_EXCLUSIONS = \</span><br><span class="line">        --exclude JSTests --exclude ManualTests --exclude PerformanceTests \</span><br><span class="line">        --exclude WebDriverTests --exclude WebKitBuild --exclude WebKitLibraries \</span><br><span class="line">        --exclude WebKit.xcworkspace --exclude Websites --exclude Examples</span><br></pre></td></tr></table></figure>
<p>By default, Buildroot skips syncing of VCS artifacts (e.g., the <em><strong>*.git*</strong></em> and <em><strong>*.svn*</strong></em> directories). Some packages prefer to have these VCS directories available during build, for example for automatically determining a precise commit reference for version information. To undo this built-in filtering at a cost of a slower speed, add these directories back:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LINUX_OVERRIDE_SRCDIR_RSYNC_EXCLUSIONS = --include .git</span><br></pre></td></tr></table></figure>
<h2 id="chapter-9-project-specific-customization"><a class="markdownIt-Anchor" href="#chapter-9-project-specific-customization"></a> Chapter 9. Project-specific customization</h2>
<p>Typical actions you may need to perform for a given project are:</p>
<ul>
<li>configuring Buildroot (including build options and toolchain, bootloader, kernel, package and filesystem image type selection)</li>
<li>configuring other components, like the Linux kernel and BusyBox</li>
<li>customizing the generated target filesystem
<ul>
<li>adding or overwriting files on the target filesystem (using <code>BR2_ROOTFS_OVERLAY</code>)</li>
<li>modifying or deleting files on the target filesystem (using <code>BR2_ROOTFS_POST_BUILD_SCRIPT</code>)</li>
<li>running arbitrary commands prior to generating the filesystem image (using <code>BR2_ROOTFS_POST_BUILD_SCRIPT</code>)</li>
<li>setting file permissions and ownership (using <code>BR2_ROOTFS_DEVICE_TABLE</code>)</li>
<li>adding custom devices nodes (using <code>BR2_ROOTFS_STATIC_DEVICE_TABLE</code>)</li>
</ul>
</li>
<li>adding custom user accounts (using <code>BR2_ROOTFS_USERS_TABLES</code>)</li>
<li>running arbitrary commands after generating the filesystem image (using <code>BR2_ROOTFS_POST_IMAGE_SCRIPT</code>)</li>
<li>adding project-specific patches to some packages (using <code>BR2_GLOBAL_PATCH_DIR</code>)</li>
<li>adding project-specific packages</li>
</ul>
<p>An important note regarding such <em>project-specific</em> customizations: please carefully consider which changes are indeed project-specific and which changes are also useful to developers outside your project. The Buildroot community highly recommends and encourages the upstreaming of improvements, packages and board support to the official Buildroot project. Of course, it is sometimes not possible or desirable to upstream because the changes are highly specific or proprietary.</p>
<p>This chapter describes how to make such project-specific customizations in Buildroot and how to store them in a way that you can build the same image in a reproducible way, even after running <em>make clean</em>. By following the recommended strategy, you can even use the same Buildroot tree to build multiple distinct projects!</p>
<h2 id="91-recommended-directory-structure"><a class="markdownIt-Anchor" href="#91-recommended-directory-structure"></a> 9.1. Recommended directory structure</h2>
<p>When customizing Buildroot for your project, you will be creating one or more project-specific files that need to be stored somewhere. While most of these files could be placed in <em>any</em> location as their path is to be specified in the Buildroot configuration, the Buildroot developers recommend a specific directory structure which is described in this section.</p>
<p>Orthogonal to this directory structure, you can choose <em>where</em> you place this structure itself: either inside the Buildroot tree, or outside of it using a br2-external tree. Both options are valid, the choice is up to you.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">+-- board/</span><br><span class="line">|   +-- &lt;company&gt;/</span><br><span class="line">|       +-- &lt;boardname&gt;/</span><br><span class="line">|           +-- linux.config</span><br><span class="line">|           +-- busybox.config</span><br><span class="line">|           +-- &lt;other configuration files&gt;</span><br><span class="line">|           +-- post_build.sh</span><br><span class="line">|           +-- post_image.sh</span><br><span class="line">|           +-- rootfs_overlay/</span><br><span class="line">|           |   +-- etc/</span><br><span class="line">|           |   +-- &lt;some files&gt;</span><br><span class="line">|           +-- patches/</span><br><span class="line">|               +-- foo/</span><br><span class="line">|               |   +-- &lt;some patches&gt;</span><br><span class="line">|               +-- libbar/</span><br><span class="line">|                   +-- &lt;some other patches&gt;</span><br><span class="line">|</span><br><span class="line">+-- configs/</span><br><span class="line">|   +-- &lt;boardname&gt;_defconfig</span><br><span class="line">|</span><br><span class="line">+-- package/</span><br><span class="line">|   +-- &lt;company&gt;/</span><br><span class="line">|       +-- Config.in (if not using a br2-external tree)</span><br><span class="line">|       +-- &lt;company&gt;.mk (if not using a br2-external tree)</span><br><span class="line">|       +-- package1/</span><br><span class="line">|       |    +-- Config.in</span><br><span class="line">|       |    +-- package1.mk</span><br><span class="line">|       +-- package2/</span><br><span class="line">|           +-- Config.in</span><br><span class="line">|           +-- package2.mk</span><br><span class="line">|</span><br><span class="line">+-- Config.in (if using a br2-external tree)</span><br><span class="line">+-- external.mk (if using a br2-external tree)</span><br><span class="line">+-- external.desc (if using a br2-external tree)</span><br></pre></td></tr></table></figure>
<p>Details on the files shown above are given further in this chapter.</p>
<p>Note: if you choose to place this structure outside of the Buildroot tree but in a br2-external tree, the <company> and possibly <boardname> components may be superfluous and can be left out.</p>
<h3 id="911-implementing-layered-customizations"><a class="markdownIt-Anchor" href="#911-implementing-layered-customizations"></a> 9.1.1. Implementing layered customizations</h3>
<p>It is quite common for a user to have several related projects that partly need the same customizations. Instead of duplicating these customizations for each project, it is recommended to use a layered customization approach, as explained in this section.</p>
<p>Almost all of the customization methods available in Buildroot, like post-build scripts and root filesystem overlays, accept a space-separated list of items. The specified items are always treated in order, from left to right. By creating more than one such item, one for the common customizations and another one for the really project-specific customizations, you can avoid unnecessary duplication. Each layer is typically embodied by a separate directory inside <code>board/&lt;company&gt;/</code>. Depending on your projects, you could even introduce more than two layers.</p>
<p>An example directory structure for where a user has two customization layers <em>common</em> and <em>fooboard</em> is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+-- board/</span><br><span class="line">    +-- &lt;company&gt;/</span><br><span class="line">        +-- common/</span><br><span class="line">        |   +-- post_build.sh</span><br><span class="line">        |   +-- rootfs_overlay/</span><br><span class="line">        |   |   +-- ...</span><br><span class="line">        |   +-- patches/</span><br><span class="line">        |       +-- ...</span><br><span class="line">        |</span><br><span class="line">        +-- fooboard/</span><br><span class="line">            +-- linux.config</span><br><span class="line">            +-- busybox.config</span><br><span class="line">            +-- &lt;other configuration files&gt;</span><br><span class="line">            +-- post_build.sh</span><br><span class="line">            +-- rootfs_overlay/</span><br><span class="line">            |   +-- ...</span><br><span class="line">            +-- patches/</span><br><span class="line">                +-- ...</span><br></pre></td></tr></table></figure>
<p>For example, if the user has the <code>BR2_GLOBAL_PATCH_DIR</code> configuration option set as:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BR2_GLOBAL_PATCH_DIR=&quot;board/&lt;company&gt;/common/patches board/&lt;company&gt;/fooboard/patches&quot;</span><br></pre></td></tr></table></figure>
<p>then first the patches from the <em>common</em> layer would be applied, followed by the patches from the <em>fooboard</em> layer.</p>
<h2 id="92-keeping-customizations-outside-of-buildroot"><a class="markdownIt-Anchor" href="#92-keeping-customizations-outside-of-buildroot"></a> 9.2. Keeping customizations outside of Buildroot</h2>
<p>As already briefly mentioned in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, you can place project-specific customizations in two locations:</p>
<ul>
<li>directly within the Buildroot tree, typically maintaining them using branches in a version control system so that upgrading to a newer Buildroot release is easy.</li>
<li>outside of the Buildroot tree, using the <em>br2-external</em> mechanism. This mechanism allows to keep package recipes, board support and configuration files outside of the Buildroot tree, while still having them nicely integrated in the build logic. We call this location a <em>br2-external tree</em>. This section explains how to use the br2-external mechanism and what to provide in a br2-external tree.</li>
</ul>
<p>One can tell Buildroot to use one or more br2-external trees by setting the <code>BR2_EXTERNAL</code> make variable set to the path(s) of the br2-external tree(s) to use. It can be passed to any Buildroot <code>make</code> invocation. It is automatically saved in the hidden <code>.br2-external.mk</code> file in the output directory. Thanks to this, there is no need to pass <code>BR2_EXTERNAL</code> at every <code>make</code> invocation. It can however be changed at any time by passing a new value, and can be removed by passing an empty value.</p>
<p><strong>Note.</strong> The path to a br2-external tree can be either absolute or relative. If it is passed as a relative path, it is important to note that it is interpreted relative to the main Buildroot source directory, <em><strong>*not*</strong></em> to the Buildroot output directory.</p>
<p><strong>Note:</strong> If using an br2-external tree from before Buildroot 2016.11, you need to convert it before you can use it with Buildroot 2016.11 onward. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#br2-external-converting">Section 27.2, “Migrating to 2016.11”</a> for help on doing so.</p>
<p>Some examples:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buildroot/ $ make BR2_EXTERNAL=/path/to/foo menuconfig</span><br></pre></td></tr></table></figure>
<p>From now on, definitions from the <code>/path/to/foo</code> br2-external tree will be used:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buildroot/ $ make</span><br><span class="line">buildroot/ $ make legal-info</span><br></pre></td></tr></table></figure>
<p>We can switch to another br2-external tree at any time:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buildroot/ $ make BR2_EXTERNAL=/where/we/have/bar xconfig</span><br></pre></td></tr></table></figure>
<p>We can also use multiple br2-external trees:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buildroot/ $ make BR2_EXTERNAL=/path/to/foo:/where/we/have/bar menuconfig</span><br></pre></td></tr></table></figure>
<p>Or disable the usage of any br2-external tree:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buildroot/ $ make BR2_EXTERNAL= xconfig</span><br></pre></td></tr></table></figure>
<h3 id="921-layout-of-a-br2-external-tree"><a class="markdownIt-Anchor" href="#921-layout-of-a-br2-external-tree"></a> 9.2.1. Layout of a br2-external tree</h3>
<p>A br2-external tree must contain at least those three files, described in the following chapters:</p>
<ul>
<li><code>external.desc</code></li>
<li><code>external.mk</code></li>
<li><code>Config.in</code></li>
</ul>
<p>Apart from those mandatory files, there may be additional and optional content that may be present in a br2-external tree, like the <code>configs/</code> or <code>provides/</code> directories. They are described in the following chapters as well.</p>
<p>A complete example br2-external tree layout is also described later.</p>
<h4 id="the-externaldesc-file"><a class="markdownIt-Anchor" href="#the-externaldesc-file"></a> The <code>external.desc</code> file</h4>
<p>That file describes the br2-external tree: the <em>name</em> and <em>description</em> for that br2-external tree.</p>
<p>The format for this file is line based, with each line starting by a keyword, followed by a colon and one or more spaces, followed by the value assigned to that keyword. There are two keywords currently recognised:</p>
<ul>
<li>
<p><code>name</code>, mandatory, defines the name for that br2-external tree. That name must only use ASCII characters in the set <code>[A-Za-z0-9_]</code>; any other character is forbidden. Buildroot sets the variable <code>BR2_EXTERNAL_$(NAME)_PATH</code> to the absolute path of the br2-external tree, so that you can use it to refer to your br2-external tree. This variable is available both in Kconfig, so you can use it to source your Kconfig files (see below) and in the Makefile, so that you can use it to include other Makefiles (see below) or refer to other files (like data files) from your br2-external tree.</p>
<p><strong>Note:</strong> Since it is possible to use multiple br2-external trees at once, this name is used by Buildroot to generate variables for each of those trees. That name is used to identify your br2-external tree, so try to come up with a name that really describes your br2-external tree, in order for it to be relatively unique, so that it does not clash with another name from another br2-external tree, especially if you are planning on somehow sharing your br2-external tree with third parties or using br2-external trees from third parties.</p>
</li>
<li>
<p><code>desc</code>, optional, provides a short description for that br2-external tree. It shall fit on a single line, is mostly free-form (see below), and is used when displaying information about a br2-external tree (e.g. above the list of defconfig files, or as the prompt in the menuconfig); as such, it should relatively brief (40 chars is probably a good upper limit). The description is available in the <code>BR2_EXTERNAL_$(NAME)_DESC</code> variable.</p>
</li>
</ul>
<p>Examples of names and the corresponding <code>BR2_EXTERNAL_$(NAME)_PATH</code> variables:</p>
<ul>
<li><code>FOO</code> → <code>BR2_EXTERNAL_FOO_PATH</code></li>
<li><code>BAR_42</code> → <code>BR2_EXTERNAL_BAR_42_PATH</code></li>
</ul>
<p>In the following examples, it is assumed the name to be set to <code>BAR_42</code>.</p>
<p><strong>Note:</strong> Both <code>BR2_EXTERNAL_$(NAME)_PATH</code> and <code>BR2_EXTERNAL_$(NAME)_DESC</code> are available in the Kconfig files and the Makefiles. They are also exported in the environment so are available in post-build, post-image and in-fakeroot scripts.</p>
<h4 id="the-configin-and-externalmk-files"><a class="markdownIt-Anchor" href="#the-configin-and-externalmk-files"></a> The <code>Config.in</code> and <code>external.mk</code> files</h4>
<p>Those files (which may each be empty) can be used to define package recipes (i.e. <code>foo/Config.in</code> and <code>foo/foo.mk</code> like for packages bundled in Buildroot itself) or other custom configuration options or make logic.</p>
<p>Buildroot automatically includes the <code>Config.in</code> from each br2-external tree to make it appear in the top-level configuration menu, and includes the <code>external.mk</code> from each br2-external tree with the rest of the makefile logic.</p>
<p>The main usage of this is to store package recipes. The recommended way to do this is to write a <code>Config.in</code> file that looks like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &quot;$BR2_EXTERNAL_BAR_42_PATH/package/package1/Config.in&quot;</span><br><span class="line">source &quot;$BR2_EXTERNAL_BAR_42_PATH/package/package2/Config.in&quot;</span><br></pre></td></tr></table></figure>
<p>Then, have an <code>external.mk</code> file that looks like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(sort $(wildcard $(BR2_EXTERNAL_BAR_42_PATH)/package/*/*.mk))</span><br></pre></td></tr></table></figure>
<p>And then in <code>$(BR2_EXTERNAL_BAR_42_PATH)/package/package1</code> and <code>$(BR2_EXTERNAL_BAR_42_PATH)/package/package2</code> create normal Buildroot package recipes, as explained in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#adding-packages">Chapter 18, <em>Adding new packages to Buildroot</em></a>. If you prefer, you can also group the packages in subdirectories called <boardname> and adapt the above paths accordingly.</p>
<p>You can also define custom configuration options in <code>Config.in</code> and custom make logic in <code>external.mk</code>.</p>
<h4 id="the-configs-directory"><a class="markdownIt-Anchor" href="#the-configs-directory"></a> The <code>configs/</code> directory</h4>
<p>One can store Buildroot defconfigs in the <code>configs</code> subdirectory of the br2-external tree. Buildroot will automatically show them in the output of <code>make list-defconfigs</code> and allow them to be loaded with the normal <code>make &lt;name&gt;_defconfig</code> command. They will be visible in the <em>make list-defconfigs</em> output, below an <code>External configs</code> label that contains the name of the br2-external tree they are defined in.</p>
<p><strong>Note:</strong> If a defconfig file is present in more than one br2-external tree, then the one from the last br2-external tree is used. It is thus possible to override a defconfig bundled in Buildroot or another br2-external tree.</p>
<h4 id="the-provides-directory"><a class="markdownIt-Anchor" href="#the-provides-directory"></a> The <code>provides/</code> directory</h4>
<p>For some packages, Buildroot provides a choice between two (or more) implementations of API-compatible such packages. For example, there is a choice to choose either libjpeg ot jpeg-turbo; there is one between openssl or libressl; there is one to select one of the known, pre-configured toolchains…</p>
<p>It is possible for a br2-external to extend those choices, by providing a set of files that define those alternatives:</p>
<ul>
<li><code>provides/toolchains.in</code> defines the pre-configured toolchains, which will then be listed in the toolchain selection;</li>
<li><code>provides/jpeg.in</code> defines the alternative libjpeg implementations;</li>
<li><code>provides/openssl.in</code> defines the alternative openssl implementations;</li>
<li><code>provides/skeleton.in</code> defines the alternative skeleton implementations;</li>
<li><code>provides/init.in</code> defines the alternative init system implementations, this can be used to select a default skeleton for your init.</li>
</ul>
<h4 id="free-form-content"><a class="markdownIt-Anchor" href="#free-form-content"></a> Free-form content</h4>
<p>One can store all the board-specific configuration files there, such as the kernel configuration, the root filesystem overlay, or any other configuration file for which Buildroot allows to set the location (by using the <code>BR2_EXTERNAL_$(NAME)_PATH</code> variable). For example, you could set the paths to a global patch directory, to a rootfs overlay and to the kernel configuration file as follows (e.g. by running <code>make menuconfig</code> and filling in these options):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BR2_GLOBAL_PATCH_DIR=$(BR2_EXTERNAL_BAR_42_PATH)/patches/</span><br><span class="line">BR2_ROOTFS_OVERLAY=$(BR2_EXTERNAL_BAR_42_PATH)/board/&lt;boardname&gt;/overlay/</span><br><span class="line">BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE=$(BR2_EXTERNAL_BAR_42_PATH)/board/&lt;boardname&gt;/kernel.config</span><br></pre></td></tr></table></figure>
<h4 id="additional-linux-kernel-extensions"><a class="markdownIt-Anchor" href="#additional-linux-kernel-extensions"></a> Additional Linux kernel extensions</h4>
<p>Additional Linux kernel extensions (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#linux-kernel-ext">Section 18.22.2, “linux-kernel-extensions”</a>) can be added by storing them in the <code>linux/</code> directory at the root of a br2-external tree.</p>
<h4 id="example-layout"><a class="markdownIt-Anchor" href="#example-layout"></a> Example layout</h4>
<p>Here is an example layout using all features of br2-external (the sample content is shown for the file above it, when it is relevant to explain the br2-external tree; this is all entirely made up just for the sake of illustration, of course):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">/path/to/br2-ext-tree/</span><br><span class="line">  |- external.desc</span><br><span class="line">  |     |name: BAR_42</span><br><span class="line">  |     |desc: Example br2-external tree</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- Config.in</span><br><span class="line">  |     |source &quot;$BR2_EXTERNAL_BAR_42_PATH/toolchain/toolchain-external-mine/Config.in.options&quot;</span><br><span class="line">  |     |source &quot;$BR2_EXTERNAL_BAR_42_PATH/package/pkg-1/Config.in&quot;</span><br><span class="line">  |     |source &quot;$BR2_EXTERNAL_BAR_42_PATH/package/pkg-2/Config.in&quot;</span><br><span class="line">  |     |source &quot;$BR2_EXTERNAL_BAR_42_PATH/package/my-jpeg/Config.in&quot;</span><br><span class="line">  |     |</span><br><span class="line">  |     |config BAR_42_FLASH_ADDR</span><br><span class="line">  |     |    hex &quot;my-board flash address&quot;</span><br><span class="line">  |     |    default 0x10AD</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- external.mk</span><br><span class="line">  |     |include $(sort $(wildcard $(BR2_EXTERNAL_BAR_42_PATH)/package/*/*.mk))</span><br><span class="line">  |     |include $(sort $(wildcard $(BR2_EXTERNAL_BAR_42_PATH)/toolchain/*/*.mk))</span><br><span class="line">  |     |</span><br><span class="line">  |     |flash-my-board:</span><br><span class="line">  |     |    $(BR2_EXTERNAL_BAR_42_PATH)/board/my-board/flash-image \</span><br><span class="line">  |     |        --image $(BINARIES_DIR)/image.bin \</span><br><span class="line">  |     |        --address $(BAR_42_FLASH_ADDR)</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- package/pkg-1/Config.in</span><br><span class="line">  |     |config BR2_PACKAGE_PKG_1</span><br><span class="line">  |     |    bool &quot;pkg-1&quot;</span><br><span class="line">  |     |    help</span><br><span class="line">  |     |      Some help about pkg-1</span><br><span class="line">  |     `----</span><br><span class="line">  |- package/pkg-1/pkg-1.hash</span><br><span class="line">  |- package/pkg-1/pkg-1.mk</span><br><span class="line">  |     |PKG_1_VERSION = 1.2.3</span><br><span class="line">  |     |PKG_1_SITE = /some/where/to/get/pkg-1</span><br><span class="line">  |     |PKG_1_LICENSE = blabla</span><br><span class="line">  |     |</span><br><span class="line">  |     |define PKG_1_INSTALL_INIT_SYSV</span><br><span class="line">  |     |    $(INSTALL) -D -m 0755 $(PKG_1_PKGDIR)/S99my-daemon \</span><br><span class="line">  |     |                          $(TARGET_DIR)/etc/init.d/S99my-daemon</span><br><span class="line">  |     |endef</span><br><span class="line">  |     |</span><br><span class="line">  |     |$(eval $(autotools-package))</span><br><span class="line">  |     `----</span><br><span class="line">  |- package/pkg-1/S99my-daemon</span><br><span class="line">  |</span><br><span class="line">  |- package/pkg-2/Config.in</span><br><span class="line">  |- package/pkg-2/pkg-2.hash</span><br><span class="line">  |- package/pkg-2/pkg-2.mk</span><br><span class="line">  |</span><br><span class="line">  |- provides/jpeg.in</span><br><span class="line">  |     |config BR2_PACKAGE_MY_JPEG</span><br><span class="line">  |     |    bool &quot;my-jpeg&quot;</span><br><span class="line">  |     `----</span><br><span class="line">  |- package/my-jpeg/Config.in</span><br><span class="line">  |     |config BR2_PACKAGE_PROVIDES_JPEG</span><br><span class="line">  |     |    default &quot;my-jpeg&quot; if BR2_PACKAGE_MY_JPEG</span><br><span class="line">  |     `----</span><br><span class="line">  |- package/my-jpeg/my-jpeg.mk</span><br><span class="line">  |     |# This is a normal package .mk file</span><br><span class="line">  |     |MY_JPEG_VERSION = 1.2.3</span><br><span class="line">  |     |MY_JPEG_SITE = https://example.net/some/place</span><br><span class="line">  |     |MY_JPEG_PROVIDES = jpeg</span><br><span class="line">  |     |$(eval $(autotools-package))</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- provides/init.in</span><br><span class="line">  |     |config BR2_INIT_MINE</span><br><span class="line">  |     |    bool &quot;my custom init&quot;</span><br><span class="line">  |     |    select BR2_PACKAGE_MY_INIT</span><br><span class="line">  |     |    select BR2_PACKAGE_SKELETON_INIT_MINE if BR2_ROOTFS_SKELETON_DEFAULT</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- provides/skeleton.in</span><br><span class="line">  |     |config BR2_ROOTFS_SKELETON_MINE</span><br><span class="line">  |     |    bool &quot;my custom skeleton&quot;</span><br><span class="line">  |     |    select BR2_PACKAGE_SKELETON_MINE</span><br><span class="line">  |     `----</span><br><span class="line">  |- package/skeleton-mine/Config.in</span><br><span class="line">  |     |config BR2_PACKAGE_SKELETON_MINE</span><br><span class="line">  |     |    bool</span><br><span class="line">  |     |    select BR2_PACKAGE_HAS_SKELETON</span><br><span class="line">  |     |</span><br><span class="line">  |     |config BR2_PACKAGE_PROVIDES_SKELETON</span><br><span class="line">  |     |    default &quot;skeleton-mine&quot; if BR2_PACKAGE_SKELETON_MINE</span><br><span class="line">  |     `----</span><br><span class="line">  |- package/skeleton-mine/skeleton-mine.mk</span><br><span class="line">  |     |SKELETON_MINE_ADD_TOOLCHAIN_DEPENDENCY = NO</span><br><span class="line">  |     |SKELETON_MINE_ADD_SKELETON_DEPENDENCY = NO</span><br><span class="line">  |     |SKELETON_MINE_PROVIDES = skeleton</span><br><span class="line">  |     |SKELETON_MINE_INSTALL_STAGING = YES</span><br><span class="line">  |     |$(eval $(generic-package))</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- provides/toolchains.in</span><br><span class="line">  |     |config BR2_TOOLCHAIN_EXTERNAL_MINE</span><br><span class="line">  |     |    bool &quot;my custom toolchain&quot;</span><br><span class="line">  |     |    depends on BR2_some_arch</span><br><span class="line">  |     |    select BR2_INSTALL_LIBSTDCPP</span><br><span class="line">  |     `----</span><br><span class="line">  |- toolchain/toolchain-external-mine/Config.in.options</span><br><span class="line">  |     |if BR2_TOOLCHAIN_EXTERNAL_MINE</span><br><span class="line">  |     |config BR2_TOOLCHAIN_EXTERNAL_PREFIX</span><br><span class="line">  |     |    default &quot;arch-mine-linux-gnu&quot;</span><br><span class="line">  |     |config BR2_PACKAGE_PROVIDES_TOOLCHAIN_EXTERNAL</span><br><span class="line">  |     |    default &quot;toolchain-external-mine&quot;</span><br><span class="line">  |     |endif</span><br><span class="line">  |     `----</span><br><span class="line">  |- toolchain/toolchain-external-mine/toolchain-external-mine.mk</span><br><span class="line">  |     |TOOLCHAIN_EXTERNAL_MINE_SITE = https://example.net/some/place</span><br><span class="line">  |     |TOOLCHAIN_EXTERNAL_MINE_SOURCE = my-toolchain.tar.gz</span><br><span class="line">  |     |$(eval $(toolchain-external-package))</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- linux/Config.ext.in</span><br><span class="line">  |     |config BR2_LINUX_KERNEL_EXT_EXAMPLE_DRIVER</span><br><span class="line">  |     |    bool &quot;example-external-driver&quot;</span><br><span class="line">  |     |    help</span><br><span class="line">  |     |      Example external driver</span><br><span class="line">  |     |---</span><br><span class="line">  |- linux/linux-ext-example-driver.mk</span><br><span class="line">  |</span><br><span class="line">  |- configs/my-board_defconfig</span><br><span class="line">  |     |BR2_GLOBAL_PATCH_DIR=&quot;$(BR2_EXTERNAL_BAR_42_PATH)/patches/&quot;</span><br><span class="line">  |     |BR2_ROOTFS_OVERLAY=&quot;$(BR2_EXTERNAL_BAR_42_PATH)/board/my-board/overlay/&quot;</span><br><span class="line">  |     |BR2_ROOTFS_POST_IMAGE_SCRIPT=&quot;$(BR2_EXTERNAL_BAR_42_PATH)/board/my-board/post-image.sh&quot;</span><br><span class="line">  |     |BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE=&quot;$(BR2_EXTERNAL_BAR_42_PATH)/board/my-board/kernel.config&quot;</span><br><span class="line">  |     `----</span><br><span class="line">  |</span><br><span class="line">  |- patches/linux/0001-some-change.patch</span><br><span class="line">  |- patches/linux/0002-some-other-change.patch</span><br><span class="line">  |- patches/busybox/0001-fix-something.patch</span><br><span class="line">  |</span><br><span class="line">  |- board/my-board/kernel.config</span><br><span class="line">  |- board/my-board/overlay/var/www/index.html</span><br><span class="line">  |- board/my-board/overlay/var/www/my.css</span><br><span class="line">  |- board/my-board/flash-image</span><br><span class="line">  `- board/my-board/post-image.sh</span><br><span class="line">        |#!/bin/sh</span><br><span class="line">        |generate-my-binary-image \</span><br><span class="line">        |    --root $&#123;BINARIES_DIR&#125;/rootfs.tar \</span><br><span class="line">        |    --kernel $&#123;BINARIES_DIR&#125;/zImage \</span><br><span class="line">        |    --dtb $&#123;BINARIES_DIR&#125;/my-board.dtb \</span><br><span class="line">        |    --output $&#123;BINARIES_DIR&#125;/image.bin</span><br><span class="line">        `----</span><br></pre></td></tr></table></figure>
<p>The br2-external tree will then be visible in the menuconfig (with the layout expanded):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">External options  ---&gt;</span><br><span class="line">    *** Example br2-external tree (in /path/to/br2-ext-tree/)</span><br><span class="line">    [ ] pkg-1</span><br><span class="line">    [ ] pkg-2</span><br><span class="line">    (0x10AD) my-board flash address</span><br></pre></td></tr></table></figure>
<p>If you are using more than one br2-external tree, it would look like (with the layout expanded and the second one with name <code>FOO_27</code> but no <code>desc:</code> field in <code>external.desc</code>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">External options  ---&gt;</span><br><span class="line">    Example br2-external tree  ---&gt;</span><br><span class="line">        *** Example br2-external tree (in /path/to/br2-ext-tree)</span><br><span class="line">        [ ] pkg-1</span><br><span class="line">        [ ] pkg-2</span><br><span class="line">        (0x10AD) my-board flash address</span><br><span class="line">    FOO_27  ---&gt;</span><br><span class="line">        *** FOO_27 (in /path/to/another-br2-ext)</span><br><span class="line">        [ ] foo</span><br><span class="line">        [ ] bar</span><br></pre></td></tr></table></figure>
<p>Additionally, the jpeg provider will be visible in the jpeg choice:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Target packages  ---&gt;</span><br><span class="line">    Libraries  ---&gt;</span><br><span class="line">        Graphics  ---&gt;</span><br><span class="line">            [*] jpeg support</span><br><span class="line">                jpeg variant ()  ---&gt;</span><br><span class="line">                    ( ) jpeg</span><br><span class="line">                    ( ) jpeg-turbo</span><br><span class="line">                        *** jpeg from: Example br2-external tree ***</span><br><span class="line">                    (X) my-jpeg</span><br><span class="line">                        *** jpeg from: FOO_27 ***</span><br><span class="line">                    ( ) another-jpeg</span><br></pre></td></tr></table></figure>
<p>And similarly for the toolchains:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Toolchain  ---&gt;</span><br><span class="line">    Toolchain ()  ---&gt;</span><br><span class="line">        ( ) Custom toolchain</span><br><span class="line">            *** Toolchains from: Example br2-external tree ***</span><br><span class="line">        (X) my custom toolchain</span><br></pre></td></tr></table></figure>
<p><strong>Note.</strong> The toolchain options in <code>toolchain/toolchain-external-mine/Config.in.options</code> will not appear in the <code>Toolchain</code> menu. They must be explicitly included from within the br2-external’s top-level <code>Config.in</code> and will thus appear in the <code>External options</code> menu.</p>
<h2 id="93-storing-the-buildroot-configuration"><a class="markdownIt-Anchor" href="#93-storing-the-buildroot-configuration"></a> 9.3. Storing the Buildroot configuration</h2>
<p>The Buildroot configuration can be stored using the command <code>make savedefconfig</code>.</p>
<p>This strips the Buildroot configuration down by removing configuration options that are at their default value. The result is stored in a file called <code>defconfig</code>. If you want to save it in another place, change the <code>BR2_DEFCONFIG</code> option in the Buildroot configuration itself, or call make with <code>make savedefconfig BR2_DEFCONFIG=&lt;path-to-defconfig&gt;</code>.</p>
<p>The recommended place to store this defconfig is <code>configs/&lt;boardname&gt;_defconfig</code>. If you follow this recommendation, the configuration will be listed in <code>make list-defconfigs</code> and can be set again by running <code>make &lt;boardname&gt;_defconfig</code>.</p>
<p>Alternatively, you can copy the file to any other place and rebuild with <code>make defconfig BR2_DEFCONFIG=&lt;path-to-defconfig-file&gt;</code>.</p>
<h2 id="94-storing-the-configuration-of-other-components"><a class="markdownIt-Anchor" href="#94-storing-the-configuration-of-other-components"></a> 9.4. Storing the configuration of other components</h2>
<p>The configuration files for BusyBox, the Linux kernel, Barebox, U-Boot and uClibc should be stored as well if changed. For each of these components, a Buildroot configuration option exists to point to an input configuration file, e.g. <code>BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE</code>. To store their configuration, set these configuration options to a path where you want to save the configuration files, and then use the helper targets described below to actually store the configuration.</p>
<p>As explained in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, the recommended path to store these configuration files is <code>board/&lt;company&gt;/&lt;boardname&gt;/foo.config</code>.</p>
<p>Make sure that you create a configuration file <em>before</em> changing the <code>BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE</code> etc. options. Otherwise, Buildroot will try to access this config file, which doesn’t exist yet, and will fail. You can create the configuration file by running <code>make linux-menuconfig</code> etc.</p>
<p>Buildroot provides a few helper targets to make the saving of configuration files easier.</p>
<ul>
<li><code>make linux-update-defconfig</code> saves the linux configuration to the path specified by <code>BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE</code>. It simplifies the config file by removing default values. However, this only works with kernels starting from 2.6.33. For earlier kernels, use <code>make linux-update-config</code>.</li>
<li><code>make busybox-update-config</code> saves the busybox configuration to the path specified by <code>BR2_PACKAGE_BUSYBOX_CONFIG</code>.</li>
<li><code>make uclibc-update-config</code> saves the uClibc configuration to the path specified by <code>BR2_UCLIBC_CONFIG</code>.</li>
<li><code>make barebox-update-defconfig</code> saves the barebox configuration to the path specified by <code>BR2_TARGET_BAREBOX_CUSTOM_CONFIG_FILE</code>.</li>
<li><code>make uboot-update-defconfig</code> saves the U-Boot configuration to the path specified by <code>BR2_TARGET_UBOOT_CUSTOM_CONFIG_FILE</code>.</li>
<li>For at91bootstrap3, no helper exists so you have to copy the config file manually to <code>BR2_TARGET_AT91BOOTSTRAP3_CUSTOM_CONFIG_FILE</code>.</li>
</ul>
<h2 id="95-customizing-the-generated-target-filesystem"><a class="markdownIt-Anchor" href="#95-customizing-the-generated-target-filesystem"></a> 9.5. Customizing the generated target filesystem</h2>
<p>Besides changing the configuration through <code>make *config</code>, there are a few other ways to customize the resulting target filesystem.</p>
<p>The two recommended methods, which can co-exist, are root filesystem overlay(s) and post build script(s).</p>
<ul>
<li>
<p>Root filesystem overlays (<code>BR2_ROOTFS_OVERLAY</code>)</p>
<p>A filesystem overlay is a tree of files that is copied directly over the target filesystem after it has been built. To enable this feature, set config option <code>BR2_ROOTFS_OVERLAY</code> (in the <code>System configuration</code> menu) to the root of the overlay. You can even specify multiple overlays, space-separated. If you specify a relative path, it will be relative to the root of the Buildroot tree. Hidden directories of version control systems, like <code>.git</code>, <code>.svn</code>, <code>.hg</code>, etc., files called <code>.empty</code> and files ending in <code>~</code> are excluded from the copy.When <code>BR2_ROOTFS_MERGED_USR</code> is enabled, then the overlay must not contain the <em>/bin</em>, <em>/lib</em> or <em>/sbin</em> directories, as Buildroot will create them as symbolic links to the relevant folders in <em>/usr</em>. In such a situation, should the overlay have any programs or libraries, they should be placed in <em>/usr/bin</em>, <em>/usr/sbin</em> and <em>/usr/lib</em>.As shown in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, the recommended path for this overlay is <code>board/&lt;company&gt;/&lt;boardname&gt;/rootfs-overlay</code>.</p>
</li>
<li>
<p>Post-build scripts (<code>BR2_ROOTFS_POST_BUILD_SCRIPT</code>)</p>
<p>Post-build scripts are shell scripts called <em>after</em> Buildroot builds all the selected software, but <em>before</em> the rootfs images are assembled. To enable this feature, specify a space-separated list of post-build scripts in config option <code>BR2_ROOTFS_POST_BUILD_SCRIPT</code> (in the <code>System configuration</code> menu). If you specify a relative path, it will be relative to the root of the Buildroot tree.Using post-build scripts, you can remove or modify any file in your target filesystem. You should, however, use this feature with care. Whenever you find that a certain package generates wrong or unneeded files, you should fix that package rather than work around it with some post-build cleanup <a target="_blank" rel="noopener" href="http://scripts.As">scripts.As</a> shown in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, the recommended path for this script is <code>board/&lt;company&gt;/&lt;boardname&gt;/post_build.sh</code>.The post-build scripts are run with the main Buildroot tree as current working directory. The path to the target filesystem is passed as the first argument to each script. If the config option <code>BR2_ROOTFS_POST_SCRIPT_ARGS</code> is not empty, these arguments will be passed to the script too. All the scripts will be passed the exact same set of arguments, it is not possible to pass different sets of arguments to each script.<code>Note that the arguments from +BR2_ROOTFS_POST_SCRIPT_ARGS+ will also be passed to post-image and post-fakeroot scripts. If you want to use arguments that are only used for the post-build scripts you can use +BR2_ROOTFS_POST_BUILD_SCRIPT_ARGS+.</code></p>
</li>
</ul>
<p>+ In addition, you may also use these environment variables:</p>
<ul>
<li><code>BR2_CONFIG</code>: the path to the Buildroot .config file</li>
<li><code>CONFIG_DIR</code>: the directory containing the .config file, and therefore the top-level Buildroot Makefile to use (which is correct for both in-tree and out-of-tree builds)</li>
<li><code>HOST_DIR</code>, <code>STAGING_DIR</code>, <code>TARGET_DIR</code>: see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">Section 18.6.2, “<code>generic-package</code> reference”</a></li>
<li><code>BUILD_DIR</code>: the directory where packages are extracted and built</li>
<li><code>BINARIES_DIR</code>: the place where all binary files (aka images) are stored</li>
<li><code>BASE_DIR</code>: the base output directory</li>
</ul>
<p>Below three more methods of customizing the target filesystem are described, but they are not recommended.</p>
<ul>
<li>
<p>Direct modification of the target filesystem</p>
<p>For temporary modifications, you can modify the target filesystem directly and rebuild the image. The target filesystem is available under <code>output/target/</code>. After making your changes, run <code>make</code> to rebuild the target filesystem image.This method allows you to do anything to the target filesystem, but if you need to clean your Buildroot tree using <code>make clean</code>, these changes will be lost. Such cleaning is necessary in several cases, refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#full-rebuild">Section 8.2, “Understanding when a full rebuild is necessary”</a> for details. This solution is therefore only useful for quick tests: <em>changes do not survive the <code>make clean</code> command</em>. Once you have validated your changes, you should make sure that they will persist after a <code>make clean</code>, using a root filesystem overlay or a post-build script.</p>
</li>
<li>
<p>Custom target skeleton (<code>BR2_ROOTFS_SKELETON_CUSTOM</code>)</p>
<p>The root filesystem image is created from a target skeleton, on top of which all packages install their files. The skeleton is copied to the target directory <code>output/target</code> before any package is built and installed. The default target skeleton provides the standard Unix filesystem layout and some basic init scripts and configuration files.If the default skeleton (available under <code>system/skeleton</code>) does not match your needs, you would typically use a root filesystem overlay or post-build script to adapt it. However, if the default skeleton is entirely different than what you need, using a custom skeleton may be more <a target="_blank" rel="noopener" href="http://suitable.To">suitable.To</a> enable this feature, enable config option <code>BR2_ROOTFS_SKELETON_CUSTOM</code> and set <code>BR2_ROOTFS_SKELETON_CUSTOM_PATH</code> to the path of your custom skeleton. Both options are available in the <code>System configuration</code> menu. If you specify a relative path, it will be relative to the root of the Buildroot tree.Custom skeletons don’t need to contain the <em>/bin</em>, <em>/lib</em> or <em>/sbin</em> directories, since they are created automatically during the build. When <code>BR2_ROOTFS_MERGED_USR</code> is enabled, then the custom skeleton must not contain the <em>/bin</em>, <em>/lib</em> or <em>/sbin</em> directories, as Buildroot will create them as symbolic links to the relevant folders in <em>/usr</em>. In such a situation, should the skeleton have any programs or libraries, they should be placed in <em>/usr/bin</em>, <em>/usr/sbin</em> and <em>/usr/lib</em>.This method is not recommended because it duplicates the entire skeleton, which prevents taking advantage of the fixes or improvements brought to the default skeleton in later Buildroot releases.</p>
</li>
<li>
<p>Post-fakeroot scripts (<code>BR2_ROOTFS_POST_FAKEROOT_SCRIPT</code>)</p>
<p>When aggregating the final images, some parts of the process requires root rights: creating device nodes in <code>/dev</code>, setting permissions or ownership to files and directories… To avoid requiring actual root rights, Buildroot uses <code>fakeroot</code> to simulate root rights. This is not a complete substitute for actually being root, but is enough for what Buildroot needs.Post-fakeroot scripts are shell scripts that are called at the <em>end</em> of the fakeroot phase, <em>right before</em> the filesystem image generator is called. As such, they are called in the fakeroot context.Post-fakeroot scripts can be useful in case you need to tweak the filesystem to do modifications that are usually only available to the root user.<strong>Note:</strong> It is recommended to use the existing mechanisms to set file permissions or create entries in <code>/dev</code> (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-device-permission">Section 9.5.1, “Setting file permissions and ownership and adding custom devices nodes”</a>) or to create users (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-users">Section 9.6, “Adding custom user accounts”</a>)<strong>Note:</strong> The difference between post-build scripts (above) and fakeroot scripts, is that post-build scripts are not called in the fakeroot context.<strong>Note:</strong> Using <code>fakeroot</code> is not an absolute substitute for actually being root. <code>fakeroot</code> only ever fakes the file access rights and types (regular, block-or-char device…) and uid/gid; these are emulated in-memory.</p>
</li>
</ul>
<h3 id="951-setting-file-permissions-and-ownership-and-adding-custom-devices-nodes"><a class="markdownIt-Anchor" href="#951-setting-file-permissions-and-ownership-and-adding-custom-devices-nodes"></a> 9.5.1. Setting file permissions and ownership and adding custom devices nodes</h3>
<p>Sometimes it is needed to set specific permissions or ownership on files or device nodes. For example, certain files may need to be owned by root. Since the post-build scripts are not run as root, you cannot do such changes from there unless you use an explicit fakeroot from the post-build script.</p>
<p>Instead, Buildroot provides support for so-called <em>permission tables</em>. To use this feature, set config option <code>BR2_ROOTFS_DEVICE_TABLE</code> to a space-separated list of permission tables, regular text files following the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#makedev-syntax">makedev syntax</a>.</p>
<p>If you are using a static device table (i.e. not using <code>devtmpfs</code>, <code>mdev</code>, or <code>(e)udev</code>) then you can add device nodes using the same syntax, in so-called <em>device tables</em>. To use this feature, set config option <code>BR2_ROOTFS_STATIC_DEVICE_TABLE</code> to a space-separated list of device tables.</p>
<p>As shown in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, the recommended location for such files is <code>board/&lt;company&gt;/&lt;boardname&gt;/</code>.</p>
<p>It should be noted that if the specific permissions or device nodes are related to a specific application, you should set variables <code>FOO_PERMISSIONS</code> and <code>FOO_DEVICES</code> in the package’s <code>.mk</code> file instead (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">Section 18.6.2, “<code>generic-package</code> reference”</a>).</p>
<h2 id="96-adding-custom-user-accounts"><a class="markdownIt-Anchor" href="#96-adding-custom-user-accounts"></a> 9.6. Adding custom user accounts</h2>
<p>Sometimes it is needed to add specific users in the target system. To cover this requirement, Buildroot provides support for so-called <em>users tables</em>. To use this feature, set config option <code>BR2_ROOTFS_USERS_TABLES</code> to a space-separated list of users tables, regular text files following the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#makeuser-syntax">makeusers syntax</a>.</p>
<p>As shown in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, the recommended location for such files is <code>board/&lt;company&gt;/&lt;boardname&gt;/</code>.</p>
<p>It should be noted that if the custom users are related to a specific application, you should set variable <code>FOO_USERS</code> in the package’s <code>.mk</code> file instead (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">Section 18.6.2, “<code>generic-package</code> reference”</a>).</p>
<h2 id="97-customization-after-the-images-have-been-created"><a class="markdownIt-Anchor" href="#97-customization-after-the-images-have-been-created"></a> 9.7. Customization <em>after</em> the images have been created</h2>
<p>While post-build scripts (<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#rootfs-custom">Section 9.5, “Customizing the generated target filesystem”</a>) are run <em>before</em> building the filesystem image, kernel and bootloader, <em><strong>*post-image scripts*</strong></em> can be used to perform some specific actions <em>after</em> all images have been created.</p>
<p>Post-image scripts can for example be used to automatically extract your root filesystem tarball in a location exported by your NFS server, or to create a special firmware image that bundles your root filesystem and kernel image, or any other custom action required for your project.</p>
<p>To enable this feature, specify a space-separated list of post-image scripts in config option <code>BR2_ROOTFS_POST_IMAGE_SCRIPT</code> (in the <code>System configuration</code> menu). If you specify a relative path, it will be relative to the root of the Buildroot tree.</p>
<p>Just like post-build scripts, post-image scripts are run with the main Buildroot tree as current working directory. The path to the <code>images</code> output directory is passed as the first argument to each script. If the config option <code>BR2_ROOTFS_POST_SCRIPT_ARGS</code> is not empty, these arguments will be passed to the script too. All the scripts will be passed the exact same set of arguments, it is not possible to pass different sets of arguments to each script.</p>
<p>Note that the arguments from <code>BR2_ROOTFS_POST_SCRIPT_ARGS</code> will also be passed to post-build and post-fakeroot scripts. If you want to use arguments that are only used for the post-image scripts you can use <code>BR2_ROOTFS_POST_IMAGE_SCRIPT_ARGS</code>.</p>
<p>Again just like for the post-build scripts, the scripts have access to the environment variables <code>BR2_CONFIG</code>, <code>HOST_DIR</code>, <code>STAGING_DIR</code>, <code>TARGET_DIR</code>, <code>BUILD_DIR</code>, <code>BINARIES_DIR</code>, <code>CONFIG_DIR</code> and <code>BASE_DIR</code>.</p>
<p>The post-image scripts will be executed as the user that executes Buildroot, which should normally <em>not</em> be the root user. Therefore, any action requiring root permissions in one of these scripts will require special handling (usage of fakeroot or sudo), which is left to the script developer.</p>
<h2 id="98-adding-project-specific-patches-and-hashes"><a class="markdownIt-Anchor" href="#98-adding-project-specific-patches-and-hashes"></a> 9.8. Adding project-specific patches and hashes</h2>
<h3 id="981-providing-extra-patches"><a class="markdownIt-Anchor" href="#981-providing-extra-patches"></a> 9.8.1. Providing extra patches</h3>
<p>It is sometimes useful to apply <em>extra</em> patches to packages - on top of those provided in Buildroot. This might be used to support custom features in a project, for example, or when working on a new architecture.</p>
<p>The <code>BR2_GLOBAL_PATCH_DIR</code> configuration option can be used to specify a space separated list of one or more directories containing package patches.</p>
<p>For a specific version <code>&lt;packageversion&gt;</code> of a specific package <code>&lt;packagename&gt;</code>, patches are applied from <code>BR2_GLOBAL_PATCH_DIR</code> as follows:</p>
<ol>
<li>For every directory - <code>&lt;global-patch-dir&gt;</code> - that exists in <code>BR2_GLOBAL_PATCH_DIR</code>, a <code>&lt;package-patch-dir&gt;</code> will be determined as follows:
<ul>
<li><code>&lt;global-patch-dir&gt;/&lt;packagename&gt;/&lt;packageversion&gt;/</code> if the directory exists.</li>
<li>Otherwise, <code>&lt;global-patch-dir&gt;/&lt;packagename&gt;</code> if the directory exists.</li>
</ul>
</li>
<li>Patches will then be applied from a <code>&lt;package-patch-dir&gt;</code> as follows:
<ul>
<li>If a <code>series</code> file exists in the package directory, then patches are applied according to the <code>series</code> file;</li>
<li>Otherwise, patch files matching <code>*.patch</code> are applied in alphabetical order. So, to ensure they are applied in the right order, it is highly recommended to name the patch files like this: <code>&lt;number&gt;-&lt;description&gt;.patch</code>, where <code>&lt;number&gt;</code> refers to the <em>apply order</em>.</li>
</ul>
</li>
</ol>
<p>For information about how patches are applied for a package, see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#patch-apply-order">Section 19.2, “How patches are applied”</a></p>
<p>The <code>BR2_GLOBAL_PATCH_DIR</code> option is the preferred method for specifying a custom patch directory for packages. It can be used to specify a patch directory for any package in buildroot. It should also be used in place of the custom patch directory options that are available for packages such as U-Boot and Barebox. By doing this, it will allow a user to manage their patches from one top-level directory.</p>
<p>The exception to <code>BR2_GLOBAL_PATCH_DIR</code> being the preferred method for specifying custom patches is <code>BR2_LINUX_KERNEL_PATCH</code>. <code>BR2_LINUX_KERNEL_PATCH</code> should be used to specify kernel patches that are available at a URL. <em><strong>*Note:*</strong></em> <code>BR2_LINUX_KERNEL_PATCH</code> specifies kernel patches that are applied after patches available in <code>BR2_GLOBAL_PATCH_DIR</code>, as it is done from a post-patch hook of the Linux package.</p>
<h3 id="982-providing-extra-hashes"><a class="markdownIt-Anchor" href="#982-providing-extra-hashes"></a> 9.8.2. Providing extra hashes</h3>
<p>Buildroot bundles a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#adding-packages-hash">list of hashes</a> against which it checks the integrity of the downloaded archives, or of those it generates locally from VCS checkouts. However, it can only do so for the known versions; for packages where it is possible to specify a custom version (e.g. a custom version string, a remote tarball URL, or a VCS repository location and changeset), Buildroot can’t carry hashes for those.</p>
<p>For users concerned with the integrity of such downloads, it is possible to provide a list of hashes that Buildroot can use to check arbitrary downloaded files. Those extra hashes are looked up similarly to the extra patches (above); for each directory in <code>BR2_GLOBAL_PATCH_DIR</code>, the first file to exist is used to check a package download:</p>
<ul>
<li><code>&lt;global-patch-dir&gt;/&lt;packagename&gt;/&lt;packageversion&gt;/&lt;packagename&gt;.hash</code></li>
<li><code>&lt;global-patch-dir&gt;/&lt;packagename&gt;/&lt;packagename&gt;.hash</code></li>
</ul>
<p>The <code>utils/add-custom-hashes</code> script can be used to generate these files.</p>
<h2 id="99-adding-project-specific-packages"><a class="markdownIt-Anchor" href="#99-adding-project-specific-packages"></a> 9.9. Adding project-specific packages</h2>
<p>In general, any new package should be added directly in the <code>package</code> directory and submitted to the Buildroot upstream project. How to add packages to Buildroot in general is explained in full detail in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#adding-packages">Chapter 18, <em>Adding new packages to Buildroot</em></a> and will not be repeated here. However, your project may need some proprietary packages that cannot be upstreamed. This section will explain how you can keep such project-specific packages in a project-specific directory.</p>
<p>As shown in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-dir-structure">Section 9.1, “Recommended directory structure”</a>, the recommended location for project-specific packages is <code>package/&lt;company&gt;/</code>. If you are using the br2-external tree feature (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#outside-br-custom">Section 9.2, “Keeping customizations outside of Buildroot”</a>) the recommended location is to put them in a sub-directory named <code>package/</code> in your br2-external tree.</p>
<p>However, Buildroot will not be aware of the packages in this location, unless we perform some additional steps. As explained in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#adding-packages">Chapter 18, <em>Adding new packages to Buildroot</em></a>, a package in Buildroot basically consists of two files: a <code>.mk</code> file (describing how to build the package) and a <code>Config.in</code> file (describing the configuration options for this package).</p>
<p>Buildroot will automatically include the <code>.mk</code> files in first-level subdirectories of the <code>package</code> directory (using the pattern <code>package/*/*.mk</code>). If we want Buildroot to include <code>.mk</code> files from deeper subdirectories (like <code>package/&lt;company&gt;/package1/</code>) then we simply have to add a <code>.mk</code> file in a first-level subdirectory that includes these additional <code>.mk</code> files. Therefore, create a file <code>package/&lt;company&gt;/&lt;company&gt;.mk</code> with following contents (assuming you have only one extra directory level below <code>package/&lt;company&gt;/</code>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(sort $(wildcard package/&lt;company&gt;/*/*.mk))</span><br></pre></td></tr></table></figure>
<p>For the <code>Config.in</code> files, create a file <code>package/&lt;company&gt;/Config.in</code> that includes the <code>Config.in</code> files of all your packages. An exhaustive list has to be provided since wildcards are not supported in the source command of kconfig. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &quot;package/&lt;company&gt;/package1/Config.in&quot;</span><br><span class="line">source &quot;package/&lt;company&gt;/package2/Config.in&quot;</span><br></pre></td></tr></table></figure>
<p>Include this new file <code>package/&lt;company&gt;/Config.in</code> from <code>package/Config.in</code>, preferably in a company-specific menu to make merges with future Buildroot versions easier.</p>
<p>If using a br2-external tree, refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#outside-br-custom">Section 9.2, “Keeping customizations outside of Buildroot”</a> for how to fill in those files.</p>
<h2 id="910-quick-guide-to-storing-your-project-specific-customizations"><a class="markdownIt-Anchor" href="#910-quick-guide-to-storing-your-project-specific-customizations"></a> 9.10. Quick guide to storing your project-specific customizations</h2>
<p>Earlier in this chapter, the different methods for making project-specific customizations have been described. This section will now summarize all this by providing step-by-step instructions to storing your project-specific customizations. Clearly, the steps that are not relevant to your project can be skipped.</p>
<ol>
<li><code>make menuconfig</code> to configure toolchain, packages and kernel.</li>
<li><code>make linux-menuconfig</code> to update the kernel config, similar for other configuration like busybox, uclibc, …</li>
<li><code>mkdir -p board/&lt;manufacturer&gt;/&lt;boardname&gt;</code></li>
<li>Set the following options to <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/&lt;package&gt;.config</code> (as far as they are relevant):
<ul>
<li><code>BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE</code></li>
<li><code>BR2_PACKAGE_BUSYBOX_CONFIG</code></li>
<li><code>BR2_UCLIBC_CONFIG</code></li>
<li><code>BR2_TARGET_AT91BOOTSTRAP3_CUSTOM_CONFIG_FILE</code></li>
<li><code>BR2_TARGET_BAREBOX_CUSTOM_CONFIG_FILE</code></li>
<li><code>BR2_TARGET_UBOOT_CUSTOM_CONFIG_FILE</code></li>
</ul>
</li>
<li>Write the configuration files:
<ul>
<li><code>make linux-update-defconfig</code></li>
<li><code>make busybox-update-config</code></li>
<li><code>make uclibc-update-config</code></li>
<li><code>cp &lt;output&gt;/build/at91bootstrap3-*/.config board/&lt;manufacturer&gt;/&lt;boardname&gt;/at91bootstrap3.config</code></li>
<li><code>make barebox-update-defconfig</code></li>
<li><code>make uboot-update-defconfig</code></li>
</ul>
</li>
<li>Create <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/rootfs-overlay/</code> and fill it with additional files you need on your rootfs, e.g. <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/rootfs-overlay/etc/inittab</code>. Set <code>BR2_ROOTFS_OVERLAY</code> to <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/rootfs-overlay</code>.</li>
<li>Create a post-build script <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/post_build.sh</code>. Set <code>BR2_ROOTFS_POST_BUILD_SCRIPT</code> to <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/post_build.sh</code></li>
<li>If additional setuid permissions have to be set or device nodes have to be created, create <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/device_table.txt</code> and add that path to <code>BR2_ROOTFS_DEVICE_TABLE</code>.</li>
<li>If additional user accounts have to be created, create <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/users_table.txt</code> and add that path to <code>BR2_ROOTFS_USERS_TABLES</code>.</li>
<li>To add custom patches to certain packages, set <code>BR2_GLOBAL_PATCH_DIR</code> to <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;/patches/</code> and add your patches for each package in a subdirectory named after the package. Each patch should be called <code>&lt;packagename&gt;-&lt;num&gt;-&lt;description&gt;.patch</code>.</li>
<li>Specifically for the Linux kernel, there also exists the option <code>BR2_LINUX_KERNEL_PATCH</code> with as main advantage that it can also download patches from a URL. If you do not need this, <code>BR2_GLOBAL_PATCH_DIR</code> is preferred. U-Boot, Barebox, at91bootstrap and at91bootstrap3 also have separate options, but these do not provide any advantage over <code>BR2_GLOBAL_PATCH_DIR</code> and will likely be removed in the future.</li>
<li>If you need to add project-specific packages, create <code>package/&lt;manufacturer&gt;/</code> and place your packages in that directory. Create an overall <code>&lt;manufacturer&gt;.mk</code> file that includes the <code>.mk</code> files of all your packages. Create an overall <code>Config.in</code> file that sources the <code>Config.in</code> files of all your packages. Include this <code>Config.in</code> file from Buildroot’s <code>package/Config.in</code> file.</li>
<li><code>make savedefconfig</code> to save the buildroot configuration.</li>
<li><code>cp defconfig configs/&lt;boardname&gt;_defconfig</code></li>
</ol>
<h2 id="chapter-10-integration-topics"><a class="markdownIt-Anchor" href="#chapter-10-integration-topics"></a> Chapter 10. Integration topics</h2>
<p>This chapter discusses how various things are integrated at system level. Buildroot is highly configurable, almost everything discussed here can be changed or overridden by <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#rootfs-custom">rootfs overlay or custom skeleton</a> configuration.</p>
<h2 id="101-systemd"><a class="markdownIt-Anchor" href="#101-systemd"></a> 10.1. Systemd</h2>
<p>This chapter describes the decisions taken in Buildroot’s integration of systemd, and how various use cases can be implemented.</p>
<h3 id="1011-dbus-daemon"><a class="markdownIt-Anchor" href="#1011-dbus-daemon"></a> 10.1.1. DBus daemon</h3>
<p>Systemd requires a DBus daemon. There are two options for it: traditional dbus (<code>BR2_PACKAGE_DBUS</code>) and bus1 dbus-broker (<code>BR2_PACKAGE_DBUS_BROKER</code>). At least one of them must be chosen. If both are included in the configuration, dbus-broker will be used as system bus, but the traditional dbus-daemon is still installed as well and can be used as session bus. Also its tools (e.g. <code>dbus-send</code>) can be used (systemd itself has <code>busctl</code> as an alternative). In addition, the traditional dbus package is the only one that provides <code>libdbus</code>, which is used by many packages as dbus integration library.</p>
<p>Both in the dbus and in the dbus-broker case, the daemon runs as user <code>dbus</code>. The DBus configuration files are also identical for both.</p>
<p>To make sure that only one of the two daemons is started as system bus, the systemd activation files of the dbus package (<code>dbus.socket</code> and the <code>dbus.service</code> symlink in <code>multi-user.target.wants</code>) are removed when dbus-broker is selected.</p>
<h2 id="102-using-selinux-in-buildroot"><a class="markdownIt-Anchor" href="#102-using-selinux-in-buildroot"></a> 10.2. Using SELinux in Buildroot</h2>
<p><a target="_blank" rel="noopener" href="https://selinuxproject.org/">SELinux</a> is a Linux kernel security module enforcing access control policies. In addition to the traditional file permissions and access control lists, <code>SELinux</code> allows to write rules for users or processes to access specific functions of resources (files, sockets…).</p>
<p><em>SELinux</em> has three modes of operation:</p>
<ul>
<li><em>Disabled</em>: the policy is not applied</li>
<li><em>Permissive</em>: the policy is applied, and non-authorized actions are simply logged. This mode is often used for troubleshooting SELinux issues.</li>
<li><em>Enforcing</em>: the policy is applied, and non-authorized actions are denied</li>
</ul>
<p>In Buildroot the mode of operation is controlled by the <code>BR2_PACKAGE_REFPOLICY_POLICY_STATE_*</code> configuration options. The Linux kernel also has various configuration options that affect how <code>SELinux</code> is enabled (see <code>security/selinux/Kconfig</code> in the Linux kernel sources).</p>
<p>By default in Buildroot the <code>SELinux</code> policy is provided by the upstream <a target="_blank" rel="noopener" href="https://github.com/SELinuxProject/refpolicy">refpolicy</a> project, enabled with <code>BR2_PACKAGE_REFPOLICY</code>.</p>
<h3 id="1021-enabling-selinux-support"><a class="markdownIt-Anchor" href="#1021-enabling-selinux-support"></a> 10.2.1. Enabling SELinux support</h3>
<p>To have proper support for <code>SELinux</code> in a Buildroot generated system, the following configuration options must be enabled:</p>
<ul>
<li><code>BR2_PACKAGE_LIBSELINUX</code></li>
<li><code>BR2_PACKAGE_REFPOLICY</code></li>
</ul>
<p>In addition, your filesystem image format must support extended attributes.</p>
<h3 id="1022-selinux-policy-tweaking"><a class="markdownIt-Anchor" href="#1022-selinux-policy-tweaking"></a> 10.2.2. SELinux policy tweaking</h3>
<p>The <code>SELinux refpolicy</code> contains modules that can be enabled or disabled when being built. Each module provide a number of <code>SELinux</code> rules. In Buildroot the non-base modules are disabled by default and several ways to enable such modules are provided:</p>
<ul>
<li>Packages can enable a list of <code>SELinux</code> modules within the <code>refpolicy</code> using the <code>&lt;packagename&gt;_SELINUX_MODULES</code> variable.</li>
<li>Packages can provide additional <code>SELinux</code> modules by putting them (.fc, .if and .te files) in <code>package/&lt;packagename&gt;/selinux/</code>.</li>
<li>Extra <code>SELinux</code> modules can be added in directories pointed by the <code>BR2_REFPOLICY_EXTRA_MODULES_DIRS</code> configuration option.</li>
<li>Additional modules in the <code>refpolicy</code> can be enabled if listed in the <code>BR2_REFPOLICY_EXTRA_MODULES_DEPENDENCIES</code> configuration option.</li>
</ul>
<p>Buildroot also allows to completely override the <code>refpolicy</code>. This allows to provide a full custom policy designed specifically for a given system. When going this way, all of the above mechanisms are disabled: no extra <code>SElinux</code> module is added to the policy, and all the available modules within the custom policy are enabled and built into the final binary policy. The custom policy must be a fork of the official <a target="_blank" rel="noopener" href="https://github.com/SELinuxProject/refpolicy">refpolicy</a>.</p>
<p>In order to fully override the <code>refpolicy</code> the following configuration variables have to be set:</p>
<ul>
<li><code>BR2_PACKAGE_REFPOLICY_CUSTOM_GIT</code></li>
<li><code>BR2_PACKAGE_REFPOLICY_CUSTOM_REPO_URL</code></li>
<li><code>BR2_PACKAGE_REFPOLICY_CUSTOM_REPO_VERSION</code></li>
</ul>
<h2 id="chapter-11-frequently-asked-questions-troubleshooting"><a class="markdownIt-Anchor" href="#chapter-11-frequently-asked-questions-troubleshooting"></a> Chapter 11. Frequently Asked Questions &amp; Troubleshooting</h2>
<h2 id="111-the-boot-hangs-after-starting-network"><a class="markdownIt-Anchor" href="#111-the-boot-hangs-after-starting-network"></a> 11.1. The boot hangs after <em>Starting network…</em></h2>
<p>If the boot process seems to hang after the following messages (messages not necessarily exactly similar, depending on the list of packages selected):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Freeing init memory: 3972K</span><br><span class="line">Initializing random number generator... done.</span><br><span class="line">Starting network...</span><br><span class="line">Starting dropbear sshd: generating rsa key... generating dsa key... OK</span><br></pre></td></tr></table></figure>
<p>then it means that your system is running, but didn’t start a shell on the serial console. In order to have the system start a shell on your serial console, you have to go into the Buildroot configuration, in <code>System configuration</code>, modify <code>Run a getty (login prompt) after boot</code> and set the appropriate port and baud rate in the <code>getty options</code> submenu. This will automatically tune the <code>/etc/inittab</code> file of the generated system so that a shell starts on the correct serial port.</p>
<h2 id="112-why-is-there-no-compiler-on-the-target"><a class="markdownIt-Anchor" href="#112-why-is-there-no-compiler-on-the-target"></a> 11.2. Why is there no compiler on the target?</h2>
<p>It has been decided that support for the <em>native compiler on the target</em> would be stopped from the Buildroot-2012.11 release because:</p>
<ul>
<li>this feature was neither maintained nor tested, and often broken;</li>
<li>this feature was only available for Buildroot toolchains;</li>
<li>Buildroot mostly targets <em>small</em> or <em>very small</em> target hardware with limited resource onboard (CPU, ram, mass-storage), for which compiling on the target does not make much sense;</li>
<li>Buildroot aims at easing the cross-compilation, making native compilation on the target unnecessary.</li>
</ul>
<p>If you need a compiler on your target anyway, then Buildroot is not suitable for your purpose. In such case, you need a <em>real distribution</em> and you should opt for something like:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.openembedded.org/">openembedded</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yoctoproject.org/">yocto</a></li>
<li><a target="_blank" rel="noopener" href="https://www.debian.org/ports/">Debian</a></li>
<li><a target="_blank" rel="noopener" href="https://fedoraproject.org/wiki/Architectures">Fedora</a></li>
<li><a target="_blank" rel="noopener" href="http://en.opensuse.org/Portal:ARM">openSUSE ARM</a></li>
<li><a target="_blank" rel="noopener" href="http://archlinuxarm.org/">Arch Linux ARM</a></li>
<li>…</li>
</ul>
<h2 id="113-why-are-there-no-development-files-on-the-target"><a class="markdownIt-Anchor" href="#113-why-are-there-no-development-files-on-the-target"></a> 11.3. Why are there no development files on the target?</h2>
<p>Since there is no compiler available on the target (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#faq-no-compiler-on-target">Section 11.2, “Why is there no compiler on the target?”</a>), it does not make sense to waste space with headers or static libraries.</p>
<p>Therefore, those files are always removed from the target since the Buildroot-2012.11 release.</p>
<h2 id="114-why-is-there-no-documentation-on-the-target"><a class="markdownIt-Anchor" href="#114-why-is-there-no-documentation-on-the-target"></a> 11.4. Why is there no documentation on the target?</h2>
<p>Because Buildroot mostly targets <em>small</em> or <em>very small</em> target hardware with limited resource onboard (CPU, ram, mass-storage), it does not make sense to waste space with the documentation data.</p>
<p>If you need documentation data on your target anyway, then Buildroot is not suitable for your purpose, and you should look for a <em>real distribution</em> (see: <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#faq-no-compiler-on-target">Section 11.2, “Why is there no compiler on the target?”</a>).</p>
<h2 id="115-why-are-some-packages-not-visible-in-the-buildroot-config-menu"><a class="markdownIt-Anchor" href="#115-why-are-some-packages-not-visible-in-the-buildroot-config-menu"></a> 11.5. Why are some packages not visible in the Buildroot config menu?</h2>
<p>If a package exists in the Buildroot tree and does not appear in the config menu, this most likely means that some of the package’s dependencies are not met.</p>
<p>To know more about the dependencies of a package, search for the package symbol in the config menu (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#make-tips">Section 8.1, “<em>make</em> tips”</a>).</p>
<p>Then, you may have to recursively enable several options (which correspond to the unmet dependencies) to finally be able to select the package.</p>
<p>If the package is not visible due to some unmet toolchain options, then you should certainly run a full rebuild (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#make-tips">Section 8.1, “<em>make</em> tips”</a> for more explanations).</p>
<h2 id="116-why-not-use-the-target-directory-as-a-chroot-directory"><a class="markdownIt-Anchor" href="#116-why-not-use-the-target-directory-as-a-chroot-directory"></a> 11.6. Why not use the target directory as a chroot directory?</h2>
<p>There are plenty of reasons to <em><strong>*not*</strong></em> use the target directory a chroot one, among these:</p>
<ul>
<li>file ownerships, modes and permissions are not correctly set in the target directory;</li>
<li>device nodes are not created in the target directory.</li>
</ul>
<p>For these reasons, commands run through chroot, using the target directory as the new root, will most likely fail.</p>
<p>If you want to run the target filesystem inside a chroot, or as an NFS root, then use the tarball image generated in <code>images/</code> and extract it as root.</p>
<h2 id="117-why-doesnt-buildroot-generate-binary-packages-deb-ipkg"><a class="markdownIt-Anchor" href="#117-why-doesnt-buildroot-generate-binary-packages-deb-ipkg"></a> 11.7. Why doesn’t Buildroot generate binary packages (.deb, .ipkg…)?</h2>
<p>One feature that is often discussed on the Buildroot list is the general topic of “package management”. To summarize, the idea would be to add some tracking of which Buildroot package installs what files, with the goals of:</p>
<ul>
<li>being able to remove files installed by a package when this package gets unselected from the menuconfig;</li>
<li>being able to generate binary packages (ipk or other format) that can be installed on the target without re-generating a new root filesystem image.</li>
</ul>
<p>In general, most people think it is easy to do: just track which package installed what and remove it when the package is unselected. However, it is much more complicated than that:</p>
<ul>
<li>It is not only about the <code>target/</code> directory, but also the sysroot in <code>host/&lt;tuple&gt;/sysroot</code> and the <code>host/</code> directory itself. All files installed in those directories by various packages must be tracked.</li>
<li>When a package is unselected from the configuration, it is not sufficient to remove just the files it installed. One must also remove all its reverse dependencies (i.e. packages relying on it) and rebuild all those packages. For example, package A depends optionally on the OpenSSL library. Both are selected, and Buildroot is built. Package A is built with crypto support using OpenSSL. Later on, OpenSSL gets unselected from the configuration, but package A remains (since OpenSSL is an optional dependency, this is possible.) If only OpenSSL files are removed, then the files installed by package A are broken: they use a library that is no longer present on the target. Although this is technically doable, it adds a lot of complexity to Buildroot, which goes against the simplicity we try to stick to.</li>
<li>In addition to the previous problem, there is the case where the optional dependency is not even known to Buildroot. For example, package A in version 1.0 never used OpenSSL, but in version 2.0 it automatically uses OpenSSL if available. If the Buildroot .mk file hasn’t been updated to take this into account, then package A will not be part of the reverse dependencies of OpenSSL and will not be removed and rebuilt when OpenSSL is removed. For sure, the .mk file of package A should be fixed to mention this optional dependency, but in the mean time, you can have non-reproducible behaviors.</li>
<li>The request is to also allow changes in the menuconfig to be applied on the output directory without having to rebuild everything from scratch. However, this is very difficult to achieve in a reliable way: what happens when the suboptions of a package are changed (we would have to detect this, and rebuild the package from scratch and potentially all its reverse dependencies), what happens if toolchain options are changed, etc. At the moment, what Buildroot does is clear and simple so its behaviour is very reliable and it is easy to support users. If configuration changes done in menuconfig are applied after the next make, then it has to work correctly and properly in all situations, and not have some bizarre corner cases. The risk is to get bug reports like “I have enabled package A, B and C, then ran make, then disabled package C and enabled package D and ran make, then re-enabled package C and enabled package E and then there is a build failure”. Or worse “I did some configuration, then built, then did some changes, built, some more changes, built, some more changes, built, and now it fails, but I don’t remember all the changes I did and in which order”. This will be impossible to support.</li>
</ul>
<p>For all these reasons, the conclusion is that adding tracking of installed files to remove them when the package is unselected, or to generate a repository of binary packages, is something that is very hard to achieve reliably and will add a lot of complexity.</p>
<p>On this matter, the Buildroot developers make this position statement:</p>
<ul>
<li>Buildroot strives to make it easy to generate a root filesystem (hence the name, by the way.) That is what we want to make Buildroot good at: building root filesystems.</li>
<li>Buildroot is not meant to be a distribution (or rather, a distribution generator.) It is the opinion of most Buildroot developers that this is not a goal we should pursue. We believe that there are other tools better suited to generate a distro than Buildroot is. For example, <a target="_blank" rel="noopener" href="http://openembedded.org/">Open Embedded</a>, or <a target="_blank" rel="noopener" href="https://openwrt.org/">openWRT</a>, are such tools.</li>
<li>We prefer to push Buildroot in a direction that makes it easy (or even easier) to generate complete root filesystems. This is what makes Buildroot stands out in the crowd (among other things, of course!)</li>
<li>We believe that for most embedded Linux systems, binary packages are not necessary, and potentially harmful. When binary packages are used, it means that the system can be partially upgraded, which creates an enormous number of possible combinations of package versions that should be tested before doing the upgrade on the embedded device. On the other hand, by doing complete system upgrades by upgrading the entire root filesystem image at once, the image deployed to the embedded system is guaranteed to really be the one that has been tested and validated.</li>
</ul>
<h2 id="118-how-to-speed-up-the-build-process"><a class="markdownIt-Anchor" href="#118-how-to-speed-up-the-build-process"></a> 11.8. How to speed-up the build process?</h2>
<p>Since Buildroot often involves doing full rebuilds of the entire system that can be quite long, we provide below a number of tips to help reduce the build time:</p>
<ul>
<li>Use a pre-built external toolchain instead of the default Buildroot internal toolchain. By using a pre-built Linaro toolchain (on ARM) or a Sourcery CodeBench toolchain (for ARM, x86, x86-64, MIPS, etc.), you will save the build time of the toolchain at each complete rebuild, approximately 15 to 20 minutes. Note that temporarily using an external toolchain does not prevent you to switch back to an internal toolchain (that may provide a higher level of customization) once the rest of your system is working;</li>
<li>Use the <code>ccache</code> compiler cache (see: <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ccache">Section 8.13.3, “Using <code>ccache</code> in Buildroot”</a>);</li>
<li>Learn about rebuilding only the few packages you actually care about (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#rebuild-pkg">Section 8.3, “Understanding how to rebuild packages”</a>), but beware that sometimes full rebuilds are anyway necessary (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#full-rebuild">Section 8.2, “Understanding when a full rebuild is necessary”</a>);</li>
<li>Make sure you are not using a virtual machine for the Linux system used to run Buildroot. Most of the virtual machine technologies are known to cause a significant performance impact on I/O, which is really important for building source code;</li>
<li>Make sure that you’re using only local files: do not attempt to do a build over NFS, which significantly slows down the build. Having the Buildroot download folder available locally also helps a bit.</li>
<li>Buy new hardware. SSDs and lots of RAM are key to speeding up the builds.</li>
<li>Experiment with top-level parallel build, see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#top-level-parallel-build">Section 8.12, “Top-level parallel build”</a>.</li>
</ul>
<h2 id="119-how-does-buildroot-support-y2038"><a class="markdownIt-Anchor" href="#119-how-does-buildroot-support-y2038"></a> 11.9. How does Buildroot support Y2038?</h2>
<p>There are multiple situations to consider:</p>
<ul>
<li>On 64-bit architectures, there is no problem, as <code>time_t</code> has always been 64-bit.</li>
<li>On 32-bit architectures, the situation depends on the C library:
<ul>
<li>With <em>uclibc-ng</em>, there is no support for 64-bit <code>time_t</code> on 32-bit architectures, so systems using <em>uclibc-ng</em> on 32-bit platforms will not be Y2038 compatible.</li>
<li>With <em>musl</em>, 64-bit <code>time_t</code> has always been used on 32-bit architectures, so systems using <em>musl</em> on 32-bit platforms are Y2038 compatible.</li>
<li>With <em>glibc</em>, 64-bit <code>time_t</code> on 32-bit architectures is enabled by the Buildroot option <code>BR2_TIME_BITS_64</code>. With this option enabled, systems using <em>glibc</em> on 32-bit platforms are Y2038 compatible.</li>
</ul>
</li>
</ul>
<p>Note that the above only comments about the capabilities of the C library. Individual user-space libraries or applications, even when built in a Y2038-compatible setup, can exhibit incorrect behavior if they do not make correct use of the time APIs and types.</p>
<h2 id="chapter-12-known-issues"><a class="markdownIt-Anchor" href="#chapter-12-known-issues"></a> Chapter 12. Known issues</h2>
<ul>
<li>It is not possible to pass extra linker options via <code>BR2_TARGET_LDFLAGS</code> if such options contain a <code>$</code> sign. For example, the following is known to break: <code>BR2_TARGET_LDFLAGS=&quot;-Wl,-rpath='$ORIGIN/../lib'&quot;</code></li>
<li>The <code>libffi</code> package is not supported on the SuperH 2 and ARMv7-M architectures.</li>
<li>The <code>prboom</code> package triggers a compiler failure with the SuperH 4 compiler from Sourcery CodeBench, version 2012.09.</li>
</ul>
<h2 id="chapter-13-legal-notice-and-licensing"><a class="markdownIt-Anchor" href="#chapter-13-legal-notice-and-licensing"></a> Chapter 13. Legal notice and licensing</h2>
<h2 id="131-complying-with-open-source-licenses"><a class="markdownIt-Anchor" href="#131-complying-with-open-source-licenses"></a> 13.1. Complying with open source licenses</h2>
<p>All of the end products of Buildroot (toolchain, root filesystem, kernel, bootloaders) contain open source software, released under various licenses.</p>
<p>Using open source software gives you the freedom to build rich embedded systems, choosing from a wide range of packages, but also imposes some obligations that you must know and honour. Some licenses require you to publish the license text in the documentation of your product. Others require you to redistribute the source code of the software to those that receive your product.</p>
<p>The exact requirements of each license are documented in each package, and it is your responsibility (or that of your legal office) to comply with those requirements. To make this easier for you, Buildroot can collect for you some material you will probably need. To produce this material, after you have configured Buildroot with <code>make menuconfig</code>, <code>make xconfig</code> or <code>make gconfig</code>, run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make legal-info</span><br></pre></td></tr></table></figure>
<p>Buildroot will collect legally-relevant material in your output directory, under the <code>legal-info/</code> subdirectory. There you will find:</p>
<ul>
<li>A <code>README</code> file, that summarizes the produced material and contains warnings about material that Buildroot could not produce.</li>
<li><code>buildroot.config</code>: this is the Buildroot configuration file that is usually produced with <code>make menuconfig</code>, and which is necessary to reproduce the build.</li>
<li>The source code for all packages; this is saved in the <code>sources/</code> and <code>host-sources/</code> subdirectories for target and host packages respectively. The source code for packages that set <code>&lt;PKG&gt;_REDISTRIBUTE = NO</code> will not be saved. Patches that were applied are also saved, along with a file named <code>series</code> that lists the patches in the order they were applied. Patches are under the same license as the files that they modify. Note: Buildroot applies additional patches to Libtool scripts of autotools-based packages. These patches can be found under <code>support/libtool</code> in the Buildroot source and, due to technical limitations, are not saved with the package sources. You may need to collect them manually.</li>
<li>A manifest file (one for host and one for target packages) listing the configured packages, their version, license and related information. Some of this information might not be defined in Buildroot; such items are marked as “unknown”.</li>
<li>The license texts of all packages, in the <code>licenses/</code> and <code>host-licenses/</code> subdirectories for target and host packages respectively. If the license file(s) are not defined in Buildroot, the file is not produced and a warning in the <code>README</code> indicates this.</li>
</ul>
<p>Please note that the aim of the <code>legal-info</code> feature of Buildroot is to produce all the material that is somehow relevant for legal compliance with the package licenses. Buildroot does not try to produce the exact material that you must somehow make public. Certainly, more material is produced than is needed for a strict legal compliance. For example, it produces the source code for packages released under BSD-like licenses, that you are not required to redistribute in source form.</p>
<p>Moreover, due to technical limitations, Buildroot does not produce some material that you will or may need, such as the toolchain source code for some of the external toolchains and the Buildroot source code itself. When you run <code>make legal-info</code>, Buildroot produces warnings in the <code>README</code> file to inform you of relevant material that could not be saved.</p>
<p>Finally, keep in mind that the output of <code>make legal-info</code> is based on declarative statements in each of the packages recipes. The Buildroot developers try to do their best to keep those declarative statements as accurate as possible, to the best of their knowledge. However, it is very well possible that those declarative statements are not all fully accurate nor exhaustive. You (or your legal department) <em>have</em> to check the output of <code>make legal-info</code> before using it as your own compliance delivery. See the <em>NO WARRANTY</em> clauses (clauses 11 and 12) in the <code>COPYING</code> file at the root of the Buildroot distribution.</p>
<h2 id="132-complying-with-the-buildroot-license"><a class="markdownIt-Anchor" href="#132-complying-with-the-buildroot-license"></a> 13.2. Complying with the Buildroot license</h2>
<p>Buildroot itself is an open source software, released under the <a target="_blank" rel="noopener" href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html">GNU General Public License, version 2</a> or (at your option) any later version, with the exception of the package patches detailed below. However, being a build system, it is not normally part of the end product: if you develop the root filesystem, kernel, bootloader or toolchain for a device, the code of Buildroot is only present on the development machine, not in the device storage.</p>
<p>Nevertheless, the general view of the Buildroot developers is that you should release the Buildroot source code along with the source code of other packages when releasing a product that contains GPL-licensed software. This is because the <a target="_blank" rel="noopener" href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html">GNU GPL</a> defines the “<em>complete source code</em>” for an executable work as “<em>all the source code for all modules it contains, plus any associated interface definition files, plus the scripts used to control compilation and installation of the executable</em>”. Buildroot is part of the <em>scripts used to control compilation and installation of the executable</em>, and as such it is considered part of the material that must be redistributed.</p>
<p>Keep in mind that this is only the Buildroot developers’ opinion, and you should consult your legal department or lawyer in case of any doubt.</p>
<h3 id="1321-patches-to-packages"><a class="markdownIt-Anchor" href="#1321-patches-to-packages"></a> 13.2.1. Patches to packages</h3>
<p>Buildroot also bundles patch files, which are applied to the sources of the various packages. Those patches are not covered by the license of Buildroot. Instead, they are covered by the license of the software to which the patches are applied. When said software is available under multiple licenses, the Buildroot patches are only provided under the publicly accessible licenses.</p>
<p>See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#patch-policy">Chapter 19, <em>Patching a package</em></a> for the technical details.</p>
<h2 id="chapter-14-beyond-buildroot"><a class="markdownIt-Anchor" href="#chapter-14-beyond-buildroot"></a> Chapter 14. Beyond Buildroot</h2>
<h2 id="141-boot-the-generated-images"><a class="markdownIt-Anchor" href="#141-boot-the-generated-images"></a> 14.1. Boot the generated images</h2>
<h3 id="1411-nfs-boot"><a class="markdownIt-Anchor" href="#1411-nfs-boot"></a> 14.1.1. NFS boot</h3>
<p>To achieve NFS-boot, enable <em>tar root filesystem</em> in the <em>Filesystem images</em> menu.</p>
<p>After a complete build, just run the following commands to setup the NFS-root directory:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -xavf /path/to/output_dir/rootfs.tar -C /path/to/nfs_root_dir</span><br></pre></td></tr></table></figure>
<p>Remember to add this path to <code>/etc/exports</code>.</p>
<p>Then, you can execute a NFS-boot from your target.</p>
<h3 id="1412-live-cd"><a class="markdownIt-Anchor" href="#1412-live-cd"></a> 14.1.2. Live CD</h3>
<p>To build a live CD image, enable the <em>iso image</em> option in the <em>Filesystem images</em> menu. Note that this option is only available on the x86 and x86-64 architectures, and if you are building your kernel with Buildroot.</p>
<p>You can build a live CD image with either IsoLinux, Grub or Grub 2 as a bootloader, but only Isolinux supports making this image usable both as a live CD and live USB (through the <em>Build hybrid image</em> option).</p>
<p>You can test your live CD image using QEMU:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -cdrom output/images/rootfs.iso9660</span><br></pre></td></tr></table></figure>
<p>Or use it as a hard-drive image if it is a hybrid ISO:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -hda output/images/rootfs.iso9660</span><br></pre></td></tr></table></figure>
<p>It can be easily flashed to a USB drive with <code>dd</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=output/images/rootfs.iso9660 of=/dev/sdb</span><br></pre></td></tr></table></figure>
<h2 id="142-chroot"><a class="markdownIt-Anchor" href="#142-chroot"></a> 14.2. Chroot</h2>
<p>If you want to chroot in a generated image, then there are few thing you should be aware of:</p>
<ul>
<li>you should setup the new root from the <em>tar root filesystem</em> image;</li>
<li>either the selected target architecture is compatible with your host machine, or you should use some <code>qemu-*</code> binary and correctly set it within the <code>binfmt</code> properties to be able to run the binaries built for the target on your host machine;</li>
<li>Buildroot does not currently provide <code>host-qemu</code> and <code>binfmt</code> correctly built and set for that kind of use.</li>
</ul>
<h1 id="part-iii-developer-guide"><a class="markdownIt-Anchor" href="#part-iii-developer-guide"></a> Part III. Developer guide</h1>
<h2 id="chapter-15-how-buildroot-works"><a class="markdownIt-Anchor" href="#chapter-15-how-buildroot-works"></a> Chapter 15. How Buildroot works</h2>
<p>As mentioned above, Buildroot is basically a set of Makefiles that download, configure, and compile software with the correct options. It also includes patches for various software packages - mainly the ones involved in the cross-compilation toolchain (<code>gcc</code>, <code>binutils</code> and <code>uClibc</code>).</p>
<p>There is basically one Makefile per software package, and they are named with the <code>.mk</code> extension. Makefiles are split into many different parts.</p>
<ul>
<li>The <code>toolchain/</code> directory contains the Makefiles and associated files for all software related to the cross-compilation toolchain: <code>binutils</code>, <code>gcc</code>, <code>gdb</code>, <code>kernel-headers</code> and <code>uClibc</code>.</li>
<li>The <code>arch/</code> directory contains the definitions for all the processor architectures that are supported by Buildroot.</li>
<li>The <code>package/</code> directory contains the Makefiles and associated files for all user-space tools and libraries that Buildroot can compile and add to the target root filesystem. There is one sub-directory per package.</li>
<li>The <code>linux/</code> directory contains the Makefiles and associated files for the Linux kernel.</li>
<li>The <code>boot/</code> directory contains the Makefiles and associated files for the bootloaders supported by Buildroot.</li>
<li>The <code>system/</code> directory contains support for system integration, e.g. the target filesystem skeleton and the selection of an init system.</li>
<li>The <code>fs/</code> directory contains the Makefiles and associated files for software related to the generation of the target root filesystem image.</li>
</ul>
<p>Each directory contains at least 2 files:</p>
<ul>
<li><code>something.mk</code> is the Makefile that downloads, configures, compiles and installs the package <code>something</code>.</li>
<li><code>Config.in</code> is a part of the configuration tool description file. It describes the options related to the package.</li>
</ul>
<p>The main Makefile performs the following steps (once the configuration is done):</p>
<ul>
<li>Create all the output directories: <code>staging</code>, <code>target</code>, <code>build</code>, etc. in the output directory (<code>output/</code> by default, another value can be specified using <code>O=</code>)</li>
<li>Generate the toolchain target. When an internal toolchain is used, this means generating the cross-compilation toolchain. When an external toolchain is used, this means checking the features of the external toolchain and importing it into the Buildroot environment.</li>
<li>Generate all the targets listed in the <code>TARGETS</code> variable. This variable is filled by all the individual components’ Makefiles. Generating these targets will trigger the compilation of the userspace packages (libraries, programs), the kernel, the bootloader and the generation of the root filesystem images, depending on the configuration.</li>
</ul>
<h2 id="chapter-16-coding-style"><a class="markdownIt-Anchor" href="#chapter-16-coding-style"></a> Chapter 16. Coding style</h2>
<p>Overall, these coding style rules are here to help you to add new files in Buildroot or refactor existing ones.</p>
<p>If you slightly modify some existing file, the important thing is to keep the consistency of the whole file, so you can:</p>
<ul>
<li>either follow the potentially deprecated coding style used in this file,</li>
<li>or entirely rework it in order to make it comply with these rules.</li>
</ul>
<h2 id="161-configin-file"><a class="markdownIt-Anchor" href="#161-configin-file"></a> 16.1. <code>Config.in</code> file</h2>
<p><code>Config.in</code> files contain entries for almost anything configurable in Buildroot.</p>
<p>An entry has the following pattern:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_LIBFOO</span><br><span class="line">        bool &quot;libfoo&quot;</span><br><span class="line">        depends on BR2_PACKAGE_LIBBAZ</span><br><span class="line">        select BR2_PACKAGE_LIBBAR</span><br><span class="line">        help</span><br><span class="line">          This is a comment that explains what libfoo is. The help text</span><br><span class="line">          should be wrapped.</span><br><span class="line"></span><br><span class="line">          http://foosoftware.org/libfoo/</span><br></pre></td></tr></table></figure>
<ul>
<li>The <code>bool</code>, <code>depends on</code>, <code>select</code> and <code>help</code> lines are indented with one tab.</li>
<li>The help text itself should be indented with one tab and two spaces.</li>
<li>The help text should be wrapped to fit 72 columns, where tab counts for 8, so 62 characters in the text itself.</li>
</ul>
<p>The <code>Config.in</code> files are the input for the configuration tool used in Buildroot, which is the regular <em>Kconfig</em>. For further details about the <em>Kconfig</em> language, refer to <a target="_blank" rel="noopener" href="http://kernel.org/doc/Documentation/kbuild/kconfig-language.txt">http://kernel.org/doc/Documentation/kbuild/kconfig-language.txt</a>.</p>
<h2 id="162-the-mk-file"><a class="markdownIt-Anchor" href="#162-the-mk-file"></a> 16.2. The <code>.mk</code> file</h2>
<ul>
<li>
<p>Header: The file starts with a header. It contains the module name, preferably in lowercase, enclosed between separators made of 80 hashes. A blank line is mandatory after the header:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line"># libfoo</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Assignment: use <code>=</code> preceded and followed by one space:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LIBFOO_VERSION = 1.0</span><br><span class="line">LIBFOO_CONF_OPTS += --without-python-support</span><br></pre></td></tr></table></figure>
<p>Do not align the <code>=</code> signs.</p>
</li>
<li>
<p>Indentation: use tab only:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">define LIBFOO_REMOVE_DOC</span><br><span class="line">        $(RM) -r $(TARGET_DIR)/usr/share/libfoo/doc \</span><br><span class="line">                $(TARGET_DIR)/usr/share/man/man3/libfoo*</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>Note that commands inside a <code>define</code> block should always start with a tab, so <em>make</em> recognizes them as commands.</p>
</li>
<li>
<p>Optional dependency:</p>
<ul>
<li>
<p>Prefer multi-line syntax.</p>
<p>YES:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ifeq ($(BR2_PACKAGE_PYTHON3),y)</span><br><span class="line">LIBFOO_CONF_OPTS += --with-python-support</span><br><span class="line">LIBFOO_DEPENDENCIES += python3</span><br><span class="line">else</span><br><span class="line">LIBFOO_CONF_OPTS += --without-python-support</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>NO:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LIBFOO_CONF_OPTS += --with$(if $(BR2_PACKAGE_PYTHON3),,out)-python-support</span><br><span class="line">LIBFOO_DEPENDENCIES += $(if $(BR2_PACKAGE_PYTHON3),python3,)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Keep configure options and dependencies close together.</p>
</li>
</ul>
</li>
<li>
<p>Optional hooks: keep hook definition and assignment together in one if block.</p>
<p>YES:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ifneq ($(BR2_LIBFOO_INSTALL_DATA),y)</span><br><span class="line">define LIBFOO_REMOVE_DATA</span><br><span class="line">        $(RM) -r $(TARGET_DIR)/usr/share/libfoo/data</span><br><span class="line">endef</span><br><span class="line">LIBFOO_POST_INSTALL_TARGET_HOOKS += LIBFOO_REMOVE_DATA</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>NO:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">define LIBFOO_REMOVE_DATA</span><br><span class="line">        $(RM) -r $(TARGET_DIR)/usr/share/libfoo/data</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">ifneq ($(BR2_LIBFOO_INSTALL_DATA),y)</span><br><span class="line">LIBFOO_POST_INSTALL_TARGET_HOOKS += LIBFOO_REMOVE_DATA</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="163-the-genimagecfg-file"><a class="markdownIt-Anchor" href="#163-the-genimagecfg-file"></a> 16.3. The <code>genimage.cfg</code> file</h2>
<p><code>genimage.cfg</code> files contain the output image layout that genimage utility uses to create final .img file.</p>
<p>An example follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">image efi-part.vfat &#123;</span><br><span class="line">        vfat &#123;</span><br><span class="line">                file EFI &#123;</span><br><span class="line">                        image = &quot;efi-part/EFI&quot;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                file Image &#123;</span><br><span class="line">                        image = &quot;Image&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size = 32M</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">image sdimage.img &#123;</span><br><span class="line">        hdimage &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        partition u-boot &#123;</span><br><span class="line">                image = &quot;efi-part.vfat&quot;</span><br><span class="line">                offset = 8K</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        partition root &#123;</span><br><span class="line">                image = &quot;rootfs.ext2&quot;</span><br><span class="line">                size = 512M</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Every <code>section</code>(i.e. hdimage, vfat etc.), <code>partition</code> must be indented with one tab.</li>
<li>Every <code>file</code> or other <code>subnode</code> must be indented with two tabs.</li>
<li>Every node(<code>section</code>, <code>partition</code>, <code>file</code>, <code>subnode</code>) must have an open curly bracket on the same line of the node’s name, while the closing one must be on a newline and after it a newline must be added except for the last one node. Same goes for its option, for example option <code>size</code> <code>=</code>.</li>
<li>Every <code>option</code>(i.e. <code>image</code>, <code>offset</code>, <code>size</code>) must have the <code>=</code> assignment one space from it and one space from the value specified.</li>
<li>Filename must at least begin with genimage prefix and have the .cfg extension to be easy to recognize.</li>
<li>Allowed notations for <code>offset</code> and <code>size</code> options are: <code>G</code>, <code>M</code>, <code>K</code> (not <code>k</code>). If it’s not possible to express a precise byte count with notations above then use hexadecimal <code>0x</code> prefix or, as last chance, the byte count. In comments instead use <code>GB</code>, <code>MB</code>, <code>KB</code> (not <code>kb</code>) in place of <code>G</code>, <code>M</code>, <code>K</code>.</li>
<li>For GPT partitions, the <code>partition-type-uuid</code> value must be <code>U</code> for the EFI System Partition (expanded to <code>c12a7328-f81f-11d2-ba4b-00a0c93ec93b</code> by <em>genimage</em>), <code>F</code> for a FAT partition (expanded to <code>ebd0a0a2-b9e5-4433-87c0-68b6b72699c7</code> by <em>genimage</em>) or <code>L</code> for the root filesystem or other filesystems (expanded to <code>0fc63daf-8483-4772-8e79-3d69d8477de4</code> by <em>genimage</em>). Even though <code>L</code> is the default value of <em>genimage</em>, we prefer to have it explicitly specified in our <code>genimage.cfg</code> files. Finally, these shortcuts should be used without double quotes, e.g <code>partition-type-uuid = U</code>. If an explicit GUID is specified, lower-case letters should be used.</li>
</ul>
<p>The <code>genimage.cfg</code> files are the input for the genimage tool used in Buildroot to generate the final image file(i.e. sdcard.img). For further details about the <em>genimage</em> language, refer to <a target="_blank" rel="noopener" href="https://github.com/pengutronix/genimage/blob/master/README.rst">https://github.com/pengutronix/genimage/blob/master/README.rst</a>.</p>
<h2 id="164-the-documentation"><a class="markdownIt-Anchor" href="#164-the-documentation"></a> 16.4. The documentation</h2>
<p>The documentation uses the <a target="_blank" rel="noopener" href="https://asciidoc-py.github.io/">asciidoc</a> format.</p>
<p>For further details about the asciidoc syntax, refer to <a target="_blank" rel="noopener" href="https://asciidoc-py.github.io/userguide.html">https://asciidoc-py.github.io/userguide.html</a>.</p>
<h2 id="165-support-scripts"><a class="markdownIt-Anchor" href="#165-support-scripts"></a> 16.5. Support scripts</h2>
<p>Some scripts in the <code>support/</code> and <code>utils/</code> directories are written in Python and should follow the <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0008/">PEP8 Style Guide for Python Code</a>.</p>
<h2 id="chapter-17-adding-support-for-a-particular-board"><a class="markdownIt-Anchor" href="#chapter-17-adding-support-for-a-particular-board"></a> Chapter 17. Adding support for a particular board</h2>
<p>Buildroot contains basic configurations for several publicly available hardware boards, so that users of such a board can easily build a system that is known to work. You are welcome to add support for other boards to Buildroot too.</p>
<p>To do so, you need to create a normal Buildroot configuration that builds a basic system for the hardware: (internal) toolchain, kernel, bootloader, filesystem and a simple BusyBox-only userspace. No specific package should be selected: the configuration should be as minimal as possible, and should only build a working basic BusyBox system for the target platform. You can of course use more complicated configurations for your internal projects, but the Buildroot project will only integrate basic board configurations. This is because package selections are highly application-specific.</p>
<p>Once you have a known working configuration, run <code>make savedefconfig</code>. This will generate a minimal <code>defconfig</code> file at the root of the Buildroot source tree. Move this file into the <code>configs/</code> directory, and rename it <code>&lt;boardname&gt;_defconfig</code>. If the configuration is a bit more complicated, it is nice to manually reformat it and separate it into sections, with a comment before each section. Typical sections are <em>Architecture</em>, <em>Toolchain options</em> (typically just linux headers version), <em>Firmware</em>, <em>Bootloader</em>, <em>Kernel</em>, and <em>Filesystem</em>.</p>
<p>Always use fixed versions or commit hashes for the different components, not the “latest” version. For example, set <code>BR2_LINUX_KERNEL_CUSTOM_VERSION=y</code> and <code>BR2_LINUX_KERNEL_CUSTOM_VERSION_VALUE</code> to the kernel version you tested with.</p>
<p>It is recommended to use as much as possible upstream versions of the Linux kernel and bootloaders, and to use as much as possible default kernel and bootloader configurations. If they are incorrect for your board, or no default exists, we encourage you to send fixes to the corresponding upstream projects.</p>
<p>However, in the mean time, you may want to store kernel or bootloader configuration or patches specific to your target platform. To do so, create a directory <code>board/&lt;manufacturer&gt;</code> and a subdirectory <code>board/&lt;manufacturer&gt;/&lt;boardname&gt;</code>. You can then store your patches and configurations in these directories, and reference them from the main Buildroot configuration. Refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize">Chapter 9, <em>Project-specific customization</em></a> for more details.</p>
<p>Before submitting patches for new boards it is recommended to test it by building it using latest gitlab-CI docker container. To do this use <code>utils/docker-run</code> script and inside it issue these commands:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make &lt;boardname&gt;_defconfig</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>
<p>By default, Buildroot developers use the official image hosted on the <a target="_blank" rel="noopener" href="https://gitlab.com/buildroot.org/buildroot/container_registry/2395076">gitlab.com registry</a> and it should be convenient for most usage. If you still want to build your own docker image, you can base it off the official image as the <code>FROM</code> directive of your own <em>Dockerfile</em>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM registry.gitlab.com/buildroot.org/buildroot/base:YYYYMMDD.HHMM</span><br><span class="line">RUN ...</span><br><span class="line">COPY ...</span><br></pre></td></tr></table></figure>
<p>The current version <em>YYYYMMDD.HHMM</em> can be found in the <code>.gitlab-ci.yml</code> file at the top of the Buildroot source tree; all past versions are listed in the aforementioned registry as well.</p>
<h2 id="chapter-18-adding-new-packages-to-buildroot"><a class="markdownIt-Anchor" href="#chapter-18-adding-new-packages-to-buildroot"></a> Chapter 18. Adding new packages to Buildroot</h2>
<p>This section covers how new packages (userspace libraries or applications) can be integrated into Buildroot. It also shows how existing packages are integrated, which is needed for fixing issues or tuning their configuration.</p>
<p>When you add a new package, be sure to test it in various conditions (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#testing-package">Section 18.25.3, “How to test your package”</a>) and also check it for coding style (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#check-package">Section 18.25.2, “How to check the coding style”</a>).</p>
<h2 id="181-package-directory"><a class="markdownIt-Anchor" href="#181-package-directory"></a> 18.1. Package directory</h2>
<p>First of all, create a directory under the <code>package</code> directory for your software, for example <code>libfoo</code>.</p>
<p>Some packages have been grouped by topic in a sub-directory: <code>x11r7</code>, <code>qt5</code> and <code>gstreamer</code>. If your package fits in one of these categories, then create your package directory in these. New subdirectories are discouraged, however.</p>
<h2 id="182-config-files"><a class="markdownIt-Anchor" href="#182-config-files"></a> 18.2. Config files</h2>
<p>For the package to be displayed in the configuration tool, you need to create a Config file in your package directory. There are two types: <code>Config.in</code> and <code>Config.in.host</code>.</p>
<h3 id="1821-configin-file"><a class="markdownIt-Anchor" href="#1821-configin-file"></a> 18.2.1. <code>Config.in</code> file</h3>
<p>For packages used on the target, create a file named <code>Config.in</code>. This file will contain the option descriptions related to our <code>libfoo</code> software that will be used and displayed in the configuration tool. It should basically contain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_LIBFOO</span><br><span class="line">        bool &quot;libfoo&quot;</span><br><span class="line">        help</span><br><span class="line">          This is a comment that explains what libfoo is. The help text</span><br><span class="line">          should be wrapped.</span><br><span class="line"></span><br><span class="line">          http://foosoftware.org/libfoo/</span><br></pre></td></tr></table></figure>
<p>The <code>bool</code> line, <code>help</code> line and other metadata information about the configuration option must be indented with one tab. The help text itself should be indented with one tab and two spaces, lines should be wrapped to fit 72 columns, where tab counts for 8, so 62 characters in the text itself. The help text must mention the upstream URL of the project after an empty line.</p>
<p>As a convention specific to Buildroot, the ordering of the attributes is as follows:</p>
<ol>
<li>The type of option: <code>bool</code>, <code>string</code>… with the prompt</li>
<li>If needed, the <code>default</code> value(s)</li>
<li>Any dependencies on the target in <code>depends on</code> form</li>
<li>Any dependencies on the toolchain in <code>depends on</code> form</li>
<li>Any dependencies on other packages in <code>depends on</code> form</li>
<li>Any dependency of the <code>select</code> form</li>
<li>The help keyword and help text.</li>
</ol>
<p>You can add other sub-options into a <code>if BR2_PACKAGE_LIBFOO…endif</code> statement to configure particular things in your software. You can look at examples in other packages. The syntax of the <code>Config.in</code> file is the same as the one for the kernel Kconfig file. The documentation for this syntax is available at <a target="_blank" rel="noopener" href="http://kernel.org/doc/Documentation/kbuild/kconfig-language.txt">http://kernel.org/doc/Documentation/kbuild/kconfig-language.txt</a></p>
<p>Finally you have to add your new <code>libfoo/Config.in</code> to <code>package/Config.in</code> (or in a category subdirectory if you decided to put your package in one of the existing categories). The files included there are <em>sorted alphabetically</em> per category and are <em>NOT</em> supposed to contain anything but the <em>bare</em> name of the package.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;package/libfoo/Config.in&quot;</span><br></pre></td></tr></table></figure>
<h3 id="1822-configinhost-file"><a class="markdownIt-Anchor" href="#1822-configinhost-file"></a> 18.2.2. <code>Config.in.host</code> file</h3>
<p>Some packages also need to be built for the host system. There are two options here:</p>
<ul>
<li>
<p>The host package is only required to satisfy build-time dependencies of one or more target packages. In this case, add <code>host-foo</code> to the target package’s <code>BAR_DEPENDENCIES</code> variable. No <code>Config.in.host</code> file should be created.</p>
</li>
<li>
<p>The host package should be explicitly selectable by the user from the configuration menu. In this case, create a <code>Config.in.host</code> file for that host package:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_HOST_FOO</span><br><span class="line">        bool &quot;host foo&quot;</span><br><span class="line">        help</span><br><span class="line">          This is a comment that explains what foo for the host is.</span><br><span class="line"></span><br><span class="line">          http://foosoftware.org/foo/</span><br></pre></td></tr></table></figure>
<p>The same coding style and options as for the <code>Config.in</code> file are valid.</p>
<p>Finally you have to add your new <code>libfoo/Config.in.host</code> to <code>package/Config.in.host</code>. The files included there are <em>sorted alphabetically</em> and are <em>NOT</em> supposed to contain anything but the <em>bare</em> name of the package.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;package/foo/Config.in.host&quot;</span><br></pre></td></tr></table></figure>
<p>The host package will then be available from the <code>Host utilities</code> menu.</p>
</li>
</ul>
<h3 id="1823-choosing-depends-on-or-select"><a class="markdownIt-Anchor" href="#1823-choosing-depends-on-or-select"></a> 18.2.3. Choosing <code>depends on</code> or <code>select</code></h3>
<p>The <code>Config.in</code> file of your package must also ensure that dependencies are enabled. Typically, Buildroot uses the following rules:</p>
<ul>
<li>Use a <code>select</code> type of dependency for dependencies on libraries. These dependencies are generally not obvious and it therefore make sense to have the kconfig system ensure that the dependencies are selected. For example, the <em>libgtk2</em> package uses <code>select BR2_PACKAGE_LIBGLIB2</code> to make sure this library is also enabled. The <code>select</code> keyword expresses the dependency with a backward semantic.</li>
<li>Use a <code>depends on</code> type of dependency when the user really needs to be aware of the dependency. Typically, Buildroot uses this type of dependency for dependencies on target architecture, MMU support and toolchain options (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#dependencies-target-toolchain-options">Section 18.2.4, “Dependencies on target and toolchain options”</a>), or for dependencies on “big” things, such as the <a target="_blank" rel="noopener" href="http://X.org">X.org</a> system. The <code>depends on</code> keyword expresses the dependency with a forward semantic.</li>
</ul>
<p><strong>Note.</strong> The current problem with the <em>kconfig</em> language is that these two dependency semantics are not internally linked. Therefore, it may be possible to select a package, whom one of its dependencies/requirement is not met.</p>
<p>An example illustrates both the usage of <code>select</code> and <code>depends on</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_RRDTOOL</span><br><span class="line">        bool &quot;rrdtool&quot;</span><br><span class="line">        depends on BR2_USE_WCHAR</span><br><span class="line">        select BR2_PACKAGE_FREETYPE</span><br><span class="line">        select BR2_PACKAGE_LIBART</span><br><span class="line">        select BR2_PACKAGE_LIBPNG</span><br><span class="line">        select BR2_PACKAGE_ZLIB</span><br><span class="line">        help</span><br><span class="line">          RRDtool is the OpenSource industry standard, high performance</span><br><span class="line">          data logging and graphing system for time series data.</span><br><span class="line"></span><br><span class="line">          http://oss.oetiker.ch/rrdtool/</span><br><span class="line"></span><br><span class="line">comment &quot;rrdtool needs a toolchain w/ wchar&quot;</span><br><span class="line">        depends on !BR2_USE_WCHAR</span><br></pre></td></tr></table></figure>
<p>Note that these two dependency types are only transitive with the dependencies of the same kind.</p>
<p>This means, in the following example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_A</span><br><span class="line">        bool &quot;Package A&quot;</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_B</span><br><span class="line">        bool &quot;Package B&quot;</span><br><span class="line">        depends on BR2_PACKAGE_A</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_C</span><br><span class="line">        bool &quot;Package C&quot;</span><br><span class="line">        depends on BR2_PACKAGE_B</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_D</span><br><span class="line">        bool &quot;Package D&quot;</span><br><span class="line">        select BR2_PACKAGE_B</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_E</span><br><span class="line">        bool &quot;Package E&quot;</span><br><span class="line">        select BR2_PACKAGE_D</span><br></pre></td></tr></table></figure>
<ul>
<li>Selecting <code>Package C</code> will be visible if <code>Package B</code> has been selected, which in turn is only visible if <code>Package A</code> has been selected.</li>
<li>Selecting <code>Package E</code> will select <code>Package D</code>, which will select <code>Package B</code>, it will not check for the dependencies of <code>Package B</code>, so it will not select <code>Package A</code>.</li>
<li>Since <code>Package B</code> is selected but <code>Package A</code> is not, this violates the dependency of <code>Package B</code> on <code>Package A</code>. Therefore, in such a situation, the transitive dependency has to be added explicitly:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_D</span><br><span class="line">        bool &quot;Package D&quot;</span><br><span class="line">        depends on BR2_PACKAGE_A</span><br><span class="line">        select BR2_PACKAGE_B</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_E</span><br><span class="line">        bool &quot;Package E&quot;</span><br><span class="line">        depends on BR2_PACKAGE_A</span><br><span class="line">        select BR2_PACKAGE_D</span><br></pre></td></tr></table></figure>
<p>Overall, for package library dependencies, <code>select</code> should be preferred.</p>
<p>Note that such dependencies will ensure that the dependency option is also enabled, but not necessarily built before your package. To do so, the dependency also needs to be expressed in the <code>.mk</code> file of the package.</p>
<p>Further formatting details: see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#writing-rules-config-in">the coding style</a>.</p>
<h3 id="1824-dependencies-on-target-and-toolchain-options"><a class="markdownIt-Anchor" href="#1824-dependencies-on-target-and-toolchain-options"></a> 18.2.4. Dependencies on target and toolchain options</h3>
<p>Many packages depend on certain options of the toolchain: the choice of C library, C++ support, thread support, RPC support, wchar support, or dynamic library support. Some packages can only be built on certain target architectures, or if an MMU is available in the processor.</p>
<p>These dependencies have to be expressed with the appropriate <em>depends on</em> statements in the <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> file. Additionally, for dependencies on toolchain options, a <code>comment</code> should be displayed when the option is not enabled, so that the user knows why the package is not available. Dependencies on target architecture or MMU support should not be made visible in a comment: since it is unlikely that the user can freely choose another target, it makes little sense to show these dependencies explicitly.</p>
<p>The <code>comment</code> should only be visible if the <code>config</code> option itself would be visible when the toolchain option dependencies are met. This means that all other dependencies of the package (including dependencies on target architecture and MMU support) have to be repeated on the <code>comment</code> definition. To keep it clear, the <code>depends on</code> statement for these non-toolchain option should be kept separate from the <code>depends on</code> statement for the toolchain options. If there is a dependency on a config option in that same file (typically the main package) it is preferable to have a global <code>if … endif</code> construct rather than repeating the <code>depends on</code> statement on the comment and other config options.</p>
<p>The general format of a dependency <code>comment</code> for package foo is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo needs a toolchain w/ featA, featB, featC</span><br></pre></td></tr></table></figure>
<p>for example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpd needs a toolchain w/ C++, threads, wchar</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crda needs a toolchain w/ threads</span><br></pre></td></tr></table></figure>
<p>Note that this text is kept brief on purpose, so that it will fit on a 80-character terminal.</p>
<p>The rest of this section enumerates the different target and toolchain options, the corresponding config symbols to depend on, and the text to use in the comment.</p>
<ul>
<li>Target architecture
<ul>
<li>Dependency symbol: <code>BR2_powerpc</code>, <code>BR2_mips</code>, … (see <code>arch/Config.in</code>)</li>
<li>Comment string: no comment to be added</li>
</ul>
</li>
<li>MMU support
<ul>
<li>Dependency symbol: <code>BR2_USE_MMU</code></li>
<li>Comment string: no comment to be added</li>
</ul>
</li>
<li>Gcc <code>*_sync**</code> built-ins used for atomic operations. They are available in variants operating on 1 byte, 2 bytes, 4 bytes and 8 bytes. Since different architectures support atomic operations on different sizes, one dependency symbol is available for each size:
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_SYNC_1</code> for 1 byte, <code>BR2_TOOLCHAIN_HAS_SYNC_2</code> for 2 bytes, <code>BR2_TOOLCHAIN_HAS_SYNC_4</code> for 4 bytes, <code>BR2_TOOLCHAIN_HAS_SYNC_8</code> for 8 bytes.</li>
<li>Comment string: no comment to be added</li>
</ul>
</li>
<li>Gcc <code>*_atomic**</code> built-ins used for atomic operations.
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_ATOMIC</code>.</li>
<li>Comment string: no comment to be added</li>
</ul>
</li>
<li>Kernel headers
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HEADERS_AT_LEAST_X_Y</code>, (replace <code>X_Y</code> with the proper version, see <code>toolchain/Config.in</code>)</li>
<li>Comment string: <code>headers &gt;= X.Y</code> and/or <code>headers &lt;= X.Y</code> (replace <code>X.Y</code> with the proper version)</li>
</ul>
</li>
<li>GCC version
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_GCC_AT_LEAST_X_Y</code>, (replace <code>X_Y</code> with the proper version, see <code>toolchain/Config.in</code>)</li>
<li>Comment string: <code>gcc &gt;= X.Y</code> and/or <code>gcc &lt;= X.Y</code> (replace <code>X.Y</code> with the proper version)</li>
</ul>
</li>
<li>Host GCC version
<ul>
<li>Dependency symbol: <code>BR2_HOST_GCC_AT_LEAST_X_Y</code>, (replace <code>X_Y</code> with the proper version, see <code>Config.in</code>)</li>
<li>Comment string: no comment to be added</li>
<li>Note that it is usually not the package itself that has a minimum host GCC version, but rather a host-package on which it depends.</li>
</ul>
</li>
<li>C library
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_USES_GLIBC</code>, <code>BR2_TOOLCHAIN_USES_MUSL</code>, <code>BR2_TOOLCHAIN_USES_UCLIBC</code></li>
<li>Comment string: for the C library, a slightly different comment text is used: <code>foo needs a glibc toolchain</code>, or <code>foo needs a glibc toolchain w/ C++</code></li>
</ul>
</li>
<li>C++ support
<ul>
<li>Dependency symbol: <code>BR2_INSTALL_LIBSTDCPP</code></li>
<li>Comment string: <code>C++</code></li>
</ul>
</li>
<li>D support
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_DLANG</code></li>
<li>Comment string: <code>Dlang</code></li>
</ul>
</li>
<li>Fortran support
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_FORTRAN</code></li>
<li>Comment string: <code>fortran</code></li>
</ul>
</li>
<li>thread support
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_THREADS</code></li>
<li>Comment string: <code>threads</code> (unless <code>BR2_TOOLCHAIN_HAS_THREADS_NPTL</code> is also needed, in which case, specifying only <code>NPTL</code> is sufficient)</li>
</ul>
</li>
<li>NPTL thread support
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_THREADS_NPTL</code></li>
<li>Comment string: <code>NPTL</code></li>
</ul>
</li>
<li>RPC support
<ul>
<li>Dependency symbol: <code>BR2_TOOLCHAIN_HAS_NATIVE_RPC</code></li>
<li>Comment string: <code>RPC</code></li>
</ul>
</li>
<li>wchar support
<ul>
<li>Dependency symbol: <code>BR2_USE_WCHAR</code></li>
<li>Comment string: <code>wchar</code></li>
</ul>
</li>
<li>dynamic library
<ul>
<li>Dependency symbol: <code>!BR2_STATIC_LIBS</code></li>
<li>Comment string: <code>dynamic library</code></li>
</ul>
</li>
</ul>
<h3 id="1825-dependencies-on-a-linux-kernel-built-by-buildroot"><a class="markdownIt-Anchor" href="#1825-dependencies-on-a-linux-kernel-built-by-buildroot"></a> 18.2.5. Dependencies on a Linux kernel built by buildroot</h3>
<p>Some packages need a Linux kernel to be built by buildroot. These are typically kernel modules or firmware. A comment should be added in the <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> file to express this dependency, similar to dependencies on toolchain options. The general format is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo needs a Linux kernel to be built</span><br></pre></td></tr></table></figure>
<p>If there is a dependency on both toolchain options and the Linux kernel, use this format:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo needs a toolchain w/ featA, featB, featC and a Linux kernel to be built</span><br></pre></td></tr></table></figure>
<h3 id="1826-dependencies-on-udev-dev-management"><a class="markdownIt-Anchor" href="#1826-dependencies-on-udev-dev-management"></a> 18.2.6. Dependencies on udev /dev management</h3>
<p>If a package needs udev /dev management, it should depend on symbol <code>BR2_PACKAGE_HAS_UDEV</code>, and the following comment should be added:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo needs udev /dev management</span><br></pre></td></tr></table></figure>
<p>If there is a dependency on both toolchain options and udev /dev management, use this format:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo needs udev /dev management and a toolchain w/ featA, featB, featC</span><br></pre></td></tr></table></figure>
<h3 id="1827-dependencies-on-features-provided-by-virtual-packages"><a class="markdownIt-Anchor" href="#1827-dependencies-on-features-provided-by-virtual-packages"></a> 18.2.7. Dependencies on features provided by virtual packages</h3>
<p>Some features can be provided by more than one package, such as the openGL libraries.</p>
<p>See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#virtual-package-tutorial">Section 18.12, “Infrastructure for virtual packages”</a> for more on the virtual packages.</p>
<h2 id="183-the-mk-file"><a class="markdownIt-Anchor" href="#183-the-mk-file"></a> 18.3. The <code>.mk</code> file</h2>
<p>Finally, here’s the hardest part. Create a file named <code>libfoo.mk</code>. It describes how the package should be downloaded, configured, built, installed, etc.</p>
<p>Depending on the package type, the <code>.mk</code> file must be written in a different way, using different infrastructures:</p>
<ul>
<li><em><strong>*Makefiles for generic packages*</strong></em> (not using autotools or CMake): These are based on an infrastructure similar to the one used for autotools-based packages, but require a little more work from the developer. They specify what should be done for the configuration, compilation and installation of the package. This infrastructure must be used for all packages that do not use the autotools as their build system. In the future, other specialized infrastructures might be written for other build systems. We cover them through in a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-tutorial">tutorial</a> and a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">reference</a>.</li>
<li><em><strong>*Makefiles for autotools-based software*</strong></em> (autoconf, automake, etc.): We provide a dedicated infrastructure for such packages, since autotools is a very common build system. This infrastructure <em>must</em> be used for new packages that rely on the autotools as their build system. We cover them through a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#autotools-package-tutorial">tutorial</a> and <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#autotools-package-reference">reference</a>.</li>
<li><em><strong>*Makefiles for cmake-based software*</strong></em>: We provide a dedicated infrastructure for such packages, as CMake is a more and more commonly used build system and has a standardized behaviour. This infrastructure <em>must</em> be used for new packages that rely on CMake. We cover them through a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#cmake-package-tutorial">tutorial</a> and <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#cmake-package-reference">reference</a>.</li>
<li><em><strong>*Makefiles for Python modules*</strong></em>: We have a dedicated infrastructure for Python modules that use the <code>flit</code>, <code>pep517</code>, <code>setuptools</code>, <code>setuptools-rust</code> or <code>maturin</code> mechanisms. We cover them through a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#python-package-tutorial">tutorial</a> and a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#python-package-reference">reference</a>.</li>
<li><em><strong>*Makefiles for Lua modules*</strong></em>: We have a dedicated infrastructure for Lua modules available through the LuaRocks web site. We cover them through a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#luarocks-package-tutorial">tutorial</a> and a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#luarocks-package-reference">reference</a>.</li>
</ul>
<p>Further formatting details: see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#writing-rules-mk">the writing rules</a>.</p>
<h2 id="184-the-hash-file"><a class="markdownIt-Anchor" href="#184-the-hash-file"></a> 18.4. The <code>.hash</code> file</h2>
<p>When possible, you must add a third file, named <code>libfoo.hash</code>, that contains the hashes of the downloaded files for the <code>libfoo</code> package. The only reason for not adding a <code>.hash</code> file is when hash checking is not possible due to how the package is downloaded.</p>
<p>When a package has a version selection choice, then the hash file may be stored in a subdirectory named after the version, e.g. <code>package/libfoo/1.2.3/libfoo.hash</code>. This is especially important if the different versions have different licensing terms, but they are stored in the same file. Otherwise, the hash file should stay in the package’s directory.</p>
<p>The hashes stored in that file are used to validate the integrity of the downloaded files and of the license files.</p>
<p>The format of this file is one line for each file for which to check the hash, each line with the following three fields separated by two spaces:</p>
<ul>
<li>the type of hash, one of:
<ul>
<li><code>md5</code>, <code>sha1</code>, <code>sha224</code>, <code>sha256</code>, <code>sha384</code>, <code>sha512</code></li>
</ul>
</li>
<li>the hash of the file:
<ul>
<li>for <code>md5</code>, 32 hexadecimal characters</li>
<li>for <code>sha1</code>, 40 hexadecimal characters</li>
<li>for <code>sha224</code>, 56 hexadecimal characters</li>
<li>for <code>sha256</code>, 64 hexadecimal characters</li>
<li>for <code>sha384</code>, 96 hexadecimal characters</li>
<li>for <code>sha512</code>, 128 hexadecimal characters</li>
</ul>
</li>
<li>the name of the file:
<ul>
<li>for a source archive: the basename of the file, without any directory component,</li>
<li>for a license file: the path as it appears in <code>FOO_LICENSE_FILES</code>.</li>
</ul>
</li>
</ul>
<p>Lines starting with a <code>#</code> sign are considered comments, and ignored. Empty lines are ignored.</p>
<p>There can be more than one hash for a single file, each on its own line. In this case, all hashes must match.</p>
<p><strong>Note.</strong> Ideally, the hashes stored in this file should match the hashes published by upstream, e.g. on their website, in the e-mail announcement… If upstream provides more than one type of hash (e.g. <code>sha1</code> and <code>sha512</code>), then it is best to add all those hashes in the <code>.hash</code> file. If upstream does not provide any hash, or only provides an <code>md5</code> hash, then compute at least one strong hash yourself (preferably <code>sha256</code>, but not <code>md5</code>), and mention this in a comment line above the hashes.</p>
<p><strong>Note.</strong> The hashes for license files are used to detect a license change when a package version is bumped. The hashes are checked during the make legal-info target run. For a package with multiple versions (like Qt5), create the hash file in a subdirectory <code>&lt;packageversion&gt;</code> of that package (see also <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#patch-apply-order">Section 19.2, “How patches are applied”</a>).</p>
<p>The example below defines a <code>sha1</code> and a <code>sha256</code> published by upstream for the main <code>libfoo-1.2.3.tar.bz2</code> tarball, an <code>md5</code> from upstream and a locally-computed <code>sha256</code> hashes for a binary blob, a <code>sha256</code> for a downloaded patch, and an archive with no hash:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Hashes from: http://www.foosoftware.org/download/libfoo-1.2.3.tar.bz2.&#123;sha1,sha256&#125;:</span><br><span class="line">sha1  486fb55c3efa71148fe07895fd713ea3a5ae343a  libfoo-1.2.3.tar.bz2</span><br><span class="line">sha256  efc8103cc3bcb06bda6a781532d12701eb081ad83e8f90004b39ab81b65d4369  libfoo-1.2.3.tar.bz2</span><br><span class="line"></span><br><span class="line"># md5 from: http://www.foosoftware.org/download/libfoo-1.2.3.tar.bz2.md5, sha256 locally computed:</span><br><span class="line">md5  2d608f3c318c6b7557d551a5a09314f03452f1a1  libfoo-data.bin</span><br><span class="line">sha256  01ba4719c80b6fe911b091a7c05124b64eeece964e09c058ef8f9805daca546b  libfoo-data.bin</span><br><span class="line"></span><br><span class="line"># Locally computed:</span><br><span class="line">sha256  ff52101fb90bbfc3fe9475e425688c660f46216d7e751c4bbdb1dc85cdccacb9  libfoo-fix-blabla.patch</span><br><span class="line"></span><br><span class="line"># Hash for license files:</span><br><span class="line">sha256  a45a845012742796534f7e91fe623262ccfb99460a2bd04015bd28d66fba95b8  COPYING</span><br><span class="line">sha256  01b1f9f2c8ee648a7a596a1abe8aa4ed7899b1c9e5551bda06da6e422b04aa55  doc/COPYING.LGPL</span><br></pre></td></tr></table></figure>
<p>If the <code>.hash</code> file is present, and it contains one or more hashes for a downloaded file, the hash(es) computed by Buildroot (after download) must match the hash(es) stored in the <code>.hash</code> file. If one or more hashes do not match, Buildroot considers this an error, deletes the downloaded file, and aborts.</p>
<p>If the <code>.hash</code> file is present, but it does not contain a hash for a downloaded file, Buildroot considers this an error and aborts. However, the downloaded file is left in the download directory since this typically indicates that the <code>.hash</code> file is wrong but the downloaded file is probably OK.</p>
<p>Hashes are currently checked for files fetched from http/ftp servers, Git or subversion repositories, files copied using scp and local files. Hashes are not checked for other version control systems (such as CVS, mercurial) because Buildroot currently does not generate reproducible tarballs when source code is fetched from such version control systems.</p>
<p>Additionally, for packages for which it is possible to specify a custom version (e.g. a custom version string, a remote tarball URL, or a VCS repository location and changeset), Buildroot can’t carry hashes for those. It is however possible to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-hashes">provide a list of extra hashes</a> that can cover such cases.</p>
<p>Hashes should only be added in <code>.hash</code> files for files that are guaranteed to be stable. For example, patches auto-generated by Github are not guaranteed to be stable, and therefore their hashes can change over time. Such patches should not be downloaded, and instead be added locally to the package folder.</p>
<p>If the <code>.hash</code> file is missing, then no check is done at all.</p>
<h2 id="185-the-snnfoo-start-script"><a class="markdownIt-Anchor" href="#185-the-snnfoo-start-script"></a> 18.5. The <code>SNNfoo</code> start script</h2>
<p>Packages that provide a system daemon usually need to be started somehow at boot. Buildroot comes with support for several init systems, some are considered tier one (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#init-system">Section 6.3, “init system”</a>), while others are also available but do not have the same level of integration. Ideally, all packages providing a system daemon should provide a start script for BusyBox/SysV init and a systemd unit file.</p>
<p>For consistency, the start script must follow the style and composition as shown in the reference: <code>package/busybox/S01syslogd</code>. An annotated example of this style is shown below. There is no specific coding style for systemd unit files, but if a package comes with its own unit file, that is preferred over a buildroot specific one, if it is compatible with buildroot.</p>
<p>The name of the start script is composed of the <code>SNN</code> and the daemon name. The <code>NN</code> is the start order number which needs to be carefully chosen. For example, a program that requires networking to be up should not start before <code>S40network</code>. The scripts are started in alphabetical order, so <code>S01syslogd</code> starts before <code>S01watchdogd</code>, and <code>S02sysctl</code> start thereafter.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">01: #!/bin/sh</span><br><span class="line">02:</span><br><span class="line">03: DAEMON=&quot;syslogd&quot;</span><br><span class="line">04: PIDFILE=&quot;/var/run/$DAEMON.pid&quot;</span><br><span class="line">05:</span><br><span class="line">06: SYSLOGD_ARGS=&quot;&quot;</span><br><span class="line">07:</span><br><span class="line">08: # shellcheck source=/dev/null</span><br><span class="line">09: [ -r &quot;/etc/default/$DAEMON&quot; ] &amp;&amp; . &quot;/etc/default/$DAEMON&quot;</span><br><span class="line">10:</span><br><span class="line">11: # BusyBox&#x27; syslogd does not create a pidfile, so pass &quot;-n&quot; in the command line</span><br><span class="line">12: # and use &quot;-m&quot; to instruct start-stop-daemon to create one.</span><br><span class="line">13: start() &#123;</span><br><span class="line">14:     printf &#x27;Starting %s: &#x27; &quot;$DAEMON&quot;</span><br><span class="line">15:     # shellcheck disable=SC2086 # we need the word splitting</span><br><span class="line">16:     start-stop-daemon -b -m -S -q -p &quot;$PIDFILE&quot; -x &quot;/sbin/$DAEMON&quot; \</span><br><span class="line">17:             -- -n $SYSLOGD_ARGS</span><br><span class="line">18:     status=$?</span><br><span class="line">19:     if [ &quot;$status&quot; -eq 0 ]; then</span><br><span class="line">20:             echo &quot;OK&quot;</span><br><span class="line">21:     else</span><br><span class="line">22:             echo &quot;FAIL&quot;</span><br><span class="line">23:     fi</span><br><span class="line">24:     return &quot;$status&quot;</span><br><span class="line">25: &#125;</span><br><span class="line">26:</span><br><span class="line">27: stop() &#123;</span><br><span class="line">28:     printf &#x27;Stopping %s: &#x27; &quot;$DAEMON&quot;</span><br><span class="line">29:     start-stop-daemon -K -q -p &quot;$PIDFILE&quot;</span><br><span class="line">30:     status=$?</span><br><span class="line">31:     if [ &quot;$status&quot; -eq 0 ]; then</span><br><span class="line">32:             rm -f &quot;$PIDFILE&quot;</span><br><span class="line">33:             echo &quot;OK&quot;</span><br><span class="line">34:     else</span><br><span class="line">35:             echo &quot;FAIL&quot;</span><br><span class="line">36:     fi</span><br><span class="line">37:     return &quot;$status&quot;</span><br><span class="line">38: &#125;</span><br><span class="line">39:</span><br><span class="line">40: restart() &#123;</span><br><span class="line">41:     stop</span><br><span class="line">42:     sleep 1</span><br><span class="line">43:     start</span><br><span class="line">44: &#125;</span><br><span class="line">45:</span><br><span class="line">46: case &quot;$1&quot; in</span><br><span class="line">47:     start|stop|restart)</span><br><span class="line">48:             &quot;$1&quot;;;</span><br><span class="line">49:     reload)</span><br><span class="line">50:             # Restart, since there is no true &quot;reload&quot; feature.</span><br><span class="line">51:             restart;;</span><br><span class="line">52:     *)</span><br><span class="line">53:             echo &quot;Usage: $0 &#123;start|stop|restart|reload&#125;&quot;</span><br><span class="line">54:             exit 1</span><br><span class="line">55: esac</span><br></pre></td></tr></table></figure>
<p><em><strong>*Note:*</strong></em> programs that support reloading their configuration in some fashion (<code>SIGHUP</code>) should provide a <code>reload()</code> function similar to <code>stop()</code>. The <code>start-stop-daemon</code> supports <code>-K -s HUP</code> for this. It is recommended to always append <code>-x &quot;/sbin/$DAEMON&quot;</code> to all the <code>start-stop-daemon</code> commands to ensure signals are set to a PID that matches <code>$DAEMON</code>.</p>
<p>Both start scripts and unit files can source command line arguments from <code>/etc/default/foo</code>, in general, if such a file does not exist it should not block the start of the daemon, unless there is some site specirfic command line argument the daemon requires to start. For start scripts a <code>FOO_ARGS=&quot;-s -o -m -e -args&quot;</code> can be defined to a default value in and the user can override this from <code>/etc/default/foo</code>.</p>
<h2 id="186-infrastructure-for-packages-with-specific-build-systems"><a class="markdownIt-Anchor" href="#186-infrastructure-for-packages-with-specific-build-systems"></a> 18.6. Infrastructure for packages with specific build systems</h2>
<p>By <em>packages with specific build systems</em> we mean all the packages whose build system is not one of the standard ones, such as <em>autotools</em> or <em>CMake</em>. This typically includes packages whose build system is based on hand-written Makefiles or shell scripts.</p>
<h3 id="1861-generic-package-tutorial"><a class="markdownIt-Anchor" href="#1861-generic-package-tutorial"></a> 18.6.1. <code>generic-package</code> tutorial</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # libfoo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LIBFOO_VERSION = 1.0</span><br><span class="line">08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz</span><br><span class="line">09: LIBFOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: LIBFOO_LICENSE = GPL-3.0+</span><br><span class="line">11: LIBFOO_LICENSE_FILES = COPYING</span><br><span class="line">12: LIBFOO_INSTALL_STAGING = YES</span><br><span class="line">13: LIBFOO_CONFIG_SCRIPTS = libfoo-config</span><br><span class="line">14: LIBFOO_DEPENDENCIES = host-libaaa libbbb</span><br><span class="line">15:</span><br><span class="line">16: define LIBFOO_BUILD_CMDS</span><br><span class="line">17:     $(MAKE) $(TARGET_CONFIGURE_OPTS) -C $(@D) all</span><br><span class="line">18: endef</span><br><span class="line">19:</span><br><span class="line">20: define LIBFOO_INSTALL_STAGING_CMDS</span><br><span class="line">21:     $(INSTALL) -D -m 0755 $(@D)/libfoo.a $(STAGING_DIR)/usr/lib/libfoo.a</span><br><span class="line">22:     $(INSTALL) -D -m 0644 $(@D)/foo.h $(STAGING_DIR)/usr/include/foo.h</span><br><span class="line">23:     $(INSTALL) -D -m 0755 $(@D)/libfoo.so* $(STAGING_DIR)/usr/lib</span><br><span class="line">24: endef</span><br><span class="line">25:</span><br><span class="line">26: define LIBFOO_INSTALL_TARGET_CMDS</span><br><span class="line">27:     $(INSTALL) -D -m 0755 $(@D)/libfoo.so* $(TARGET_DIR)/usr/lib</span><br><span class="line">28:     $(INSTALL) -d -m 0755 $(TARGET_DIR)/etc/foo.d</span><br><span class="line">29: endef</span><br><span class="line">30:</span><br><span class="line">31: define LIBFOO_USERS</span><br><span class="line">32:     foo -1 libfoo -1 * - - - LibFoo daemon</span><br><span class="line">33: endef</span><br><span class="line">34:</span><br><span class="line">35: define LIBFOO_DEVICES</span><br><span class="line">36:     /dev/foo c 666 0 0 42 0 - - -</span><br><span class="line">37: endef</span><br><span class="line">38:</span><br><span class="line">39: define LIBFOO_PERMISSIONS</span><br><span class="line">40:     /bin/foo f 4755 foo libfoo - - - - -</span><br><span class="line">41: endef</span><br><span class="line">42:</span><br><span class="line">43: $(eval $(generic-package))</span><br></pre></td></tr></table></figure>
<p>The Makefile begins on line 7 to 11 with metadata information: the version of the package (<code>LIBFOO_VERSION</code>), the name of the tarball containing the package (<code>LIBFOO_SOURCE</code>) (xz-ed tarball recommended) the Internet location at which the tarball can be downloaded from (<code>LIBFOO_SITE</code>), the license (<code>LIBFOO_LICENSE</code>) and file with the license text (<code>LIBFOO_LICENSE_FILES</code>). All variables must start with the same prefix, <code>LIBFOO_</code> in this case. This prefix is always the uppercased version of the package name (see below to understand where the package name is defined).</p>
<p>On line 12, we specify that this package wants to install something to the staging space. This is often needed for libraries, since they must install header files and other development files in the staging space. This will ensure that the commands listed in the <code>LIBFOO_INSTALL_STAGING_CMDS</code> variable will be executed.</p>
<p>On line 13, we specify that there is some fixing to be done to some of the <em>libfoo-config</em> files that were installed during <code>LIBFOO_INSTALL_STAGING_CMDS</code> phase. These *-config files are executable shell script files that are located in <em>$(STAGING_DIR)/usr/bin</em> directory and are executed by other 3rd party packages to find out the location and the linking flags of this particular package.</p>
<p>The problem is that all these *-config files by default give wrong, host system linking flags that are unsuitable for cross-compiling.</p>
<p>For example: <em>-I/usr/include</em> instead of <em>-I<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mi>T</mi><mi>A</mi><mi>G</mi><mi>I</mi><mi>N</mi><msub><mi>G</mi><mi>D</mi></msub><mi>I</mi><mi>R</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>u</mi><mi>s</mi><mi>r</mi><mi mathvariant="normal">/</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>u</mi><mi>d</mi><mi>e</mi><mo>∗</mo><mi>o</mi><mi>r</mi><mo>:</mo><mo>∗</mo><mo>−</mo><mi>L</mi><mi mathvariant="normal">/</mi><mi>u</mi><mi>s</mi><mi>r</mi><mi mathvariant="normal">/</mi><mi>l</mi><mi>i</mi><mi>b</mi><mo>∗</mo><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>o</mi><mi>f</mi><mo>∗</mo><mo>−</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">(STAGING_DIR)/usr/include* or: *-L/usr/lib* instead of *-L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">A</span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">/</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord">/</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord mathnormal">L</span></span></span></span>(STAGING_DIR)/usr/lib</em></p>
<p>So some sed magic is done to these scripts to make them give correct flags. The argument to be given to <code>LIBFOO_CONFIG_SCRIPTS</code> is the file name(s) of the shell script(s) needing fixing. All these names are relative to <em>$(STAGING_DIR)/usr/bin</em> and if needed multiple names can be given.</p>
<p>In addition, the scripts listed in <code>LIBFOO_CONFIG_SCRIPTS</code> are removed from <code>$(TARGET_DIR)/usr/bin</code>, since they are not needed on the target.</p>
<p><strong>Example 18.1. Config script: *divine* package</strong></p>
<p>Package divine installs shell script <em>$(STAGING_DIR)/usr/bin/divine-config</em>.</p>
<p>So its fixup would be:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DIVINE_CONFIG_SCRIPTS = divine-config</span><br></pre></td></tr></table></figure>
<p><strong>Example 18.2. Config script: *imagemagick* package:</strong></p>
<p>Package imagemagick installs the following scripts: <em>$(STAGING_DIR)/usr/bin/{Magick,Magick++,MagickCore,MagickWand,Wand}-config</em></p>
<p>So it’s fixup would be:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IMAGEMAGICK_CONFIG_SCRIPTS = \</span><br><span class="line">   Magick-config Magick++-config \</span><br><span class="line">   MagickCore-config MagickWand-config Wand-config</span><br></pre></td></tr></table></figure>
<p>On line 14, we specify the list of dependencies this package relies on. These dependencies are listed in terms of lower-case package names, which can be packages for the target (without the <code>host-</code> prefix) or packages for the host (with the <code>host-</code>) prefix). Buildroot will ensure that all these packages are built and installed <em>before</em> the current package starts its configuration.</p>
<p>The rest of the Makefile, lines 16…29, defines what should be done at the different steps of the package configuration, compilation and installation. <code>LIBFOO_BUILD_CMDS</code> tells what steps should be performed to build the package. <code>LIBFOO_INSTALL_STAGING_CMDS</code> tells what steps should be performed to install the package in the staging space. <code>LIBFOO_INSTALL_TARGET_CMDS</code> tells what steps should be performed to install the package in the target space.</p>
<p>All these steps rely on the <code>$(@D)</code> variable, which contains the directory where the source code of the package has been extracted.</p>
<p>On lines 31…33, we define a user that is used by this package (e.g. to run a daemon as non-root) (<code>LIBFOO_USERS</code>).</p>
<p>On line 35…37, we define a device-node file used by this package (<code>LIBFOO_DEVICES</code>).</p>
<p>On line 39…41, we define the permissions to set to specific files installed by this package (<code>LIBFOO_PERMISSIONS</code>).</p>
<p>Finally, on line 43, we call the <code>generic-package</code> function, which generates, according to the variables defined previously, all the Makefile code necessary to make your package working.</p>
<h3 id="1862-generic-package-reference"><a class="markdownIt-Anchor" href="#1862-generic-package-reference"></a> 18.6.2. <code>generic-package</code> reference</h3>
<p>There are two variants of the generic target. The <code>generic-package</code> macro is used for packages to be cross-compiled for the target. The <code>host-generic-package</code> macro is used for host packages, natively compiled for the host. It is possible to call both of them in a single <code>.mk</code> file: once to create the rules to generate a target package and once to create the rules to generate a host package:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(eval $(generic-package))</span><br><span class="line">$(eval $(host-generic-package))</span><br></pre></td></tr></table></figure>
<p>This might be useful if the compilation of the target package requires some tools to be installed on the host. If the package name is <code>libfoo</code>, then the name of the package for the target is also <code>libfoo</code>, while the name of the package for the host is <code>host-libfoo</code>. These names should be used in the DEPENDENCIES variables of other packages, if they depend on <code>libfoo</code> or <code>host-libfoo</code>.</p>
<p>The call to the <code>generic-package</code> and/or <code>host-generic-package</code> macro <em><strong>*must*</strong></em> be at the end of the <code>.mk</code> file, after all variable definitions. The call to <code>host-generic-package</code> <em><strong>*must*</strong></em> be after the call to <code>generic-package</code>, if any.</p>
<p>For the target package, the <code>generic-package</code> uses the variables defined by the .mk file and prefixed by the uppercased package name: <code>LIBFOO_*</code>. <code>host-generic-package</code> uses the <code>HOST_LIBFOO_*</code> variables. For <em>some</em> variables, if the <code>HOST_LIBFOO_</code> prefixed variable doesn’t exist, the package infrastructure uses the corresponding variable prefixed by <code>LIBFOO_</code>. This is done for variables that are likely to have the same value for both the target and host packages. See below for details.</p>
<p>The list of variables that can be set in a <code>.mk</code> file to give metadata information is (assuming the package name is <code>libfoo</code>) :</p>
<ul>
<li>
<p><code>LIBFOO_VERSION</code>, mandatory, must contain the version of the package. Note that if <code>HOST_LIBFOO_VERSION</code> doesn’t exist, it is assumed to be the same as <code>LIBFOO_VERSION</code>. It can also be a revision number or a tag for packages that are fetched directly from their version control system. Examples:</p>
<ul>
<li>
<p>a version for a release tarball: <code>LIBFOO_VERSION = 0.1.2</code></p>
</li>
<li>
<p>a sha1 for a git tree: <code>LIBFOO_VERSION = cb9d6aa9429e838f0e54faa3d455bcbab5eef057</code></p>
</li>
<li>
<p>a tag for a git tree <code>LIBFOO_VERSION = v0.1.2</code></p>
<p><strong>Note:</strong> Using a branch name as <code>FOO_VERSION</code> is not supported, because it does not and can not work as people would expect it should:</p>
<ol>
<li>due to local caching, Buildroot will not re-fetch the repository, so people who expect to be able to follow the remote repository would be quite surprised and disappointed;</li>
<li>because two builds can never be perfectly simultaneous, and because the remote repository may get new commits on the branch anytime, two users, using the same Buildroot tree and building the same configuration, may get different source, thus rendering the build non reproducible, and people would be quite surprised and disappointed.</li>
</ol>
</li>
</ul>
</li>
<li>
<p><code>LIBFOO_SOURCE</code> may contain the name of the tarball of the package, which Buildroot will use to download the tarball from <code>LIBFOO_SITE</code>. If <code>HOST_LIBFOO_SOURCE</code> is not specified, it defaults to <code>LIBFOO_SOURCE</code>. If none are specified, then the value is assumed to be <code>libfoo-$(LIBFOO_VERSION).tar.gz</code>. Example: <code>LIBFOO_SOURCE = foobar-$(LIBFOO_VERSION).tar.bz2</code></p>
</li>
<li>
<p><code>LIBFOO_PATCH</code> may contain a space-separated list of patch file names, that Buildroot will download and apply to the package source code. If an entry contains <code>://</code>, then Buildroot will assume it is a full URL and download the patch from this location. Otherwise, Buildroot will assume that the patch should be downloaded from <code>LIBFOO_SITE</code>. If <code>HOST_LIBFOO_PATCH</code> is not specified, it defaults to <code>LIBFOO_PATCH</code>. Note that patches that are included in Buildroot itself use a different mechanism: all files of the form <code>*.patch</code> present in the package directory inside Buildroot will be applied to the package after extraction (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#patch-policy">patching a package</a>). Finally, patches listed in the <code>LIBFOO_PATCH</code> variable are applied <em>before</em> the patches stored in the Buildroot package directory.</p>
</li>
<li>
<p><code>LIBFOO_SITE</code> provides the location of the package, which can be a URL or a local filesystem path. HTTP, FTP and SCP are supported URL types for retrieving package tarballs. In these cases don’t include a trailing slash: it will be added by Buildroot between the directory and the filename as appropriate. Git, Subversion, Mercurial, and Bazaar are supported URL types for retrieving packages directly from source code management systems. There is a helper function to make it easier to download source tarballs from GitHub (refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#github-download-url">Section 18.25.4, “How to add a package from GitHub”</a> for details). A filesystem path may be used to specify either a tarball or a directory containing the package source code. See <code>LIBFOO_SITE_METHOD</code> below for more details on how retrieval works. Note that SCP URLs should be of the form <code>scp://[user@]host:filepath</code>, and that filepath is relative to the user’s home directory, so you may want to prepend the path with a slash for absolute paths: <code>scp://[user@]host:/absolutepath</code>. The same goes for SFTP URLs. If <code>HOST_LIBFOO_SITE</code> is not specified, it defaults to <code>LIBFOO_SITE</code>. Examples: <code>LIBFOO_SITE=http://www.libfoosoftware.org/libfoo</code> <code>LIBFOO_SITE=http://svn.xiph.org/trunk/Tremor</code> <code>LIBFOO_SITE=/opt/software/libfoo.tar.gz</code> <code>LIBFOO_SITE=$(TOPDIR)/../src/libfoo</code></p>
</li>
<li>
<p><code>LIBFOO_DL_OPTS</code> is a space-separated list of additional options to pass to the downloader. Useful for retrieving documents with server-side checking for user logins and passwords, or to use a proxy. All download methods valid for <code>LIBFOO_SITE_METHOD</code> are supported; valid options depend on the download method (consult the man page for the respective download utilities).</p>
</li>
<li>
<p><code>LIBFOO_EXTRA_DOWNLOADS</code> is a space-separated list of additional files that Buildroot should download. If an entry contains <code>://</code> then Buildroot will assume it is a complete URL and will download the file using this URL. Otherwise, Buildroot will assume the file to be downloaded is located at <code>LIBFOO_SITE</code>. Buildroot will not do anything with those additional files, except download them: it will be up to the package recipe to use them from <code>$(LIBFOO_DL_DIR)</code>.</p>
</li>
<li>
<p><code>LIBFOO_SITE_METHOD</code> determines the method used to fetch or copy the package source code. In many cases, Buildroot guesses the method from the contents of <code>LIBFOO_SITE</code> and setting <code>LIBFOO_SITE_METHOD</code> is unnecessary. When <code>HOST_LIBFOO_SITE_METHOD</code> is not specified, it defaults to the value of <code>LIBFOO_SITE_METHOD</code>. The possible values of <code>LIBFOO_SITE_METHOD</code> are:</p>
<ul>
<li><code>wget</code> for normal FTP/HTTP downloads of tarballs. Used by default when <code>LIBFOO_SITE</code> begins with <code>http://</code>, <code>https://</code> or <code>ftp://</code>.</li>
<li><code>scp</code> for downloads of tarballs over SSH with scp. Used by default when <code>LIBFOO_SITE</code> begins with <code>scp://</code>.</li>
<li><code>sftp</code> for downloads of tarballs over SSH with sftp. Used by default when <code>LIBFOO_SITE</code> begins with <code>sftp://</code>.</li>
<li><code>svn</code> for retrieving source code from a Subversion repository. Used by default when <code>LIBFOO_SITE</code> begins with <code>svn://</code>. When a <code>http://</code> Subversion repository URL is specified in <code>LIBFOO_SITE</code>, one <em>must</em> specify <code>LIBFOO_SITE_METHOD=svn</code>. Buildroot performs a checkout which is preserved as a tarball in the download cache; subsequent builds use the tarball instead of performing another checkout.</li>
<li><code>cvs</code> for retrieving source code from a CVS repository. Used by default when <code>LIBFOO_SITE</code> begins with <code>cvs://</code>. The downloaded source code is cached as with the <code>svn</code> method. Anonymous pserver mode is assumed otherwise explicitly defined on <code>LIBFOO_SITE</code>. Both <code>LIBFOO_SITE=cvs://libfoo.net:/cvsroot/libfoo</code> and <code>LIBFOO_SITE=cvs://:ext:libfoo.net:/cvsroot/libfoo</code> are accepted, on the former anonymous pserver access mode is assumed. <code>LIBFOO_SITE</code> <em>must</em> contain the source URL as well as the remote repository directory. The module is the package name. <code>LIBFOO_VERSION</code> is <em>mandatory</em> and <em>must</em> be a tag, a branch, or a date (e.g. “2014-10-20”, “2014-10-20 13:45”, “2014-10-20 13:45+01” see “man cvs” for further details).</li>
<li><code>git</code> for retrieving source code from a Git repository. Used by default when <code>LIBFOO_SITE</code> begins with <code>git://</code>. The downloaded source code is cached as with the <code>svn</code> method.</li>
<li><code>hg</code> for retrieving source code from a Mercurial repository. One <em>must</em> specify <code>LIBFOO_SITE_METHOD=hg</code> when <code>LIBFOO_SITE</code> contains a Mercurial repository URL. The downloaded source code is cached as with the <code>svn</code> method.</li>
<li><code>bzr</code> for retrieving source code from a Bazaar repository. Used by default when <code>LIBFOO_SITE</code> begins with <code>bzr://</code>. The downloaded source code is cached as with the <code>svn</code> method.</li>
<li><code>file</code> for a local tarball. One should use this when <code>LIBFOO_SITE</code> specifies a package tarball as a local filename. Useful for software that isn’t available publicly or in version control.</li>
<li><code>local</code> for a local source code directory. One should use this when <code>LIBFOO_SITE</code> specifies a local directory path containing the package source code. Buildroot copies the contents of the source directory into the package’s build directory. Note that for <code>local</code> packages, no patches are applied. If you need to still patch the source code, use <code>LIBFOO_POST_RSYNC_HOOKS</code>, see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks-rsync">Section 18.23.1, “Using the <code>POST_RSYNC</code> hook”</a>.</li>
</ul>
</li>
<li>
<p><code>LIBFOO_GIT_SUBMODULES</code> can be set to <code>YES</code> to create an archive with the git submodules in the repository. This is only available for packages downloaded with git (i.e. when <code>LIBFOO_SITE_METHOD=git</code>). Note that we try not to use such git submodules when they contain bundled libraries, in which case we prefer to use those libraries from their own package.</p>
</li>
<li>
<p><code>LIBFOO_GIT_LFS</code> should be set to <code>YES</code> if the Git repository uses Git LFS to store large files out of band. This is only available for packages downloaded with git (i.e. when <code>LIBFOO_SITE_METHOD=git</code>).</p>
</li>
<li>
<p><code>LIBFOO_SVN_EXTERNALS</code> can be set to <code>YES</code> to create an archive with the svn external references. This is only available for packages downloaded with subversion.</p>
</li>
<li>
<p><code>LIBFOO_STRIP_COMPONENTS</code> is the number of leading components (directories) that tar must strip from file names on extraction. The tarball for most packages has one leading component named “<pkg-name>-<pkg-version>”, thus Buildroot passes --strip-components=1 to tar to remove it. For non-standard packages that don’t have this component, or that have more than one leading component to strip, set this variable with the value to be passed to tar. Default: 1.</p>
</li>
<li>
<p><code>LIBFOO_EXCLUDES</code> is a space-separated list of patterns to exclude when extracting the archive. Each item from that list is passed as a tar’s <code>--exclude</code> option. By default, empty.</p>
</li>
<li>
<p><code>LIBFOO_DEPENDENCIES</code> lists the dependencies (in terms of package name) that are required for the current target package to compile. These dependencies are guaranteed to be compiled and installed before the configuration of the current package starts. However, modifications to configuration of these dependencies will not force a rebuild of the current package. In a similar way, <code>HOST_LIBFOO_DEPENDENCIES</code> lists the dependencies for the current host package.</p>
</li>
<li>
<p><code>LIBFOO_EXTRACT_DEPENDENCIES</code> lists the dependencies (in terms of package name) that are required for the current target package to be extracted. These dependencies are guaranteed to be compiled and installed before the extract step of the current package starts. This is only used internally by the package infrastructure, and should typically not be used directly by packages.</p>
</li>
<li>
<p><code>LIBFOO_PATCH_DEPENDENCIES</code> lists the dependencies (in terms of package name) that are required for the current package to be patched. These dependencies are guaranteed to be extracted and patched (but not necessarily built) before the current package is patched. In a similar way, <code>HOST_LIBFOO_PATCH_DEPENDENCIES</code> lists the dependencies for the current host package. This is seldom used; usually, <code>LIBFOO_DEPENDENCIES</code> is what you really want to use.</p>
</li>
<li>
<p><code>LIBFOO_PROVIDES</code> lists all the virtual packages <code>libfoo</code> is an implementation of. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#virtual-package-tutorial">Section 18.12, “Infrastructure for virtual packages”</a>.</p>
</li>
<li>
<p><code>LIBFOO_INSTALL_STAGING</code> can be set to <code>YES</code> or <code>NO</code> (default). If set to <code>YES</code>, then the commands in the <code>LIBFOO_INSTALL_STAGING_CMDS</code> variables are executed to install the package into the staging directory.</p>
</li>
<li>
<p><code>LIBFOO_INSTALL_TARGET</code> can be set to <code>YES</code> (default) or <code>NO</code>. If set to <code>YES</code>, then the commands in the <code>LIBFOO_INSTALL_TARGET_CMDS</code> variables are executed to install the package into the target directory.</p>
</li>
<li>
<p><code>LIBFOO_INSTALL_IMAGES</code> can be set to <code>YES</code> or <code>NO</code> (default). If set to <code>YES</code>, then the commands in the <code>LIBFOO_INSTALL_IMAGES_CMDS</code> variable are executed to install the package into the images directory.</p>
</li>
<li>
<p><code>LIBFOO_CONFIG_SCRIPTS</code> lists the names of the files in <em><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mi>T</mi><mi>A</mi><mi>G</mi><mi>I</mi><mi>N</mi><msub><mi>G</mi><mi>D</mi></msub><mi>I</mi><mi>R</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>u</mi><mi>s</mi><mi>r</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>i</mi><mi>n</mi><mo>∗</mo><mi>t</mi><mi>h</mi><mi>a</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>e</mi><mi>d</mi><mi>s</mi><mi>o</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>p</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi>f</mi><mi>i</mi><mi>x</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>o</mi><mi>m</mi><mi>a</mi><mi>k</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>m</mi><mi>c</mi><mi>r</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>−</mo><mi>c</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>i</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>f</mi><mi>r</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>l</mi><mi>y</mi><mi mathvariant="normal">.</mi><mi>M</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi>i</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>b</mi><mi>y</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>c</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>n</mi><mi>b</mi><mi>e</mi><mi>g</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>r</mi><mi>e</mi><mi>r</mi><mi>e</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>t</mi><mi>o</mi><mo>∗</mo></mrow><annotation encoding="application/x-tex">(STAGING_DIR)/usr/bin* that need some special fixing to make them cross-compiling friendly. Multiple file names separated by space can be given and all are relative to *</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">A</span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord">∗</span></span></span></span>(STAGING_DIR)/usr/bin</em>. The files listed in <code>LIBFOO_CONFIG_SCRIPTS</code> are also removed from <code>$(TARGET_DIR)/usr/bin</code> since they are not needed on the target.</p>
</li>
<li>
<p><code>LIBFOO_DEVICES</code> lists the device files to be created by Buildroot when using the static device table. The syntax to use is the makedevs one. You can find some documentation for this syntax in the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#makedev-syntax">Chapter 25, <em>Makedev syntax documentation</em></a>. This variable is optional.</p>
</li>
<li>
<p><code>LIBFOO_PERMISSIONS</code> lists the changes of permissions to be done at the end of the build process. The syntax is once again the makedevs one. You can find some documentation for this syntax in the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#makedev-syntax">Chapter 25, <em>Makedev syntax documentation</em></a>. This variable is optional.</p>
</li>
<li>
<p><code>LIBFOO_USERS</code> lists the users to create for this package, if it installs a program you want to run as a specific user (e.g. as a daemon, or as a cron-job). The syntax is similar in spirit to the makedevs one, and is described in the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#makeuser-syntax">Chapter 26, <em>Makeusers syntax documentation</em></a>. This variable is optional.</p>
</li>
<li>
<p><code>LIBFOO_LICENSE</code> defines the license (or licenses) under which the package is released. This name will appear in the manifest file produced by <code>make legal-info</code>. If the license appears in <a target="_blank" rel="noopener" href="https://spdx.org/licenses/">the SPDX License List</a>, use the SPDX short identifier to make the manifest file uniform. Otherwise, describe the license in a precise and concise way, avoiding ambiguous names such as <code>BSD</code> which actually name a family of licenses. This variable is optional. If it is not defined, <code>unknown</code> will appear in the <code>license</code> field of the manifest file for this package. The expected format for this variable must comply with the following rules:</p>
<ul>
<li>If different parts of the package are released under different licenses, then <code>comma</code> separate licenses (e.g. <code>LIBFOO_LICENSE = GPL-2.0+, LGPL-2.1+</code>). If there is clear distinction between which component is licensed under what license, then annotate the license with that component, between parenthesis (e.g. <code>LIBFOO_LICENSE = GPL-2.0+ (programs), LGPL-2.1+ (libraries)</code>).</li>
<li>If some licenses are conditioned on a sub-option being enabled, append the conditional licenses with a comma (e.g.: <code>FOO_LICENSE += , GPL-2.0+ (programs)</code>); the infrastructure will internally remove the space before the comma.</li>
<li>If the package is dual licensed, then separate licenses with the <code>or</code> keyword (e.g. <code>LIBFOO_LICENSE = AFL-2.1 or GPL-2.0+</code>).</li>
</ul>
</li>
<li>
<p><code>LIBFOO_LICENSE_FILES</code> is a space-separated list of files in the package tarball that contain the license(s) under which the package is released. <code>make legal-info</code> copies all of these files in the <code>legal-info</code> directory. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#legal-info">Chapter 13, <em>Legal notice and licensing</em></a> for more information. This variable is optional. If it is not defined, a warning will be produced to let you know, and <code>not saved</code> will appear in the <code>license files</code> field of the manifest file for this package.</p>
</li>
<li>
<p><code>LIBFOO_ACTUAL_SOURCE_TARBALL</code> only applies to packages whose <code>LIBFOO_SITE</code> / <code>LIBFOO_SOURCE</code> pair points to an archive that does not actually contain source code, but binary code. This a very uncommon case, only known to apply to external toolchains which come already compiled, although theoretically it might apply to other packages. In such cases a separate tarball is usually available with the actual source code. Set <code>LIBFOO_ACTUAL_SOURCE_TARBALL</code> to the name of the actual source code archive and Buildroot will download it and use it when you run <code>make legal-info</code> to collect legally-relevant material. Note this file will not be downloaded during regular builds nor by <code>make source</code>.</p>
</li>
<li>
<p><code>LIBFOO_ACTUAL_SOURCE_SITE</code> provides the location of the actual source tarball. The default value is <code>LIBFOO_SITE</code>, so you don’t need to set this variable if the binary and source archives are hosted on the same directory. If <code>LIBFOO_ACTUAL_SOURCE_TARBALL</code> is not set, it doesn’t make sense to define <code>LIBFOO_ACTUAL_SOURCE_SITE</code>.</p>
</li>
<li>
<p><code>LIBFOO_REDISTRIBUTE</code> can be set to <code>YES</code> (default) or <code>NO</code> to indicate if the package source code is allowed to be redistributed. Set it to <code>NO</code> for non-opensource packages: Buildroot will not save the source code for this package when collecting the <code>legal-info</code>.</p>
</li>
<li>
<p><code>LIBFOO_FLAT_STACKSIZE</code> defines the stack size of an application built into the FLAT binary format. The application stack size on the NOMMU architecture processors can’t be enlarged at run time. The default stack size for the FLAT binary format is only 4k bytes. If the application consumes more stack, append the required number here.</p>
</li>
<li>
<p><code>LIBFOO_BIN_ARCH_EXCLUDE</code> is a space-separated list of paths (relative to the target directory) to ignore when checking that the package installs correctly cross-compiled binaries. You seldom need to set this variable, unless the package installs binary blobs outside the default locations, <code>/lib/firmware</code>, <code>/usr/lib/firmware</code>, <code>/lib/modules</code>, <code>/usr/lib/modules</code>, and <code>/usr/share</code>, which are automatically excluded.</p>
</li>
<li>
<p><code>LIBFOO_IGNORE_CVES</code> is a space-separated list of CVEs that tells Buildroot CVE tracking tools which CVEs should be ignored for this package. This is typically used when the CVE is fixed by a patch in the package, or when the CVE for some reason does not affect the Buildroot package. A Makefile comment must always precede the addition of a CVE to this variable. Example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 0001-fix-cve-2020-12345.patch</span><br><span class="line">LIBFOO_IGNORE_CVES += CVE-2020-12345</span><br><span class="line"># only when built with libbaz, which Buildroot doesn&#x27;t support</span><br><span class="line">LIBFOO_IGNORE_CVES += CVE-2020-54321</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>LIBFOO_CPE_ID_*</code> variables is a set of variables that allows the package to define its <a target="_blank" rel="noopener" href="https://nvd.nist.gov/products/cpe">CPE identifier</a>. The available variables are:</p>
<ul>
<li><code>LIBFOO_CPE_ID_VALID</code>, if set to <code>YES</code>, specifies that the default values for each of the following variables is appropriate, and generates a valid CPE ID.</li>
<li><code>LIBFOO_CPE_ID_PREFIX</code>, specifies the prefix of the CPE identifier, i.e the first three fields. When not defined, the default value is <code>cpe:2.3:a</code>.</li>
<li><code>LIBFOO_CPE_ID_VENDOR</code>, specifies the vendor part of the CPE identifier. When not defined, the default value is <code>&lt;pkgname&gt;_project</code>.</li>
<li><code>LIBFOO_CPE_ID_PRODUCT</code>, specifies the product part of the CPE identifier. When not defined, the default value is <code>&lt;pkgname&gt;</code>.</li>
<li><code>LIBFOO_CPE_ID_VERSION</code>, specifies the version part of the CPE identifier. When not defined the default value is <code>$(LIBFOO_VERSION)</code>.</li>
<li><code>LIBFOO_CPE_ID_UPDATE</code> specifies the <em>update</em> part of the CPE identifier. When not defined the default value is <code>*</code>.</li>
</ul>
<p>If any of those variables is defined, then the generic package infrastructure assumes the package provides valid CPE information. In this case, the generic package infrastructure will define <code>LIBFOO_CPE_ID</code>.</p>
<p>For a host package, if its <code>LIBFOO_CPE_ID_*</code> variables are not defined, it inherits the value of those variables from the corresponding target package.</p>
</li>
</ul>
<p>The recommended way to define these variables is to use the following syntax:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIBFOO_VERSION = 2.32</span><br></pre></td></tr></table></figure>
<p>Now, the variables that define what should be performed at the different steps of the build process.</p>
<ul>
<li><code>LIBFOO_EXTRACT_CMDS</code> lists the actions to be performed to extract the package. This is generally not needed as tarballs are automatically handled by Buildroot. However, if the package uses a non-standard archive format, such as a ZIP or RAR file, or has a tarball with a non-standard organization, this variable allows to override the package infrastructure default behavior.</li>
<li><code>LIBFOO_CONFIGURE_CMDS</code> lists the actions to be performed to configure the package before its compilation.</li>
<li><code>LIBFOO_BUILD_CMDS</code> lists the actions to be performed to compile the package.</li>
<li><code>HOST_LIBFOO_INSTALL_CMDS</code> lists the actions to be performed to install the package, when the package is a host package. The package must install its files to the directory given by <code>$(HOST_DIR)</code>. All files, including development files such as headers should be installed, since other packages might be compiled on top of this package.</li>
<li><code>LIBFOO_INSTALL_TARGET_CMDS</code> lists the actions to be performed to install the package to the target directory, when the package is a target package. The package must install its files to the directory given by <code>$(TARGET_DIR)</code>. Only the files required for <em>execution</em> of the package have to be installed. Header files, static libraries and documentation will be removed again when the target filesystem is finalized.</li>
<li><code>LIBFOO_INSTALL_STAGING_CMDS</code> lists the actions to be performed to install the package to the staging directory, when the package is a target package. The package must install its files to the directory given by <code>$(STAGING_DIR)</code>. All development files should be installed, since they might be needed to compile other packages.</li>
<li><code>LIBFOO_INSTALL_IMAGES_CMDS</code> lists the actions to be performed to install the package to the images directory, when the package is a target package. The package must install its files to the directory given by <code>$(BINARIES_DIR)</code>. Only files that are binary images (aka images) that do not belong in the <code>TARGET_DIR</code> but are necessary for booting the board should be placed here. For example, a package should utilize this step if it has binaries which would be similar to the kernel image, bootloader or root filesystem images.</li>
<li><code>LIBFOO_INSTALL_INIT_SYSV</code>, <code>LIBFOO_INSTALL_INIT_OPENRC</code> and <code>LIBFOO_INSTALL_INIT_SYSTEMD</code> list the actions to install init scripts either for the systemV-like init systems (busybox, sysvinit, etc.), openrc or for the systemd units. These commands will be run only when the relevant init system is installed (i.e. if systemd is selected as the init system in the configuration, only <code>LIBFOO_INSTALL_INIT_SYSTEMD</code> will be run). The only exception is when openrc is chosen as init system and <code>LIBFOO_INSTALL_INIT_OPENRC</code> has not been set, in such situation <code>LIBFOO_INSTALL_INIT_SYSV</code> will be called, since openrc supports sysv init scripts. When systemd is used as the init system, buildroot will automatically enable all services using the <code>systemctl preset-all</code> command in the final phase of image building. You can add preset files to prevent a particular unit from being automatically enabled by buildroot.</li>
<li><code>LIBFOO_HELP_CMDS</code> lists the actions to print the package help, which is included to the main <code>make help</code> output. These commands can print anything in any format. This is seldom used, as packages rarely have custom rules. <em><strong>*Do not use this variable*</strong></em>, unless you really know that you need to print help.</li>
<li><code>LIBFOO_LINUX_CONFIG_FIXUPS</code> lists the Linux kernel configuration options that are needed to build and use this package, and without which the package is fundamentally broken. This shall be a set of calls to one of the kconfig tweaking option: <code>KCONFIG_ENABLE_OPT</code>, <code>KCONFIG_DISABLE_OPT</code>, or <code>KCONFIG_SET_OPT</code>. This is seldom used, as package usually have no strict requirements on the kernel options.</li>
</ul>
<p>The preferred way to define these variables is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">define LIBFOO_CONFIGURE_CMDS</span><br><span class="line">        action 1</span><br><span class="line">        action 2</span><br><span class="line">        action 3</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>In the action definitions, you can use the following variables:</p>
<ul>
<li><code>$(LIBFOO_PKGDIR)</code> contains the path to the directory containing the <code>libfoo.mk</code> and <code>Config.in</code> files. This variable is useful when it is necessary to install a file bundled in Buildroot, like a runtime configuration file, a splashscreen image…</li>
<li><code>$(@D)</code>, which contains the directory in which the package source code has been uncompressed.</li>
<li><code>$(LIBFOO_DL_DIR)</code> contains the path to the directory where all the downloads made by Buildroot for <code>libfoo</code> are stored in.</li>
<li><code>$(TARGET_CC)</code>, <code>$(TARGET_LD)</code>, etc. to get the target cross-compilation utilities</li>
<li><code>$(TARGET_CROSS)</code> to get the cross-compilation toolchain prefix</li>
<li>Of course the <code>$(HOST_DIR)</code>, <code>$(STAGING_DIR)</code> and <code>$(TARGET_DIR)</code> variables to install the packages properly. Those variables point to the global <em>host</em>, <em>staging</em> and <em>target</em> directories, unless <em>per-package directory</em> support is used, in which case they point to the current package <em>host</em>, <em>staging</em> and <em>target</em> directories. In both cases, it doesn’t make any difference from the package point of view: it should simply use <code>HOST_DIR</code>, <code>STAGING_DIR</code> and <code>TARGET_DIR</code>. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#top-level-parallel-build">Section 8.12, “Top-level parallel build”</a> for more details about <em>per-package directory</em> support.</li>
</ul>
<p>Finally, you can also use hooks. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for more information.</p>
<h2 id="187-infrastructure-for-autotools-based-packages"><a class="markdownIt-Anchor" href="#187-infrastructure-for-autotools-based-packages"></a> 18.7. Infrastructure for autotools-based packages</h2>
<h3 id="1871-autotools-package-tutorial"><a class="markdownIt-Anchor" href="#1871-autotools-package-tutorial"></a> 18.7.1. <code>autotools-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for an autotools-based package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # libfoo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LIBFOO_VERSION = 1.0</span><br><span class="line">08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz</span><br><span class="line">09: LIBFOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: LIBFOO_INSTALL_STAGING = YES</span><br><span class="line">11: LIBFOO_INSTALL_TARGET = NO</span><br><span class="line">12: LIBFOO_CONF_OPTS = --disable-shared</span><br><span class="line">13: LIBFOO_DEPENDENCIES = libglib2 host-pkgconf</span><br><span class="line">14:</span><br><span class="line">15: $(eval $(autotools-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended) and the location of the tarball on the Web. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10, we tell Buildroot to install the package to the staging directory. The staging directory, located in <code>output/staging/</code> is the directory where all the packages are installed, including their development files, etc. By default, packages are not installed to the staging directory, since usually, only libraries need to be installed in the staging directory: their development files are needed to compile other libraries or applications depending on them. Also by default, when staging installation is enabled, packages are installed in this location using the <code>make install</code> command.</p>
<p>On line 11, we tell Buildroot to not install the package to the target directory. This directory contains what will become the root filesystem running on the target. For purely static libraries, it is not necessary to install them in the target directory because they will not be used at runtime. By default, target installation is enabled; setting this variable to NO is almost never needed. Also by default, packages are installed in this location using the <code>make install</code> command.</p>
<p>On line 12, we tell Buildroot to pass a custom configure option, that will be passed to the <code>./configure</code> script before configuring and building the package.</p>
<p>On line 13, we declare our dependencies, so that they are built before the build process of our package starts.</p>
<p>Finally, on line line 15, we invoke the <code>autotools-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<h3 id="1872-autotools-package-reference"><a class="markdownIt-Anchor" href="#1872-autotools-package-reference"></a> 18.7.2. <code>autotools-package</code> reference</h3>
<p>The main macro of the autotools package infrastructure is <code>autotools-package</code>. It is similar to the <code>generic-package</code> macro. The ability to have target and host packages is also available, with the <code>host-autotools-package</code> macro.</p>
<p>Just like the generic infrastructure, the autotools infrastructure works by defining a number of variables before calling the <code>autotools-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the autotools infrastructure: <code>LIBFOO_VERSION</code>, <code>LIBFOO_SOURCE</code>, <code>LIBFOO_PATCH</code>, <code>LIBFOO_SITE</code>, <code>LIBFOO_SUBDIR</code>, <code>LIBFOO_DEPENDENCIES</code>, <code>LIBFOO_INSTALL_STAGING</code>, <code>LIBFOO_INSTALL_TARGET</code>.</p>
<p>A few additional variables, specific to the autotools infrastructure, can also be defined. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them.</p>
<ul>
<li><code>LIBFOO_SUBDIR</code> may contain the name of a subdirectory inside the package that contains the configure script. This is useful, if for example, the main configure script is not at the root of the tree extracted by the tarball. If <code>HOST_LIBFOO_SUBDIR</code> is not specified, it defaults to <code>LIBFOO_SUBDIR</code>.</li>
<li><code>LIBFOO_CONF_ENV</code>, to specify additional environment variables to pass to the configure script. By default, empty.</li>
<li><code>LIBFOO_CONF_OPTS</code>, to specify additional configure options to pass to the configure script. By default, empty.</li>
<li><code>LIBFOO_MAKE</code>, to specify an alternate <code>make</code> command. This is typically useful when parallel make is enabled in the configuration (using <code>BR2_JLEVEL</code>) but that this feature should be disabled for the given package, for one reason or another. By default, set to <code>$(MAKE)</code>. If parallel building is not supported by the package, then it should be set to <code>LIBFOO_MAKE=$(MAKE1)</code>.</li>
<li><code>LIBFOO_MAKE_ENV</code>, to specify additional environment variables to pass to make in the build step. These are passed before the <code>make</code> command. By default, empty.</li>
<li><code>LIBFOO_MAKE_OPTS</code>, to specify additional variables to pass to make in the build step. These are passed after the <code>make</code> command. By default, empty.</li>
<li><code>LIBFOO_AUTORECONF</code>, tells whether the package should be autoreconfigured or not (i.e. if the configure script and <a target="_blank" rel="noopener" href="http://Makefile.in">Makefile.in</a> files should be re-generated by re-running autoconf, automake, libtool, etc.). Valid values are <code>YES</code> and <code>NO</code>. By default, the value is <code>NO</code></li>
<li><code>LIBFOO_AUTORECONF_ENV</code>, to specify additional environment variables to pass to the <em>autoreconf</em> program if <code>LIBFOO_AUTORECONF=YES</code>. These are passed in the environment of the <em>autoreconf</em> command. By default, empty.</li>
<li><code>LIBFOO_AUTORECONF_OPTS</code> to specify additional options passed to the <em>autoreconf</em> program if <code>LIBFOO_AUTORECONF=YES</code>. By default, empty.</li>
<li><code>LIBFOO_AUTOPOINT</code>, tells whether the package should be autopointed or not (i.e. if the package needs I18N infrastructure copied in.) Only valid when <code>LIBFOO_AUTORECONF=YES</code>. Valid values are <code>YES</code> and <code>NO</code>. The default is <code>NO</code>.</li>
<li><code>LIBFOO_LIBTOOL_PATCH</code> tells whether the Buildroot patch to fix libtool cross-compilation issues should be applied or not. Valid values are <code>YES</code> and <code>NO</code>. By default, the value is <code>YES</code></li>
<li><code>LIBFOO_INSTALL_STAGING_OPTS</code> contains the make options used to install the package to the staging directory. By default, the value is <code>DESTDIR=$(STAGING_DIR) install</code>, which is correct for most autotools packages. It is still possible to override it.</li>
<li><code>LIBFOO_INSTALL_TARGET_OPTS</code> contains the make options used to install the package to the target directory. By default, the value is <code>DESTDIR=$(TARGET_DIR) install</code>. The default value is correct for most autotools packages, but it is still possible to override it if needed.</li>
</ul>
<p>With the autotools infrastructure, all the steps required to build and install the packages are already defined, and they generally work well for most autotools-based packages. However, when required, it is still possible to customize what is done in any particular step:</p>
<ul>
<li>By adding a post-operation hook (after extract, patch, configure, build or install). See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for details.</li>
<li>By overriding one of the steps. For example, even if the autotools infrastructure is used, if the package <code>.mk</code> file defines its own <code>LIBFOO_CONFIGURE_CMDS</code> variable, it will be used instead of the default autotools one. However, using this method should be restricted to very specific cases. Do not use it in the general case.</li>
</ul>
<h2 id="188-infrastructure-for-cmake-based-packages"><a class="markdownIt-Anchor" href="#188-infrastructure-for-cmake-based-packages"></a> 18.8. Infrastructure for CMake-based packages</h2>
<h3 id="1881-cmake-package-tutorial"><a class="markdownIt-Anchor" href="#1881-cmake-package-tutorial"></a> 18.8.1. <code>cmake-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a CMake-based package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # libfoo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LIBFOO_VERSION = 1.0</span><br><span class="line">08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz</span><br><span class="line">09: LIBFOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: LIBFOO_INSTALL_STAGING = YES</span><br><span class="line">11: LIBFOO_INSTALL_TARGET = NO</span><br><span class="line">12: LIBFOO_CONF_OPTS = -DBUILD_DEMOS=ON</span><br><span class="line">13: LIBFOO_DEPENDENCIES = libglib2 host-pkgconf</span><br><span class="line">14:</span><br><span class="line">15: $(eval $(cmake-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended) and the location of the tarball on the Web. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10, we tell Buildroot to install the package to the staging directory. The staging directory, located in <code>output/staging/</code> is the directory where all the packages are installed, including their development files, etc. By default, packages are not installed to the staging directory, since usually, only libraries need to be installed in the staging directory: their development files are needed to compile other libraries or applications depending on them. Also by default, when staging installation is enabled, packages are installed in this location using the <code>make install</code> command.</p>
<p>On line 11, we tell Buildroot to not install the package to the target directory. This directory contains what will become the root filesystem running on the target. For purely static libraries, it is not necessary to install them in the target directory because they will not be used at runtime. By default, target installation is enabled; setting this variable to NO is almost never needed. Also by default, packages are installed in this location using the <code>make install</code> command.</p>
<p>On line 12, we tell Buildroot to pass custom options to CMake when it is configuring the package.</p>
<p>On line 13, we declare our dependencies, so that they are built before the build process of our package starts.</p>
<p>Finally, on line line 15, we invoke the <code>cmake-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<h3 id="1882-cmake-package-reference"><a class="markdownIt-Anchor" href="#1882-cmake-package-reference"></a> 18.8.2. <code>cmake-package</code> reference</h3>
<p>The main macro of the CMake package infrastructure is <code>cmake-package</code>. It is similar to the <code>generic-package</code> macro. The ability to have target and host packages is also available, with the <code>host-cmake-package</code> macro.</p>
<p>Just like the generic infrastructure, the CMake infrastructure works by defining a number of variables before calling the <code>cmake-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the CMake infrastructure: <code>LIBFOO_VERSION</code>, <code>LIBFOO_SOURCE</code>, <code>LIBFOO_PATCH</code>, <code>LIBFOO_SITE</code>, <code>LIBFOO_SUBDIR</code>, <code>LIBFOO_DEPENDENCIES</code>, <code>LIBFOO_INSTALL_STAGING</code>, <code>LIBFOO_INSTALL_TARGET</code>.</p>
<p>A few additional variables, specific to the CMake infrastructure, can also be defined. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them.</p>
<ul>
<li><code>LIBFOO_SUBDIR</code> may contain the name of a subdirectory inside the package that contains the main CMakeLists.txt file. This is useful, if for example, the main CMakeLists.txt file is not at the root of the tree extracted by the tarball. If <code>HOST_LIBFOO_SUBDIR</code> is not specified, it defaults to <code>LIBFOO_SUBDIR</code>.</li>
<li><code>LIBFOO_CMAKE_BACKEND</code> specifies the cmake backend to use, one of <code>make</code> (to use the GNU Makefiles generator, the default) or <code>ninja</code> (to use the Ninja generator).</li>
<li><code>LIBFOO_CONF_ENV</code>, to specify additional environment variables to pass to CMake. By default, empty.</li>
<li><code>LIBFOO_CONF_OPTS</code>, to specify additional configure options to pass to CMake. By default, empty. A number of common CMake options are set by the <code>cmake-package</code> infrastructure; so it is normally not necessary to set them in the package’s <code>*.mk</code> file unless you want to override them:
<ul>
<li><code>CMAKE_BUILD_TYPE</code> is driven by <code>BR2_ENABLE_RUNTIME_DEBUG</code>;</li>
<li><code>CMAKE_INSTALL_PREFIX</code>;</li>
<li><code>BUILD_SHARED_LIBS</code> is driven by <code>BR2_STATIC_LIBS</code>;</li>
<li><code>BUILD_DOC</code>, <code>BUILD_DOCS</code> are disabled;</li>
<li><code>BUILD_EXAMPLE</code>, <code>BUILD_EXAMPLES</code> are disabled;</li>
<li><code>BUILD_TEST</code>, <code>BUILD_TESTS</code>, <code>BUILD_TESTING</code> are disabled.</li>
</ul>
</li>
<li><code>LIBFOO_BUILD_ENV</code> and <code>LIBFOO_BUILD_OPTS</code> to specify additional environment variables, or command line options, to pass to the backend at build time.</li>
<li><code>LIBFOO_SUPPORTS_IN_SOURCE_BUILD = NO</code> should be set when the package cannot be built inside the source tree but needs a separate build directory.</li>
<li><code>LIBFOO_MAKE</code>, to specify an alternate <code>make</code> command. This is typically useful when parallel make is enabled in the configuration (using <code>BR2_JLEVEL</code>) but that this feature should be disabled for the given package, for one reason or another. By default, set to <code>$(MAKE)</code>. If parallel building is not supported by the package, then it should be set to <code>LIBFOO_MAKE=$(MAKE1)</code>.</li>
<li><code>LIBFOO_MAKE_ENV</code>, to specify additional environment variables to pass to make in the build step. These are passed before the <code>make</code> command. By default, empty.</li>
<li><code>LIBFOO_MAKE_OPTS</code>, to specify additional variables to pass to make in the build step. These are passed after the <code>make</code> command. By default, empty.</li>
<li><code>LIBFOO_INSTALL_OPTS</code> contains the make options used to install the package to the host directory. By default, the value is <code>install</code>, which is correct for most CMake packages. It is still possible to override it.</li>
<li><code>LIBFOO_INSTALL_STAGING_OPTS</code> contains the make options used to install the package to the staging directory. By default, the value is <code>DESTDIR=$(STAGING_DIR) install/fast</code>, which is correct for most CMake packages. It is still possible to override it.</li>
<li><code>LIBFOO_INSTALL_TARGET_OPTS</code> contains the make options used to install the package to the target directory. By default, the value is <code>DESTDIR=$(TARGET_DIR) install/fast</code>. The default value is correct for most CMake packages, but it is still possible to override it if needed.</li>
</ul>
<p>With the CMake infrastructure, all the steps required to build and install the packages are already defined, and they generally work well for most CMake-based packages. However, when required, it is still possible to customize what is done in any particular step:</p>
<ul>
<li>By adding a post-operation hook (after extract, patch, configure, build or install). See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for details.</li>
<li>By overriding one of the steps. For example, even if the CMake infrastructure is used, if the package <code>.mk</code> file defines its own <code>LIBFOO_CONFIGURE_CMDS</code> variable, it will be used instead of the default CMake one. However, using this method should be restricted to very specific cases. Do not use it in the general case.</li>
</ul>
<h2 id="189-infrastructure-for-python-packages"><a class="markdownIt-Anchor" href="#189-infrastructure-for-python-packages"></a> 18.9. Infrastructure for Python packages</h2>
<p>This infrastructure applies to Python packages that use the standard Python setuptools, pep517, flit or maturin mechanisms as their build system, generally recognizable by the usage of a <code>setup.py</code> script or <code>pyproject.toml</code> file.</p>
<h3 id="1891-python-package-tutorial"><a class="markdownIt-Anchor" href="#1891-python-package-tutorial"></a> 18.9.1. <code>python-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a Python package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # python-foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: PYTHON_FOO_VERSION = 1.0</span><br><span class="line">08: PYTHON_FOO_SOURCE = python-foo-$(PYTHON_FOO_VERSION).tar.xz</span><br><span class="line">09: PYTHON_FOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: PYTHON_FOO_LICENSE = BSD-3-Clause</span><br><span class="line">11: PYTHON_FOO_LICENSE_FILES = LICENSE</span><br><span class="line">12: PYTHON_FOO_ENV = SOME_VAR=1</span><br><span class="line">13: PYTHON_FOO_DEPENDENCIES = libmad</span><br><span class="line">14: PYTHON_FOO_SETUP_TYPE = setuptools</span><br><span class="line">15:</span><br><span class="line">16: $(eval $(python-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended) and the location of the tarball on the Web. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10 and 11, we give licensing details about the package (its license on line 10, and the file containing the license text on line 11).</p>
<p>On line 12, we tell Buildroot to pass custom options to the Python <code>setup.py</code> script when it is configuring the package.</p>
<p>On line 13, we declare our dependencies, so that they are built before the build process of our package starts.</p>
<p>On line 14, we declare the specific Python build system being used. In this case the <code>setuptools</code> Python build system is used. The five supported ones are <code>flit</code>, <code>pep517</code>, <code>setuptools</code>, <code>setuptools-rust</code> and <code>maturin</code>.</p>
<p>Finally, on line 16, we invoke the <code>python-package</code> macro that generates all the Makefile rules that actually allow the package to be built.</p>
<h3 id="1892-python-package-reference"><a class="markdownIt-Anchor" href="#1892-python-package-reference"></a> 18.9.2. <code>python-package</code> reference</h3>
<p>As a policy, packages that merely provide Python modules should all be named <code>python-&lt;something&gt;</code> in Buildroot. Other packages that use the Python build system, but are not Python modules, can freely choose their name (existing examples in Buildroot are <code>scons</code> and <code>supervisor</code>).</p>
<p>The main macro of the Python package infrastructure is <code>python-package</code>. It is similar to the <code>generic-package</code> macro. It is also possible to create Python host packages with the <code>host-python-package</code> macro.</p>
<p>Just like the generic infrastructure, the Python infrastructure works by defining a number of variables before calling the <code>python-package</code> or <code>host-python-package</code> macros.</p>
<p>All the package metadata information variables that exist in the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">generic package infrastructure</a> also exist in the Python infrastructure: <code>PYTHON_FOO_VERSION</code>, <code>PYTHON_FOO_SOURCE</code>, <code>PYTHON_FOO_PATCH</code>, <code>PYTHON_FOO_SITE</code>, <code>PYTHON_FOO_SUBDIR</code>, <code>PYTHON_FOO_DEPENDENCIES</code>, <code>PYTHON_FOO_LICENSE</code>, <code>PYTHON_FOO_LICENSE_FILES</code>, <code>PYTHON_FOO_INSTALL_STAGING</code>, etc.</p>
<p>Note that:</p>
<ul>
<li>It is not necessary to add <code>python</code> or <code>host-python</code> in the <code>PYTHON_FOO_DEPENDENCIES</code> variable of a package, since these basic dependencies are automatically added as needed by the Python package infrastructure.</li>
<li>Similarly, it is not needed to add <code>host-python-setuptools</code> to <code>PYTHON_FOO_DEPENDENCIES</code> for setuptools-based packages, since it’s automatically added by the Python infrastructure as needed.</li>
</ul>
<p>One variable specific to the Python infrastructure is mandatory:</p>
<ul>
<li><code>PYTHON_FOO_SETUP_TYPE</code>, to define which Python build system is used by the package. The five supported values are <code>flit</code>, <code>pep517</code> and <code>setuptools</code>, <code>setuptools-rust</code> and <code>maturin</code>. If you don’t know which one is used in your package, look at the <code>setup.py</code> or <code>pyproject.toml</code> file in your package source code, and see whether it imports things from the <code>flit</code> module or the <code>setuptools</code> module. If the package is using a <code>pyproject.toml</code> file without any build-system requires and with a local in-tree backend-path one should use <code>pep517</code>.</li>
</ul>
<p>A few additional variables, specific to the Python infrastructure, can optionally be defined, depending on the package’s needs. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them, or none.</p>
<ul>
<li><code>PYTHON_FOO_SUBDIR</code> may contain the name of a subdirectory inside the package that contains the main <code>setup.py</code> or <code>pyproject.toml</code> file. This is useful, if for example, the main <code>setup.py</code> or <code>pyproject.toml</code> file is not at the root of the tree extracted by the tarball. If <code>HOST_PYTHON_FOO_SUBDIR</code> is not specified, it defaults to <code>PYTHON_FOO_SUBDIR</code>.</li>
<li><code>PYTHON_FOO_ENV</code>, to specify additional environment variables to pass to the Python <code>setup.py</code> script (for setuptools packages) or the <code>support/scripts/pyinstaller.py</code> script (for flit/pep517 packages) for both the build and install steps. Note that the infrastructure is automatically passing several standard variables, defined in <code>PKG_PYTHON_SETUPTOOLS_ENV</code> (for setuptools target packages), <code>HOST_PKG_PYTHON_SETUPTOOLS_ENV</code> (for setuptools host packages), <code>PKG_PYTHON_PEP517_ENV</code> (for flit/pep517 target packages) and <code>HOST_PKG_PYTHON_PEP517_ENV</code> (for flit/pep517 host packages).</li>
<li><code>PYTHON_FOO_BUILD_OPTS</code>, to specify additional options to pass to the Python <code>setup.py</code> script during the build step, this generally only makes sense to use for setuptools based packages as flit/pep517 based packages do not pass these options to a <code>setup.py</code> script but instead pass them to <code>support/scripts/pyinstaller.py</code>.</li>
<li><code>PYTHON_FOO_INSTALL_TARGET_OPTS</code>, <code>PYTHON_FOO_INSTALL_STAGING_OPTS</code>, <code>HOST_PYTHON_FOO_INSTALL_OPTS</code> to specify additional options to pass to the Python <code>setup.py</code> script (for setuptools packages) or <code>support/scripts/pyinstaller.py</code> (for flit/pep517 packages) during the target installation step, the staging installation step or the host installation, respectively.</li>
</ul>
<p>With the Python infrastructure, all the steps required to build and install the packages are already defined, and they generally work well for most Python-based packages. However, when required, it is still possible to customize what is done in any particular step:</p>
<ul>
<li>By adding a post-operation hook (after extract, patch, configure, build or install). See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for details.</li>
<li>By overriding one of the steps. For example, even if the Python infrastructure is used, if the package <code>.mk</code> file defines its own <code>PYTHON_FOO_BUILD_CMDS</code> variable, it will be used instead of the default Python one. However, using this method should be restricted to very specific cases. Do not use it in the general case.</li>
</ul>
<h3 id="1893-generating-a-python-package-from-a-pypi-repository"><a class="markdownIt-Anchor" href="#1893-generating-a-python-package-from-a-pypi-repository"></a> 18.9.3. Generating a <code>python-package</code> from a PyPI repository</h3>
<p>If the Python package for which you would like to create a Buildroot package is available on PyPI, you may want to use the <code>scanpypi</code> tool located in <code>utils/</code> to automate the process.</p>
<p>You can find the list of existing PyPI packages <a target="_blank" rel="noopener" href="https://pypi.python.org/">here</a>.</p>
<p><code>scanpypi</code> requires Python’s <code>setuptools</code> package to be installed on your host.</p>
<p>When at the root of your buildroot directory just do :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">utils/scanpypi foo bar -o package</span><br></pre></td></tr></table></figure>
<p>This will generate packages <code>python-foo</code> and <code>python-bar</code> in the package folder if they exist on <a target="_blank" rel="noopener" href="https://pypi.python.org/">https://pypi.python.org</a>.</p>
<p>Find the <code>external python modules</code> menu and insert your package inside. Keep in mind that the items inside a menu should be in alphabetical order.</p>
<p>Please keep in mind that you’ll most likely have to manually check the package for any mistakes as there are things that cannot be guessed by the generator (e.g. dependencies on any of the python core modules such as BR2_PACKAGE_PYTHON_ZLIB). Also, please take note that the license and license files are guessed and must be checked. You also need to manually add the package to the <code>package/Config.in</code> file.</p>
<p>If your Buildroot package is not in the official Buildroot tree but in a br2-external tree, use the -o flag as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">utils/scanpypi foo bar -o other_package_dir</span><br></pre></td></tr></table></figure>
<p>This will generate packages <code>python-foo</code> and <code>python-bar</code> in the <code>other_package_directory</code> instead of <code>package</code>.</p>
<p>Option <code>-h</code> will list the available options:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">utils/scanpypi -h</span><br></pre></td></tr></table></figure>
<h3 id="1894-python-package-cffi-backend"><a class="markdownIt-Anchor" href="#1894-python-package-cffi-backend"></a> 18.9.4. <code>python-package</code> CFFI backend</h3>
<p>C Foreign Function Interface for Python (CFFI) provides a convenient and reliable way to call compiled C code from Python using interface declarations written in C. Python packages relying on this backend can be identified by the appearance of a <code>cffi</code> dependency in the <code>install_requires</code> field of their <code>setup.py</code> file.</p>
<p>Such a package should:</p>
<ul>
<li>add <code>python-cffi</code> as a runtime dependency in order to install the compiled C library wrapper on the target. This is achieved by adding <code>select BR2_PACKAGE_PYTHON_CFFI</code> to the package <code>Config.in</code>.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_PYTHON_FOO</span><br><span class="line">        bool &quot;python-foo&quot;</span><br><span class="line">        select BR2_PACKAGE_PYTHON_CFFI # runtime</span><br></pre></td></tr></table></figure>
<ul>
<li>add <code>host-python-cffi</code> as a build-time dependency in order to cross-compile the C wrapper. This is achieved by adding <code>host-python-cffi</code> to the <code>PYTHON_FOO_DEPENDENCIES</code> variable.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line"># python-foo</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">PYTHON_FOO_DEPENDENCIES = host-python-cffi</span><br><span class="line"></span><br><span class="line">$(eval $(python-package))</span><br></pre></td></tr></table></figure>
<h2 id="1810-infrastructure-for-luarocks-based-packages"><a class="markdownIt-Anchor" href="#1810-infrastructure-for-luarocks-based-packages"></a> 18.10. Infrastructure for LuaRocks-based packages</h2>
<h3 id="18101-luarocks-package-tutorial"><a class="markdownIt-Anchor" href="#18101-luarocks-package-tutorial"></a> 18.10.1. <code>luarocks-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a LuaRocks-based package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # lua-foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LUA_FOO_VERSION = 1.0.2-1</span><br><span class="line">08: LUA_FOO_NAME_UPSTREAM = foo</span><br><span class="line">09: LUA_FOO_DEPENDENCIES = bar</span><br><span class="line">10:</span><br><span class="line">11: LUA_FOO_BUILD_OPTS += BAR_INCDIR=$(STAGING_DIR)/usr/include</span><br><span class="line">12: LUA_FOO_BUILD_OPTS += BAR_LIBDIR=$(STAGING_DIR)/usr/lib</span><br><span class="line">13: LUA_FOO_LICENSE = luaFoo license</span><br><span class="line">14: LUA_FOO_LICENSE_FILES = $(LUA_FOO_SUBDIR)/COPYING</span><br><span class="line">15:</span><br><span class="line">16: $(eval $(luarocks-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package (the same as in the rockspec, which is the concatenation of the upstream version and the rockspec revision, separated by a hyphen <em>-</em>).</p>
<p>On line 8, we declare that the package is called “foo” on LuaRocks. In Buildroot, we give Lua-related packages a name that starts with “lua”, so the Buildroot name is different from the upstream name. <code>LUA_FOO_NAME_UPSTREAM</code> makes the link between the two names.</p>
<p>On line 9, we declare our dependencies against native libraries, so that they are built before the build process of our package starts.</p>
<p>On lines 11-12, we tell Buildroot to pass custom options to LuaRocks when it is building the package.</p>
<p>On lines 13-14, we specify the licensing terms for the package.</p>
<p>Finally, on line 16, we invoke the <code>luarocks-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<p>Most of these details can be retrieved from the <code>rock</code> and <code>rockspec</code>. So, this file and the <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> file can be generated by running the command <code>luarocks buildroot foo lua-foo</code> in the Buildroot directory. This command runs a specific Buildroot addon of <code>luarocks</code> that will automatically generate a Buildroot package. The result must still be manually inspected and possibly modified.</p>
<ul>
<li>The <code>package/Config.in</code> file has to be updated manually to include the generated <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> files.</li>
</ul>
<h3 id="18102-luarocks-package-reference"><a class="markdownIt-Anchor" href="#18102-luarocks-package-reference"></a> 18.10.2. <code>luarocks-package</code> reference</h3>
<p>LuaRocks is a deployment and management system for Lua modules, and supports various <code>build.type</code>: <code>builtin</code>, <code>make</code> and <code>cmake</code>. In the context of Buildroot, the <code>luarocks-package</code> infrastructure only supports the <code>builtin</code> mode. LuaRocks packages that use the <code>make</code> or <code>cmake</code> build mechanisms should instead be packaged using the <code>generic-package</code> and <code>cmake-package</code> infrastructures in Buildroot, respectively.</p>
<p>The main macro of the LuaRocks package infrastructure is <code>luarocks-package</code>: like <code>generic-package</code> it works by defining a number of variables providing metadata information about the package, and then calling <code>luarocks-package</code>.</p>
<p>Just like the generic infrastructure, the LuaRocks infrastructure works by defining a number of variables before calling the <code>luarocks-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the LuaRocks infrastructure: <code>LUA_FOO_VERSION</code>, <code>LUA_FOO_SOURCE</code>, <code>LUA_FOO_SITE</code>, <code>LUA_FOO_DEPENDENCIES</code>, <code>LUA_FOO_LICENSE</code>, <code>LUA_FOO_LICENSE_FILES</code>.</p>
<p>Two of them are populated by the LuaRocks infrastructure (for the <code>download</code> step). If your package is not hosted on the LuaRocks mirror <code>$(BR2_LUAROCKS_MIRROR)</code>, you can override them:</p>
<ul>
<li><code>LUA_FOO_SITE</code>, which defaults to <code>$(BR2_LUAROCKS_MIRROR)</code></li>
<li><code>LUA_FOO_SOURCE</code>, which defaults to <code>$(lowercase LUA_FOO_NAME_UPSTREAM)-$(LUA_FOO_VERSION).src.rock</code></li>
</ul>
<p>A few additional variables, specific to the LuaRocks infrastructure, are also defined. They can be overridden in specific cases.</p>
<ul>
<li><code>LUA_FOO_NAME_UPSTREAM</code>, which defaults to <code>lua-foo</code>, i.e. the Buildroot package name</li>
<li><code>LUA_FOO_ROCKSPEC</code>, which defaults to <code>$(lowercase LUA_FOO_NAME_UPSTREAM)-$(LUA_FOO_VERSION).rockspec</code></li>
<li><code>LUA_FOO_SUBDIR</code>, which defaults to <code>$(LUA_FOO_NAME_UPSTREAM)-$(LUA_FOO_VERSION_WITHOUT_ROCKSPEC_REVISION)</code></li>
<li><code>LUA_FOO_BUILD_OPTS</code> contains additional build options for the <code>luarocks build</code> call.</li>
</ul>
<h2 id="1811-infrastructure-for-perlcpan-packages"><a class="markdownIt-Anchor" href="#1811-infrastructure-for-perlcpan-packages"></a> 18.11. Infrastructure for Perl/CPAN packages</h2>
<h3 id="18111-perl-package-tutorial"><a class="markdownIt-Anchor" href="#18111-perl-package-tutorial"></a> 18.11.1. <code>perl-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a Perl/CPAN package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # perl-foo-bar</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: PERL_FOO_BAR_VERSION = 0.02</span><br><span class="line">08: PERL_FOO_BAR_SOURCE = Foo-Bar-$(PERL_FOO_BAR_VERSION).tar.gz</span><br><span class="line">09: PERL_FOO_BAR_SITE = $(BR2_CPAN_MIRROR)/authors/id/M/MO/MONGER</span><br><span class="line">10: PERL_FOO_BAR_DEPENDENCIES = perl-strictures</span><br><span class="line">11: PERL_FOO_BAR_LICENSE = Artistic or GPL-1.0+</span><br><span class="line">12: PERL_FOO_BAR_LICENSE_FILES = LICENSE</span><br><span class="line">13: PERL_FOO_BAR_DISTNAME = Foo-Bar</span><br><span class="line">14:</span><br><span class="line">15: $(eval $(perl-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball and the location of the tarball on a CPAN server. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10, we declare our dependencies, so that they are built before the build process of our package starts.</p>
<p>On line 11 and 12, we give licensing details about the package (its license on line 11, and the file containing the license text on line 12).</p>
<p>On line 13, the name of the distribution as needed by the script <code>utils/scancpan</code> (in order to regenerate/upgrade these package files).</p>
<p>Finally, on line 15, we invoke the <code>perl-package</code> macro that generates all the Makefile rules that actually allow the package to be built.</p>
<p>Most of these data can be retrieved from <a target="_blank" rel="noopener" href="https://metacpan.org/">https://metacpan.org/</a>. So, this file and the <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> can be generated by running the script <code>utils/scancpan Foo-Bar</code> in the Buildroot directory (or in a br2-external tree). This script creates a <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> file and <a target="_blank" rel="noopener" href="http://foo-bar.mk">foo-bar.mk</a> file for the requested package, and also recursively for all dependencies specified by CPAN. You should still manually edit the result. In particular, the following things should be checked.</p>
<ul>
<li>If the perl module links with a shared library that is provided by another (non-perl) package, this dependency is not added automatically. It has to be added manually to <code>PERL_FOO_BAR_DEPENDENCIES</code>.</li>
<li>The <code>package/Config.in</code> file has to be updated manually to include the generated <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> files. As a hint, the <code>scancpan</code> script prints out the required <code>source &quot;…&quot;</code> statements, sorted alphabetically.</li>
</ul>
<h3 id="18112-perl-package-reference"><a class="markdownIt-Anchor" href="#18112-perl-package-reference"></a> 18.11.2. <code>perl-package</code> reference</h3>
<p>As a policy, packages that provide Perl/CPAN modules should all be named <code>perl-&lt;something&gt;</code> in Buildroot.</p>
<p>This infrastructure handles various Perl build systems : <code>ExtUtils-MakeMaker</code> (EUMM), <code>Module-Build</code> (MB) and <code>Module-Build-Tiny</code>. <code>Build.PL</code> is preferred by default when a package provides a <code>Makefile.PL</code> and a <code>Build.PL</code>.</p>
<p>The main macro of the Perl/CPAN package infrastructure is <code>perl-package</code>. It is similar to the <code>generic-package</code> macro. The ability to have target and host packages is also available, with the <code>host-perl-package</code> macro.</p>
<p>Just like the generic infrastructure, the Perl/CPAN infrastructure works by defining a number of variables before calling the <code>perl-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the Perl/CPAN infrastructure: <code>PERL_FOO_VERSION</code>, <code>PERL_FOO_SOURCE</code>, <code>PERL_FOO_PATCH</code>, <code>PERL_FOO_SITE</code>, <code>PERL_FOO_SUBDIR</code>, <code>PERL_FOO_DEPENDENCIES</code>, <code>PERL_FOO_INSTALL_TARGET</code>.</p>
<p>Note that setting <code>PERL_FOO_INSTALL_STAGING</code> to <code>YES</code> has no effect unless a <code>PERL_FOO_INSTALL_STAGING_CMDS</code> variable is defined. The perl infrastructure doesn’t define these commands since Perl modules generally don’t need to be installed to the <code>staging</code> directory.</p>
<p>A few additional variables, specific to the Perl/CPAN infrastructure, can also be defined. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them.</p>
<ul>
<li><code>PERL_FOO_PREFER_INSTALLER</code>/<code>HOST_PERL_FOO_PREFER_INSTALLER</code>, specifies the preferred installation method. Possible values are <code>EUMM</code> (for <code>Makefile.PL</code> based installation using <code>ExtUtils-MakeMaker</code>) and <code>MB</code> (for <code>Build.PL</code> based installation using <code>Module-Build</code>). This variable is only used when the package provides both installation methods.</li>
<li><code>PERL_FOO_CONF_ENV</code>/<code>HOST_PERL_FOO_CONF_ENV</code>, to specify additional environment variables to pass to the <code>perl Makefile.PL</code> or <code>perl Build.PL</code>. By default, empty.</li>
<li><code>PERL_FOO_CONF_OPTS</code>/<code>HOST_PERL_FOO_CONF_OPTS</code>, to specify additional configure options to pass to the <code>perl Makefile.PL</code> or <code>perl Build.PL</code>. By default, empty.</li>
<li><code>PERL_FOO_BUILD_OPTS</code>/<code>HOST_PERL_FOO_BUILD_OPTS</code>, to specify additional options to pass to <code>make pure_all</code> or <code>perl Build build</code> in the build step. By default, empty.</li>
<li><code>PERL_FOO_INSTALL_TARGET_OPTS</code>, to specify additional options to pass to <code>make pure_install</code> or <code>perl Build install</code> in the install step. By default, empty.</li>
<li><code>HOST_PERL_FOO_INSTALL_OPTS</code>, to specify additional options to pass to <code>make pure_install</code> or <code>perl Build install</code> in the install step. By default, empty.</li>
</ul>
<h2 id="1812-infrastructure-for-virtual-packages"><a class="markdownIt-Anchor" href="#1812-infrastructure-for-virtual-packages"></a> 18.12. Infrastructure for virtual packages</h2>
<p>In Buildroot, a virtual package is a package whose functionalities are provided by one or more packages, referred to as <em>providers</em>. The virtual package management is an extensible mechanism allowing the user to choose the provider used in the rootfs.</p>
<p>For example, <em>OpenGL ES</em> is an API for 2D and 3D graphics on embedded systems. The implementation of this API is different for the <em>Allwinner Tech Sunxi</em> and the <em>Texas Instruments OMAP35xx</em> platforms. So <code>libgles</code> will be a virtual package and <code>sunxi-mali-utgard</code> and <code>ti-gfx</code> will be the providers.</p>
<h3 id="18121-virtual-package-tutorial"><a class="markdownIt-Anchor" href="#18121-virtual-package-tutorial"></a> 18.12.1. <code>virtual-package</code> tutorial</h3>
<p>In the following example, we will explain how to add a new virtual package (<em>something-virtual</em>) and a provider for it (<em>some-provider</em>).</p>
<p>First, let’s create the virtual package.</p>
<h3 id="18122-virtual-packages-configin-file"><a class="markdownIt-Anchor" href="#18122-virtual-packages-configin-file"></a> 18.12.2. Virtual package’s <code>Config.in</code> file</h3>
<p>The <code>Config.in</code> file of virtual package <em>something-virtual</em> should contain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">01: config BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</span><br><span class="line">02:     bool</span><br><span class="line">03:</span><br><span class="line">04: config BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL</span><br><span class="line">05:     depends on BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</span><br><span class="line">06:     string</span><br></pre></td></tr></table></figure>
<p>In this file, we declare two options, <code>BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</code> and <code>BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL</code>, whose values will be used by the providers.</p>
<h3 id="18123-virtual-packages-mk-file"><a class="markdownIt-Anchor" href="#18123-virtual-packages-mk-file"></a> 18.12.3. Virtual package’s <code>.mk</code> file</h3>
<p>The <code>.mk</code> for the virtual package should just evaluate the <code>virtual-package</code> macro:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # something-virtual</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: $(eval $(virtual-package))</span><br></pre></td></tr></table></figure>
<p>The ability to have target and host packages is also available, with the <code>host-virtual-package</code> macro.</p>
<h3 id="18124-providers-configin-file"><a class="markdownIt-Anchor" href="#18124-providers-configin-file"></a> 18.12.4. Provider’s <code>Config.in</code> file</h3>
<p>When adding a package as a provider, only the <code>Config.in</code> file requires some modifications.</p>
<p>The <code>Config.in</code> file of the package <em>some-provider</em>, which provides the functionalities of <em>something-virtual</em>, should contain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">01: config BR2_PACKAGE_SOME_PROVIDER</span><br><span class="line">02:     bool &quot;some-provider&quot;</span><br><span class="line">03:     select BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</span><br><span class="line">04:     help</span><br><span class="line">05:       This is a comment that explains what some-provider is.</span><br><span class="line">06:</span><br><span class="line">07:       http://foosoftware.org/some-provider/</span><br><span class="line">08:</span><br><span class="line">09: if BR2_PACKAGE_SOME_PROVIDER</span><br><span class="line">10: config BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL</span><br><span class="line">11:     default &quot;some-provider&quot;</span><br><span class="line">12: endif</span><br></pre></td></tr></table></figure>
<p>On line 3, we select <code>BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</code>, and on line 11, we set the value of <code>BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL</code> to the name of the provider, but only if it is selected.</p>
<h3 id="18125-providers-mk-file"><a class="markdownIt-Anchor" href="#18125-providers-mk-file"></a> 18.12.5. Provider’s <code>.mk</code> file</h3>
<p>The <code>.mk</code> file should also declare an additional variable <code>SOME_PROVIDER_PROVIDES</code> to contain the names of all the virtual packages it is an implementation of:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">01: SOME_PROVIDER_PROVIDES = something-virtual</span><br></pre></td></tr></table></figure>
<p>Of course, do not forget to add the proper build and runtime dependencies for this package!</p>
<h3 id="18126-notes-on-depending-on-a-virtual-package"><a class="markdownIt-Anchor" href="#18126-notes-on-depending-on-a-virtual-package"></a> 18.12.6. Notes on depending on a virtual package</h3>
<p>When adding a package that requires a certain <code>FEATURE</code> provided by a virtual package, you have to use <code>depends on BR2_PACKAGE_HAS_FEATURE</code>, like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_HAS_FEATURE</span><br><span class="line">    bool</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_FOO</span><br><span class="line">    bool &quot;foo&quot;</span><br><span class="line">    depends on BR2_PACKAGE_HAS_FEATURE</span><br></pre></td></tr></table></figure>
<h3 id="18127-notes-on-depending-on-a-specific-provider"><a class="markdownIt-Anchor" href="#18127-notes-on-depending-on-a-specific-provider"></a> 18.12.7. Notes on depending on a specific provider</h3>
<p>If your package really requires a specific provider, then you’ll have to make your package <code>depends on</code> this provider; you can <em>not</em> <code>select</code> a provider.</p>
<p>Let’s take an example with two providers for a <code>FEATURE</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">config BR2_PACKAGE_HAS_FEATURE</span><br><span class="line">    bool</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_FOO</span><br><span class="line">    bool &quot;foo&quot;</span><br><span class="line">    select BR2_PACKAGE_HAS_FEATURE</span><br><span class="line"></span><br><span class="line">config BR2_PACKAGE_BAR</span><br><span class="line">    bool &quot;bar&quot;</span><br><span class="line">    select BR2_PACKAGE_HAS_FEATURE</span><br></pre></td></tr></table></figure>
<p>And you are adding a package that needs <code>FEATURE</code> as provided by <code>foo</code>, but not as provided by <code>bar</code>.</p>
<p>If you were to use <code>select BR2_PACKAGE_FOO</code>, then the user would still be able to select <code>BR2_PACKAGE_BAR</code> in the menuconfig. This would create a configuration inconsistency, whereby two providers of the same <code>FEATURE</code> would be enabled at once, one explicitly set by the user, the other implicitly by your <code>select</code>.</p>
<p>Instead, you have to use <code>depends on BR2_PACKAGE_FOO</code>, which avoids any implicit configuration inconsistency.</p>
<h2 id="1813-infrastructure-for-packages-using-kconfig-for-configuration-files"><a class="markdownIt-Anchor" href="#1813-infrastructure-for-packages-using-kconfig-for-configuration-files"></a> 18.13. Infrastructure for packages using kconfig for configuration files</h2>
<p>A popular way for a software package to handle user-specified configuration is <code>kconfig</code>. Among others, it is used by the Linux kernel, Busybox, and Buildroot itself. The presence of a .config file and a <code>menuconfig</code> target are two well-known symptoms of kconfig being used.</p>
<p>Buildroot features an infrastructure for packages that use kconfig for their configuration. This infrastructure provides the necessary logic to expose the package’s <code>menuconfig</code> target as <code>foo-menuconfig</code> in Buildroot, and to handle the copying back and forth of the configuration file in a correct way.</p>
<p>The <code>kconfig-package</code> infrastructure is based on the <code>generic-package</code> infrastructure. All variables supported by <code>generic-package</code> are available in <code>kconfig-package</code> as well. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">Section 18.6.2, “<code>generic-package</code> reference”</a> for more details.</p>
<p>In order to use the <code>kconfig-package</code> infrastructure for a Buildroot package, the minimally required lines in the <code>.mk</code> file, in addition to the variables required by the <code>generic-package</code> infrastructure, are:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FOO_KCONFIG_FILE = reference-to-source-configuration-file</span><br><span class="line"></span><br><span class="line">$(eval $(kconfig-package))</span><br></pre></td></tr></table></figure>
<p>This snippet creates the following make targets:</p>
<ul>
<li><code>foo-menuconfig</code>, which calls the package’s <code>menuconfig</code> target</li>
<li><code>foo-update-config</code>, which copies the configuration back to the source configuration file. It is not possible to use this target when fragment files are set.</li>
<li><code>foo-update-defconfig</code>, which copies the configuration back to the source configuration file. The configuration file will only list the options that differ from the default values. It is not possible to use this target when fragment files are set.</li>
<li><code>foo-diff-config</code>, which outputs the differences between the current configuration and the one defined in the Buildroot configuration for this kconfig package. The output is useful to identify the configuration changes that may have to be propagated to configuration fragments for example.</li>
</ul>
<p>and ensures that the source configuration file is copied to the build directory at the right moment.</p>
<p>There are two options to specify a configuration file to use, either <code>FOO_KCONFIG_FILE</code> (as in the example, above) or <code>FOO_KCONFIG_DEFCONFIG</code>. It is mandatory to provide either, but not both:</p>
<ul>
<li><code>FOO_KCONFIG_FILE</code> specifies the path to a defconfig or full-config file to be used to configure the package.</li>
<li><code>FOO_KCONFIG_DEFCONFIG</code> specifies the defconfig <em>make</em> rule to call to configure the package.</li>
</ul>
<p>In addition to these minimally required lines, several optional variables can be set to suit the needs of the package under consideration:</p>
<ul>
<li><code>FOO_KCONFIG_EDITORS</code>: a space-separated list of kconfig editors to support, for example <em>menuconfig xconfig</em>. By default, <em>menuconfig</em>.</li>
<li><code>FOO_KCONFIG_FRAGMENT_FILES</code>: a space-separated list of configuration fragment files that are merged to the main configuration file. Fragment files are typically used when there is a desire to stay in sync with an upstream (def)config file, with some minor modifications.</li>
<li><code>FOO_KCONFIG_OPTS</code>: extra options to pass when calling the kconfig editors. This may need to include <em>$(FOO_MAKE_OPTS)</em>, for example. By default, empty.</li>
<li><code>FOO_KCONFIG_FIXUP_CMDS</code>: a list of shell commands needed to fixup the configuration file after copying it or running a kconfig editor. Such commands may be needed to ensure a configuration consistent with other configuration of Buildroot, for example. By default, empty.</li>
<li><code>FOO_KCONFIG_DOTCONFIG</code>: path (with filename) of the <code>.config</code> file, relative to the package source tree. The default, <code>.config</code>, should be well suited for all packages that use the standard kconfig infrastructure as inherited from the Linux kernel; some packages use a derivative of kconfig that use a different location.</li>
<li><code>FOO_KCONFIG_DEPENDENCIES</code>: the list of packages (most probably, host packages) that need to be built before this package’s kconfig is interpreted. Seldom used. By default, empty.</li>
<li><code>FOO_KCONFIG_SUPPORTS_DEFCONFIG</code>: whether the package’s kconfig system supports using defconfig files; few packages do not. By default, <em>YES</em>.</li>
</ul>
<h2 id="1814-infrastructure-for-rebar-based-packages"><a class="markdownIt-Anchor" href="#1814-infrastructure-for-rebar-based-packages"></a> 18.14. Infrastructure for rebar-based packages</h2>
<h3 id="18141-rebar-package-tutorial"><a class="markdownIt-Anchor" href="#18141-rebar-package-tutorial"></a> 18.14.1. <code>rebar-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a rebar-based package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # erlang-foobar</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: ERLANG_FOOBAR_VERSION = 1.0</span><br><span class="line">08: ERLANG_FOOBAR_SOURCE = erlang-foobar-$(ERLANG_FOOBAR_VERSION).tar.xz</span><br><span class="line">09: ERLANG_FOOBAR_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: ERLANG_FOOBAR_DEPENDENCIES = host-libaaa libbbb</span><br><span class="line">11:</span><br><span class="line">12: $(eval $(rebar-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended) and the location of the tarball on the Web. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10, we declare our dependencies, so that they are built before the build process of our package starts.</p>
<p>Finally, on line 12, we invoke the <code>rebar-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<h3 id="18142-rebar-package-reference"><a class="markdownIt-Anchor" href="#18142-rebar-package-reference"></a> 18.14.2. <code>rebar-package</code> reference</h3>
<p>The main macro of the <code>rebar</code> package infrastructure is <code>rebar-package</code>. It is similar to the <code>generic-package</code> macro. The ability to have host packages is also available, with the <code>host-rebar-package</code> macro.</p>
<p>Just like the generic infrastructure, the <code>rebar</code> infrastructure works by defining a number of variables before calling the <code>rebar-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the <code>rebar</code> infrastructure: <code>ERLANG_FOOBAR_VERSION</code>, <code>ERLANG_FOOBAR_SOURCE</code>, <code>ERLANG_FOOBAR_PATCH</code>, <code>ERLANG_FOOBAR_SITE</code>, <code>ERLANG_FOOBAR_SUBDIR</code>, <code>ERLANG_FOOBAR_DEPENDENCIES</code>, <code>ERLANG_FOOBAR_INSTALL_STAGING</code>, <code>ERLANG_FOOBAR_INSTALL_TARGET</code>, <code>ERLANG_FOOBAR_LICENSE</code> and <code>ERLANG_FOOBAR_LICENSE_FILES</code>.</p>
<p>A few additional variables, specific to the <code>rebar</code> infrastructure, can also be defined. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them.</p>
<ul>
<li>
<p><code>ERLANG_FOOBAR_USE_AUTOCONF</code>, to specify that the package uses <em>autoconf</em> at the configuration step. When a package sets this variable to <code>YES</code>, the <code>autotools</code> infrastructure is used.</p>
<p><strong>Note.</strong> You can also use some of the variables from the <code>autotools</code> infrastructure: <code>ERLANG_FOOBAR_CONF_ENV</code>, <code>ERLANG_FOOBAR_CONF_OPTS</code>, <code>ERLANG_FOOBAR_AUTORECONF</code>, <code>ERLANG_FOOBAR_AUTORECONF_ENV</code> and <code>ERLANG_FOOBAR_AUTORECONF_OPTS</code>.</p>
</li>
<li>
<p><code>ERLANG_FOOBAR_USE_BUNDLED_REBAR</code>, to specify that the package has a bundled version of <em>rebar</em> <em><strong>*and*</strong></em> that it shall be used. Valid values are <code>YES</code> or <code>NO</code> (the default).</p>
<p><strong>Note.</strong> If the package bundles a <em>rebar</em> utility, but can use the generic one that Buildroot provides, just say <code>NO</code> (i.e., do not specify this variable). Only set if it is mandatory to use the <em>rebar</em> utility bundled in this package.</p>
</li>
<li>
<p><code>ERLANG_FOOBAR_REBAR_ENV</code>, to specify additional environment variables to pass to the <em>rebar</em> utility.</p>
</li>
<li>
<p><code>ERLANG_FOOBAR_KEEP_DEPENDENCIES</code>, to keep the dependencies described in the rebar.config file. Valid values are <code>YES</code> or <code>NO</code> (the default). Unless this variable is set to <code>YES</code>, the <em>rebar</em> infrastructure removes such dependencies in a post-patch hook to ensure rebar does not download nor compile them.</p>
</li>
</ul>
<p>With the rebar infrastructure, all the steps required to build and install the packages are already defined, and they generally work well for most rebar-based packages. However, when required, it is still possible to customize what is done in any particular step:</p>
<ul>
<li>By adding a post-operation hook (after extract, patch, configure, build or install). See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for details.</li>
<li>By overriding one of the steps. For example, even if the rebar infrastructure is used, if the package <code>.mk</code> file defines its own <code>ERLANG_FOOBAR_BUILD_CMDS</code> variable, it will be used instead of the default rebar one. However, using this method should be restricted to very specific cases. Do not use it in the general case.</li>
</ul>
<h2 id="1815-infrastructure-for-waf-based-packages"><a class="markdownIt-Anchor" href="#1815-infrastructure-for-waf-based-packages"></a> 18.15. Infrastructure for Waf-based packages</h2>
<h3 id="18151-waf-package-tutorial"><a class="markdownIt-Anchor" href="#18151-waf-package-tutorial"></a> 18.15.1. <code>waf-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a Waf-based package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # libfoo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LIBFOO_VERSION = 1.0</span><br><span class="line">08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz</span><br><span class="line">09: LIBFOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: LIBFOO_CONF_OPTS = --enable-bar --disable-baz</span><br><span class="line">11: LIBFOO_DEPENDENCIES = bar</span><br><span class="line">12:</span><br><span class="line">13: $(eval $(waf-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended) and the location of the tarball on the Web. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10, we tell Buildroot what options to enable for libfoo.</p>
<p>On line 11, we tell Buildroot the dependencies of libfoo.</p>
<p>Finally, on line line 13, we invoke the <code>waf-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<h3 id="18152-waf-package-reference"><a class="markdownIt-Anchor" href="#18152-waf-package-reference"></a> 18.15.2. <code>waf-package</code> reference</h3>
<p>The main macro of the Waf package infrastructure is <code>waf-package</code>. It is similar to the <code>generic-package</code> macro.</p>
<p>Just like the generic infrastructure, the Waf infrastructure works by defining a number of variables before calling the <code>waf-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the Waf infrastructure: <code>LIBFOO_VERSION</code>, <code>LIBFOO_SOURCE</code>, <code>LIBFOO_PATCH</code>, <code>LIBFOO_SITE</code>, <code>LIBFOO_SUBDIR</code>, <code>LIBFOO_DEPENDENCIES</code>, <code>LIBFOO_INSTALL_STAGING</code>, <code>LIBFOO_INSTALL_TARGET</code>.</p>
<p>An additional variable, specific to the Waf infrastructure, can also be defined.</p>
<ul>
<li><code>LIBFOO_SUBDIR</code> may contain the name of a subdirectory inside the package that contains the main wscript file. This is useful, if for example, the main wscript file is not at the root of the tree extracted by the tarball. If <code>HOST_LIBFOO_SUBDIR</code> is not specified, it defaults to <code>LIBFOO_SUBDIR</code>.</li>
<li><code>LIBFOO_NEEDS_EXTERNAL_WAF</code> can be set to <code>YES</code> or <code>NO</code> to tell Buildroot to use the bundled <code>waf</code> executable. If set to <code>NO</code>, the default, then Buildroot will use the waf executable provided in the package source tree; if set to <code>YES</code>, then Buildroot will download, install waf as a host tool and use it to build the package.</li>
<li><code>LIBFOO_WAF_OPTS</code>, to specify additional options to pass to the <code>waf</code> script at every step of the package build process: configure, build and installation. By default, empty.</li>
<li><code>LIBFOO_CONF_OPTS</code>, to specify additional options to pass to the <code>waf</code> script for the configuration step. By default, empty.</li>
<li><code>LIBFOO_BUILD_OPTS</code>, to specify additional options to pass to the <code>waf</code> script during the build step. By default, empty.</li>
<li><code>LIBFOO_INSTALL_STAGING_OPTS</code>, to specify additional options to pass to the <code>waf</code> script during the staging installation step. By default, empty.</li>
<li><code>LIBFOO_INSTALL_TARGET_OPTS</code>, to specify additional options to pass to the <code>waf</code> script during the target installation step. By default, empty.</li>
</ul>
<h2 id="1816-infrastructure-for-meson-based-packages"><a class="markdownIt-Anchor" href="#1816-infrastructure-for-meson-based-packages"></a> 18.16. Infrastructure for Meson-based packages</h2>
<h3 id="18161-meson-package-tutorial"><a class="markdownIt-Anchor" href="#18161-meson-package-tutorial"></a> 18.16.1. <code>meson-package</code> tutorial</h3>
<p><a target="_blank" rel="noopener" href="http://mesonbuild.com/">Meson</a> is an open source build system meant to be both extremely fast, and, even more importantly, as user friendly as possible. It uses <a target="_blank" rel="noopener" href="https://ninja-build.org/">Ninja</a> as a companion tool to perform the actual build operations.</p>
<p>Let’s see how to write a <code>.mk</code> file for a Meson-based package, with an example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_VERSION = 1.0</span><br><span class="line">08: FOO_SOURCE = foo-$(FOO_VERSION).tar.gz</span><br><span class="line">09: FOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: FOO_LICENSE = GPL-3.0+</span><br><span class="line">11: FOO_LICENSE_FILES = COPYING</span><br><span class="line">12: FOO_INSTALL_STAGING = YES</span><br><span class="line">13:</span><br><span class="line">14: FOO_DEPENDENCIES = host-pkgconf bar</span><br><span class="line">15:</span><br><span class="line">16: ifeq ($(BR2_PACKAGE_BAZ),y)</span><br><span class="line">17: FOO_CONF_OPTS += -Dbaz=true</span><br><span class="line">18: FOO_DEPENDENCIES += baz</span><br><span class="line">19: else</span><br><span class="line">20: FOO_CONF_OPTS += -Dbaz=false</span><br><span class="line">21: endif</span><br><span class="line">22:</span><br><span class="line">23: $(eval $(meson-package))</span><br></pre></td></tr></table></figure>
<p>The Makefile starts with the definition of the standard variables for package declaration (lines 7 to 11).</p>
<p>On line line 23, we invoke the <code>meson-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<p>In the example, <code>host-pkgconf</code> and <code>bar</code> are declared as dependencies in <code>FOO_DEPENDENCIES</code> at line 14 because the Meson build file of <code>foo</code> uses <code>pkg-config</code> to determine the compilation flags and libraries of package <code>bar</code>.</p>
<p>Note that it is not necessary to add <code>host-meson</code> in the <code>FOO_DEPENDENCIES</code> variable of a package, since this basic dependency is automatically added as needed by the Meson package infrastructure.</p>
<p>If the “baz” package is selected, then support for the “baz” feature in “foo” is activated by adding <code>-Dbaz=true</code> to <code>FOO_CONF_OPTS</code> at line 17, as specified in the <code>meson_options.txt</code> file in “foo” source tree. The “baz” package is also added to <code>FOO_DEPENDENCIES</code>. Note that the support for <code>baz</code> is explicitly disabled at line 20, if the package is not selected.</p>
<p>To sum it up, to add a new meson-based package, the Makefile example can be copied verbatim then edited to replace all occurences of <code>FOO</code> with the uppercase name of the new package and update the values of the standard variables.</p>
<h3 id="18162-meson-package-reference"><a class="markdownIt-Anchor" href="#18162-meson-package-reference"></a> 18.16.2. <code>meson-package</code> reference</h3>
<p>The main macro of the Meson package infrastructure is <code>meson-package</code>. It is similar to the <code>generic-package</code> macro. The ability to have target and host packages is also available, with the <code>host-meson-package</code> macro.</p>
<p>Just like the generic infrastructure, the Meson infrastructure works by defining a number of variables before calling the <code>meson-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the Meson infrastructure: <code>FOO_VERSION</code>, <code>FOO_SOURCE</code>, <code>FOO_PATCH</code>, <code>FOO_SITE</code>, <code>FOO_SUBDIR</code>, <code>FOO_DEPENDENCIES</code>, <code>FOO_INSTALL_STAGING</code>, <code>FOO_INSTALL_TARGET</code>.</p>
<p>A few additional variables, specific to the Meson infrastructure, can also be defined. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them.</p>
<ul>
<li><code>FOO_SUBDIR</code> may contain the name of a subdirectory inside the package that contains the main meson.build file. This is useful, if for example, the main meson.build file is not at the root of the tree extracted by the tarball. If <code>HOST_FOO_SUBDIR</code> is not specified, it defaults to <code>FOO_SUBDIR</code>.</li>
<li><code>FOO_CONF_ENV</code>, to specify additional environment variables to pass to <code>meson</code> for the configuration step. By default, empty.</li>
<li><code>FOO_CONF_OPTS</code>, to specify additional options to pass to <code>meson</code> for the configuration step. By default, empty.</li>
<li><code>FOO_CFLAGS</code>, to specify compiler arguments added to the package specific <code>cross-compile.conf</code> file <code>c_args</code> property. By default, the value of <code>TARGET_CFLAGS</code>.</li>
<li><code>FOO_CXXFLAGS</code>, to specify compiler arguments added to the package specific <code>cross-compile.conf</code> file <code>cpp_args</code> property. By default, the value of <code>TARGET_CXXFLAGS</code>.</li>
<li><code>FOO_LDFLAGS</code>, to specify compiler arguments added to the package specific <code>cross-compile.conf</code> file <code>c_link_args</code> and <code>cpp_link_args</code> properties. By default, the value of <code>TARGET_LDFLAGS</code>.</li>
<li><code>FOO_MESON_EXTRA_BINARIES</code>, to specify a space-separated list of programs to add to the <code>[binaries]</code> section of the meson <code>cross-compilation.conf</code> configuration file. The format is <code>program-name='/path/to/program'</code>, with no space around the <code>=</code> sign, and with the path of the program between single quotes. By default, empty. Note that Buildroot already sets the correct values for <code>c</code>, <code>cpp</code>, <code>ar</code>, <code>strip</code>, and <code>pkgconfig</code>.</li>
<li><code>FOO_MESON_EXTRA_PROPERTIES</code>, to specify a space-separated list of properties to add to the <code>[properties]</code> section of the meson <code>cross-compilation.conf</code> configuration file. The format is <code>property-name=&lt;value&gt;</code> with no space around the <code>=</code> sign, and with single quotes around string values. By default, empty. Note that Buildroot already sets values for <code>needs_exe_wrapper</code>, <code>c_args</code>, <code>c_link_args</code>, <code>cpp_args</code>, <code>cpp_link_args</code>, <code>sys_root</code>, and <code>pkg_config_libdir</code>.</li>
<li><code>FOO_NINJA_ENV</code>, to specify additional environment variables to pass to <code>ninja</code>, meson companion tool in charge of the build operations. By default, empty.</li>
<li><code>FOO_NINJA_OPTS</code>, to specify a space-separated list of targets to build. By default, empty, to build the default target(s).</li>
</ul>
<h2 id="1817-infrastructure-for-cargo-based-packages"><a class="markdownIt-Anchor" href="#1817-infrastructure-for-cargo-based-packages"></a> 18.17. Infrastructure for Cargo-based packages</h2>
<p>Cargo is the package manager for the Rust programming language. It allows the user to build programs or libraries written in Rust, but it also downloads and manages their dependencies, to ensure repeatable builds. Cargo packages are called “crates”.</p>
<h3 id="18171-cargo-package-tutorial"><a class="markdownIt-Anchor" href="#18171-cargo-package-tutorial"></a> 18.17.1. <code>cargo-package</code> tutorial</h3>
<p>The <code>Config.in</code> file of Cargo-based package <em>foo</em> should contain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">01: config BR2_PACKAGE_FOO</span><br><span class="line">02:     bool &quot;foo&quot;</span><br><span class="line">03:     depends on BR2_PACKAGE_HOST_RUSTC_TARGET_ARCH_SUPPORTS</span><br><span class="line">04:     select BR2_PACKAGE_HOST_RUSTC</span><br><span class="line">05:     help</span><br><span class="line">06:       This is a comment that explains what foo is.</span><br><span class="line">07:</span><br><span class="line">08:       http://foosoftware.org/foo/</span><br></pre></td></tr></table></figure>
<p>And the <code>.mk</code> file for this package should contain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_VERSION = 1.0</span><br><span class="line">08: FOO_SOURCE = foo-$(FOO_VERSION).tar.gz</span><br><span class="line">09: FOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: FOO_LICENSE = GPL-3.0+</span><br><span class="line">11: FOO_LICENSE_FILES = COPYING</span><br><span class="line">12:</span><br><span class="line">13: $(eval $(cargo-package))</span><br></pre></td></tr></table></figure>
<p>The Makefile starts with the definition of the standard variables for package declaration (lines 7 to 11).</p>
<p>As seen in line 13, it is based on the <code>cargo-package</code> infrastructure. Cargo will be invoked automatically by this infrastructure to build and install the package.</p>
<p>It is still possible to define custom build commands or install commands (i.e. with FOO_BUILD_CMDS and FOO_INSTALL_TARGET_CMDS). Those will then replace the commands from the cargo infrastructure.</p>
<h3 id="18172-cargo-package-reference"><a class="markdownIt-Anchor" href="#18172-cargo-package-reference"></a> 18.17.2. <code>cargo-package</code> reference</h3>
<p>The main macros for the Cargo package infrastructure are <code>cargo-package</code> for target packages and <code>host-cargo-package</code> for host packages.</p>
<p>Just like the generic infrastructure, the Cargo infrastructure works by defining a number of variables before calling the <code>cargo-package</code> or <code>host-cargo-package</code> macros.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the Cargo infrastructure: <code>FOO_VERSION</code>, <code>FOO_SOURCE</code>, <code>FOO_PATCH</code>, <code>FOO_SITE</code>, <code>FOO_DEPENDENCIES</code>, <code>FOO_LICENSE</code>, <code>FOO_LICENSE_FILES</code>, etc.</p>
<p>A few additional variables, specific to the Cargo infrastructure, can also be defined. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them.</p>
<ul>
<li><code>FOO_SUBDIR</code> may contain the name of a subdirectory inside the package that contains the Cargo.toml file. This is useful, if for example, it is not at the root of the tree extracted by the tarball. If <code>HOST_FOO_SUBDIR</code> is not specified, it defaults to <code>FOO_SUBDIR</code>.</li>
<li><code>FOO_CARGO_ENV</code> can be used to pass additional variables in the environment of <code>cargo</code> invocations. It used at both build and installation time</li>
<li><code>FOO_CARGO_BUILD_OPTS</code> can be used to pass additional options to <code>cargo</code> at build time.</li>
<li><code>FOO_CARGO_INSTALL_OPTS</code> can be used to pass additional options to <code>cargo</code> at install time.</li>
</ul>
<p>A crate can depend on other libraries from <a target="_blank" rel="noopener" href="http://crates.io">crates.io</a> or git repositories, listed in its <code>Cargo.toml</code> file. Buildroot automatically takes care of downloading such dependencies as part of the download step of packages that use the <code>cargo-package</code> infrastructure. Such dependencies are then kept together with the package source code in the tarball cached in Buildroot’s <code>DL_DIR</code>, and therefore the hash of the package’s tarball includes such dependencies.</p>
<p>This mechanism ensures that any change in the dependencies will be detected, and allows the build to be performed completely offline.</p>
<h2 id="1818-infrastructure-for-go-packages"><a class="markdownIt-Anchor" href="#1818-infrastructure-for-go-packages"></a> 18.18. Infrastructure for Go packages</h2>
<p>This infrastructure applies to Go packages that use the standard build system and use bundled dependencies.</p>
<h3 id="18181-golang-package-tutorial"><a class="markdownIt-Anchor" href="#18181-golang-package-tutorial"></a> 18.18.1. <code>golang-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a go package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_VERSION = 1.0</span><br><span class="line">08: FOO_SITE = $(call github,bar,foo,$(FOO_VERSION))</span><br><span class="line">09: FOO_LICENSE = BSD-3-Clause</span><br><span class="line">10: FOO_LICENSE_FILES = LICENSE</span><br><span class="line">11:</span><br><span class="line">12: $(eval $(golang-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8, we declare the upstream location of the package, here fetched from Github, since a large number of Go packages are hosted on Github.</p>
<p>On line 9 and 10, we give licensing details about the package.</p>
<p>Finally, on line 12, we invoke the <code>golang-package</code> macro that generates all the Makefile rules that actually allow the package to be built.</p>
<h3 id="18182-golang-package-reference"><a class="markdownIt-Anchor" href="#18182-golang-package-reference"></a> 18.18.2. <code>golang-package</code> reference</h3>
<p>In their <code>Config.in</code> file, packages using the <code>golang-package</code> infrastructure should depend on <code>BR2_PACKAGE_HOST_GO_TARGET_ARCH_SUPPORTS</code> because Buildroot will automatically add a dependency on <code>host-go</code> to such packages. If you need CGO support in your package, you must add a dependency on <code>BR2_PACKAGE_HOST_GO_TARGET_CGO_LINKING_SUPPORTS</code>.</p>
<p>The main macro of the Go package infrastructure is <code>golang-package</code>. It is similar to the <code>generic-package</code> macro. The ability to build host packages is also available, with the <code>host-golang-package</code> macro. Host packages built by <code>host-golang-package</code> macro should depend on BR2_PACKAGE_HOST_GO_HOST_ARCH_SUPPORTS.</p>
<p>Just like the generic infrastructure, the Go infrastructure works by defining a number of variables before calling the <code>golang-package</code>.</p>
<p>All the package metadata information variables that exist in the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">generic package infrastructure</a> also exist in the Go infrastructure: <code>FOO_VERSION</code>, <code>FOO_SOURCE</code>, <code>FOO_PATCH</code>, <code>FOO_SITE</code>, <code>FOO_SUBDIR</code>, <code>FOO_DEPENDENCIES</code>, <code>FOO_LICENSE</code>, <code>FOO_LICENSE_FILES</code>, <code>FOO_INSTALL_STAGING</code>, etc.</p>
<p>Note that it is not necessary to add <code>host-go</code> in the <code>FOO_DEPENDENCIES</code> variable of a package, since this basic dependency is automatically added as needed by the Go package infrastructure.</p>
<p>A few additional variables, specific to the Go infrastructure, can optionally be defined, depending on the package’s needs. Many of them are only useful in very specific cases, typical packages will therefore only use a few of them, or none.</p>
<ul>
<li>The package must specify its Go module name in the <code>FOO_GOMOD</code> variable. If not specified, it defaults to <code>URL-domain/1st-part-of-URL/2nd-part-of-URL</code>, e.g <code>FOO_GOMOD</code> will take the value <code>github.com/bar/foo</code> for a package that specifies <code>FOO_SITE = $(call github,bar,foo,$(FOO_VERSION))</code>. The Go package infrastructure will automatically generate a minimal <code>go.mod</code> file in the package source tree if it doesn’t exist.</li>
<li><code>FOO_LDFLAGS</code> and <code>FOO_TAGS</code> can be used to pass respectively the <code>LDFLAGS</code> or the <code>TAGS</code> to the <code>go</code> build command.</li>
<li><code>FOO_BUILD_TARGETS</code> can be used to pass the list of targets that should be built. If <code>FOO_BUILD_TARGETS</code> is not specified, it defaults to <code>.</code>. We then have two cases:
<ul>
<li><code>FOO_BUILD_TARGETS</code> is <code>.</code>. In this case, we assume only one binary will be produced, and that by default we name it after the package name. If that is not appropriate, the name of the produced binary can be overridden using <code>FOO_BIN_NAME</code>.</li>
<li><code>FOO_BUILD_TARGETS</code> is not <code>.</code>. In this case, we iterate over the values to build each target, and for each produced a binary that is the non-directory component of the target. For example if <code>FOO_BUILD_TARGETS = cmd/docker cmd/dockerd</code> the binaries produced are <code>docker</code> and <code>dockerd</code>.</li>
</ul>
</li>
<li><code>FOO_INSTALL_BINS</code> can be used to pass the list of binaries that should be installed in <code>/usr/bin</code> on the target. If <code>FOO_INSTALL_BINS</code> is not specified, it defaults to the lower-case name of package.</li>
</ul>
<p>With the Go infrastructure, all the steps required to build and install the packages are already defined, and they generally work well for most Go-based packages. However, when required, it is still possible to customize what is done in any particular step:</p>
<ul>
<li>By adding a post-operation hook (after extract, patch, configure, build or install). See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for details.</li>
<li>By overriding one of the steps. For example, even if the Go infrastructure is used, if the package <code>.mk</code> file defines its own <code>FOO_BUILD_CMDS</code> variable, it will be used instead of the default Go one. However, using this method should be restricted to very specific cases. Do not use it in the general case.</li>
</ul>
<p>A Go package can depend on other Go modules, listed in its <code>go.mod</code> file. Buildroot automatically takes care of downloading such dependencies as part of the download step of packages that use the <code>golang-package</code> infrastructure. Such dependencies are then kept together with the package source code in the tarball cached in Buildroot’s <code>DL_DIR</code>, and therefore the hash of the package’s tarball includes such dependencies.</p>
<p>This mechanism ensures that any change in the dependencies will be detected, and allows the build to be performed completely offline.</p>
<h2 id="1819-infrastructure-for-qmake-based-packages"><a class="markdownIt-Anchor" href="#1819-infrastructure-for-qmake-based-packages"></a> 18.19. Infrastructure for QMake-based packages</h2>
<h3 id="18191-qmake-package-tutorial"><a class="markdownIt-Anchor" href="#18191-qmake-package-tutorial"></a> 18.19.1. <code>qmake-package</code> tutorial</h3>
<p>First, let’s see how to write a <code>.mk</code> file for a QMake-based package, with an example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # libfoo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LIBFOO_VERSION = 1.0</span><br><span class="line">08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz</span><br><span class="line">09: LIBFOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: LIBFOO_CONF_OPTS = QT_CONFIG+=bar QT_CONFIG-=baz</span><br><span class="line">11: LIBFOO_DEPENDENCIES = bar</span><br><span class="line">12:</span><br><span class="line">13: $(eval $(qmake-package))</span><br></pre></td></tr></table></figure>
<p>On line 7, we declare the version of the package.</p>
<p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended) and the location of the tarball on the Web. Buildroot will automatically download the tarball from this location.</p>
<p>On line 10, we tell Buildroot what options to enable for libfoo.</p>
<p>On line 11, we tell Buildroot the dependencies of libfoo.</p>
<p>Finally, on line line 13, we invoke the <code>qmake-package</code> macro that generates all the Makefile rules that actually allows the package to be built.</p>
<h3 id="18192-qmake-package-reference"><a class="markdownIt-Anchor" href="#18192-qmake-package-reference"></a> 18.19.2. <code>qmake-package</code> reference</h3>
<p>The main macro of the QMake package infrastructure is <code>qmake-package</code>. It is similar to the <code>generic-package</code> macro.</p>
<p>Just like the generic infrastructure, the QMake infrastructure works by defining a number of variables before calling the <code>qmake-package</code> macro.</p>
<p>First, all the package metadata information variables that exist in the generic infrastructure also exist in the QMake infrastructure: <code>LIBFOO_VERSION</code>, <code>LIBFOO_SOURCE</code>, <code>LIBFOO_PATCH</code>, <code>LIBFOO_SITE</code>, <code>LIBFOO_SUBDIR</code>, <code>LIBFOO_DEPENDENCIES</code>, <code>LIBFOO_INSTALL_STAGING</code>, <code>LIBFOO_INSTALL_TARGET</code>.</p>
<p>An additional variable, specific to the QMake infrastructure, can also be defined.</p>
<ul>
<li><code>LIBFOO_CONF_ENV</code>, to specify additional environment variables to pass to the <code>qmake</code> script for the configuration step. By default, empty.</li>
<li><code>LIBFOO_CONF_OPTS</code>, to specify additional options to pass to the <code>qmake</code> script for the configuration step. By default, empty.</li>
<li><code>LIBFOO_MAKE_ENV</code>, to specify additional environment variables to the <code>make</code> command during the build and install steps. By default, empty.</li>
<li><code>LIBFOO_MAKE_OPTS</code>, to specify additional targets to pass to the <code>make</code> command during the build step. By default, empty.</li>
<li><code>LIBFOO_INSTALL_STAGING_OPTS</code>, to specify additional targets to pass to the <code>make</code> command during the staging installation step. By default, <code>install</code>.</li>
<li><code>LIBFOO_INSTALL_TARGET_OPTS</code>, to specify additional targets to pass to the <code>make</code> command during the target installation step. By default, <code>install</code>.</li>
<li><code>LIBFOO_SYNC_QT_HEADERS</code>, to run <a target="_blank" rel="noopener" href="http://syncqt.pl">syncqt.pl</a> before qmake. Some packages need this to have a properly populated include directory before running the build.</li>
</ul>
<h2 id="1820-infrastructure-for-packages-building-kernel-modules"><a class="markdownIt-Anchor" href="#1820-infrastructure-for-packages-building-kernel-modules"></a> 18.20. Infrastructure for packages building kernel modules</h2>
<p>Buildroot offers a helper infrastructure to make it easy to write packages that build and install Linux kernel modules. Some packages only contain a kernel module, other packages contain programs and libraries in addition to kernel modules. Buildroot’s helper infrastructure supports either case.</p>
<h3 id="18201-kernel-module-tutorial"><a class="markdownIt-Anchor" href="#18201-kernel-module-tutorial"></a> 18.20.1. <code>kernel-module</code> tutorial</h3>
<p>Let’s start with an example on how to prepare a simple package that only builds a kernel module, and no other component:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_VERSION = 1.2.3</span><br><span class="line">08: FOO_SOURCE = foo-$(FOO_VERSION).tar.xz</span><br><span class="line">09: FOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: FOO_LICENSE = GPL-2.0</span><br><span class="line">11: FOO_LICENSE_FILES = COPYING</span><br><span class="line">12:</span><br><span class="line">13: $(eval $(kernel-module))</span><br><span class="line">14: $(eval $(generic-package))</span><br></pre></td></tr></table></figure>
<p>Lines 7-11 define the usual meta-data to specify the version, archive name, remote URI where to find the package source, licensing information.</p>
<p>On line 13, we invoke the <code>kernel-module</code> helper infrastructure, that generates all the appropriate Makefile rules and variables to build that kernel module.</p>
<p>Finally, on line 14, we invoke the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-tutorial"><code>generic-package</code> infrastructure</a>.</p>
<p>The dependency on <code>linux</code> is automatically added, so it is not needed to specify it in <code>FOO_DEPENDENCIES</code>.</p>
<p>What you may have noticed is that, unlike other package infrastructures, we explicitly invoke a second infrastructure. This allows a package to build a kernel module, but also, if needed, use any one of other package infrastructures to build normal userland components (libraries, executables…). Using the <code>kernel-module</code> infrastructure on its own is not sufficient; another package infrastructure <em><strong>*must*</strong></em> be used.</p>
<p>Let’s look at a more complex example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_VERSION = 1.2.3</span><br><span class="line">08: FOO_SOURCE = foo-$(FOO_VERSION).tar.xz</span><br><span class="line">09: FOO_SITE = http://www.foosoftware.org/download</span><br><span class="line">10: FOO_LICENSE = GPL-2.0</span><br><span class="line">11: FOO_LICENSE_FILES = COPYING</span><br><span class="line">12:</span><br><span class="line">13: FOO_MODULE_SUBDIRS = driver/base</span><br><span class="line">14: FOO_MODULE_MAKE_OPTS = KVERSION=$(LINUX_VERSION_PROBED)</span><br><span class="line">15:</span><br><span class="line">16: ifeq ($(BR2_PACKAGE_LIBBAR),y)</span><br><span class="line">17: FOO_DEPENDENCIES += libbar</span><br><span class="line">18: FOO_CONF_OPTS += --enable-bar</span><br><span class="line">19: FOO_MODULE_SUBDIRS += driver/bar</span><br><span class="line">20: else</span><br><span class="line">21: FOO_CONF_OPTS += --disable-bar</span><br><span class="line">22: endif</span><br><span class="line">23:</span><br><span class="line">24: $(eval $(kernel-module))</span><br><span class="line">26: $(eval $(autotools-package))</span><br></pre></td></tr></table></figure>
<p>Here, we see that we have an autotools-based package, that also builds the kernel module located in sub-directory <code>driver/base</code> and, if libbar is enabled, the kernel module located in sub-directory <code>driver/bar</code>, and defines the variable <code>KVERSION</code> to be passed to the Linux buildsystem when building the module(s).</p>
<h3 id="18202-kernel-module-reference"><a class="markdownIt-Anchor" href="#18202-kernel-module-reference"></a> 18.20.2. <code>kernel-module</code> reference</h3>
<p>The main macro for the kernel module infrastructure is <code>kernel-module</code>. Unlike other package infrastructures, it is not stand-alone, and requires any of the other <code>*-package</code> macros be called after it.</p>
<p>The <code>kernel-module</code> macro defines post-build and post-target-install hooks to build the kernel modules. If the package’s <code>.mk</code> needs access to the built kernel modules, it should do so in a post-build hook, <em><strong>*registered after*</strong></em> the call to <code>kernel-module</code>. Similarly, if the package’s <code>.mk</code> needs access to the kernel module after it has been installed, it should do so in a post-install hook, <em><strong>*registered after*</strong></em> the call to <code>kernel-module</code>. Here’s an example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(eval $(kernel-module))</span><br><span class="line"></span><br><span class="line">define FOO_DO_STUFF_WITH_KERNEL_MODULE</span><br><span class="line">    # Do something with it...</span><br><span class="line">endef</span><br><span class="line">FOO_POST_BUILD_HOOKS += FOO_DO_STUFF_WITH_KERNEL_MODULE</span><br><span class="line"></span><br><span class="line">$(eval $(generic-package))</span><br></pre></td></tr></table></figure>
<p>Finally, unlike the other package infrastructures, there is no <code>host-kernel-module</code> variant to build a host kernel module.</p>
<p>The following additional variables can optionally be defined to further configure the build of the kernel module:</p>
<ul>
<li><code>FOO_MODULE_SUBDIRS</code> may be set to one or more sub-directories (relative to the package source top-directory) where the kernel module sources are. If empty or not set, the sources for the kernel module(s) are considered to be located at the top of the package source tree.</li>
<li><code>FOO_MODULE_MAKE_OPTS</code> may be set to contain extra variable definitions to pass to the Linux buildsystem.</li>
</ul>
<p>You may also reference (but you may <em><strong>*not*</strong></em> set!) those variables:</p>
<ul>
<li><code>LINUX_DIR</code> contains the path to where the Linux kernel has been extracted and built.</li>
<li><code>LINUX_VERSION</code> contains the version string as configured by the user.</li>
<li><code>LINUX_VERSION_PROBED</code> contains the real version string of the kernel, retrieved with running <code>make -C $(LINUX_DIR) kernelrelease</code></li>
<li><code>KERNEL_ARCH</code> contains the name of the current architecture, like <code>arm</code>, <code>mips</code>…</li>
</ul>
<h2 id="1821-infrastructure-for-asciidoc-documents"><a class="markdownIt-Anchor" href="#1821-infrastructure-for-asciidoc-documents"></a> 18.21. Infrastructure for asciidoc documents</h2>
<p>The Buildroot manual, which you are currently reading, is entirely written using the <a target="_blank" rel="noopener" href="http://asciidoc.org/">AsciiDoc</a> mark-up syntax. The manual is then rendered to many formats:</p>
<ul>
<li>html</li>
<li>split-html</li>
<li>pdf</li>
<li>epub</li>
<li>text</li>
</ul>
<p>Although Buildroot only contains one document written in AsciiDoc, there is, as for packages, an infrastructure for rendering documents using the AsciiDoc syntax.</p>
<p>Also as for packages, the AsciiDoc infrastructure is available from a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#outside-br-custom">br2-external tree</a>. This allows documentation for a br2-external tree to match the Buildroot documentation, as it will be rendered to the same formats and use the same layout and theme.</p>
<h3 id="18211-asciidoc-document-tutorial"><a class="markdownIt-Anchor" href="#18211-asciidoc-document-tutorial"></a> 18.21.1. <code>asciidoc-document</code> tutorial</h3>
<p>Whereas package infrastructures are suffixed with <code>-package</code>, the document infrastructures are suffixed with <code>-document</code>. So, the AsciiDoc infrastructure is named <code>asciidoc-document</code>.</p>
<p>Here is an example to render a simple AsciiDoc document.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo-document</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_SOURCES = $(sort $(wildcard $(FOO_DOCDIR)/*))</span><br><span class="line">08: $(eval $(call asciidoc-document))</span><br></pre></td></tr></table></figure>
<p>On line 7, the Makefile declares what the sources of the document are. Currently, it is expected that the document’s sources are only local; Buildroot will not attempt to download anything to render a document. Thus, you must indicate where the sources are. Usually, the string above is sufficient for a document with no sub-directory structure.</p>
<p>On line 8, we call the <code>asciidoc-document</code> function, which generates all the Makefile code necessary to render the document.</p>
<h3 id="18212-asciidoc-document-reference"><a class="markdownIt-Anchor" href="#18212-asciidoc-document-reference"></a> 18.21.2. <code>asciidoc-document</code> reference</h3>
<p>The list of variables that can be set in a <code>.mk</code> file to give metadata information is (assuming the document name is <code>foo</code>) :</p>
<ul>
<li><code>FOO_SOURCES</code>, mandatory, defines the source files for the document.</li>
<li><code>FOO_RESOURCES</code>, optional, may contain a space-separated list of paths to one or more directories containing so-called resources (like CSS or images). By default, empty.</li>
<li><code>FOO_DEPENDENCIES</code>, optional, the list of packages (most probably, host-packages) that must be built before building this document.</li>
<li><code>FOO_TOC_DEPTH</code>, <code>FOO_TOC_DEPTH_&lt;FMT&gt;</code>, optionals, the depth of the table of content for this document, which can be overridden for the specified format <code>&lt;FMT&gt;</code> (see the list of rendered formats, above, but in uppercase, and with dash replaced by underscore; see example, below). By default: <code>1</code>.</li>
</ul>
<p>There are also additional hooks (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">Section 18.23, “Hooks available in the various build steps”</a> for general information on hooks), that a document may set to define extra actions to be done at various steps:</p>
<ul>
<li><code>FOO_POST_RSYNC_HOOKS</code> to run additional commands after the sources have been copied by Buildroot. This can for example be used to generate part of the manual with information extracted from the tree. As an example, Buildroot uses this hook to generate the tables in the appendices.</li>
<li><code>FOO_CHECK_DEPENDENCIES_HOOKS</code> to run additional tests on required components to generate the document. In AsciiDoc, it is possible to call filters, that is, programs that will parse an AsciiDoc block and render it appropriately (e.g. <a target="_blank" rel="noopener" href="http://ditaa.sourceforge.net/">ditaa</a> or <a target="_blank" rel="noopener" href="https://pythonhosted.org/aafigure/">aafigure</a>).</li>
<li><code>FOO_CHECK_DEPENDENCIES_&lt;FMT&gt;_HOOKS</code>, to run additional tests for the specified format <code>&lt;FMT&gt;</code> (see the list of rendered formats, above).</li>
</ul>
<p>Buildroot sets the following variable that can be used in the definitions above:</p>
<ul>
<li><code>$(FOO_DOCDIR)</code>, similar to <code>$(FOO_PKGDIR)</code>, contains the path to the directory containing <code>foo.mk</code>. It can be used to refer to the document sources, and can be used in the hooks, especially the post-rsync hook if parts of the documentation needs to be generated.</li>
<li><code>$(@D)</code>, as for traditional packages, contains the path to the directory where the document will be copied and built.</li>
</ul>
<p>Here is a complete example that uses all variables and all hooks:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo-document</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: FOO_SOURCES = $(sort $(wildcard $(FOO_DOCDIR)/*))</span><br><span class="line">08: FOO_RESOURCES = $(sort $(wildcard $(FOO_DOCDIR)/ressources))</span><br><span class="line">09:</span><br><span class="line">10: FOO_TOC_DEPTH = 2</span><br><span class="line">11: FOO_TOC_DEPTH_HTML = 1</span><br><span class="line">12: FOO_TOC_DEPTH_SPLIT_HTML = 3</span><br><span class="line">13:</span><br><span class="line">14: define FOO_GEN_EXTRA_DOC</span><br><span class="line">15:     /path/to/generate-script --outdir=$(@D)</span><br><span class="line">16: endef</span><br><span class="line">17: FOO_POST_RSYNC_HOOKS += FOO_GEN_EXTRA_DOC</span><br><span class="line">18:</span><br><span class="line">19: define FOO_CHECK_MY_PROG</span><br><span class="line">20:     if ! which my-prog &gt;/dev/null 2&gt;&amp;1; then \</span><br><span class="line">21:         echo &quot;You need my-prog to generate the foo document&quot;; \</span><br><span class="line">22:         exit 1; \</span><br><span class="line">23:     fi</span><br><span class="line">24: endef</span><br><span class="line">25: FOO_CHECK_DEPENDENCIES_HOOKS += FOO_CHECK_MY_PROG</span><br><span class="line">26:</span><br><span class="line">27: define FOO_CHECK_MY_OTHER_PROG</span><br><span class="line">28:     if ! which my-other-prog &gt;/dev/null 2&gt;&amp;1; then \</span><br><span class="line">29:         echo &quot;You need my-other-prog to generate the foo document as PDF&quot;; \</span><br><span class="line">30:         exit 1; \</span><br><span class="line">31:     fi</span><br><span class="line">32: endef</span><br><span class="line">33: FOO_CHECK_DEPENDENCIES_PDF_HOOKS += FOO_CHECK_MY_OTHER_PROG</span><br><span class="line">34:</span><br><span class="line">35: $(eval $(call asciidoc-document))</span><br></pre></td></tr></table></figure>
<h2 id="1822-infrastructure-specific-to-the-linux-kernel-package"><a class="markdownIt-Anchor" href="#1822-infrastructure-specific-to-the-linux-kernel-package"></a> 18.22. Infrastructure specific to the Linux kernel package</h2>
<p>The Linux kernel package can use some specific infrastructures based on package hooks for building Linux kernel tools or/and building Linux kernel extensions.</p>
<h3 id="18221-linux-kernel-tools"><a class="markdownIt-Anchor" href="#18221-linux-kernel-tools"></a> 18.22.1. linux-kernel-tools</h3>
<p>Buildroot offers a helper infrastructure to build some userspace tools for the target available within the Linux kernel sources. Since their source code is part of the kernel source code, a special package, <code>linux-tools</code>, exists and re-uses the sources of the Linux kernel that runs on the target.</p>
<p>Let’s look at an example of a Linux tool. For a new Linux tool named <code>foo</code>, create a new menu entry in the existing <code>package/linux-tools/Config.in</code>. This file will contain the option descriptions related to each kernel tool that will be used and displayed in the configuration tool. It would basically look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">01: config BR2_PACKAGE_LINUX_TOOLS_FOO</span><br><span class="line">02:     bool &quot;foo&quot;</span><br><span class="line">03:     select BR2_PACKAGE_LINUX_TOOLS</span><br><span class="line">04:     help</span><br><span class="line">05:       This is a comment that explains what foo kernel tool is.</span><br><span class="line">06:</span><br><span class="line">07:       http://foosoftware.org/foo/</span><br></pre></td></tr></table></figure>
<p>The name of the option starts with the prefix <code>BR2_PACKAGE_LINUX_TOOLS_</code>, followed by the uppercase name of the tool (like is done for packages).</p>
<p><strong>Note.</strong> Unlike other packages, the <code>linux-tools</code> package options appear in the <code>linux</code> kernel menu, under the <code>Linux Kernel Tools</code> sub-menu, not under the <code>Target packages</code> main menu.</p>
<p>Then for each linux tool, add a new <code>.mk.in</code> file named <code>package/linux-tools/linux-tool-foo.mk.in</code>. It would basically look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LINUX_TOOLS += foo</span><br><span class="line">08:</span><br><span class="line">09: FOO_DEPENDENCIES = libbbb</span><br><span class="line">10:</span><br><span class="line">11: define FOO_BUILD_CMDS</span><br><span class="line">12:     $(TARGET_MAKE_ENV) $(MAKE) -C $(LINUX_DIR)/tools foo</span><br><span class="line">13: endef</span><br><span class="line">14:</span><br><span class="line">15: define FOO_INSTALL_STAGING_CMDS</span><br><span class="line">16:     $(TARGET_MAKE_ENV) $(MAKE) -C $(LINUX_DIR)/tools \</span><br><span class="line">17:             DESTDIR=$(STAGING_DIR) \</span><br><span class="line">18:             foo_install</span><br><span class="line">19: endef</span><br><span class="line">20:</span><br><span class="line">21: define FOO_INSTALL_TARGET_CMDS</span><br><span class="line">22:     $(TARGET_MAKE_ENV) $(MAKE) -C $(LINUX_DIR)/tools \</span><br><span class="line">23:             DESTDIR=$(TARGET_DIR) \</span><br><span class="line">24:             foo_install</span><br><span class="line">25: endef</span><br></pre></td></tr></table></figure>
<p>On line 7, we register the Linux tool <code>foo</code> to the list of available Linux tools.</p>
<p>On line 9, we specify the list of dependencies this tool relies on. These dependencies are added to the Linux package dependencies list only when the <code>foo</code> tool is selected.</p>
<p>The rest of the Makefile, lines 11-25 defines what should be done at the different steps of the Linux tool build process like for a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-tutorial"><code>generic package</code></a>. They will actually be used only when the <code>foo</code> tool is selected. The only supported commands are <code>_BUILD_CMDS</code>, <code>_INSTALL_STAGING_CMDS</code> and <code>_INSTALL_TARGET_CMDS</code>.</p>
<p><strong>Note.</strong> One <em><strong>*must not*</strong></em> call <code>$(eval $(generic-package))</code> or any other package infrastructure! Linux tools are not packages by themselves, they are part of the <code>linux-tools</code> package.</p>
<h3 id="18222-linux-kernel-extensions"><a class="markdownIt-Anchor" href="#18222-linux-kernel-extensions"></a> 18.22.2. linux-kernel-extensions</h3>
<p>Some packages provide new features that require the Linux kernel tree to be modified. This can be in the form of patches to be applied on the kernel tree, or in the form of new files to be added to the tree. The Buildroot’s Linux kernel extensions infrastructure provides a simple solution to automatically do this, just after the kernel sources are extracted and before the kernel patches are applied. Examples of extensions packaged using this mechanism are the real-time extensions Xenomai and RTAI, as well as the set of out-of-tree LCD screens drivers <code>fbtft</code>.</p>
<p>Let’s look at an example on how to add a new Linux extension <code>foo</code>.</p>
<p>First, create the package <code>foo</code> that provides the extension: this package is a standard package; see the previous chapters on how to create such a package. This package is in charge of downloading the sources archive, checking the hash, defining the licence informations and building user space tools if any.</p>
<p>Then create the <em>Linux extension</em> proper: create a new menu entry in the existing <code>linux/Config.ext.in</code>. This file contains the option descriptions related to each kernel extension that will be used and displayed in the configuration tool. It would basically look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">01: config BR2_LINUX_KERNEL_EXT_FOO</span><br><span class="line">02:     bool &quot;foo&quot;</span><br><span class="line">03:     help</span><br><span class="line">04:       This is a comment that explains what foo kernel extension is.</span><br><span class="line">05:</span><br><span class="line">06:       http://foosoftware.org/foo/</span><br></pre></td></tr></table></figure>
<p>Then for each linux extension, add a new <code>.mk</code> file named <code>linux/linux-ext-foo.mk</code>. It should basically contain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">01: ################################################################################</span><br><span class="line">02: #</span><br><span class="line">03: # foo</span><br><span class="line">04: #</span><br><span class="line">05: ################################################################################</span><br><span class="line">06:</span><br><span class="line">07: LINUX_EXTENSIONS += foo</span><br><span class="line">08:</span><br><span class="line">09: define FOO_PREPARE_KERNEL</span><br><span class="line">10:     $(FOO_DIR)/prepare-kernel-tree.sh --linux-dir=$(@D)</span><br><span class="line">11: endef</span><br></pre></td></tr></table></figure>
<p>On line 7, we add the Linux extension <code>foo</code> to the list of available Linux extensions.</p>
<p>On line 9-11, we define what should be done by the extension to modify the Linux kernel tree; this is specific to the linux extension and can use the variables defined by the <code>foo</code> package, like: <code>$(FOO_DIR)</code> or <code>$(FOO_VERSION)</code>… as well as all the Linux variables, like: <code>$(LINUX_VERSION)</code> or <code>$(LINUX_VERSION_PROBED)</code>, <code>$(KERNEL_ARCH)</code>… See the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#kernel-variables">definition of those kernel variables</a>.</p>
<h2 id="1823-hooks-available-in-the-various-build-steps"><a class="markdownIt-Anchor" href="#1823-hooks-available-in-the-various-build-steps"></a> 18.23. Hooks available in the various build steps</h2>
<p>The generic infrastructure (and as a result also the derived autotools and cmake infrastructures) allow packages to specify hooks. These define further actions to perform after existing steps. Most hooks aren’t really useful for generic packages, since the <code>.mk</code> file already has full control over the actions performed in each step of the package construction.</p>
<p>The following hook points are available:</p>
<ul>
<li><code>LIBFOO_PRE_DOWNLOAD_HOOKS</code></li>
<li><code>LIBFOO_POST_DOWNLOAD_HOOKS</code></li>
<li><code>LIBFOO_PRE_EXTRACT_HOOKS</code></li>
<li><code>LIBFOO_POST_EXTRACT_HOOKS</code></li>
<li><code>LIBFOO_PRE_RSYNC_HOOKS</code></li>
<li><code>LIBFOO_POST_RSYNC_HOOKS</code></li>
<li><code>LIBFOO_PRE_PATCH_HOOKS</code></li>
<li><code>LIBFOO_POST_PATCH_HOOKS</code></li>
<li><code>LIBFOO_PRE_CONFIGURE_HOOKS</code></li>
<li><code>LIBFOO_POST_CONFIGURE_HOOKS</code></li>
<li><code>LIBFOO_PRE_BUILD_HOOKS</code></li>
<li><code>LIBFOO_POST_BUILD_HOOKS</code></li>
<li><code>LIBFOO_PRE_INSTALL_HOOKS</code> (for host packages only)</li>
<li><code>LIBFOO_POST_INSTALL_HOOKS</code> (for host packages only)</li>
<li><code>LIBFOO_PRE_INSTALL_STAGING_HOOKS</code> (for target packages only)</li>
<li><code>LIBFOO_POST_INSTALL_STAGING_HOOKS</code> (for target packages only)</li>
<li><code>LIBFOO_PRE_INSTALL_TARGET_HOOKS</code> (for target packages only)</li>
<li><code>LIBFOO_POST_INSTALL_TARGET_HOOKS</code> (for target packages only)</li>
<li><code>LIBFOO_PRE_INSTALL_IMAGES_HOOKS</code></li>
<li><code>LIBFOO_POST_INSTALL_IMAGES_HOOKS</code></li>
<li><code>LIBFOO_PRE_LEGAL_INFO_HOOKS</code></li>
<li><code>LIBFOO_POST_LEGAL_INFO_HOOKS</code></li>
<li><code>LIBFOO_TARGET_FINALIZE_HOOKS</code></li>
</ul>
<p>These variables are <em>lists</em> of variable names containing actions to be performed at this hook point. This allows several hooks to be registered at a given hook point. Here is an example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">define LIBFOO_POST_PATCH_FIXUP</span><br><span class="line">        action1</span><br><span class="line">        action2</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">LIBFOO_POST_PATCH_HOOKS += LIBFOO_POST_PATCH_FIXUP</span><br></pre></td></tr></table></figure>
<h3 id="18231-using-the-post_rsync-hook"><a class="markdownIt-Anchor" href="#18231-using-the-post_rsync-hook"></a> 18.23.1. Using the <code>POST_RSYNC</code> hook</h3>
<p>The <code>POST_RSYNC</code> hook is run only for packages that use a local source, either through the <code>local</code> site method or the <code>OVERRIDE_SRCDIR</code> mechanism. In this case, package sources are copied using <code>rsync</code> from the local location into the buildroot build directory. The <code>rsync</code> command does not copy all files from the source directory, though. Files belonging to a version control system, like the directories <code>.git</code>, <code>.hg</code>, etc. are not copied. For most packages this is sufficient, but a given package can perform additional actions using the <code>POST_RSYNC</code> hook.</p>
<p>In principle, the hook can contain any command you want. One specific use case, though, is the intentional copying of the version control directory using <code>rsync</code>. The <code>rsync</code> command you use in the hook can, among others, use the following variables:</p>
<ul>
<li><code>$(SRCDIR)</code>: the path to the overridden source directory</li>
<li><code>$(@D)</code>: the path to the build directory</li>
</ul>
<h3 id="18232-target-finalize-hook"><a class="markdownIt-Anchor" href="#18232-target-finalize-hook"></a> 18.23.2. Target-finalize hook</h3>
<p>Packages may also register hooks in <code>LIBFOO_TARGET_FINALIZE_HOOKS</code>. These hooks are run after all packages are built, but before the filesystem images are generated. They are seldom used, and your package probably do not need them.</p>
<h2 id="1824-gettext-integration-and-interaction-with-packages"><a class="markdownIt-Anchor" href="#1824-gettext-integration-and-interaction-with-packages"></a> 18.24. Gettext integration and interaction with packages</h2>
<p>Many packages that support internationalization use the gettext library. Dependencies for this library are fairly complicated and therefore, deserve some explanation.</p>
<p>The <em>glibc</em> C library integrates a full-blown implementation of <em>gettext</em>, supporting translation. Native Language Support is therefore built-in in <em>glibc</em>.</p>
<p>On the other hand, the <em>uClibc</em> and <em>musl</em> C libraries only provide a stub implementation of the gettext functionality, which allows to compile libraries and programs using gettext functions, but without providing the translation capabilities of a full-blown gettext implementation. With such C libraries, if real Native Language Support is necessary, it can be provided by the <code>libintl</code> library of the <code>gettext</code> package.</p>
<p>Due to this, and in order to make sure that Native Language Support is properly handled, packages in Buildroot that can use NLS support should:</p>
<ol>
<li>Ensure NLS support is enabled when <code>BR2_SYSTEM_ENABLE_NLS=y</code>. This is done automatically for <em>autotools</em> packages and therefore should only be done for packages using other package infrastructures.</li>
<li>Add <code>$(TARGET_NLS_DEPENDENCIES)</code> to the package <code>&lt;pkg&gt;_DEPENDENCIES</code> variable. This addition should be done unconditionally: the value of this variable is automatically adjusted by the core infrastructure to contain the relevant list of packages. If NLS support is disabled, this variable is empty. If NLS support is enabled, this variable contains <code>host-gettext</code> so that tools needed to compile translation files are available on the host. In addition, if <em>uClibc</em> or <em>musl</em> are used, this variable also contains <code>gettext</code> in order to get the full-blown <em>gettext</em> implementation.</li>
<li>If needed, add <code>$(TARGET_NLS_LIBS)</code> to the linker flags, so that the package gets linked with <code>libintl</code>. This is generally not needed with <em>autotools</em> packages as they usually detect automatically that they should link with <code>libintl</code>. However, packages using other build systems, or problematic autotools-based packages may need this. <code>$(TARGET_NLS_LIBS)</code> should be added unconditionally to the linker flags, as the core automatically makes it empty or defined to <code>-lintl</code> depending on the configuration.</li>
</ol>
<p>No changes should be made to the <code>Config.in</code> file to support NLS.</p>
<p>Finally, certain packages need some gettext utilities on the target, such as the <code>gettext</code> program itself, which allows to retrieve translated strings, from the command line. In such a case, the package should:</p>
<ul>
<li>use <code>select BR2_PACKAGE_GETTEXT</code> in their <code>Config.in</code> file, indicating in a comment above that it’s a runtime dependency only.</li>
<li>not add any <code>gettext</code> dependency in the <code>DEPENDENCIES</code> variable of their <code>.mk</code> file.</li>
</ul>
<h2 id="1825-tips-and-tricks"><a class="markdownIt-Anchor" href="#1825-tips-and-tricks"></a> 18.25. Tips and tricks</h2>
<h3 id="18251-package-name-config-entry-name-and-makefile-variable-relationship"><a class="markdownIt-Anchor" href="#18251-package-name-config-entry-name-and-makefile-variable-relationship"></a> 18.25.1. Package name, config entry name and makefile variable relationship</h3>
<p>In Buildroot, there is some relationship between:</p>
<ul>
<li>the <em>package name</em>, which is the package directory name (and the name of the <code>*.mk</code> file);</li>
<li>the config entry name that is declared in the <code>Config.in</code> file;</li>
<li>the makefile variable prefix.</li>
</ul>
<p>It is mandatory to maintain consistency between these elements, using the following rules:</p>
<ul>
<li>the package directory and the <code>*.mk</code> name are the <em>package name</em> itself (e.g.: <code>package/foo-bar_boo/foo-bar_boo.mk</code>);</li>
<li>the <em>make</em> target name is the <em>package name</em> itself (e.g.: <code>foo-bar_boo</code>);</li>
<li>the config entry is the upper case <em>package name</em> with <code>.</code> and <code>-</code> characters substituted with <code>_</code>, prefixed with <code>BR2_PACKAGE_</code> (e.g.: <code>BR2_PACKAGE_FOO_BAR_BOO</code>);</li>
<li>the <code>*.mk</code> file variable prefix is the upper case <em>package name</em> with <code>.</code> and <code>-</code> characters substituted with <code>_</code> (e.g.: <code>FOO_BAR_BOO_VERSION</code>).</li>
</ul>
<h3 id="18252-how-to-check-the-coding-style"><a class="markdownIt-Anchor" href="#18252-how-to-check-the-coding-style"></a> 18.25.2. How to check the coding style</h3>
<p>Buildroot provides a script in <code>utils/check-package</code> that checks new or changed files for coding style. It is not a complete language validator, but it catches many common mistakes. It is meant to run in the actual files you created or modified, before creating the patch for submission.</p>
<p>This script can be used for packages, filesystem makefiles, <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> files, etc. It does not check the files defining the package infrastructures and some other files containing similar common code.</p>
<p>To use it, run the <code>check-package</code> script, by telling which files you created or changed:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./utils/check-package package/new-package/*</span><br></pre></td></tr></table></figure>
<p>If you have the <code>utils</code> directory in your path you can also run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd package/new-package/</span><br><span class="line">$ check-package *</span><br></pre></td></tr></table></figure>
<p>The tool can also be used for packages in a br2-external:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ check-package -b /path/to/br2-ext-tree/package/my-package/*</span><br></pre></td></tr></table></figure>
<h3 id="18253-how-to-test-your-package"><a class="markdownIt-Anchor" href="#18253-how-to-test-your-package"></a> 18.25.3. How to test your package</h3>
<p>Once you have added your new package, it is important that you test it under various conditions: does it build for all architectures? Does it build with the different C libraries? Does it need threads, NPTL? And so on…</p>
<p>Buildroot runs <a target="_blank" rel="noopener" href="http://autobuild.buildroot.org/">autobuilders</a> which continuously test random configurations. However, these only build the <code>master</code> branch of the git tree, and your new fancy package is not yet there.</p>
<p>Buildroot provides a script in <code>utils/test-pkg</code> that uses the same base configurations as used by the autobuilders so you can test your package in the same conditions.</p>
<p>First, create a config snippet that contains all the necessary options needed to enable your package, but without any architecture or toolchain option. For example, let’s create a config snippet that just enables <code>libcurl</code>, without any TLS backend:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat libcurl.config</span><br><span class="line">BR2_PACKAGE_LIBCURL=y</span><br></pre></td></tr></table></figure>
<p>If your package needs more configuration options, you can add them to the config snippet. For example, here’s how you would test <code>libcurl</code> with <code>openssl</code> as a TLS backend and the <code>curl</code> program:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat libcurl.config</span><br><span class="line">BR2_PACKAGE_LIBCURL=y</span><br><span class="line">BR2_PACKAGE_LIBCURL_CURL=y</span><br><span class="line">BR2_PACKAGE_OPENSSL=y</span><br></pre></td></tr></table></figure>
<p>Then run the <code>test-pkg</code> script, by telling it what config snippet to use and what package to test:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./utils/test-pkg -c libcurl.config -p libcurl</span><br></pre></td></tr></table></figure>
<p>By default, <code>test-pkg</code> will build your package against a subset of the toolchains used by the autobuilders, which has been selected by the Buildroot developers as being the most useful and representative subset. If you want to test all toolchains, pass the <code>-a</code> option. Note that in any case, internal toolchains are excluded as they take too long to build.</p>
<p>The output lists all toolchains that are tested and the corresponding result (excerpt, results are fake):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ./utils/test-pkg -c libcurl.config -p libcurl</span><br><span class="line">                armv5-ctng-linux-gnueabi [ 1/11]: OK</span><br><span class="line">              armv7-ctng-linux-gnueabihf [ 2/11]: OK</span><br><span class="line">                        br-aarch64-glibc [ 3/11]: SKIPPED</span><br><span class="line">                           br-arcle-hs38 [ 4/11]: SKIPPED</span><br><span class="line">                            br-arm-basic [ 5/11]: FAILED</span><br><span class="line">                  br-arm-cortex-a9-glibc [ 6/11]: OK</span><br><span class="line">                   br-arm-cortex-a9-musl [ 7/11]: FAILED</span><br><span class="line">                   br-arm-cortex-m4-full [ 8/11]: OK</span><br><span class="line">                             br-arm-full [ 9/11]: OK</span><br><span class="line">                    br-arm-full-nothread [10/11]: FAILED</span><br><span class="line">                      br-arm-full-static [11/11]: OK</span><br><span class="line">11 builds, 2 skipped, 2 build failed, 1 legal-info failed</span><br></pre></td></tr></table></figure>
<p>The results mean:</p>
<ul>
<li><code>OK</code>: the build was successful.</li>
<li><code>SKIPPED</code>: one or more configuration options listed in the config snippet were not present in the final configuration. This is due to options having dependencies not satisfied by the toolchain, such as for example a package that <code>depends on BR2_USE_MMU</code> with a noMMU toolchain. The missing options are reported in <code>missing.config</code> in the output build directory (<code>~/br-test-pkg/TOOLCHAIN_NAME/</code> by default).</li>
<li><code>FAILED</code>: the build failed. Inspect the <code>logfile</code> file in the output build directory to see what went wrong:
<ul>
<li>the actual build failed,</li>
<li>the legal-info failed,</li>
<li>one of the preliminary steps (downloading the config file, applying the configuration, running <code>dirclean</code> for the package) failed.</li>
</ul>
</li>
</ul>
<p>When there are failures, you can just re-run the script with the same options (after you fixed your package); the script will attempt to re-build the package specified with <code>-p</code> for all toolchains, without the need to re-build all the dependencies of that package.</p>
<p>The <code>test-pkg</code> script accepts a few options, for which you can get some help by running:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./utils/test-pkg -h</span><br></pre></td></tr></table></figure>
<h3 id="18254-how-to-add-a-package-from-github"><a class="markdownIt-Anchor" href="#18254-how-to-add-a-package-from-github"></a> 18.25.4. How to add a package from GitHub</h3>
<p>Packages on GitHub often don’t have a download area with release tarballs. However, it is possible to download tarballs directly from the repository on GitHub. As GitHub is known to have changed download mechanisms in the past, the <em>github</em> helper function should be used as shown below.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Use a tag or a full commit ID</span><br><span class="line">FOO_VERSION = 1.0</span><br><span class="line">FOO_SITE = $(call github,&lt;user&gt;,&lt;package&gt;,v$(FOO_VERSION))</span><br></pre></td></tr></table></figure>
<p><strong>Notes</strong></p>
<ul>
<li>The FOO_VERSION can either be a tag or a commit ID.</li>
<li>The tarball name generated by github matches the default one from Buildroot (e.g.: <code>foo-f6fb6654af62045239caed5950bc6c7971965e60.tar.gz</code>), so it is not necessary to specify it in the <code>.mk</code> file.</li>
<li>When using a commit ID as version, you should use the full 40 hex characters.</li>
<li>When the tag contains a prefix such as <code>v</code> in <code>v1.0</code>, then the <code>VERSION</code> variable should contain just <code>1.0</code>, and the <code>v</code> should be added directly in the <code>SITE</code> variable, as illustrated above. This ensures that the <code>VERSION</code> variable value can be used to match against <a target="_blank" rel="noopener" href="http://www.release-monitoring.org/">release-monitoring.org</a> results.</li>
</ul>
<p>If the package you wish to add does have a release section on GitHub, the maintainer may have uploaded a release tarball, or the release may just point to the automatically generated tarball from the git tag. If there is a release tarball uploaded by the maintainer, we prefer to use that since it may be slightly different (e.g. it contains a configure script so we don’t need to do AUTORECONF).</p>
<p>You can see on the release page if it’s an uploaded tarball or a git tag:</p>
<p><img src="https://chai-1301855619.cos.ap-beijing.myqcloud.com/202407161359533.png" alt="github_hash_mongrel2.png" /></p>
<ul>
<li>If it looks like the image above then it was uploaded by the maintainer and you should use that link (in that example: <em>mongrel2-v1.9.2.tar.bz2</em>) to specify <code>FOO_SITE</code>, and not use the <em>github</em> helper.</li>
<li>On the other hand, if there’s is <em><strong>*only*</strong></em> the “Source code” link, then it’s an automatically generated tarball and you should use the <em>github</em> helper function.</li>
</ul>
<h3 id="18255-how-to-add-a-package-from-gitlab"><a class="markdownIt-Anchor" href="#18255-how-to-add-a-package-from-gitlab"></a> 18.25.5. How to add a package from Gitlab</h3>
<p>In a similar way to the <code>github</code> macro described in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#github-download-url">Section 18.25.4, “How to add a package from GitHub”</a>, Buildroot also provides the <code>gitlab</code> macro to download from Gitlab repositories. It can be used to download auto-generated tarballs produced by Gitlab, either for specific tags or commits:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Use a tag or a full commit ID</span><br><span class="line">FOO_VERSION = 1.0</span><br><span class="line">FOO_SITE = $(call gitlab,&lt;user&gt;,&lt;package&gt;,v$(FOO_VERSION))</span><br></pre></td></tr></table></figure>
<p>By default, it will use a <code>.tar.gz</code> tarball, but Gitlab also provides <code>.tar.bz2</code> tarballs, so by adding a <code>&lt;pkg&gt;_SOURCE</code> variable, this <code>.tar.bz2</code> tarball can be used:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Use a tag or a full commit ID</span><br><span class="line">FOO_VERSION = 1.0</span><br><span class="line">FOO_SITE = $(call gitlab,&lt;user&gt;,&lt;package&gt;,v$(FOO_VERSION))</span><br><span class="line">FOO_SOURCE = foo-$(FOO_VERSION).tar.bz2</span><br></pre></td></tr></table></figure>
<p>If there is a specific tarball uploaded by the upstream developers in <code>https://gitlab.com/&lt;project&gt;/releases/</code>, do not use this macro, but rather use directly the link to the tarball.</p>
<h2 id="1826-conclusion"><a class="markdownIt-Anchor" href="#1826-conclusion"></a> 18.26. Conclusion</h2>
<p>As you can see, adding a software package to Buildroot is simply a matter of writing a Makefile using an existing example and modifying it according to the compilation process required by the package.</p>
<p>If you package software that might be useful for other people, don’t forget to send a patch to the Buildroot mailing list (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#submitting-patches">Section 22.5, “Submitting patches”</a>)!</p>
<h2 id="chapter-19-patching-a-package"><a class="markdownIt-Anchor" href="#chapter-19-patching-a-package"></a> Chapter 19. Patching a package</h2>
<p>While integrating a new package or updating an existing one, it may be necessary to patch the source of the software to get it cross-built within Buildroot.</p>
<p>Buildroot offers an infrastructure to automatically handle this during the builds. It supports three ways of applying patch sets: downloaded patches, patches supplied within buildroot and patches located in a user-defined global patch directory.</p>
<h2 id="191-providing-patches"><a class="markdownIt-Anchor" href="#191-providing-patches"></a> 19.1. Providing patches</h2>
<h3 id="1911-downloaded"><a class="markdownIt-Anchor" href="#1911-downloaded"></a> 19.1.1. Downloaded</h3>
<p>If it is necessary to apply a patch that is available for download, then add it to the <code>&lt;packagename&gt;_PATCH</code> variable. If an entry contains <code>://</code>, then Buildroot will assume it is a full URL and download the patch from this location. Otherwise, Buildroot will assume that the patch should be downloaded from <code>&lt;packagename&gt;_SITE</code>. It can be a single patch, or a tarball containing a patch series.</p>
<p>Like for all downloads, a hash should be added to the <code>&lt;packagename&gt;.hash</code> file.</p>
<p>This method is typically used for packages from Debian.</p>
<h3 id="1912-within-buildroot"><a class="markdownIt-Anchor" href="#1912-within-buildroot"></a> 19.1.2. Within Buildroot</h3>
<p>Most patches are provided within Buildroot, in the package directory; these typically aim to fix cross-compilation, libc support, or other such issues.</p>
<p>These patch files should be named <code>&lt;number&gt;-&lt;description&gt;.patch</code>.</p>
<p><strong>Notes</strong></p>
<ul>
<li>The patch files coming with Buildroot should not contain any package version reference in their filename.</li>
<li>The field <code>&lt;number&gt;</code> in the patch file name refers to the <em>apply order</em>, and shall start at 1; It is preferred to pad the number with zeros up to 4 digits, like <em>git-format-patch</em> does. E.g.: <code>0001-foobar-the-buz.patch</code></li>
<li>The patch email subject prefix shall not be numbered. Patches shall be generated with the <code>git format-patch -N</code> command, since this numbering is automatically added for series. For example, the patch subject line should look like <code>Subject: [PATCH] foobar the buz</code> rather than <code>Subject: [PATCH n/m] foobar the buz</code>.</li>
<li>Previously, it was mandatory for patches to be prefixed with the name of the package, like <code>&lt;package&gt;-&lt;number&gt;-&lt;description&gt;.patch</code>, but that is no longer the case. Existing packages will be fixed as time passes. <em>Do not prefix patches with the package name.</em></li>
<li>Previously, a <code>series</code> file, as used by <code>quilt</code>, could also be added in the package directory. In that case, the <code>series</code> file defines the patch application order. This is deprecated, and will be removed in the future. <em>Do not use a series file.</em></li>
</ul>
<h3 id="1913-global-patch-directory"><a class="markdownIt-Anchor" href="#1913-global-patch-directory"></a> 19.1.3. Global patch directory</h3>
<p>The <code>BR2_GLOBAL_PATCH_DIR</code> configuration file option can be used to specify a space separated list of one or more directories containing global package patches. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-patches">Section 9.8.1, “Providing extra patches”</a> for details.</p>
<h2 id="192-how-patches-are-applied"><a class="markdownIt-Anchor" href="#192-how-patches-are-applied"></a> 19.2. How patches are applied</h2>
<ol>
<li>Run the <code>&lt;packagename&gt;_PRE_PATCH_HOOKS</code> commands if defined;</li>
<li>Cleanup the build directory, removing any existing <code>*.rej</code> files;</li>
<li>If <code>&lt;packagename&gt;_PATCH</code> is defined, then patches from these tarballs are applied;</li>
<li>If there are some <code>*.patch</code> files in the package’s Buildroot directory or in a package subdirectory named <code>&lt;packageversion&gt;</code>, then:
<ul>
<li>If a <code>series</code> file exists in the package directory, then patches are applied according to the <code>series</code> file;</li>
<li>Otherwise, patch files matching <code>*.patch</code> are applied in alphabetical order. So, to ensure they are applied in the right order, it is highly recommended to name the patch files like this: <code>&lt;number&gt;-&lt;description&gt;.patch</code>, where <code>&lt;number&gt;</code> refers to the <em>apply order</em>.</li>
</ul>
</li>
<li>If <code>BR2_GLOBAL_PATCH_DIR</code> is defined, the directories will be enumerated in the order they are specified. The patches are applied as described in the previous step.</li>
<li>Run the <code>&lt;packagename&gt;_POST_PATCH_HOOKS</code> commands if defined.</li>
</ol>
<p>If something goes wrong in the steps <em>3</em> or <em>4</em>, then the build fails.</p>
<h2 id="193-format-and-licensing-of-the-package-patches"><a class="markdownIt-Anchor" href="#193-format-and-licensing-of-the-package-patches"></a> 19.3. Format and licensing of the package patches</h2>
<p>Patches are released under the same license as the software they apply to (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#legal-info-buildroot">Section 13.2, “Complying with the Buildroot license”</a>).</p>
<p>A message explaining what the patch does, and why it is needed, should be added in the header commentary of the patch.</p>
<p>You should add a <code>Signed-off-by</code> statement in the header of the each patch to help with keeping track of the changes and to certify that the patch is released under the same license as the software that is modified.</p>
<p>If the software is under version control, it is recommended to use the upstream SCM software to generate the patch set.</p>
<p>Otherwise, concatenate the header with the output of the <code>diff -purN package-version.orig/ package-version/</code> command.</p>
<p>If you update an existing patch (e.g. when bumping the package version), make sure the existing From header and Signed-off-by tags are not removed, but do update the rest of the patch comment when appropriate.</p>
<p>At the end, the patch should look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">configure.ac: add C++ support test</span><br><span class="line"></span><br><span class="line">Signed-off-by: John Doe &lt;john.doe@noname.org&gt;</span><br><span class="line"></span><br><span class="line">--- configure.ac.orig</span><br><span class="line">+++ configure.ac</span><br><span class="line">@@ -40,2 +40,12 @@</span><br><span class="line"></span><br><span class="line">AC_PROG_MAKE_SET</span><br><span class="line">+</span><br><span class="line">+AC_CACHE_CHECK([whether the C++ compiler works],</span><br><span class="line">+               [rw_cv_prog_cxx_works],</span><br><span class="line">+               [AC_LANG_PUSH([C++])</span><br><span class="line">+                AC_LINK_IFELSE([AC_LANG_PROGRAM([], [])],</span><br><span class="line">+                               [rw_cv_prog_cxx_works=yes],</span><br><span class="line">+                               [rw_cv_prog_cxx_works=no])</span><br><span class="line">+                AC_LANG_POP([C++])])</span><br><span class="line">+</span><br><span class="line">+AM_CONDITIONAL([CXX_WORKS], [test &quot;x$rw_cv_prog_cxx_works&quot; = &quot;xyes&quot;])</span><br></pre></td></tr></table></figure>
<h2 id="194-additional-patch-documentation"><a class="markdownIt-Anchor" href="#194-additional-patch-documentation"></a> 19.4. Additional patch documentation</h2>
<p>Ideally, all patches should document an upstream patch or patch submission, when applicable, via the <code>Upstream</code> trailer.</p>
<p>When backporting an upstream patch that has been accepted into mainline, it is preferred that the URL to the commit is referenced:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Upstream: &lt;URL to upstream commit&gt;</span><br></pre></td></tr></table></figure>
<p>If a new issue is identified in Buildroot and upstream is generally affected by the issue (it’s not a Buildroot specific issue), users should submit the patch upstream and provide a link to that submission when possible:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Upstream: &lt;URL to upstream mailing list submission or merge request&gt;</span><br></pre></td></tr></table></figure>
<p>Patches that have been submitted but were denied upstream should note that and include comments about why the patch is being used despite the upstream status.</p>
<p>Note: in any of the above scenarios, it is also sensible to add a few words about any changes to the patch that may have been necessary.</p>
<p>If a patch does not apply upstream then this should be noted with a comment:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Upstream: N/A &lt;additional information about why patch is Buildroot specific&gt;</span><br></pre></td></tr></table></figure>
<p>Adding this documentation helps streamline the patch review process during package version updates.</p>
<h2 id="chapter-20-download-infrastructure"><a class="markdownIt-Anchor" href="#chapter-20-download-infrastructure"></a> Chapter 20. Download infrastructure</h2>
<p>TODO</p>
<h2 id="chapter-21-debugging-buildroot"><a class="markdownIt-Anchor" href="#chapter-21-debugging-buildroot"></a> Chapter 21. Debugging Buildroot</h2>
<p>It is possible to instrument the steps <code>Buildroot</code> does when building packages. Define the variable <code>BR2_INSTRUMENTATION_SCRIPTS</code> to contain the path of one or more scripts (or other executables), in a space-separated list, you want called before and after each step. The scripts are called in sequence, with three parameters:</p>
<ul>
<li><code>start</code> or <code>end</code> to denote the start (resp. the end) of a step;</li>
<li>the name of the step about to be started, or which just ended;</li>
<li>the name of the package.</li>
</ul>
<p>For example :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make BR2_INSTRUMENTATION_SCRIPTS=&quot;/path/to/my/script1 /path/to/my/script2&quot;</span><br></pre></td></tr></table></figure>
<p>The list of steps is:</p>
<ul>
<li><code>extract</code></li>
<li><code>patch</code></li>
<li><code>configure</code></li>
<li><code>build</code></li>
<li><code>install-host</code>, when a host-package is installed in <code>$(HOST_DIR)</code></li>
<li><code>install-target</code>, when a target-package is installed in <code>$(TARGET_DIR)</code></li>
<li><code>install-staging</code>, when a target-package is installed in <code>$(STAGING_DIR)</code></li>
<li><code>install-image</code>, when a target-package installs files in <code>$(BINARIES_DIR)</code></li>
</ul>
<p>The script has access to the following variables:</p>
<ul>
<li><code>BR2_CONFIG</code>: the path to the Buildroot .config file</li>
<li><code>HOST_DIR</code>, <code>STAGING_DIR</code>, <code>TARGET_DIR</code>: see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#generic-package-reference">Section 18.6.2, “<code>generic-package</code> reference”</a></li>
<li><code>BUILD_DIR</code>: the directory where packages are extracted and built</li>
<li><code>BINARIES_DIR</code>: the place where all binary files (aka images) are stored</li>
<li><code>BASE_DIR</code>: the base output directory</li>
</ul>
<h2 id="chapter-22-contributing-to-buildroot"><a class="markdownIt-Anchor" href="#chapter-22-contributing-to-buildroot"></a> Chapter 22. Contributing to Buildroot</h2>
<p>There are many ways in which you can contribute to Buildroot: analyzing and fixing bugs, analyzing and fixing package build failures detected by the autobuilders, testing and reviewing patches sent by other developers, working on the items in our TODO list and sending your own improvements to Buildroot or its manual. The following sections give a little more detail on each of these items.</p>
<p>If you are interested in contributing to Buildroot, the first thing you should do is to subscribe to the Buildroot mailing list. This list is the main way of interacting with other Buildroot developers and to send contributions to. If you aren’t subscribed yet, then refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#community-resources">Chapter 5, <em>Community resources</em></a> for the subscription link.</p>
<p>If you are going to touch the code, it is highly recommended to use a git repository of Buildroot, rather than starting from an extracted source code tarball. Git is the easiest way to develop from and directly send your patches to the mailing list. Refer to <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#getting-buildroot">Chapter 3, <em>Getting Buildroot</em></a> for more information on obtaining a Buildroot git tree.</p>
<h2 id="221-reproducing-analyzing-and-fixing-bugs"><a class="markdownIt-Anchor" href="#221-reproducing-analyzing-and-fixing-bugs"></a> 22.1. Reproducing, analyzing and fixing bugs</h2>
<p>A first way of contributing is to have a look at the open bug reports in the <a target="_blank" rel="noopener" href="https://bugs.buildroot.org/buglist.cgi?product=buildroot">Buildroot bug tracker</a>. As we strive to keep the bug count as small as possible, all help in reproducing, analyzing and fixing reported bugs is more than welcome. Don’t hesitate to add a comment to bug reports reporting your findings, even if you don’t yet see the full picture.</p>
<h2 id="222-analyzing-and-fixing-autobuild-failures"><a class="markdownIt-Anchor" href="#222-analyzing-and-fixing-autobuild-failures"></a> 22.2. Analyzing and fixing autobuild failures</h2>
<p>The Buildroot autobuilders are a set of build machines that continuously run Buildroot builds based on random configurations. This is done for all architectures supported by Buildroot, with various toolchains, and with a random selection of packages. With the large commit activity on Buildroot, these autobuilders are a great help in detecting problems very early after commit.</p>
<p>All build results are available at <a target="_blank" rel="noopener" href="http://autobuild.buildroot.org/">http://autobuild.buildroot.org</a>, statistics are at <a target="_blank" rel="noopener" href="http://autobuild.buildroot.org/stats.php">http://autobuild.buildroot.org/stats.php</a>. Every day, an overview of all failed packages is sent to the mailing list.</p>
<p>Detecting problems is great, but obviously these problems have to be fixed as well. Your contribution is very welcome here! There are basically two things that can be done:</p>
<ul>
<li>Analyzing the problems. The daily summary mails do not contain details about the actual failures: in order to see what’s going on you have to open the build log and check the last output. Having someone doing this for all packages in the mail is very useful for other developers, as they can make a quick initial analysis based on this output alone.</li>
<li>Fixing a problem. When fixing autobuild failures, you should follow these steps:
<ol>
<li>Check if you can reproduce the problem by building with the same configuration. You can do this manually, or use the <a target="_blank" rel="noopener" href="http://git.buildroot.org/buildroot-test/tree/utils/br-reproduce-build">br-reproduce-build</a> script that will automatically clone a Buildroot git repository, checkout the correct revision, download and set the right configuration, and start the build.</li>
<li>Analyze the problem and create a fix.</li>
<li>Verify that the problem is really fixed by starting from a clean Buildroot tree and only applying your fix.</li>
<li>Send the fix to the Buildroot mailing list (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#submitting-patches">Section 22.5, “Submitting patches”</a>). In case you created a patch against the package sources, you should also send the patch upstream so that the problem will be fixed in a later release, and the patch in Buildroot can be removed. In the commit message of a patch fixing an autobuild failure, add a reference to the build result directory, as follows:</li>
</ol>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fixes: http://autobuild.buildroot.org/results/51000a9d4656afe9e0ea6f07b9f8ed374c2e4069</span><br></pre></td></tr></table></figure>
<h2 id="223-reviewing-and-testing-patches"><a class="markdownIt-Anchor" href="#223-reviewing-and-testing-patches"></a> 22.3. Reviewing and testing patches</h2>
<p>With the amount of patches sent to the mailing list each day, the maintainer has a very hard job to judge which patches are ready to apply and which ones aren’t. Contributors can greatly help here by reviewing and testing these patches.</p>
<p>In the review process, do not hesitate to respond to patch submissions for remarks, suggestions or anything that will help everyone to understand the patches and make them better. Please use internet style replies in plain text emails when responding to patch submissions.</p>
<p>To indicate approval of a patch, there are three formal tags that keep track of this approval. To add your tag to a patch, reply to it with the approval tag below the original author’s Signed-off-by line. These tags will be picked up automatically by patchwork (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#apply-patches-patchwork">Section 22.3.1, “Applying Patches from Patchwork”</a>) and will be part of the commit log when the patch is accepted.</p>
<ul>
<li>
<p>Tested-by</p>
<p>Indicates that the patch has been tested successfully. You are encouraged to specify what kind of testing you performed (compile-test on architecture X and Y, runtime test on target A, …). This additional information helps other testers and the maintainer.</p>
</li>
<li>
<p>Reviewed-by</p>
<p>Indicates that you code-reviewed the patch and did your best in spotting problems, but you are not sufficiently familiar with the area touched to provide an Acked-by tag. This means that there may be remaining problems in the patch that would be spotted by someone with more experience in that area. Should such problems be detected, your Reviewed-by tag remains appropriate and you cannot be blamed.</p>
</li>
<li>
<p>Acked-by</p>
<p>Indicates that you code-reviewed the patch and you are familiar enough with the area touched to feel that the patch can be committed as-is (no additional changes required). In case it later turns out that something is wrong with the patch, your Acked-by could be considered inappropriate. The difference between Acked-by and Reviewed-by is thus mainly that you are prepared to take the blame on Acked patches, but not on Reviewed ones.</p>
</li>
</ul>
<p>If you reviewed a patch and have comments on it, you should simply reply to the patch stating these comments, without providing a Reviewed-by or Acked-by tag. These tags should only be provided if you judge the patch to be good as it is.</p>
<p>It is important to note that neither Reviewed-by nor Acked-by imply that testing has been performed. To indicate that you both reviewed and tested the patch, provide two separate tags (Reviewed/Acked-by and Tested-by).</p>
<p>Note also that <em>any developer</em> can provide Tested/Reviewed/Acked-by tags, without exception, and we encourage everyone to do this. Buildroot does not have a defined group of <em>core</em> developers, it just so happens that some developers are more active than others. The maintainer will value tags according to the track record of their submitter. Tags provided by a regular contributor will naturally be trusted more than tags provided by a newcomer. As you provide tags more regularly, your <em>trustworthiness</em> (in the eyes of the maintainer) will go up, but <em>any</em> tag provided is valuable.</p>
<p>Buildroot’s Patchwork website can be used to pull in patches for testing purposes. Please see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#apply-patches-patchwork">Section 22.3.1, “Applying Patches from Patchwork”</a> for more information on using Buildroot’s Patchwork website to apply patches.</p>
<h3 id="2231-applying-patches-from-patchwork"><a class="markdownIt-Anchor" href="#2231-applying-patches-from-patchwork"></a> 22.3.1. Applying Patches from Patchwork</h3>
<p>The main use of Buildroot’s Patchwork website for a developer is for pulling in patches into their local git repository for testing purposes.</p>
<p>When browsing patches in the patchwork management interface, an <code>mbox</code> link is provided at the top of the page. Copy this link address and run the following commands:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b &lt;test-branch-name&gt;</span><br><span class="line">$ wget -O - &lt;mbox-url&gt; | git am</span><br></pre></td></tr></table></figure>
<p>Another option for applying patches is to create a bundle. A bundle is a set of patches that you can group together using the patchwork interface. Once the bundle is created and the bundle is made public, you can copy the <code>mbox</code> link for the bundle and apply the bundle using the above commands.</p>
<h2 id="224-work-on-items-from-the-todo-list"><a class="markdownIt-Anchor" href="#224-work-on-items-from-the-todo-list"></a> 22.4. Work on items from the TODO list</h2>
<p>If you want to contribute to Buildroot but don’t know where to start, and you don’t like any of the above topics, you can always work on items from the <a target="_blank" rel="noopener" href="http://elinux.org/Buildroot#Todo_list">Buildroot TODO list</a>. Don’t hesitate to discuss an item first on the mailing list or on IRC. Do edit the wiki to indicate when you start working on an item, so we avoid duplicate efforts.</p>
<h2 id="225-submitting-patches"><a class="markdownIt-Anchor" href="#225-submitting-patches"></a> 22.5. Submitting patches</h2>
<h3 id="note"><a class="markdownIt-Anchor" href="#note"></a> Note</h3>
<p><em>Please, do not attach patches to bugs, send them to the mailing list instead</em>.</p>
<p>If you made some changes to Buildroot and you would like to contribute them to the Buildroot project, proceed as follows.</p>
<h3 id="2251-the-formatting-of-a-patch"><a class="markdownIt-Anchor" href="#2251-the-formatting-of-a-patch"></a> 22.5.1. The formatting of a patch</h3>
<p>We expect patches to be formatted in a specific way. This is necessary to make it easy to review patches, to be able to apply them easily to the git repository, to make it easy to find back in the history how and why things have changed, and to make it possible to use <code>git bisect</code> to locate the origin of a problem.</p>
<p>First of all, it is essential that the patch has a good commit message. The commit message should start with a separate line with a brief summary of the change, prefixed by the area touched by the patch. A few examples of good commit titles:</p>
<ul>
<li><code>package/linuxptp: bump version to 2.0</code></li>
<li><code>configs/imx23evk: bump Linux version to 4.19</code></li>
<li><code>package/pkg-generic: postpone evaluation of dependency conditions</code></li>
<li><code>boot/uboot: needs host-&#123;flex,bison&#125;</code></li>
<li><code>support/testing: add python-ubjson tests</code></li>
</ul>
<p>The description that follows the prefix should start with a lower case letter (i.e “bump”, “needs”, “postpone”, “add” in the above examples).</p>
<p>Second, the body of the commit message should describe <em>why</em> this change is needed, and if necessary also give details about <em>how</em> it was done. When writing the commit message, think of how the reviewers will read it, but also think about how you will read it when you look at this change again a few years down the line.</p>
<p>Third, the patch itself should do only one change, but do it completely. Two unrelated or weakly related changes should usually be done in two separate patches. This usually means that a patch affects only a single package. If several changes are related, it is often still possible to split them up in small patches and apply them in a specific order. Small patches make it easier to review, and often make it easier to understand afterwards why a change was done. However, each patch must be complete. It is not allowed that the build is broken when only the first but not the second patch is applied. This is necessary to be able to use <code>git bisect</code> afterwards.</p>
<p>Of course, while you’re doing your development, you’re probably going back and forth between packages, and certainly not committing things immediately in a way that is clean enough for submission. So most developers rewrite the history of commits to produce a clean set of commits that is appropriate for submission. To do this, you need to use <em>interactive rebasing</em>. You can learn about it <a target="_blank" rel="noopener" href="https://git-scm.com/book/en/v2/Git-Tools-Rewriting-History">in the Pro Git book</a>. Sometimes, it is even easier to discard you history with <code>git reset --soft origin/master</code> and select individual changes with <code>git add -i</code> or <code>git add -p</code>.</p>
<p>Finally, the patch should be signed off. This is done by adding <code>Signed-off-by: Your Real Name &lt;your@email.address&gt;</code> at the end of the commit message. <code>git commit -s</code> does that for you, if configured properly. The <code>Signed-off-by</code> tag means that you publish the patch under the Buildroot license (i.e. GPL-2.0+, except for package patches, which have the upstream license), and that you are allowed to do so. See <a target="_blank" rel="noopener" href="http://developercertificate.org/">the Developer Certificate of Origin</a> for details.</p>
<p>To give credits to who sponsored the creation of a patch or the process of upstreaming it, you may use <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc5233">email subaddressing</a> for your git identity (i.e. what is used as commit author and email <code>From:</code> field, as well as your Signed-off-by tag); add suffix to the local part, separated from it by a plus <code>+</code> sign. E.g.:</p>
<ul>
<li>
<p>for a company which sponsored the submitted work, use the company name as the detail (suffix) part:</p>
<p><code>Your-Name Your-Surname &lt;your-name.your-surname+companyname@mail.com&gt;</code></p>
</li>
<li>
<p>for an individual who sponsored the submitted work, use their name and surname:</p>
<p><code>Your-Name Your-Surname &lt;your-name.your-surname+their-name.their-surname@mail.com&gt;</code></p>
</li>
</ul>
<p>When adding new packages, you should submit every package in a separate patch. This patch should have the update to <code>package/Config.in</code>, the package <code>Config.in</code> file, the <code>.mk</code> file, the <code>.hash</code> file, any init script, and all package patches. If the package has many sub-options, these are sometimes better added as separate follow-up patches. The summary line should be something like <code>&lt;packagename&gt;: new package</code>. The body of the commit message can be empty for simple packages, or it can contain the description of the package (like the <a target="_blank" rel="noopener" href="http://Config.in">Config.in</a> help text). If anything special has to be done to build the package, this should also be explained explicitly in the commit message body.</p>
<p>When you bump a package to a new version, you should also submit a separate patch for each package. Don’t forget to update the <code>.hash</code> file, or add it if it doesn’t exist yet. Also don’t forget to check if the <code>_LICENSE</code> and <code>_LICENSE_FILES</code> are still valid. The summary line should be something like <code>&lt;packagename&gt;: bump to version &lt;new version&gt;</code>. If the new version only contains security updates compared to the existing one, the summary should be <code>&lt;packagename&gt;: security bump to version &lt;new version&gt;</code> and the commit message body should show the CVE numbers that are fixed. If some package patches can be removed in the new version, it should be explained explicitly why they can be removed, preferably with the upstream commit ID. Also any other required changes should be explained explicitly, like configure options that no longer exist or are no longer needed.</p>
<p>If you are interested in getting notified of build failures and of further changes in the packages you added or modified, please add yourself to the DEVELOPERS file. This should be done in the same patch creating or modifying the package. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#DEVELOPERS">the DEVELOPERS file</a> for more information.</p>
<p>Buildroot provides a handy tool to check for common coding style mistakes on files you created or modified, called <code>check-package</code> (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#check-package">Section 18.25.2, “How to check the coding style”</a> for more information).</p>
<h3 id="2252-preparing-a-patch-series"><a class="markdownIt-Anchor" href="#2252-preparing-a-patch-series"></a> 22.5.2. Preparing a patch series</h3>
<p>Starting from the changes committed in your local git view, <em>rebase</em> your development branch on top of the upstream tree before generating a patch set. To do so, run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git fetch --all --tags</span><br><span class="line">$ git rebase origin/master</span><br></pre></td></tr></table></figure>
<p>Now check the coding style for the changes you committed:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ utils/docker-run make check-package</span><br></pre></td></tr></table></figure>
<p>Now, you are ready to generate then submit your patch set.</p>
<p>To generate it, run:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git format-patch -M -n -s -o outgoing origin/master</span><br></pre></td></tr></table></figure>
<p>This will generate patch files in the <code>outgoing</code> subdirectory, automatically adding the <code>Signed-off-by</code> line.</p>
<p>Once patch files are generated, you can review/edit the commit message before submitting them, using your favorite text editor.</p>
<p>Buildroot provides a handy tool to know to whom your patches should be sent, called <code>get-developers</code> (see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#DEVELOPERS">Chapter 23, <em>DEVELOPERS file and get-developers</em></a> for more information). This tool reads your patches and outputs the appropriate <code>git send-email</code> command to use:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./utils/get-developers outgoing/*</span><br></pre></td></tr></table></figure>
<p>Use the output of <code>get-developers</code> to send your patches:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git send-email --to buildroot@buildroot.org --cc bob --cc alice outgoing/*</span><br></pre></td></tr></table></figure>
<p>Alternatively, <code>get-developers -e</code> can be used directly with the <code>--cc-cmd</code> argument to <code>git send-email</code> to automatically CC the affected developers:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git send-email --to buildroot@buildroot.org \</span><br><span class="line">      --cc-cmd &#x27;./utils/get-developers -e&#x27; origin/master</span><br></pre></td></tr></table></figure>
<p><code>git</code> can be configured to automatically do this out of the box with:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git config sendemail.to buildroot@buildroot.org</span><br><span class="line">$ git config sendemail.ccCmd &quot;$(pwd)/utils/get-developers -e&quot;</span><br></pre></td></tr></table></figure>
<p>And then just do:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git send-email origin/master</span><br></pre></td></tr></table></figure>
<p>Note that <code>git</code> should be configured to use your mail account. To configure <code>git</code>, see <code>man git-send-email</code> or <a target="_blank" rel="noopener" href="https://git-send-email.io/">https://git-send-email.io/</a>.</p>
<p>If you do not use <code>git send-email</code>, make sure posted <em><strong>*patches are not line-wrapped*</strong></em>, otherwise they cannot easily be applied. In such a case, fix your e-mail client, or better yet, learn to use <code>git send-email</code>.</p>
<p><a target="_blank" rel="noopener" href="https://sr.ht/">https://sr.ht</a> also has a light-weight UI for <a target="_blank" rel="noopener" href="https://man.sr.ht/git.sr.ht/#sending-patches-upstream">preparing patchseries</a> and can also send out the patches for you. There are a few drawbacks to this, as you cannot edit your patches’ status in Patchwork and you currently can’t edit your display name with which the match emails are sent out but it is an option if you cannot get git send-email to work with your mail provider (i.e. O365); it shall not be considered the official way of sending patches, but just a fallback.</p>
<h3 id="2253-cover-letter"><a class="markdownIt-Anchor" href="#2253-cover-letter"></a> 22.5.3. Cover letter</h3>
<p>If you want to present the whole patch set in a separate mail, add <code>--cover-letter</code> to the <code>git format-patch</code> command (see <code>man git-format-patch</code> for further information). This will generate a template for an introduction e-mail to your patch series.</p>
<p>A <em>cover letter</em> may be useful to introduce the changes you propose in the following cases:</p>
<ul>
<li>large number of commits in the series;</li>
<li>deep impact of the changes in the rest of the project;</li>
<li>RFC [<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#ftn.idm6034">4]</a>;</li>
<li>whenever you feel it will help presenting your work, your choices, the review process, etc.</li>
</ul>
<h3 id="2254-patches-for-maintenance-branches"><a class="markdownIt-Anchor" href="#2254-patches-for-maintenance-branches"></a> 22.5.4. Patches for maintenance branches</h3>
<p>When fixing bugs on a maintenance branch, bugs should be fixed on the master branch first. The commit log for such a patch may then contain a post-commit note specifying what branches are affected:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package/foo: fix stuff</span><br><span class="line"></span><br><span class="line">Signed-off-by: Your Real Name &lt;your@email.address&gt;</span><br><span class="line">---</span><br><span class="line">Backport to: 2020.02.x, 2020.05.x</span><br><span class="line">(2020.08.x not affected as the version was bumped)</span><br></pre></td></tr></table></figure>
<p>Those changes will then be backported by a maintainer to the affected branches.</p>
<p>However, some bugs may apply only to a specific release, for example because it is using an older version of a package. In that case, patches should be based off the maintenance branch, and the patch subject prefix must include the maintenance branch name (for example “[PATCH 2020.02.x]”). This can be done with the <code>git format-patch</code> flag <code>--subject-prefix</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git format-patch --subject-prefix &quot;PATCH 2020.02.x&quot; \</span><br><span class="line">    -M -s -o outgoing origin/2020.02.x</span><br></pre></td></tr></table></figure>
<p>Then send the patches with <code>git send-email</code>, as described above.</p>
<h3 id="2255-patch-revision-changelog"><a class="markdownIt-Anchor" href="#2255-patch-revision-changelog"></a> 22.5.5. Patch revision changelog</h3>
<p>When improvements are requested, the new revision of each commit should include a changelog of the modifications between each submission. Note that when your patch series is introduced by a cover letter, an overall changelog may be added to the cover letter in addition to the changelog in the individual commits. The best thing to rework a patch series is by interactive rebasing: <code>git rebase -i origin/master</code>. Consult the git manual for more information.</p>
<p>When added to the individual commits, this changelog is added when editing the commit message. Below the <code>Signed-off-by</code> section, add <code>---</code> and your changelog.</p>
<p>Although the changelog will be visible for the reviewers in the mail thread, as well as in <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/buildroot/list/">patchwork</a>, <code>git</code> will automatically ignores lines below <code>---</code> when the patch will be merged. This is the intended behavior: the changelog is not meant to be preserved forever in the <code>git</code> history of the project.</p>
<p>Hereafter the recommended layout:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Patch title: short explanation, max 72 chars</span><br><span class="line"></span><br><span class="line">A paragraph that explains the problem, and how it manifests itself. If</span><br><span class="line">the problem is complex, it is OK to add more paragraphs. All paragraphs</span><br><span class="line">should be wrapped at 72 characters.</span><br><span class="line"></span><br><span class="line">A paragraph that explains the root cause of the problem. Again, more</span><br><span class="line">than one paragraph is OK.</span><br><span class="line"></span><br><span class="line">Finally, one or more paragraphs that explain how the problem is solved.</span><br><span class="line">Don&#x27;t hesitate to explain complex solutions in detail.</span><br><span class="line"></span><br><span class="line">Signed-off-by: John DOE &lt;john.doe@example.net&gt;</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">Changes v2 -&gt; v3:</span><br><span class="line">  - foo bar  (suggested by Jane)</span><br><span class="line">  - bar buz</span><br><span class="line"></span><br><span class="line">Changes v1 -&gt; v2:</span><br><span class="line">  - alpha bravo  (suggested by John)</span><br><span class="line">  - charly delta</span><br></pre></td></tr></table></figure>
<p>Any patch revision should include the version number. The version number is simply composed of the letter <code>v</code> followed by an <code>integer</code> greater or equal to two (i.e. “PATCH v2”, “PATCH v3” …).</p>
<p>This can be easily handled with <code>git format-patch</code> by using the option <code>--subject-prefix</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git format-patch --subject-prefix &quot;PATCH v4&quot; \</span><br><span class="line">    -M -s -o outgoing origin/master</span><br></pre></td></tr></table></figure>
<p>Since git version 1.8.1, you can also use <code>-v &lt;n&gt;</code> (where <n> is the version number):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git format-patch -v4 -M -s -o outgoing origin/master</span><br></pre></td></tr></table></figure>
<p>When you provide a new version of a patch, please mark the old one as superseded in <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/buildroot/list/">patchwork</a>. You need to create an account on <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/buildroot/list/">patchwork</a> to be able to modify the status of your patches. Note that you can only change the status of patches you submitted yourself, which means the email address you register in <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/buildroot/list/">patchwork</a> should match the one you use for sending patches to the mailing list.</p>
<p>You can also add the <code>--in-reply-to &lt;message-id&gt;</code> option when submitting a patch to the mailing list. The id of the mail to reply to can be found under the “Message Id” tag on <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/buildroot/list/">patchwork</a>. The advantage of <em><strong>*in-reply-to*</strong></em> is that patchwork will automatically mark the previous version of the patch as superseded.</p>
<h2 id="226-reporting-issuesbugs-or-getting-help"><a class="markdownIt-Anchor" href="#226-reporting-issuesbugs-or-getting-help"></a> 22.6. Reporting issues/bugs or getting help</h2>
<p>Before reporting any issue, please check in <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#community-resources">the mailing list archive</a> whether someone has already reported and/or fixed a similar problem.</p>
<p>However you choose to report bugs or get help, either by opening a bug in the <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#community-resources">bug tracker</a> or by <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#community-resources">sending a mail to the mailing list</a>, there are a number of details to provide in order to help people reproduce and find a solution to the issue.</p>
<p>Try to think as if you were trying to help someone else; in that case, what would you need?</p>
<p>Here is a short list of details to provide in such case:</p>
<ul>
<li>host machine (OS/release)</li>
<li>version of Buildroot</li>
<li>target for which the build fails</li>
<li>package(s) for which the build fails</li>
<li>the command that fails and its output</li>
<li>any information you think that may be relevant</li>
</ul>
<p>Additionally, you should add the <code>.config</code> file (or if you know how, a <code>defconfig</code>; see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#customize-store-buildroot-config">Section 9.3, “Storing the Buildroot configuration”</a>).</p>
<p>If some of these details are too large, do not hesitate to use a pastebin service. Note that not all available pastebin services will preserve Unix-style line terminators when downloading raw pastes. Following pastebin services are known to work correctly: - <a target="_blank" rel="noopener" href="https://gist.github.com/">https://gist.github.com/</a> - <a target="_blank" rel="noopener" href="http://code.bulix.org/">http://code.bulix.org/</a></p>
<h2 id="227-using-the-runtime-tests-framework"><a class="markdownIt-Anchor" href="#227-using-the-runtime-tests-framework"></a> 22.7. Using the runtime tests framework</h2>
<p>Buildroot includes a run-time testing framework built upon Python scripting and QEMU runtime execution. The goals of the framework are the following:</p>
<ul>
<li>build a well defined Buildroot configuration</li>
<li>optionally, verify some properties of the build output</li>
<li>optionally, boot the build results under Qemu, and verify that a given feature is working as expected</li>
</ul>
<p>The entry point to use the runtime tests framework is the <code>support/testing/run-tests</code> tool, which has a series of options documented in the tool’s help <em>-h</em> description. Some common options include setting the download folder, the output folder, keeping build output, and for multiple test cases, you can set the JLEVEL for each.</p>
<p>Here is an example walk through of running a test case.</p>
<ul>
<li>For a first step, let us see what all the test case options are. The test cases can be listed by executing <code>support/testing/run-tests -l</code>. These tests can all be run individually during test development from the console. Both one at a time and selectively as a group of a subset of tests.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ support/testing/run-tests -l</span><br><span class="line">List of tests</span><br><span class="line">test_run (tests.utils.test_check_package.TestCheckPackage)</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainBuildrootMusl) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainBuildrootuClibc) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainCCache) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainCtngMusl) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainLinaroArm) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainSourceryArmv4) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainSourceryArmv5) ... ok</span><br><span class="line">test_run (tests.toolchain.test_external.TestExternalToolchainSourceryArmv7) ... ok</span><br><span class="line">[snip]</span><br><span class="line">test_run (tests.init.test_systemd.TestInitSystemSystemdRoFull) ... ok</span><br><span class="line">test_run (tests.init.test_systemd.TestInitSystemSystemdRoIfupdown) ... ok</span><br><span class="line">test_run (tests.init.test_systemd.TestInitSystemSystemdRoNetworkd) ... ok</span><br><span class="line">test_run (tests.init.test_systemd.TestInitSystemSystemdRwFull) ... ok</span><br><span class="line">test_run (tests.init.test_systemd.TestInitSystemSystemdRwIfupdown) ... ok</span><br><span class="line">test_run (tests.init.test_systemd.TestInitSystemSystemdRwNetworkd) ... ok</span><br><span class="line">test_run (tests.init.test_busybox.TestInitSystemBusyboxRo) ... ok</span><br><span class="line">test_run (tests.init.test_busybox.TestInitSystemBusyboxRoNet) ... ok</span><br><span class="line">test_run (tests.init.test_busybox.TestInitSystemBusyboxRw) ... ok</span><br><span class="line">test_run (tests.init.test_busybox.TestInitSystemBusyboxRwNet) ... ok</span><br><span class="line"></span><br><span class="line">Ran 157 tests in 0.021s</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<ul>
<li>Then, to run one test case:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ support/testing/run-tests -d dl -o output_folder -k tests.init.test_busybox.TestInitSystemBusyboxRw</span><br><span class="line">15:03:26 TestInitSystemBusyboxRw                  Starting</span><br><span class="line">15:03:28 TestInitSystemBusyboxRw                  Building</span><br><span class="line">15:08:18 TestInitSystemBusyboxRw                  Building done</span><br><span class="line">15:08:27 TestInitSystemBusyboxRw                  Cleaning up</span><br><span class="line">.</span><br><span class="line">Ran 1 test in 301.140s</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>The standard output indicates if the test is successful or not. By default, the output folder for the test is deleted automatically unless the option <code>-k</code> is passed to <em><strong>*keep*</strong></em> the output directory.</p>
<h3 id="2271-creating-a-test-case"><a class="markdownIt-Anchor" href="#2271-creating-a-test-case"></a> 22.7.1. Creating a test case</h3>
<p>Within the Buildroot repository, the testing framework is organized at the top level in <code>support/testing/</code> by folders of <code>conf</code>, <code>infra</code> and <code>tests</code>. All the test cases live under the <code>tests</code> folder and are organized in various folders representing the category of test.</p>
<p>The best way to get familiar with how to create a test case is to look at a few of the basic file system <code>support/testing/tests/fs/</code> and init <code>support/testing/tests/init/</code> test scripts. Those tests give good examples of a basic tests that include both checking the build results, and doing runtime tests. There are other more advanced cases that use things like nested <code>br2-external</code> folders to provide skeletons and additional packages.</p>
<p>Creating a basic test case involves:</p>
<ul>
<li>Defining a test class that inherits from <code>infra.basetest.BRTest</code></li>
<li>Defining the <code>config</code> member of the test class, to the Buildroot configuration to build for this test case. It can optionally rely on configuration snippets provided by the runtime test infrastructure: <code>infra.basetest.BASIC_TOOLCHAIN_CONFIG</code> to get a basic architecture/toolchain configuration, and <code>infra.basetest.MINIMAL_CONFIG</code> to not build any filesystem. The advantage of using <code>infra.basetest.BASIC_TOOLCHAIN_CONFIG</code> is that a matching Linux kernel image is provided, which allows to boot the resulting image in Qemu without having to build a Linux kernel image as part of the test case, therefore significant decreasing the build time required for the test case.</li>
<li>Implementing a <code>def test_run(self):</code> function to implement the actual tests to run after the build has completed. They may be tests that verify the build output, by running command on the host using the <code>run_cmd_on_host()</code> helper function. Or they may boot the generated system in Qemu using the <code>Emulator</code> object available as <code>self.emulator</code> in the test case. For example <code>self.emulator.boot()</code> allows to boot the system in Qemu, <code>self.emulator.login()</code> allows to login, <code>self.emulator.run()</code> allows to run shell commands inside Qemu.</li>
</ul>
<p>After creating the test script, add yourself to the <code>DEVELOPERS</code> file to be the maintainer of that test case.</p>
<h3 id="2272-debugging-a-test-case"><a class="markdownIt-Anchor" href="#2272-debugging-a-test-case"></a> 22.7.2. Debugging a test case</h3>
<p>When a test case runs, the <code>output_folder</code> will contain the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls output_folder/</span><br><span class="line">TestInitSystemBusyboxRw/</span><br><span class="line">TestInitSystemBusyboxRw-build.log</span><br><span class="line">TestInitSystemBusyboxRw-run.log</span><br></pre></td></tr></table></figure>
<p><code>TestInitSystemBusyboxRw/</code> is the Buildroot output directory, and it is preserved only if the <code>-k</code> option is passed.</p>
<p><code>TestInitSystemBusyboxRw-build.log</code> is the log of the Buildroot build.</p>
<p><code>TestInitSystemBusyboxRw-run.log</code> is the log of the Qemu boot and test. This file will only exist if the build was successful and the test case involves booting under Qemu.</p>
<p>If you want to manually run Qemu to do manual tests of the build result, the first few lines of <code>TestInitSystemBusyboxRw-run.log</code> contain the Qemu command line to use.</p>
<p>You can also make modifications to the current sources inside the <code>output_folder</code> (e.g. for debug purposes) and rerun the standard Buildroot make targets (in order to regenerate the complete image with the new modifications) and then rerun the test.</p>
<h3 id="2273-runtime-tests-and-gitlab-ci"><a class="markdownIt-Anchor" href="#2273-runtime-tests-and-gitlab-ci"></a> 22.7.3. Runtime tests and Gitlab CI</h3>
<p>All runtime tests are regularly executed by Buildroot Gitlab CI infrastructure, see .gitlab.yml and <a target="_blank" rel="noopener" href="https://gitlab.com/buildroot.org/buildroot/-/jobs">https://gitlab.com/buildroot.org/buildroot/-/jobs</a>.</p>
<p>You can also use Gitlab CI to test your new test cases, or verify that existing tests continue to work after making changes in Buildroot.</p>
<p>In order to achieve this, you need to create a fork of the Buildroot project on Gitlab, and be able to push branches to your Buildroot fork on Gitlab.</p>
<p>The name of the branch that you push will determine if a Gitlab CI pipeline will be triggered or not, and for which test cases.</p>
<p>In the examples below, the <name> component of the branch name is an arbitrary string you choose.</p>
<ul>
<li>To trigger all run-test test case jobs, push a branch that ends with <code>-runtime-tests</code>:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push gitlab HEAD:&lt;name&gt;-runtime-tests</span><br></pre></td></tr></table></figure>
<ul>
<li>To trigger one or several test case jobs, push a branch that ends with the complete test case name (<code>tests.init.test_busybox.TestInitSystemBusyboxRo</code>) or with the name of a category of tests (<code>tests.init.test_busybox</code>):</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push gitlab HEAD:&lt;name&gt;-&lt;test case name&gt;</span><br></pre></td></tr></table></figure>
<p>Example to run one test:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push gitlab HEAD:foo-tests.init.test_busybox.TestInitSystemBusyboxRo</span><br></pre></td></tr></table></figure>
<p>Examples to run several tests part of the same group:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git push gitlab HEAD:foo-tests.init.test_busybox</span><br><span class="line">$ git push gitlab HEAD:foo-tests.init</span><br></pre></td></tr></table></figure>
<hr />
<p>[<a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#idm6034">4] </a>RFC: (Request for comments) change proposal</p>
<h2 id="chapter-23-developers-file-and-get-developers"><a class="markdownIt-Anchor" href="#chapter-23-developers-file-and-get-developers"></a> Chapter 23. DEVELOPERS file and get-developers</h2>
<p>The main Buildroot directory contains a file named <code>DEVELOPERS</code> that lists the developers involved with various areas of Buildroot. Thanks to this file, the <code>get-developers</code> tool allows to:</p>
<ul>
<li>Calculate the list of developers to whom patches should be sent, by parsing the patches and matching the modified files with the relevant developers. See <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#submitting-patches">Section 22.5, “Submitting patches”</a> for details.</li>
<li>Find which developers are taking care of a given architecture or package, so that they can be notified when a build failure occurs on this architecture or package. This is done in interaction with Buildroot’s autobuild infrastructure.</li>
</ul>
<p>We ask developers adding new packages, new boards, or generally new functionality in Buildroot, to register themselves in the <code>DEVELOPERS</code> file. As an example, we expect a developer contributing a new package to include in his patch the appropriate modification to the <code>DEVELOPERS</code> file.</p>
<p>The <code>DEVELOPERS</code> file format is documented in detail inside the file itself.</p>
<p>The <code>get-developers</code> tool, located in <code>utils/</code> allows to use the <code>DEVELOPERS</code> file for various tasks:</p>
<ul>
<li>When passing one or several patches as command line argument, <code>get-developers</code> will return the appropriate <code>git send-email</code> command. If the <code>-e</code> option is passed, only the email addresses are printed in a format suitable for <code>git send-email --cc-cmd</code>.</li>
<li>When using the <code>-a &lt;arch&gt;</code> command line option, <code>get-developers</code> will return the list of developers in charge of the given architecture.</li>
<li>When using the <code>-p &lt;package&gt;</code> command line option, <code>get-developers</code> will return the list of developers in charge of the given package.</li>
<li>When using the <code>-c</code> command line option, <code>get-developers</code> will look at all files under version control in the Buildroot repository, and list the ones that are not handled by any developer. The purpose of this option is to help completing the <code>DEVELOPERS</code> file.</li>
<li>When using the <code>-v</code> command line option, it validates the integrity of the DEVELOPERS file and will note WARNINGS for items that don’t match.</li>
</ul>
<h2 id="chapter-24-release-engineering"><a class="markdownIt-Anchor" href="#chapter-24-release-engineering"></a> Chapter 24. Release Engineering</h2>
<h2 id="241-releases"><a class="markdownIt-Anchor" href="#241-releases"></a> 24.1. Releases</h2>
<p>The Buildroot project makes quarterly releases with monthly bugfix releases. The first release of each year is a long term support release, LTS.</p>
<ul>
<li>Quarterly releases: 2020.02, 2020.05, 2020.08, and 2020.11</li>
<li>Bugfix releases: 2020.02.1, 2020.02.2, …</li>
<li>LTS releases: 2020.02, 2021.02, …</li>
</ul>
<p>Releases are supported until the first bugfix release of the next release, e.g., 2020.05.x is EOL when 2020.08.1 is released.</p>
<p>LTS releases are supported until the first bugfix release of the next LTS, e.g., 2020.02.x is supported until 2021.02.1 is released.</p>
<h2 id="242-development"><a class="markdownIt-Anchor" href="#242-development"></a> 24.2. Development</h2>
<p>Each release cycle consist of two months of development on the <code>master</code> branch and one month stabilization before the release is made. During this phase no new features are added to <code>master</code>, only bugfixes.</p>
<p>The stabilization phase starts with tagging <code>-rc1</code>, and every week until the release, another release candidate is tagged.</p>
<p>To handle new features and version bumps during the stabilization phase, a <code>next</code> branch may be created for these features. Once the current release has been made, the <code>next</code> branch is merged into <code>master</code> and the development cycle for the next release continues there.</p>
<h1 id="part-iv-appendix"><a class="markdownIt-Anchor" href="#part-iv-appendix"></a> Part IV. Appendix</h1>
<h2 id="chapter-25-makedev-syntax-documentation"><a class="markdownIt-Anchor" href="#chapter-25-makedev-syntax-documentation"></a> Chapter 25. Makedev syntax documentation</h2>
<p>The makedev syntax is used in several places in Buildroot to define changes to be made for permissions, or which device files to create and how to create them, in order to avoid calls to mknod.</p>
<p>This syntax is derived from the makedev utility, and more complete documentation can be found in the <code>package/makedevs/README</code> file.</p>
<p>It takes the form of a space separated list of fields, one file per line; the fields are:</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>mode</th>
<th>uid</th>
<th>gid</th>
<th>major</th>
<th>minor</th>
<th>start</th>
<th>inc</th>
<th>count</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>There are a few non-trivial blocks:</p>
<ul>
<li><code>name</code> is the path to the file you want to create/modify</li>
<li><code>type</code> is the type of the file, being one of:
<ul>
<li><code>f</code>: a regular file, which must already exist</li>
<li><code>F</code>: a regular file, which is ignored and not created if missing</li>
<li><code>d</code>: a directory, which is created, as well as its parents, if missing</li>
<li><code>r</code>: a directory recursively, which must already exist</li>
<li><code>c</code>: a character device file, which parent directory must exist</li>
<li><code>b</code>: a block device file, which parent directory must exist</li>
<li><code>p</code>: a named pipe, which parent directory must exist</li>
</ul>
</li>
<li><code>mode</code> are the usual permissions settings (only numerical values are allowed); for type <code>d</code>, the mode of existing parents is not changed, but the mode of created parents is set; for types <code>f</code>, <code>F</code>, and <code>r</code>, <code>mode</code> can also be set to <code>-1</code> to not change the mode (and only change uid and gid)</li>
<li><code>uid</code> and <code>gid</code> are the UID and GID to set on this file; can be either numerical values or actual names</li>
<li><code>major</code> and <code>minor</code> are here for device files, set to <code>-</code> for other files</li>
<li><code>start</code>, <code>inc</code> and <code>count</code> are for when you want to create a batch of files, and can be reduced to a loop, beginning at <code>start</code>, incrementing its counter by <code>inc</code> until it reaches <code>count</code></li>
</ul>
<p>Let’s say you want to change the ownership and permissions of a given file; using this syntax, you will need to write:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/foo f 755 0 0 - - - - -</span><br><span class="line">/usr/bin/bar f 755 root root - - - - -</span><br><span class="line">/data/buz f 644 buz-user buz-group - - - - -</span><br><span class="line">/data/baz f -1 baz-user baz-group - - - - -</span><br></pre></td></tr></table></figure>
<p>Alternatively, if you want to change owner of a directory recursively, you can write (to set UID to <code>foo</code> and GID to <code>bar</code> for the directory <code>/usr/share/myapp</code> and all files and directories below it):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/myapp r -1 foo bar - - - - -</span><br></pre></td></tr></table></figure>
<p>On the other hand, if you want to create the device file <code>/dev/hda</code> and the corresponding 15 files for the partitions, you will need for <code>/dev/hda</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/hda b 640 root root 3 0 0 0 -</span><br></pre></td></tr></table></figure>
<p>and then for device files corresponding to the partitions of <code>/dev/hda</code>, <code>/dev/hdaX</code>, <code>X</code> ranging from 1 to 15:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/hda b 640 root root 3 1 1 1 15</span><br></pre></td></tr></table></figure>
<p>Extended attributes are supported if <code>BR2_ROOTFS_DEVICE_TABLE_SUPPORTS_EXTENDED_ATTRIBUTES</code> is enabled. This is done by adding a line starting with <code>|xattr</code> after the line describing the file. Right now, only capability is supported as extended attribute.</p>
<table>
<thead>
<tr>
<th>|xattr</th>
<th>capability</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>|xattr</code> is a “flag” that indicate an extended attribute</li>
<li><code>capability</code> is a capability to add to the previous file</li>
</ul>
<p>If you want to add the capability cap_sys_admin to the binary foo, you will write :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/foo f 755 root root - - - - -</span><br><span class="line">|xattr cap_sys_admin+eip</span><br></pre></td></tr></table></figure>
<p>You can add several capabilities to a file by using several <code>|xattr</code> lines. If you want to add the capability cap_sys_admin and cap_net_admin to the binary foo, you will write :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/foo f 755 root root - - - - -</span><br><span class="line">|xattr cap_sys_admin+eip</span><br><span class="line">|xattr cap_net_admin+eip</span><br></pre></td></tr></table></figure>
<h2 id="chapter-26-makeusers-syntax-documentation"><a class="markdownIt-Anchor" href="#chapter-26-makeusers-syntax-documentation"></a> Chapter 26. Makeusers syntax documentation</h2>
<p>The syntax to create users is inspired by the makedev syntax, above, but is specific to Buildroot.</p>
<p>The syntax for adding a user is a space-separated list of fields, one user per line; the fields are:</p>
<table>
<thead>
<tr>
<th>username</th>
<th>uid</th>
<th>group</th>
<th>gid</th>
<th>password</th>
<th>home</th>
<th>shell</th>
<th>groups</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Where:</p>
<ul>
<li><code>username</code> is the desired user name (aka login name) for the user. It can not be <code>root</code>, and must be unique. If set to <code>-</code>, then just a group will be created.</li>
<li><code>uid</code> is the desired UID for the user. It must be unique, and not <code>0</code>. If set to <code>-1</code> or <code>-2</code>, then a unique UID will be computed by Buildroot, with <code>-1</code> denoting a system UID from [100…999] and <code>-2</code> denoting a user UID from [1000…1999].</li>
<li><code>group</code> is the desired name for the user’s main group. It can not be <code>root</code>. If the group does not exist, it will be created.</li>
<li><code>gid</code> is the desired GID for the user’s main group. It must be unique, and not <code>0</code>. If set to <code>-1</code> or <code>-2</code>, and the group does not already exist, then a unique GID will be computed by Buildroot, with <code>-1</code> denoting a system GID from [100…999] and <code>-2</code> denoting a user GID from [1000…1999].</li>
<li><code>password</code> is the crypt(3)-encoded password. If prefixed with <code>!</code>, then login is disabled. If prefixed with <code>=</code>, then it is interpreted as clear-text, and will be crypt-encoded (using MD5). If prefixed with <code>!=</code>, then the password will be crypt-encoded (using MD5) and login will be disabled. If set to <code>*</code>, then login is not allowed. If set to <code>-</code>, then no password value will be set.</li>
<li><code>home</code> is the desired home directory for the user. If set to <em>-</em>, no home directory will be created, and the user’s home will be <code>/</code>. Explicitly setting <code>home</code> to <code>/</code> is not allowed.</li>
<li><code>shell</code> is the desired shell for the user. If set to <code>-</code>, then <code>/bin/false</code> is set as the user’s shell.</li>
<li><code>groups</code> is the comma-separated list of additional groups the user should be part of. If set to <code>-</code>, then the user will be a member of no additional group. Missing groups will be created with an arbitrary <code>gid</code>.</li>
<li><code>comment</code> (aka <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gecos_field">GECOS</a> field) is an almost-free-form text.</li>
</ul>
<p>There are a few restrictions on the content of each field:</p>
<ul>
<li>except for <code>comment</code>, all fields are mandatory.</li>
<li>except for <code>comment</code>, fields may not contain spaces.</li>
<li>no field may contain a colon (<code>:</code>).</li>
</ul>
<p>If <code>home</code> is not <code>-</code>, then the home directory, and all files below, will belong to the user and its main group.</p>
<p>Examples:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo -1 bar -1 !=blabla /home/foo /bin/sh alpha,bravo Foo user</span><br></pre></td></tr></table></figure>
<p>This will create this user:</p>
<ul>
<li><code>username</code> (aka login name) is: <code>foo</code></li>
<li><code>uid</code> is computed by Buildroot</li>
<li>main <code>group</code> is: <code>bar</code></li>
<li>main group <code>gid</code> is computed by Buildroot</li>
<li>clear-text <code>password</code> is: <code>blabla</code>, will be crypt(3)-encoded, and login is disabled.</li>
<li><code>home</code> is: <code>/home/foo</code></li>
<li><code>shell</code> is: <code>/bin/sh</code></li>
<li><code>foo</code> is also a member of <code>groups</code>: <code>alpha</code> and <code>bravo</code></li>
<li><code>comment</code> is: <code>Foo user</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test 8000 wheel -1 = - /bin/sh - Test user</span><br></pre></td></tr></table></figure>
<p>This will create this user:</p>
<ul>
<li><code>username</code> (aka login name) is: <code>test</code></li>
<li><code>uid</code> is : <code>8000</code></li>
<li>main <code>group</code> is: <code>wheel</code></li>
<li>main group <code>gid</code> is computed by Buildroot, and will use the value defined in the rootfs skeleton</li>
<li><code>password</code> is empty (aka no password).</li>
<li><code>home</code> is <code>/</code> but will not belong to <code>test</code></li>
<li><code>shell</code> is: <code>/bin/sh</code></li>
<li><code>test</code> is not a member of any additional <code>groups</code></li>
<li><code>comment</code> is: <code>Test user</code></li>
</ul>
<h2 id="261-caveat-with-automatic-uids-and-gids"><a class="markdownIt-Anchor" href="#261-caveat-with-automatic-uids-and-gids"></a> 26.1. Caveat with automatic UIDs and GIDs</h2>
<p>When updating buildroot or when packages are added or removed to/from the configuration, it is possible that the automatic UIDs and GIDs are changed. This can be a problem if persistent files were created with that user or group: after upgrade, they will suddenly have a different owner.</p>
<p>Therefore, it is advisable to perpetuate the automatic IDs. This can be done by adding a users table with the generated IDs. It is only needed to do this for UIDs that actually create persistent files, e.g. database.</p>
<h2 id="chapter-27-migrating-from-older-buildroot-versions"><a class="markdownIt-Anchor" href="#chapter-27-migrating-from-older-buildroot-versions"></a> Chapter 27. Migrating from older Buildroot versions</h2>
<p>Some versions have introduced backward incompatibilities. This section explains those incompatibilities, and for each explains what to do to complete the migration.</p>
<h2 id="271-general-approach"><a class="markdownIt-Anchor" href="#271-general-approach"></a> 27.1. General approach</h2>
<p>To migrate from an older Buildroot version, take the following steps.</p>
<ol>
<li>For all your configurations, do a build in the old Buildroot environment. Run <code>make graph-size</code>. Save <code>graphs/file-size-stats.csv</code> in a different location. Run <code>make clean</code> to remove the rest.</li>
<li>Review the specific migration notes below and make the required adaptations to external packages and custom build scripts.</li>
<li>Update Buildroot.</li>
<li>Run <code>make menuconfig</code> starting from the existing <code>.config</code>.</li>
<li>If anything is enabled in the Legacy menu, check its help text, unselect it, and save the configuration.</li>
<li>For more details, review the git commit messages for the packages that you need. Change into the <code>packages</code> directory and run <code>git log &lt;old version&gt;.. — &lt;your packages&gt;</code>.</li>
<li>Build in the new Buildroot environment.</li>
<li>Fix build issues in external packages (usually due to updated dependencies).</li>
<li>Run <code>make graph-size</code>.</li>
<li>Compare the new <code>file-size-stats.csv</code> with the original one, to check if no required files have disappeared and if no new big unneeded files have appeared.</li>
<li>For configuration (and other) files in a custom overlay that overwrite files created by Buildroot, check if there are changes in the Buildroot-generated file that need to be propagated to your custom file.</li>
</ol>
<h2 id="272-migrating-to-201611"><a class="markdownIt-Anchor" href="#272-migrating-to-201611"></a> 27.2. Migrating to 2016.11</h2>
<p>Before Buildroot 2016.11, it was possible to use only one br2-external tree at once. With Buildroot 2016.11 came the possibility to use more than one simultaneously (for details, see <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#outside-br-custom">Section 9.2, “Keeping customizations outside of Buildroot”</a>).</p>
<p>This however means that older br2-external trees are not usable as-is. A minor change has to be made: adding a name to your br2-external tree.</p>
<p>This can be done very easily in just a few steps:</p>
<ul>
<li>
<p>First, create a new file named <code>external.desc</code>, at the root of your br2-external tree, with a single line defining the name of your br2-external tree:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;name: NAME_OF_YOUR_TREE&#x27; &gt;external.desc</span><br></pre></td></tr></table></figure>
<p><strong>Note.</strong> Be careful when choosing a name: It has to be unique and be made with only ASCII characters from the set <code>[A-Za-z0-9_]</code>.</p>
</li>
<li>
<p>Then, change every occurence of <code>BR2_EXTERNAL</code> in your br2-external tree with the new variable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . -type f | xargs sed -i &#x27;s/BR2_EXTERNAL/BR2_EXTERNAL_NAME_OF_YOUR_TREE_PATH/g&#x27;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Now, your br2-external tree can be used with Buildroot 2016.11 onward.</p>
<p><strong>Note:</strong> This change makes your br2-external tree incompatible with Buildroot before 2016.11.</p>
<h2 id="273-migrating-to-201708"><a class="markdownIt-Anchor" href="#273-migrating-to-201708"></a> 27.3. Migrating to 2017.08</h2>
<p>Before Buildroot 2017.08, host packages were installed in <code>$(HOST_DIR)/usr</code> (with e.g. the autotools’ <code>--prefix=$(HOST_DIR)/usr</code>). With Buildroot 2017.08, they are now installed directly in <code>$(HOST_DIR)</code>.</p>
<p>Whenever a package installs an executable that is linked with a library in <code>$(HOST_DIR)/lib</code>, it must have an RPATH pointing to that directory.</p>
<p>An RPATH pointing to <code>$(HOST_DIR)/usr/lib</code> is no longer accepted.</p>
<h2 id="274-migrating-to-202311"><a class="markdownIt-Anchor" href="#274-migrating-to-202311"></a> 27.4. Migrating to 2023.11</h2>
<p>Before Buildroot 2023.11, the subversion download backend unconditionally retrieved the external references (objects with an <code>svn:externals</code> property). Starting with 2023.11, externals are no longer retrieved by default; if you need them, set <code>LIBFOO_SVN_EXTERNALS</code> to <code>YES</code>. This change implies that:</p>
<ul>
<li>the generated archive content may change, and thus the hashes may need to be updated appropriately;</li>
<li>the archive version suffix has been updated to <code>-br3</code>, so the hash files must be updated appropriately.</li>
</ul>
<p>Before Buildroot 2023.11, it was possible (but undocumented and unused) to apply architecture-specific patches, by prefixing the patch filename with the architecture, e.g. <code>0001-some-changes.patch.arm</code> and such a patch would only be applied for that architecture. With Buildroot 2023.11, this is no longer supported, and such patches are no longer applied at all.</p>
<p>If you still need per-architecture patches, then you may provide a <a target="_blank" rel="noopener" href="https://buildroot.org/downloads/manual/manual.html#hooks">pre-patch hook</a> that copies the patches applicable to the configured architecture, e.g.:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">define LIBFOO_ARCH_PATCHES</span><br><span class="line">    $(foreach p,$(wildcard $(LIBFOO_PKGDIR)/*.patch.$(ARCH)), \</span><br><span class="line">        cp -f $(p) $(patsubst %.$(ARCH),%,$(p))</span><br><span class="line">    )</span><br><span class="line">endef</span><br><span class="line">LIBFOO_PRE_PATCH_HOOKS += LIBFOO_ARCH_PATCHES</span><br></pre></td></tr></table></figure>
<p>Note that no package in Buildroot has architecture-specific patches, and that such patches will most probably not be accepted.</p>
<h2 id="275-migrating-to-202405"><a class="markdownIt-Anchor" href="#275-migrating-to-202405"></a> 27.5. Migrating to 2024.05</h2>
<p>The download backends have been extended in various ways.</p>
<ul>
<li>All locally generated tarballs are even more reproducible. Before 2024.05, it was possible that the access mode of files in the archives were not consistent when the download directory has specific ACLs (e.g. with the <code>default</code> ACL set). This impacts the archives generated for git and subversion repositories, as well as those for vendored cargo and go packages.</li>
<li>The git download backend now properly expands the <code>export-subst</code> <a target="_blank" rel="noopener" href="https://git-scm.com/docs/gitattributes">git attribute</a> when generating archives.</li>
<li>A newer <code>tar</code> version, <em>1.35</em>, is required to generate the archives. For compatibility reasons, <code>tar</code> 1.35 changes the way it stores some fields (<code>devmajor</code> and <code>devminor</code>), which has an impact in the metadata stored in the archives (but the content of files is not affected).</li>
</ul>
<p>To accomodate those changes, the archive suffix has been updated or added:</p>
<ul>
<li>for git: <code>-git4</code></li>
<li>for subversion: <code>-svn5</code></li>
<li>for cargo (rust) packages: <code>-cargo2</code></li>
<li>for go packages: <code>-go2</code></li>
</ul>
<p>Note that, if two such prefixes would apply to a generated archive, like for a cargo package downloaded from git, both suffixes need to be added, first the one for the download mechanism, then the one for the vendoring, e.g.: <code>libfoo-1.2.3-git4-cargo2.tar.gz</code>.</p>
<p>Because of this, the hash file of any custom packages or custom versions for kernel and bootloaders must be updated. The following sed scripts can automate the rename in the hash file (assuming such files are kept under git):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># For git and svn packages, which originally had -br2 resp. -br3 suffix</span><br><span class="line">sed -r -i -e &#x27;s/-br2/-git4/; s/-br3/-svn5/&#x27; $(</span><br><span class="line">    git grep -l -E -- &#x27;-br2|-br3&#x27; -- &#x27;*.hash&#x27;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># For go packages, which originally had no suffix</span><br><span class="line">sed -r -i -e &#x27;s/(\.tar\.gz)$/-go2\1/&#x27; $(</span><br><span class="line">    git grep -l -E &#x27;\$\(eval \$\((host-)?golang-package\)\)&#x27; -- &#x27;*.mk&#x27; \</span><br><span class="line">    |sed -r -e &#x27;s/\.mk$/.hash/&#x27; \</span><br><span class="line">    |sort -u</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># For cargo packages, which originally had no suffix</span><br><span class="line">sed -r -i -e &#x27;s/(\.tar\.gz)$/-cargo2\1/&#x27; $(</span><br><span class="line">    git grep -l -E &#x27;\$\(eval \$\((host-)?cargo-package\)\)&#x27; -- &#x27;*.mk&#x27; \</span><br><span class="line">    |sed -r -e &#x27;s/\.mk$/.hash/&#x27; \</span><br><span class="line">    |sort -u</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Note that the hash <em>will</em> have changed, so that needs to be updated (manually) as well.</p>
<p>×</p>
<p>拖拽到此处完成下载</p>
<p>图片将完成下载</p>
<p>AIX智能下载器</p>
<hr />
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/07/02/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/20_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC2%E4%B8%AA%E6%98%9F%E6%9C%9F)/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/07/03/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/21_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC%E4%B8%89%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            工作记录((7月第3个星期)
          
        </div>
      </a>
    
    
      <a href="/2024/07/01/06_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/19_%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95(%E4%B8%83%E6%9C%88%E7%AC%AC1%E4%B8%AA%E6%98%9F%E6%9C%9F)/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">工作记录((7月第1个星期)</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> chai
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="热爱学习的未来酱"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%94%9F%E6%B4%BB">生活</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%91%9E%E8%8A%AF%E5%BE%AE">瑞芯微</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/Linux%E5%AD%A6%E4%B9%A0">Linux学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E8%AF%BB%E4%B9%A6">读书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/C%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E5%AD%A6%E4%B9%A0">C语言高级学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95">工作记录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7">小技巧</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/shell%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0">shell编程学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/PCB%E5%AD%A6%E4%B9%A0">PCB学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0">音视频学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=22707008&auto=0&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>